---
title: MERGE in Integration Services Packages | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- MERGE statement [SQL Server]
ms.assetid: 7e44a5c2-e6d6-4fe2-a079-4f95ccdb147b
author: chugugrace
ms.author: chugu
ms.openlocfilehash: cc6de738d44b91a9e2a4885978ba4a46dfede8cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87639578"
---
# <a name="merge-in-integration-services-packages"></a><span data-ttu-id="8ac69-102">MERGE in Integration Services Packages</span><span class="sxs-lookup"><span data-stu-id="8ac69-102">MERGE in Integration Services Packages</span></span>
  <span data-ttu-id="8ac69-103">現在のリリースの [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)]では、SQL 実行タスクの SQL ステートメントに MERGE ステートメントを含めることができます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-103">In the current release of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], the SQL statement in an Execute SQL task can contain a MERGE statement.</span></span> <span data-ttu-id="8ac69-104">この MERGE ステートメントを使用すると、1 つのステートメントで複数の INSERT、UPDATE、および DELETE 操作を実行できます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-104">This MERGE statement enables you to accomplish multiple INSERT, UPDATE, and DELETE operations in a single statement.</span></span>  
  
 <span data-ttu-id="8ac69-105">パッケージで MERGE ステートメントを使用するには、次の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-105">To use the MERGE statement in a package, follow these steps:</span></span>  
  
-   <span data-ttu-id="8ac69-106">一時テーブルまたはステージング テーブルへのソース データの読み込み、変換、保存を実行するデータ フロー タスクを作成します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-106">Create a Data Flow task that loads, transforms, and saves the source data to a temporary or staging table.</span></span>  
  
-   <span data-ttu-id="8ac69-107">MERGE ステートメントを含む SQL 実行タスクを作成します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-107">Create an Execute SQL task that contains the MERGE statement.</span></span>  
  
-   <span data-ttu-id="8ac69-108">データ フロー タスクを SQL 実行タスクに接続し、ステージング テーブルのデータを MERGE ステートメントへの入力として使用します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-108">Connect the Data Flow task to the Execute SQL task, and use the data in the staging table as the input for the MERGE statement.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="8ac69-109">このシナリオでは、一般に、MERGE ステートメントにステージング テーブルが必要ですが、MERGE ステートメントのパフォーマンスは、通常、参照変換で実行される 1 行ずつの参照のパフォーマンスを上回ります。</span><span class="sxs-lookup"><span data-stu-id="8ac69-109">Although a MERGE statement typically requires a staging table in this scenario, the performance of the MERGE statement usually exceeds that of the row-by-row lookup performed by the Lookup transformation.</span></span> <span data-ttu-id="8ac69-110">また、MERGE は、大きなサイズの参照テーブルが参照変換でその参照テーブルをキャッシュするために使用できるメモリをテストする場合にも役立ちます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-110">MERGE is also useful when the large size of a lookup table would test the memory that is available to the Lookup transformation for caching its reference table.</span></span>  
  
 <span data-ttu-id="8ac69-111">このトピックの残りの部分では、MERGE ステートメントの別の使用方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-111">The remainder of this topic discusses some additional uses for the MERGE statement.</span></span>  
  
 <span data-ttu-id="8ac69-112">MERGE ステートメントの使用をサポートする変換先コンポーネントのサンプルについては、CodePlex コミュニティのサンプル ( [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215)) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ac69-112">For a sample destination component that supports the use of the MERGE statement, see the CodePlex community sample, [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215).</span></span>  
  
## <a name="using-merge"></a><span data-ttu-id="8ac69-113">MERGE を使用する</span><span class="sxs-lookup"><span data-stu-id="8ac69-113">Using MERGE</span></span>  
 <span data-ttu-id="8ac69-114">通常、MERGE ステートメントは、挿入、更新、および削除を含む変更をあるテーブルから別のテーブルに適用する場合に使用します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-114">Typically, you use the MERGE statement when you want to apply changes that include inserts, updates, and deletions from one table to another table.</span></span> <span data-ttu-id="8ac69-115">[!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]より前のバージョンでこの処理を行うには、参照変換と複数の OLE DB コマンド変換の両方が必要でした。</span><span class="sxs-lookup"><span data-stu-id="8ac69-115">Prior to [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], this process required both a Lookup transformation and multiple OLE DB Command transformations.</span></span> <span data-ttu-id="8ac69-116">参照変換で、1 行ずつ参照を実行して各行が新しいか変更されたかを判断し、</span><span class="sxs-lookup"><span data-stu-id="8ac69-116">The Lookup transformation performed a row-by-row lookup to determine whether each row was new or changed.</span></span> <span data-ttu-id="8ac69-117">次に、OLE DB コマンド変換で、必要な INSERT、UPDATE および DELETE の操作を実行しました。</span><span class="sxs-lookup"><span data-stu-id="8ac69-117">The OLE DB Command transformations then performed the necessary INSERT, UPDATE, and DELETE operations.</span></span> <span data-ttu-id="8ac69-118">[!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]以降、1 つの MERGE ステートメントを、参照変換と対応する OLE DB コマンド変換に代わって使用できます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-118">Beginning in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], a single MERGE statement can replace both the Lookup transformation and the corresponding OLE DB Command transformations.</span></span>  
  
### <a name="merge-with-incremental-loads"></a><span data-ttu-id="8ac69-119">増分読み込みを伴う MERGE</span><span class="sxs-lookup"><span data-stu-id="8ac69-119">MERGE with Incremental Loads</span></span>  
 <span data-ttu-id="8ac69-120">Change Data Capture 機能は [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] の新機能で、これを使用すると、データ ウェアハウスへの増分読み込みを簡単に実行できます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-120">The change data capture functionality that is new in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] makes it easier to perform incremental loads reliably to a data warehouse.</span></span> <span data-ttu-id="8ac69-121">パラメーター化された OLE DB コマンド変換を使用して挿入と更新を実行する代わりに、MERGE ステートメントを使用して両方の操作を組み合わせることができます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-121">As an alternative to using parameterized OLE DB Command transformations to perform the inserts and the updates, you can use the MERGE statement to combine both operations.</span></span>  
  
 <span data-ttu-id="8ac69-122">詳細については、「 [変換先に変更を適用する](../change-data-capture/apply-the-changes-to-the-destination.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ac69-122">For more information, see [Apply the Changes to the Destination](../change-data-capture/apply-the-changes-to-the-destination.md).</span></span>  
  
#### <a name="merge-in-other-scenarios"></a><span data-ttu-id="8ac69-123">他のシナリオでの MERGE</span><span class="sxs-lookup"><span data-stu-id="8ac69-123">MERGE in Other Scenarios</span></span>  
 <span data-ttu-id="8ac69-124">次のシナリオでは、MERGE ステートメントを [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] パッケージの内部でも外部でも使用できます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-124">In the following scenarios, you can use the MERGE statement either outside or inside an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package.</span></span> <span data-ttu-id="8ac69-125">ただし、 [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] パッケージは、多くの場合、このデータを複数の異種ソースから読み込み、データを結合および消去する際に必要になることがあります。</span><span class="sxs-lookup"><span data-stu-id="8ac69-125">However, an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package is often required to load this data from multiple heterogeneous sources, and then to combine and cleanse the data.</span></span> <span data-ttu-id="8ac69-126">したがって、メンテナンスを都合に合わせて簡単に行えるように、パッケージ内では MERGE ステートメントを使用することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="8ac69-126">Therefore, you might consider using the MERGE statement in a package for convenience and ease of maintenance.</span></span>  
  
##### <a name="track-buying-habits"></a><span data-ttu-id="8ac69-127">購買習慣の追跡</span><span class="sxs-lookup"><span data-stu-id="8ac69-127">Track Buying Habits</span></span>  
 <span data-ttu-id="8ac69-128">データ ウェアハウスの FactBuyingHabits テーブルでは、各顧客が特定の製品を最後に購入した日付を追跡しています。</span><span class="sxs-lookup"><span data-stu-id="8ac69-128">The FactBuyingHabits table in the data warehouse tracks the last date on which a customer bought a given product.</span></span> <span data-ttu-id="8ac69-129">このテーブルは、ProductID、CustomerID、および PurchaseDate の各列で構成されています。</span><span class="sxs-lookup"><span data-stu-id="8ac69-129">The table consists of ProductID, CustomerID and PurchaseDate columns.</span></span> <span data-ttu-id="8ac69-130">トランザクション データベースは、毎週、その週に行われた購入を記録する PurchaseRecords テーブルを生成します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-130">Every week, the transactional database generates a PurchaseRecords table that includes the purchases made during that week.</span></span> <span data-ttu-id="8ac69-131">1 つの MERGE ステートメントを使用して PurchaseRecords テーブルの情報を FactBuyingHabits テーブルにマージすることが目的です。</span><span class="sxs-lookup"><span data-stu-id="8ac69-131">The objective is to use a single MERGE statement to merge the information in the PurchaseRecords table into the FactBuyingHabits table.</span></span> <span data-ttu-id="8ac69-132">製品と顧客の組み合わせが存在しない場合は、MERGE ステートメントによって新しい行が挿入されます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-132">For product-customer pairs that do not exist, the MERGE statement inserts new rows.</span></span> <span data-ttu-id="8ac69-133">製品と顧客の組み合わせが存在する場合は、MERGE ステートメントによって最新の購入日が更新されます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-133">For product-customer pairs that exist, the MERGE statement updates the most recent date-of-purchase.</span></span>  
  
###### <a name="track-price-history"></a><span data-ttu-id="8ac69-134">価格履歴の追跡</span><span class="sxs-lookup"><span data-stu-id="8ac69-134">Track Price History</span></span>  
 <span data-ttu-id="8ac69-135">DimBook テーブルは、書店の在庫にある書籍の一覧を表し、各書籍の価格履歴を示しています。</span><span class="sxs-lookup"><span data-stu-id="8ac69-135">The DimBook table represents the list of books in the inventory of a book seller and identifies the price history of each book.</span></span> <span data-ttu-id="8ac69-136">このテーブルには、ISBN、ProductID、Price、Shelf、および IsCurrent の各列が含まれています。</span><span class="sxs-lookup"><span data-stu-id="8ac69-136">This table has these columns: ISBN, ProductID, Price, Shelf, and IsCurrent.</span></span> <span data-ttu-id="8ac69-137">また、このテーブルでは、書籍の価格が変更されるたびに 1 行追加されます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-137">This table also has one row for each price the book has had.</span></span> <span data-ttu-id="8ac69-138">こうした行の 1 つに、現在の価格が含まれています。</span><span class="sxs-lookup"><span data-stu-id="8ac69-138">One of these rows contains the current price.</span></span> <span data-ttu-id="8ac69-139">現在の価格が含まれている行を示すために、その行の IsCurrent 列の値は 1 に設定されます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-139">To indicate which row contains the current price, the value of the IsCurrent column for that row is set to 1.</span></span>  
  
 <span data-ttu-id="8ac69-140">データベースは、毎週、その週の価格変更と、その週に追加された新しい書籍を記録する WeeklyChanges テーブルを生成します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-140">Every week, the database generates a WeeklyChanges table that contains price changes for the week and new books that were added during the week.</span></span> <span data-ttu-id="8ac69-141">1 つの MERGE ステートメントを使用して、WeeklyChanges テーブルの変更を DimBook テーブルに適用できます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-141">By using a single MERGE statement, you can apply the changes in the WeeklyChanges table to the DimBook table.</span></span> <span data-ttu-id="8ac69-142">MERGE ステートメントにより、新しく追加された書籍用に新しい行が挿入され、価格が変更された既存の書籍の行では IsCurrent 列が 0 に更新されます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-142">The MERGE statement inserts new rows for newly-added books, and updates the IsCurrent column to 0 for rows of existing books whose prices have changed.</span></span> <span data-ttu-id="8ac69-143">また、価格が変更された書籍用に新しい行が挿入され、その行では IsCurrent 列の値が 1 に設定されます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-143">The MERGE statement also inserts new rows for books whose prices have changed, and for these new rows, sets the value of the IsCurrent column to 1.</span></span>  
  
### <a name="merge-a-table-with-new-data-against-the-old-table"></a><span data-ttu-id="8ac69-144">新しいデータを含むテーブルと古いテーブルのマージ</span><span class="sxs-lookup"><span data-stu-id="8ac69-144">Merge a Table with New Data Against the Old Table</span></span>  
 <span data-ttu-id="8ac69-145">データベースは、"オープン スキーマ"、つまり、各プロパティの名前と値の組み合わせが格納されているテーブルを使用して、オブジェクトのプロパティをモデル化します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-145">The database models the properties of an object by using an "open schema," that is, a table contains name-value pairs for each property.</span></span> <span data-ttu-id="8ac69-146">Properties テーブルには EntityID、PropertyID、および Value という 3 つの列があります。</span><span class="sxs-lookup"><span data-stu-id="8ac69-146">The Properties table has three columns: EntityID, PropertyID, and Value.</span></span> <span data-ttu-id="8ac69-147">NewProperties テーブルは、Properties テーブルと同期する必要のある、新しいバージョンのテーブルです。</span><span class="sxs-lookup"><span data-stu-id="8ac69-147">A NewProperties table that is a newer version of the table has to be synchronized with the Properties table.</span></span> <span data-ttu-id="8ac69-148">この 2 つのテーブルを同期するには、1 つの MERGE ステートメントを使用して次の操作を実行します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-148">To synchronize these two tables, you can use a single MERGE statement to perform the following operations:</span></span>  
  
-   <span data-ttu-id="8ac69-149">Properties テーブルから、NewProperties テーブルに存在しないプロパティを削除します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-149">Delete properties from the Properties table if they are absent from the NewProperties table.</span></span>  
  
-   <span data-ttu-id="8ac69-150">Properties テーブルに存在するプロパティの値を、NewProperties テーブルにある新しい値で更新します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-150">Update values for properties that are in the Properties table with new values found in the NewProperties table.</span></span>  
  
-   <span data-ttu-id="8ac69-151">NewProperties テーブルに存在して Properties テーブルにはないプロパティについては、新しいプロパティを挿入します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-151">Insert new properties for properties that are in the NewProperties table but are not found in the Properties table.</span></span>  
  
 <span data-ttu-id="8ac69-152">この方法は、レプリケーション シナリオのようなシナリオで役立ちます。この場合は、2 つのサーバー上の 2 つのテーブル内のデータを同期しておくことが目的です。</span><span class="sxs-lookup"><span data-stu-id="8ac69-152">This approach is useful in scenarios that resemble replication scenarios, where the objective is to keep data in two tables on two servers synchronized.</span></span>  
  
### <a name="track-inventory"></a><span data-ttu-id="8ac69-153">在庫の追跡</span><span class="sxs-lookup"><span data-stu-id="8ac69-153">Track Inventory</span></span>  
 <span data-ttu-id="8ac69-154">Inventory データベースには、ProductID 列と StockOnHand 列を含む ProductsInventory テーブルがあります。</span><span class="sxs-lookup"><span data-stu-id="8ac69-154">The Inventory database has a ProductsInventory table that has ProductID and StockOnHand columns.</span></span> <span data-ttu-id="8ac69-155">ProductID、CustomerID、および Quantity の各列を含む Shipments テーブルでは、顧客に対する製品の出荷を追跡しています。</span><span class="sxs-lookup"><span data-stu-id="8ac69-155">A Shipments table with ProductID, CustomerID, and Quantity columns tracks shipments of products to customers.</span></span> <span data-ttu-id="8ac69-156">ProductInventory テーブルは、Shipments テーブルの情報に基づいて毎日更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="8ac69-156">The ProductInventory table has to be updated daily based on information in the Shipments table.</span></span> <span data-ttu-id="8ac69-157">1 つの MERGE ステートメントによって、出荷が行われると ProductInventory テーブルの在庫が減少します。</span><span class="sxs-lookup"><span data-stu-id="8ac69-157">A single MERGE statement can reduce the inventory in the ProductInventory table based on the shipments made.</span></span> <span data-ttu-id="8ac69-158">製品の在庫が 0 まで減少した場合は、その MERGE ステートメントによって、ProductInventory テーブルからその製品の行も削除されます。</span><span class="sxs-lookup"><span data-stu-id="8ac69-158">If the inventory for a product has been reduced to 0, that MERGE statement can also delete that product row from the ProductInventory table.</span></span>  
  
  
