---
title: 可用性グループのための Azure への SQL Server マネージバックアップの設定 |Microsoft Docs
description: このチュートリアルでは、Always On 可用性グループに参加しているデータベースの Microsoft Azure に SQL Server マネージバックアップを構成する方法について説明します。
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 0c4553cd-d8e4-4691-963a-4e414cc0f1ba
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: ebae9f75ac25698582b7f3e4c78c2fb773bd803e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87631224"
---
# <a name="setting-up-sql-server-managed-backup-to-azure-for-availability-groups"></a><span data-ttu-id="0d62e-103">可用性グループに対する Azure への SQL Server マネージド バックアップの設定</span><span class="sxs-lookup"><span data-stu-id="0d62e-103">Setting up SQL Server Managed Backup to Azure for Availability Groups</span></span>
  <span data-ttu-id="0d62e-104">このトピックは、AlwaysOn 可用性グループに参加しているデータベースの [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]の構成に関するチュートリアルです。</span><span class="sxs-lookup"><span data-stu-id="0d62e-104">This topic is a tutorial on configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Groups.</span></span>  
  
## <a name="availability-group-configurations"></a><span data-ttu-id="0d62e-105">可用性グループの構成</span><span class="sxs-lookup"><span data-stu-id="0d62e-105">Availability Group Configurations</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="0d62e-106">は、可用性グループデータベースに対してサポートされています。レプリカがすべてオンプレミスで構成されているか、完全に Azure で構成されているか、またはオンプレミスと1つ以上の Azure 仮想マシンの間のハイブリッド実装であるかは関係ありません。</span><span class="sxs-lookup"><span data-stu-id="0d62e-106">is supported for Availability Group databases, whether the replicas are all configured on-premises, or entirely on Azure, or a Hybrid implementation between on-premises and on one or more Azure virtual machines.</span></span> <span data-ttu-id="0d62e-107">ただし、1 つ以上の実装に関して、次のことを考慮する必要が生じる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-107">However you might need to consider the following for one or more implementations:</span></span>  
  
-   <span data-ttu-id="0d62e-108">ログ バックアップ頻度: ログ バックアップ頻度に応じて、時間とログの両方が増加します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-108">Log Backup Frequency: The frequency of log backup is both time and log growth.</span></span> <span data-ttu-id="0d62e-109">たとえば、2 時間という期間で使用されるログ領域が 5 MB に達しない場合は、2 時間ごとにログ バックアップを作成するとします。</span><span class="sxs-lookup"><span data-stu-id="0d62e-109">For example, the log backup is taken once every 2 hours unless the log space used within the two hour period is 5 MB or more.</span></span> <span data-ttu-id="0d62e-110">この方針を、内部設置型、クラウド、またはハイブリッドというすべての実装に適用します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-110">This applies to all implementations, on-premises, cloud, or a Hybrid.</span></span>  
  
-   <span data-ttu-id="0d62e-111">ネットワーク帯域幅: これは、ハイブリッドクラウドなどの異なる物理的な場所にあるレプリカが配置されている場合、またはクラウドのみの構成の異なる Azure リージョンにある場合に適用されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-111">Network Bandwidth: This applies to implementations where the replicas are located in different physical locations, like in a hybrid cloud, or across different Azure regions in a cloud only configuration.</span></span> <span data-ttu-id="0d62e-112">ネットワーク帯域幅は、セカンダリの待機時間に影響する可能性があります。セカンダリが同期レプリケーションに設定されている場合は、プライマリ ログの増加が引き起こされる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-112">The network bandwidth can affect the latency of the secondaries and if the secondaries are set to synchronous replication, then this can cause log growth on the primary.</span></span> <span data-ttu-id="0d62e-113">セカンダリ レプリカが同期レプリケーションに設定されている場合は、ネットワーク待機時間が原因でセカンダリは同期を維持できない可能性があり、その結果、セカンダリ レプリカへのフェールオーバー イベントが発生したときにデータが失われる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-113">If the secondaries are set to synchronous replication, the secondaries may not be able to keep up due to network latency, which can result in data loss in the event of a failover to the secondary replica.</span></span>  
  
### <a name="configuring-ss_smartbackup-for-availability-databases"></a><span data-ttu-id="0d62e-114">可用性データベースに対する [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]の構成</span><span class="sxs-lookup"><span data-stu-id="0d62e-114">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for Availability Databases.</span></span>  
 <span data-ttu-id="0d62e-115">**アクセス許可:**</span><span class="sxs-lookup"><span data-stu-id="0d62e-115">**Permissions:**</span></span>  
  
-   <span data-ttu-id="0d62e-116">**Db_backupoperator**データベースロールのメンバーシップ、 **ALTER ANY CREDENTIAL**権限、および `EXECUTE` **sp_delete_backuphistory**ストアドプロシージャに対する権限が必要です。</span><span class="sxs-lookup"><span data-stu-id="0d62e-116">Requires membership in **db_backupoperator** database role, with **ALTER ANY CREDENTIAL** permissions, and `EXECUTE` permissions on **sp_delete_backuphistory**stored procedure.</span></span>  
  
-   <span data-ttu-id="0d62e-117">**Smart_admin fn_get_current_xevent_settings**関数に対する**SELECT**権限が必要です。</span><span class="sxs-lookup"><span data-stu-id="0d62e-117">Requires **SELECT** permissions on the **smart_admin.fn_get_current_xevent_settings**function.</span></span>  
  
-   <span data-ttu-id="0d62e-118">`EXECUTE` **Smart_admin sp_get_backup_diagnostics**ストアドプロシージャに対する権限が必要です。</span><span class="sxs-lookup"><span data-stu-id="0d62e-118">Requires `EXECUTE` permissions on the **smart_admin.sp_get_backup_diagnostics** stored procedure.</span></span> <span data-ttu-id="0d62e-119">さらに、`VIEW SERVER STATE` 権限も必要です (この権限を必要とする他のシステム オブジェクトを内部的に呼び出すため)。</span><span class="sxs-lookup"><span data-stu-id="0d62e-119">In addition, it requires `VIEW SERVER STATE` permissions as it internally calls other system objects that require this permission.</span></span>  
  
-   <span data-ttu-id="0d62e-120">`EXECUTE` `smart_admin.sp_set_instance_backup` ストアドプロシージャおよびストアドプロシージャに対する権限が必要です `smart_admin.sp_backup_master_switch` 。</span><span class="sxs-lookup"><span data-stu-id="0d62e-120">Requires `EXECUTE` permissions on the `smart_admin.sp_set_instance_backup` and `smart_admin.sp_backup_master_switch` stored procedures.</span></span>  
  
 <span data-ttu-id="0d62e-121">次に、[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]で AlwaysOn 可用性グループを設定する基本的な手順を説明します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-121">The following are the basic steps to setting up an AlwaysOn Availability Group with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="0d62e-122">詳細手順のチュートリアルについては、このトピックの後半で説明します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-122">A detailed step-by step tutorial is described later in this topic.</span></span>  
  
1.  <span data-ttu-id="0d62e-123">可用性グループを作成したら、優先されるバックアップ レプリカを構成します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-123">Once you have created Availability Group, configure the preferred backup replica.</span></span> <span data-ttu-id="0d62e-124">可用性グループに対するこの設定は、バックアップに使用するレプリカを決定するために [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]でも使用されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-124">This setting for the Availability Group is also used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which replica to use for backup.</span></span> <span data-ttu-id="0d62e-125">バックアップ設定をセットアップする方法の詳細な手順については、「[可用性レプリカのバックアップの構成」 &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-125">For step by step instructions about how to set up the backup preference, see [Configure Backup on Availability Replicas &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span></span>  <span data-ttu-id="0d62e-126">新しい AlwaysOn 可用性グループを作成する場合は、「[はじめに AlwaysOn 可用性グループ &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-126">If you are creating a new AlwaysOn Availability Group, see [Getting Started with AlwaysOn Availability Groups &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="0d62e-127">セカンダリ レプリカへの読み取り専用接続アクセスを構成します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-127">Configure read only connection access to the secondary replicas.</span></span> <span data-ttu-id="0d62e-128">読み取り専用アクセスを構成する方法の詳細な手順については、「[可用性レプリカでの読み取り専用アクセスの構成 &#40;SQL Server](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md) 」を参照してください&#41;</span><span class="sxs-lookup"><span data-stu-id="0d62e-128">For step by step instructions about how to configure read only access, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span></span>  
  
3.  <span data-ttu-id="0d62e-129">バックアップ レプリカを指定します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-129">Specify Backup replica.</span></span> <span data-ttu-id="0d62e-130">優先されるバックアップ レプリカの設定は、バックアップのスケジュール設定に使用するデータベースを決定するために [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]で使用されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-130">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which database to use for scheduling backups from..</span></span>  <span data-ttu-id="0d62e-131">現在のレプリカが推奨されるバックアップレプリカであるかどうかを判断するには、 [fn_hadr_backup_is_preferred_replica &#40;transact-sql&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql)関数を使用します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-131">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
4.  <span data-ttu-id="0d62e-132">各レプリカで、 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] **smart admin. sp_set_db_backup**ストアドプロシージャを使用してデータベースの構成を実行します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-132">On each replica run [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration for the database using the **smart-admin.sp_set_db_backup** stored procedure.</span></span>  
  
     <span data-ttu-id="0d62e-133">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] フェールオーバー後の動作:\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] は、フェールオーバーイベント後も引き続き機能し、バックアップコピーと回復性を維持します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-133">**[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] behavior after a failover:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will continue to work and maintain backup copies and recoverability after a failover event.</span></span> <span data-ttu-id="0d62e-134">フェールオーバー後に特別な操作は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="0d62e-134">No specific action is required after a failover.</span></span>  
  
#### <a name="considerations-and-requirements"></a><span data-ttu-id="0d62e-135">注意点と要件:</span><span class="sxs-lookup"><span data-stu-id="0d62e-135">Considerations and Requirements:</span></span>  
 <span data-ttu-id="0d62e-136">AlwaysOn 可用性グループに参加しているデータベースに対して [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]を構成する場合は、特定の注意点と要件があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-136">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Group requires specific considerations and requirements.</span></span> <span data-ttu-id="0d62e-137">次に、考慮事項と要件の一覧を示します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-137">Following is a list of considerations and requirements:</span></span>  
  
-   <span data-ttu-id="0d62e-138">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]の構成設定は、同じ可用性グループに参加している [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] のすべてのノード上にあるすべてのデータベースに対して同じである必要があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-138">The [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings should be the same for all the databases on all the nodes of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] participating in the same Availability Group.</span></span> <span data-ttu-id="0d62e-139">これを実現するには、データベース レベルでプライマリとすべてのレプリカに対して同じ [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]構成を設定するか、可用性グループに参加しているすべてのノードで同じ既定の [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]設定を使用します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-139">You can achieve this either by setting  the same [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configurations for the primary and all the replicas at the database level, or by setting the same default [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] settings on all the nodes participating in the Availability Groups.</span></span> <span data-ttu-id="0d62e-140">データベース レベルで [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]を設定することをお勧めします。データベース レベルで [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]を構成すると、データベースに対する設定を分離でき、既定の設定に対する変更は、インスタンス上の他のデータベースすべてに反映されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-140">We recommend setting [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database because configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database level lets you isolate the settings to the databases and changes to default settings affect all other databases on the instance.</span></span>  
  
-   <span data-ttu-id="0d62e-141">バックアップ レプリカを指定します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-141">Specify Backup replica.</span></span> <span data-ttu-id="0d62e-142">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]では、優先されるバックアップ レプリカの設定がバックアップのスケジュール設定に使用されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-142">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to schedule the backups.</span></span> <span data-ttu-id="0d62e-143">現在のレプリカが推奨されるバックアップレプリカであるかどうかを判断するには、 [fn_hadr_backup_is_preferred_replica &#40;transact-sql&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql)関数を使用します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-143">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
-   <span data-ttu-id="0d62e-144">優先されるレプリカとしてセカンダリ レプリカが構成されている場合は、少なくとも読み取り専用接続アクセスを持つように構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-144">If the secondary replica is configured as the preferred replica, it should be configured to have at least read only connection access.</span></span> <span data-ttu-id="0d62e-145">セカンダリ データベースへの接続アクセスがない可用性グループはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="0d62e-145">Availability groups that have no connection access to secondary databases are not supported.</span></span>  <span data-ttu-id="0d62e-146">詳細については、「 [可用性レプリカでの読み取り専用アクセスの構成 &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)が存在する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-146">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
-   <span data-ttu-id="0d62e-147">可用性グループの構成後に [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]を構成すると、[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]は、構成に基づいて既存のバックアップをコピーし、それをストレージ コンテナーに格納することを試みます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-147">If you are configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] after you configure the Availability Group, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to copy any existing backups based and copy them over to the storage container.</span></span>  <span data-ttu-id="0d62e-148">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]は、既存のバックアップが見つからない場合や既存のバックアップにアクセスできない場合に、データベースの完全バックアップをスケジュールします。</span><span class="sxs-lookup"><span data-stu-id="0d62e-148">If [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is unable to find or access existing backups, it will schedule a full database backup.</span></span> <span data-ttu-id="0d62e-149">この処理は、特に、可用性グループのデータベースのバックアップ操作を最適化するために行われます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-149">This is done specifically to optimize the backup operations for Availability Group databases.</span></span>  
  
-   <span data-ttu-id="0d62e-150">新しい可用性データベースを作成するときに、インスタンスレベルの設定をデータベースに適用しない場合は、インスタンスレベルの設定を無効にすることを検討してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-150">You may want to consider disabling the instance level settings if you are creating a new availability database, and you don't intend to apply the instance level settings to the database</span></span>  
  
-   <span data-ttu-id="0d62e-151">暗号化を使用する場合は、すべてのレプリカで同じ証明書を使用します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-151">When using encryption, use the same certificate on all the replicas.</span></span> <span data-ttu-id="0d62e-152">この結果、フェールオーバー イベントが発生した場合や、別のレプリカへの復元を行う場合に、継続的で途切れることのないバックアップ操作が容易になります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-152">This facilitates continued and uninterrupted backup operations in the event of a failover or restores to a different replica.</span></span>  
  
#### <a name="enable-and-configure-ss_smartbackup-for-an-availability-database"></a><span data-ttu-id="0d62e-153">可用性データベースに対する [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]の有効化と構成</span><span class="sxs-lookup"><span data-stu-id="0d62e-153">Enable and Configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for an Availability Database</span></span>  
 <span data-ttu-id="0d62e-154">このチュートリアルでは、Node1 と Node2 のコンピューターでデータベース (Agtestdb 対し) を有効にして構成する手順について説明し、 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] その後、正常性状態の監視を有効にする手順について説明し [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-154">This tutorial describes the steps to enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a database (AGTestDB) on computers Node1 and Node2, followed by steps to enable monitoring the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] health status.</span></span>  
  
1.  <span data-ttu-id="0d62e-155">**Azure ストレージアカウントを作成します。** バックアップは、Azure Blob ストレージサービスに格納されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-155">**Create an Azure storage account:** The backups are stored in the Azure Blob storage service.</span></span> <span data-ttu-id="0d62e-156">Azure ストレージアカウントをまだ作成していない場合は、最初に作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-156">You must first create an Azure storage account, if you do not already have one.</span></span> <span data-ttu-id="0d62e-157">詳細については、「 [Azure Storage アカウントの作成](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-157">For more information, see [Creating an Azure Storage Account](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span></span> <span data-ttu-id="0d62e-158">ストレージ アカウントの名前、アクセス キー、および URL をメモしておきます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-158">Make a note of the storage account name, access keys, and URL of the storage account.</span></span> <span data-ttu-id="0d62e-159">ストレージ アカウント名およびアクセス キー情報は、SQL 資格情報の作成に使用します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-159">The storage account name and access key information is used to create a SQL Credential.</span></span> <span data-ttu-id="0d62e-160">SQL 資格情報は、バックアップ操作中にストレージ アカウントへの認証を行うために [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]によって使用されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-160">The SQL Credential is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] during backup operations to authenticate to the storage account.</span></span>  
  
2.  <span data-ttu-id="0d62e-161">**SQL 資格情報を作成します。** Id としてストレージアカウントの名前を使用し、パスワードとしてストレージアクセスキーを使用して、SQL 資格情報を作成します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-161">**Create a SQL Credential:** Create a SQL Credential using the name of the storage account as the Identity and the storage access key as the password.</span></span>  
  
3.  <span data-ttu-id="0d62e-162">**SQL Server エージェント サービスが開始され、実行されていることを確認する:** SQL Server エージェントを開始します (現在実行されていない場合)。</span><span class="sxs-lookup"><span data-stu-id="0d62e-162">**Ensure SQL Server Agent service is Started and Running:** Start SQL Server Agent if it is not currently running.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="0d62e-163">でバックアップ操作を実行するには、SQL Server エージェントがインスタンスで実行されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-163">requires SQL Server Agent to be running on the instance to perform backup operations.</span></span>  <span data-ttu-id="0d62e-164">バックアップ操作を定期的に実行できるように、SQL エージェントの自動的な実行を設定できます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-164">You may want to set SQL Agent to run automatically to make sure that backup operations can occur regularly.</span></span>  
  
4.  <span data-ttu-id="0d62e-165">**保有期間を決定します。** バックアップファイルに必要な保有期間を決定します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-165">**Determine the retention period:** Determine the retention period that you want for the backup files.</span></span> <span data-ttu-id="0d62e-166">保有期間は日数で指定し、その範囲は 1 ～ 30 になります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-166">The retention period is specified in days and can range from 1 to 30.</span></span> <span data-ttu-id="0d62e-167">保有期間によって、データベースの復旧時間の期間が決まります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-167">The retention period determines the recoverability time frame for the database.</span></span>  
  
5.  <span data-ttu-id="0d62e-168">**バックアップ中の暗号化に使用する証明書または非対称キーを作成します。** 最初のノード Node1 で証明書を作成してから、バックアップ証明書を使用してファイルにエクスポートします。これには、 [transact-sql&#41;&#40;](/sql/t-sql/statements/backup-certificate-transact-sql)ます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-168">**Create a Certificate or Asymmetric key to use for encryption during back up:** Create the certificate on the first node Node1, and then export it to a file using [BACKUP CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span></span> <span data-ttu-id="0d62e-169">Node 2 で、Node 1 からエクスポートしたファイルを使用して証明書を作成します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-169">On Node 2, create a certificate using the file exported from Node 1 .</span></span> <span data-ttu-id="0d62e-170">ファイルから証明書を作成する方法の詳細については、「 [CREATE certificate &#40;transact-sql&#41;](/sql/t-sql/statements/create-certificate-transact-sql)」の例を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-170">For more information on creating a certificate from a file, see the example in [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span></span>  
  
6.  <span data-ttu-id="0d62e-171">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] Node1 で Agtestdb 対しを有効にして構成する:\*\* SQL Server Management Studio を開始し、可用性データベースがインストールされている node1 上のインスタンスに接続します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-171">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node1:** Start SQL Server Management Studio  and connect to the instance on Node1 where the availability database  is installed.</span></span> <span data-ttu-id="0d62e-172">要件に合わせて、データベース名、ストレージ URL、SQL 資格情報、および保有期間の値を変更した後、クエリ ウィンドウから次のステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-172">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     <span data-ttu-id="0d62e-173">暗号化用の証明書の作成の詳細については、「[暗号化されたバックアップを作成](../relational-databases/backup-restore/create-an-encrypted-backup.md)する」の「**バックアップ証明書**の作成」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-173">For more information on creating a certificate for encryption, see the **Create a Backup Certificate** step in [Create an Encrypted Backup](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span></span>  
  
7.  <span data-ttu-id="0d62e-174">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] Node2 で Agtestdb 対しを有効にして構成する:\*\* SQL Server Management Studio を開始し、可用性データベースがインストールされている node2 上のインスタンスに接続します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-174">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node2:** Start SQL Server Management Studio and connect to the instance on Node2 where the availability database  is installed.</span></span> <span data-ttu-id="0d62e-175">要件に合わせて、データベース名、ストレージ URL、SQL 資格情報、および保有期間の値を変更した後、クエリ ウィンドウから次のステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-175">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="0d62e-176">は、指定したデータベースで有効になります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-176">is now enabled on the database you specified.</span></span> <span data-ttu-id="0d62e-177">データベースでのバックアップ操作の実行が開始されるまで最大 15 分かかる場合があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-177">It may take up to 15 minutes for the backup operations on the database to start to run.</span></span> <span data-ttu-id="0d62e-178">バックアップは、優先されるバックアップ レプリカに対して実行されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-178">The backup will occur on the preferred backup replica.</span></span>  
  
8.  <span data-ttu-id="0d62e-179">**拡張イベントの既定の構成を確認します。** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]を使用してバックアップのスケジュールを設定するレプリカで、次の transact-sql ステートメントを実行して、拡張イベントの構成を確認します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-179">**Review Extended Event Default Configuration:**  Review the Extended Event configuration by running the following transact-SQL statement on the replica that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using to schedule the backups from.</span></span> <span data-ttu-id="0d62e-180">これは、通常、データベースが属している可用性グループの優先されるバックアップ レプリカの設定です。</span><span class="sxs-lookup"><span data-stu-id="0d62e-180">This is usually the preferred backup replica setting for the Availability Group that the database belongs to.</span></span>  
  
    ```sql  
    SELECT * FROM smart_admin.fn_get_current_xevent_settings(); 
    ```  
  
     <span data-ttu-id="0d62e-181">管理、運用、および分析のチャネル イベントは既定で有効になっていて、無効にできないことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-181">You should see that Admin, Operational  and Analytical channel events are enabled by default and cannot be disabled.</span></span> <span data-ttu-id="0d62e-182">手動の介入を必要とするイベントを監視するには、これで十分です。</span><span class="sxs-lookup"><span data-stu-id="0d62e-182">This should be sufficient to monitor the events that require manual intervention.</span></span>  <span data-ttu-id="0d62e-183">デバッグ イベントを有効にすることはできますが、これらのチャネルには、[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]が問題の検出および解決に使用する情報イベントとデバッグ イベントが含まれています。</span><span class="sxs-lookup"><span data-stu-id="0d62e-183">You can enable the debug events, but these channels include informational and debug events that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] uses to detect issues and solve them.</span></span> <span data-ttu-id="0d62e-184">詳細については、「 [Monitor SQL Server Managed Backup To Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-184">For more information, see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
9. <span data-ttu-id="0d62e-185">**正常性状態の通知を有効化し、構成する:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]Microsoft Azure への SQL Server マネージド バックアップには、注意を要するエラーまたは警告の電子メール通知を送信するためにエージェント ジョブを作成するストアド プロシージャがあります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-185">**Enable and Configure Notification for Health Status:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] has a stored procedure that creates an agent job to send out e-mail notifications of errors or warnings that may require attention.</span></span>  <span data-ttu-id="0d62e-186">このような通知を受信するには、SQL Server エージェント ジョブを作成するストアド プロシージャの実行を有効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-186">To receive such notifications, you must enable run the stored procedure which creates a SQL Server Agent Job.</span></span> <span data-ttu-id="0d62e-187">次の手順では、電子メール通知を有効にして構成するためのプロセスを示します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-187">The following steps describe the process to enable and configure e-mail notifications:</span></span>  
  
    1.  <span data-ttu-id="0d62e-188">データベース メールがインスタンス上でまだ有効になっていない場合は設定します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-188">Setup Database Mail if it is not already enabled on the instance.</span></span> <span data-ttu-id="0d62e-189">詳細については、「 [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-189">For more information, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span>  
  
    2.  <span data-ttu-id="0d62e-190">データベース メールを使用するように SQL Server エージェント通知を構成します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-190">Configure SQL Server Agent Notification to use Database Mail.</span></span> <span data-ttu-id="0d62e-191">詳細については、「 [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-191">For more information, see [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span></span>  
  
    3.  <span data-ttu-id="0d62e-192">**電子メール通知を有効にして、バックアップ エラーおよび警告を受け取る:** クエリ ウィンドウから、次の Transact-SQL ステートメントを実行します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-192">**Enable e-mail notifications to receive backup errors and warnings:** From the query window, run the following Transact-SQL statements:</span></span>  
  
        ```sql  
        EXEC msdb.smart_admin.sp_set_parameter  
        @parameter_name = 'SSMBackup2WANotificationEmailIds',  
        @parameter_value = '<email>'  
        ```  
  
         <span data-ttu-id="0d62e-193">詳細と完全なサンプルスクリプトについては、「 [Monitor SQL Server Managed Backup To Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-193">For more information and a full sample script see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
10. <span data-ttu-id="0d62e-194">**Azure Storage アカウントでバックアップファイルを表示します。** SQL Server Management Studio または Azure 管理ポータルからストレージアカウントに接続します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-194">**View backup files in the Azure Storage Account:** Connect to the storage account from SQL Server Management Studio or the Azure Management Portal.</span></span> <span data-ttu-id="0d62e-195">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]を使用するように構成したデータベースをホストする SQL Server インスタンスのコンテナーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-195">You will see a container for the instance of SQL Server that hosts the database you configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="0d62e-196">また、データベースに対して [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]を有効にしてから 15 分以内のデータベースとログ バックアップも表示される場合があります。</span><span class="sxs-lookup"><span data-stu-id="0d62e-196">You may also see a database and a log backup within 15 minutes of enabling [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span>  
  
11. <span data-ttu-id="0d62e-197">**正常性状態を監視する:** 前の手順で構成した電子メール通知から監視するか、ログに記録されているイベントをアクティブに監視することができます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-197">**Monitor the Health Status:**  You can monitor through e-mail notifications you configured previously, or actively monitor the events logged.</span></span> <span data-ttu-id="0d62e-198">イベントを表示するための Transact-SQL ステートメントのいくつかの例を示します。</span><span class="sxs-lookup"><span data-stu-id="0d62e-198">The following are some example Transact-SQL Statements used to view the events:</span></span>  
  
    ```sql  
    --  view all admin events  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    DECLARE @eventresult TABLE  
    (event_type nvarchar(512),  
    event varchar (512),  
    timestamp datetime  
    )  
  
    INSERT INTO @eventresult  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek  
  
    SELECT * from @eventresult  
    WHERE event_type LIKE '%admin%'  
    ```  
  
    ```sql  
    -- to enable debug events  
    Use msdb;  
    Go  
    EXEC smart_admin.sp_set_parameter 'FileRetentionDebugXevent', 'True'  
    ```  
  
    ```sql  
    --  View all events in the current week  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek;  
    ```  
  
 <span data-ttu-id="0d62e-199">このセクションで説明した手順は、データベースで初めて [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] を構成するための特別な手順です。</span><span class="sxs-lookup"><span data-stu-id="0d62e-199">The steps described in this section are specifically for configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the first time on the database.</span></span> <span data-ttu-id="0d62e-200">同じシステムストアドプロシージャ**smart_admin sp_set_db_backup**を使用して既存の構成を変更し、新しい値を指定することができます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-200">You can modify the existing configurations using the same system stored procedure **smart_admin.sp_set_db_backup** and provide the new values.</span></span> <span data-ttu-id="0d62e-201">詳細については、「 [Azure へのマネージバックアップ-保有期間とストレージの設定の SQL Server](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0d62e-201">For more information, see [SQL Server Managed Backup to Azure - Retention and Storage Settings](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span></span>  
  
### <a name="considerations-when-removing-a-database-from-alwayson-availability-group-configuration"></a><span data-ttu-id="0d62e-202">AlwaysOn 可用性グループの構成からデータベースを削除する際の注意点</span><span class="sxs-lookup"><span data-stu-id="0d62e-202">Considerations when Removing a Database from AlwaysOn Availability Group Configuration</span></span>  
 <span data-ttu-id="0d62e-203">データベースが AlwaysOn 可用性グループの構成から削除され、スタンドアロンデータベースになった場合は、smart_admin を使用してバックアップを実行することをお勧めし[ます。 transact-sql&#41;&#40;sp_backup_on_demand ](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="0d62e-203">If a database is removed from the AlwaysOn Availability Group configuration and is now a stand-alone database, we recommend doing backup using [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span></span> <span data-ttu-id="0d62e-204">データベースのバックアップをこのように作成すると、新しいバックアップ チェーンが確立され、データベースが可用性グループに含まれていたときにバックアップが格納された可用性コンテナーではなく、インスタンス固有のコンテナーにファイルが配置されます。</span><span class="sxs-lookup"><span data-stu-id="0d62e-204">When you create a database backup  this way, it establishes  a new backup chain and the file will be placed in the instance specific container as opposed to Availability container where the backups were stored when the database was part of Availability Group.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="0d62e-205">このシナリオのデータベースについては、可用性グループの状態が変更される前のバックアップからの復旧性は保証されません。</span><span class="sxs-lookup"><span data-stu-id="0d62e-205">The recoverability of the database in this scenario from backups previous to the change in the Availability Group status is not guaranteed.</span></span>  
  
