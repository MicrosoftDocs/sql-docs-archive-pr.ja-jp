---
title: ログ配布とレプリケーション (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- replication [SQL Server], log shipping and
- log shipping [SQL Server], replication and
ms.assetid: 132bebfd-0206-4d23-829a-b38e5ed17bc9
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e3b1a0e08c5850b9e31202965909dfcfe1273e47
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87642294"
---
# <a name="log-shipping-and-replication-sql-server"></a><span data-ttu-id="0c182-102">ログ配布とレプリケーション (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="0c182-102">Log Shipping and Replication (SQL Server)</span></span>
  <span data-ttu-id="0c182-103">ログ配布では単一のデータベースの 2 つのコピーを使用します。通常、これらのコピーは異なるコンピューターに配置されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-103">Log shipping involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="0c182-104">クライアントが任意の時点において使用できるデータベースのコピーは 1 つだけです。</span><span class="sxs-lookup"><span data-stu-id="0c182-104">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="0c182-105">このコピーはプライマリ データベースと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="0c182-105">This copy is known as the primary database.</span></span> <span data-ttu-id="0c182-106">クライアントがプライマリ データベースに対して加えた更新は、ログ配布によってセカンダリ データベースと呼ばれるもう一方のコピー データベースに適用されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-106">Updates made by clients to the primary database are propagated by means of log shipping to the other copy of the database, known as the secondary database.</span></span> <span data-ttu-id="0c182-107">プライマリ データベースに対して行われた挿入、更新、および削除はすべてトランザクション ログに記録され、ログ配布によってこのトランザクション ログがセカンダリ データベースに適用されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-107">Log shipping involves applying the transaction log from every insertion, update, or deletion made on the primary database onto the secondary database.</span></span>  
  
 <span data-ttu-id="0c182-108">ログ配布はレプリケーションと組み合わせて使用できます。ログ配布とレプリケーションを併用した場合の動作を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="0c182-108">Log shipping can be used in conjunction with replication, with the following behavior:</span></span>  
  
-   <span data-ttu-id="0c182-109">ログ配布でフェールオーバーが発生すると、レプリケーションが停止します。</span><span class="sxs-lookup"><span data-stu-id="0c182-109">Replication does not continue after a log shipping failover.</span></span> <span data-ttu-id="0c182-110">フェールオーバーが発生した場合、レプリケーション エージェントはセカンダリに接続しません。その結果、トランザクションがサブスクライバーにレプリケートされなくなります。</span><span class="sxs-lookup"><span data-stu-id="0c182-110">If a failover occurs, replication agents do not connect to the secondary, so transactions are not replicated to Subscribers.</span></span> <span data-ttu-id="0c182-111">プライマリへのフェールバックが行われると、レプリケーションが再開されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-111">If a failback to the primary occurs, replication resumes.</span></span> <span data-ttu-id="0c182-112">ログ配布によってセカンダリからプライマリにコピーされたすべてのトランザクションがサブスクライバーにレプリケートされます。</span><span class="sxs-lookup"><span data-stu-id="0c182-112">All transactions that log shipping copies from the secondary back to the primary are replicated to Subscribers.</span></span>  
  
-   <span data-ttu-id="0c182-113">プライマリが完全に失われた場合、セカンダリの名前を変更してレプリケーションを継続できます。</span><span class="sxs-lookup"><span data-stu-id="0c182-113">If the primary is permanently lost, the secondary can be renamed so that replication can continue.</span></span> <span data-ttu-id="0c182-114">このトピックの残りの部分では、こうしたケースを処理する場合の要件と手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="0c182-114">The remainder of this topic describes the requirements and procedures for handling this case.</span></span> <span data-ttu-id="0c182-115">ログ配布を使用する最も一般的なデータベースであるパブリケーション データベースを例として使用します。ただし、サブスクリプション データベースおよびディストリビューション データベースについても同様の手順を適用できます。</span><span class="sxs-lookup"><span data-stu-id="0c182-115">The example given is the publication database, which is the most common database to log ship, but a similar process can also be applied to subscription and distribution databases.</span></span>  
  
 <span data-ttu-id="0c182-116">レプリケーションを再構成することなく、レプリケーションに関連するデータベースを復元する場合の詳細については、「 [レプリケートされたデータベースのバックアップと復元](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="0c182-116">For information about recovering databases involved in replication without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="0c182-117">パブリケーション データベースの可用性を提供することが目的の場合は、ログ配布ではなく、データベース ミラーリングを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="0c182-117">We recommend using database mirroring, rather than log shipping, to provide availability for the publication database.</span></span> <span data-ttu-id="0c182-118">詳細については、「 [データベース ミラーリングとレプリケーション &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="0c182-118">For more information, see [Database Mirroring and Replication &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span></span>  
  
## <a name="requirements-and-procedures-for-replicating-from-the-secondary-if-the-primary-is-lost"></a><span data-ttu-id="0c182-119">プライマリが失われた場合にセカンダリからレプリケートを行うための要件と手順</span><span class="sxs-lookup"><span data-stu-id="0c182-119">Requirements and Procedures for Replicating from the Secondary If the Primary Is Lost</span></span>  
 <span data-ttu-id="0c182-120">以下の要件および考慮事項に注意してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-120">Be aware of the following requirements and considerations:</span></span>  
  
-   <span data-ttu-id="0c182-121">プライマリに複数のパブリケーション データベースが格納されている場合、すべてのパブリケーション データベースのログが同一のセカンダリに配布されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-121">If a primary contains more than one publication database, log ship all of the publication databases to the same secondary.</span></span>  
  
-   <span data-ttu-id="0c182-122">セカンダリ サーバー インスタンスのインストール パスは、プライマリ サーバー インスタンスのインストール パスと同一にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-122">The installation path for the secondary server instance must be the same as the primary.</span></span> <span data-ttu-id="0c182-123">セカンダリ サーバー上のユーザー データベースの場所は、プライマリ サーバー上の場所と同一にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-123">User database locations on the secondary server must be the same as on the primary.</span></span>  
  
-   <span data-ttu-id="0c182-124">プライマリでサービス マスター キーをバックアップします。</span><span class="sxs-lookup"><span data-stu-id="0c182-124">Back up the service master key at the primary.</span></span> <span data-ttu-id="0c182-125">このキーはセカンダリで復元されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-125">This key will be restored at the secondary.</span></span> <span data-ttu-id="0c182-126">詳細については、「[BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-126">For more information, see [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span></span>  
  
-   <span data-ttu-id="0c182-127">ログ配布では、データ損失の回避は保障されません。</span><span class="sxs-lookup"><span data-stu-id="0c182-127">Log shipping does not guarantee against data loss.</span></span> <span data-ttu-id="0c182-128">プライマリ データベースで障害が発生した場合、バックアップされていないデータが失われたり、障害時にバックアップ用のデータが失われる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-128">A failure on the primary database can result in the loss of data that has not yet been backed up or for backups that are lost during the failure.</span></span>  
  
### <a name="log-shipping-with-transactional-replication"></a><span data-ttu-id="0c182-129">トランザクション レプリケーションのログ配布</span><span class="sxs-lookup"><span data-stu-id="0c182-129">Log Shipping with Transactional Replication</span></span>  
 <span data-ttu-id="0c182-130">トランザクション レプリケーションの場合、ログ配布の動作は **sync with backup** オプションの設定によって異なります。</span><span class="sxs-lookup"><span data-stu-id="0c182-130">For transactional replication, the behavior of log shipping depends on the **sync with backup** option.</span></span> <span data-ttu-id="0c182-131">このオプションは、パブリケーション データベースおよびディストリビューション データベースで設定できます。パブリッシャーのログ配布では、パブリケーション データベースでの設定のみが関係します。</span><span class="sxs-lookup"><span data-stu-id="0c182-131">This option can be set on the publication database and distribution database; in log shipping for the Publisher, only the setting on the publication database is relevant.</span></span>  
  
 <span data-ttu-id="0c182-132">パブリケーション データベースでこのオプションを設定すると、パブリケーション データベースでのバックアップが終了するまで、トランザクションがディストリビューション データベースに配信されることはなくなります。</span><span class="sxs-lookup"><span data-stu-id="0c182-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="0c182-133">これにより、セカンダリ サーバーでパブリケーション データベースの最後のバックアップを復元したときに、復元されたパブリケーション データベースにないトランザクションが、ディストリビューション データベースに存在する可能性がなくなります。</span><span class="sxs-lookup"><span data-stu-id="0c182-133">The last publication database backup can then be restored at the secondary server without any possibility of the distribution database having transactions that the restored publication database does not have.</span></span> <span data-ttu-id="0c182-134">このオプションを設定すると、パブリッシャーがセカンダリ サーバーにフェールオーバーした場合でも、パブリッシャー、ディストリビューター、およびサブスクライバーの間で一貫性が保持されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-134">This option guarantees that if the Publisher fails over to a secondary server, consistency is maintained between the Publisher, Distributor, and Subscribers.</span></span> <span data-ttu-id="0c182-135">パブリッシャーでのバックアップが終了するまでの間、トランザクションがディストリビューション データベースに配信されなくなるため、レプリケーションの待機時間とスループットが影響を受けることになります。アプリケーションがこうした待機時間の遅延を許容できる場合は、パブリケーション データベースでこのオプションを設定することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="0c182-135">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher; if your application can tolerate this latency, we recommend that you set this option on the publication database.</span></span> <span data-ttu-id="0c182-136">**sync with backup** オプションが設定されていない場合は、セカンダリ サーバーで復元されたデータベースに含まれていない変更をサブスクライバーが受信する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-136">If the **sync with backup** option is not set, Subscribers might receive changes that are no longer included in the recovered database at the secondary server.</span></span> <span data-ttu-id="0c182-137">詳細については、「 [スナップショット レプリケーションおよびトランザクション レプリケーションのバックアップと復元の方式](../../relational-databases/replication/transactional/transactional-replication.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-137">For more information, see [Strategies for Backing Up and Restoring Snapshot and Transactional Replication](../../relational-databases/replication/transactional/transactional-replication.md).</span></span>  
  
 <span data-ttu-id="0c182-138">**sync with backup オプションを使用してトランザクション レプリケーションとログ配布を構成するには**</span><span class="sxs-lookup"><span data-stu-id="0c182-138">**To configure transactional replication and log shipping with the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="0c182-139">パブリケーション データベースで sync with backup オプションが設定されていない場合は、 `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`を実行します。</span><span class="sxs-lookup"><span data-stu-id="0c182-139">If the sync with backup option is not set on the publication database, execute `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span></span> <span data-ttu-id="0c182-140">詳細については、「[sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-140">For more information, see [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span>  
  
2.  <span data-ttu-id="0c182-141">パブリケーション データベースに対してログ配布を構成します。</span><span class="sxs-lookup"><span data-stu-id="0c182-141">Configure log shipping for the publication database.</span></span> <span data-ttu-id="0c182-142">詳細については、「 [ログ配布の構成 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)で導入されました。</span><span class="sxs-lookup"><span data-stu-id="0c182-142">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="0c182-143">パブリッシャーに障害が発生した場合は、RESTORE LOG の KEEP_REPLICATION オプションを使用して、データベースの最新のログをセカンダリ サーバーに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-143">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="0c182-144">これにより、データベースのレプリケーション設定がすべて保持されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-144">This retains all replication settings for the database.</span></span> <span data-ttu-id="0c182-145">詳細については、「[ログ配布のセカンダリへのフェールオーバー &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md)」および「[RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-145">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="0c182-146">**msdb** データベースおよび **master** データベースをプライマリからセカンダリに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-146">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="0c182-147">詳細については、「[システム データベースのバックアップと復元 &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-147">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="0c182-148">プライマリがディストリビューターでもある場合は、ディストリビューション データベースをプライマリからセカンダリに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-148">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="0c182-149">これらのデータベースのレプリケーション構成およびレプリケーション設定が、プライマリのパブリケーション データベースと一致する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-149">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="0c182-150">セカンダリ サーバーでコンピューター名を変更し、次にプライマリ サーバー名と一致するように [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のインスタンス名を変更します。</span><span class="sxs-lookup"><span data-stu-id="0c182-150">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="0c182-151">コンピューター名の変更の詳細については、Windows のマニュアルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-151">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="0c182-152">サーバーの名前変更の詳細については、「 [SQL Server のスタンドアロン インスタンスをホストするコンピューターの名前変更](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) 」および「 [SQL Server のフェールオーバー クラスター インスタンスの名前変更](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="0c182-152">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
6.  <span data-ttu-id="0c182-153">プライマリからバックアップしたサービス マスター キーをセカンダリ サーバーで復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-153">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="0c182-154">詳細については、「[RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-154">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
 <span data-ttu-id="0c182-155">**sync with backup オプションを使用しないでトランザクション レプリケーションとログ配布を構成するには**</span><span class="sxs-lookup"><span data-stu-id="0c182-155">**To configure transactional replication and log shipping without the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="0c182-156">パブリケーション データベースに対してログ配布を構成します。</span><span class="sxs-lookup"><span data-stu-id="0c182-156">Configure log shipping for the publication database.</span></span> <span data-ttu-id="0c182-157">詳細については、「 [ログ配布の構成 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)で導入されました。</span><span class="sxs-lookup"><span data-stu-id="0c182-157">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="0c182-158">パブリッシャーに障害が発生した場合は、RESTORE LOG の KEEP_REPLICATION オプションを使用して、データベースの最新のログをセカンダリ サーバーに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-158">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="0c182-159">これにより、データベースのレプリケーション設定がすべて保持されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-159">This retains all replication settings for the database.</span></span> <span data-ttu-id="0c182-160">詳細については、「[ログ配布のセカンダリへのフェールオーバー &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md)」および「[RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-160">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
3.  <span data-ttu-id="0c182-161">**msdb** データベースおよび **master** データベースをプライマリからセカンダリに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-161">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="0c182-162">詳細については、「[システム データベースのバックアップと復元 &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-162">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="0c182-163">プライマリがディストリビューターでもある場合は、ディストリビューション データベースをプライマリからセカンダリに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-163">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="0c182-164">これらのデータベースのレプリケーション構成およびレプリケーション設定が、プライマリのパブリケーション データベースと一致する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-164">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
4.  <span data-ttu-id="0c182-165">セカンダリ サーバーでコンピューター名を変更し、次にプライマリ サーバー名と一致するように [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のインスタンス名を変更します。</span><span class="sxs-lookup"><span data-stu-id="0c182-165">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="0c182-166">コンピューター名の変更の詳細については、Windows のマニュアルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-166">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="0c182-167">サーバーの名前変更の詳細については、「 [SQL Server のスタンドアロン インスタンスをホストするコンピューターの名前変更](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) 」および「 [SQL Server のフェールオーバー クラスター インスタンスの名前変更](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="0c182-167">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
     <span data-ttu-id="0c182-168">パブリケーション データベースとディストリビューション データベースが同期していないことを示す、ログ リーダー エージェントのエラー メッセージが表示される場合があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-168">You might receive an error message from the Log Reader Agent that the publication database and the distribution database are not synchronized.</span></span>  
  
5.  <span data-ttu-id="0c182-169">プライマリからバックアップしたサービス マスター キーをセカンダリ サーバーで復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-169">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="0c182-170">詳細については、「[RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-170">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="0c182-171">**sp_replrestart** を実行します。</span><span class="sxs-lookup"><span data-stu-id="0c182-171">Execute **sp_replrestart**.</span></span> <span data-ttu-id="0c182-172">このストアド プロシージャを使用すると、パブリケーション データベースのログに記録されたレプリケート済みのトランザクションが、ログ リーダー エージェントによってすべて無視されることになります。</span><span class="sxs-lookup"><span data-stu-id="0c182-172">This stored procedure can be used to force the Log Reader Agent to ignore all the previous replicated transactions in the publication database log.</span></span> <span data-ttu-id="0c182-173">ストアド プロシージャが完了した後で適用されたトランザクションは、ログ リーダー エージェントによって処理されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-173">Transactions applied after the completion of the stored procedure are processed by the Log Reader Agent.</span></span> <span data-ttu-id="0c182-174">詳細については、「[sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-174">For more information, see [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span></span>  
  
7.  <span data-ttu-id="0c182-175">ストアド プロシージャが正常に終了したら、ログ リーダー エージェントを再起動します。</span><span class="sxs-lookup"><span data-stu-id="0c182-175">Restart the Log Reader Agent after the stored procedure executes successfully.</span></span> <span data-ttu-id="0c182-176">詳細については、「[レプリケーション エージェントを起動および停止する &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-176">For more information, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span>  
  
8.  <span data-ttu-id="0c182-177">サブスクライバーに既に配信されたトランザクションがパブリッシャーで適用される場合があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-177">Transactions that have already been distributed to Subscriber might be applied at the Publisher.</span></span> <span data-ttu-id="0c182-178">これらのトランザクションをサブスクライバーで再適用する場合に、ディストリビューション エージェントがエラーで異常終了しないようにするには、" **データ一貫性エラー時続行**" という名前のエージェント プロファイルを指定します。</span><span class="sxs-lookup"><span data-stu-id="0c182-178">To ensure that the Distribution Agent does not fail with an error when attempting to reapply these transactions at a Subscriber, specify the agent profile titled **Continue On Data Consistency Errors**.</span></span>  
  
### <a name="log-shipping-with-merge-replication"></a><span data-ttu-id="0c182-179">マージ レプリケーションのログ配布</span><span class="sxs-lookup"><span data-stu-id="0c182-179">Log Shipping with Merge Replication</span></span>  
 <span data-ttu-id="0c182-180">マージ レプリケーションとログ配布を構成するには、以下の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="0c182-180">Follow the steps in the procedure below to configure merge replication and log shipping.</span></span>  
  
 <span data-ttu-id="0c182-181">**マージ レプリケーションとログ配布を構成するには**</span><span class="sxs-lookup"><span data-stu-id="0c182-181">**To configure merge replication and log shipping**</span></span>  
  
1.  <span data-ttu-id="0c182-182">パブリケーション データベースに対してログ配布を構成します。</span><span class="sxs-lookup"><span data-stu-id="0c182-182">Configure log shipping for the publication database.</span></span> <span data-ttu-id="0c182-183">詳細については、「 [ログ配布の構成 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)で導入されました。</span><span class="sxs-lookup"><span data-stu-id="0c182-183">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="0c182-184">パブリッシャーに障害が発生した場合は、セカンダリ サーバーでコンピューター名を変更し、次にプライマリ サーバー名と一致するように [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のインスタンス名を変更します。</span><span class="sxs-lookup"><span data-stu-id="0c182-184">If the Publisher fails, at the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="0c182-185">コンピューター名の変更の詳細については、Windows のマニュアルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-185">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="0c182-186">サーバーの名前変更の詳細については、「 [SQL Server のスタンドアロン インスタンスをホストするコンピューターの名前変更](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) 」および「 [SQL Server のフェールオーバー クラスター インスタンスの名前変更](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="0c182-186">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
3.  <span data-ttu-id="0c182-187">RESTORE LOG の KEEP_REPLICATION オプションを使用して、データベースの最新のログをセカンダリ サーバーに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-187">Restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="0c182-188">これにより、データベースのレプリケーション設定がすべて保持されます。</span><span class="sxs-lookup"><span data-stu-id="0c182-188">This retains all replication settings for the database.</span></span> <span data-ttu-id="0c182-189">詳細については、「[ログ配布のセカンダリへのフェールオーバー &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md)」および「[RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-189">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="0c182-190">**msdb** データベースおよび **master** データベースをプライマリからセカンダリに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-190">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="0c182-191">詳細については、「[システム データベースのバックアップと復元 &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-191">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="0c182-192">プライマリがディストリビューターでもある場合は、ディストリビューション データベースをプライマリからセカンダリに復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-192">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="0c182-193">これらのデータベースのレプリケーション構成およびレプリケーション設定が、プライマリのパブリケーション データベースと一致する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-193">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="0c182-194">プライマリからバックアップしたサービス マスター キーをセカンダリ サーバーで復元します。</span><span class="sxs-lookup"><span data-stu-id="0c182-194">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="0c182-195">詳細については、「[RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-195">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="0c182-196">パブリケーション データベースを 1 つ以上のサブスクリプション データベースと同期します。</span><span class="sxs-lookup"><span data-stu-id="0c182-196">Synchronize the publication database with one or more subscription databases.</span></span> <span data-ttu-id="0c182-197">これにより、復元されたバックアップに反映されていないパブリケーション データベースの変更をアップロードできます。</span><span class="sxs-lookup"><span data-stu-id="0c182-197">This allows you to upload those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="0c182-198">アップロードできるデータは、パブリケーションのフィルター選択方法によって次のように異なります。</span><span class="sxs-lookup"><span data-stu-id="0c182-198">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
    -   <span data-ttu-id="0c182-199">パブリケーションがフィルター選択されていない場合は、最新のサブスクライバーと同期することでパブリケーション データベースを最新の状態に更新できます。</span><span class="sxs-lookup"><span data-stu-id="0c182-199">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
    -   <span data-ttu-id="0c182-200">パブリケーションがフィルター選択されている場合は、パブリケーションを最新の状態に更新できない場合があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-200">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="0c182-201">各サブスクリプションが 1 つの地域の顧客データのみを受信できるようにパーティション分割されているテーブルがあるとします。北、東、南、西のいずれかです。</span><span class="sxs-lookup"><span data-stu-id="0c182-201">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="0c182-202">データの各パーティションに 1 つ以上のサブスクライバーがある場合、各パーティションのサブスクライバーと同期することにより、パブリケーション データベースを最新の状態に更新できます。</span><span class="sxs-lookup"><span data-stu-id="0c182-202">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="0c182-203">ただし、たとえば、西パーティションのデータがすべてのサブスクライバーにレプリケートされていない場合は、パブリッシャーでこのデータを最新の状態に更新することはできません。</span><span class="sxs-lookup"><span data-stu-id="0c182-203">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span> <span data-ttu-id="0c182-204">この場合、パブリッシャーとサブスクライバーのデータが集約するように、すべてのサブスクリプションを再初期化することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="0c182-204">In this case, we recommend reinitializing all subscriptions so that the data at the Publisher and Subscribers converges.</span></span> <span data-ttu-id="0c182-205">詳細については、「 [サブスクリプションの再初期化](../../relational-databases/replication/reinitialize-subscriptions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-205">For more information, see [Reinitialize Subscriptions](../../relational-databases/replication/reinitialize-subscriptions.md).</span></span>  
  
     <span data-ttu-id="0c182-206">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] よりも前のバージョンの [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]を実行しているサブスクライバーと同期する場合は、サブスクリプションを匿名にすることはできません。このサブスクリプションはクライアント サブスクリプションまたはサーバー サブスクリプション (以前のリリースではローカル サブスクリプションとグローバル サブスクリプションと呼ばれていました) にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c182-206">If you synchronize with a Subscriber that is running a version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] prior to [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span> <span data-ttu-id="0c182-207">詳細については、「 [データの同期](../../relational-databases/replication/synchronize-data.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c182-207">For more information, see [Synchronize Data](../../relational-databases/replication/synchronize-data.md).</span></span>   
  
## <a name="see-also"></a><span data-ttu-id="0c182-208">参照</span><span class="sxs-lookup"><span data-stu-id="0c182-208">See Also</span></span>  
 <span data-ttu-id="0c182-209">[SQL Server のレプリケーション](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="0c182-209">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="0c182-210">[ログ配布について &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="0c182-210">[About Log Shipping &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span></span>  
 [<span data-ttu-id="0c182-211">データベース ミラーリングとレプリケーション &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="0c182-211">Database Mirroring and Replication &#40;SQL Server&#41;</span></span>](../database-mirroring/database-mirroring-and-replication-sql-server.md)  
  
  
