---
title: ログ配布の監視 (Transact-SQL) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], status
- history tables [SQL Server]
- historical information [SQL Server], log shipping
- log shipping [SQL Server], monitoring
- alerts [SQL Server], log shipping
- status information [SQL Server], log shipping
- monitoring log shipping [SQL Server]
ms.assetid: acf3cd99-55f7-4287-8414-0892f830f423
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0ab87d5d8aa08b7b2860fe52fd097f33af327a94
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87633992"
---
# <a name="monitor-log-shipping-transact-sql"></a><span data-ttu-id="67c87-102">ログ配布の監視 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="67c87-102">Monitor Log Shipping (Transact-SQL)</span></span>
  <span data-ttu-id="67c87-103">ログ配布を構成すると、すべてのログ配布サーバーの状態に関する情報を監視できます。</span><span class="sxs-lookup"><span data-stu-id="67c87-103">After you have configured log shipping, you can monitor information about the status of all the log shipping servers.</span></span> <span data-ttu-id="67c87-104">ログ配布操作の履歴と状態は、ログ配布ジョブにより、常にローカルに保存されます。</span><span class="sxs-lookup"><span data-stu-id="67c87-104">The history and status of log shipping operations are always saved locally by the log shipping jobs.</span></span> <span data-ttu-id="67c87-105">バックアップ操作の履歴と状態はプライマリ サーバーに格納され、コピー操作と復元操作の履歴と状態はセカンダリ サーバーに格納されます。</span><span class="sxs-lookup"><span data-stu-id="67c87-105">The history and status of the backup operation are stored at the primary server, and the history and status of the copy and restore operations are stored at the secondary server.</span></span> <span data-ttu-id="67c87-106">リモートの監視サーバーを実装している場合、この情報はリモートの監視サーバーにも格納されます。</span><span class="sxs-lookup"><span data-stu-id="67c87-106">If you have implemented a remote monitor server, this information is also stored on the monitor server.</span></span>  
  
 <span data-ttu-id="67c87-107">ログ配布操作がスケジュールどおりに実行されなかった場合に警告を発生させることができます。</span><span class="sxs-lookup"><span data-stu-id="67c87-107">You can configure alerts that will fire if log shipping operations fail to occur as scheduled.</span></span> <span data-ttu-id="67c87-108">エラーは、バックアップ操作と復元操作の状態を監視する警告ジョブによって発生します。</span><span class="sxs-lookup"><span data-stu-id="67c87-108">Errors are raised by an alert job that watches the status of the backup and restore operations.</span></span> <span data-ttu-id="67c87-109">これらのエラーの発生をオペレーターに通知する警告を定義できます。</span><span class="sxs-lookup"><span data-stu-id="67c87-109">You can define alerts that notify an operator when these errors are raised.</span></span> <span data-ttu-id="67c87-110">監視サーバーを構成している場合、警告ジョブは、ログ配布構成に関するすべての操作に対してエラーを発生させる監視サーバーで実行されます。</span><span class="sxs-lookup"><span data-stu-id="67c87-110">If a monitor server is configured, one alert job runs on the monitor server that raises errors for all operations in the log shipping configuration.</span></span> <span data-ttu-id="67c87-111">監視サーバーが指定されていない場合、警告ジョブは、バックアップ操作を監視しているプライマリ サーバー インスタンスで実行されます。</span><span class="sxs-lookup"><span data-stu-id="67c87-111">If a monitor server is not specified, an alert job runs on the primary server instance, which monitors the backup operation.</span></span> <span data-ttu-id="67c87-112">監視サーバーが指定されていない場合、警告ジョブは、ローカルのコピー操作と復元操作を監視している各セカンダリ サーバー インスタンスでも実行されます。</span><span class="sxs-lookup"><span data-stu-id="67c87-112">If a monitor server is not specified, an alert job also runs on each secondary server instance to monitor the local copy and restore operations.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="67c87-113">ログ配布構成を監視するには、ログ配布を有効にするときに監視サーバーを追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="67c87-113">To monitor a log shipping configuration, you must add the monitor server when you enable log shipping.</span></span> <span data-ttu-id="67c87-114">監視サーバーを後で追加する場合は、ログ配布構成を削除して、代わりに監視サーバーを含む新しい構成を用意します。</span><span class="sxs-lookup"><span data-stu-id="67c87-114">If you add a monitor server later, you must remove the log shipping configuration and then replace it with a new configuration that includes a monitor server.</span></span> <span data-ttu-id="67c87-115">詳細については、「 [ログ配布の構成 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)で導入されました。</span><span class="sxs-lookup"><span data-stu-id="67c87-115">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span> <span data-ttu-id="67c87-116">監視サーバーは、一度構成すると、最初にログ配布を削除しない限り変更できません。</span><span class="sxs-lookup"><span data-stu-id="67c87-116">Furthermore, after the monitor server has been configured, it cannot be changed without removing log shipping first.</span></span>  
  
## <a name="history-tables-containing-monitoring-information"></a><span data-ttu-id="67c87-117">監視情報を含む履歴テーブル</span><span class="sxs-lookup"><span data-stu-id="67c87-117">History Tables Containing Monitoring Information</span></span>  
 <span data-ttu-id="67c87-118">監視の履歴テーブルには、監視サーバーに格納されているメタデータが含まれています。</span><span class="sxs-lookup"><span data-stu-id="67c87-118">The monitoring history tables contain metadata that is stored on the monitor server.</span></span> <span data-ttu-id="67c87-119">また、指定されているプライマリ サーバーやセカンダリ サーバーに固有の情報のコピーもローカルに格納されています。</span><span class="sxs-lookup"><span data-stu-id="67c87-119">A copy of information specific to a given primary or secondary server is also stored locally.</span></span>  
  
 <span data-ttu-id="67c87-120">これらのテーブルでクエリを実行して、ログ配布セッションの状態を監視できます。</span><span class="sxs-lookup"><span data-stu-id="67c87-120">You can query these tables to monitor the status of a log shipping session.</span></span> <span data-ttu-id="67c87-121">たとえば、ログ配布の状態を参照するには、バックアップ ジョブ、コピー ジョブ、および復元ジョブの状態と履歴を確認します。</span><span class="sxs-lookup"><span data-stu-id="67c87-121">For example, to learn status of log shipping, check the status and history of the backup job, copy job, and restore job.</span></span> <span data-ttu-id="67c87-122">以下の監視テーブルをクエリすることにより、特定のログ配布の履歴とエラーの詳細を参照できます。</span><span class="sxs-lookup"><span data-stu-id="67c87-122">You can view specific log shipping history and error details by querying the following monitoring tables.</span></span>  
  
|<span data-ttu-id="67c87-123">テーブル</span><span class="sxs-lookup"><span data-stu-id="67c87-123">Table</span></span>|<span data-ttu-id="67c87-124">説明</span><span class="sxs-lookup"><span data-stu-id="67c87-124">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="67c87-125">log_shipping_monitor_alert</span><span class="sxs-lookup"><span data-stu-id="67c87-125">log_shipping_monitor_alert</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-alert-transact-sql)|<span data-ttu-id="67c87-126">警告ジョブ ID を格納します。</span><span class="sxs-lookup"><span data-stu-id="67c87-126">Stores alert job ID.</span></span>|  
|[<span data-ttu-id="67c87-127">log_shipping_monitor_error_detail</span><span class="sxs-lookup"><span data-stu-id="67c87-127">log_shipping_monitor_error_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-error-detail-transact-sql)|<span data-ttu-id="67c87-128">ログ配布ジョブのエラーの詳細を格納します。</span><span class="sxs-lookup"><span data-stu-id="67c87-128">Stores error details for log shipping jobs.</span></span> <span data-ttu-id="67c87-129">このテーブルをクエリして、あるエージェント セッションのエラーを参照することができます。</span><span class="sxs-lookup"><span data-stu-id="67c87-129">You can query this table see the errors for an agent session.</span></span> <span data-ttu-id="67c87-130">必要に応じて、エラーが記録された日付と時刻でエラーを並べ替えることができます。</span><span class="sxs-lookup"><span data-stu-id="67c87-130">Optionally, you can sort the errors by the date and time at which each was logged.</span></span> <span data-ttu-id="67c87-131">各エラーは一連の例外として記録されるので、1 つのエージェント セッションで複数のエラー (シーケンス) が記録されることがあります。</span><span class="sxs-lookup"><span data-stu-id="67c87-131">Each error is logged as a sequence of exceptions, and multiple errors (sequences) can per agent session.</span></span>|  
|[<span data-ttu-id="67c87-132">log_shipping_monitor_history_detail</span><span class="sxs-lookup"><span data-stu-id="67c87-132">log_shipping_monitor_history_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-history-detail-transact-sql)|<span data-ttu-id="67c87-133">ログ配布エージェントの履歴の詳細情報を格納します。</span><span class="sxs-lookup"><span data-stu-id="67c87-133">Contains history details for log shipping agents.</span></span> <span data-ttu-id="67c87-134">このテーブルをクエリして、エージェント セッションの履歴の詳細情報を参照することができます。</span><span class="sxs-lookup"><span data-stu-id="67c87-134">You can query this table to see the history detail for an agent session.</span></span>|  
|[<span data-ttu-id="67c87-135">log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="67c87-135">log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="67c87-136">ログ配布構成ごとに、前回のバックアップ ファイルおよび監視に役立つ最後に復元したファイルに関する情報を含む、プライマリ データの管理レコードを格納します。</span><span class="sxs-lookup"><span data-stu-id="67c87-136">Stores one monitor record for the primary database in each log shipping configuration, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
|[<span data-ttu-id="67c87-137">log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="67c87-137">log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="67c87-138">前回のバックアップ ファイルおよび監視に役立つ最後に復元したファイルに関する情報を含む、セカンダリ データの管理レコードを格納します。</span><span class="sxs-lookup"><span data-stu-id="67c87-138">Stores one monitor record for each secondary database, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
  
## <a name="stored-procedures-for-monitoring-log-shipping"></a><span data-ttu-id="67c87-139">ログ配布を監視するためのストアド プロシージャ</span><span class="sxs-lookup"><span data-stu-id="67c87-139">Stored Procedures for Monitoring Log Shipping</span></span>  
 <span data-ttu-id="67c87-140">監視情報と履歴情報は、 **msdb**のテーブルに格納されます。このテーブルには、ログ配布ストアド プロシージャを使用してアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="67c87-140">Monitoring and history information is stored in tables in **msdb**, which can be accessed using log shipping stored procedures.</span></span> <span data-ttu-id="67c87-141">次の表に示すサーバーで、これらのストアド プロシージャを実行します。</span><span class="sxs-lookup"><span data-stu-id="67c87-141">Run these stored procedures on the servers indicated in the following table.</span></span>  
  
|<span data-ttu-id="67c87-142">ストアド プロシージャ</span><span class="sxs-lookup"><span data-stu-id="67c87-142">Stored procedure</span></span>|<span data-ttu-id="67c87-143">説明</span><span class="sxs-lookup"><span data-stu-id="67c87-143">Description</span></span>|<span data-ttu-id="67c87-144">プロシージャを実行するサーバー</span><span class="sxs-lookup"><span data-stu-id="67c87-144">Run this procedure on</span></span>|  
|----------------------|-----------------|---------------------------|  
|[<span data-ttu-id="67c87-145">sp_help_log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="67c87-145">sp_help_log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="67c87-146">**log_shipping_monitor_primary** テーブルから、指定したプライマリ データベースの監視レコードを返します。</span><span class="sxs-lookup"><span data-stu-id="67c87-146">Returns monitor records for the specified primary database from the **log_shipping_monitor_primary** table.</span></span>|<span data-ttu-id="67c87-147">監視サーバーまたはプライマリ サーバー</span><span class="sxs-lookup"><span data-stu-id="67c87-147">Monitor server or primary server</span></span>|  
|[<span data-ttu-id="67c87-148">sp_help_log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="67c87-148">sp_help_log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="67c87-149">**log_shipping_monitor_secondary** テーブルから、指定したセカンダリ データベースの監視レコードを返します。</span><span class="sxs-lookup"><span data-stu-id="67c87-149">Returns monitor records for the specified secondary database from the **log_shipping_monitor_secondary** table.</span></span>|<span data-ttu-id="67c87-150">監視サーバーまたはセカンダリ サーバー</span><span class="sxs-lookup"><span data-stu-id="67c87-150">Monitor server or secondary server</span></span>|  
|[<span data-ttu-id="67c87-151">sp_help_log_shipping_alert_job</span><span class="sxs-lookup"><span data-stu-id="67c87-151">sp_help_log_shipping_alert_job</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-alert-job-transact-sql)|<span data-ttu-id="67c87-152">警告ジョブのジョブ ID を返します。</span><span class="sxs-lookup"><span data-stu-id="67c87-152">Returns the job ID of the alert job.</span></span>|<span data-ttu-id="67c87-153">監視サーバー (監視サーバーが定義されていない場合はプライマリ サーバーまたはセカンダリ サーバー)</span><span class="sxs-lookup"><span data-stu-id="67c87-153">Monitor server, or primary or secondary server if no monitor is defined</span></span>|  
|[<span data-ttu-id="67c87-154">sp_help_log_shipping_primary_database</span><span class="sxs-lookup"><span data-stu-id="67c87-154">sp_help_log_shipping_primary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-database-transact-sql)|<span data-ttu-id="67c87-155">プライマリ データベースの設定を取得し、 **log_shipping_primary_databases** テーブルと **log_shipping_monitor_primary** テーブルの値を表示します。</span><span class="sxs-lookup"><span data-stu-id="67c87-155">Retrieves primary database settings and displays the values from the **log_shipping_primary_databases** and **log_shipping_monitor_primary** tables.</span></span>|<span data-ttu-id="67c87-156">プライマリ サーバー</span><span class="sxs-lookup"><span data-stu-id="67c87-156">Primary server</span></span>|  
|[<span data-ttu-id="67c87-157">sp_help_log_shipping_primary_secondary</span><span class="sxs-lookup"><span data-stu-id="67c87-157">sp_help_log_shipping_primary_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-secondary-transact-sql)|<span data-ttu-id="67c87-158">プライマリ データベースのセカンダリ データベース名を取得します。</span><span class="sxs-lookup"><span data-stu-id="67c87-158">Retrieves secondary database names for a primary database.</span></span>|<span data-ttu-id="67c87-159">プライマリ サーバー</span><span class="sxs-lookup"><span data-stu-id="67c87-159">Primary server</span></span>|  
|[<span data-ttu-id="67c87-160">sp_help_log_shipping_secondary_database</span><span class="sxs-lookup"><span data-stu-id="67c87-160">sp_help_log_shipping_secondary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-database-transact-sql)|<span data-ttu-id="67c87-161">**log_shipping_secondary**、 **log_shipping_secondary_databases** 、および **log_shipping_monitor_secondary** の各テーブルからセカンダリ データベースの設定を取得します。</span><span class="sxs-lookup"><span data-stu-id="67c87-161">Retrieves secondary-database settings from the **log_shipping_secondary**, **log_shipping_secondary_databases** and **log_shipping_monitor_secondary** tables.</span></span>|<span data-ttu-id="67c87-162">セカンダリ サーバー</span><span class="sxs-lookup"><span data-stu-id="67c87-162">Secondary server</span></span>|  
|[<span data-ttu-id="67c87-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="67c87-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-primary-transact-sql)|<span data-ttu-id="67c87-164">セカンダリ サーバーにある指定されたプライマリ データベースの設定を取得します。</span><span class="sxs-lookup"><span data-stu-id="67c87-164">This stored procedure retrieves the settings for a given primary database on the secondary server.</span></span>|<span data-ttu-id="67c87-165">セカンダリ サーバー</span><span class="sxs-lookup"><span data-stu-id="67c87-165">Secondary server</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="67c87-166">参照</span><span class="sxs-lookup"><span data-stu-id="67c87-166">See Also</span></span>  
 <span data-ttu-id="67c87-167">[ログ配布レポートの表示 &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span><span class="sxs-lookup"><span data-stu-id="67c87-167">[View the Log Shipping Report &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span></span>  
 [<span data-ttu-id="67c87-168">ログ配布のストアド プロシージャとテーブル</span><span class="sxs-lookup"><span data-stu-id="67c87-168">Log Shipping Stored Procedures and Tables</span></span>](log-shipping-tables-and-stored-procedures.md)  
  
  
