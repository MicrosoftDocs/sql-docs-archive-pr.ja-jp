---
title: SQL Server 2014 へのログ配布のアップグレード (Transact-sql) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 80330d03853c984cfd26100b02918eb218705085
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87645790"
---
# <a name="upgrade-log-shipping-to-sql-server-2014-transact-sql"></a><span data-ttu-id="46d4a-102">SQL Server 2014 へのログ配布のアップグレード (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="46d4a-102">Upgrade Log Shipping to SQL Server 2014 (Transact-SQL)</span></span>
  <span data-ttu-id="46d4a-103">[!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]、 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]、 [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]、または [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] から [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]にアップグレードする際には、ログ配布構成を保持することができます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-103">It is possible to preserve log shipping configurations when upgrading from [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)], or [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="46d4a-104">このトピックでは、ログ配布構成のアップグレードの複数のシナリオとベスト プラクティスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-104">This topic describes alternative scenarios and best practices for upgrading a log shipping configuration.</span></span>

> [!NOTE]
>  <span data-ttu-id="46d4a-105">[バックアップの圧縮](../../relational-databases/backup-restore/backup-compression-sql-server.md) は [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)]で導入されました。</span><span class="sxs-lookup"><span data-stu-id="46d4a-105">[Backup compression](../../relational-databases/backup-restore/backup-compression-sql-server.md) was introduced in [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span></span> <span data-ttu-id="46d4a-106">アップグレードされたログ配布構成では、 **バックアップの圧縮の既定** サーバー レベル構成オプションを使用して、トランザクション ログ バックアップ ファイルにバックアップ圧縮を使用するかどうかを制御します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-106">An upgraded log shipping configuration uses the **backup compression default** server-level configuration option to control whether backup compression is used for the transaction log backup files.</span></span> <span data-ttu-id="46d4a-107">ログ バックアップのバックアップ圧縮動作は、ログ配布構成ごとに指定できます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-107">The backup compression behavior of log backups can be specified for each log shipping configuration.</span></span> <span data-ttu-id="46d4a-108">詳細については、「 [ログ配布の構成 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)で導入されました。</span><span class="sxs-lookup"><span data-stu-id="46d4a-108">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>


##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a> <span data-ttu-id="46d4a-109">アップグレード前のデータの保護</span><span class="sxs-lookup"><span data-stu-id="46d4a-109">Protect Your Data Before the Upgrade</span></span>
 <span data-ttu-id="46d4a-110">ログ配布のアップグレードを行う前にデータを保護することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-110">As a best practice, we recommend that you protect your data before a log shipping upgrade.</span></span>

 <span data-ttu-id="46d4a-111">**データを保護するには**</span><span class="sxs-lookup"><span data-stu-id="46d4a-111">**To protect your data**</span></span>

1.  <span data-ttu-id="46d4a-112">すべてのプライマリ データベースを対象にデータベースの完全バックアップを実行します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-112">Perform a full database backup on every primary database.</span></span>

     <span data-ttu-id="46d4a-113">詳細については、「[データベースの完全バックアップの作成 &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-113">For more information, see [Create a Full Database Backup &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span></span>

2.  <span data-ttu-id="46d4a-114">すべてのプライマリ データベースで [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) コマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-114">Run the [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) command on every primary database.</span></span>

##  <a name="upgrading-the-monitor-server-instance"></a><a name="UpgradeMonitor"></a><span data-ttu-id="46d4a-115">監視サーバーインスタンスのアップグレード</span><span class="sxs-lookup"><span data-stu-id="46d4a-115">Upgrading the Monitor Server Instance</span></span>
 <span data-ttu-id="46d4a-116">監視サーバー インスタンスがある場合、そのインスタンスはいつアップグレードしてもかまいません。</span><span class="sxs-lookup"><span data-stu-id="46d4a-116">The monitor server instance, if any, can be upgraded at any time.</span></span>

 <span data-ttu-id="46d4a-117">監視サーバーのアップグレード中もログ配布構成は引き続き機能しますが、その状態は監視テーブルに記録されません。</span><span class="sxs-lookup"><span data-stu-id="46d4a-117">While the monitor server is being upgraded, the log shipping configuration continues to work, but its status is not recorded in the tables on the monitor.</span></span> <span data-ttu-id="46d4a-118">また、監視サーバーをアップグレードしている間は、構成されている警告がトリガーされません。</span><span class="sxs-lookup"><span data-stu-id="46d4a-118">Any alerts that have been configured will not be triggered while the monitor server is being upgraded.</span></span> <span data-ttu-id="46d4a-119">アップグレードの完了後、[sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) システム ストアド プロシージャを実行して監視テーブルの情報を更新できます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-119">After the upgrade, you can update the information in the monitor tables by executing the [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) system stored procedure.</span></span>

##  <a name="upgrading-log-shipping-configurations-with-a-single-secondary-server"></a><a name="UpgradeSingleSecondary"></a><span data-ttu-id="46d4a-120">単一のセカンダリサーバーを使用したログ配布構成のアップグレード</span><span class="sxs-lookup"><span data-stu-id="46d4a-120">Upgrading Log Shipping Configurations with a Single Secondary Server</span></span>
 <span data-ttu-id="46d4a-121">ここでは、プライマリ サーバーと単一のセカンダリ サーバーから成る構成のアップグレード プロセスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-121">The upgrade process described in this section assumes a configuration consisting of the primary server and only one secondary server.</span></span> <span data-ttu-id="46d4a-122">次の図はこの構成を表しています。図の A がプライマリ サーバー インスタンス、B が単一のセカンダリ サーバー インスタンスです。</span><span class="sxs-lookup"><span data-stu-id="46d4a-122">This configuration is represented in the following illustration, which shows a primary server instance, A, and a single secondary server instance, B.</span></span>

 <span data-ttu-id="46d4a-123">![セカンダリ サーバーが 1 台で、監視サーバーはなし](../media/ls-2-wayconfig-nomonitor.gif "セカンダリ サーバーが 1 台で、監視サーバーはなし")</span><span class="sxs-lookup"><span data-stu-id="46d4a-123">![One secondary server and no monitor server](../media/ls-2-wayconfig-nomonitor.gif "One secondary server and no monitor server")</span></span>

 <span data-ttu-id="46d4a-124">複数のセカンダリ サーバーのアップグレードについては、このトピックの「 [複数のセカンダリ サーバー インスタンスのアップグレード](#MultipleSecondaries)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-124">For information about upgrading multiple secondary servers, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>
 

###  <a name="upgrading-the-secondary-server-instance"></a><a name="UpgradeSecondary"></a><span data-ttu-id="46d4a-125">セカンダリサーバーインスタンスのアップグレード</span><span class="sxs-lookup"><span data-stu-id="46d4a-125">Upgrading the Secondary Server Instance</span></span>
 <span data-ttu-id="46d4a-126">このアップグレード プロセスでは、 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 以降のログ配布構成のセカンダリ サーバー インスタンスを [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] にアップグレードしてから、プライマリ サーバー インスタンスをアップグレードします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-126">The upgrade process involves upgrading the secondary server instances of a [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher log shipping configuration to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] before upgrading the primary server instance.</span></span> <span data-ttu-id="46d4a-127">常にセカンダリ サーバー インスタンスを先にアップグレードします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-127">Always upgrade the secondary server instance first.</span></span> <span data-ttu-id="46d4a-128">セカンダリ サーバーより先にプライマリ サーバーをアップグレードすると、ログ配布が失敗します。これは、新しいバージョンの [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] で作成されたバックアップを古いバージョンの [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]で復元することはできないためです。</span><span class="sxs-lookup"><span data-stu-id="46d4a-128">If the primary server were upgraded before a secondary server, log shipping would fail because a backup created on a newer version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cannot be restored on an older version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>

 <span data-ttu-id="46d4a-129">アップグレードされたセカンダリ サーバーでは引き続き [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 以降のプライマリ サーバーからログ バックアップの復元が行われるため、アップグレード プロセスの間もログ配布は継続されます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-129">Log shipping continues throughout the upgrade process because the upgraded secondary servers continue to restore the log backups from the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server.</span></span> <span data-ttu-id="46d4a-130">セカンダリ サーバー インスタンスのアップグレード プロセスの一部は、ログ配布構成にセカンダリ サーバーが複数あるかどうかによって異なります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-130">The process for upgrading the secondary server instances depends partly on whether the log shipping configuration possesses multiple secondary servers.</span></span> <span data-ttu-id="46d4a-131">詳細については、このトピックの「 [複数のセカンダリ サーバー インスタンスのアップグレード](#MultipleSecondaries)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-131">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

 <span data-ttu-id="46d4a-132">セカンダリ サーバー インスタンスをアップグレードしている間はログ配布のコピーと復元のジョブが実行されないため、復元されないトランザクション ログ バックアップが蓄積されていきます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-132">While the secondary server instance is being upgraded, the log shipping copy and restore jobs do not run, so unrestored transaction log backups will accumulate.</span></span> <span data-ttu-id="46d4a-133">蓄積される量は、プライマリ サーバーの定期バックアップの頻度に依存します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-133">The amount of accumulation depends on the frequency of scheduled backup on the primary server.</span></span> <span data-ttu-id="46d4a-134">また、独立した監視サーバーが構成されている場合は、構成されている間隔を経過しても復元が行われないことを知らせる警告が生成されることがあります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-134">Also, if a separate monitor server has been configured, alerts might be raised indicating restores have not been performed for longer than the configured interval.</span></span>

 <span data-ttu-id="46d4a-135">セカンダリ サーバーのアップグレードが完了すると、ログ配布エージェント ジョブが再開され、引き続きプライマリ サーバー インスタンス (サーバー A) のログ バックアップのコピーと復元が行われます。セカンダリ サーバーでセカンダリ データベースが最新の状態になるまでにかかる時間は、セカンダリ サーバーのアップグレードにかかった時間とプライマリ サーバーのバックアップの頻度に依存します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-135">Once the secondary server has been upgraded, the log shipping agents jobs resume and continue to copy and restore log backups from the primary server instance, server A. The amount of time required for the secondary server to bring the secondary database up to date varies, depending on the time taken to upgrade the secondary server and the frequency of the backups on the primary server.</span></span>

> [!NOTE]
>  <span data-ttu-id="46d4a-136">サーバー アップグレードの過程では、セカンダリ データベースの [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] データベースへのアップグレードは行われません。</span><span class="sxs-lookup"><span data-stu-id="46d4a-136">During the server upgrade, the secondary database is not upgraded to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database.</span></span> <span data-ttu-id="46d4a-137">データベースのアップグレードが行われるのは、データベースがオンラインになってからです。</span><span class="sxs-lookup"><span data-stu-id="46d4a-137">It will get upgraded only if it is brought online.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="46d4a-138">アップグレードが必要なデータベースに対しては RESTORE WITH STANDBY オプションはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="46d4a-138">The RESTORE WITH STANDBY option is not supported for a database that requires upgrading.</span></span> <span data-ttu-id="46d4a-139">アップグレードされたセカンダリ データベースが RESTORE WITH STANDBY を使用して構成されている場合、アップグレード後にトランザクション ログを復元できなくなります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-139">If an upgraded secondary database has been configured by using RESTORE WITH STANDBY, transaction logs can no longer be restored after upgrade.</span></span> <span data-ttu-id="46d4a-140">そのセカンダリ データベースでのログ配布を再開するには、そのスタンバイ サーバーでもう一度ログ配布を設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-140">To resume log shipping on that secondary database, you will need to set up log shipping again on that standby server.</span></span> <span data-ttu-id="46d4a-141">STANDBY オプションの詳細については、「 [RESTORE Arguments &#40;transact-sql&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-141">For more information about the STANDBY option, see [RESTORE Arguments &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span></span>

###  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> <span data-ttu-id="46d4a-142">プライマリ サーバー インスタンスのアップグレード</span><span class="sxs-lookup"><span data-stu-id="46d4a-142">Upgrading the Primary Server Instance</span></span>
 <span data-ttu-id="46d4a-143">アップグレードの計画では、データベースを使用できなくなる時間が重要な考慮事項になります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-143">When planning an upgrade, a significant consideration is the amount of time that your database will be unavailable.</span></span> <span data-ttu-id="46d4a-144">最も単純なシナリオでは、プライマリ サーバーをアップグレードする間、データベースを使用できなくなります (下のシナリオ 1)。</span><span class="sxs-lookup"><span data-stu-id="46d4a-144">The simplest upgrade scenario involves the database being unavailable while you upgrade the primary server (scenario 1, below).</span></span>

 <span data-ttu-id="46d4a-145">元のプライマリ サーバーをアップグレードする前に [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 以降のプライマリ サーバーを [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] セカンダリ サーバーにフェールオーバーすると、アップグレード プロセスはより複雑になりますが、データベースの可用性を最大限に高めることができます (下のシナリオ 2)。</span><span class="sxs-lookup"><span data-stu-id="46d4a-145">At the cost of a more complicated upgrade process, you can maximize your database availability by failing over the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] secondary server before upgrading the original primary server (scenario 2, below).</span></span> <span data-ttu-id="46d4a-146">フェールオーバーのシナリオは 2 種類あります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-146">There are two variants of the failover scenario.</span></span> <span data-ttu-id="46d4a-147">1 つは、元のプライマリ サーバーにスイッチ バックして、元のログ配布構成を引き続き使用するシナリオ。</span><span class="sxs-lookup"><span data-stu-id="46d4a-147">You can switch back to the original primary server and keep the original log shipping configuration.</span></span> <span data-ttu-id="46d4a-148">もう 1 つは、元のログ配布構成を削除してから元のプライマリ サーバーをアップグレードし、その後、新しいプライマリ サーバーを使用して新しい構成を作成するシナリオです。</span><span class="sxs-lookup"><span data-stu-id="46d4a-148">Alternatively, you can remove the original log shipping configuration before upgrading the original primary server and later create a new configuration using the new primary server.</span></span> <span data-ttu-id="46d4a-149">ここでは、この両方のシナリオについて説明します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-149">This section describes both these scenarios.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="46d4a-150">必ず、プライマリ サーバー インスタンスをアップグレードする前にセカンダリ サーバー インスタンスをアップグレードしてください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-150">Be sure to upgrade the secondary server instance before upgrading the primary server instance.</span></span> <span data-ttu-id="46d4a-151">詳細については、このトピックの「 [セカンダリ サーバー インスタンスのアップグレード](#UpgradeSecondary)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-151">For more information, see [Upgrading the Secondary Server Instance](#UpgradeSecondary), earlier in this topic.</span></span>


####  <a name="scenario-1-upgrade-primary-server-instance-without-failover"></a><a name="Scenario1"></a><span data-ttu-id="46d4a-152">シナリオ 1: フェールオーバーを使用せずにプライマリサーバーインスタンスをアップグレードする</span><span class="sxs-lookup"><span data-stu-id="46d4a-152">Scenario 1: Upgrade Primary Server Instance Without Failover</span></span>
 <span data-ttu-id="46d4a-153">このシナリオは、フェールオーバーを使用するシナリオより単純ですが、ダウンタイムが長くなります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-153">This is the simpler scenario, but it causes more downtime than using failover.</span></span> <span data-ttu-id="46d4a-154">プライマリ サーバー インスタンスを単純にアップグレードするため、その間データベースを使用できなくなります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-154">The primary server instance is simply upgraded and the database is unavailable during this upgrade.</span></span>

 <span data-ttu-id="46d4a-155">サーバーのアップグレードが完了すると、データベースが自動的にオンラインに戻り、データベースのアップグレードが行われます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-155">Once the server is upgraded, the database is automatically brought back online, which causes it to be upgraded.</span></span> <span data-ttu-id="46d4a-156">データベースのアップグレードが完了すると、ログ配布ジョブが再開されます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-156">After the database is upgraded, the log shipping jobs resume.</span></span>

#### <a name="scenario-2-upgrade-primary-server-instance-with-failover"></a><span data-ttu-id="46d4a-157">シナリオ 2: フェールオーバーを使用してプライマリ サーバー インスタンスをアップグレードする</span><span class="sxs-lookup"><span data-stu-id="46d4a-157">Scenario 2: Upgrade Primary Server Instance with Failover</span></span>
 <span data-ttu-id="46d4a-158">このシナリオでは、可用性を最大限に高め、ダウンタイムを最小限に抑えることができます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-158">This scenario maximizes availability and minimizes downtime.</span></span> <span data-ttu-id="46d4a-159">セカンダリ サーバー インスタンスへの制御されたフェールオーバーを活用して、元のプライマリ サーバー インスタンスをアップグレードする間もデータベースを使用できるようにします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-159">It utilizes a controlled failover to the secondary server instance, which keeps the database available while the original primary server instance is upgraded.</span></span> <span data-ttu-id="46d4a-160">これにより、プライマリ サーバー インスタンスのアップグレードに要する時間から、フェールオーバーに要する比較的短い時間へと、ダウンタイムを短縮できます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-160">Downtime is limited to the relatively short time required to fail over, rather than the time required to upgrade the primary server instance.</span></span>

 <span data-ttu-id="46d4a-161">フェールオーバーを使用したプライマリ サーバー インスタンスのアップグレードには 3 つの一般的な手順が含まれます。セカンダリ サーバーへの制御されたフェールオーバーの実行、元のプライマリ サーバー インスタンスの [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]へのアップグレード、および [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] プライマリ サーバー インスタンスでのログ配布の設定の 3 つです。</span><span class="sxs-lookup"><span data-stu-id="46d4a-161">Upgrading the primary server instance with failover involves three general procedures: performing a controlled failover to the secondary server, upgrading the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], and setting up log shipping on a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] primary server instance.</span></span> <span data-ttu-id="46d4a-162">ここではこれらの手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-162">These procedures are described in this section.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="46d4a-163">セカンダリ サーバー インスタンスを新しいプライマリ サーバー インスタンスとして使用する場合は、ログ配布構成を削除し、</span><span class="sxs-lookup"><span data-stu-id="46d4a-163">If you plan to have the secondary server instance as the new primary server instance, you need to remove the log shipping configuration.</span></span> <span data-ttu-id="46d4a-164">元のプライマリ サーバー インスタンスをアップグレードしてからログ配布 (新しいプライマリから新しいセカンダリへのログ配布) を再構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-164">Log shipping will need to be reconfigured from the new primary to the new secondary, after the original primary server instance has been upgraded.</span></span> <span data-ttu-id="46d4a-165">詳細については、「 [SQL Server&#41;のログ配布 &#40;の削除](remove-log-shipping-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-165">For more information, see [Remove Log Shipping &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span></span>


#####  <a name="procedure-1-perform-a-controlled-failover-to-the-secondary-server"></a><a name="Procedure1"></a><span data-ttu-id="46d4a-166">手順 1: セカンダリサーバーへの制御されたフェールオーバーを実行する</span><span class="sxs-lookup"><span data-stu-id="46d4a-166">Procedure 1: Perform a Controlled Failover to the Secondary Server</span></span>
 <span data-ttu-id="46d4a-167">セカンダリ サーバーへの制御されたフェールオーバー:</span><span class="sxs-lookup"><span data-stu-id="46d4a-167">Controlled failover to the secondary server:</span></span>

1.  <span data-ttu-id="46d4a-168">WITH NORECOVERY を指定して、プライマリデータベースでトランザクションログの[ログ末尾のバックアップ](../../relational-databases/backup-restore/tail-log-backups-sql-server.md)を手動で実行します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-168">Manually perform a [tail-log backup](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) of the transaction log on the primary database specifying WITH NORECOVERY.</span></span> <span data-ttu-id="46d4a-169">このログ バックアップは、まだバックアップされていないログ レコードをキャプチャし、データベースをオフラインにします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-169">This log backup captures any log records that have not been backed up yet and takes the database offline.</span></span> <span data-ttu-id="46d4a-170">データベースがオフラインの間は、ログ配布バックアップ ジョブは失敗します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-170">Note that while the database is offline, the log shipping backup job will fail.</span></span>

     <span data-ttu-id="46d4a-171">プライマリ サーバーの `AdventureWorks` データベースのログ末尾のバックアップを作成する例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-171">The following example creates a tail log backup of the `AdventureWorks` database on the primary server.</span></span> <span data-ttu-id="46d4a-172">バックアップ ファイルの名前は、 `Failover_AW_20080315.trn`です。</span><span class="sxs-lookup"><span data-stu-id="46d4a-172">The backup file is named `Failover_AW_20080315.trn`:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Failover_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

     <span data-ttu-id="46d4a-173">手動で作成したバックアップ ファイルとログ配布バックアップ ジョブによって作成されたバックアップ ファイルを区別できるように、それぞれに異なるファイル名前付け規則を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-173">We recommend that you use a distinct file naming convention to differentiate the manually-created backup file from the backup files created by the log shipping backup job.</span></span>

2.  <span data-ttu-id="46d4a-174">セカンダリ サーバーで次の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-174">On the secondary server:</span></span>

    1.  <span data-ttu-id="46d4a-175">ログ配布バックアップ ジョブによって自動的に作成されたバックアップがすべて適用されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-175">Ensure that all backups taken automatically by the log shipping backup jobs have been applied.</span></span> <span data-ttu-id="46d4a-176">どのバックアップジョブが適用されたかを確認するには、監視サーバーまたはプライマリサーバーとセカンダリサーバーで[sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql)システムストアドプロシージャを使用します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-176">To check which backup jobs have been applied, use the [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) system stored procedure on the monitor server or on the primary and secondary servers.</span></span> <span data-ttu-id="46d4a-177">同じファイルが [ **last_backup_file**、 **last_copied_file**、および**last_restored_file**列に表示されます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-177">The same file should be listed in the **last_backup_file**, **last_copied_file**, and **last_restored_file** columns.</span></span> <span data-ttu-id="46d4a-178">コピーおよび復元されていないバックアップ ファイルがあった場合は、ログ配布構成のコピーと復元のエージェント ジョブを手動で呼び出します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-178">If any of the backup files have not been copied and restored, manually invoke the agent copy and restore jobs for the log shipping configuration.</span></span>

         <span data-ttu-id="46d4a-179">ジョブの開始については、「 [Start a Job](../../ssms/agent/start-a-job.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-179">For information about starting a job, see [Start a Job](../../ssms/agent/start-a-job.md).</span></span>

    2.  <span data-ttu-id="46d4a-180">ステップ 1. で作成した最後のログ バックアップ ファイルを、ファイル共有から、セカンダリ サーバーでログ配布に使用されるローカルの場所にコピーします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-180">Copy your the final log backup file that you created in step 1 from the file share to the local location that is used by log shipping on the secondary server.</span></span>

    3.  <span data-ttu-id="46d4a-181">WITH RECOVERY を指定して最後のログ バックアップを復元します。データベースがオンラインになり、</span><span class="sxs-lookup"><span data-stu-id="46d4a-181">Restore the final log backup specifying WITH RECOVERY to bring the database online.</span></span> <span data-ttu-id="46d4a-182">その過程で [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]にアップグレードされます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-182">As part of being brought online, the database will upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

         <span data-ttu-id="46d4a-183">セカンダリ データベースで `AdventureWorks` データベースのログ末尾のバックアップを復元する例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-183">The following example restores the tail log backup of the `AdventureWorks` database on the secondary database.</span></span> <span data-ttu-id="46d4a-184">この例では WITH RECOVERY オプションが使用されているため、データベースがオンラインになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-184">The example uses the WITH RECOVERY option, which brings the database online:</span></span>

        ```
        RESTORE LOG AdventureWorks 
          FROM DISK = N'c:\logshipping\Failover_AW_20080315.trn' 
           WITH RECOVERY;
        GO
        ```

        > [!NOTE]
        >  <span data-ttu-id="46d4a-185">複数のセカンダリ サーバーを含む構成では、他にも注意点があります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-185">For a configuration that contains more than one secondary server, there are additional considerations.</span></span> <span data-ttu-id="46d4a-186">詳細については、このトピックの「 [複数のセカンダリ サーバー インスタンスのアップグレード](#MultipleSecondaries)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-186">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

    4.  <span data-ttu-id="46d4a-187">元のプライマリ サーバー (サーバー A) からオンラインのセカンダリ サーバー (サーバー B) にクライアントをリダイレクトして、データベースをフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-187">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    5.  <span data-ttu-id="46d4a-188">セカンダリ データベースがオンラインになっている間にデータベースのトランザクション ログがいっぱいにならないように注意してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-188">Take care that the transaction log of the secondary database does not fill while the database is online.</span></span> <span data-ttu-id="46d4a-189">そのためには、トランザクション ログをバックアップする必要がある場合もあります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-189">To prevent the transaction log from filling, you might need to back it up.</span></span> <span data-ttu-id="46d4a-190">その場合は、そのバックアップを他のサーバー インスタンスで復元に使用できるように、共有の場所 ( *バックアップ共有*) にバックアップすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-190">If so, we recommend that you back it up to a shared location, a *backup share*, to make the backups available for restoring on the other server instance.</span></span>

#####  <a name="procedure-2-upgrade-the-original-primary-server-instance-to-sscurrent"></a><a name="Procedure2"></a><span data-ttu-id="46d4a-191">手順 2: 元のプライマリサーバーインスタンスをにアップグレードする[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="46d4a-191">Procedure 2: Upgrade the Original Primary Server Instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="46d4a-192">元のプライマリ サーバー インスタンスを [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]にアップグレードした後も、データベースはまだオフラインで、元の形式のままです。</span><span class="sxs-lookup"><span data-stu-id="46d4a-192">After you upgrade the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], the database will still be offline and in the format.</span></span>

#####  <a name="procedure-3-set-up-log-shipping-on-sscurrent"></a><a name="Procedure3"></a><span data-ttu-id="46d4a-193">手順 3: ログ配布を設定する[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="46d4a-193">Procedure 3: Set Up Log Shipping on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="46d4a-194">残りのアップグレード プロセスは、ログ配布がまだ構成されているかどうかによって、次のように異なります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-194">The rest of the upgrade process depends on whether log shipping is still configured, as follows:</span></span>

-   <span data-ttu-id="46d4a-195">[!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]以降のログ配布構成が保持されている場合は、元のプライマリ サーバー インスタンスにスイッチ バックします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-195">If you have kept the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]or higher log shipping configuration, switch back to the original primary server instance.</span></span> <span data-ttu-id="46d4a-196">詳細については、このセクションの「 [元のプライマリ サーバー インスタンスにスイッチ バックするには](#SwitchToOrigPrimary)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-196">For more information, see [To Switch Back to the Original Primary Server Instance](#SwitchToOrigPrimary), later in this section.</span></span>

-   <span data-ttu-id="46d4a-197">フェールオーバーの前にログ配布構成を削除した場合は、元のセカンダリ サーバー インスタンスを新しいプライマリ サーバー インスタンスにする新しいログ配布構成を作成します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-197">If you removed the log shipping configuration before failing over, create a new log shipping configuration in which the original secondary server instance is the new primary server instance.</span></span> <span data-ttu-id="46d4a-198">詳細については、このセクションの「 [古いセカンダリ サーバー インスタンスを新しいプライマリ サーバー インスタンスとして保持するには](#KeepOldSecondaryAsNewPrimary)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-198">For more information, see [To Keep the Old Secondary Server Instance As the New Primary Server Instance](#KeepOldSecondaryAsNewPrimary), later in this section.</span></span>

######  <a name="to-switch-back-to-the-original-primary-server-instance"></a><a name="SwitchToOrigPrimary"></a><span data-ttu-id="46d4a-199">元のプライマリサーバーインスタンスにスイッチバックするには</span><span class="sxs-lookup"><span data-stu-id="46d4a-199">To Switch Back to the Original Primary Server Instance</span></span>

1.  <span data-ttu-id="46d4a-200">暫定プライマリ サーバー (サーバー B) で、WITH NORECOVERY を使用してログの末尾をバックアップします。ログ末尾のバックアップが作成され、データベースがオフラインになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-200">On the interim primary server (server B), back up the tail of the log using WITH NORECOVERY to create a tail-log backup and take the database offline.</span></span> <span data-ttu-id="46d4a-201">ログ末尾のバックアップには `Switchback_AW_20080315.trn`という名前が付けられます。以下に例を示します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-201">The tail log backup is named `Switchback_AW_20080315.trn`.For example:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Switchback_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

2.  <span data-ttu-id="46d4a-202">暫定プライマリ データベースでトランザクション ログ バックアップ (ステップ 1. で作成したログ末尾のバックアップを除く) を実行した場合は、WITH NORECOVERY を使用してそれらのログ バックアップを元のプライマリ サーバー (サーバー A) 上のオフライン データベースに復元します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-202">If any transaction log backups were taken on the interim primary database, other than the tail backup that you created in step 1, restore those log backups using WITH NORECOVERY to the offline database on the original primary server (server A).</span></span> <span data-ttu-id="46d4a-203">最初のログ バックアップが復元されるときにデータベースが [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 形式にアップグレードされます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-203">The database is upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] format when the first log backup is restored.</span></span>

3.  <span data-ttu-id="46d4a-204">WITH RECOVERY を使用してログ末尾のバックアップ (`Switchback_AW_20080315.trn`) を元のプライマリ データベース (サーバー A 上) で復元します。データベースがオンラインになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-204">Restore the tail-log backup, `Switchback_AW_20080315.trn`, on the original primary database (on server A) using WITH RECOVERY to bring the database online.</span></span>

4.  <span data-ttu-id="46d4a-205">元のプライマリ サーバーからオンライン セカンダリ サーバーにクライアントをリダイレクトして、元のプライマリ データベース (サーバー A 上) にスイッチ バックします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-205">Fail over back to the original primary database (on server A) by redirecting clients to the online secondary server from the original primary server.</span></span>

 <span data-ttu-id="46d4a-206">データベースがオンラインになると、元のログ配布構成が再開されます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-206">After the database comes online, the original log shipping configuration will resume.</span></span>

######  <a name="to-keep-the-old-secondary-server-instance-as-the-new-primary-server-instance"></a><a name="KeepOldSecondaryAsNewPrimary"></a><span data-ttu-id="46d4a-207">古いセカンダリサーバーインスタンスを新しいプライマリサーバーインスタンスとして保持するには</span><span class="sxs-lookup"><span data-stu-id="46d4a-207">To Keep the Old Secondary Server Instance As the New Primary Server Instance</span></span>
 <span data-ttu-id="46d4a-208">古いセカンダリ サーバー インスタンス (B) をプライマリ サーバーとして使用し、古いプライマリ サーバー インスタンス (A) を新しいセカンダリ サーバーとして使用する、新しいログ配布構成を設定します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-208">Establish a new log shipping configuration using the old secondary server instance, B, as the primary server and the old primary server instance, A, as the new secondary server, as follows:</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="46d4a-209">プロセスの開始時 (トランザクション ログ バックアップを手動で実行してデータベースをオフラインにする前) に元のプライマリ サーバーから古いログ配布構成が削除されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-209">The old log shipping configuration should have been removed from the original primary server at the start of the process before taking the manual transaction log backup that took the database offline.</span></span>

1.  <span data-ttu-id="46d4a-210">新しいセカンダリ サーバー (サーバー A) でデータベースの完全なバックアップと復元を行わなくても済むように、新しいプライマリ データベースのログ バックアップを新しいセカンダリ データベースに適用します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-210">To avoid performing a complete backup and restore of the database on the new secondary server (server A), apply the log backups from the new primary database to the new secondary database.</span></span> <span data-ttu-id="46d4a-211">この例の構成で言うと、サーバー B で作成されたログ バックアップをサーバー A のデータベースに復元します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-211">In the example configuration, this involves restoring the log backups taken on server B to the database on server A.</span></span>

2.  <span data-ttu-id="46d4a-212">新しいプライマリ データベース (サーバー B 上) のログをバックアップします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-212">Back up the log from the new primary database (on server B).</span></span>

3.  <span data-ttu-id="46d4a-213">WITH NORECOVERY を使用してログ バックアップを新しいセカンダリ サーバー インスタンス (サーバー A) に復元します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-213">Restore the log backups to the new secondary server instance (server A) using WITH NORECOVERY.</span></span> <span data-ttu-id="46d4a-214">最初の復元操作により、データベースが [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]に更新されます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-214">The first restore operation updates the database to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

4.  <span data-ttu-id="46d4a-215">以前のセカンダリ サーバー (サーバー B) をプライマリ サーバー インスタンスとするログ配布を構成します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-215">Configure log shipping with the former secondary server (server B) as the primary server instance.</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="46d4a-216">[!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] を使用する場合は、セカンダリ データベースを初期化済みとして指定します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-216">If you use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], specify that the secondary database is already initialized.</span></span>

     <span data-ttu-id="46d4a-217">詳細については、「 [ログ配布の構成 &#40;SQL Server&#41;](configure-log-shipping-sql-server.md)で導入されました。</span><span class="sxs-lookup"><span data-stu-id="46d4a-217">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

5.  <span data-ttu-id="46d4a-218">元のプライマリ サーバー (サーバー A) からオンラインのセカンダリ サーバー (サーバー B) にクライアントをリダイレクトして、データベースをフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-218">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="46d4a-219">新しいプライマリ データベースにフェールオーバーするときは、そのデータベースのメタデータと元のプライマリ データベースのメタデータに一貫性があることを確認します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-219">When you failover to a new primary database, you should ensure that its metadata is consistent with the metadata of the original primary database.</span></span> <span data-ttu-id="46d4a-220">詳細については、「 [データベースを別のサーバー インスタンスで使用できるようにするときのメタデータの管理 &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-220">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span>

##  <a name="upgrading-multiple-secondary-server-instances"></a><a name="MultipleSecondaries"></a><span data-ttu-id="46d4a-221">複数のセカンダリサーバーインスタンスのアップグレード</span><span class="sxs-lookup"><span data-stu-id="46d4a-221">Upgrading Multiple Secondary Server Instances</span></span>
 <span data-ttu-id="46d4a-222">次の図はこの構成を表しています。図の A がプライマリ サーバー インスタンス、B と C がセカンダリ サーバー インスタンスです。</span><span class="sxs-lookup"><span data-stu-id="46d4a-222">This configuration is represented in the following illustration, which shows a primary server instance, A, and two secondary server instances, B and C.</span></span>

 <span data-ttu-id="46d4a-223">![セカンダリ サーバーが 2 台で、監視サーバーはなし](../media/ls-3-wayconfig-nomonitor.gif "セカンダリ サーバーが 2 台で、監視サーバーはなし")</span><span class="sxs-lookup"><span data-stu-id="46d4a-223">![Two secondary servers and no monitor server](../media/ls-3-wayconfig-nomonitor.gif "Two secondary servers and no monitor server")</span></span>

 <span data-ttu-id="46d4a-224">ここでは、フェールオーバーを使用し、その後、元のプライマリ サーバーにスイッチ バックすることでアップグレードする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-224">This section discusses how to upgrade using a failover and then switching back to the original primary server.</span></span> <span data-ttu-id="46d4a-225">フェールオーバーを使用してプライマリ インスタンスをアップグレードする場合、セカンダリ サーバー インスタンスが複数あるとプロセスがより複雑になります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-225">When upgrading the primary instance with failover the process is more complex when there are multiple secondary server instances.</span></span> <span data-ttu-id="46d4a-226">次の手順では、すべてのセカンダリ サーバーをアップグレードした後、アップグレードしたセカンダリ データベースのいずれかにプライマリ サーバーをフェールオーバーし、</span><span class="sxs-lookup"><span data-stu-id="46d4a-226">In the following procedure, after all the secondary servers are upgraded, the primary server is failed over to one of the upgraded secondary databases.</span></span> <span data-ttu-id="46d4a-227">元のプライマリ サーバーをアップグレードした後、元のプライマリ サーバーにログ配布をスイッチ バックします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-227">The original primary server is upgraded, and log shipping is failed over back to it.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="46d4a-228">常に、セカンダリ サーバー インスタンスをすべてアップグレードしてからプライマリ サーバーをアップグレードします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-228">Always upgrade all the secondary server instances before you upgrade the primary server.</span></span>

 <span data-ttu-id="46d4a-229">**フェールオーバーを使用し、その後、元のプライマリ サーバーにスイッチ バックすることでアップグレードするには**</span><span class="sxs-lookup"><span data-stu-id="46d4a-229">**To upgrade using a failover and then switching back to original primary server**</span></span>

1.  <span data-ttu-id="46d4a-230">すべてのセカンダリ サーバー インスタンス (サーバー B およびサーバー C) をアップグレードします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-230">Upgrade all the secondary server instances (server B and server C).</span></span>

2.  <span data-ttu-id="46d4a-231">プライマリ データベース (サーバー A 上) で、WITH NORECOVERY を使用してトランザクション ログをバックアップします。トランザクション ログの末尾が取得され、データベースがオフラインになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-231">Obtain the tail of the transaction log of the primary database (on server A), and take the database offline, by backing up the transaction log using WITH NORECOVERY.</span></span>

3.  <span data-ttu-id="46d4a-232">フェールオーバー先となるセカンダリ サーバー (サーバー B) で、WITH RECOVERY を使用してログ バックアップを復元します。セカンダリ データベースがオンラインになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-232">On the secondary server to which you plan to fail over (server B), bring the secondary database online, by restoring the log backup using WITH RECOVERY.</span></span>

4.  <span data-ttu-id="46d4a-233">他のすべてのセカンダリ サーバー (サーバー C) で、WITH NORECOVERY を使用してログ バックアップを復元します。セカンダリ データベースはオフラインのままになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-233">On every other secondary server (server C), leave the secondary database offline by restoring the log backup using WITH NORECOVERY.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="46d4a-234">セカンダリ サーバーではログ配布のコピーと復元のジョブが実行されますが、新しいログ バックアップ ファイルがバックアップ共有に配置されないため、何も行われません。</span><span class="sxs-lookup"><span data-stu-id="46d4a-234">The log shipping copy and restore jobs will run on the secondary servers, but the jobs will do nothing because new log-backup files will not be placed on the backup share.</span></span>

5.  <span data-ttu-id="46d4a-235">元のプライマリ サーバー (サーバー A) からオンラインのセカンダリ サーバー (サーバー B) にクライアントをリダイレクトして、データベースをフェールオーバーします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-235">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span> <span data-ttu-id="46d4a-236">オンライン データベースが暫定プライマリ サーバーになり、元のプライマリ サーバー (サーバー A) がオフラインになっている間も引き続きデータベースを使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-236">The online database becomes an interim primary server, keeping the database available while the original primary server is offline (server A).</span></span>

6.  <span data-ttu-id="46d4a-237">元のプライマリ サーバー (サーバー A) をアップグレードします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-237">Upgrade the original primary server (server A).</span></span>

7.  <span data-ttu-id="46d4a-238">フェールオーバー先のデータベース (サーバー B 上) で、WITH NORECOVERY を使用してトランザクションログを手動でバックアップします。</span><span class="sxs-lookup"><span data-stu-id="46d4a-238">On the database to which you failed over-the interim primary database (on server B), manually back up the transaction log using WITH NORECOVERY.</span></span> <span data-ttu-id="46d4a-239">データベースがオフラインになります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-239">This takes the database offline.</span></span>

8.  <span data-ttu-id="46d4a-240">暫定プライマリ データベース (サーバー B 上) で作成したすべてのトランザクション ログ バックアップを、WITH NORECOVERY を使用して他のすべてのセカンダリ データベース (サーバー C 上) に復元します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-240">Restore all transaction log backups that you created on the interim primary database (on server B) to every other secondary database (on server C) using WITH NORECOVERY.</span></span> <span data-ttu-id="46d4a-241">これにより、元のプライマリ データベースをアップグレードした後、元のプライマリ データベースからのログ配布を再開する際に、各セカンダリ データベースでデータベースの完全な復元を行う必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="46d4a-241">This allows log shipping to continue from the original primary database after its upgrade, without requiring a full database restore on each secondary database.</span></span>

9. <span data-ttu-id="46d4a-242">WITH RECOVERY を使用して、暫定プライマリ サーバー (サーバー B) のトランザクション ログを元のプライマリ データベース (サーバー A 上) に復元します。</span><span class="sxs-lookup"><span data-stu-id="46d4a-242">Restore the transaction log from the interim primary server (server B) to the original primary database (on server A) using WITH RECOVERY.</span></span>

##  <a name="redeploying-log-shipping"></a><a name="Redeploying"></a><span data-ttu-id="46d4a-243">ログ配布の再配置</span><span class="sxs-lookup"><span data-stu-id="46d4a-243">Redeploying Log Shipping</span></span>
 <span data-ttu-id="46d4a-244">ログ配布構成を移行するときに上記のいずれの方法も使用したくない場合、プライマリ データベースの完全バックアップおよび復元によってセカンダリ データベースを初期化し直すことで、ログ配布を始めから再配置できます。</span><span class="sxs-lookup"><span data-stu-id="46d4a-244">If you do not want to migrate your log shipping configuration using one of the procedures shown above, you can redeploy log shipping from scratch by reinitializing your secondary database with a full backup and restore of the primary database.</span></span> <span data-ttu-id="46d4a-245">使用しているデータベースが小さい場合、またはアップグレード中は高い可用性が必要ない場合、この方法が適しています。</span><span class="sxs-lookup"><span data-stu-id="46d4a-245">This may be a desirable option if you have a small database or if high availability is not crucial during the upgrade procedure.</span></span>

 <span data-ttu-id="46d4a-246">ログ配布を有効にする方法の詳細については、「 [SQL Server&#41;&#40;ログ配布の構成](configure-log-shipping-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="46d4a-246">For information about enabling log shipping, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="46d4a-247">参照</span><span class="sxs-lookup"><span data-stu-id="46d4a-247">See Also</span></span>
 <span data-ttu-id="46d4a-248">トランザクションログ[バックアップ &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [トランザクションログバックアップの適用 &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [ログ配布テーブルとストアドプロシージャ](log-shipping-tables-and-stored-procedures.md)</span><span class="sxs-lookup"><span data-stu-id="46d4a-248">[Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [Apply Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [Log Shipping Tables and Stored Procedures](log-shipping-tables-and-stored-procedures.md)</span></span>
