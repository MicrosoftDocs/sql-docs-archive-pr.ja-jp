---
title: データベース ミラーリング セッションへのクライアントの接続 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- partners [SQL Server], connecting clients to
- database mirroring [SQL Server], connecting clients to
- client connections [SQL Server], database mirroring
- connections [SQL Server], database mirroring
ms.assetid: 0d5d2742-2614-43de-9ab9-864addb6299b
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 16faa8d02a22fba3e4cfa4cbe0bd6558fc140fdd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87634034"
---
# <a name="connect-clients-to-a-database-mirroring-session-sql-server"></a><span data-ttu-id="7d2c4-102">データベース ミラーリング セッションへのクライアントの接続 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7d2c4-102">Connect Clients to a Database Mirroring Session (SQL Server)</span></span>
  <span data-ttu-id="7d2c4-103">データベース ミラーリング セッションに接続するには、クライアント側で [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client または .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]を使用できます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-103">To connect to a database mirroring session, a client can use either [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client or .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7d2c4-104">これらのデータ アクセス プロバイダーは、 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] データベース用に構成されると、両方ともデータベース ミラーリングを完全にサポートします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-104">When configured for a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database, these data access providers both fully support database mirroring.</span></span> <span data-ttu-id="7d2c4-105">ミラー化されたデータベースの使用に関するプログラミングの注意点については、「 [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-105">For information about programming considerations for using a mirrored database, see [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md).</span></span> <span data-ttu-id="7d2c4-106">さらに、現在のプリンシパル サーバー インスタンスは使用可能であり、クライアントのログインがサーバー インスタンス上に作成されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-106">In addition, the current principal server instance must be available and the login of the client must have been created on the server instance.</span></span> <span data-ttu-id="7d2c4-107">詳細については、「 [孤立ユーザーのトラブルシューティング &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md)を実行します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-107">For more information, see [Troubleshoot Orphaned Users &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span></span> <span data-ttu-id="7d2c4-108">データベース ミラーリング セッションへのクライアント接続では、ミラーリング監視サーバー インスタンスが存在していても使用されません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-108">Client connections to a database mirroring session do not involve the witness server instance, if one exists.</span></span>  
  
 ##  <a name="making-the-initial-connection-to-a-database-mirroring-session"></a><a name="InitialConnection"></a> <span data-ttu-id="7d2c4-109">データベース ミラーリング セッションへの最初の接続</span><span class="sxs-lookup"><span data-stu-id="7d2c4-109">Making the Initial Connection to a Database Mirroring Session</span></span>  
 <span data-ttu-id="7d2c4-110">クライアントはミラー化されたデータベースに初めて接続するときに、最低限サーバー インスタンスの名前を含む接続文字列を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-110">For the initial connection to a mirrored database, a client must supply a connection string that minimally supplies the name of a server instance.</span></span> <span data-ttu-id="7d2c4-111">この必須のサーバー名は、現在のプリンシパル サーバー インスタンスを特定するもので、 *イニシャル パートナー名*と呼びます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-111">This required server name should identify the current principal server instance and is known as the *initial partner name*.</span></span>  
  
 <span data-ttu-id="7d2c4-112">接続文字列には、必要に応じて、別のサーバー インスタンスの名前を指定することもできます。この名前は、現在のミラー サーバー インスタンスを特定するもので、最初の接続試行でイニシャル パートナーを使用できない場合に使用されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-112">Optionally, the connection string can also supply the name of another server instance, which should identify the current mirror server instance, for use if the initial partner is unavailable during the first connection attempt.</span></span> <span data-ttu-id="7d2c4-113">この 2 つ目の名前を *フェールオーバー パートナー名*と呼びます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-113">The second name is known as the *failover partner name*.</span></span>  
  
 <span data-ttu-id="7d2c4-114">また、接続文字列にはデータベース名も指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-114">The connection string must also supply a database name.</span></span> <span data-ttu-id="7d2c4-115">データベース名は、データ アクセス プロバイダーがフェールオーバーを試行できるようにするために必要です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-115">This is necessary to enable failover attempts by the data access provider.</span></span>  
  
 <span data-ttu-id="7d2c4-116">データ アクセス プロバイダーは接続文字列を受け取ると、イニシャル パートナー名とフェールオーバー パートナー名 (指定された場合) をクライアントの揮発性メモリのキャッシュに格納します (マネージド コードの場合、キャッシュはアプリケーション ドメインにスコープが設定されます)。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-116">On receiving a connection string, the data access provider stores the initial partner name and the failover partner name, if supplied, in a cache in the client's volatile memory (for managed code, the cache is scoped to the application domain).</span></span> <span data-ttu-id="7d2c4-117">キャッシュに保存されたイニシャル パートナー名は、データ アクセス プロバイダーによって更新されません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-117">Once cached, the initial partner name is never updated by the data access provider.</span></span> <span data-ttu-id="7d2c4-118">クライアントがフェールオーバー パートナー名を指定した場合、データ アクセス プロバイダーでは、イニシャル パートナー名を使用して接続できなかった場合に備えて、このフェールオーバー パートナー名も一時的に保存します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-118">When the client supplies the failover partner name, the data access provider also stores this failover partner name temporarily in case the provider cannot connect using the initial partner name.</span></span>  
  
 <span data-ttu-id="7d2c4-119">データベース ミラーリング セッションによる保護は、クライアント コンピューターでネットワーク通信に関する問題が発生した場合など、サーバーへのアクセスに関するクライアント固有の問題には対処できません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-119">A database mirroring session does not protect against server-access problems that are specific to clients, such as when a client computer is having a problems communicating with the network.</span></span> <span data-ttu-id="7d2c4-120">ミラー化されたデータベースへの接続は、データ アクセス プロバイダーに関連しない原因で失敗することもあります。たとえば、データベースがフェールオーバー中である場合や、ネットワーク エラーが発生した場合に、プリンシパル サーバー インスタンスがアクティブでないことが原因で接続試行が失敗することがあります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-120">A connection attempt to a mirrored database can also fail for a variety of reasons that are unrelated to the data-access provider; for example, a connection attempt can fail because the principal server instance is inactive, as occurs when the database is failing over, or because of a network error.</span></span>  
  
 <span data-ttu-id="7d2c4-121">データ アクセス プロバイダーでは、まずイニシャル パートナー名を使用して接続を試行します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-121">When attempting to connect, the data access provider begins by using the initial partner name.</span></span> <span data-ttu-id="7d2c4-122">通常、指定したサーバー インスタンスが使用可能で、それが現在のプリンシパル サーバー インスタンスであれば接続は成功します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-122">If the specified server instance is available and is the current principal server instance, the connection attempt typically succeeds.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-123">ミラーリング セッションが一時停止した場合、通常、クライアントはプリンシパル サーバーに接続し、パートナー名をダウンロードします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-123">If the mirroring session is paused, the client typically connects to the principal server and the downloads the partner name.</span></span> <span data-ttu-id="7d2c4-124">ただし、ミラーリングが再開されるまで、クライアントはデータベースにアクセスできません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-124">However, the database is unavailable to the client until mirroring resumes.</span></span>  
  
 <span data-ttu-id="7d2c4-125">イニシャル パートナー名で接続できない場合、フェールオーバー パートナー名 (指定された場合) で接続を試行します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-125">If that attempt does not work, the data access provider tries the failover partner name, if available.</span></span> <span data-ttu-id="7d2c4-126">いずれかのパートナー名で現在のプリンシパル サーバーを正しく特定できると、正常に最初の接続を開くことができます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-126">If either partner name correctly identifies the current principal server, the data access provider normally succeeds in opening the initial connection.</span></span> <span data-ttu-id="7d2c4-127">この接続が完了すると、現在のミラー サーバーのサーバー インスタンス名をダウンロードします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-127">On completing this connection, the data access provider downloads the server instance name of the current mirror server.</span></span> <span data-ttu-id="7d2c4-128">この名前はフェールオーバー パートナー名としてキャッシュに保存され、クライアントが指定したフェールオーバー パートナー名 (存在する場合) が上書きされます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-128">This name is stored in the cache as the failover partner name, overwriting the client-supplied failover partner name, if any.</span></span> <span data-ttu-id="7d2c4-129">その後、.NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] はこのフェールオーバー パートナー名を更新しません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-129">Thereafter, the .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] does not update the failover partner name.</span></span> <span data-ttu-id="7d2c4-130">それに対して、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client は、その後の接続や接続のリセットにより異なるパートナー名が返されたときはキャッシュを更新します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-130">In contrast, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client updates the cache whenever a subsequent connection or connection reset returns a different partner name.</span></span>  
  
 <span data-ttu-id="7d2c4-131">次の図は、 **Db_1**という名前のミラー化されたデータベースのイニシャル パートナーである **Partner_A**へのクライアント接続を示しています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-131">The following figure illustrates a client connection to the initial partner, **Partner_A**, for a mirrored database named **Db_1**.</span></span> <span data-ttu-id="7d2c4-132">この図では、クライアントが指定したイニシャル パートナー名が現在のプリンシパル サーバーである **Partner_A**を正しく特定しています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-132">This figure shows a case in which the initial partner name supplied by the client correctly identifies the current principal server, **Partner_A**.</span></span> <span data-ttu-id="7d2c4-133">最初の接続試行が成功し、データ アクセス プロバイダーのローカル キャッシュに、ミラー サーバーの名前 (現在は **Partner_B**) がフェールオーバー パートナー名として保存されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-133">The initial connection attempt succeeds, and the data access provider stores the name of the mirror server (currently **Partner_B**) as the failover partner name in the local cache.</span></span> <span data-ttu-id="7d2c4-134">最後に、クライアントが **Db_1** データベースのプリンシパル コピーに接続されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-134">Finally, the client connects to the principal copy of the **Db_1** database.</span></span>  
  
 <span data-ttu-id="7d2c4-135">![最初のパートナーがプリンシパルである場合のクライアント接続](../media/dbm-initial-connection.gif "最初のパートナーがプリンシパルである場合のクライアント接続")</span><span class="sxs-lookup"><span data-stu-id="7d2c4-135">![Client connection if initial partner is principal](../media/dbm-initial-connection.gif "Client connection if initial partner is principal")</span></span>  
  
 <span data-ttu-id="7d2c4-136">最初の接続試行は、ネットワーク エラーやアクティブでないサーバー インスタンスが原因で失敗する場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-136">The initial connection attempt may fail, for example, because of a network error or an inactive server instance.</span></span> <span data-ttu-id="7d2c4-137">最初のパートナーが使用できないときに、データ アクセス プロバイダーがフェールオーバー パートナーへの接続を試行するには、クライアントが接続文字列にフェールオーバー パートナー名を指定している必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-137">Because the initial partner is unavailable, for the data access provider to attempt to connect to the failover partner, the client must have supplied the failover partner name in the connection string.</span></span>  
  
 <span data-ttu-id="7d2c4-138">フェールオーバー パートナー名が指定されていなければ、ネットワーク接続がタイムアウトになるかエラーが返されるまで、元の接続試行が続行されます (データベースがミラー化されていない場合と同じ動作です)。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-138">In that case, if the failover partner name is unavailable, the original connection attempt continues until the network connection timeout or an error is returned (just as for a non-mirrored database).</span></span>  
  
 <span data-ttu-id="7d2c4-139">接続文字列にフェールオーバー パートナー名を指定した場合、データ アクセス プロバイダーの動作は、クライアントのネットワーク プロトコルとオペレーティング システムによって次のように異なります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-139">When the failover partner name is supplied in the connection string, the behavior of the data access provider depends on the network protocol and operating system of the client, as follows:</span></span>  
  
-   <span data-ttu-id="7d2c4-140">TCP/IP では、データベース ミラーリング固有の接続再試行アルゴリズムによって接続試行が規制されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-140">For TCP/IP, the connection attempts are regulated by a connection retry algorithm that is specific to database mirroring.</span></span> <span data-ttu-id="7d2c4-141">*接続再試行アルゴリズム* は、1 回の接続試行で接続を開くのに割り当てる最大時間 ( *再試行時間*) を決定します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-141">The *connection retry algorithm* determines the maximum time (the *retry time*) allotted for opening a connection in a given connection attempt.</span></span>  
  
-   <span data-ttu-id="7d2c4-142">その他のネットワーク プロトコル</span><span class="sxs-lookup"><span data-stu-id="7d2c4-142">For other network protocols</span></span>  
  
     <span data-ttu-id="7d2c4-143">エラーが発生するか、イニシャル パートナーを使用できない場合、最初の接続試行は、ネットワーク接続がタイムアウトになるか、データ アクセス プロバイダーのログインがタイムアウトになるまで待機します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-143">If an error occurs or if the initial partner is unavailable, the initial connection attempt waits until the network connection timeout period expires or the login timeout period expires on the data access provider.</span></span> <span data-ttu-id="7d2c4-144">通常、この待機時間は 20 ～ 30 秒です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-144">Typically, this wait is on the order of 20 to 30 seconds.</span></span> <span data-ttu-id="7d2c4-145">データ アクセス プロバイダーがタイムアウトしなければ、フェールオーバー パートナーへの接続が試行されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-145">Thereafter, if the data access provider has not timed out, it attempts to connect to the failover partner.</span></span> <span data-ttu-id="7d2c4-146">接続が成功する前に接続がタイムアウトになるか、フェールオーバー パートナーを使用できない場合、接続試行は失敗します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-146">If the connection timeout period expires before the connection succeeds or the failover partner is unavailable, the connection attempt fails.</span></span> <span data-ttu-id="7d2c4-147">ログインがタイムアウトになる前に、フェールオーバー パートナーが使用でき、そのパートナーがその時点のプリンシパル サーバーの場合、接続試行は成功します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-147">If failover partner is available within the login timeout period and is now the principal server, the connection attempt normally succeeds.</span></span>  

  
### <a name="connection-strings-for-a-mirrored-database"></a><span data-ttu-id="7d2c4-148">ミラー化されたデータベースの接続文字列</span><span class="sxs-lookup"><span data-stu-id="7d2c4-148">Connection Strings for a Mirrored Database</span></span>  
 <span data-ttu-id="7d2c4-149">クライアントが指定する接続文字列には、データ アクセス プロバイダーがデータベースへの接続に使用する情報が含まれています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-149">The connection string supplied by the client contains information that the data access provider uses to connect to the database.</span></span> <span data-ttu-id="7d2c4-150">ここでは特に、ミラー化されたデータベースに [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client の ODBC ドライバー接続を使用して接続する場合のキーワードについて説明します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-150">This section discusses the keywords that are specifically relevant for connecting to a mirrored database using a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC Driver Connection.</span></span>  
  
#### <a name="network-attribute"></a><span data-ttu-id="7d2c4-151">Network 属性</span><span class="sxs-lookup"><span data-stu-id="7d2c4-151">Network Attribute</span></span>  
 <span data-ttu-id="7d2c4-152">接続文字列には、ネットワーク プロトコルを指定するための **Network** 属性を含めます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-152">The connection string should contain the **Network** attribute to specify the network protocol.</span></span> <span data-ttu-id="7d2c4-153">この属性を含めると、異なるパートナーに接続を切り替えても、指定したネットワーク プロトコルが保持されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-153">This ensures that the specified network protocol persists between connections to different partners.</span></span> <span data-ttu-id="7d2c4-154">ミラー化されたデータベースへの接続に最も適したプロトコルは TCP/IP です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-154">The best protocol for connecting to a mirrored database is TCP/IP.</span></span> <span data-ttu-id="7d2c4-155">クライアントがパートナーへのすべての接続に TCP/IP を要求するには、接続文字列に次の属性を指定します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-155">To ensure that the client requests TCP/IP for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbmssocn;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7d2c4-156">TCP/IP はクライアントのプロトコル一覧の先頭に指定することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-156">We recommend keeping TCP/IP at the top of a client's protocol list.</span></span> <span data-ttu-id="7d2c4-157">ただし、接続文字列に **Network** 属性を指定した場合は、そのプロトコルが一覧の順序をオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-157">However, if the connection string specifies the **Network** attribute, this overrides the list order.</span></span>  
  
 <span data-ttu-id="7d2c4-158">また、クライアントがパートナーへのすべての接続に名前付きパイプを要求するには、接続文字列に次の属性を指定します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-158">Alternatively, to ensure that the client requests named pipes for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbnmpntw;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7d2c4-159">名前付きパイプでは TCP/IP の再試行アルゴリズムを使用しないので、多くの場合、名前付きパイプによる接続試行はミラー化されたデータベースに接続される前にタイムアウトします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-159">Because named pipes does not use the TCP/IP retry algorithm, in many cases, a named pipes connection attempt may time out before connecting to a mirrored database.</span></span>  
  
#### <a name="server-attribute"></a><span data-ttu-id="7d2c4-160">Server 属性</span><span class="sxs-lookup"><span data-stu-id="7d2c4-160">Server Attribute</span></span>  
 <span data-ttu-id="7d2c4-161">接続文字列には、イニシャル パートナー名を指定する `Server` 属性を含める必要があります。この名前で現在のプリンシパル サーバー インスタンスを特定します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-161">The connection string must contain a `Server` attribute that supplies the initial partner name, which should identify the current principal server instance.</span></span>  
  
 <span data-ttu-id="7d2c4-162">サーバー インスタンスを特定する最も簡単な方法は、 *<server_name>* [ **\\** _<SQL_Server_instance_name>_ ] の形式でインスタンス名を指定することです。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-162">The simplest way to identify the server instance is by specifying its name , *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span> <span data-ttu-id="7d2c4-163">次に例を示します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-163">For example:</span></span>  
  
 `Server=Partner_A;`  
  
 <span data-ttu-id="7d2c4-164">or</span><span class="sxs-lookup"><span data-stu-id="7d2c4-164">or</span></span>  
  
 `Server=Partner_A\Instance_2;`  
  
 <span data-ttu-id="7d2c4-165">ただし、システム名を使用するときは、クライアントは DNS 参照を実行してサーバーの IP アドレスを取得し、SQL Server Browser クエリを実行してパートナーが存在するサーバーのポート番号を取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-165">However, when the system name is used, the client must perform a DNS lookup to obtain the IP address of the server and a SQL Server Browser query to obtain the port number of the server on which the partner resides.</span></span> <span data-ttu-id="7d2c4-166">`Server` 属性にパートナーのサーバー名ではなく IP アドレスとポート番号を指定すると、こうした参照やクエリを回避できます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-166">Those lookups and queries can be bypassed by specifying the IP address and port number of the partner in the `Server` attribute, rather than specifying the server name.</span></span> <span data-ttu-id="7d2c4-167">パートナーへの接続中に外部遅延が発生する可能性を最小限に抑えるために、この指定を行うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-167">This is recommended to minimize the possibility of external delays while connecting to that partner.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-168">接続文字列に名前付きインスタンス名を指定し、ポート名を指定しない場合は、SQL Server Browser クエリの実行が必要です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-168">A SQL Server Browser query is necessary if the connection string specifies the named instance name and not the port.</span></span>  
  
 <span data-ttu-id="7d2c4-169">IP アドレスとポートを指定するには、 `Server` 属性に次の形式を `Server=` 使用します。 *<ip_address>* の `,` *\<port>* ようになります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-169">To specify the IP address and port, the `Server` attribute takes the following form, `Server=`*<ip_address>*`,`*\<port>*, for example:</span></span>  
  
```  
Server=123.34.45.56,4724;   
```  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-170">IP アドレスには、IP Version 4 (IPv4) または IP Version 6 (IPv6) を使用できます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-170">The IP address can be IP Version 4 (IPv4) or IP Version 6 (IPv6).</span></span>  
  
#### <a name="database-attribute"></a><span data-ttu-id="7d2c4-171">Database 属性</span><span class="sxs-lookup"><span data-stu-id="7d2c4-171">Database Attribute</span></span>  
 <span data-ttu-id="7d2c4-172">接続文字列には、ミラー化されたデータベースの名前を指定する `Database` 属性も指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-172">In addition, the connection string must specify the `Database` attribute to supply the name of the mirrored database.</span></span> <span data-ttu-id="7d2c4-173">クライアントが接続を試行したときにデータベースを使用できない場合は、例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-173">If the database is unavailable when the client attempts to connect, an exception is raised.</span></span>  
  
 <span data-ttu-id="7d2c4-174">たとえば、プリンシパル サーバー Partner_A の **AdventureWorks** データベースに明示的に接続するには、クライアントで次の接続文字列を使用します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-174">For example, to expressly connect to the **AdventureWorks** database on the principal server Partner_A, a client uses the following connection string:</span></span>  
  
 `" Server=Partner_A; Database=AdventureWorks "`  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-175">この文字列では、認証情報が省略されています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-175">This string omits authentication information.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7d2c4-176">プロトコルプレフィックスを属性 () にバンドルすること `Server` `Server=tcp:` *\<servername>* は、 **Network**属性と互換性がありません。また、両方の場所にプロトコルを指定すると、エラーが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-176">Bundling the protocol prefix with the `Server` attribute (`Server=tcp:`*\<servername>*) is incompatible with the **Network** attribute, and specifying the protocol in both places will likely result in an error.</span></span> <span data-ttu-id="7d2c4-177">このため、接続文字列でプロトコルを指定する際には**Network**属性を使用し、属性にはサーバー名だけを指定することをお勧めし `Server` `"Network=dbmssocn; Server=` *\<servername>* `"` ます ()。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-177">Therefore, we recommend that a connection string specify the protocol using the **Network** attribute and specify only the server name in the `Server` attribute (`"Network=dbmssocn; Server=`*\<servername>*`"`).</span></span>  
  
#### <a name="failover-partner-attribute"></a><span data-ttu-id="7d2c4-178">Failover Partner 属性</span><span class="sxs-lookup"><span data-stu-id="7d2c4-178">Failover Partner Attribute</span></span>  
 <span data-ttu-id="7d2c4-179">クライアントは、イニシャル パートナー名以外に、現在のミラー サーバー インスタンスを特定するフェールオーバー パートナー名も指定できます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-179">In addition to the initial partner name, the client can also specify failover partner name, which should identify the current mirror server instance.</span></span> <span data-ttu-id="7d2c4-180">フェールオーバー パートナーは、Failover Partner 属性を表すいずれかのキーワードで指定します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-180">The failover partner is specified by one of the keywords for the failover partner attribute.</span></span> <span data-ttu-id="7d2c4-181">この属性を表すキーワードは、使用する API によって異なります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-181">The keyword for this attribute depends on the API that you are using.</span></span> <span data-ttu-id="7d2c4-182">次の表は、これらのキーワードを示しています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-182">The following table lists these keywords:</span></span>  
  
|<span data-ttu-id="7d2c4-183">API</span><span class="sxs-lookup"><span data-stu-id="7d2c4-183">API</span></span>|<span data-ttu-id="7d2c4-184">Failover Partner 属性を表すキーワード</span><span class="sxs-lookup"><span data-stu-id="7d2c4-184">Keyword for failover partner attribute</span></span>|  
|---------|--------------------------------------------|  
|<span data-ttu-id="7d2c4-185">OLE DB プロバイダー</span><span class="sxs-lookup"><span data-stu-id="7d2c4-185">OLE DB Provider</span></span>|`FailoverPartner`|  
|<span data-ttu-id="7d2c4-186">ODBC ドライバー</span><span class="sxs-lookup"><span data-stu-id="7d2c4-186">ODBC Driver</span></span>|`Failover_Partner`|  
|<span data-ttu-id="7d2c4-187">ActiveX Data Objects (ADO)</span><span class="sxs-lookup"><span data-stu-id="7d2c4-187">ActiveX Data Objects (ADO)</span></span>|`Failover Partner`|  
  
 <span data-ttu-id="7d2c4-188">サーバー インスタンスを特定する最も簡単な方法は、そのインスタンスのシステム名を *<server_name>* [ **\\** _<SQL_Server_instance_name>_ ] という形式で指定することです。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-188">The simplest way to identify the server instance is by its system name, *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span>  
  
 <span data-ttu-id="7d2c4-189">また、`Failover Partner` 属性に IP アドレスとポート番号を指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-189">Alternatively, the IP address and port number can be supplied in the `Failover Partner` attribute.</span></span> <span data-ttu-id="7d2c4-190">これにより、最初の接続試行がデータベースへの最初の接続に失敗した場合、DNS と SQL Server Browser に依存しないでフェールオーバー パートナーへの接続を試行できます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-190">If the initial connection attempt fails during the first connection to the database, the attempt to connect to the failover partner will be freed from relying on DNS and SQL Server Browser.</span></span> <span data-ttu-id="7d2c4-191">接続が確立されると、指定したフェールオーバー パートナー名が接続時のフェールオーバー パートナー名に上書きされるので、次にフェールオーバーが発生した場合、リダイレクトされた接続では DNS と SQL Server Browser が必要になります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-191">Once a connection is established, the failover partner name will be overwritten with the failover partner name, so if a failover occurs, the redirected connections will require DNS and SQL Server Browser.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-192">イニシャル パートナー名のみを指定すると、アプリケーション開発者が操作を実行したり、再接続方法以外のコードを記述したりする必要はありません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-192">When only the initial partner name is provided, application developers do not need to take any action or write any code except about how to reconnect.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-193">マネージド コード アプリケーションの開発者は `ConnectionString` オブジェクトの `SqlConnection` でフェールオーバー パートナー名を指定します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-193">Managed code application developers supply the failover partner name in the `ConnectionString` of the `SqlConnection` object.</span></span> <span data-ttu-id="7d2c4-194">この接続文字列の使用方法については、 [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK に含まれている ADO.NET マニュアルの「Database Mirroring Support in the .NET Framework Data Provider for SQL Server」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-194">For information on using this connection string, see "Database Mirroring Support in the .NET Framework Data Provider for SQL Server" in the ADO.NET documentation, which is part of the [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK.</span></span>  
  
#### <a name="example-connection-string"></a><span data-ttu-id="7d2c4-195">接続文字列の例</span><span class="sxs-lookup"><span data-stu-id="7d2c4-195">Example Connection String</span></span>  
 <span data-ttu-id="7d2c4-196">たとえば、TCP/IP を使用して Partner_A または Partner_B の **AdventureWorks** データベースに明示的に接続するには、ODBC ドライバーを使用するクライアント アプリケーションで次の接続文字列を指定します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-196">For example, to explicitly connect using TCP/IP to the **AdventureWorks** database on either Partner_A or Partner_B, a client application that uses the ODBC Driver could supply the following connection string:</span></span>  
  
```  
"Server=Partner_A; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
 <span data-ttu-id="7d2c4-197">また、クライアントはイニシャル パートナーの Partner_A を特定するために、IP アドレスとポート番号を指定できます。たとえば、IP アドレスが 250.65.43.21 でポート番号が 4734 の場合、接続文字列は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-197">Alternatively, the client could use the IP address and port number to identify the initial partner, Partner_A; for example, if the IP address is 250.65.43.21 and the port number is 4734, the connection string would be:</span></span>  
  
```  
"Server=250.65.43.21,4734; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
##  <a name="connection-retry-algorithm-for-tcpip-connections"></a><a name="RetryAlgorithm"></a> <span data-ttu-id="7d2c4-198">接続再試行アルゴリズム (TCP/IP 接続用)</span><span class="sxs-lookup"><span data-stu-id="7d2c4-198">Connection Retry Algorithm (for TCP/IP Connections)</span></span>  
 <span data-ttu-id="7d2c4-199">TCP/IP 接続では、両方のパートナー名がキャッシュ内に存在すると、データ アクセス プロバイダーは接続再試行アルゴリズムに従います。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-199">For a TCP/IP connection, when both partner names are in the cache, the data access provider adheres to a connection retry algorithm.</span></span> <span data-ttu-id="7d2c4-200">これは、セッションに初めて接続する場合にも、確立した接続が切断された後に再接続する場合にも当てはまります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-200">This is true both for making the initial connection to the session and for reconnecting after losing an established connection.</span></span> <span data-ttu-id="7d2c4-201">接続を開いた後の場合、ログイン前およびログイン時の手順を完了するのにさらに時間がかかります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-201">Once a connection has been opened, completing the pre-login and login steps takes additional time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-202">接続を開くときにかかる時間は、外部要因が原因で再試行時間を超える場合があります。外部要因には、速度の遅い DNS 参照、処理速度の遅いドメイン コントローラーや Kerberos キー配布センター (KDC)、SQL Server Browser への接続にかかる時間、ネットワークの混雑などがあります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-202">The time spent in opening a connection can exceed the retry time because of external factors, such as slow DNS lookups, slow domain controller/Kerberos Key Distribution Center (KDC), time spent contacting SQL Server Browser, network congestion, and so forth.</span></span> <span data-ttu-id="7d2c4-203">このような外部要因により、クライアントはミラー化されたデータベースに接続できなくなる場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-203">Such external factors can prevent a client from connecting to a mirrored database.</span></span> <span data-ttu-id="7d2c4-204">また、接続を開くとき、割り当てられた再試行時間より長い時間がかかる場合もあります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-204">Also, external factors can cause a connection to take longer to open than the allotted retry time.</span></span> <span data-ttu-id="7d2c4-205">イニシャル パートナーへの接続試行時の DNS および SQL Server Browser のバイパスについては、このトピックの「 [データベース ミラーリング セッションへの最初の接続](#InitialConnection)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-205">For information on bypassing DNS and SQL Server Browser for connection attempt to the initial partner, see [Making the Initial Connection to a Database Mirroring Session](#InitialConnection), earlier in this topic.</span></span>  
  
 <span data-ttu-id="7d2c4-206">接続試行が失敗したり、接続試行が成功する前に再試行時間がタイムアウトした場合、データ アクセス プロバイダーは他のパートナーを使用します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-206">If a connection attempt fails or the retry time expires before it succeeds, the data access provider tries the other partner.</span></span> <span data-ttu-id="7d2c4-207">この時点までに接続が開かれていない場合は、接続が開かれるかログイン期間がタイムアウトするまで、プロバイダーはイニシャル パートナー名とフェールオーバー パートナー名を交互に使用します。既定のログイン タイムアウト期間は 15 秒です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-207">If a connection is not opened by this point, the provider alternately tries the initial and failover partner names, until a connection is opened or the login period times out. The default login time-out period is 15 seconds.</span></span> <span data-ttu-id="7d2c4-208">ログイン タイムアウト期間は 5 秒以上にすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-208">We recommend that the login time-out period be at least 5 seconds.</span></span> <span data-ttu-id="7d2c4-209">タイムアウト期間を 5 秒未満にすると、接続試行が成功しない場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-209">Specifying a smaller time-out period might prevent any of the connection attempts from succeeding.</span></span>  
  
 <span data-ttu-id="7d2c4-210">再試行時間は、ログイン タイムアウト期間の比率で決まります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-210">The retry time is a percentage of the login period.</span></span> <span data-ttu-id="7d2c4-211">接続試行の再試行時間は、連続する各ラウンドでラウンドごとに長くなります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-211">The retry time for a connection attempt is larger in each successive round.</span></span> <span data-ttu-id="7d2c4-212">最初のラウンドでは、2 回の接続試行それぞれの再試行時間は、合計ログイン タイムアウト期間の 8% です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-212">In the first round, the retry time for each of the two attempts is 8 percent of the total login period.</span></span> <span data-ttu-id="7d2c4-213">その後に続く各ラウンドでは、再試行アルゴリズムによって、最大再試行時間が一定の比率で増加します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-213">In each successive round, the retry algorithm increases the maximum retry time by the same amount.</span></span> <span data-ttu-id="7d2c4-214">したがって、最初の 8 回の接続試行の再試行時間は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-214">Thus, the retry times for the first eight connection attempts is as follows:</span></span>  
  
 <span data-ttu-id="7d2c4-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span><span class="sxs-lookup"><span data-stu-id="7d2c4-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span></span>  
  
 <span data-ttu-id="7d2c4-216">再試行時間は、次の式を使用して計算されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-216">The retry time is calculated using the following formula:</span></span>  
  
 <span data-ttu-id="7d2c4-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;** _LoginTimeout_ **)**</span><span class="sxs-lookup"><span data-stu-id="7d2c4-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;**_LoginTimeout_**)**</span></span>  
  
 <span data-ttu-id="7d2c4-218">ここでは、 *PreviousRetryTime* の初期値は 0 です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-218">Where *PreviousRetryTime* is initially 0.</span></span>  
  
 <span data-ttu-id="7d2c4-219">たとえば、15 秒という既定のログイン タイムアウト期間を使用すると、*LoginTimeout* *= 15* となります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-219">For example, if using the default login time-out period of 15 seconds, *LoginTimeout* *= 15*.</span></span> <span data-ttu-id="7d2c4-220">この場合、最初の 3 ラウンドに割り当てられる再試行時間は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-220">In this case, the retry times allotted in the first three rounds are as follows:</span></span>  
  
|<span data-ttu-id="7d2c4-221">Round</span><span class="sxs-lookup"><span data-stu-id="7d2c4-221">Round</span></span>|<span data-ttu-id="7d2c4-222">*RetryTime* の計算</span><span class="sxs-lookup"><span data-stu-id="7d2c4-222">*RetryTime* calculation</span></span>|<span data-ttu-id="7d2c4-223">接続試行ごとの再試行時間</span><span class="sxs-lookup"><span data-stu-id="7d2c4-223">Retry time per attempt</span></span>|  
|-----------|-----------------------------|----------------------------|  
|<span data-ttu-id="7d2c4-224">1</span><span class="sxs-lookup"><span data-stu-id="7d2c4-224">1</span></span>|<span data-ttu-id="7d2c4-225">0 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="7d2c4-225">0 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="7d2c4-226">1.2 秒</span><span class="sxs-lookup"><span data-stu-id="7d2c4-226">1.2 seconds</span></span>|  
|<span data-ttu-id="7d2c4-227">2</span><span class="sxs-lookup"><span data-stu-id="7d2c4-227">2</span></span>|<span data-ttu-id="7d2c4-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="7d2c4-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="7d2c4-229">2.4 秒</span><span class="sxs-lookup"><span data-stu-id="7d2c4-229">2.4 seconds</span></span>|  
|<span data-ttu-id="7d2c4-230">3</span><span class="sxs-lookup"><span data-stu-id="7d2c4-230">3</span></span>|<span data-ttu-id="7d2c4-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="7d2c4-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="7d2c4-232">3.6 秒</span><span class="sxs-lookup"><span data-stu-id="7d2c4-232">3.6 seconds</span></span>|  
|<span data-ttu-id="7d2c4-233">4</span><span class="sxs-lookup"><span data-stu-id="7d2c4-233">4</span></span>|<span data-ttu-id="7d2c4-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="7d2c4-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="7d2c4-235">4.8 秒</span><span class="sxs-lookup"><span data-stu-id="7d2c4-235">4.8 seconds</span></span>|   
  
 <span data-ttu-id="7d2c4-236">次の図では、連続する接続試行のそれぞれがタイムアウトする再試行時間を示しています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-236">The following figure illustrates these retry times for successive connection attempts, each of which times out.</span></span>  
  
 <span data-ttu-id="7d2c4-237">![15 秒のログイン タイムアウト期間での最大再試行間隔](../media/dbm-retry-algorithm.gif "15 秒のログイン タイムアウト期間での最大再試行間隔")</span><span class="sxs-lookup"><span data-stu-id="7d2c4-237">![Maximum retry delays for 15 second login timeout](../media/dbm-retry-algorithm.gif "Maximum retry delays for 15 second login timeout")</span></span>  
  
 <span data-ttu-id="7d2c4-238">既定のログイン タイムアウト期間に対して、接続試行の最初の 3 ラウンドに割り当てられた最大時間は 14.4 秒です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-238">For the default login time-out period, the maximum time allotted to the first three rounds of connection attempts is 14.4 seconds.</span></span> <span data-ttu-id="7d2c4-239">各接続試行で割り当てられた時間をすべて使用してしまった場合、ログイン期間がタイムアウトするまでに 0.6 秒しか残っていません。その場合、4 ラウンド目は短縮されるので、最後は、イニシャル パートナー名を使用した簡単な接続試行しか行うことができません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-239">If every attempt were to use all of its allotted time, only 0.6 seconds of time would remain before the login period times out. In that case, the fourth round would be curtailed, allowing only a final quick attempt to connect using the initial partner name.</span></span> <span data-ttu-id="7d2c4-240">ただし、特に後半のラウンドでは、割り当てられた再試行時間が経過しないうちに接続試行が失敗する場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-240">However, a connection attempt may fail in less than its allotted retry time, particularly in later rounds.</span></span> <span data-ttu-id="7d2c4-241">たとえば、ネットワーク エラーが発生すると、再試行時間がタイムアウトする前に、試行が終了する場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-241">For example, receiving a network error can cause an attempt to end before the retry time expires.</span></span> <span data-ttu-id="7d2c4-242">初期の接続試行がネットワーク エラーによって失敗すると、4 ラウンド目とおそらくは追加のラウンドで、使用できる時間が追加されることがあります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-242">If earlier attempts fail due to a network error, additional time would be available for the fourth round and, perhaps, additional rounds.</span></span>  
  
 <span data-ttu-id="7d2c4-243">接続試行に失敗するもう 1 つの原因として、サーバー インスタンスがそのデータベースをフェールオーバーしている場合に発生するような、非アクティブなサーバー インスタンスがあります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-243">Another cause of a failed attempt is an inactive server instance, as occurs when a server instance is engaged in failing over its database.</span></span> <span data-ttu-id="7d2c4-244">この場合、クライアントが短時間の連続的な接続試行によってパートナーに負荷をかけ過ぎないように、再試行間隔が指定されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-244">In this case, a retry delay is imposed to prevent clients from overloading the partners with a rapid succession of connection attempts.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-245">両方のパートナー名が使用できる場合、ログイン タイムアウト期間に制限がないと、クライアントは、イニシャル パートナー名とフェールオーバー パートナー名を交互に使いながら、無制限にサーバーへの再接続を試みます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-245">When both partner names are available, if the login time-out period is infinite, the client attempts to reconnect to the servers indefinitely, alternating between the initial partner name and the failover partner name.</span></span>  
<span data-ttu-id="7d2c4-246">)</span><span class="sxs-lookup"><span data-stu-id="7d2c4-246">)</span></span>  
  
### <a name="retry-delays-during-failover"></a><span data-ttu-id="7d2c4-247">フェールオーバー中の再試行間隔</span><span class="sxs-lookup"><span data-stu-id="7d2c4-247">Retry Delays During Failover</span></span>  
 <span data-ttu-id="7d2c4-248">フェールオーバーしているパートナーにクライアントが接続を試みると、パートナーはすぐに非アクティブであることを応答します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-248">If a client attempts to connect to a partner that is failing over, the partner immediately responds that it is inactive.</span></span> <span data-ttu-id="7d2c4-249">この場合、接続試行の各ラウンドは、割り当てられた再試行時間よりかなり短くなります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-249">In this case, each round of connection attempts are much briefer than the allotted retry time.</span></span> <span data-ttu-id="7d2c4-250">つまり、接続試行の多くのラウンドは、ログイン期間がタイムアウトする前に発生する場合があります。フェールオーバー中に短時間で連続した接続試行を行ってパートナーに負荷がかかり過ぎるのを回避するために、データ アクセス プロバイダーは、各再試行サイクルの後に短い再試行間隔を追加します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-250">This means that many rounds of connection attempts could happen before the login period times out. To avoid overloading the partners with a rapid series of connection attempts during a failover, the data access provider adds a brief retry delay after each retry cycle.</span></span> <span data-ttu-id="7d2c4-251">指定された再試行間隔の長さは、再試行間隔アルゴリズムによって決まります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-251">The length of a given retry delay is determined by the retry-delay algorithm.</span></span> <span data-ttu-id="7d2c4-252">最初のラウンドの後の間隔は 100 ミリ秒です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-252">After the first round, the delay is 100 milliseconds.</span></span> <span data-ttu-id="7d2c4-253">それ以降の再試行間隔は 3 ラウンドごとに、200、400、800 と倍になっていきます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-253">After each of the next three rounds, the retry delay doubles-to 200, 400, and 800.</span></span> <span data-ttu-id="7d2c4-254">その後のすべてのラウンドでは、接続試行が成功するかタイムアウトするまで再試行間隔は 1 秒になります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-254">For all later rounds, the retry delay is 1 second until the connection attempt succeeds or times out.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-255">サーバー インスタンスが停止すると、接続要求はすぐに失敗します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-255">If the server instance is stopped, then the connection request fails immediately.</span></span>  
  
 <span data-ttu-id="7d2c4-256">次の図では、手動フェールオーバー中の再試行間隔による接続試行への影響を示しています。ここでは、パートナーは役割を交換しています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-256">The following figure illustrates how the retry delay affects connection attempts during a manual failover, in which the partners switch their roles.</span></span> <span data-ttu-id="7d2c4-257">ログイン タイムアウト期間は 15 秒です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-257">The login time-out period is 15 seconds.</span></span>  
  
 <span data-ttu-id="7d2c4-258">![再試行間隔のアルゴリズム](../media/dbm-retry-delay-algorithm.gif "再試行間隔のアルゴリズム")</span><span class="sxs-lookup"><span data-stu-id="7d2c4-258">![Retry-delay algorithm](../media/dbm-retry-delay-algorithm.gif "Retry-delay algorithm")</span></span>  
  
##  <a name="reconnecting-to-a-database-mirroring-session"></a><a name="Reconnecting"></a> <span data-ttu-id="7d2c4-259">データベース ミラーリング セッションへの再接続</span><span class="sxs-lookup"><span data-stu-id="7d2c4-259">Reconnecting to a Database Mirroring Session</span></span>  
 <span data-ttu-id="7d2c4-260">データベース ミラーリングのフェールオーバーなどの理由でデータベース ミラーリング セッションに対して確立された接続が失敗し、アプリケーションが最初のサーバーに再接続を試みると、データ アクセス プロバイダーは、クライアントのキャッシュに保存されたフェールオーバー パートナー名を使用して再接続を試みる場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-260">If an established connection to a database mirroring session fails for any reason, for example, due to a database mirroring failover, and the application attempts to reconnect to the initial server, the data access provider can attempt to reconnect using the failover partner name stored in the client's cache.</span></span> <span data-ttu-id="7d2c4-261">ただし、再接続は自動的には行われず、</span><span class="sxs-lookup"><span data-stu-id="7d2c4-261">Reconnecting is not automatic, however.</span></span> <span data-ttu-id="7d2c4-262">アプリケーションではエラーを検出することになります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-262">The application must become aware of the error.</span></span> <span data-ttu-id="7d2c4-263">その後、アプリケーションは失敗した接続を閉じて、同じ接続文字列属性を使用して新しい接続を開く必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-263">Then, the application needs to close the failed connection and open a new connection using the same connection string attributes.</span></span> <span data-ttu-id="7d2c4-264">この時点で、データ アクセス プロバイダーがフェールオーバー パートナーに接続をリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-264">At this point, the data access provider redirects the connection to the failover partner.</span></span> <span data-ttu-id="7d2c4-265">この名前で識別されるサーバー インスタンスが現在のプリンシパル サーバーの場合は、通常、接続試行は成功します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-265">If the server instance identified by this name is currently the principal server, the connection attempt usually succeeds.</span></span> <span data-ttu-id="7d2c4-266">トランザクションがコミットされたかロールバックされたかはっきりしない場合、アプリケーションでは、スタンドアロンのサーバー インスタンスに再接続するときと同じように、トランザクションの状態を確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-266">If it is unclear whether a transaction was committed or rolled back, the application must check on the state of the transaction, in the same way as when reconnecting to a stand-alone server instance.</span></span>  
  
 <span data-ttu-id="7d2c4-267">再接続は、接続文字列でフェールオーバー パートナー名を指定した最初の接続と同様に行われます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-267">Reconnecting resembles an initial connection for which the connection string supplied a failover partner name.</span></span> <span data-ttu-id="7d2c4-268">最初の接続試行が失敗すると、クライアントがプリンシパル サーバーに接続するか、データ アクセス プロバイダーがタイムアウトするまで、イニシャル パートナー名とフェールオーバー パートナー名を交互に使用して接続が試行されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-268">If the first connection attempt fails, connection attempts alternate back and forth between the initial partner name and failover partner name until either the client connects to the  principal server or the data access provider times out.</span></span>  
  
> [!NOTE]  
>  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="7d2c4-269">Native Client では、クライアントからプリンシパル サーバー インスタンスへの接続は確認しますが、接続したインスタンスが接続文字列のイニシャル パートナー名に指定されたサーバー インスタンスのパートナーかどうかは確認しません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-269">Native Client verifies that it connects to a principal server instance but not whether this instance is the partner of server instance specified in the initial partner name of the connection string.</span></span>  
  
 <span data-ttu-id="7d2c4-270">接続に TCP/IP を使用している場合は、接続再試行アルゴリズムによって、接続試行の各ラウンドに割り当てられる時間が決まります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-270">If the connections use TCP/IP, the connection retry algorithm determines the amount of time allotted to the connection attempts in each round.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7d2c4-271">クライアントとデータベース間の接続が切断された場合、データ アクセス プロバイダーでは再接続が試行されません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-271">If the client gets disconnected from the database, the data access provider does not attempt to reconnect.</span></span> <span data-ttu-id="7d2c4-272">クライアントから新規接続要求を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-272">The client must issue a new connection request.</span></span> <span data-ttu-id="7d2c4-273">また、接続が切断されたためにアプリケーションがシャットダウンされると、キャッシュに保存されているパートナー名は失われます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-273">Also, if an application shuts down on losing the connection, it will lose the cached partner names.</span></span> <span data-ttu-id="7d2c4-274">プリンシパル サーバーが使用できなくなったために接続が切断されると、接続文字列でフェールオーバー パートナー名を指定する以外に、アプリケーションがミラー サーバーに再接続できる方法はありません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-274">If the connection was lost because the principal server became unavailable, the only way that the application can reconnect to the mirror server is by supplying the failover partner name in its connection string.</span></span>  
  
  
### <a name="impact-of-redirection-on-a-client-application"></a><span data-ttu-id="7d2c4-275">クライアント アプリケーションでのリダイレクトの影響</span><span class="sxs-lookup"><span data-stu-id="7d2c4-275">Impact of Redirection on a Client Application</span></span>  
 <span data-ttu-id="7d2c4-276">フェールオーバー後、データ アクセス プロバイダーは、現在のプリンシパル サーバー インスタンスに接続をリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-276">After a failover, the data access provider redirects the connection to the current principal server instance.</span></span> <span data-ttu-id="7d2c4-277">ただし、リダイレクトはクライアント側では認識されません。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-277">However, the redirection is transparent to clients.</span></span> <span data-ttu-id="7d2c4-278">リダイレクトされた接続は、クライアントにはイニシャル パートナー名で特定されたサーバー インスタンスへの接続のように見えます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-278">To a client, a redirected connection appears to be a connection to the server instance identified by the initial partner name.</span></span> <span data-ttu-id="7d2c4-279">イニシャル パートナーが現在ミラー サーバーの場合、クライアントはミラー サーバーに接続され、ミラー データベースを更新しているように見えます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-279">When the initial partner is currently the mirror server, the client can appear to be connected to the mirror server and updating the mirror database.</span></span> <span data-ttu-id="7d2c4-280">ただし、実際には、クライアントは現在のプリンシパル データベースであるフェールオーバー パートナーにリダイレクトされています。また、クライアントは、新しいプリンシパル データベースを更新しています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-280">Actually, however, the client has been redirected to the failover partner, which is the current principal database, and the client is updating the new principal database.</span></span>  
  
 <span data-ttu-id="7d2c4-281">クライアントがフェールオーバー パートナーにリダイレクトされた後、 [!INCLUDE[tsql](../../includes/tsql-md.md)] USE ステートメントを使用して別のデータベースを使用すると、予期しない結果が発生する場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-281">After being redirected to the failover partner, a client can experience unexpected results when using a [!INCLUDE[tsql](../../includes/tsql-md.md)] USE statement to use a different database.</span></span> <span data-ttu-id="7d2c4-282">これは、現在のプリンシパル サーバー インスタンス (フェールオーバー パートナー) で元のプリンシパル サーバー (イニシャル パートナー) とは異なるデータベースを使用している場合に発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-282">This can happen if the current principal server instance (the failover partner) has a different set of databases than the original principal server (the initial partner).</span></span>  
  
##  <a name="the-impact-of-a-stale-failover-partner-name"></a><a name="StalePartnerName"></a> <span data-ttu-id="7d2c4-283">古いフェールオーバー パートナー名の影響</span><span class="sxs-lookup"><span data-stu-id="7d2c4-283">The Impact of a Stale Failover Partner Name</span></span>  
 <span data-ttu-id="7d2c4-284">データベース管理者はフェールオーバー パートナーをいつでも変更できます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-284">The database administrator can change the failover partner at any time.</span></span> <span data-ttu-id="7d2c4-285">このため、クライアントが指定したフェールオーバー パートナー名が *古い*場合があります。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-285">Therefore, a client-supplied failover partner name might be out of date, or *stale*.</span></span> <span data-ttu-id="7d2c4-286">たとえば、別のサーバー インスタンス Partner_C で置き換えられる Partner_B というフェールオーバー パートナーを考えてみます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-286">For example, consider a failover partner named Partner_B that is replaced by another server instance, Partner_C.</span></span> <span data-ttu-id="7d2c4-287">クライアントがフェールオーバー パートナー名として Partner_B を指定した場合、それは古い名前です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-287">Now, if a client supplies Partner_B as the failover partner name, that name is stale.</span></span> <span data-ttu-id="7d2c4-288">クライアント指定のフェールオーバー パートナー名が古い場合、データ アクセス プロバイダーは、クライアントでフェールオーバー パートナー名が指定されていない場合と同じように動作します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-288">When the client-supplied failover partner name is stale, the behavior of the data access provider equates to the case in which a failover partner name is not supplied by the client.</span></span>  
  
 <span data-ttu-id="7d2c4-289">たとえば、クライアントによって 1 つの接続文字列が 4 回の接続試行に使用される場合を検討します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-289">For example, consider situation in which a client uses one connection string for a series of four connection attempts.</span></span> <span data-ttu-id="7d2c4-290">この接続文字列では、次のようにイニシャル パートナー名が Partner_A で、フェールオーバー パートナー名が Partner_B です。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-290">In the connection string, the initial partner name is Partner_A, and the failover partner name is Partner_B:</span></span>  
  
```  
"Server=Partner_A; Failover Partner=Partner_B; Database=AdventureWorks"  
```  
  
 <span data-ttu-id="7d2c4-291">次の表は、4 つのパートナー構成と、それぞれの構成でこの接続文字列がクライアントの初回接続時に機能するかどうかを示しています。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-291">The following table shows four partner configurations and indicates for each whether this connection string works for connecting the client for the first time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7d2c4-292">アプリケーションでは、構成の変更を追跡し、その変更に応じて接続文字列を変更することができます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-292">An application can track configuration changes and change its connection string accordingly.</span></span> <span data-ttu-id="7d2c4-293">これには追加のコードが必要ですが、管理上の負担は軽減されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-293">This requires extra code but reduces the administrative burden.</span></span>  
  
|<span data-ttu-id="7d2c4-294">構成</span><span class="sxs-lookup"><span data-stu-id="7d2c4-294">Configuration</span></span>|<span data-ttu-id="7d2c4-295">プリンシパル サーバー</span><span class="sxs-lookup"><span data-stu-id="7d2c4-295">Principal server</span></span>|<span data-ttu-id="7d2c4-296">ミラー サーバー</span><span class="sxs-lookup"><span data-stu-id="7d2c4-296">Mirror server</span></span>|<span data-ttu-id="7d2c4-297">Partner_A と Partner_B を指定して接続を試行するときの動作</span><span class="sxs-lookup"><span data-stu-id="7d2c4-297">Behavior when attempting to connect specifying Partner_A and Partner_B</span></span>|  
|-------------------|----------------------|-------------------|------------------------------------------------------------------------------|  
|<span data-ttu-id="7d2c4-298">元のミラー化構成</span><span class="sxs-lookup"><span data-stu-id="7d2c4-298">Original mirroring configuration.</span></span>|<span data-ttu-id="7d2c4-299">Db_1</span><span class="sxs-lookup"><span data-stu-id="7d2c4-299">Partner_A</span></span>|<span data-ttu-id="7d2c4-300">Partner_B</span><span class="sxs-lookup"><span data-stu-id="7d2c4-300">Partner_B</span></span>|<span data-ttu-id="7d2c4-301">Partner_A はイニシャル パートナー名としてキャッシュに保存されます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-301">Partner_A is cached as the initial partner name.</span></span> <span data-ttu-id="7d2c4-302">クライアントは、Partner_A への接続に成功します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-302">The client succeeds in connecting to Partner_A.</span></span> <span data-ttu-id="7d2c4-303">クライアントは、Partner_B というミラー サーバーの名前をダウンロードしてキャッシュに保存し、クライアント指定のフェールオーバー パートナー名を無視します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-303">The client downloads the name of mirror server, Partner_B, and caches it, ignoring the client-supplied failover partner name.</span></span>|  
|<span data-ttu-id="7d2c4-304">Partner_A でハードウェア障害が発生し、フェールオーバーを実行 (クライアントの接続を切断)</span><span class="sxs-lookup"><span data-stu-id="7d2c4-304">Partner_A experiences a hardware failure, and failover occurs (disconnecting clients).</span></span>|<span data-ttu-id="7d2c4-305">Partner_B</span><span class="sxs-lookup"><span data-stu-id="7d2c4-305">Partner_B</span></span>|<span data-ttu-id="7d2c4-306">なし</span><span class="sxs-lookup"><span data-stu-id="7d2c4-306">none</span></span>|<span data-ttu-id="7d2c4-307">Partner_A はイニシャル パートナー名としてキャッシュに保存されていますが、クライアント指定のフェールオーバー パートナー名 Partner_B を使用して、クライアントは現在のプリンシパル サーバーに接続できます。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-307">The Partner_A is still cached as the initial partner name, but the client-supplied failover partner name, Partner_B, permits the client to connect to the current principal server.</span></span>|  
|<span data-ttu-id="7d2c4-308">データベース管理者がミラー化を停止し (クライアントの接続を切断)、Partner_A を Partner_C に置き換えて、ミラー化を再開</span><span class="sxs-lookup"><span data-stu-id="7d2c4-308">The database administrator stops mirroring (disconnecting clients), replaces Partner_A with Partner_C, and restarts mirroring.</span></span>|<span data-ttu-id="7d2c4-309">Partner_B</span><span class="sxs-lookup"><span data-stu-id="7d2c4-309">Partner_B</span></span>|<span data-ttu-id="7d2c4-310">Partner_C</span><span class="sxs-lookup"><span data-stu-id="7d2c4-310">Partner_C</span></span>|<span data-ttu-id="7d2c4-311">クライアントは Partner_A への接続を試行して失敗します。その後、Partner_B (現在のプリンシパル サーバー) への接続を試行して成功します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-311">The client attempts to connect to Partner_A and fails; then the client tries Partner_B (the current principal server) and succeeds.</span></span> <span data-ttu-id="7d2c4-312">データ アクセス プロバイダーは現在のミラー サーバー名である Partner_C をダウンロードし、現在のフェールオーバー パートナー名としてキャッシュに保存します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-312">The data access provider downloads the name of the current mirror server, Partner_C, and caches it as the current failover partner name.</span></span>|  
|<span data-ttu-id="7d2c4-313">サービスを手動で Partner_C にフェールオーバー (クライアントの接続を切断)</span><span class="sxs-lookup"><span data-stu-id="7d2c4-313">Service is manually failed over to Partner_C (disconnecting clients).</span></span>|<span data-ttu-id="7d2c4-314">Partner_C</span><span class="sxs-lookup"><span data-stu-id="7d2c4-314">Partner_C</span></span>|<span data-ttu-id="7d2c4-315">Partner_B</span><span class="sxs-lookup"><span data-stu-id="7d2c4-315">Partner_B</span></span>|<span data-ttu-id="7d2c4-316">クライアントはまず Partner_A に接続してから Partner_B に接続しようとします。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-316">Client attempts to connect to Partner_A initially, and then to Partner_B.</span></span> <span data-ttu-id="7d2c4-317">どちらの名前でも接続に失敗し、最終的には接続要求がタイムアウトになって失敗します。</span><span class="sxs-lookup"><span data-stu-id="7d2c4-317">Both names fail, and eventually the connection request times out and fails.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="7d2c4-318">参照</span><span class="sxs-lookup"><span data-stu-id="7d2c4-318">See Also</span></span>  
 <span data-ttu-id="7d2c4-319">[データベース ミラーリング &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7d2c4-319">[Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="7d2c4-320">データベース ミラーリング中に発生する可能性のあるエラー</span><span class="sxs-lookup"><span data-stu-id="7d2c4-320">Possible Failures During Database Mirroring</span></span>](possible-failures-during-database-mirroring.md)  
  
  
