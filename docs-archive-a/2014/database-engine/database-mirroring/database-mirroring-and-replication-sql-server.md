---
title: データベース ミラーリングとレプリケーション (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- replication [SQL Server], database mirroring and
ms.assetid: 82796217-02e2-4bc5-9ab5-218bae11a2d6
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: b126aeb8ccd24932706b8798ebfe7088308918e2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87736768"
---
# <a name="database-mirroring-and-replication-sql-server"></a><span data-ttu-id="4f042-102">データベース ミラーリングとレプリケーション (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="4f042-102">Database Mirroring and Replication (SQL Server)</span></span>
  <span data-ttu-id="4f042-103">データベース ミラーリングとレプリケーションを組み合わせて使用すると、パブリケーション データベースの可用性を高めることができます。</span><span class="sxs-lookup"><span data-stu-id="4f042-103">Database mirroring can be used in conjunction with replication to improve availability for the publication database.</span></span> <span data-ttu-id="4f042-104">データベース ミラーリングでは単一データベースの 2 つのコピーを使用します。通常、これらのコピーは異なるコンピューターに配置されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-104">Database mirroring involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="4f042-105">クライアントが任意の時点において使用できるデータベースのコピーは 1 つだけです。</span><span class="sxs-lookup"><span data-stu-id="4f042-105">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="4f042-106">このコピーはプリンシパル データベースと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="4f042-106">This copy is known as the principal database.</span></span> <span data-ttu-id="4f042-107">クライアントがプリンシパル データベースに対して加えた更新は、ミラー データベースと呼ばれるもう一方のコピー データベースに適用されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-107">Updates made by clients to the principal database are applied on the other copy of the database, known as the mirror database.</span></span> <span data-ttu-id="4f042-108">プリンシパル データベースに対して行われた挿入、更新、および削除はすべてトランザクション ログに記録され、ミラーリングによってこのトランザクション ログがミラー データベースに適用されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-108">Mirroring involves applying the transaction log from every insertion, update, or deletion made on the principal database onto the mirror database.</span></span>  
  
 <span data-ttu-id="4f042-109">ミラーに対するレプリケーション フェールオーバーはパブリケーション データベースでのみ完全にサポートされ、サブスクリプション データベースでは制限付きでサポートされます。</span><span class="sxs-lookup"><span data-stu-id="4f042-109">Replication failover to a mirror is fully supported for publication databases, with limited support for subscription databases.</span></span> <span data-ttu-id="4f042-110">データベース ミラーリングは、ディストリビューション データベースではサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="4f042-110">Database mirroring is not supported for the distribution database.</span></span> <span data-ttu-id="4f042-111">レプリケーションを再構成することなく、ディストリビューション データベースおよびサブスクリプション データベースを復旧する場合の詳細については、「 [レプリケートされたデータベースのバックアップと復元](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-111">For information about recovering a distribution database or subscription database without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span> <span data-ttu-id="4f042-112">サブスクライバー データベースのミラーリングの詳細については、以下を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-112">For information about mirroring the subscriber database, see the</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="4f042-113">フェールオーバー後には、ミラーがプリンシパルになります。</span><span class="sxs-lookup"><span data-stu-id="4f042-113">After a failover, the mirror becomes the principal.</span></span> <span data-ttu-id="4f042-114">このトピックでは、"プリンシパル" および "ミラー" という言葉は常に、元のプリンシパルとミラーを表します。</span><span class="sxs-lookup"><span data-stu-id="4f042-114">In this topic, "principal" and "mirror" always refer to the original principal and mirror.</span></span>  
  
## <a name="requirements-and-considerations-for-using-replication-with-database-mirroring"></a><span data-ttu-id="4f042-115">レプリケーションとデータベース ミラーリングを併用する場合の要件および注意事項</span><span class="sxs-lookup"><span data-stu-id="4f042-115">Requirements and Considerations for Using Replication with Database Mirroring</span></span>  
 <span data-ttu-id="4f042-116">レプリケーションとデータベース ミラーリングを併用する場合、以下の要件および考慮事項に注意してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-116">Be aware of the following requirements and considerations when using replication with database mirroring:</span></span>  
  
-   <span data-ttu-id="4f042-117">プリンシパルとミラーはディストリビューターを共有する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-117">The principal and mirror must share a Distributor.</span></span> <span data-ttu-id="4f042-118">このディストリビューターにはリモート ディストリビューターを使用することをお勧めします。こうすることによって、パブリッシャーに予定外のフェールオーバーが発生した場合のフォールト トレランスが向上します。</span><span class="sxs-lookup"><span data-stu-id="4f042-118">We recommend that this be a remote Distributor, which provides greater fault tolerance if the Publisher has an unplanned failover.</span></span>  
  
-   <span data-ttu-id="4f042-119">マージ レプリケーション、および読み取り専用サブスクライバーまたはキュー更新サブスクライバーを使用するトランザクション レプリケーションでは、パブリケーション データベースのミラーリングがサポートされます。</span><span class="sxs-lookup"><span data-stu-id="4f042-119">Replication supports mirroring the publication database for merge replication and for transactional replication with read-only Subscribers or queued updating Subscribers.</span></span> <span data-ttu-id="4f042-120">即時更新サブスクライバー、Oracle パブリッシャー、ピア ツー ピア トポロジのパブリッシャー、および再パブリッシュはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="4f042-120">Immediate updating Subscribers, Oracle Publishers, Publishers in a peer-to-peer topology, and republishing are not supported.</span></span>  
  
-   <span data-ttu-id="4f042-121">ログイン、ジョブ、リンク サーバーなど、データベースの外部に存在するメタデータやオブジェクトはミラーにコピーされません。</span><span class="sxs-lookup"><span data-stu-id="4f042-121">Metadata and objects that exist outside the database are not copied to the mirror, including logins, jobs, linked servers, and so on.</span></span> <span data-ttu-id="4f042-122">これらのメタデータやオブジェクトをミラーで必要とする場合、手動でコピーする必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-122">If you require the metadata and objects at the mirror, you must copy them manually.</span></span> <span data-ttu-id="4f042-123">詳細については、「[役割の交代後のログインとジョブの管理 &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-123">For more information, see [Management of Logins and Jobs After Role Switching &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md).</span></span>  
  
## <a name="configuring-replication-with-database-mirroring"></a><span data-ttu-id="4f042-124">データベース ミラーリングを使用するレプリケーションの構成</span><span class="sxs-lookup"><span data-stu-id="4f042-124">Configuring Replication with Database Mirroring</span></span>  
 <span data-ttu-id="4f042-125">レプリケーションとデータベース ミラーリングの構成には、以下の 5 つの手順があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-125">Configuring replication and database mirroring involves five steps.</span></span> <span data-ttu-id="4f042-126">各手順の詳細については、以下のセクションで説明します。</span><span class="sxs-lookup"><span data-stu-id="4f042-126">Each step is described in more detail in the following section.</span></span>  
  
1.  <span data-ttu-id="4f042-127">パブリッシャーを構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-127">Configure the Publisher.</span></span>  
  
2.  <span data-ttu-id="4f042-128">データベース ミラーリングを構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-128">Configure database mirroring.</span></span>  
  
3.  <span data-ttu-id="4f042-129">プリンシパルと同じディストリビューターを使用するようにミラーを構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-129">Configure the mirror to use the same Distributor as the principal.</span></span>  
  
4.  <span data-ttu-id="4f042-130">フェールオーバー用にレプリケーション エージェントを構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-130">Configure replication agents for failover.</span></span>  
  
5.  <span data-ttu-id="4f042-131">プリンシパルおよびミラーをレプリケーション モニターに追加します。</span><span class="sxs-lookup"><span data-stu-id="4f042-131">Add the principal and mirror to Replication Monitor.</span></span>  
  
 <span data-ttu-id="4f042-132">手順 1. と手順 2. の実行順序は逆にすることもできます。</span><span class="sxs-lookup"><span data-stu-id="4f042-132">Steps 1 and 2 can also be performed in the opposite order.</span></span>  
  
#### <a name="to-configure-database-mirroring-for-a-publication-database"></a><span data-ttu-id="4f042-133">パブリケーション データベースのデータベース ミラーリングを構成するには</span><span class="sxs-lookup"><span data-stu-id="4f042-133">To configure database mirroring for a publication database</span></span>  
  
1.  <span data-ttu-id="4f042-134">パブリッシャーを構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-134">Configure the Publisher:</span></span>  
  
    1.  <span data-ttu-id="4f042-135">リモート ディストリビューターの使用をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="4f042-135">We recommend using a remote Distributor.</span></span> <span data-ttu-id="4f042-136">ディストリビューションの構成の詳細については、「 [ディストリビューションの構成](../../relational-databases/replication/configure-distribution.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-136">For more information about configuring distribution, see [Configure Distribution](../../relational-databases/replication/configure-distribution.md).</span></span>  
  
    2.  <span data-ttu-id="4f042-137">スナップショット パブリケーション、トランザクション パブリケーション、およびマージ パブリケーションのデータベースを有効化できます。</span><span class="sxs-lookup"><span data-stu-id="4f042-137">You can enable a database for snapshot and transactional publications and/or merge publications.</span></span> <span data-ttu-id="4f042-138">複数の種類のパブリケーションを含むミラー データベースの場合、同一ノード上で [sp_replicationdboption](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql)を使用し、両方の種類のパブリケーションに対してデータベースを有効化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-138">For mirrored databases that will contain more than one type of publication, you must enable the database for both types at the same node using [sp_replicationdboption](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span> <span data-ttu-id="4f042-139">たとえば、以下のストアド プロシージャの呼び出しをプリンシパルで実行できます。</span><span class="sxs-lookup"><span data-stu-id="4f042-139">For example, you could execute the following stored procedure calls at the principal:</span></span>  
  
        ```  
        exec sp_replicationdboption @dbname='<PublicationDatabase>', @optname='publish', @value=true;  
        exec sp_replicationdboption @dbname='<PublicationDatabase>', @optname='mergepublish', @value=true;  
        ```  
  
         <span data-ttu-id="4f042-140">パブリケーションの作成の詳細については、「[データとデータベース オブジェクトのパブリッシュ](../../relational-databases/replication/publish/publish-data-and-database-objects.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-140">For more information about creating publications, see [Publish Data and Database Objects](../../relational-databases/replication/publish/publish-data-and-database-objects.md).</span></span>  
  
2.  <span data-ttu-id="4f042-141">データベース ミラーリングを構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-141">Configure database mirroring.</span></span> <span data-ttu-id="4f042-142">詳細については、「[Windows 認証を使用してデータベース ミラーリング セッションを確立する &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md)」および「[データベース ミラーリングの設定 &#40;SQL Server&#41;](database-mirroring-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-142">For more information, see [Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md) and [Setting Up Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="4f042-143">ディストリビューションをミラー用に構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-143">Configure distribution for the mirror.</span></span> <span data-ttu-id="4f042-144">ミラー名をパブリッシャーとして指定し、プリンシパルと同一のディストリビューターおよびスナップショット フォルダーを指定します。</span><span class="sxs-lookup"><span data-stu-id="4f042-144">Specify the mirror name as the Publisher, and specify the same Distributor and snapshot folder that the principal uses.</span></span> <span data-ttu-id="4f042-145">たとえば、ストアド プロシージャを使用してレプリケーションを構成する場合、ディストリビューターで [sp_adddistpublisher](/sql/relational-databases/system-stored-procedures/sp-adddistpublisher-transact-sql) を実行し、次にミラーで [sp_adddistributor](/sql/relational-databases/system-stored-procedures/sp-adddistributor-transact-sql) を実行します。</span><span class="sxs-lookup"><span data-stu-id="4f042-145">For example, if you are configuring replication with stored procedures, execute [sp_adddistpublisher](/sql/relational-databases/system-stored-procedures/sp-adddistpublisher-transact-sql) at the Distributor; and then execute [sp_adddistributor](/sql/relational-databases/system-stored-procedures/sp-adddistributor-transact-sql) at the mirror.</span></span> <span data-ttu-id="4f042-146">**sp_adddistpublisher**の場合は、以下の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="4f042-146">For **sp_adddistpublisher**:</span></span>  
  
    -   <span data-ttu-id="4f042-147">パラメーターの値 **@publisher** をミラーのネットワーク名に設定します。</span><span class="sxs-lookup"><span data-stu-id="4f042-147">Set the value of the **@publisher** parameter to the network name of the mirror.</span></span>  
  
    -   <span data-ttu-id="4f042-148">パラメーターの値を、 **@working_directory** プリンシパルによって使用されるスナップショットフォルダーに設定します。</span><span class="sxs-lookup"><span data-stu-id="4f042-148">Set the value of the **@working_directory** parameter to the snapshot folder used by the principal.</span></span>  
  
4.  <span data-ttu-id="4f042-149">**-PublisherFailoverPartner** エージェント パラメーターの値にミラー名を指定します。</span><span class="sxs-lookup"><span data-stu-id="4f042-149">Specify the mirror name for the **-PublisherFailoverPartner** agent parameter.</span></span> <span data-ttu-id="4f042-150">フェールオーバーの後、以下のエージェントでミラーを特定する場合にこのエージェント パラメーターが必要になります。</span><span class="sxs-lookup"><span data-stu-id="4f042-150">Agent This parameter is required for the following agents to identify the mirror after failover:</span></span>  
  
    -   <span data-ttu-id="4f042-151">スナップショット エージェント (すべてのパブリケーション用)</span><span class="sxs-lookup"><span data-stu-id="4f042-151">Snapshot Agent (for all publications)</span></span>  
  
    -   <span data-ttu-id="4f042-152">ログ リーダー エージェント (すべてのトランザクション パブリケーション用)</span><span class="sxs-lookup"><span data-stu-id="4f042-152">Log Reader Agent (for all transactional publications)</span></span>  
  
    -   <span data-ttu-id="4f042-153">キュー リーダー エージェント (キュー更新サブスクリプションをサポートするトランザクション パブリケーション用)</span><span class="sxs-lookup"><span data-stu-id="4f042-153">Queue Reader Agent (for transactional publications that support queued updating subscriptions)</span></span>  
  
    -   <span data-ttu-id="4f042-154">マージ エージェント (マージ サブスクリプション用)</span><span class="sxs-lookup"><span data-stu-id="4f042-154">Merge Agent (for merge subscriptions)</span></span>  
  
    -   [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="4f042-155">レプリケーション リスナー (replisapi.dll : Web 同期を使用して同期したマージ サブスクリプション用)</span><span class="sxs-lookup"><span data-stu-id="4f042-155">replication listener (replisapi.dll: for merge subscriptions synchronized using Web synchronization)</span></span>  
  
    -   <span data-ttu-id="4f042-156">SQL マージ ActiveX コントロール (このコントロールを使用して同期したマージ サブスクリプション用)</span><span class="sxs-lookup"><span data-stu-id="4f042-156">SQL Merge ActiveX Control (for merge subscriptions synchronized with the control)</span></span>  
  
     <span data-ttu-id="4f042-157">ディストリビューション エージェントおよびディストリビューション ActiveX コントロールはパブリッシャーに接続しないため、このパラメーターがありません。</span><span class="sxs-lookup"><span data-stu-id="4f042-157">The Distribution Agent and Distribution ActiveX Control do not have this parameter because they do not connect to the Publisher.</span></span>  
  
     <span data-ttu-id="4f042-158">エージェント パラメーターの変更は、エージェントの次回起動時に反映されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-158">Agent parameter changes take effect the next time the agent is started.</span></span> <span data-ttu-id="4f042-159">エージェントを継続して実行している場合は、そのエージェントを停止して再起動する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-159">If the agent runs continuously, you must stop and restart the agent.</span></span> <span data-ttu-id="4f042-160">パラメーターは、エージェント プロファイルおよびコマンド プロンプトで指定できます。</span><span class="sxs-lookup"><span data-stu-id="4f042-160">Parameters can be specified in agent profiles and from the command prompt.</span></span> <span data-ttu-id="4f042-161">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-161">For more information, see:</span></span>  
  
    -   [<span data-ttu-id="4f042-162">レプリケーション エージェント コマンド プロンプト パラメーターを表示および変更する &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="4f042-162">View and Modify Replication Agent Command Prompt Parameters &#40;SQL Server Management Studio&#41;</span></span>](../../relational-databases/replication/agents/view-and-modify-replication-agent-command-prompt-parameters.md)  
  
    -   [<span data-ttu-id="4f042-163">Replication Agent Executables Concepts</span><span class="sxs-lookup"><span data-stu-id="4f042-163">Replication Agent Executables Concepts</span></span>](../../relational-databases/replication/concepts/replication-agent-executables-concepts.md)  
  
     <span data-ttu-id="4f042-164">**-PublisherFailoverPartner** をエージェント プロファイルに追加して、プロファイルにミラー名を指定することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="4f042-164">We recommend adding the **-PublisherFailoverPartner** to an agent profile, and then specifying the mirror name in the profile.</span></span> <span data-ttu-id="4f042-165">たとえば、ストアド プロシージャを使用してレプリケーションを構成する場合、以下のように指定します。</span><span class="sxs-lookup"><span data-stu-id="4f042-165">For example, if you are configuring replication with stored procedures:</span></span>  
  
    ```  
    -- Execute sp_help_agent_profile in the context of the distribution database to get the list of profiles.  
    -- Select the profile id of the profile that needs to be updated from the result set.  
    -- In the agent_type column returned by sp_help_agent_profile:   
    -- 1 = Snapshot Agent; 2 = Log Reader Agent; 3 = Distribution Agent; 4 = Merge Agent; 9 = Queue Reader Agent.  
  
    exec sp_help_agent_profile;  
  
    -- Setting the -PublisherFailoverPartner parameter in the default Snapshot Agent profile (profile 1).  
    -- Execute sp_add_agent_parameter in the context of the distribution database.  
    exec sp_add_agent_parameter @profile_id = 1, @parameter_name = N'-PublisherFailoverPartner', @parameter_value = N'<Failover Partner Name>';  
  
    -- Setting the -PublisherFailoverPartner parameter in the default Merge Agent profile (profile 6).  
    -- Execute sp_add_agent_parameter in the context of the distribution database.  
    exec sp_add_agent_parameter @profile_id = 6, @parameter_name = N'-PublisherFailoverPartner', @parameter_value = N'<Failover Partner Name>';  
    ```  
  
5.  <span data-ttu-id="4f042-166">プリンシパルおよびミラーをレプリケーション モニターに追加します。</span><span class="sxs-lookup"><span data-stu-id="4f042-166">Add the principal and mirror to Replication Monitor.</span></span> <span data-ttu-id="4f042-167">詳細については、「 [レプリケーション モニターのパブリッシャーの追加および削除](../../relational-databases/replication/monitor/add-and-remove-publishers-from-replication-monitor.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-167">For more information, see [Add and Remove Publishers from Replication Monitor](../../relational-databases/replication/monitor/add-and-remove-publishers-from-replication-monitor.md).</span></span>  
  
## <a name="maintaining-a-mirrored-publication-database"></a><span data-ttu-id="4f042-168">ミラー化したパブリケーション データベースのメンテナンス</span><span class="sxs-lookup"><span data-stu-id="4f042-168">Maintaining a Mirrored Publication Database</span></span>  
 <span data-ttu-id="4f042-169">ミラー化したパブリケーション データベースのメンテナンスは、ミラー化していないデータベースの場合と基本的に同じです。ただし、以下の点に注意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-169">Maintaining a mirrored publication database is essentially the same as maintaining a non-mirrored database, with the following considerations:</span></span>  
  
-   <span data-ttu-id="4f042-170">アクティブなサーバーで管理および監視を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-170">Administration and monitoring must occur at the active server.</span></span> <span data-ttu-id="4f042-171">[!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]では、アクティブなサーバーだけで、 **[ローカル パブリケーション]** フォルダー以下にパブリケーションが表示されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-171">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], publications appear under the **Local Publications** folder only for the active server.</span></span> <span data-ttu-id="4f042-172">たとえば、ミラーへのフェールオーバーが発生した場合、パブリケーションがミラーで表示され、プリンシパルでは表示されなくなります。</span><span class="sxs-lookup"><span data-stu-id="4f042-172">For example, if you failover to the mirror, the publications are displayed at the mirror and are no longer displayed at the principal.</span></span> <span data-ttu-id="4f042-173">データベースでミラーへのフェールオーバーが発生した場合、 [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] およびレプリケーション モニターを手動で更新して、変更を反映することが必要になる場合もあります。</span><span class="sxs-lookup"><span data-stu-id="4f042-173">If the database fails over to the mirror, you might need to manually refresh [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] and Replication Monitor for the change to be reflected.</span></span>  
  
-   <span data-ttu-id="4f042-174">レプリケーション モニターでは、プリンシパルとミラーの両方に対するオブジェクト ツリー内にパブリッシャー ノードが表示されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-174">Replication Monitor displays Publisher nodes in the object tree for both the principal and the mirror.</span></span> <span data-ttu-id="4f042-175">プリンシパルがアクティブなサーバーの場合、パブリケーション情報はレプリケーション モニターのプリンシパル ノード以下のみに表示されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-175">If the principal is the active server, publication information is displayed only under the principal node in Replication Monitor.</span></span>  
  
     <span data-ttu-id="4f042-176">ミラーがアクティブなサーバーの場合は、次のように表示されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-176">If the mirror is the active server:</span></span>  
  
    -   <span data-ttu-id="4f042-177">エージェントでエラーが発生している場合、エラーはプリンシパル ノードでのみ示され、ミラー ノードでは示されません。</span><span class="sxs-lookup"><span data-stu-id="4f042-177">If an agent has an error, the error is indicated only on the principal node, not on the mirror node.</span></span>  
  
    -   <span data-ttu-id="4f042-178">プリンシパルが使用不可の場合、プリンシパル ノードとミラー ノードで、パブリケーションの同一の一覧が表示されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-178">If the principal is unavailable, the principal and mirror nodes display identical lists of publications.</span></span> <span data-ttu-id="4f042-179">監視は、ミラー ノードのパブリケーションで実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-179">Monitoring should be performed on the publications under the mirror node.</span></span>  
  
-   <span data-ttu-id="4f042-180">ストアド プロシージャまたはレプリケーション管理オブジェクト (RMO) を使用して、ミラーでレプリケーションを管理する場合、パブリッシャー名を指定する際にはレプリケーションを有効にしたデータベースが使用するインスタンス名を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-180">When using stored procedures or Replication Management Objects (RMO) to administer replication at the mirror, for cases in which you specify the Publisher name, you must specify the name of the instance on which the database was enabled for replication.</span></span> <span data-ttu-id="4f042-181">適切な名前を決定するには、 [publishingservername](/sql/t-sql/functions/replication-functions-publishingservername)関数を使用します。</span><span class="sxs-lookup"><span data-stu-id="4f042-181">To determine the appropriate name, use the function [publishingservername](/sql/t-sql/functions/replication-functions-publishingservername).</span></span>  
  
     <span data-ttu-id="4f042-182">パブリケーション データベースをミラー化した場合、ミラー データベースに格納されるレプリケーション メタデータとプリンシパル データベースに格納されるメタデータが同一になります。</span><span class="sxs-lookup"><span data-stu-id="4f042-182">When a publication database is mirrored, the replication metadata stored in the mirrored database is identical to the metadata stored in the principal database.</span></span> <span data-ttu-id="4f042-183">その結果、プリンシパルでレプリケーションが有効なパブリケーション データベースでは、ミラーのシステム テーブルに格納されるパブリッシャーのインスタンス名は、ミラーではなくプリンシパルの名前になります。</span><span class="sxs-lookup"><span data-stu-id="4f042-183">Consequently, for publication databases enabled for replication at the principal, the Publisher instance name stored in system tables at the mirror is the name of the principal, not the mirror.</span></span> <span data-ttu-id="4f042-184">これにより、パブリケーション データベースでミラーへのフェールオーバーが発生した場合のレプリケーションの構成およびメンテナンスが影響を受けます。</span><span class="sxs-lookup"><span data-stu-id="4f042-184">This affects replication configuration and maintenance if the publication database fails over to the mirror.</span></span> <span data-ttu-id="4f042-185">たとえば、フェールオーバー後にストアドプロシージャを使用してレプリケーションを構成し、プリンシパルで有効にしたパブリケーションデータベースにプルサブスクリプションを追加する場合は、 **@publisher** **sp_addpullsubscription**または**sp_addmergepullsubscription**のパラメーターにミラー名ではなくプリンシパル名を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-185">For example, if you are configuring replication with stored procedures on the mirror after a failover, and you want to add a pull subscription to a publication database that was enabled at the principal, you must specify the principal name rather than the mirror name for the **@publisher** parameter of **sp_addpullsubscription** or **sp_addmergepullsubscription**.</span></span>  
  
     <span data-ttu-id="4f042-186">ミラーへのフェールオーバー後にミラーでパブリケーションデータベースを有効にした場合、システムテーブルに格納されているパブリッシャーのインスタンス名はミラーの名前になります。この場合は、パラメーターにミラーの名前を使用し **@publisher** ます。</span><span class="sxs-lookup"><span data-stu-id="4f042-186">If you enable a publication database at the mirror after failover to the mirror, the Publisher instance name stored in system tables is the name of the mirror; in this case, you would use the name of the mirror for the **@publisher** parameter.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="4f042-187">**sp_addpublication** などを使う場合、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 以外のパブリッシャーに対してのみ **@publisher** パラメーターがサポートされます。このような場合、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のデータベース ミラーリングとは無関係になります。</span><span class="sxs-lookup"><span data-stu-id="4f042-187">In some cases, such as **sp_addpublication**, the **@publisher** parameter is supported only for non-[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Publishers; in these cases, it is not relevant for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database mirroring.</span></span>  
  
-   <span data-ttu-id="4f042-188">フェールオーバーの後、 [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] でサブスクリプションを同期するには、サブスクライバーからプル サブスクリプションを同期し、アクティブなパブリッシャーからプッシュ サブスクリプションを同期します。</span><span class="sxs-lookup"><span data-stu-id="4f042-188">To synchronize a subscription in [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] after a failover: synchronize pull subscriptions from the Subscriber; and synchronize push subscriptions from the active Publisher.</span></span>  
  
### <a name="replication-behavior-if-mirroring-is-removed"></a><span data-ttu-id="4f042-189">ミラーリングを解除した場合のレプリケーションの動作</span><span class="sxs-lookup"><span data-stu-id="4f042-189">Replication Behavior if Mirroring is Removed</span></span>  
 <span data-ttu-id="4f042-190">パブリッシュされたデータベースからデータベース ミラーリングを解除する場合は、以下の点に注意してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-190">Keep the following issues in mind if database mirroring is removed from a published database:</span></span>  
  
-   <span data-ttu-id="4f042-191">プリンシパルでパブリケーション データベースが既にミラー化されていない場合、元のプリンシパルに対するレプリケーションはそのまま動作します。</span><span class="sxs-lookup"><span data-stu-id="4f042-191">If the publication database at the principal is no longer mirrored, replication continues to work unchanged against the original principal.</span></span>  
  
-   <span data-ttu-id="4f042-192">パブリケーション データベースでプリンシパルからミラーへのフェールオーバーが発生した後、ミラーリング リレーションシップを無効化または解除した場合、レプリケーション エージェントがミラーに対して機能しなくなります。</span><span class="sxs-lookup"><span data-stu-id="4f042-192">If the publication database fails over from the principal to the mirror and the mirroring relationship is subsequently disabled or removed, replication agents will not function against the mirror.</span></span> <span data-ttu-id="4f042-193">プリンシパルが完全に失われた場合、ミラーのレプリケーションをいったん無効化し、その後パブリッシャーとして再構成します。</span><span class="sxs-lookup"><span data-stu-id="4f042-193">If the principal is permanently lost, disable and then reconfigure replication with the mirror specified as the Publisher.</span></span>  
  
-   <span data-ttu-id="4f042-194">データベース ミラーリングを完全に解除した場合、ミラー データベースが復旧状態になるため、動作させるためには復元を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f042-194">If database mirroring is removed completely, the mirror database is in a recovery state and must be restored in order to become functional.</span></span> <span data-ttu-id="4f042-195">復旧したデータベースでレプリケーションがどのように動作するかは、KEEP_REPLICATION オプションを指定したかどうかによって異なります。</span><span class="sxs-lookup"><span data-stu-id="4f042-195">The behavior of the recovered database with respect to replication depends on whether the KEEP_REPLICATION option is specified.</span></span> <span data-ttu-id="4f042-196">このオプションを指定すると、パブリッシュされたデータベースをバックアップが作成されたサーバーと異なるサーバーに復元する場合に、復元操作でレプリケーションの設定が強制的に保存されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-196">This option forces the restore operation to preserve replication settings when restoring a published database to a server other than that on which the backup was created.</span></span> <span data-ttu-id="4f042-197">他のパブリケーション データベースが使用できない場合にのみ、KEEP_REPLICATION オプションを指定してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-197">Use the KEEP_REPLICATION option only when the other publication database is unavailable.</span></span> <span data-ttu-id="4f042-198">他のパブリケーション データベースが稼働中でレプリケーションを実行中の場合、このオプションはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="4f042-198">The option is not supported if the other publication database is still intact and replicating.</span></span> <span data-ttu-id="4f042-199">KEEP_REPLICATION の詳細については、「[RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-199">For more information about KEEP_REPLICATION, see [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
## <a name="log-reader-agent-behavior"></a><span data-ttu-id="4f042-200">ログ リーダー エージェントの動作</span><span class="sxs-lookup"><span data-stu-id="4f042-200">Log Reader Agent Behavior</span></span>  
 <span data-ttu-id="4f042-201">データベース ミラーリングのさまざまな動作モードに対するログ リーダー エージェントの動作を次の表に示します。</span><span class="sxs-lookup"><span data-stu-id="4f042-201">The following table describes Log Reader Agent behavior for the various operating modes of database mirroring.</span></span>  
  
|<span data-ttu-id="4f042-202">動作モード</span><span class="sxs-lookup"><span data-stu-id="4f042-202">Operating mode</span></span>|<span data-ttu-id="4f042-203">ミラーが使用できない場合のログ リーダー エージェントの動作</span><span class="sxs-lookup"><span data-stu-id="4f042-203">Log Reader Agent behavior if the mirror is unavailable</span></span>|  
|--------------------|------------------------------------------------------------|  
|<span data-ttu-id="4f042-204">自動フェールオーバーを伴う高い安全性モード</span><span class="sxs-lookup"><span data-stu-id="4f042-204">High-safety mode with automatic failover</span></span>|<span data-ttu-id="4f042-205">ミラーが使用できない場合、ログ リーダー エージェントはコマンドをディストリビューション データベースに反映します。</span><span class="sxs-lookup"><span data-stu-id="4f042-205">If the mirror is unavailable, the Log Reader Agent propagates commands to the distribution database.</span></span> <span data-ttu-id="4f042-206">ミラーがオンラインに戻り、プリンシパルからすべてのトランザクションを受け取るまで、プリンシパルからミラーへのフェールオーバーは発生しません。</span><span class="sxs-lookup"><span data-stu-id="4f042-206">The principal cannot failover to the mirror until the mirror is back online and has all transactions from the principal.</span></span>|  
|<span data-ttu-id="4f042-207">高パフォーマンス モード</span><span class="sxs-lookup"><span data-stu-id="4f042-207">High-performance mode</span></span>|<span data-ttu-id="4f042-208">ミラーが使用できない場合、プリンシパル データベースは無防備な (つまり、ミラー化されていない) 状態で稼働していることになります。</span><span class="sxs-lookup"><span data-stu-id="4f042-208">If the mirror is unavailable, the principal database is running exposed (that is, unmirrored).</span></span> <span data-ttu-id="4f042-209">ただし、ログ リーダー エージェントはミラーで保存されたトランザクションのみをレプリケートします。</span><span class="sxs-lookup"><span data-stu-id="4f042-209">However, the Log Reader Agent only replicates those transactions that are hardened on the mirror.</span></span> <span data-ttu-id="4f042-210">サービスが強制され、ミラー サーバーがプリンシパルとしての役割を回復すると、ログ リーダー エージェントがミラーに対して機能し、新しいトランザクションの取得を開始します。</span><span class="sxs-lookup"><span data-stu-id="4f042-210">If service is forced and the mirror server assumes the role of the principal, the Log Reader Agent will work against the mirror and start picking up the new transactions.</span></span><br /><br /> <span data-ttu-id="4f042-211">ミラーがプリンシパルより遅れた場合、レプリケーションの待機時間が増大することに注意してください。</span><span class="sxs-lookup"><span data-stu-id="4f042-211">Be aware that replication latency will increase if the mirror falls behind the principal.</span></span>|  
|<span data-ttu-id="4f042-212">自動フェールオーバーを伴わない高い安全性モード</span><span class="sxs-lookup"><span data-stu-id="4f042-212">High-safety mode without automatic failover</span></span>|<span data-ttu-id="4f042-213">コミット済みのすべてのトランザクションがミラーのディスクに保存されることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="4f042-213">All committed transactions are guaranteed to be hardened to disk on the mirror.</span></span> <span data-ttu-id="4f042-214">ログ リーダー エージェントはミラーで保存されたトランザクションのみをレプリケートします。</span><span class="sxs-lookup"><span data-stu-id="4f042-214">The Log Reader Agent replicates only those transactions that are hardened on the mirror.</span></span> <span data-ttu-id="4f042-215">ミラーが使用できない場合、プリンシパルのデータベースが停止します。そのため、ログ リーダー エージェントがレプリケートするトランザクションがなくなります。</span><span class="sxs-lookup"><span data-stu-id="4f042-215">If the mirror is unavailable, the principal disallows further activity in the database; therefore the Log Reader Agent has no transactions to replicate.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="4f042-216">参照</span><span class="sxs-lookup"><span data-stu-id="4f042-216">See Also</span></span>  
 <span data-ttu-id="4f042-217">[SQL Server のレプリケーション](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="4f042-217">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 [<span data-ttu-id="4f042-218">ログ配布とレプリケーション &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="4f042-218">Log Shipping and Replication &#40;SQL Server&#41;</span></span>](../log-shipping/log-shipping-and-replication-sql-server.md)  
  
  
