---
title: 役割の交代中にサービスの中断を見積もる (データベースミラーリング) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87632661"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="81958-102">役割の交代中に発生するサービスの中断時間の算出 (データベース ミラーリング)</span><span class="sxs-lookup"><span data-stu-id="81958-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="81958-103">役割の交代中、データベース ミラーリングを使用できない時間の長さは、役割の交代の形式、および原因によって異なります。</span><span class="sxs-lookup"><span data-stu-id="81958-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="81958-104">自動フェールオーバーの場合、サービスが中断される時間には 2 つの要因が影響します。ミラー サーバーがプリンシパル サーバー インスタンスに障害が発生したことを認識するのに必要な時間 (エラー検出)、およびデータベースのフェールオーバーに必要な時間 (フェールオーバー時間) です。</span><span class="sxs-lookup"><span data-stu-id="81958-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="81958-105">強制的なサービスの操作の場合、障害が発生しても、障害を検出し対応するのは人間の応答時間に依存します。</span><span class="sxs-lookup"><span data-stu-id="81958-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="81958-106">しかし、ミラー サーバーが強制的なサービス コマンドを発行した後で役割を交代する時間を算出するだけで、サービスが中断した場合の時間を算出することができます。</span><span class="sxs-lookup"><span data-stu-id="81958-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="81958-107">エラーの種類などの特定の条件を検出するのに必要な時間を減らすには、条件の警告を定義できます。</span><span class="sxs-lookup"><span data-stu-id="81958-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="81958-108">手動フェールオーバーでは、フェールオーバー コマンドの発行以降にデータベースをフェールオーバーするために必要な時間だけになります。</span><span class="sxs-lookup"><span data-stu-id="81958-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="81958-109">エラー検出</span><span class="sxs-lookup"><span data-stu-id="81958-109">Error detection</span></span>
 <span data-ttu-id="81958-110">システムにエラーが通知されるまでの時間は、エラーの種類によって異なります。たとえば、ネットワーク エラーはほぼ即座に通知されますが、サーバーが応答しない場合では (既定のタイムアウトで) 10 秒かかります。</span><span class="sxs-lookup"><span data-stu-id="81958-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="81958-111">データベース ミラーリング セッション中に障害が発生する原因と考えられるエラー、および自動フェールオーバーを伴う高い安全性モードでのタイムアウト検出の詳細については、「 [データベース ミラーリング中に発生する可能性のあるエラー](possible-failures-during-database-mirroring.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="81958-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="81958-112">フェールオーバー時間</span><span class="sxs-lookup"><span data-stu-id="81958-112">Failover time</span></span>
 <span data-ttu-id="81958-113">フェールオーバー時間の内訳は、以前のミラー サーバーが再実行キューに残っているすべてのログをロールフォワードするために必要な時間を主とし、これにわずかな時間を加えたものです (ミラー サーバーでログ レコードが処理される方法の詳細については、「[データベース ミラーリング &#40;SQL Server&#41;](database-mirroring-sql-server.md)」を参照してください)。</span><span class="sxs-lookup"><span data-stu-id="81958-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="81958-114">フェールオーバー時間の測定方法の詳細については、このトピックの「フェールオーバーの再実行速度の測定」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="81958-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="81958-115">インデックスまたはテーブルを作成し、変更するトランザクション中にフェールオーバーが発生した場合、フェールオーバーには通常より長い時間がかかる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="81958-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="81958-116">たとえば、BEGIN TRANSACTION、テーブルに対する CREATE INDEX、SELECT INTO という一連の操作では、フェールオーバーの時間が増加する場合があります。</span><span class="sxs-lookup"><span data-stu-id="81958-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="81958-117">このようなトランザクションでは、COMMIT TRANSACTION ステートメントまたは ROLLBACK TRANSACTION ステートメントを使用してトランザクションを完了するまで、フェールオーバーの時間が増加する可能性は残ります。</span><span class="sxs-lookup"><span data-stu-id="81958-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="81958-118">再実行キュー</span><span class="sxs-lookup"><span data-stu-id="81958-118">The Redo Queue</span></span>
 <span data-ttu-id="81958-119">データベースのロールフォワードでは、現在ミラー サーバー上の再実行キューにあるすべてのログ レコードが適用されます。</span><span class="sxs-lookup"><span data-stu-id="81958-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="81958-120">*再実行キュー* は、ミラー サーバー上のディスクに再実行用として書き込まれていて、ミラー データベースへはロールフォワードされていないログ レコードで構成されています。</span><span class="sxs-lookup"><span data-stu-id="81958-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="81958-121">データベースのフェールオーバー時間は、再実行キュー内のログがミラー サーバーからロールフォワードされる速度によって決まります。つまり、主にシステムのハードウェアと現在のワークロードによって決まります。</span><span class="sxs-lookup"><span data-stu-id="81958-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="81958-122">場合によっては、プリンシパル データベースがビジーになり、ミラー サーバーからログがロールフォワードされる速度よりも、プリンシパル サーバーからミラー サーバーにログが送信される速度の方が大幅に速くなることがあります。</span><span class="sxs-lookup"><span data-stu-id="81958-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="81958-123">この状況では、ミラー サーバーが再実行キューのログをロールフォワードする間、フェールオーバーに相当な時間がかかる場合があります。</span><span class="sxs-lookup"><span data-stu-id="81958-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="81958-124">再実行キューの現在のサイズを調べるには、データベース ミラーリング パフォーマンス オブジェクトの **Redo Queue** カウンターを使用します。</span><span class="sxs-lookup"><span data-stu-id="81958-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="81958-125">詳しくは、「 [SQL Server:Database Mirroring オブジェクト](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="81958-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="81958-126">フェールオーバーの再実行速度の測定</span><span class="sxs-lookup"><span data-stu-id="81958-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="81958-127">実稼働データベースのテスト コピーを使用して、ログ レコードのロールフォワードに必要な時間 ("*再実行速度*") を測定できます。</span><span class="sxs-lookup"><span data-stu-id="81958-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="81958-128">フェールオーバー時のロールフォワード時間を測定する方法は、再実行フェーズ中にミラー サーバーによって使用されるスレッドの数によって異なります。</span><span class="sxs-lookup"><span data-stu-id="81958-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="81958-129">スレッドの数は以下の条件によって異なります。</span><span class="sxs-lookup"><span data-stu-id="81958-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="81958-130">[!INCLUDE[ssStandard](../../includes/ssstandard-md.md)]の場合、データベースのロールフォワードにミラー サーバーが使用するスレッドは常に 1 つです。</span><span class="sxs-lookup"><span data-stu-id="81958-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="81958-131">[!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)]では、5 基未満の CPU が搭載されたコンピューター上のミラー サーバーでも、1 つのスレッドのみが使用されます。</span><span class="sxs-lookup"><span data-stu-id="81958-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="81958-132">5 基以上の CPU が搭載されている場合、ミラー サーバーでは、フェールオーバー時にロールフォワード操作が複数スレッドに分散されます (これは、 *並列再実行*と呼ばれています)。</span><span class="sxs-lookup"><span data-stu-id="81958-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="81958-133">並列再実行は、4 基の CPU ごとに 1 つのスレッドを使用するように最適化されています。</span><span class="sxs-lookup"><span data-stu-id="81958-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="81958-134">シングルスレッドでの再実行速度の測定</span><span class="sxs-lookup"><span data-stu-id="81958-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="81958-135">シングルスレッドでの再実行では、フェールオーバー時にミラー データベースをロールフォワードすると、ログ バックアップの復元で同量のログをロールフォワードするのと同程度の時間がかかります。</span><span class="sxs-lookup"><span data-stu-id="81958-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="81958-136">フェールオーバー時間を測定するには、ミラーリングを実行しようとしている環境にテスト データベースを作成します。</span><span class="sxs-lookup"><span data-stu-id="81958-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="81958-137">次に、実稼働データベースからログ バックアップを取得します。</span><span class="sxs-lookup"><span data-stu-id="81958-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="81958-138">そのログのバックアップの再実行速度を測定するには、ログ バックアップを WITH NORECOVERY でテスト データベースに復元するのにかかる時間を測定します。</span><span class="sxs-lookup"><span data-stu-id="81958-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="81958-139">ミラー サーバーの再実行速度がわかったら、特定の時点にデータベースをフェールオーバーするのにかかる時間を測定できます。この値は、( **Redo Queue** パフォーマンス カウンターで測定した) ミラー上で再実行される現在のログのサイズを、再実行速度で割ることによって取得できます。</span><span class="sxs-lookup"><span data-stu-id="81958-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="81958-140">通常の状況下では、プリンシパルからの読み込みに対してミラー サーバーが遅延していない場合、 **Redo Queue** は小さい値であるかゼロに近く、フェールオーバーには数秒しかかかりません。</span><span class="sxs-lookup"><span data-stu-id="81958-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="81958-141">並列再実行速度の測定</span><span class="sxs-lookup"><span data-stu-id="81958-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="81958-142">[!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)]では、並列再実行は、4 基の CPU ごとに 1 つのスレッドを使用するように最適化されています。</span><span class="sxs-lookup"><span data-stu-id="81958-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="81958-143">並列再実行のロールフォワード時間を測定するには、テスト データベースにアクセスするよりも、稼働中のテスト システムにアクセスした方がより正確な値を得られます。</span><span class="sxs-lookup"><span data-stu-id="81958-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="81958-144">ミラー サーバー上の再実行キューを監視している間は、プリンシパル サーバー上の負荷を増やします。</span><span class="sxs-lookup"><span data-stu-id="81958-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="81958-145">通常の運用では、再実行キューはゼロに近くなります。</span><span class="sxs-lookup"><span data-stu-id="81958-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="81958-146">Redo Queue が継続的に増加し始めるまでは、プリンシパル サーバー上の負荷を増やします。そうすると、システムが最大の再実行速度になり、この時点で **Redo Bytes/sec** パフォーマンス カウンターは、最大の再実行速度を示します。</span><span class="sxs-lookup"><span data-stu-id="81958-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="81958-147">詳しくは、「 [SQL Server:Database Mirroring オブジェクト](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="81958-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="81958-148">自動フェールオーバー中に発生するサービスの中断時間の算出</span><span class="sxs-lookup"><span data-stu-id="81958-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="81958-149">下の図は、 **Partner_B**で自動フェールオーバーが完了するのに必要な時間に、エラー検出とフェールオーバー時間がどのように影響しているのかを示します。</span><span class="sxs-lookup"><span data-stu-id="81958-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="81958-150">フェールオーバーには、データベースをロールフォワードする (再実行フェーズ) ための時間に加え、データベースをオンラインにするための短い時間が必要です。</span><span class="sxs-lookup"><span data-stu-id="81958-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="81958-151">コミットされていないトランザクションのロールバックを実行する元に戻すフェーズは、新しいプリンシパル データベースがオンラインになった後に発生し、フェールオーバー後に続行します。</span><span class="sxs-lookup"><span data-stu-id="81958-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="81958-152">元に戻すフェーズの間、データベースは使用できます。</span><span class="sxs-lookup"><span data-stu-id="81958-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="81958-153">![エラー検出とフェールオーバー時間](../media/dbm-failovauto-time.gif "エラー検出とフェールオーバー時間")</span><span class="sxs-lookup"><span data-stu-id="81958-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="81958-154">参照</span><span class="sxs-lookup"><span data-stu-id="81958-154">See Also</span></span>
 <span data-ttu-id="81958-155">データベースミラーリングの[動作モード](database-mirroring-operating-modes.md)データベース[ミラーリングセッション中の役割の切り替え &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [データベースミラーリングの監視 &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="81958-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>


