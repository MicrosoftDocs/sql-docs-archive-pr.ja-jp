---
title: 可用性グループの自動フェールオーバーのための柔軟なフェールオーバーポリシー (SQL Server) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], flexible failover policy
- Availability Groups [SQL Server], failover
- flexible failover policy
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 8c504c7f-5c1d-4124-b697-f735ef0084f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: cd4dd62d8b30e2041415e0b9be5682ce4b01d1f6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87640237"
---
# <a name="flexible-failover-policy-for-automatic-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="faad9-102">可用性グループの自動フェールオーバーのための柔軟なフェールオーバー ポリシー (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="faad9-102">Flexible Failover Policy for Automatic Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="faad9-103">柔軟なフェールオーバーポリシーを使用すると、可用性グループの[自動フェールオーバー](failover-and-failover-modes-always-on-availability-groups.md)を発生させる条件をきめ細かく制御できます。</span><span class="sxs-lookup"><span data-stu-id="faad9-103">A flexible failover policy provides granular control over the conditions that cause [automatic failover](failover-and-failover-modes-always-on-availability-groups.md) for an availability group.</span></span> <span data-ttu-id="faad9-104">自動フェールオーバーを実行するエラー条件および正常性チェックの頻度を変更することで、自動フェールオーバーの確率値を増減して高可用性の SLA をサポートできます。</span><span class="sxs-lookup"><span data-stu-id="faad9-104">By changing the failure conditions that trigger an automatic failover and the frequency of health checks, you can increase or decrease the likelihood of an automatic failover to support your SLA for high availability.</span></span>  
  
 <span data-ttu-id="faad9-105">可用性グループの柔軟なフェールオーバー ポリシーは、そのエラー条件レベルと正常性チェックのタイムアウトしきい値によって定義されます。</span><span class="sxs-lookup"><span data-stu-id="faad9-105">The flexible failover policy of an availability group is defined by its failure-condition level and health-check timeout threshold.</span></span> <span data-ttu-id="faad9-106">可用性グループがエラー条件レベルまたはその正常性チェックのタイムアウトしきい値を超えていることを検出すると、可用性グループのリソース DLL が Windows Server フェールオーバー クラスタリング (WSFC) クラスターに応答を送り返します。</span><span class="sxs-lookup"><span data-stu-id="faad9-106">On detecting that an availability group has exceeded its failure condition level or its health-check timeout threshold, the availability group's resource DLL responds back to the Windows Server Failover Clustering (WSFC) cluster.</span></span> <span data-ttu-id="faad9-107">その後、WSFC クラスターは、セカンダリ レプリカに対する自動フェールオーバーを開始します。</span><span class="sxs-lookup"><span data-stu-id="faad9-107">The WSFC cluster then initiates an automatic failover to the secondary replica.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="faad9-108">WSFC クラスターでは、可用性グループが WSFC のエラーしきい値を超えると、自動フェールオーバーはその可用性グループに対して実行されません。</span><span class="sxs-lookup"><span data-stu-id="faad9-108">If an availability group exceeds its WSFC failure threshold, the WSFC cluster will not attempt an automatic failover for the availability group.</span></span> <span data-ttu-id="faad9-109">また、クラスター管理者が失敗したリソース グループを手動でオンラインにするか、データベース管理者が可用性グループの手動フェールオーバーを実行するまで、可用性グループの WSFC リソース グループはエラー状態のままになります。</span><span class="sxs-lookup"><span data-stu-id="faad9-109">Furthermore, the WSFC resource group of the availability group remains in a failed state until either the cluster administrator manually brings the failed resource group online or the database administrator performs a manual failover of the availability group.</span></span> <span data-ttu-id="faad9-110">*WSFC のエラーしきい値* は、特定の期間に可用性グループに対して許容されるエラーの最大数として定義されています。</span><span class="sxs-lookup"><span data-stu-id="faad9-110">The *WSFC failure threshold* is defined as the maximum number of failures supported for the availability group during a given time period.</span></span> <span data-ttu-id="faad9-111">既定の期間は 6 時間であり、この期間のエラーの最大数の既定値は *n*-1 です ( *n* は WSFC ノードの数です)。</span><span class="sxs-lookup"><span data-stu-id="faad9-111">The default time period is six hours, and the default value for the maximum number of failures during this period is *n*-1, where *n* is the number of WSFC nodes.</span></span> <span data-ttu-id="faad9-112">特定の可用性グループのエラーしきい値を変更するには、WSFC フェールオーバー マネージャー コンソールを使用します。</span><span class="sxs-lookup"><span data-stu-id="faad9-112">To change the failure-threshold values for a given availability group, use the WSFC Failover Manager Console.</span></span>  
  
  
  
##  <a name="health-check-timeout-threshold"></a><a name="HCtimeout"></a> <span data-ttu-id="faad9-113">正常性チェックのタイムアウトしきい値</span><span class="sxs-lookup"><span data-stu-id="faad9-113">Health-Check Timeout Threshold</span></span>  
 <span data-ttu-id="faad9-114">可用性グループの WSFC リソース DLL では、プライマリ レプリカをホストする SQL Server のインスタンスで *sp_server_diagnostics* ストアド プロシージャを呼び出して、プライマリ レプリカの [正常性チェック](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) を実行します。</span><span class="sxs-lookup"><span data-stu-id="faad9-114">WSFC resource DLL of the availability group performs a *health check* of the primary replica by calling the [sp_server_diagnostics](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) stored procedure on the instance of SQL Server that hosts the primary replica.</span></span> <span data-ttu-id="faad9-115">**sp_server_diagnostics** は、可用性グループの正常性チェックのタイムアウトしきい値の 3 分の 1 の間隔で結果を返します。</span><span class="sxs-lookup"><span data-stu-id="faad9-115">**sp_server_diagnostics** returns results at an interval that equals 1/3 of the health-check timeout threshold for the availability group.</span></span> <span data-ttu-id="faad9-116">既定の正常性チェックのタイムアウトしきい値は 30 秒であるので、 **sp_server_diagnostics** では 10 秒間隔で結果が返されます。</span><span class="sxs-lookup"><span data-stu-id="faad9-116">The default health-check timeout threshold is 30 seconds, which causes **sp_server_diagnostics** to return at a 10-second interval.</span></span> <span data-ttu-id="faad9-117">**sp_server_diagnostics** が低速であるか、情報を返さない場合、リソース DLL は正常性チェックのタイムアウトしきい値の間隔が完全に経過するのを待ってから、プライマリ レプリカが無応答であると判断します。</span><span class="sxs-lookup"><span data-stu-id="faad9-117">If **sp_server_diagnostics** is slow or is not returning information, the resource DLL will wait for the full interval of the health-check timeout threshold before determining that the primary replica is unresponsive.</span></span> <span data-ttu-id="faad9-118">プライマリ レプリカが応答しない場合、自動フェールオーバー (現在サポートされている場合) が開始されます。</span><span class="sxs-lookup"><span data-stu-id="faad9-118">If the primary replica is unresponsive, an automatic failover is initiated, if currently supported.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="faad9-119">**sp_server_diagnostics** では、データベース レベルでの正常性チェックは実行されません。</span><span class="sxs-lookup"><span data-stu-id="faad9-119">**sp_server_diagnostics** does not perform health checks at the database level.</span></span>  
  
##  <a name="failure-condition-level"></a><a name="FClevel"></a> <span data-ttu-id="faad9-120">エラー条件レベル</span><span class="sxs-lookup"><span data-stu-id="faad9-120">Failure-Condition Level</span></span>  
 <span data-ttu-id="faad9-121">**sp_server_diagnostics** から返される診断データと正常性の情報によって自動フェールオーバーが保証されるかどうかは、可用性グループのエラー条件レベルによって異なります。</span><span class="sxs-lookup"><span data-stu-id="faad9-121">Whether the diagnostic data and health information returned by **sp_server_diagnostics** warrants an automatic failover depends on the failure-condition level of the availability group.</span></span> <span data-ttu-id="faad9-122">*エラー条件レベル* は、自動フェールオーバーを実行するエラー条件を指定します。</span><span class="sxs-lookup"><span data-stu-id="faad9-122">The *failure-condition level* specifies what failure conditions trigger an automatic failover.</span></span> <span data-ttu-id="faad9-123">エラー条件レベルの範囲は、最も制限が緩いものから (レベル 1)、最も制限の厳しい指定 (レベル 5) まで 5 つあります。</span><span class="sxs-lookup"><span data-stu-id="faad9-123">There are five failure-condition levels, which range from the least restrictive (level one) to the most restrictive (level five).</span></span> <span data-ttu-id="faad9-124">任意のレベルは、それより制限が緩いすべてのレベルを含みます。</span><span class="sxs-lookup"><span data-stu-id="faad9-124">A given level encompasses the less restrictive levels.</span></span> <span data-ttu-id="faad9-125">したがって、最も制限の厳しいレベル 5 にはそれより制限が緩い 4 つの条件が含まれます。以下同様です。</span><span class="sxs-lookup"><span data-stu-id="faad9-125">Thus, the strictest level, five, includes the four less restrictive conditions, and so forth.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="faad9-126">破損したデータベースおよび問題があると考えられるデータベースは、すべてのエラー条件レベルで検出されません。</span><span class="sxs-lookup"><span data-stu-id="faad9-126">Damaged databases and suspect databases are not detected by any failure-condition level.</span></span> <span data-ttu-id="faad9-127">そのため、破損したデータベースや問題があると考えられるデータベースによって、(その原因がハードウェア障害、データ破損、またはその他の問題であるかにかかわらず) 自動フェールオーバーがトリガーされることはありません。</span><span class="sxs-lookup"><span data-stu-id="faad9-127">Therefore, a database that is damaged or suspect (whether due to a hardware failure, data corruption, or other issue) never triggers an automatic failover.</span></span>  
  
 <span data-ttu-id="faad9-128">次の表では、各レベルに対応するエラー条件について説明します。</span><span class="sxs-lookup"><span data-stu-id="faad9-128">The following table describes the failure-conditions that corresponds to each level.</span></span>  
  
|<span data-ttu-id="faad9-129">Level</span><span class="sxs-lookup"><span data-stu-id="faad9-129">Level</span></span>|<span data-ttu-id="faad9-130">エラー状態</span><span class="sxs-lookup"><span data-stu-id="faad9-130">Failure Condition</span></span>|[!INCLUDE[tsql](../../../includes/tsql-md.md)] <span data-ttu-id="faad9-131">値</span><span class="sxs-lookup"><span data-stu-id="faad9-131">Value</span></span>|<span data-ttu-id="faad9-132">PowerShell 値</span><span class="sxs-lookup"><span data-stu-id="faad9-132">PowerShell Value</span></span>|  
|-----------|-----------------------|------------------------------|----------------------|  
|<span data-ttu-id="faad9-133">1 つ</span><span class="sxs-lookup"><span data-stu-id="faad9-133">One</span></span>|<span data-ttu-id="faad9-134">サーバーの停止。</span><span class="sxs-lookup"><span data-stu-id="faad9-134">On server down.</span></span> <span data-ttu-id="faad9-135">これは最も制限の緩いレベルです。</span><span class="sxs-lookup"><span data-stu-id="faad9-135">This is the least restrictive level.</span></span> <span data-ttu-id="faad9-136">次のいずれかが発生した場合に自動フェールオーバーを開始することを指定します。</span><span class="sxs-lookup"><span data-stu-id="faad9-136">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="faad9-137">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] サービスがダウンした。</span><span class="sxs-lookup"><span data-stu-id="faad9-137">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service is down.</span></span><br /><br /> <span data-ttu-id="faad9-138">WSFC クラスターに接続するための可用性グループのリースが、サーバー インスタンスから ACK を受信しないために期限切れになった。</span><span class="sxs-lookup"><span data-stu-id="faad9-138">The lease of the availability group for connecting to the WSFC cluster expires because no ACK is received from the server instance.</span></span> <span data-ttu-id="faad9-139">詳細については、「 [動作方法: SQL Server AlwaysOn のリース タイムアウト](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="faad9-139">For more information, see [How It Works: SQL Server AlwaysOn Lease Timeout](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx).</span></span>|<span data-ttu-id="faad9-140">1</span><span class="sxs-lookup"><span data-stu-id="faad9-140">1</span></span>|`OnServerDown`|  
|<span data-ttu-id="faad9-141">2 つ</span><span class="sxs-lookup"><span data-stu-id="faad9-141">Two</span></span>|<span data-ttu-id="faad9-142">サーバーの応答停止。</span><span class="sxs-lookup"><span data-stu-id="faad9-142">On server unresponsive.</span></span> <span data-ttu-id="faad9-143">次のいずれかが発生した場合に自動フェールオーバーを開始することを指定します。</span><span class="sxs-lookup"><span data-stu-id="faad9-143">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="faad9-144">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] のインスタンスがクラスターに接続していず、可用性グループのユーザー指定の正常性チェック タイムアウトしきい値を超えた。</span><span class="sxs-lookup"><span data-stu-id="faad9-144">The instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] does not connect to cluster, and the user-specified health check timeout threshold of the availability group is exceeded.</span></span><br /><br /> <span data-ttu-id="faad9-145">可用性レプリカがエラー状態である。</span><span class="sxs-lookup"><span data-stu-id="faad9-145">The availability replica is in failed state.</span></span>|<span data-ttu-id="faad9-146">2</span><span class="sxs-lookup"><span data-stu-id="faad9-146">2</span></span>|`OnServerUnresponsive`|  
|<span data-ttu-id="faad9-147">3</span><span class="sxs-lookup"><span data-stu-id="faad9-147">Three</span></span>|<span data-ttu-id="faad9-148">重大なサーバー エラー。</span><span class="sxs-lookup"><span data-stu-id="faad9-148">On critical server error.</span></span> <span data-ttu-id="faad9-149">孤立したスピンロック、深刻な書き込みアクセス違反、ダンプが多すぎるなどの深刻な [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 内部エラーが発生した場合に自動フェールオーバーを開始することを指定します。</span><span class="sxs-lookup"><span data-stu-id="faad9-149">Specifies that an automatic failover is initiated on critical [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as orphaned spinlocks, serious write-access violations, or too much dumping.</span></span> <span data-ttu-id="faad9-150">これは既定のレベルです。</span><span class="sxs-lookup"><span data-stu-id="faad9-150">This is the default level.</span></span>|<span data-ttu-id="faad9-151">3</span><span class="sxs-lookup"><span data-stu-id="faad9-151">3</span></span>|`OnCriticalServerError`|  
|<span data-ttu-id="faad9-152">4</span><span class="sxs-lookup"><span data-stu-id="faad9-152">Four</span></span>|<span data-ttu-id="faad9-153">中程度のサーバー エラー。</span><span class="sxs-lookup"><span data-stu-id="faad9-153">On moderate server error.</span></span> <span data-ttu-id="faad9-154">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 内部リソース プールに永続的なメモリ不足の状態があるなど中程度の [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 内部エラーが発生した場合に自動フェールオーバーを開始することを指定します。</span><span class="sxs-lookup"><span data-stu-id="faad9-154">Specifies that an automatic failover is initiated on moderate [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as a persistent out-of-memory condition in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal resource pool.</span></span>|<span data-ttu-id="faad9-155">4</span><span class="sxs-lookup"><span data-stu-id="faad9-155">4</span></span>|`OnModerateServerError`|  
|<span data-ttu-id="faad9-156">5</span><span class="sxs-lookup"><span data-stu-id="faad9-156">Five</span></span>|<span data-ttu-id="faad9-157">任意の限定されたエラー条件。</span><span class="sxs-lookup"><span data-stu-id="faad9-157">On any qualified failure conditions.</span></span> <span data-ttu-id="faad9-158">これは最も制限の厳しいレベルです。</span><span class="sxs-lookup"><span data-stu-id="faad9-158">This is the most restrictive level.</span></span> <span data-ttu-id="faad9-159">以下のような任意の限定されたエラー条件に対して自動フェールオーバーを開始することを指定します。</span><span class="sxs-lookup"><span data-stu-id="faad9-159">Specifies that an automatic failover is initiated on any qualified failure conditions, including:</span></span><br /><br /> <span data-ttu-id="faad9-160">SQL エンジンのワーカー スレッドが枯渇している。</span><span class="sxs-lookup"><span data-stu-id="faad9-160">Exhaustion of SQL Engine worker-threads.</span></span><br /><br /> <span data-ttu-id="faad9-161">解決不可能なデッドロックが検出された。</span><span class="sxs-lookup"><span data-stu-id="faad9-161">Detection of an unsolvable deadlock.</span></span>|<span data-ttu-id="faad9-162">5</span><span class="sxs-lookup"><span data-stu-id="faad9-162">5</span></span>|`OnAnyQualifiedFailureConditions`|  
  
> [!NOTE]  
>  <span data-ttu-id="faad9-163">クライアント要求に対して [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] のインスタンスが応答しないことは、可用性グループには関係ありません。</span><span class="sxs-lookup"><span data-stu-id="faad9-163">Lack of response by an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] to client requests is irrelevant to availability groups.</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="faad9-164">関連タスク</span><span class="sxs-lookup"><span data-stu-id="faad9-164">Related Tasks</span></span>  
 <span data-ttu-id="faad9-165">**自動フェールオーバーを設定するには**</span><span class="sxs-lookup"><span data-stu-id="faad9-165">**To configure automatic failover**</span></span>  
  
-   <span data-ttu-id="faad9-166">[可用性レプリカの可用性モードの変更 &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md) (自動フェールオーバーには同期コミット可用性モードが必要)</span><span class="sxs-lookup"><span data-stu-id="faad9-166">[Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md) (automatic failover requires synchronous-commit availability mode)</span></span>  
  
-   [<span data-ttu-id="faad9-167">可用性レプリカのフェールオーバー モードの変更 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="faad9-167">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
-   [<span data-ttu-id="faad9-168">自動フェールオーバーの条件を制御する柔軟なフェールオーバー ポリシーの構成 (AlwaysOn 可用性グループ)</span><span class="sxs-lookup"><span data-stu-id="faad9-168">Configure the Flexible Failover Policy to Control Conditions for Automatic Failover (AlwaysOn Availability Groups)</span></span>](configure-flexible-automatic-failover-policy.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="faad9-169">関連コンテンツ</span><span class="sxs-lookup"><span data-stu-id="faad9-169">Related Content</span></span>  
  
-   [<span data-ttu-id="faad9-170">動作方法: SQL Server AlwaysOn のリース タイムアウト</span><span class="sxs-lookup"><span data-stu-id="faad9-170">How It Works: SQL Server AlwaysOn Lease Timeout</span></span>](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx)  
  
## <a name="see-also"></a><span data-ttu-id="faad9-171">参照</span><span class="sxs-lookup"><span data-stu-id="faad9-171">See Also</span></span>  
 <span data-ttu-id="faad9-172">[AlwaysOn 可用性グループ &#40;SQL Server の概要&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="faad9-172">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="faad9-173">[可用性モード (AlwaysOn 可用性グループ)](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="faad9-173">[Availability Modes (AlwaysOn Availability Groups)](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="faad9-174">[フェールオーバーとフェールオーバーモード &#40;AlwaysOn 可用性グループ&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="faad9-174">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="faad9-175">[Windows Server フェールオーバー クラスタリング &#40;WSFC&#41; と SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="faad9-175">[Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span></span>  
 <span data-ttu-id="faad9-176">[フェールオーバー クラスター インスタンスのフェールオーバー ポリシー](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span><span class="sxs-lookup"><span data-stu-id="faad9-176">[Failover Policy for Failover Cluster Instances](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span></span>  
 [<span data-ttu-id="faad9-177">sp_server_diagnostics &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="faad9-177">sp_server_diagnostics &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql)  
  
  
