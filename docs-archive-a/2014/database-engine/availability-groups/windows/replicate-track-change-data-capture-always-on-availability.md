---
title: レプリケーション、Change Tracking、変更データキャプチャ、AlwaysOn 可用性グループ (SQL Server) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- change tracking [SQL Server], AlwaysOn Availability Groups
- change data capture [SQL Server], AlwaysOn Availability Groups
- Availability Groups [SQL Server], interoperability
- replication [SQL Server], AlwaysOn Availability Groups
ms.assetid: e17a9ca9-dd96-4f84-a85d-60f590da96ad
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e8ea6257cb906177b9eb224d718eecf54fb94119
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87634052"
---
# <a name="replication-change-tracking-change-data-capture-and-alwayson-availability-groups-sql-server"></a><span data-ttu-id="f6068-102">レプリケーション、変更の追跡、変更データ キャプチャ、および AlwaysOn 可用性グループ (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f6068-102">Replication, Change Tracking, Change Data Capture, and AlwaysOn Availability Groups (SQL Server)</span></span>
  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="f6068-103">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]のレプリケーション、変更データ キャプチャ (CDC)、および変更の追跡 (CT) がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="f6068-103">Replication, change data capture (CDC), and change tracking (CT) are supported on [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] <span data-ttu-id="f6068-104">は、高可用性と追加のデータベース復旧機能を提供します。</span><span class="sxs-lookup"><span data-stu-id="f6068-104">helps provide high availability and additional database recovery capabilities.</span></span>  
  
 
  
##  <a name="overview-of-replication-on-alwayson-availability-groups"></a><a name="Overview"></a><span data-ttu-id="f6068-105">AlwaysOn 可用性グループでのレプリケーションの概要</span><span class="sxs-lookup"><span data-stu-id="f6068-105">Overview of Replication on AlwaysOn Availability Groups</span></span>  
  
###  <a name="publisher-redirection"></a><a name="PublisherRedirect"></a> <span data-ttu-id="f6068-106">パブリッシャー リダイレクト</span><span class="sxs-lookup"><span data-stu-id="f6068-106">Publisher Redirection</span></span>  
 <span data-ttu-id="f6068-107">パブリッシュされたデータベースが [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]に対応している場合、パブリッシング データベースへのエージェント アクセス権を提供するディストリビューターは、redirected_publishers エントリで構成されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-107">When a published database is aware of [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], the distributor that provides agent access to the publishing database is configured with redirected_publishers entries.</span></span> <span data-ttu-id="f6068-108">これらのエントリは、パブリッシャーとパブリッシング データベースへの接続に可用性グループ リスナー名を使用して、最初に構成されていたパブリッシャー/データベース ペアをリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="f6068-108">These entries redirect the originally configured publisher/database pair, making use of an availability group listener name to connect to the publisher and publishing database.</span></span> <span data-ttu-id="f6068-109">可用性グループ リスナー名を介して確立された接続は、フェールオーバーに失敗します。</span><span class="sxs-lookup"><span data-stu-id="f6068-109">Established connections through the availability group listener name will fail on failover.</span></span> <span data-ttu-id="f6068-110">フェールオーバー後にレプリケーション エージェントを再起動すると、接続は自動的に新しいプライマリにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="f6068-110">When the replication agent restarts after failover, the connection will automatically be redirected to the new primary.</span></span>  
  
 <span data-ttu-id="f6068-111">AlwaysOn 可用性グループでセカンダリ データベースをパブリッシャーにすることはできません。</span><span class="sxs-lookup"><span data-stu-id="f6068-111">In an AlwaysOn availability group a secondary database cannot be a publisher.</span></span> <span data-ttu-id="f6068-112">レプリケーションを [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]と組み合わせている場合、再パブリッシュはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="f6068-112">Republishing is not supported when replication is combined with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span>  
  
 <span data-ttu-id="f6068-113">パブリッシュされたデータベースが可用性グループのメンバーであり、パブリッシャーをリダイレクトする場合は、その可用性グループに関連付けられている可用性グループ リスナー名にリダイレクトする必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-113">If a published database is a member of an availability group and the publisher is redirected, it must be redirected to an availability group listener name associated with the availability group.</span></span> <span data-ttu-id="f6068-114">明示的なノードにリダイレクトさせることはできません。</span><span class="sxs-lookup"><span data-stu-id="f6068-114">It may not be redirected to an explicit node.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f6068-115">セカンダリ レプリカにフェールオーバーした後、レプリケーション モニターは [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] のパブリッシング インスタンスの名前を調整できないため、 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]の元のプライマリ インスタンスの名前を引き続き使ってレプリケーション情報が表示されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-115">After failover to a secondary replica, Replication Monitor is unable to adjust the name of the publishing instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and will continue to display replication information under the name of the original primary instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="f6068-116">フェールオーバー後は、トレーサー トークンはレプリケーション モニターを使用して入力できませんが、新しいパブリッシャーで [!INCLUDE[tsql](../../../includes/tsql-md.md)]を使用して入力されたトレース トークンがレプリケーション モニターに表示されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-116">After failover, a tracer token cannot be entered by using the Replication Monitor, however a tracer token entered on the new publisher by using [!INCLUDE[tsql](../../../includes/tsql-md.md)], is visible in Replication Monitor.</span></span>  
  
###  <a name="general-changes-to-replication-agents-to-support-alwayson-availability-groups"></a><a name="Changes"></a><span data-ttu-id="f6068-117">AlwaysOn 可用性グループをサポートするためのレプリケーションエージェントへの一般的な変更</span><span class="sxs-lookup"><span data-stu-id="f6068-117">General Changes to Replication Agents to Support AlwaysOn Availability Groups</span></span>  
 <span data-ttu-id="f6068-118">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]をサポートするために、3 つのレプリケーション エージェントが変更されました。</span><span class="sxs-lookup"><span data-stu-id="f6068-118">Three replication agents were modified to support [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="f6068-119">ログ リーダー、スナップショット、およびマージ エージェントは、リダイレクトされたパブリッシャーについてディストリビューション データベースにクエリを実行し、リダイレクトされたパブリッシャーが宣言されていた場合は、返された可用性グループ リスナー名を使用してデータベース パブリッシャーに接続するように変更されました。</span><span class="sxs-lookup"><span data-stu-id="f6068-119">The Log Reader, Snapshot, and Merge agents were modified to query the distribution database for the redirected publisher and to use the returned availability group listener name, if a redirected publisher was declared, to connect to the database publisher.</span></span>  
  
 <span data-ttu-id="f6068-120">既定では、エージェントがディストリビューターにクエリを実行して、元のパブリッシャーがリダイレクトされたかどうかを判断する場合、リダイレクトされたホストがエージェントに戻る前に、現在のターゲットまたはリダイレクトの適合性が検証されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-120">By default, when the agents query the distributor to determine whether the original publisher has been redirected, the suitability of the current target or redirection will be verified prior to returning the redirected host to the agent.</span></span> <span data-ttu-id="f6068-121">これは推奨される動作です。</span><span class="sxs-lookup"><span data-stu-id="f6068-121">This is recommended behavior.</span></span> <span data-ttu-id="f6068-122">ただし、エージェントの起動が非常に頻繁に行われる場合、検証ストアド プロシージャに関連するオーバーヘッドのコストが高くなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-122">However, if agent start up occurs very frequently the overhead associated with the validation stored procedure may be deemed too costly.</span></span> <span data-ttu-id="f6068-123">新しいコマンド ライン スイッチ *BypassPublisherValidation*が、ログ リーダー、スナップショット、およびマージ エージェントに追加されました。</span><span class="sxs-lookup"><span data-stu-id="f6068-123">A new command line switch, *BypassPublisherValidation*, has been added to the Logreader, Snapshot, and Merge agents.</span></span> <span data-ttu-id="f6068-124">スイッチが使用される場合、リダイレクトされたパブリッシャーはエージェントに即時に戻り、検証ストアド プロシージャの実行が省略されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-124">When the switch is used, the redirected publisher is returned immediately to the agent and execution of the validation stored procedure is bypassed.</span></span>  
  
 <span data-ttu-id="f6068-125">検証ストアド プロシージャから返されるエラーは、エージェントの履歴ログに記録されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-125">Failures returned from the validation stored procedure are logged in the agent history logs.</span></span> <span data-ttu-id="f6068-126">重大度が 16 以上のエラーが発生すると、エージェントが終了します。</span><span class="sxs-lookup"><span data-stu-id="f6068-126">Those errors with severity greater than or equal to 16 will cause the agents to terminate.</span></span> <span data-ttu-id="f6068-127">新しいプライマリにフェールオーバーするときに、パブリッシュされたデータベースからの予期される切断を処理するために、いくつかの再試行機能がエージェントに組み込まれています。</span><span class="sxs-lookup"><span data-stu-id="f6068-127">Some retry capabilities have been built in to the agents to handle the expected disconnect from a published database when it fails over to a new primary.</span></span>  
  
#### <a name="log-reader-agent-modifications"></a><span data-ttu-id="f6068-128">ログ リーダー エージェントの変更</span><span class="sxs-lookup"><span data-stu-id="f6068-128">Log Reader Agent Modifications</span></span>  
 <span data-ttu-id="f6068-129">ログ リーダー エージェントでは次の点が変更されています。</span><span class="sxs-lookup"><span data-stu-id="f6068-129">The Logreader Agent has the following changes.</span></span>  
  
-   <span data-ttu-id="f6068-130">**レプリケートされたデータベースの一貫性**</span><span class="sxs-lookup"><span data-stu-id="f6068-130">**Replicated Database Consistency**</span></span>  
  
     <span data-ttu-id="f6068-131">パブリッシュされたデータベースが AlwaysOn 可用性グループのメンバーである場合、既定では、ログ リーダーはすべての可用性グループ セカンダリ レプリカでまだ書き込まれていないログ レコードを処理しません。</span><span class="sxs-lookup"><span data-stu-id="f6068-131">When a published database is a member of an AlwaysOn availability group, by default the log reader will not process log records that have not already been hardened at all availability group secondary replicas.</span></span> <span data-ttu-id="f6068-132">こうすることで、フェールオーバー時にサブスクライバーにレプリケートされるすべての行が、新しいプライマリにも存在することが保証されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-132">This insures that on failover, all rows replicated to a subscriber also are present at the new primary.</span></span>  
  
     <span data-ttu-id="f6068-133">パブリッシャーに AlwaysOn 可用性レプリカが 2 つ (プライマリが 1 つとセカンダリが 1 つ) しかない場合にフェールオーバーが発生すると、すべてのセカンダリ データベースがオンラインに戻るか、エラーが発生したセカンダリ レプリカが可用性グループから削除されるまでログ リーダーが前へ進まないため、元のプライマリ レプリカはダウンしたままになります。</span><span class="sxs-lookup"><span data-stu-id="f6068-133">When the publisher has only two AlwaysOn availability replicas (one primary and one secondary) and a failover happens, the original primary replica remains down because the logreader does not move forward until all secondary databases are brought back online or until the failing secondary replicas are removed from the availability group.</span></span> <span data-ttu-id="f6068-134">AlwaysOn がセカンダリ データベースに変更を書き込むことができないので、セカンダリ データベースに対して実行されているログ リーダーは前へ進みません。</span><span class="sxs-lookup"><span data-stu-id="f6068-134">The logreader, now running against the secondary database, will not proceed forward since AlwaysOn cannot harden any changes to any secondary database.</span></span> <span data-ttu-id="f6068-135">ディザスター リカバリー機能を維持しながら、ログ リーダーが前へ進めるようにするには、ALTER AVAILABITY GROUP <group_name> REMOVE REPLICA を使用して、元のプライマリ レプリカを可用性グループから削除します。</span><span class="sxs-lookup"><span data-stu-id="f6068-135">To allow the logreader to proceed further and still have disaster recovery capacity, remove the original primary replica from the availability group using ALTER AVAILABITY GROUP <group_name> REMOVE REPLICA.</span></span> <span data-ttu-id="f6068-136">その後、新しいセカンダリ レプリカを可用性グループに追加します。</span><span class="sxs-lookup"><span data-stu-id="f6068-136">Then add a new secondary replica to the availability group.</span></span>  
  
-   <span data-ttu-id="f6068-137">**トレース フラグ 1448**</span><span class="sxs-lookup"><span data-stu-id="f6068-137">**Trace flag 1448**</span></span>  
  
     <span data-ttu-id="f6068-138">トレース フラグ 1448 は、非同期セカンダリ レプリカで変更の受信が確認されていない場合でも、レプリケーション ログ リーダーが前へ進めるようにします。</span><span class="sxs-lookup"><span data-stu-id="f6068-138">Trace flag 1448 enables the replication log reader to move forward even if the asynchronous secondary replicas have not acknowledged the reception of a change.</span></span> <span data-ttu-id="f6068-139">このトレース フラグが有効でも、ログ リーダーは常に同期セカンダリ レプリカを待機します。</span><span class="sxs-lookup"><span data-stu-id="f6068-139">Even with this trace flag enabled,, the log reader always waits for the synchronous secondary replicas.</span></span> <span data-ttu-id="f6068-140">ログ リーダーは同期セカンダリ レプリカの最小 ack を超えることはありません。</span><span class="sxs-lookup"><span data-stu-id="f6068-140">The log reader will not go beyond the min ack of the synchronous secondary replicas.</span></span> <span data-ttu-id="f6068-141">このトレース フラグは、可用性グループ、可用性データベース、またはログ リーダー インスタンスだけでなく、 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]のインスタンスにも適用されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-141">This trace flag applies to the instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], not just to an availability group, an availability database, or a log reader instance.</span></span> <span data-ttu-id="f6068-142">再起動しなくても、トレース フラグはすぐに有効になります。</span><span class="sxs-lookup"><span data-stu-id="f6068-142">This trace flag takes effect immediately without a restart.</span></span> <span data-ttu-id="f6068-143">このトレース フラグは、事前にアクティブにすることも、非同期セカンダリ レプリカで障害が発生したときにアクティブにすることもできます。</span><span class="sxs-lookup"><span data-stu-id="f6068-143">It can be activated ahead of time or when an asynchronous secondary replica fails.</span></span>  
  
###  <a name="stored-procedures-supporting-alwayson"></a><a name="StoredProcs"></a><span data-ttu-id="f6068-144">AlwaysOn をサポートするストアドプロシージャ</span><span class="sxs-lookup"><span data-stu-id="f6068-144">Stored Procedures Supporting AlwaysOn</span></span>  
  
-   <span data-ttu-id="f6068-145">**sp_redirect_publisher**</span><span class="sxs-lookup"><span data-stu-id="f6068-145">**sp_redirect_publisher**</span></span>  
  
     <span data-ttu-id="f6068-146">ストアド プロシージャ **sp_redirect_publisher** を使用すると、既存のパブリッシャー/データベース ペアのリダイレクトされたパブリッシャーを指定できます。</span><span class="sxs-lookup"><span data-stu-id="f6068-146">The stored procedure **sp_redirect_publisher** is used to specify a redirected publisher for an existing publisher/database pair.</span></span> <span data-ttu-id="f6068-147">パブリッシャー データベースが可用性グループに属している場合、リダイレクトされたパブリッシャーは可用性グループ リスナー名です。</span><span class="sxs-lookup"><span data-stu-id="f6068-147">If the publisher database belongs to an availability group, the redirected publisher is the availability group listener name.</span></span>  
  
-   <span data-ttu-id="f6068-148">**sp_get_redirected_publisher**</span><span class="sxs-lookup"><span data-stu-id="f6068-148">**sp_get_redirected_publisher**</span></span>  
  
     <span data-ttu-id="f6068-149">ストアド プロシージャ **sp_get_redirected_publisher** は、パブリッシャー/データベース ペアに定義済みのリダイレクトされたパブリッシャーがあるかどうかを判断するために、レプリケーション エージェントがディストリビューターに対してクエリを実行するときに使用されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-149">The stored procedure **sp_get_redirected_publisher** is used by replication agents to query a distributor to determine whether a publisher/database pair has a defined redirected publisher.</span></span> <span data-ttu-id="f6068-150">このストアド プロシージャには、2 つの目的があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-150">This stored procedure serves two purposes.</span></span> <span data-ttu-id="f6068-151">1 つ目は、元のパブリッシャーがリダイレクトされたかどうかをエージェントが判断できるようにすることです。</span><span class="sxs-lookup"><span data-stu-id="f6068-151">First, it allows the agent to determine whether the original publisher has been redirected.</span></span> <span data-ttu-id="f6068-152">2 つ目は、リダイレクトの対象ノードが、指定されたデータベースのパブリッシャーとして適しているかどうかを検証する、ディストリビューターで実行される検証ストアド プロシージャ (**sp_validate_redirected_publisher**) を開始することです。</span><span class="sxs-lookup"><span data-stu-id="f6068-152">Second, it may also initiate a validation stored procedure run at the distributor (**sp_validate_redirected_publisher**) that verifies the suitability of the target node of the redirection to serve as a publisher for the named database.</span></span>  
  
     <span data-ttu-id="f6068-153">このストアド プロシージャを実行するには、呼び出し元はディストリビューション データベースの **sysadmin** サーバー ロールおよび **db_owner** データベース ロールのメンバーであるか、パブリッシャー データベースと関連付けられている定義済みパブリケーションの **パブリケーション アクセス リスト** のメンバーである必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-153">To execute this stored procedure the caller must either be a member of the **sysadmin** server role, the **db_owner** database role for the distribution database, or a member of a **Publication Access List** for a defined publication associated with the publisher database.</span></span>  
  
-   <span data-ttu-id="f6068-154">**sp_validate_redirected_publisher**</span><span class="sxs-lookup"><span data-stu-id="f6068-154">**sp_validate_redirected_publisher**</span></span>  
  
     <span data-ttu-id="f6068-155">このストアド プロシージャは、パブリッシュされたデータベースを現在のパブリッシャーがホストできることを検証しようとします。</span><span class="sxs-lookup"><span data-stu-id="f6068-155">This stored procedure attempts to validate that the current publisher is capable of hosting the published database.</span></span> <span data-ttu-id="f6068-156">パブリッシュされたデータベースの現在のホストがレプリケーションをサポートできることを確認するために、いつでも呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="f6068-156">It can be called at any time to verify that the current host for the published database is capable of supporting replication.</span></span>  
  
-   <span data-ttu-id="f6068-157">**sp_validate_replicate_hosts_as_publishers**</span><span class="sxs-lookup"><span data-stu-id="f6068-157">**sp_validate_replicate_hosts_as_publishers**</span></span>  
  
     <span data-ttu-id="f6068-158">現在のプライマリがパブリッシャー データベースのレプリケーション パブリッシャーとして機能できることを確認できるのはエージェントにとって便利ですが、AlwaysOn 可用性データベースのレプリケーション トポロジ全体の有効性を確立するには、より一般的な検証機能が必要です。</span><span class="sxs-lookup"><span data-stu-id="f6068-158">While it is useful for the agents to insure that the current primary can function as the replication publisher for a publisher database, a more general validation capability is needed to establish the validity of an entire replication topology on an AlwaysOn availability database.</span></span> <span data-ttu-id="f6068-159">ストアド プロシージャ **sp_validate_replica_hosts_as_publishers** は、このニーズを満たすように設計されています。</span><span class="sxs-lookup"><span data-stu-id="f6068-159">The stored procedure **sp_validate_replica_hosts_as_publishers** is designed to fill this need.</span></span>  
  
     <span data-ttu-id="f6068-160">このストアド プロシージャは、常に手動で実行されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-160">This stored procedure is always run manually.</span></span> <span data-ttu-id="f6068-161">呼び出し元は、ディストリビューターでの **sysadmin** であるか、ディストリビューション データベースの **dbowner** であるか、またはパブリッシャー データベースのパブリケーションの **パブリケーション アクセス リスト** のメンバーである必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-161">The caller must either be **sysadmin** at the distributor, **dbowner** of the distribution database, or a member of the **Publication Access List** of a publication of the publisher database.</span></span> <span data-ttu-id="f6068-162">また、呼び出し元のログインは、すべての可用性レプリカ ホストに対して有効なログインであり、パブリッシャー データベースに関連付けられている可用性データベースに対する select 特権を持っている必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-162">In addition, the login of the caller must be a valid login for all of the availability replica hosts, and have select privileges on the availability database associated with the publisher database.</span></span>  
  
###  <a name="change-data-capture"></a><a name="CDC"></a> <span data-ttu-id="f6068-163">変更データ キャプチャ</span><span class="sxs-lookup"><span data-stu-id="f6068-163">Change Data Capture</span></span>  
 <span data-ttu-id="f6068-164">障害が発生してもデータベースを引き続き使用できるだけでなく、データベース テーブルへの変更も引き続き監視され、CDC 変更テーブルに格納されることを保証するために、変更データ キャプチャ (CDC) が有効になっているデータベースで [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] を利用できます。</span><span class="sxs-lookup"><span data-stu-id="f6068-164">Databases enabled for change data capture (CDC) are able to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] in order to insure not only that the database remains available in the event of failure, but that changes to the database tables continue to be monitored and deposited in the CDC change tables.</span></span> <span data-ttu-id="f6068-165">CDC と [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] の構成順序は重要ではありません。</span><span class="sxs-lookup"><span data-stu-id="f6068-165">The order in which CDC and [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] are configured is not important.</span></span> <span data-ttu-id="f6068-166">CDC 対応データベースは [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]に追加でき、AlwaysOn 可用性グループのメンバーであるデータベースでは CDC を有効にできます。</span><span class="sxs-lookup"><span data-stu-id="f6068-166">CDC enabled databases can be added to [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], and databases that are members of an AlwaysOn availability group can be enabled for CDC.</span></span> <span data-ttu-id="f6068-167">ただし、どちらの場合も、CDC 構成は常に現在または目的のプライマリ レプリカで実行されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-167">In both cases, however, CDC configuration is always performed on the current or intended primary replica.</span></span> <span data-ttu-id="f6068-168">CDC はログ リーダー エージェントを使用するため、このトピックの「 **ログ リーダー エージェントの変更** 」に記載されているのと同じ制限事項があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-168">CDC uses the log reader agent and has the same limitations as described in the **Log Reader Agent Modifications** section earlier in this topic.</span></span>  
  
-   <span data-ttu-id="f6068-169">**レプリケーションなしでの変更データ キャプチャの変更の取得**</span><span class="sxs-lookup"><span data-stu-id="f6068-169">**Harvesting Changes for Change Data Capture Without Replication**</span></span>  
  
     <span data-ttu-id="f6068-170">データベースで CDC が有効になっていて、レプリケーションは有効になっていない場合、ログから変更を取得して CDC 変更テーブルに格納するために使用されるキャプチャ プロセスは、CDC ホストで独自の SQL エージェント ジョブとして実行されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-170">If CDC is enabled for a database, but replication is not, the capture process used to harvest changes from the log and deposit them in CDC change tables runs at the CDC host as its own SQL Agent job.</span></span>  
  
     <span data-ttu-id="f6068-171">フェールオーバー後に変更の取得を再開するには、ローカル キャプチャ ジョブを作成するために、新しいプライマリでストアド プロシージャ **sp_cdc_add_job** を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-171">In order to resume the harvesting of changes after failover, the stored procedure **sp_cdc_add_job** must be run at the new primary to create the local capture job.</span></span>  
  
     <span data-ttu-id="f6068-172">次の例では、キャプチャ ジョブを作成します。</span><span class="sxs-lookup"><span data-stu-id="f6068-172">The following example creates the capture job.</span></span>  
  
    ```  
    EXEC sys.sp_cdc_add_job @job_type = 'capture';  
    ```  
  
-   <span data-ttu-id="f6068-173">**レプリケーションを使用した変更データ キャプチャの変更の取得**</span><span class="sxs-lookup"><span data-stu-id="f6068-173">**Harvesting Changes for Change Data Capture With Replication**</span></span>  
  
     <span data-ttu-id="f6068-174">データベースで CDC とレプリケーションの両方が有効になっている場合は、ログ リーダーが CDC 変更テーブルのデータ設定を処理します。</span><span class="sxs-lookup"><span data-stu-id="f6068-174">If both CDC and replication are enabled for a database, the log reader handles the population of the CDC change tables.</span></span> <span data-ttu-id="f6068-175">この場合、 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] を利用するためにレプリケーションで使用される手法によって、フェールオーバー後も引き続き変更がログから取得され、CDC 変更テーブルに格納されることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-175">In this case, the techniques used by replication to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] will insure that changes continue to be harvested from the log and deposited in CDC change tables after failover.</span></span> <span data-ttu-id="f6068-176">変更テーブルにデータが設定されるようにするために、この構成の CDC に対して何も追加で行う必要はありません。</span><span class="sxs-lookup"><span data-stu-id="f6068-176">Nothing additional needs to be done for CDC in this configuration to insure that the change tables are populated.</span></span>  
  
-   <span data-ttu-id="f6068-177">**変更データ キャプチャのクリーンアップ**</span><span class="sxs-lookup"><span data-stu-id="f6068-177">**Change Data Capture Cleanup**</span></span>  
  
     <span data-ttu-id="f6068-178">新しいプライマリ データベースで適切なクリーンアップが確実に行われるように、ローカル クリーアップ ジョブを必ず作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-178">To insure that appropriate cleanup occurs at the new primary database, a local cleanup job should always be created.</span></span> <span data-ttu-id="f6068-179">次の例では、クリーンアップ ジョブを作成します。</span><span class="sxs-lookup"><span data-stu-id="f6068-179">The following example creates the cleanup job.</span></span>  
  
    ```  
    EXEC sys.sp_cdc_add_job @job_type = 'cleanup';  
    ```  
  
    > [!NOTE]  
    >  <span data-ttu-id="f6068-180">フェールオーバーの前にすべてのフェールオーバー ターゲット候補でジョブを作成し、ホストの可用性レプリカが新しいプライマリ レプリカになるまで無効としてマークしておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-180">You should create the jobs at all of the possible failover targets before failover, and mark them as disabled until the availability replica at a host becomes the new primary replica.</span></span> <span data-ttu-id="f6068-181">ローカル データベースがセカンダリ データベースになったときに、古いプライマリ データベースで実行されている CDC ジョブも無効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-181">The CDC jobs running at the old primary database should be also disabled when the local database becomes a secondary database.</span></span> <span data-ttu-id="f6068-182">ジョブを無効または有効にするには、 *@enabled* sp_update_job のオプション[&#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-update-job-transact-sql)を使用します。</span><span class="sxs-lookup"><span data-stu-id="f6068-182">To disable and enable jobs, use the *@enabled* option of [sp_update_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-update-job-transact-sql).</span></span> <span data-ttu-id="f6068-183">CDC ジョブの作成の詳細については、「 [sys.sp_cdc_add_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql)のレプリケーション、変更データ キャプチャ (CDC)、および変更の追跡 (CT) がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="f6068-183">For more information about creating CDC jobs, see [sys.sp_cdc_add_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql).</span></span>  
  
-   <span data-ttu-id="f6068-184">**AlwaysOn プライマリ データベース レプリカへの CDC ロールの追加**</span><span class="sxs-lookup"><span data-stu-id="f6068-184">**Adding CDC Roles to an AlwaysOn Primary Database Replica**</span></span>  
  
     <span data-ttu-id="f6068-185">CDC に対してテーブルを有効にした場合は、データベース ロールをキャプチャ インスタンスに関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="f6068-185">When a table is enabled for CDC, it is possible to associate a database role with the capture instance.</span></span> <span data-ttu-id="f6068-186">ロールが指定されている場合、CDC テーブル値関数を使用してテーブルの変更にアクセスするユーザーは、追跡されるテーブル列への選択アクセス権を持つだけでなく、名前付きロールのメンバーでもある必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-186">If a role is specified, the user wishing to use the CDC table-valued functions to access changes for the table must not only have select access to the tracked table columns, but must also be a member of the named role.</span></span> <span data-ttu-id="f6068-187">指定したロールが存在しない場合は、ロールが作成されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-187">If the specified role does not already exist, the role will be created.</span></span> <span data-ttu-id="f6068-188">AlwaysOn プライマリ データベースにデータベース ロールが自動的に追加されると、ロールは可用性グループのセカンダリ データベースにも反映されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-188">When database roles are automatically added to an AlwaysOn primary database, the roles are also propagated to the secondary databases of the availability group.</span></span>  
  
-   <span data-ttu-id="f6068-189">**CDC 変更データにアクセスするクライアント アプリケーションと Always On**</span><span class="sxs-lookup"><span data-stu-id="f6068-189">**Client Applications Accessing CDC Change Data and Always On**</span></span>  
  
     <span data-ttu-id="f6068-190">変更テーブル データにアクセスするためにテーブル値関数 (TVF) またはリンク サーバーを使用するクライアント アプリケーションには、フェールオーバー後に適切な CDC ホストを検索する機能も必要です。</span><span class="sxs-lookup"><span data-stu-id="f6068-190">Client applications that use the table-valued functions (TVFs) or linked servers to access change table data also need the ability to locate an appropriate CDC host after failover.</span></span> <span data-ttu-id="f6068-191">可用性グループ リスナー名は、接続のターゲットを別のホストに透過的に再指定できるようにするために、 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] によって提供されるメカニズムです。</span><span class="sxs-lookup"><span data-stu-id="f6068-191">The availability group listener name is the mechanism provided by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] to transparently allow a connection to be retargeted to a different host.</span></span> <span data-ttu-id="f6068-192">可用性グループに関連付けられた可用性グループ リスナー名は、TCP 接続文字列で使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="f6068-192">Once an availability group listener name is associated with an availability group, it is available to be used in TCP connection strings.</span></span> <span data-ttu-id="f6068-193">2 つの異なる接続シナリオが、可用性グループ リスナー名を通じてサポートされます。</span><span class="sxs-lookup"><span data-stu-id="f6068-193">Two different connection scenarios are supported through the availability group listener name.</span></span>  
  
    -   <span data-ttu-id="f6068-194">接続要求が常に現在のプライマリ レプリカに送られることを保証する。</span><span class="sxs-lookup"><span data-stu-id="f6068-194">One insures that connection requests are always directed to the current primary replica.</span></span>  
  
    -   <span data-ttu-id="f6068-195">接続要求が読み取り専用セカンダリ レプリカに送られることを保証する。</span><span class="sxs-lookup"><span data-stu-id="f6068-195">One insures that connection requests are directed to a read-only secondary replica.</span></span>  
  
     <span data-ttu-id="f6068-196">読み取り専用セカンダリ レプリカの検索にルーティング リストを使用する場合は、可用性グループの読み取り専用ルーティング リストも定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-196">If used to locate a read-only secondary replica, a read-only routing list must also be defined for the availability group.</span></span> <span data-ttu-id="f6068-197">読み取り可能セカンダリへのルーティングアクセスの詳細については、「 [読み取り専用ルーティングの可用性レプリカを構成するには](../../listeners-client-connectivity-application-failover.md#ConfigureARsForROR)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f6068-197">For more information about routing access to readable secondaries, see [To Configure Availability Replicas for Read-Only Routing](../../listeners-client-connectivity-application-failover.md#ConfigureARsForROR).</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f6068-198">可用性グループ データベース レプリカにアクセスするには、可用性グループ リスナー名の作成およびクライアント アプリケーションによる可用性グループ リスナー名の使用に関連するいくらかの伝達の遅延があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-198">There is some propagation delay associated with the creation of an availability group listener name and its use by client applications to access an availability group database replica.</span></span>  
  
     <span data-ttu-id="f6068-199">次のクエリを使用して、可用性グループ リスナー名が CDC データベースをホストしている可用性グループに対して定義されているかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="f6068-199">Use the following query to determine whether an availability group listener name has been defined for the availability group hosting a CDC database.</span></span> <span data-ttu-id="f6068-200">クエリは、可用性グループ リスナー名が作成されている場合に、それを返します。</span><span class="sxs-lookup"><span data-stu-id="f6068-200">The query will return the availability group listener name if one has been created.</span></span>  
  
    ```  
    SELECT dns_name   
    FROM sys.availability_group_listeners AS l  
    INNER JOIN sys.availability_databases_cluster AS d  
        ON l.group_id = d.group_id  
    WHERE d.database_name = N'MyCDCDB';  
    ```  
  
-   <span data-ttu-id="f6068-201">**読み取り可能なセカンダリ レプリカへのクエリ負荷のリダイレクト**</span><span class="sxs-lookup"><span data-stu-id="f6068-201">**Redirecting the Query Load to a Readable Secondary Replica**</span></span>  
  
     <span data-ttu-id="f6068-202">多くの場合、クライアント アプリケーションは常に現在のプライマリ レプリカに接続しようとしますが、これが [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]を利用する唯一の方法というわけではありません。</span><span class="sxs-lookup"><span data-stu-id="f6068-202">While in many cases a client application will always want to connect to the current primary replica that is not the only way to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="f6068-203">可用性グループが読み取り可能なセカンダリ レプリカをサポートするように構成されている場合、変更データはセカンダリ ノードからも収集できます。</span><span class="sxs-lookup"><span data-stu-id="f6068-203">If an availability group is configured to support readable secondary replicas, change data can also be gathered from secondary nodes.</span></span>  
  
     <span data-ttu-id="f6068-204">可用性グループが構成されている場合は、SECONDARY_ROLE に関連付けられている ALLOW_CONNECTIONS 属性を使用して、サポートされているセカンダリ アクセスの種類を指定します。</span><span class="sxs-lookup"><span data-stu-id="f6068-204">When an availability group is configured, the ALLOW_CONNECTIONS attribute associated with the SECONDARY_ROLE is used to specify the type of secondary access supported.</span></span> <span data-ttu-id="f6068-205">ALL として構成した場合、セカンダリへのすべての接続が許可されますが、成功するのは読み取り専用アクセスを必要とする接続だけです。</span><span class="sxs-lookup"><span data-stu-id="f6068-205">If configured as ALL, all connections to the secondary will be allowed, but only those requiring read only access will succeed.</span></span> <span data-ttu-id="f6068-206">READ_ONLY として構成した場合、接続を成功させるには、セカンダリ データベースへの接続時に読み取り専用の目的を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-206">If configured as READ_ONLY, it is necessary to specify read only intent when making the connection to the secondary database in order for the connection to succeed.</span></span> <span data-ttu-id="f6068-207">詳細については、「 [可用性レプリカでの読み取り専用アクセスの構成 &#40;SQL Server&#41;](configure-read-only-access-on-an-availability-replica-sql-server.md)が存在する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-207">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
     <span data-ttu-id="f6068-208">次のクエリを使用して、読み取り可能なセカンダリ レプリカに接続するために読み取り専用の目的が必要かどうかを確認できます。</span><span class="sxs-lookup"><span data-stu-id="f6068-208">The following query can be used to determine whether read-only intent is needed to connect to a readable secondary replica.</span></span>  
  
    ```  
    SELECT g.name AS AG, replica_server_name, secondary_role_allow_connections_desc  
    FROM sys.availability_replicas AS r  
    JOIN sys.availability_groups AS g  
        ON r.group_id = g.group_id  
    WHERE g.name = N'MY_AG_NAME;  
    ```  
  
     <span data-ttu-id="f6068-209">可用性グループ リスナー名または明示的なノード名を使用してセカンダリ レプリカを検索できます。</span><span class="sxs-lookup"><span data-stu-id="f6068-209">Either the availability group listener name or the explicit node name can be used to locate the secondary replica.</span></span> <span data-ttu-id="f6068-210">可用性グループ リスナー名を使用すると、アクセスは適切なセカンダリ レプリカに送られます。</span><span class="sxs-lookup"><span data-stu-id="f6068-210">If the availability group listener name is used, access will be directed to any suitable secondary replica.</span></span>  
  
     <span data-ttu-id="f6068-211">を `sp_addlinkedserver` 使用してセカンダリにアクセスするリンクサーバーを作成する場合、 *@datasrc* パラメーターは可用性グループリスナー名または明示的なサーバー名に使用され、 *@provstr* パラメーターは読み取り専用の目的を指定するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-211">When `sp_addlinkedserver` is used to create a linked server to access the secondary, the *@datasrc* parameter is used for the availability group listener name or the explicit server name, and the *@provstr* parameter is used to specify read-only intent.</span></span>  
  
    ```  
    EXEC sp_addlinkedserver   
    @server = N'linked_svr',   
    @srvproduct=N'SqlServer',  
    @provider=N'SQLNCLI11',   
    @datasrc=N'AG_Listener_Name',   
    @provstr=N'ApplicationIntent=ReadOnly',   
    @catalog=N'MY_DB_NAME';  
    ```  
  
-   <span data-ttu-id="f6068-212">**CDC 変更データとドメイン ログインへのクライアント アクセス**</span><span class="sxs-lookup"><span data-stu-id="f6068-212">**Client Access to CDC Change Data and Domain Logins**</span></span>  
  
     <span data-ttu-id="f6068-213">一般に、AlwaysOn 可用性グループのメンバーであるデータベースに存在する変更データへのクライアント アクセスには、ドメイン ログインを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-213">In general, you should use domain logins for client access to change data residing in databases that are members of AlwaysOn availability groups.</span></span> <span data-ttu-id="f6068-214">フェールオーバー後に変更データへの継続的なアクセスを保証するには、ドメイン ユーザーに、可用性グループ レプリカをサポートするすべてのホストに対するアクセス権限が必要です。</span><span class="sxs-lookup"><span data-stu-id="f6068-214">To insure continued access to change data after failover, the domain user will need access privileges on all of the hosts supporting availability group replicas.</span></span> <span data-ttu-id="f6068-215">データベース ユーザーがプライマリ レプリカのデータベースに追加され、ユーザーがドメイン ログインに関連付けられている場合、データベース ユーザーはセカンダリ データベースに反映され、引き続き指定されたドメイン ログインに関連付けられます。</span><span class="sxs-lookup"><span data-stu-id="f6068-215">If a database user is added to a database in a primary replica, and the user is associated with a domain login, the database user is propagated to secondary databases and continues to be associated with the specified domain login.</span></span> <span data-ttu-id="f6068-216">新しいデータベース ユーザーが SQL Server 認証ログインに関連付けられている場合、セカンダリ データベースのユーザーはログインなしで反映されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-216">If the new database user is associated with a SQL Server authentication login, the user at the secondary databases will be propagated without a login.</span></span> <span data-ttu-id="f6068-217">関連付けられた [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 認証ログインを使用して、データベース ユーザーが最初に定義されたプライマリの変更データにアクセスできますが、ノードはアクセスが可能な唯一のノードです。</span><span class="sxs-lookup"><span data-stu-id="f6068-217">While the associated [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] authentication login could be used to access change data at the primary where the database user was originally defined, that node is the only one where access would be possible.</span></span> <span data-ttu-id="f6068-218">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 認証ログインは、セカンダリ データベースのデータにアクセスすることも、データベース ユーザーが定義された元のデータベース以外の新しいプライマリ データベースのデータにアクセスすることもできません。</span><span class="sxs-lookup"><span data-stu-id="f6068-218">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] authentication login would not be able to access data from any secondary database, nor from any new primary databases other than the original database where the database user was defined.</span></span>  
  
###  <a name="change-tracking"></a><a name="CT"></a> <span data-ttu-id="f6068-219">変更の追跡</span><span class="sxs-lookup"><span data-stu-id="f6068-219">Change Tracking</span></span>  
 <span data-ttu-id="f6068-220">変更の追跡 (CT) が有効になっているデータベースは、AlwaysOn 可用性グループに含めることができます。</span><span class="sxs-lookup"><span data-stu-id="f6068-220">A database enabled for change tracking (CT) can be part of an AlwaysOn availability group.</span></span> <span data-ttu-id="f6068-221">追加の構成は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="f6068-221">No additional configuration is needed.</span></span> <span data-ttu-id="f6068-222">変更データにアクセスするために CDC テーブル値関数 (TVF) を使用する変更の追跡クライアント アプリケーションには、フェールオーバー後にプライマリ レプリカを検索する機能が必要です。</span><span class="sxs-lookup"><span data-stu-id="f6068-222">Change tracking client applications that use the CDC table-valued functions (TVFs) to access change data will need the ability to locate the primary replica after failover.</span></span> <span data-ttu-id="f6068-223">クライアント アプリケーションが可用性グループ リスナー名を通じて接続する場合、接続要求は常に現在のプライマリ レプリカに適切に送られます。</span><span class="sxs-lookup"><span data-stu-id="f6068-223">If the client application connects through the availability group listener name, connection requests will always be appropriately directed to the current primary replica.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f6068-224">変更の追跡データは、常にプライマリ レプリカから取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-224">Change tracking data must always be obtained from the primary replica.</span></span> <span data-ttu-id="f6068-225">セカンダリ レプリカから変更データにアクセスしようとすると、次のエラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="f6068-225">An attempt to access change data from a secondary replica will result in the following error:</span></span>  
>   
>  <span data-ttu-id="f6068-226">メッセージ 22117、レベル 16、状態 1、行 1</span><span class="sxs-lookup"><span data-stu-id="f6068-226">Msg 22117, Level 16, State 1, Line1</span></span>  
>   
>  <span data-ttu-id="f6068-227">セカンダリ レプリカのメンバーであるデータベース (セカンダリ データベース) では、変更の追跡はサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="f6068-227">For databases that are members of a secondary replica (that is, for secondary databases), change tracking is not supported.</span></span> <span data-ttu-id="f6068-228">変更の追跡クエリをプライマリ レプリカのデータベースに対して実行します。</span><span class="sxs-lookup"><span data-stu-id="f6068-228">Run change tracking queries on the databases in the primary replica.</span></span>  
  
##  <a name="prerequisites-restrictions-and-considerations-for-using-replication"></a><a name="Prereqs"></a> <span data-ttu-id="f6068-229">レプリケーションの使用に関する前提条件、制限、および考慮事項</span><span class="sxs-lookup"><span data-stu-id="f6068-229">Prerequisites, Restrictions, and Considerations for Using Replication</span></span>  
 <span data-ttu-id="f6068-230">ここでは、 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]でレプリケーションを配置する際の前提条件、制限、推奨などの考慮事項について説明します。</span><span class="sxs-lookup"><span data-stu-id="f6068-230">This section describes considerations for deploying replication with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], including prerequisites, restrictions, and recommendations.</span></span>  
  
### <a name="prerequisites"></a><span data-ttu-id="f6068-231">前提条件</span><span class="sxs-lookup"><span data-stu-id="f6068-231">Prerequisites</span></span>  
  
-   <span data-ttu-id="f6068-232">単一の可用性グループ内でトランザクション レプリケーションとパブリッシング データベースを使用する場合は、パブリッシャーとディストリビューターの両方が少なくとも [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)]を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-232">When using transactional replication and the publishing database is in an availability group both the publisher and the distributor must run at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span> <span data-ttu-id="f6068-233">サブスクライバーは、それより低いレベルの [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]を使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="f6068-233">The subscriber can be using a lower level of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="f6068-234">単一の可用性グループ内でマージ レプリケーションとパブリッシング データベースを使用する場合は、次のことが適用されます。</span><span class="sxs-lookup"><span data-stu-id="f6068-234">When using merge replication and the publishing database is in an availability group:</span></span>  
  
    -   <span data-ttu-id="f6068-235">プッシュ サブスクリプション: パブリッシャーとディストリビューターの両方が少なくとも [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-235">Push subscription: Both the publisher and the distributor must run at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span>  
  
    -   <span data-ttu-id="f6068-236">プル サブスクリプション: パブリッシャー、ディストリビューター、およびサブスクライバー データベースは、少なくとも [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] 上にある必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-236">Pull subscription: The publisher, distributor, and subscriber databases must be on at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span> <span data-ttu-id="f6068-237">これは、可用性グループがセカンダリにフェールオーバーする方法を、サブスクライバー上のマージ エージェントが把握しておく必要があることが原因です。</span><span class="sxs-lookup"><span data-stu-id="f6068-237">This is because the merge agent on the subscriber must understand how an availability group can fail over to its secondary.</span></span>  
  
-   <span data-ttu-id="f6068-238">ディストリビューション データベースを可用性グループに配置することはサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="f6068-238">Placing the distribution database on an availability group is not supported.</span></span>  
  
-   <span data-ttu-id="f6068-239">パブリッシャーのインスタンスは、AlwaysOn 可用性グループに参加するために必要なすべての前提条件を満たす必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-239">The Publisher instances satisfy all the prerequisites required to participate in an AlwaysOn availability group.</span></span> <span data-ttu-id="f6068-240">詳細については[、「AlwaysOn 可用性グループ &#40;SQL Server&#41;の前提条件、制限事項、および推奨事項](prereqs-restrictions-recommendations-always-on-availability.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f6068-240">For more information see [Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md).</span></span>  
  
### <a name="restrictions"></a><span data-ttu-id="f6068-241">制限</span><span class="sxs-lookup"><span data-stu-id="f6068-241">Restrictions</span></span>  
 <span data-ttu-id="f6068-242">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]のレプリケーションでサポートされている組み合わせは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="f6068-242">Supported combinations of replication on [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]:</span></span>  
  
|||||  
|-|-|-|-|  
||<span data-ttu-id="f6068-243">**発行元**</span><span class="sxs-lookup"><span data-stu-id="f6068-243">**Publisher**</span></span>|<span data-ttu-id="f6068-244">**ディストリビューター** <sup>3</sup></span><span class="sxs-lookup"><span data-stu-id="f6068-244">**Distributor** <sup>3</sup></span></span>|<span data-ttu-id="f6068-245">**サブスクライバー**</span><span class="sxs-lookup"><span data-stu-id="f6068-245">**Subscriber**</span></span>|  
|<span data-ttu-id="f6068-246">**トランザクション**</span><span class="sxs-lookup"><span data-stu-id="f6068-246">**Transactional**</span></span>|<span data-ttu-id="f6068-247">可<sup>1</sup></span><span class="sxs-lookup"><span data-stu-id="f6068-247">Yes<sup>1</sup></span></span>|<span data-ttu-id="f6068-248">いいえ</span><span class="sxs-lookup"><span data-stu-id="f6068-248">No</span></span>|<span data-ttu-id="f6068-249">はい<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="f6068-249">Yes<sup>2</sup></span></span>|  
|<span data-ttu-id="f6068-250">**P2P**</span><span class="sxs-lookup"><span data-stu-id="f6068-250">**P2P**</span></span>|<span data-ttu-id="f6068-251">いいえ</span><span class="sxs-lookup"><span data-stu-id="f6068-251">No</span></span>|<span data-ttu-id="f6068-252">いいえ</span><span class="sxs-lookup"><span data-stu-id="f6068-252">No</span></span>|<span data-ttu-id="f6068-253">いいえ</span><span class="sxs-lookup"><span data-stu-id="f6068-253">No</span></span>|  
|<span data-ttu-id="f6068-254">**[マージ]**</span><span class="sxs-lookup"><span data-stu-id="f6068-254">**Merge**</span></span>|<span data-ttu-id="f6068-255">はい</span><span class="sxs-lookup"><span data-stu-id="f6068-255">Yes</span></span>|<span data-ttu-id="f6068-256">いいえ</span><span class="sxs-lookup"><span data-stu-id="f6068-256">No</span></span>|<span data-ttu-id="f6068-257">はい<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="f6068-257">Yes<sup>2</sup></span></span>|  
|<span data-ttu-id="f6068-258">**スナップショット**</span><span class="sxs-lookup"><span data-stu-id="f6068-258">**Snapshot**</span></span>|<span data-ttu-id="f6068-259">はい</span><span class="sxs-lookup"><span data-stu-id="f6068-259">Yes</span></span>|<span data-ttu-id="f6068-260">いいえ</span><span class="sxs-lookup"><span data-stu-id="f6068-260">No</span></span>|<span data-ttu-id="f6068-261">はい<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="f6068-261">Yes<sup>2</sup></span></span>|  
  
 <span data-ttu-id="f6068-262"><sup>1</sup>双方向の相互トランザクションレプリケーションのサポートは含まれません。</span><span class="sxs-lookup"><span data-stu-id="f6068-262"><sup>1</sup> Does not include support for bi-directional and reciprocal transactional replication.</span></span>  
  
 <span data-ttu-id="f6068-263"><sup>2</sup>レプリカデータベースへのフェールオーバーは手動で行います。</span><span class="sxs-lookup"><span data-stu-id="f6068-263"><sup>2</sup> Failover to the replica database is a manual procedure.</span></span> <span data-ttu-id="f6068-264">自動フェールオーバーは提供されていません。</span><span class="sxs-lookup"><span data-stu-id="f6068-264">Automatic failover is not provided.</span></span>  
  
 <span data-ttu-id="f6068-265"><sup>3</sup>ディストリビューターデータベースは、 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] またはデータベースミラーリングでの使用がサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="f6068-265"><sup>3</sup> The Distributor database is not supported for use with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] or database mirroring.</span></span>  
  
### <a name="considerations"></a><span data-ttu-id="f6068-266">考慮事項</span><span class="sxs-lookup"><span data-stu-id="f6068-266">Considerations</span></span>  
  
-   <span data-ttu-id="f6068-267">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] またはデータベース ミラーリングでディストリビューション データベースを使用することはできません。</span><span class="sxs-lookup"><span data-stu-id="f6068-267">The distribution database is not supported for use with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] or database mirroring.</span></span> <span data-ttu-id="f6068-268">レプリケーション構成は、ディストリビューターが構成された SQL Server インスタンスと結び付けられます。そのため、ディストリビューション データベースはミラー化またはレプリケートできません。</span><span class="sxs-lookup"><span data-stu-id="f6068-268">Replication configuration is coupled to the SQL Server instance where the Distributor is configured; therefore the distribution database cannot be mirrored or replicated.</span></span> <span data-ttu-id="f6068-269">ディストリビューターの高可用性を実現するには、SQL Server のフェールオーバー クラスターを使用します。</span><span class="sxs-lookup"><span data-stu-id="f6068-269">To provide high availability for the Distributor, use a SQL Server failover cluster.</span></span> <span data-ttu-id="f6068-270">詳細については、「[Always On フェールオーバー クラスター インスタンス (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="f6068-270">For more information, see [AlwaysOn Failover Cluster Instances (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md).</span></span>  
  
-   <span data-ttu-id="f6068-271">セカンダリ データベースへのサブスクライバーのフェールオーバーはサポートされていますが、かなり複雑な手動での手順になります。</span><span class="sxs-lookup"><span data-stu-id="f6068-271">Subscriber failover to a secondary database, while supported, is a relatively complex manual procedure.</span></span> <span data-ttu-id="f6068-272">手順は、ミラー化されたサブスクライバー データベースをフェールオーバーするために使用される方法と本質的には同じです。</span><span class="sxs-lookup"><span data-stu-id="f6068-272">The procedure is essentially identical to the method used to fail over a mirrored subscriber database.</span></span> <span data-ttu-id="f6068-273">可用性グループに参加するには、サブスクライバーは [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] 以降を実行している必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-273">Subscribers must be running [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] or later to participate in an availability group.</span></span>  
  
-   <span data-ttu-id="f6068-274">ログイン、ジョブ、リンク サーバーなど、データベースの外部に存在するメタデータやオブジェクトはセカンダリ レプリカに反映されません。</span><span class="sxs-lookup"><span data-stu-id="f6068-274">Metadata and objects that exist outside the database are not propagated to the secondary replicas, including logins, jobs, linked servers.</span></span> <span data-ttu-id="f6068-275">フェールオーバー後に新しいプライマリ データベースでこれらのメタデータやオブジェクトが必要な場合は、手動でコピーする必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6068-275">If you require the metadata and objects at the new primary database after failover, you must copy them manually.</span></span> <span data-ttu-id="f6068-276">詳細については、「 [可用性グループのデータベースのためのログインとジョブの管理 &#40;SQL Server&#41;](../../logins-and-jobs-for-availability-group-databases.md)と呼ばれるプロセスで交換されることがあります。</span><span class="sxs-lookup"><span data-stu-id="f6068-276">For more information, see [Management of Logins and Jobs for the Databases of an Availability Group &#40;SQL Server&#41;](../../logins-and-jobs-for-availability-group-databases.md).</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="f6068-277">関連タスク</span><span class="sxs-lookup"><span data-stu-id="f6068-277">Related Tasks</span></span>  
 <span data-ttu-id="f6068-278">**レプリケーション**</span><span class="sxs-lookup"><span data-stu-id="f6068-278">**Replication**</span></span>  
  
-   [<span data-ttu-id="f6068-279">AlwaysOn 可用性グループ用のレプリケーションの構成 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f6068-279">Configure Replication for AlwaysOn Availability Groups (SQL Server)</span></span>](always-on-availability-groups-sql-server.md)  
  
-   [<span data-ttu-id="f6068-280">AlwaysOn パブリケーションデータベースのメンテナンス &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-280">Maintaining an AlwaysOn Publication Database &#40;SQL Server&#41;</span></span>](maintaining-an-always-on-publication-database-sql-server.md)  
  
-   [<span data-ttu-id="f6068-281">レプリケーション管理に関する FAQ</span><span class="sxs-lookup"><span data-stu-id="f6068-281">Replication Administration FAQ</span></span>](../../../relational-databases/replication/administration/frequently-asked-questions-for-replication-administrators.md)  
  
 <span data-ttu-id="f6068-282">**変更データのキャプチャ**</span><span class="sxs-lookup"><span data-stu-id="f6068-282">**Change data capture**</span></span>  
  
-   [<span data-ttu-id="f6068-283">変更データ キャプチャの有効化と無効化 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-283">Enable and Disable Change Data Capture &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server.md)  
  
-   [<span data-ttu-id="f6068-284">変更データ キャプチャの管理と監視 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-284">Administer and Monitor Change Data Capture &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/administer-and-monitor-change-data-capture-sql-server.md)  
  
-   [<span data-ttu-id="f6068-285">変更データの処理 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-285">Work with Change Data &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/work-with-change-data-sql-server.md)  
  
 <span data-ttu-id="f6068-286">**Change tracking**</span><span class="sxs-lookup"><span data-stu-id="f6068-286">**Change tracking**</span></span>  
  
-   [<span data-ttu-id="f6068-287">変更の追跡の有効化と無効化 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-287">Enable and Disable Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/enable-and-disable-change-tracking-sql-server.md)  
  
-   [<span data-ttu-id="f6068-288">変更の追跡の管理 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-288">Manage Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/manage-change-tracking-sql-server.md)  
  
-   [<span data-ttu-id="f6068-289">変更の追跡のしくみ &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-289">Work with Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/work-with-change-tracking-sql-server.md)  
  
## <a name="see-also"></a><span data-ttu-id="f6068-290">参照</span><span class="sxs-lookup"><span data-stu-id="f6068-290">See Also</span></span>  
 <span data-ttu-id="f6068-291">[レプリケーションサブスクライバーと AlwaysOn 可用性グループ &#40;SQL Server&#41;](replication-subscribers-and-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-291">[Replication Subscribers and AlwaysOn Availability Groups &#40;SQL Server&#41;](replication-subscribers-and-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="f6068-292">[AlwaysOn 可用性グループ &#40;SQL Server の前提条件、制限事項、推奨事項&#41;](prereqs-restrictions-recommendations-always-on-availability.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-292">[Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md) </span></span>  
 <span data-ttu-id="f6068-293">[AlwaysOn 可用性グループ &#40;SQL Server の概要&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-293">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="f6068-294">[AlwaysOn 可用性グループ: 相互運用性 (SQL Server)](always-on-availability-groups-interoperability-sql-server.md) [AlwaysOn フェールオーバークラスターインスタンス (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-294">[AlwaysOn Availability Groups: Interoperability (SQL Server)](always-on-availability-groups-interoperability-sql-server.md) [AlwaysOn Failover Cluster Instances (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) </span></span>  
 <span data-ttu-id="f6068-295">[変更データ キャプチャについて &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-295">[About Change Data Capture &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="f6068-296">[変更の追跡について &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-tracking-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-296">[About Change Tracking &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-tracking-sql-server.md) </span></span>  
 <span data-ttu-id="f6068-297">[SQL Server のレプリケーション](../../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-297">[SQL Server Replication](../../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="f6068-298">[データ変更の追跡 &#40;SQL Server&#41;](../../../relational-databases/track-changes/track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f6068-298">[Track Data Changes &#40;SQL Server&#41;](../../../relational-databases/track-changes/track-data-changes-sql-server.md) </span></span>  
 [<span data-ttu-id="f6068-299">sys.sp_cdc_add_job &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="f6068-299">sys.sp_cdc_add_job &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql)  
  
  
