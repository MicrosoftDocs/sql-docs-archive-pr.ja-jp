---
title: 可用性グループの強制手動フェールオーバーの実行 (SQLServer) | Microsoft Docs
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
f1_keywords:
- sql12.swb.availabilitygroup.forcefailover.f1
helpviewer_keywords:
- Availability Groups [SQL Server], failover
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 222288fe-ffc0-4567-b624-5d91485d70f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: f36908102a09eb1ef1f7a485898da715deb4253b
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87639660"
---
# <a name="perform-a-forced-manual-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="7bb64-102">可用性グループの強制手動フェールオーバーの実行 (SQLServer)</span><span class="sxs-lookup"><span data-stu-id="7bb64-102">Perform a Forced Manual Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="7bb64-103">このトピックでは、[!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]、[!INCLUDE[tsql](../../../includes/tsql-md.md)]、または [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] の PowerShell を使用して、AlwaysOn 可用性グループに対する強制フェールオーバー (データ損失の可能性あり) を実行する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-103">This topic describes how to perform a forced failover (with possible data loss) on an AlwaysOn availability group by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)], or PowerShell in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="7bb64-104">強制フェールオーバーは、[計画的な手動フェールオーバー](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)を実行できない場合に、ディザスター リカバリーのみを目的として実行する手動フェールオーバーです。</span><span class="sxs-lookup"><span data-stu-id="7bb64-104">A forced failover is a form of manual failover that is intended strictly for disaster recovery, when a [planned manual failover](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md) is not possible.</span></span> <span data-ttu-id="7bb64-105">非同期のセカンダリ レプリカに対して強制フェールオーバーを実行した場合、データ損失の可能性があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-105">If you force failover to an unsynchronized secondary replica, some data loss is possible.</span></span> <span data-ttu-id="7bb64-106">したがって、強制フェールオーバーは、データ損失のリスクを引き受けたうえで、可用性グループに対するサービスを直ちに復旧する必要がある場合のみ実行することを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7bb64-106">Therefore, we strongly recommend that you force failover only if you must restore service to the availability group immediately and you are willing to risk losing data.</span></span>  
  
 <span data-ttu-id="7bb64-107">強制フェールオーバーの実行後、可用性グループのフェールオーバー先であるフェールオーバー ターゲットが新しいプライマリ レプリカになります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-107">After a forced failover, the failover target to which the availability group was failed over becomes the new primary replica.</span></span> <span data-ttu-id="7bb64-108">残りのセカンダリ レプリカ内のセカンダリ データベースは中断され、手動で再開する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-108">The secondary databases in the remaining secondary replicas are suspended and must be manually resumed.</span></span> <span data-ttu-id="7bb64-109">元のプライマリ レプリカは、使用可能になったときにセカンダリ ロールに移行し、元のプライマリ データベースがセカンダリ データベースになり、SUSPENDED 状態に移行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-109">When the former primary replica becomes available, it transitions to the secondary role, causing the former primary databases to become secondary databases and transition into the SUSPENDED state.</span></span> <span data-ttu-id="7bb64-110">特定のセカンダリ データベースを再開する前に、そのデータベースから失われたデータを復元できる場合があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-110">Before you resume a given secondary database, you might be able to recover lost data from it.</span></span> <span data-ttu-id="7bb64-111">ただし、プライマリ データベースでは、いずれかのセカンダリ データベースが中断している間、トランザクション ログの切り捨てが遅延されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-111">However, notice that transaction log truncation is delayed on a given primary database while any of its secondary databases is suspended.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7bb64-112">セカンダリ データベースが再開されるまでは、プライマリ データベースとのデータ同期は実行されません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-112">Data synchronization with the primary database will not occur until the secondary database is resumed.</span></span> <span data-ttu-id="7bb64-113">セカンダリ データベースの再開の詳細については、この記事の後半にある「[補足情報: 強制フェールオーバー後の必須タスク](#FollowUp)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-113">For information about resuming a secondary database, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp) later in this article.</span></span>  
  
 <span data-ttu-id="7bb64-114">強制フェールオーバーは、次のような緊急事態が発生した場合に実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-114">Performing a forced failover is necessary in the following emergency situations:</span></span>  
  
-   <span data-ttu-id="7bb64-115">WSFC クラスターに対してクォーラムを強制した後 ( *"強制クォーラム"* )、各可用性グループに対して強制フェールオーバーを実行する必要があります (このとき、データ損失の可能性もあります)。</span><span class="sxs-lookup"><span data-stu-id="7bb64-115">After forcing quorum on the WSFC cluster (*forced quorum*), you need to force failover each availability group (with possible data loss).</span></span> <span data-ttu-id="7bb64-116">強制フェールオーバーが必要なのは、WSFC クラスター値の実際の状態が失われている可能性があるためです。</span><span class="sxs-lookup"><span data-stu-id="7bb64-116">Forcing failover is required because the real state of the WSFC cluster values might have been lost.</span></span> <span data-ttu-id="7bb64-117">ただし、強制クォーラムを実行する前にプライマリ レプリカであったレプリカをホストしていたサーバー インスタンスで強制フェールオーバーを実行できる場合、または強制クォーラムを実行する前に同期されていたセカンダリ レプリカに対してフェールオーバーを実行できる場合は、データ損失を回避できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-117">However, you can avoid data loss, if are able to force failover on the server instance that was hosting the replica that was the primary replica before you forced quorum or to a secondary replica that was synchronized before you forced quorum.</span></span> <span data-ttu-id="7bb64-118">詳細については、このトピックの「 [クォーラム強制後のデータ損失を回避できる方法](#WaysToAvoidDataLoss)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-118">For more information, see [Potential Ways to Avoid Data Loss After Quorum is Forced](#WaysToAvoidDataLoss), later in this topic.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="7bb64-119">クォーラムが強制ではなく通常の方法で再取得される場合、可用性レプリカは通常の方法で復元されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-119">If quorum is regained by natural means instead of being forced, the availability replicas will go through normal recovery.</span></span> <span data-ttu-id="7bb64-120">クォーラムの再取得後にプライマリ レプリカがまだ使用できない場合は、同期セカンダリ レプリカに対して計画的な手動フェールオーバーを実行できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-120">If the primary replica is still unavailable after quorum is regained, you can perform a planned manual failover to a synchronized secondary replica.</span></span>  
  
     <span data-ttu-id="7bb64-121">強制フォーラムの詳細については、「 [WSFC の強制クォーラムによる災害復旧 &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)の PowerShell を使用して、AlwaysOn 可用性グループに対する強制フェールオーバー (データ損失の可能性あり) を実行する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-121">For information about forcing quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span> <span data-ttu-id="7bb64-122">強制クォーラム後に強制フェールオーバーが必要な理由については、「[フェールオーバーとフェールオーバー モード &#40;AlwaysOn 可用性グループ&#41;](failover-and-failover-modes-always-on-availability-groups.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-122">For information about why forcing failover is required after forcing quorum, see [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
-   <span data-ttu-id="7bb64-123">WSFC クラスターに正常なクォーラムがあるときにプライマリ レプリカが使用不能になった場合は、ロールが SECONDARY または RESOLVING 状態である任意のレプリカに、強制フェールオーバー (データ損失の可能性あり) を実行できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-123">If the primary replica becomes unavailable when the WSFC cluster has a healthy quorum, you can force failover (with possible data loss), to any replica whose role is in the SECONDARY or RESOLVING state.</span></span> <span data-ttu-id="7bb64-124">可能であれば、プライマリ レプリカが失われたときに同期されていた、同期コミット セカンダリ レプリカへの強制フェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-124">If possible, force failover to a synchronous-commit secondary replica that was synchronized when the primary replica was lost.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="7bb64-125">WSFC クラスターに正常なクォーラムがあるときに、同期セカンダリ レプリカで強制フェールオーバー コマンドを発行した場合、レプリカが実際に実行するのは、計画的な手動フェールオーバーです。</span><span class="sxs-lookup"><span data-stu-id="7bb64-125">When the WSFC cluster has a healthy quorum, if you issue a force failover command on a synchronized secondary replica, the replica actually performs a planned manual failover.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7bb64-126">フェールオーバーを強制する場合の前提条件と推奨事項の詳細、および強制フェールオーバーを使用して重大なエラーから復旧するシナリオの例については、この記事の後半にある「[サンプル シナリオ: 重大なエラーから復旧するための強制フェールオーバーの使用](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-126">For more information about the prerequisites and recommendations for forcing failover and for an example scenario that uses a forced failover to recover from a catastrophic failure, see [Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy), later in this topic.</span></span>  
  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> <span data-ttu-id="7bb64-127">はじめに</span><span class="sxs-lookup"><span data-stu-id="7bb64-127">Before You Begin</span></span>  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> <span data-ttu-id="7bb64-128">制限事項と制約事項</span><span class="sxs-lookup"><span data-stu-id="7bb64-128">Limitations and Restrictions</span></span>  
  
-   <span data-ttu-id="7bb64-129">強制フェールオーバーは、Windows server フェールオーバー クラスタリング (WSFC) にクォーラムが存在しない場合のみ実行できません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-129">The only time that you cannot perform a forced failover is when Windows Server Failover Clustering (WSFC) cluster lacks quorum.</span></span>  
  
-   <span data-ttu-id="7bb64-130">可用性グループの強制フェールオーバー中にはデータ損失の可能性があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-130">Data loss is possible during the forced failover of an availability group.</span></span> <span data-ttu-id="7bb64-131">さらに、強制フェールオーバーを開始したときにプライマリ レプリカが実行されている場合は、クライアントがまだ元のプライマリ データベースに接続している可能性があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-131">In addition, if the primary replica is running when you initiate a forced failover, clients might still be connected to former primary databases.</span></span> <span data-ttu-id="7bb64-132">したがって、プライマリ レプリカが動作しておらず、データ損失のリスクを許容できる場合にのみ、可用性グループのデータベースへのアクセスを復旧するために強制フェールオーバーを実行することを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7bb64-132">Therefore, we strongly recommend that you force failover only if the primary replica is no longer running and if you are willing to risk losing data in order to restore access to databases in the availability group.</span></span>  
  
-   <span data-ttu-id="7bb64-133">セカンダリ データベースが REVERTING または INITIALIZING 状態の場合、強制フェールオーバーを実行すると、そのデータベースはプライマリ データベースとして起動できなくなります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-133">When a secondary database in the REVERTING or INITIALIZING state, forcing failover would cause the database to fail to start as a primary database.</span></span> <span data-ttu-id="7bb64-134">データベースが INTIAILIZGING 状態だった場合は、欠落しているログ レコードをデータベース バックアップから適用するか、データベースを最初から完全に復元する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-134">If the database was in the INTIAILIZGING state the you will need to apply the missing log records from a database backup or fully restore the database from scratch.</span></span> <span data-ttu-id="7bb64-135">データベースが REVERTING 状態だった場合は、データベースをバックアップから完全に復元する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-135">If the database was in the REVERTING state you will need to fully restore the database from backups.</span></span>  
  
-   <span data-ttu-id="7bb64-136">フェールオーバー コマンドは、フェールオーバー ターゲットがコマンドを受け入れた直後に戻ります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-136">A failover command returns as soon as the failover target has accepted the command.</span></span> <span data-ttu-id="7bb64-137">ただし、データベースの復旧は、可用性グループがフェールオーバーを完了した後に非同期で行われます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-137">However, database recovery occurs asynchronously after the availability group has finished failing over.</span></span>  
  
-   <span data-ttu-id="7bb64-138">フェールオーバー時に、可用性グループ内のデータベース間の一貫性は維持されません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-138">Cross-database consistency across databases within the availability group is not maintained on failover.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="7bb64-139">複数のデータベースにまたがるトランザクションおよび分散トランザクションは、[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] ではサポートされません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-139">Cross-database transactions and distributed transactions are not supported by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="7bb64-140">詳細については、「[データベース ミラーリングまたは AlwaysOn 可用性グループではサポートされない複数データベースにまたがるトランザクション &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-140">For more information, see [Cross-Database Transactions Not Supported For Database Mirroring or AlwaysOn Availability Groups &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md).</span></span>  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> <span data-ttu-id="7bb64-141">前提条件</span><span class="sxs-lookup"><span data-stu-id="7bb64-141">Prerequisites</span></span>  
  
-   <span data-ttu-id="7bb64-142">WSFC クラスターにクォーラムがあること。</span><span class="sxs-lookup"><span data-stu-id="7bb64-142">The WSFC cluster has quorum.</span></span> <span data-ttu-id="7bb64-143">クラスターにクォーラムが存在しない場合は、「 [WSFC の強制クォーラムによる災害復旧 &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)の PowerShell を使用して、AlwaysOn 可用性グループに対する強制フェールオーバー (データ損失の可能性あり) を実行する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-143">If the cluster lacks quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
-   <span data-ttu-id="7bb64-144">ロールが SECONDARY または RESOLVING 状態であるレプリカをホストするサーバー インスタンスに接続できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-144">You must be able to connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state.</span></span>  
  
###  <a name="recommendations"></a><a name="Recommendations"></a> <span data-ttu-id="7bb64-145">推奨事項</span><span class="sxs-lookup"><span data-stu-id="7bb64-145">Recommendations</span></span>  
  
-   <span data-ttu-id="7bb64-146">プライマリ レプリカが実行中である間は、強制フェールオーバーを実行しないでください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-146">Do not force failover while the primary replica is still running.</span></span>  
  
-   <span data-ttu-id="7bb64-147">可能な場合は、セカンダリ データベースが NOT SYNCHRONIZED、SYNCHRONIZED、SYNCHRONIZING のいずれかの状態であるセカンダリ レプリカにのみ、強制フェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-147">If possible, force failover only to a failover target whose secondary databases are either in the NOT SYNCHRONIZED, SYNCHRONIZED, or SYNCHRONIZING state.</span></span> <span data-ttu-id="7bb64-148">セカンダリ データベースが INTIAILIZGING または REVERTING 状態の場合の強制フェールオーバーの影響については、このトピックの「 [制限事項と制約事項](#Restrictions)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-148">For information about the implications of forcing failover when a secondary database is in the INTIAILIZGING or REVERTING state, see [Limitations and Restrictions](#Restrictions), earlier in this topic.</span></span>  
  
-   <span data-ttu-id="7bb64-149">通常は、特定のセカンダリ データベースの待機時間は、プライマリ データベースに比べて、別の非同期コミット セカンダリ レプリカでも同じくらいになります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-149">Typically, the latency of a given secondary database, relative to the primary database, should be similar on different asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="7bb64-150">ただし、強制フェールオーバーを行う場合は、データ損失が重要な問題になります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-150">However, when forcing failover, data loss can be a significant concern.</span></span> <span data-ttu-id="7bb64-151">そのため、異なるセカンダリ レプリカ上でのデータベースのコピーに関する相対的な待機時間を検討するようにしてください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-151">Therefore, consider taking time to determine the relative latency of the copies of the databases on different secondary replicas.</span></span> <span data-ttu-id="7bb64-152">特定のセカンダリ データベースのどのコピーが最小の待機時間かを判断するには、ログの最後の LSN を比較します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-152">To determine which copy of a given secondary database has the least latency, compare their end-of-log LSNs.</span></span> <span data-ttu-id="7bb64-153">ログの最後の LSN の値が大きいほど、待機時間が小さいことを示します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-153">A higher the end-of-log LSN indicates less latency.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="7bb64-154">ログの最後の LSN の値を比較するには、それぞれのオンライン セカンダリ レプリカに接続し、 [sys.dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) に対して各ローカル セカンダリ データベースの **end_of_log_lsn** 値を照会します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-154">To compare end-of-log LSNs, connect to each online secondary replica, in turn, and query [sys.dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) for the **end_of_log_lsn** value of each local secondary database.</span></span> <span data-ttu-id="7bb64-155">次に、各データベースの異なるコピーで、ログの最後の LSN を比較します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-155">Then, compare the end-of-log LSNs of the different copies of each database.</span></span> <span data-ttu-id="7bb64-156">データベースによって、LSN の値が最も大きいセカンダリ レプリカが異なる場合もあることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-156">Note that different databases might have their highest LSNs on different secondary replicas.</span></span> <span data-ttu-id="7bb64-157">この場合、最も適切なフェールオーバー ターゲットは、各データベース内のデータの相対的な重要度によって決まります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-157">In this case, the most appropriate failover target depends on the relative importance that you place on the data in the different databases.</span></span> <span data-ttu-id="7bb64-158">つまり、どのデータベースでのデータ損失の可能性を最小限に抑えたいか、という問題になります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-158">That is, for which of these databases would you most want to minimize possible data loss?</span></span>  
  
-   <span data-ttu-id="7bb64-159">クライアントが元のプライマリに接続できる場合は、強制フェールオーバーによってスプリット ブレイン動作のリスクが発生します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-159">If clients are able to connect to the original primary, a forced failover incurs some risk of split brain behavior.</span></span> <span data-ttu-id="7bb64-160">強制フェールオーバーを実行する前に、クライアントが元のプライマリ レプリカにアクセスできないようにすることを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7bb64-160">Before you force failover, we strongly recommend that you prevent clients from accessing the original primary replica.</span></span> <span data-ttu-id="7bb64-161">そうしないと、強制フェールオーバーの実行後に元のプライマリ データベースと現在のプライマリ データベースがそれぞれ、他方とは無関係に更新されることがあります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-161">Otherwise, after failover is forced, the original primary databases and the current primary databases could be updated independently of the other.</span></span>  
  
###  <a name="potential-ways-to-avoid-data-loss-after-quorum-is-forced"></a><a name="WaysToAvoidDataLoss"></a> <span data-ttu-id="7bb64-162">クォーラム強制後のデータ損失を回避できる方法</span><span class="sxs-lookup"><span data-stu-id="7bb64-162">Potential Ways to Avoid Data Loss After Quorum is Forced</span></span>  
 <span data-ttu-id="7bb64-163">クォーラムが失われた後のエラー状態中は、以下に示すように、データ損失を回避できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-163">Under some failure conditions after quorum is lost, you can avoid prevent data loss, as follows:</span></span>  
  
-   <span data-ttu-id="7bb64-164">**元のプライマリ レプリカがオンラインになる場合**</span><span class="sxs-lookup"><span data-stu-id="7bb64-164">**If the original primary replica comes online**</span></span>  
  
     <span data-ttu-id="7bb64-165">クォーラムが失われ、WSFC クォーラムの強制によって可用性グループのプライマリ レプリカをホストするクラスター ノードが復元される場合は、その可用性グループのデータ損失を回避できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-165">If quorum is lost and forcing WSFC quorum restores the cluster node that hosts the primary replica of an availability group, you can prevent data loss for this availability group.</span></span> <span data-ttu-id="7bb64-166">プライマリ レプリカに接続し、強制フェールオーバー (FAILOVER_ALLOW_DATA_LOSS) を実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-166">Connect to the primary replica and perform a forced failover (FAILOVER_ALLOW_DATA_LOSS).</span></span> <span data-ttu-id="7bb64-167">これにより、プライマリ レプリカがオンラインに戻ります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-167">This brings the primary replica back online.</span></span> <span data-ttu-id="7bb64-168">元のプライマリ レプリカへの強制フェールオーバーを実行するため、データ損失は起こりません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-168">Because you perform the forced failover to the original primary replica, there is no data loss.</span></span>  
  
-   <span data-ttu-id="7bb64-169">**同期コミット セカンダリ レプリカがオンラインになる場合**</span><span class="sxs-lookup"><span data-stu-id="7bb64-169">**If a synchronized synchronous-commit secondary replica comes online**</span></span>  
  
     <span data-ttu-id="7bb64-170">クォーラムが失われ、WSFC クォーラムの強制によって可用性グループの同期セカンダリ レプリカをホストするクラスター ノードが復元される場合は、その可用性グループのデータ損失を回避できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-170">If quorum is lost and forcing WSFC quorum restores a cluster node that hosts a synchronized secondary replica for an availability group, you should be able to prevent data loss for this availability group.</span></span> <span data-ttu-id="7bb64-171">復元されるノードが、クォーラムの消失時に起動していた場合は、 **sys.dm_hadr_database_replica_cluster_states** 動的管理ビューの [is_failover_ready](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) 列を照会することで、特定のデータベースでデータ損失が発生した可能性があるかどうかを確認できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-171">If the restored node was up at the time that quorum was lost, you can determine whether data loss could occur on a given database by querying the **is_failover_ready** column of the [sys.dm_hadr_database_replica_cluster_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) dynamic management view.</span></span> <span data-ttu-id="7bb64-172">たとえば、 `sql108w2k8r22`という名前のサーバー インスタンスに対して、次のクエリを発行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-172">For example, for a server instance named `sql108w2k8r22`, issue the following query:</span></span>  
  
    ```  
    SELECT * FROM sys.dm_hadr_database_replica_cluster_states  
       WHERE replica_id=(SELECT replica_id FROM sys.availability_replicas   
          WHERE replica_server_name ='sql108w2k8r22')  
    ```  
  
    > [!CAUTION]  
    >  <span data-ttu-id="7bb64-173">復元されるノードがクォーラムの消失時に起動していなかった場合、 **is_failover_ready** は、プライマリ レプリカがオフラインになった時点のクラスターの実際の状態を反映していない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-173">If the restored node was not up at the time quorum was lost, **is_failover_ready** may not reflect the cluster's actual state at the time the primary replica went offline.</span></span> <span data-ttu-id="7bb64-174">したがって、 **is_failover_ready** 値は、エラー発生時のホスト ノードにのみ有効です。</span><span class="sxs-lookup"><span data-stu-id="7bb64-174">Therefore, the **is_failover_ready** value is only good if the host node at the time of the failure.</span></span> <span data-ttu-id="7bb64-175">詳細については、「[フェールオーバーとフェールオーバー モード &#40;AlwaysOn 可用性グループ&#41;](failover-and-failover-modes-always-on-availability-groups.md)」の「クォーラムの強制後に強制フェールオーバーが必要な理由」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-175">For more information, see "Why Forced Failover is Required After Forcing Quorum" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="7bb64-176">**is_failover_ready** = 1 の場合、データベースはクラスター内で同期済みとマークされ、フェールオーバーの準備ができています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-176">If **is_failover_ready** = 1, the database is marked as synchronized in the cluster and is ready for a failover.</span></span> <span data-ttu-id="7bb64-177">特定のセカンダリ レプリカのすべてのデータベースで **is_failover_ready** = 1 の場合は、そのセカンダリ レプリカに対して、データ損失なしで強制フェールオーバー (FORCE_FAILOVER_ALLOW_DATA_LOSS) を実行できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-177">If **is_failover_ready** = 1 on every database on a given secondary replica, you can perform a forced failover (FORCE_FAILOVER_ALLOW_DATA_LOSS) without data loss on this secondary replica.</span></span> <span data-ttu-id="7bb64-178">同期セカンダリ レプリカは、すべてのデータを保持したまま、新しいプライマリ レプリカとしてプライマリ ロールでオンラインになります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-178">The synchronized secondary replica comes online in the primary role, that is, as the new primary replica, with all the data intact.</span></span>  
  
     <span data-ttu-id="7bb64-179">**is_failover_ready** = 0 の場合、データベースはクラスター内で同期済みとマークされておらず、計画的な手動フェールオーバーの準備が *"できていません"* 。</span><span class="sxs-lookup"><span data-stu-id="7bb64-179">If **is_failover_ready** = 0, the database is not marked as synchronized in the cluster and is *not* ready for a planned manual failover.</span></span> <span data-ttu-id="7bb64-180">ホスト セカンダリ レプリカに対して強制フェールオーバーを実行した場合、そのデータベースのデータは失われます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-180">If you force failover to the host secondary replica, data will be lost on this database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="7bb64-181">セカンダリ レプリカに対して強制フェールオーバーを実行する場合、データ損失の量は、フェールオーバー ターゲットがどの程度プライマリ レプリカより遅れているかによって決まります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-181">When you force failover to a secondary replica, the amount of data loss will depend on how far the failover target is lagging behind the primary replica.</span></span> <span data-ttu-id="7bb64-182">残念ながら、WSFC クラスターにクォーラムが存在しない、またはクォーラムが強制されている場合は、失われる可能性があるデータの量を評価できません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-182">Unfortunately, when the WSFC cluster lacks quorum or quorum has been forced, you cannot assess the amount of potential data loss.</span></span> <span data-ttu-id="7bb64-183">ただし、WSFC クラスターが正常なクォーラムを再取得した後、データ損失の可能性を追跡できます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-183">Note, however, that once the WSFC cluster regains a healthy quorum, you could begin to track potential data loss.</span></span> <span data-ttu-id="7bb64-184">詳細については、「[フェールオーバーとフェールオーバー モード &#40;AlwaysOn 可用性グループ&#41;](failover-and-failover-modes-always-on-availability-groups.md)」の「データ損失の可能性の追跡」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-184">For more information, see "Tracking Potential Data Loss" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="7bb64-185">セキュリティ</span><span class="sxs-lookup"><span data-stu-id="7bb64-185">Security</span></span>  
  
####  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="7bb64-186">Permissions</span><span class="sxs-lookup"><span data-stu-id="7bb64-186">Permissions</span></span>  
 <span data-ttu-id="7bb64-187">可用性グループの ALTER AVAILABILITY GROUP 権限、CONTROL AVAILABILITY GROUP 権限、ALTER ANY AVAILABILITY GROUP 権限、または CONTROL SERVER 権限が必要です。</span><span class="sxs-lookup"><span data-stu-id="7bb64-187">Requires ALTER AVAILABILITY GROUP permission on the availability group, CONTROL AVAILABILITY GROUP permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="7bb64-188">SQL Server Management Studio の使用</span><span class="sxs-lookup"><span data-stu-id="7bb64-188">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="7bb64-189">**強制フェールオーバー (データ損失の可能性あり) を実行するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-189">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="7bb64-190">オブジェクト エクスプローラーで、フェールオーバーを行う必要がある可用性グループでロールが SECONDARY または RESOLVING 状態であるレプリカをホストするサーバー インスタンスに接続し、サーバー ツリーを展開します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-190">In Object Explorer, connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over, and expand the server tree.</span></span>  
  
2.  <span data-ttu-id="7bb64-191">**[AlwaysOn 高可用性]** ノードと **[可用性グループ]** ノードを展開します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-191">Expand the **AlwaysOn High Availability** node and the **Availability Groups** node.</span></span>  
  
3.  <span data-ttu-id="7bb64-192">フェールオーバーする [可用性グループ] ノードを右クリックし、 **[フェールオーバー]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-192">Right-click the availability group to be failed over, and select the **Failover** command.</span></span>  
  
4.  <span data-ttu-id="7bb64-193">可用性グループのフェールオーバー ウィザードが起動します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-193">This launches the Failover Availability Group Wizard.</span></span> <span data-ttu-id="7bb64-194">詳細については、「[可用性グループのフェールオーバー ウィザードの使用 &#40;SQL Server Management Studio&#41;](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-194">For more information, see [Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md).</span></span>  
  
5.  <span data-ttu-id="7bb64-195">可用性グループを強制的にフェールオーバーした後で、必要なフォローアップ手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-195">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="7bb64-196">詳細については、このトピックで後述する「[補足情報:強制フェールオーバー後の必須タスク](#FollowUp)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-196">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="7bb64-197">Transact-SQL の使用</span><span class="sxs-lookup"><span data-stu-id="7bb64-197">Using Transact-SQL</span></span>  
 <span data-ttu-id="7bb64-198">**強制フェールオーバー (データ損失の可能性あり) を実行するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-198">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="7bb64-199">フェールオーバーを行う必要がある可用性グループでロールが SECONDARY または RESOLVING 状態であるレプリカをホストするサーバー インスタンスに接続し、サーバー ツリーを展開します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-199">Connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="7bb64-200">[ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) ステートメントを使用します。次にその例を示します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-200">Use the [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) statement, as follows:</span></span>  
  
     <span data-ttu-id="7bb64-201">ALTER AVAILABILITY GROUP *group_name* FORCE_FAILOVER_ALLOW_DATA_LOSS</span><span class="sxs-lookup"><span data-stu-id="7bb64-201">ALTER AVAILABILITY GROUP *group_name* FORCE_FAILOVER_ALLOW_DATA_LOSS</span></span>  
  
     <span data-ttu-id="7bb64-202">*group_name* は可用性グループの名前です。</span><span class="sxs-lookup"><span data-stu-id="7bb64-202">where *group_name* is the name of the availability group.</span></span>  
  
     <span data-ttu-id="7bb64-203">次の例では、 `AccountsAG` 可用性グループのローカル セカンダリ レプリカへのフェールオーバーを強制的に実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-203">The following example forces the `AccountsAG` availability group to fail over to the local secondary replica.</span></span>  
  
    ```sql
    ALTER AVAILABILITY GROUP AccountsAG FORCE_FAILOVER_ALLOW_DATA_LOSS;  
    ```  
  
3.  <span data-ttu-id="7bb64-204">可用性グループを強制的にフェールオーバーした後で、必要なフォローアップ手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-204">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="7bb64-205">詳細については、このトピックで後述する「[補足情報:強制フェールオーバー後の必須タスク](#FollowUp)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-205">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> <span data-ttu-id="7bb64-206">PowerShell の使用</span><span class="sxs-lookup"><span data-stu-id="7bb64-206">Using PowerShell</span></span>  
 <span data-ttu-id="7bb64-207">**強制フェールオーバー (データ損失の可能性あり) を実行するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-207">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="7bb64-208">ディレクトリの変更 ( `cd` ) を、フェールオーバーする必要がある可用性グループ内のロールがセカンダリまたは解決状態であるレプリカをホストするサーバーインスタンスに変更します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-208">Change directory (`cd`) to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="7bb64-209">次の形式のいずれかで `Switch-SqlAvailabilityGroup` パラメーターを指定して `AllowDataLoss` コマンドレットを使用します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-209">Use the `Switch-SqlAvailabilityGroup` cmdlet with the `AllowDataLoss` parameter in one of the following forms:</span></span>  
  
    -   `-AllowDataLoss`  
  
         <span data-ttu-id="7bb64-210">既定では、`-AllowDataLoss` に `Switch-SqlAvailabilityGroup` パラメーターを指定した場合、強制フェールオーバーを実行するとコミットされていないトランザクションが失われる可能性があることが通知され、操作を続行するかどうかの確認を求められます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-210">By default `-AllowDataLoss` parameter causes `Switch-SqlAvailabilityGroup` to prompt you to remind you that forcing failover might result in the loss of uncommitted transactions and to request confirmation.</span></span> <span data-ttu-id="7bb64-211">続けるには「`Y`」を入力し、操作をキャンセルするには「`N`」を入力します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-211">To continue, enter `Y`; to cancel the operation, enter `N`.</span></span>  
  
         <span data-ttu-id="7bb64-212">次の例では、可用性グループ `MyAg` に対して、 `SecondaryServer\InstanceName`というサーバー インスタンスのセカンダリ レプリカへの強制フェールオーバー (データ損失の可能性あり) が実行されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-212">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the secondary replica on the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="7bb64-213">この操作の確認を求めるメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-213">You will be prompted to confirm this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss  
        ```  
  
    -   <span data-ttu-id="7bb64-214">**-AllowDataLoss-Force**</span><span class="sxs-lookup"><span data-stu-id="7bb64-214">**-AllowDataLoss-Force**</span></span>  
  
         <span data-ttu-id="7bb64-215">確認を求めずに強制フェールオーバーを実行するには、`-AllowDataLoss` パラメーターと `-Force` パラメーターを両方とも指定します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-215">To initiate a forced failover without confirmation, specify both the `-AllowDataLoss` and `-Force` parameters.</span></span> <span data-ttu-id="7bb64-216">これは、コマンドをスクリプトに組み込んで自動的に実行する場合に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-216">This is useful if you want to include the command in a script and run it without user interaction.</span></span>  <span data-ttu-id="7bb64-217">ただし、強制フェールオーバーによって可用性グループに参加しているデータベースでデータ損失が発生する可能性があるため、`-Force` オプションは慎重に使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-217">However, use the `-Force` option with caution, because a forced failover might result in the loss of data from databases participating the availability group.</span></span>  
  
         <span data-ttu-id="7bb64-218">次の例では、可用性グループ `MyAg` に対して、 `SecondaryServer\InstanceName`というサーバー インスタンスへの強制フェールオーバー (データ損失の可能性あり) が実行されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-218">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="7bb64-219">`-Force` オプションにより、この操作の確認は表示されません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-219">The `-Force` option suppresses confirmation of this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss -Force  
        ```  
  
    > [!NOTE]  
    >  <span data-ttu-id="7bb64-220">コマンドレットの構文を表示するには、[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell 環境で `Get-Help` コマンドレットを使用します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-220">To view the syntax of a cmdlet, use the `Get-Help` cmdlet in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell environment.</span></span> <span data-ttu-id="7bb64-221">詳細については、「 [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-221">For more information, see [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>  
  
3.  <span data-ttu-id="7bb64-222">可用性グループを強制的にフェールオーバーした後で、必要なフォローアップ手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-222">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="7bb64-223">詳細については、このトピックで後述する「[補足情報:強制フェールオーバー後の必須タスク](#FollowUp)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-223">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
 <span data-ttu-id="7bb64-224">**SQL Server PowerShell プロバイダーを設定して使用するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-224">**To set up and use the SQL Server PowerShell provider**</span></span>  
  
-   [<span data-ttu-id="7bb64-225">SQL Server PowerShell プロバイダー</span><span class="sxs-lookup"><span data-stu-id="7bb64-225">SQL Server PowerShell Provider</span></span>](../../../powershell/sql-server-powershell-provider.md)  
  
##  <a name="follow-up-essential-tasks-after-a-forced-failover"></a><a name="FollowUp"></a><span data-ttu-id="7bb64-226">補足情報: 強制フェールオーバー後の必須タスク</span><span class="sxs-lookup"><span data-stu-id="7bb64-226">Follow Up: Essential Tasks After a Forced Failover</span></span>  
  
1.  <span data-ttu-id="7bb64-227">強制フェールオーバーの後で、フェールオーバー先のセカンダリ レプリカが新しいプライマリ レプリカになります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-227">After a forced failover, the secondary replica to which you failed over becomes the new primary replica.</span></span> <span data-ttu-id="7bb64-228">ただし、この可用性レプリカにクライアントからアクセスできるようにするには、WSFC クォーラムの再構成または可用性グループの可用性モード構成の調整が必要な場合があります。次の手順を実行してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-228">However, to make that availability replica accessible to clients, you might need to reconfigure the WSFC quorum or adjust the availability-mode configuration of the availability group, as follows:</span></span>  
  
    -   <span data-ttu-id="7bb64-229">**[!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] の外側でフェールオーバーした場合:** WSFC ノードのクォーラム投票を調整して新しい可用性グループの構成を反映します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-229">**If you failed over outside of the [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]:**  Adjust the quorum votes of the WSFC nodes to reflect your new availability group configuration.</span></span> <span data-ttu-id="7bb64-230">対象のセカンダリ レプリカがホストされている WSFC ノードに WSFC クォーラム投票がない場合、強制的に WSFC クォーラムを適用することが必要な場合があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-230">If the WSFC node that hosts the target secondary replica does not have a WSFC quorum vote, you might need to force WSFC quorum.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="7bb64-231">[!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] は、2 つの可用性レプリカ (元のプライマリ レプリカを含む) に、自動フェールオーバーが指定され、同期コミット モードが構成されている場合のみ存在します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-231">An [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] exists only if two availability replicas (including the previous primary replica) are configured for synchronous-commit mode with automatic failover.</span></span>  
  
         <span data-ttu-id="7bb64-232">**クォーラム投票を調整するには:**</span><span class="sxs-lookup"><span data-stu-id="7bb64-232">**To adjust quorum votes**</span></span>  
  
        -   [<span data-ttu-id="7bb64-233">クラスター クォーラムの NodeWeight 設定を表示</span><span class="sxs-lookup"><span data-stu-id="7bb64-233">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="7bb64-234">クラスター クォーラムの NodeWeight の設定の構成</span><span class="sxs-lookup"><span data-stu-id="7bb64-234">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="7bb64-235">クォーラムを使用せずに WSFC クラスターを強制的に起動する</span><span class="sxs-lookup"><span data-stu-id="7bb64-235">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
    -   <span data-ttu-id="7bb64-236">**[!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] の外側でフェールオーバーした場合:** 新しいプライマリ レプリカおよび残りのセカンダリ レプリカで、可用性モードとフェールオーバー モードを調整して、目的の同期コミット構成および自動フェールオーバー構成にすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7bb64-236">**If you failed over outside of the [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)]:** We recommend that you consider adjusting the availability mode and failover mode on the new primary replica and on remaining secondary replicas to reflect your desired synchronous-commit and automatic failover configuration.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="7bb64-237">[!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] は、現在のプライマリ レプリカに同期コミット モードが構成されている場合にのみ存在します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-237">A [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] exists only if the current primary replica is configured for synchronous-commit mode.</span></span>  
  
         <span data-ttu-id="7bb64-238">**可用性モードとフェールオーバー モードを変更するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-238">**To change the availability mode and failover mode**</span></span>  
  
        -   [<span data-ttu-id="7bb64-239">可用性レプリカの可用性モードの変更 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-239">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)  
  
        -   [<span data-ttu-id="7bb64-240">可用性レプリカのフェールオーバー モードの変更 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-240">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
2.  <span data-ttu-id="7bb64-241">強制フェールオーバー後は、すべてのセカンダリ データベースが中断されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-241">After a forced failover, all secondary databases are suspended.</span></span> <span data-ttu-id="7bb64-242">これには、元のプライマリ データベースも含まれます (元のプライマリ レプリカは、オンラインに戻った後でセカンダリ レプリカになります)。</span><span class="sxs-lookup"><span data-stu-id="7bb64-242">This includes the former primary databases, after the former primary replica comes back online and discovers that it is now a secondary replica.</span></span> <span data-ttu-id="7bb64-243">各セカンダリ レプリカで、中断されたデータベースをそれぞれ手動で再開する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-243">You must manually resume each suspended database individually on each secondary replica.</span></span>  
  
     <span data-ttu-id="7bb64-244">セカンダリ データベースは、再開時に、対応するプライマリ データベースとのデータ同期を開始します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-244">When a secondary database is resumed, it initiates data synchronization with the corresponding primary database.</span></span> <span data-ttu-id="7bb64-245">新しいプライマリ データベースで 1 回もコミットされなかったログ レコードは、すべてロールバックされます。そのため、フェールオーバー後のプライマリ データベースでデータ損失の可能性が懸念される場合は、同期コミットのセカンダリ データベースの 1 つで、中断されたデータベースにデータベース スナップショットの作成を試みる必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-245">The secondary database rolls back any log records that were never committed on the new primary database.Therefore, if you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one of the synchronous-commit secondary databases.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="7bb64-246">プライマリ データベースでは、いずれかのセカンダリ データベースが中断している間は、トランザクション ログの切り捨てが遅延されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-246">Transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="7bb64-247">また、同期コミット セカンダリ レプリカの同期状態は、いずれかのローカル データベースが中断している間は、HEALTHY に移行できません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-247">Also the synchronization health of a synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>  
  
     <span data-ttu-id="7bb64-248">**データベース スナップショットを作成するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-248">**To create a database snapshot**</span></span>  
  
    -   [<span data-ttu-id="7bb64-249">データベース スナップショットの作成 &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-249">Create a Database Snapshot &#40;Transact-SQL&#41;</span></span>](../../../relational-databases/databases/create-a-database-snapshot-transact-sql.md)  
  
     <span data-ttu-id="7bb64-250">**可用性データベースを再開するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-250">**To resume an availability database**</span></span>  
  
    -   [<span data-ttu-id="7bb64-251">可用性データベースの再開 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-251">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)  
  
    > [!CAUTION]  
    >  <span data-ttu-id="7bb64-252">すべてのセカンダリ データベースを再開した後で、グループのフェールオーバーを再度試行する前に、次のフェールオーバー ターゲットのすべてのセカンダリ データベースが SYNCHRONIZING 状態になるまで待機します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-252">After resuming all the secondary databases, before attempting to fail over the group again, wait for every secondary database on the next failover target to enter the SYNCHRONIZING state.</span></span> <span data-ttu-id="7bb64-253">どのデータベースもまだ SYNCHRONIZING 状態ではない場合、データベースをプライマリ データベースとしてオンラインにすることができません。また、データベースへのデータ同期を再確立するには、トランザクション ログの復元、データベース バックアップ全体の復元、または元のプライマリ レプリカへのフェールオーバーが必要となる場合があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-253">If any database is not yet SYNCHRONIZING, that database will be prevented from coming online as a primary database, and re-establishing data synchronization for the database might require restoring transaction logs, restoring a full database backup, or failing over back to the previous primary replica.</span></span>  
  
3.  <span data-ttu-id="7bb64-254">停止した可用性レプリカがその可用性レプリカに戻らないか、戻るのが遅すぎて新しいプライマリ データベースでのトランザクション ログの切り捨てを遅延できない場合、停止したレプリカを可用性グループから削除してログ ファイル用のディスク領域の不足を回避することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-254">If an availability replica that failed will not be returning to the availability replica or will return too late for you to delay transaction log truncation on the new primary database, consider removing the failed replica from the availability group to avoid running out of disk space for your log files.</span></span>  
  
     <span data-ttu-id="7bb64-255">**セカンダリ レプリカを削除するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-255">**To remove a secondary replica**</span></span>  
  
    -   [<span data-ttu-id="7bb64-256">可用性グループからのセカンダリ レプリカの削除 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-256">Remove a Secondary Replica from an Availability Group &#40;SQL Server&#41;</span></span>](remove-a-secondary-replica-from-an-availability-group-sql-server.md)  
  
4.  <span data-ttu-id="7bb64-257">強制フェールオーバー後、さらに追加で強制フェールオーバーを 1 回以上実行すると、連続する追加の強制フェールオーバーごとにログ バックアップが実行されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-257">If you follow a forced failover with one or more additional forced failovers, perform a log backup after each additional forced failover in the series.</span></span> <span data-ttu-id="7bb64-258">この理由については、「[フェールオーバーとフェールオーバー モード &#40;AlwaysOn 可用性グループ&#41;](failover-and-failover-modes-always-on-availability-groups.md)」の「強制手動フェールオーバー (データ損失の可能性あり)」の「強制フェールオーバーのリスク」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-258">For information about the reason for this, see "Risks of Forcing Failover" in the "Forced Manual Failover (with Possible Data Loss)" section of [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="7bb64-259">**ログ バックアップを実行するには**</span><span class="sxs-lookup"><span data-stu-id="7bb64-259">**To perform a log backup**</span></span>  
  
    -   [<span data-ttu-id="7bb64-260">トランザクション ログのバックアップ &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-260">Back Up a Transaction Log &#40;SQL Server&#41;</span></span>](../../../relational-databases/backup-restore/back-up-a-transaction-log-sql-server.md)  
  
##  <a name="example-scenario-using-a-forced-failover-to-recover-from-a-catastrophic-failure"></a><a name="ExampleRecoveryFromCatastrophy"></a> <span data-ttu-id="7bb64-261">サンプル シナリオ:重大なエラーから復旧するための強制フェールオーバーの使用</span><span class="sxs-lookup"><span data-stu-id="7bb64-261">Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure</span></span>  
 <span data-ttu-id="7bb64-262">プライマリ レプリカが失敗し、使用可能な同期されたセカンダリ レプリカがない場合は、可用性グループの強制フェールオーバーが適切な対応であることがあります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-262">If the primary replica fails and no synchronized secondary replica is available, forcing the availability group to fail over might be an appropriate response.</span></span> <span data-ttu-id="7bb64-263">フェールオーバーの強制が適切かどうかは、(1) プライマリ レプリカがオフラインになっている時間がサービス レベル契約 (SLA) で許容される時間よりも長くなると見込まれるかどうかと、(2) プライマリ データベースをすぐに使用できるようにする目的でデータ損失の可能性のリスクを許容できるかどうかという 2 点によって決まります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-263">The appropriateness of forcing a failover depends on: (1) whether you expect the primary replica to be offline for longer than your service level agreement (SLA) tolerates, and (2) whether you are willing to risk potential data loss in order to make primary databases available quickly.</span></span> <span data-ttu-id="7bb64-264">可用性グループに強制フェールオーバーが必要だと判断したとしても、実際の強制フェールオーバーは、複数の手順から成るプロセスの中の 1 つの手順です。</span><span class="sxs-lookup"><span data-stu-id="7bb64-264">If you decide that an availability group requires a forced failover, the actual forced failover is but one step of a multi-step process.</span></span>  
  
 <span data-ttu-id="7bb64-265">重大なエラーからの強制フェールオーバーによる復旧に必要な手順を説明するために、このトピックでは 1 つのディザスター リカバリー シナリオを示します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-265">To illustrate the steps that are required to use a forced failover to recover from a catastrophic failure, this topic presents one possible disaster recovery scenario.</span></span> <span data-ttu-id="7bb64-266">このサンプル シナリオで想定する可用性グループは、元のトポロジがメイン データ センターとリモート データ センターで構成されています。メイン データ センターは、3 つの同期コミット可用性レプリカをホストしており、これにはプライマリ レプリカが含まれています。リモート データ センターは、2 つの非同期コミット セカンダリ レプリカをホストしています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-266">The example scenario considers an availability group whose original topology consists of a main data center that hosts three synchronous-commit availability replicas, including the primary replica, and a remote data center that hosts two asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="7bb64-267">次の図は、この例の可用性グループの元のトポロジを示しています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-267">The following figure illustrates the original topology of this example availability group.</span></span> <span data-ttu-id="7bb64-268">可用性グループは、メイン データ センターに 3 つのノード (**Node 01**、 **Node 02**、および **Node 03**) があり、リモート データ センターに 2 つのノード (**Node 04** と **Node 05**) があるマルチサブネット WSFC クラスターによってホストされています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-268">The availability group is hosted by a multi-subnet WSFC cluster with three nodes in the main data center (**Node 01**, **Node 02**, and **Node 03**) and two nodes in a remote data center (**Node 04** and **Node 05**).</span></span>  
  
 <span data-ttu-id="7bb64-269">![可用性グループの元のトポロジ](../../media/aoag-failurerecovery-origtopology.gif "可用性グループの元のトポロジ")</span><span class="sxs-lookup"><span data-stu-id="7bb64-269">![Original topology of availability group](../../media/aoag-failurerecovery-origtopology.gif "Original topology of availability group")</span></span>  
  
 <span data-ttu-id="7bb64-270">メイン データ センターが、予期せずシャットダウンされました。</span><span class="sxs-lookup"><span data-stu-id="7bb64-270">The main data center shuts down unexpectedly.</span></span> <span data-ttu-id="7bb64-271">3 つの可用性レプリカがオフラインになり、データベースは使用できなくなります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-271">Its three availability replicas to go offline, and their databases become unavailable.</span></span> <span data-ttu-id="7bb64-272">次の図は、可用性グループのトポロジに対するこのエラーの影響を示しています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-272">The following figure illustrates the impact of this failure on the topology of the availability group.</span></span>  
  
 <span data-ttu-id="7bb64-273">![メイン データ センターのエラー発生後のトポロジ](../../media/aoag-failurerecovery-catastrophy.gif "メイン データ センターのエラー発生後のトポロジ")</span><span class="sxs-lookup"><span data-stu-id="7bb64-273">![Topology after failure of main data center](../../media/aoag-failurerecovery-catastrophy.gif "Topology after failure of main data center")</span></span>  
  
 <span data-ttu-id="7bb64-274">データベース管理者 (DBA) は、リモートの非同期コミット セカンダリ レプリカのいずれかに可用性グループを強制フェールオーバーすることが最善の対応であると判断しました。</span><span class="sxs-lookup"><span data-stu-id="7bb64-274">The database administrator (DBA) determines that the best possible response is to force failover of the availability group to one of the remote, asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="7bb64-275">この例では、可用性グループをリモート レプリカに強制フェールオーバーし、最終的には可用性グループを元のトポロジに戻す場合に必要な、一般的な手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-275">This example illustrates the typical steps involved when you force failover of the availability group to a remote replica and, eventually, return the availability group to its original topology.</span></span>  
  
  
###  <a name="responding-to-the-catastrophic-failure-of-the-main-data-center"></a><a name="FailureResponse"></a> <span data-ttu-id="7bb64-276">Responding to the Catastrophic Failure of the Main Data Center</span><span class="sxs-lookup"><span data-stu-id="7bb64-276">Responding to the Catastrophic Failure of the Main Data Center</span></span>  
 <span data-ttu-id="7bb64-277">次の図は、メイン データ センターでの重大なエラーに対応して、リモート データ センターで実行される一連の操作を示しています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-277">The following figure illustrates the series of actions performed at the remote data center in response a catastrophic failure at the main data center.</span></span>  
  
 <span data-ttu-id="7bb64-278">![メイン データ センターのエラーに対応する手順](../../media/aoag-failurerecovery-actions-part1.gif "メイン データ センターのエラーに対応する手順")</span><span class="sxs-lookup"><span data-stu-id="7bb64-278">![Steps for responding to failure of main data cente](../../media/aoag-failurerecovery-actions-part1.gif "Steps for responding to failure of main data cente")</span></span>  
  
 <span data-ttu-id="7bb64-279">この図の手順は、次の手順を示しています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-279">The steps in this figure indicate the following steps:</span></span>  
  
|<span data-ttu-id="7bb64-280">手順</span><span class="sxs-lookup"><span data-stu-id="7bb64-280">Step</span></span>|<span data-ttu-id="7bb64-281">アクション</span><span class="sxs-lookup"><span data-stu-id="7bb64-281">Action</span></span>|<span data-ttu-id="7bb64-282">リンク</span><span class="sxs-lookup"><span data-stu-id="7bb64-282">Links</span></span>|  
|----------|------------|-----------|  
|<span data-ttu-id="7bb64-283">**1.**</span><span class="sxs-lookup"><span data-stu-id="7bb64-283">**1.**</span></span>|<span data-ttu-id="7bb64-284">DBA またはネットワーク管理者は、WSFC クラスターに正常なクォーラムがあることを確認します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-284">The DBA or network administrator ensures that the WSFC cluster has a healthy quorum.</span></span> <span data-ttu-id="7bb64-285">この例では、クォーラムが強制される必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-285">In this example, quorum needs to be forced.</span></span>|[<span data-ttu-id="7bb64-286">WSFC クォーラム モードと投票の構成 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-286">WSFC Quorum Modes and Voting Configuration &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-quorum-modes-and-voting-configuration-sql-server.md)<br /><br /> [<span data-ttu-id="7bb64-287">WSFC の強制クォーラムによる災害復旧 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-287">WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)|  
|<span data-ttu-id="7bb64-288">**2.**</span><span class="sxs-lookup"><span data-stu-id="7bb64-288">**2.**</span></span>|<span data-ttu-id="7bb64-289">DBA は、待機時間が最も少ないサーバー インスタンス ( **Node 04**) に接続し、強制手動フェールオーバーを実行します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-289">The DBA connects to the server instance with the least latency (on **Node 04**) and performs a forced manual failover.</span></span> <span data-ttu-id="7bb64-290">強制フェールオーバーにより、このセカンダリ レプリカがプライマリ ロールに移行され、残りのセカンダリ レプリカ ( **Node 05**) のセカンダリ データベースが中断されます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-290">The forced failover transitions this secondary replica to the primary role and suspends the secondary databases on the remaining secondary replica (on **Node 05**).</span></span>|<span data-ttu-id="7bb64-291">[sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) ( **end_of_log_lsn** 列に対するクエリ)。</span><span class="sxs-lookup"><span data-stu-id="7bb64-291">[sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) (Query the **end_of_log_lsn** column.</span></span> <span data-ttu-id="7bb64-292">詳細については、このトピックの「 [推奨事項](#Recommendations)」を参照してください。)</span><span class="sxs-lookup"><span data-stu-id="7bb64-292">For more information, see [Recommendations](#Recommendations), earlier in this topic.)</span></span>|  
|<span data-ttu-id="7bb64-293">**3.**</span><span class="sxs-lookup"><span data-stu-id="7bb64-293">**3.**</span></span>|<span data-ttu-id="7bb64-294">DBA は、残りのセカンダリ レプリカの各セカンダリ データベースを手動で再開します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-294">The DBA manually resumes each of the secondary databases on the remaining secondary replica.</span></span>|[<span data-ttu-id="7bb64-295">可用性データベースの再開 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-295">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)|  
  
###  <a name="returning-the-availability-group-to-its-original-topology"></a><a name="ReturnToOrigTopology"></a> <span data-ttu-id="7bb64-296">可用性グループの元のトポロジへの復帰</span><span class="sxs-lookup"><span data-stu-id="7bb64-296">Returning the Availability Group to its Original Topology</span></span>  
 <span data-ttu-id="7bb64-297">次の図は、メイン データ センターがオンラインに戻り、WSFC ノードが WSFC クラスターとの通信を再確立した後で、可用性グループを元のトポロジに復帰させる一連の操作を示しています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-297">The following figure illustrates the series of actions that return the availability group to its original topology after the main data center comes back online and the WSFC nodes re-establish communication with the WSFC cluster.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7bb64-298">WSFC クラスター クォーラムが強制された場合、オフラインのノードは 2 つの条件が満たされれば、再開するときに新しいクォーラムを形成できます。2 つの条件とは、(a) 強制されたクォーラムのセット内のいずれのノード間にもネットワーク接続がなく、(b) 再開するノードがクラスター ノードの過半数を占めていることです。</span><span class="sxs-lookup"><span data-stu-id="7bb64-298">If the WSFC cluster quorum has been forced, as the offline nodes restart they could form a new quorum if the following conditions both exist: (a) there is no network connectivity between any of the nodes in the forced-quorum set, and (b) the restarting nodes are the majority of the cluster nodes.</span></span> <span data-ttu-id="7bb64-299">この結果として、可用性グループに 2 つの独立したプライマリ レプリカ (各データ センターに 1 つ) が含まれる、"スプリット ブレイン" 状態が発生します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-299">This would result in a "split brain" condition in which the availability group would possess two independent primary replicas, one at each data center.</span></span> <span data-ttu-id="7bb64-300">クォーラムで強制的にマイノリティ クォーラム セットを作成する前に、「 [WSFC の強制クォーラムによる災害復旧 &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)の PowerShell を使用して、AlwaysOn 可用性グループに対する強制フェールオーバー (データ損失の可能性あり) を実行する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-300">Before forcing quorum to create a minority quorum set, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
 <span data-ttu-id="7bb64-301">![グループを元のトポロジへ復帰する手順](../../media/aoag-failurerecovery-actions-part2.gif "グループを元のトポロジへ復帰する手順")</span><span class="sxs-lookup"><span data-stu-id="7bb64-301">![Steps to return the group to its original topology](../../media/aoag-failurerecovery-actions-part2.gif "Steps to return the group to its original topology")</span></span>  
  
 <span data-ttu-id="7bb64-302">この図の手順は、次の手順を示しています。</span><span class="sxs-lookup"><span data-stu-id="7bb64-302">The steps in this figure indicate the following steps:</span></span>  
  
||<span data-ttu-id="7bb64-303">手順</span><span class="sxs-lookup"><span data-stu-id="7bb64-303">Step</span></span>|<span data-ttu-id="7bb64-304">リンク</span><span class="sxs-lookup"><span data-stu-id="7bb64-304">Links</span></span>|  
|-|----------|-----------|  
|<span data-ttu-id="7bb64-305">**1.**</span><span class="sxs-lookup"><span data-stu-id="7bb64-305">**1.**</span></span>|<span data-ttu-id="7bb64-306">メイン データ センターのノードがオンラインに戻り、WSFC クラスターとの通信を再確立します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-306">The nodes in the main data center come back online and re-establish communication with the WSFC cluster.</span></span> <span data-ttu-id="7bb64-307">その可用性レプリカは、中断されたデータベースと共にセカンダリ レプリカとしてオンラインに戻り、DBA は直ちに手動で各データベースを再開する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-307">Their availability replicas come online as secondary replicas with suspended databases, and the DBA will need to manually resume each of these databases soon.</span></span>|[<span data-ttu-id="7bb64-308">可用性データベースの再開 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-308">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)<br /><br /> <span data-ttu-id="7bb64-309">ヒント:フェールオーバー後のプライマリ データベースでデータ損失の可能性が懸念される場合は、同期コミットのセカンダリ データベースの 1 つで、中断されたデータベースにデータベース スナップショットの作成を試みる必要があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-309">Tip: If you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one the synchronous-commit secondary database.</span></span> <span data-ttu-id="7bb64-310">プライマリ データベースでは、いずれかのセカンダリ データベースが中断している間、トランザクション ログの切り捨てが遅延されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="7bb64-310">Keep in mind that the transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="7bb64-311">また、同期コミット セカンダリ レプリカの同期状態は、いずれかのローカル データベースが中断している間、HEALTHY に移行できません。</span><span class="sxs-lookup"><span data-stu-id="7bb64-311">Also the synchronization health of the synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>|  
|<span data-ttu-id="7bb64-312">**2.**</span><span class="sxs-lookup"><span data-stu-id="7bb64-312">**2.**</span></span>|<span data-ttu-id="7bb64-313">データベースが再開されたら、DBA は新しいプライマリ レプリカを一時的に同期コミット モードに変更します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-313">Once the databases are resumed, the DBA changes the new primary replica to synchronous-commit mode temporarily.</span></span> <span data-ttu-id="7bb64-314">これには、次の 2 つの手順があります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-314">This involves two steps:</span></span><br /><br /> <span data-ttu-id="7bb64-315">1) 1 つのオフライン可用性レプリカを非同期コミット モードに変更する。</span><span class="sxs-lookup"><span data-stu-id="7bb64-315">1) Change one offline availability replica to asynchronous-commit mode.</span></span> <br /><span data-ttu-id="7bb64-316">2) 新しいプライマリ レプリカを同期コミット モードに変更する。</span><span class="sxs-lookup"><span data-stu-id="7bb64-316">2) Change the new primary replica to synchronous-commit mode.</span></span><br /><span data-ttu-id="7bb64-317">注:この手順により、再開された同期コミット セカンダリ データベースを SYNCHRONIZED にすることができます。</span><span class="sxs-lookup"><span data-stu-id="7bb64-317">Note: This step enables resumed synchronous-commit secondary databases to become SYNCHRONIZED.</span></span>|[<span data-ttu-id="7bb64-318">可用性レプリカの可用性モードの変更 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-318">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
|<span data-ttu-id="7bb64-319">**3.**</span><span class="sxs-lookup"><span data-stu-id="7bb64-319">**3.**</span></span>|<span data-ttu-id="7bb64-320">**Node 03** の同期コミット セカンダリ レプリカ (元のプライマリ レプリカ) が HEALTHY 同期状態になったら、DBA はそのレプリカに計画的な手動フェールオーバーを実行して、プライマリ レプリカに戻します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-320">Once the synchronous-commit secondary replica on **Node 03** (the original primary replica) enters the HEALTHY synchronization state, the DBA performs a planned manual failover to that replica, to make it the primary replica again.</span></span> <span data-ttu-id="7bb64-321">**Node 04** のレプリカは、セカンダリ レプリカに戻ります。</span><span class="sxs-lookup"><span data-stu-id="7bb64-321">The replica on **Node 04** returns to being a secondary replica.</span></span>|[<span data-ttu-id="7bb64-322">sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-322">sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql)<br /><br /> [<span data-ttu-id="7bb64-323">AlwaysOn ポリシーを使用して、可用性グループ &#40;SQL Server の正常性を表示&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-323">Use AlwaysOn Policies to View the Health of an Availability Group &#40;SQL Server&#41;</span></span>](use-always-on-policies-to-view-the-health-of-an-availability-group-sql-server.md)<br /><br /> [<span data-ttu-id="7bb64-324">可用性グループの計画的な手動フェールオーバーの実行 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-324">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)|  
|<span data-ttu-id="7bb64-325">**4.**</span><span class="sxs-lookup"><span data-stu-id="7bb64-325">**4.**</span></span>|<span data-ttu-id="7bb64-326">DBA は、新しいプライマリ レプリカに接続し、次の操作を行います。</span><span class="sxs-lookup"><span data-stu-id="7bb64-326">The DBA connects to the new primary replica and:</span></span><br /><br /> <span data-ttu-id="7bb64-327">1) 元のプライマリ レプリカ (リモート センター内) を非同期コミット モードに戻します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-327">1) Changes the former primary replica (in the remote center) back to asynchronous-commit mode.</span></span><br /><span data-ttu-id="7bb64-328">2) メイン データ センターの非同期コミット セカンダリ レプリカを同期コミット モードに戻します。</span><span class="sxs-lookup"><span data-stu-id="7bb64-328">2) Changes the asynchronous-commit secondary replica in the main data center back to synchronous-commit mode.</span></span>|[<span data-ttu-id="7bb64-329">可用性レプリカの可用性モードの変更 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-329">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="7bb64-330">関連タスク</span><span class="sxs-lookup"><span data-stu-id="7bb64-330">Related Tasks</span></span>  
 <span data-ttu-id="7bb64-331">**クォーラム投票を調整するには:**</span><span class="sxs-lookup"><span data-stu-id="7bb64-331">**To adjust quorum votes**</span></span>  
  
-   [<span data-ttu-id="7bb64-332">クラスター クォーラムの NodeWeight 設定を表示</span><span class="sxs-lookup"><span data-stu-id="7bb64-332">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="7bb64-333">クラスター クォーラムの NodeWeight の設定の構成</span><span class="sxs-lookup"><span data-stu-id="7bb64-333">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="7bb64-334">クォーラムを使用せずに WSFC クラスターを強制的に起動する</span><span class="sxs-lookup"><span data-stu-id="7bb64-334">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
 <span data-ttu-id="7bb64-335">**計画的な手動フェールオーバー:**</span><span class="sxs-lookup"><span data-stu-id="7bb64-335">**Planned manual failover:**</span></span>  
  
-   [<span data-ttu-id="7bb64-336">可用性グループの計画的な手動フェールオーバーの実行 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-336">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)  
  
-   [<span data-ttu-id="7bb64-337">可用性グループのフェールオーバー ウィザードの使用 &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-337">Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;</span></span>](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)  
  
 <span data-ttu-id="7bb64-338">**トラブルシューティングするには:**</span><span class="sxs-lookup"><span data-stu-id="7bb64-338">**To troubleshoot:**</span></span>  
  
-   [<span data-ttu-id="7bb64-339">AlwaysOn 可用性グループ構成 &#40;SQL Server のトラブルシューティング&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-339">Troubleshoot AlwaysOn Availability Groups Configuration &#40;SQL Server&#41;</span></span>](troubleshoot-always-on-availability-groups-configuration-sql-server.md) 
  
-   [<span data-ttu-id="7bb64-340">失敗したファイルの追加操作のトラブルシューティング &#40;AlwaysOn 可用性グループ&#41;</span><span class="sxs-lookup"><span data-stu-id="7bb64-340">Troubleshoot a Failed Add-File Operation &#40;AlwaysOn Availability Groups&#41;</span></span>](troubleshoot-a-failed-add-file-operation-always-on-availability-groups.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="7bb64-341">関連コンテンツ</span><span class="sxs-lookup"><span data-stu-id="7bb64-341">Related Content</span></span>  
  
-   <span data-ttu-id="7bb64-342">**ブログ:**</span><span class="sxs-lookup"><span data-stu-id="7bb64-342">**Blogs:**</span></span>  
  
     [<span data-ttu-id="7bb64-343">SQL Server AlwaysOn チームのブログ:SQL Server AlwaysOn チームのオフィシャル ブログ</span><span class="sxs-lookup"><span data-stu-id="7bb64-343">SQL Server AlwaysOn Team Blogs: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)  
  
     [<span data-ttu-id="7bb64-344">CSS SQL Server エンジニアのブログ</span><span class="sxs-lookup"><span data-stu-id="7bb64-344">CSS SQL Server Engineers Blogs</span></span>](https://blogs.msdn.com/b/psssql/)  
  
-   <span data-ttu-id="7bb64-345">**ホワイト ペーパー:**</span><span class="sxs-lookup"><span data-stu-id="7bb64-345">**Whitepapers:**</span></span>  
  
     [<span data-ttu-id="7bb64-346">高可用性と災害復旧のための Microsoft SQL Server AlwaysOn ソリューション ガイド</span><span class="sxs-lookup"><span data-stu-id="7bb64-346">Microsoft SQL Server AlwaysOn Solutions Guide for High Availability and Disaster Recovery</span></span>](https://go.microsoft.com/fwlink/?LinkId=227600)  
  
     [<span data-ttu-id="7bb64-347">SQL Server 2012 に関する Microsoft ホワイト ペーパー</span><span class="sxs-lookup"><span data-stu-id="7bb64-347">Microsoft White Papers for SQL Server 2012</span></span>](https://msdn.microsoft.com/library/hh403491.aspx)  
  
     [<span data-ttu-id="7bb64-348">SQL Server ユーザー諮問チームのホワイト ペーパー</span><span class="sxs-lookup"><span data-stu-id="7bb64-348">SQL Server Customer Advisory Team Whitepapers</span></span>](http://sqlcat.com/)  
  
## <a name="see-also"></a><span data-ttu-id="7bb64-349">参照</span><span class="sxs-lookup"><span data-stu-id="7bb64-349">See Also</span></span>  
 <span data-ttu-id="7bb64-350">[AlwaysOn 可用性グループ &#40;SQL Server の概要&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7bb64-350">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="7bb64-351">[可用性モード &#40;AlwaysOn 可用性グループ&#41;](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="7bb64-351">[Availability Modes &#40;AlwaysOn Availability Groups&#41;](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="7bb64-352">[フェールオーバーとフェールオーバーモード &#40;AlwaysOn 可用性グループ&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="7bb64-352">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="7bb64-353">[可用性レプリカに対するクライアント接続アクセスについて &#40;SQL Server&#41;](about-client-connection-access-to-availability-replicas-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7bb64-353">[About Client Connection Access to Availability Replicas &#40;SQL Server&#41;](about-client-connection-access-to-availability-replicas-sql-server.md) </span></span>  
 <span data-ttu-id="7bb64-354">[可用性グループの監視 &#40;SQL Server&#41;](monitoring-of-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7bb64-354">[Monitoring of Availability Groups &#40;SQL Server&#41;](monitoring-of-availability-groups-sql-server.md) </span></span>  
 [<span data-ttu-id="7bb64-355">Windows Server フェールオーバー クラスタリング &#40;WSFC&#41; と SQL Server</span><span class="sxs-lookup"><span data-stu-id="7bb64-355">Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server</span></span>](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md)  
  
  
