---
title: 実行準備 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- deferred statement preparation
- prepared execution [ODBC]
- SQLPrepare function
- ODBC applications, statements
- SQLExecute function
- statements [ODBC], prepared execution
ms.assetid: f3a9d32b-6cd7-4f0c-b38d-c8ccc4ee40c3
author: rothja
ms.author: jroth
ms.openlocfilehash: 33ab9f35cd9d3eaf04e688a89390b5eb3f00ae58
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87631864"
---
# <a name="prepared-execution"></a><span data-ttu-id="14cdf-102">準備実行</span><span class="sxs-lookup"><span data-stu-id="14cdf-102">Prepared Execution</span></span>
  <span data-ttu-id="14cdf-103">ODBC API では、準備実行とは、[!INCLUDE[tsql](../../../includes/tsql-md.md)] ステートメントを繰り返し実行する際に関連して生じる解析やコンパイルのオーバーヘッドを削減する方法と定義されています。</span><span class="sxs-lookup"><span data-stu-id="14cdf-103">The ODBC API defines prepared execution as a way to reduce the parsing and compiling overhead associated with repeatedly executing a [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span> <span data-ttu-id="14cdf-104">アプリケーションでは SQL ステートメントを保持する文字列を構築してから、そのステートメントを 2 段階に分けて実行します。</span><span class="sxs-lookup"><span data-stu-id="14cdf-104">The application builds a character string containing an SQL statement and then executes it in two stages.</span></span> <span data-ttu-id="14cdf-105">[SQLPrepare 関数](https://go.microsoft.com/fwlink/?LinkId=59360)を1回呼び出して、ステートメントが解析され、によって実行プランにコンパイルされるようにし [!INCLUDE[ssDE](../../../includes/ssde-md.md)] ます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-105">It calls [SQLPrepare Function](https://go.microsoft.com/fwlink/?LinkId=59360) once to have the statement parsed and compiled into an execution plan by the [!INCLUDE[ssDE](../../../includes/ssde-md.md)].</span></span> <span data-ttu-id="14cdf-106">次に、準備された実行プランの各実行に対して**Sqlexecute**を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="14cdf-106">It then calls **SQLExecute** for each execution of the prepared execution plan.</span></span> <span data-ttu-id="14cdf-107">この方法では、各実行にかかる解析とコンパイルのオーバーヘッドが抑制されます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-107">This saves the parsing and compiling overhead on each execution.</span></span> <span data-ttu-id="14cdf-108">準備実行は、通常、同一のパラメーター化された SQL ステートメントを繰り返し実行するアプリケーションで使用されます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-108">Prepared execution is commonly used by applications to repeatedly execute the same, parameterized SQL statement.</span></span>  
  
 <span data-ttu-id="14cdf-109">ほとんどのデータベースでは、直接実行されるステートメントが実行のたびにコンパイルされるのに対し、準備実行されるステートメントは 1 回だけコンパイルされるので、準備実行は主に 4、5 回以上実行されるステートメントの場合は直接実行よりも高速になります。</span><span class="sxs-lookup"><span data-stu-id="14cdf-109">For most databases, prepared execution is faster than direct execution for statements executed more than three or four times primarily because the statement is compiled only once, while statements executed directly are compiled each time they are executed.</span></span> <span data-ttu-id="14cdf-110">準備実行では、SQL ステートメントが実行されるたびに、ドライバーはステートメント全体ではなく、実行プランの識別子とパラメーター値だけをデータ ソースに送信できるので、ネットワーク トラフィックも削減できます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-110">Prepared execution can also provide a reduction in network traffic because the driver can send an execution plan identifier and the parameter values, rather than an entire SQL statement, to the data source each time the statement is executed.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="14cdf-111">**SQLExecDirect**から実行プランを検出して再利用するための強化されたアルゴリズムにより、直接実行と準備実行のパフォーマンスの差異を軽減します。</span><span class="sxs-lookup"><span data-stu-id="14cdf-111">reduces the performance difference between direct and prepared execution through improved algorithms for detecting and reusing execution plans from **SQLExecDirect**.</span></span> <span data-ttu-id="14cdf-112">そのため、直接実行されるステートメントでも、準備実行のパフォーマンス上の利点の一部を利用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="14cdf-112">This makes some of the performance benefits of prepared execution available to statements executed directly.</span></span> <span data-ttu-id="14cdf-113">詳細については、「[直接実行](direct-execution.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="14cdf-113">For more information, see [Direct Execution](direct-execution.md).</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="14cdf-114">では、準備実行がネイティブにサポートされます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-114">also provides native support for prepared execution.</span></span> <span data-ttu-id="14cdf-115">実行プランは**SQLPrepare**上に構築され、後で**sqlexecute**が呼び出されたときに実行されます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-115">An execution plan is built on **SQLPrepare** and later executed when **SQLExecute** is called.</span></span> <span data-ttu-id="14cdf-116">で [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] は、 **SQLPrepare**で一時ストアドプロシージャを構築する必要がないため、 **tempdb**のシステムテーブルに余分なオーバーヘッドが発生することはありません。</span><span class="sxs-lookup"><span data-stu-id="14cdf-116">Because [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is not required to build temporary stored procedures on **SQLPrepare**, there is no extra overhead on the system tables in **tempdb**.</span></span>  
  
 <span data-ttu-id="14cdf-117">パフォーマンス上の理由から、 **Sqlexecute**が呼び出されるか、メタプロパティ操作 (ODBC での[SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md)や[SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md)など) が実行されるまで、ステートメントの準備は遅延されます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-117">For performance reasons, the statement preparation is deferred until **SQLExecute** is called or a metaproperty operation (such as [SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md) or [SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md) in ODBC) is performed.</span></span> <span data-ttu-id="14cdf-118">これは既定の動作です。</span><span class="sxs-lookup"><span data-stu-id="14cdf-118">This is the default behavior.</span></span> <span data-ttu-id="14cdf-119">準備されているステートメントのエラーは、ステートメントまたはメタプロパティ操作が実行されるまでわかりません。</span><span class="sxs-lookup"><span data-stu-id="14cdf-119">Any errors in the statement being prepared are not known until the statement is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="14cdf-120">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC ドライバー固有のステートメント属性の SQL_SOPT_SS_DEFER_PREPARE を SQL_DP_OFF に設定することで、この既定の動作を無効にできます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-120">Setting the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver-specific statement attribute SQL_SOPT_SS_DEFER_PREPARE to SQL_DP_OFF can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="14cdf-121">準備の遅延が発生した場合、 **Sqlexecute**を呼び出す前に**SQLDescribeCol**または**SQLDescribeParam**を呼び出すと、サーバーへの追加のラウンドトリップが生成されます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-121">In case of deferred prepare, calling either **SQLDescribeCol** or **SQLDescribeParam** before calling **SQLExecute** generates an extra roundtrip to the server.</span></span> <span data-ttu-id="14cdf-122">**SQLDescribeCol**では、ドライバーはクエリから WHERE 句を削除し、SET FMTONLY ON を使用してサーバーに送信します。これにより、クエリによって返される最初の結果セットの列の説明が取得されます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-122">On **SQLDescribeCol**, the driver removes the WHERE clause from the query and sends it to the server with SET FMTONLY ON to get the description of the columns in the first result set returned by the query.</span></span> <span data-ttu-id="14cdf-123">**SQLDescribeParam**では、ドライバーはサーバーを呼び出して、クエリ内の任意のパラメーターマーカーによって参照される式または列の説明を取得します。</span><span class="sxs-lookup"><span data-stu-id="14cdf-123">On **SQLDescribeParam**, the driver calls the server to get a description of the expressions or columns referenced by any parameter markers in the query.</span></span> <span data-ttu-id="14cdf-124">この方法には、サブクエリのパラメーターを解決することができないなど、いくつか制限事項もあります。</span><span class="sxs-lookup"><span data-stu-id="14cdf-124">This method also has some restrictions, such as not being able to resolve parameters in subqueries.</span></span>  
  
 <span data-ttu-id="14cdf-125">Native Client ODBC ドライバーで**SQLPrepare**を過度に使用する [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] と、特に以前のバージョンの SQL Server に接続している場合に、パフォーマンスが低下します。</span><span class="sxs-lookup"><span data-stu-id="14cdf-125">Excess use of **SQLPrepare** with the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver degrades performance, especially when connected to earlier versions of SQL Server.</span></span> <span data-ttu-id="14cdf-126">準備実行は、1 回しか実行されないステートメントには使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="14cdf-126">Prepared execution should not be used for statements executed a single time.</span></span> <span data-ttu-id="14cdf-127">準備実行では、クライアントからサーバーへのネットワーク上のやり取りを余分に実行する必要があるため、ステートメントを 1 回しか実行しない場合は直接実行よりも時間がかかります。</span><span class="sxs-lookup"><span data-stu-id="14cdf-127">Prepared execution is slower than direct execution for a single execution of a statement because it requires an extra network roundtrip from the client to the server.</span></span> <span data-ttu-id="14cdf-128">以前のバージョンの [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] では、準備実行で一時ストアド プロシージャの生成も行います。</span><span class="sxs-lookup"><span data-stu-id="14cdf-128">On earlier versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] it also generates a temporary stored procedure.</span></span>  
  
 <span data-ttu-id="14cdf-129">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] では、準備されたステートメントを使用して一時オブジェクトを作成することはできません。</span><span class="sxs-lookup"><span data-stu-id="14cdf-129">Prepared statements cannot be used to create temporary objects on [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="14cdf-130">一部の初期 ODBC アプリケーションでは、 [SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md)を使用したときに**SQLPrepare**が使用されていました。</span><span class="sxs-lookup"><span data-stu-id="14cdf-130">Some early ODBC applications used **SQLPrepare** any time [SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md) was used.</span></span> <span data-ttu-id="14cdf-131">**SQLBindParameter**では、 **SQLPrepare**を使用する必要はありません。 **SQLExecDirect**と共に使用できます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-131">**SQLBindParameter** does not require the use of **SQLPrepare**, it can be used with **SQLExecDirect**.</span></span> <span data-ttu-id="14cdf-132">たとえば、 **SQLExecDirect**を**SQLBindParameter**と共に使用すると、ストアドプロシージャから返されるリターンコードまたは出力パラメーターが1回だけ実行されます。</span><span class="sxs-lookup"><span data-stu-id="14cdf-132">For example, use **SQLExecDirect** with **SQLBindParameter** to retrieve the return code or output parameters from a stored procedure that is only executed one time.</span></span> <span data-ttu-id="14cdf-133">同じステートメントが複数回実行される場合を除き、 **SQLPrepare**と**SQLBindParameter**を同時に使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="14cdf-133">Do not use **SQLPrepare** with **SQLBindParameter** unless the same statement will be executed multiple times.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="14cdf-134">参照</span><span class="sxs-lookup"><span data-stu-id="14cdf-134">See Also</span></span>  
 [<span data-ttu-id="14cdf-135">ODBC&#41;&#40;のステートメントの実行</span><span class="sxs-lookup"><span data-stu-id="14cdf-135">Executing Statements &#40;ODBC&#41;</span></span>](executing-statements-odbc.md)  
  
  
