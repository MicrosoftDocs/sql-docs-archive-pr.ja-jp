---
title: CLR ユーザー定義集計の要件 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 8123f8324d43212007857dbb596a4fc61872bd2e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87641693"
---
# <a name="requirements-for-clr-user-defined-aggregates"></a><span data-ttu-id="4d3b9-102">CLR ユーザー定義集計の要件</span><span class="sxs-lookup"><span data-stu-id="4d3b9-102">Requirements for CLR User-Defined Aggregates</span></span>
  <span data-ttu-id="4d3b9-103">CLR (共通言語ランタイム) アセンブリの型は、必要な集計コントラクトが実装されていれば、ユーザー定義集計関数として登録できます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-103">A type in a common language runtime (CLR) assembly can be registered as a user-defined aggregate function, as long as it implements the required aggregation contract.</span></span> <span data-ttu-id="4d3b9-104">このコントラクトは、`SqlUserDefinedAggregate` 属性と集計コントラクトのメソッドで構成されます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-104">This contract consists of the `SqlUserDefinedAggregate` attribute and the aggregation contract methods.</span></span> <span data-ttu-id="4d3b9-105">集計コントラクトには、集計の中間状態を保存するためのメカニズムと、`Init`、`Accumulate`、`Merge`、および `Terminate` の 4 つのメソッドで構成される新しい値を積算するメカニズムが含まれます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-105">The aggregation contract includes the mechanism to save the intermediate state of the aggregation, and the mechanism to accumulate new values, which consists of four methods: `Init`, `Accumulate`, `Merge`, and `Terminate`.</span></span> <span data-ttu-id="4d3b9-106">これらの要件を満たしている場合は、でユーザー定義集計を最大限に活用することができ [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-106">When you have met these requirements, you will be able to take full advantage of user-defined aggregates in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="4d3b9-107">このトピックの次のセクションでは、ユーザー定義集計を作成し、そのユーザー定義集計を使用して作業する方法について詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-107">The following sections of this topic provide additional details about how to create and work with user-defined aggregates.</span></span> <span data-ttu-id="4d3b9-108">例については、「 [CLR ユーザー定義集計関数の呼び出し](clr-user-defined-aggregate-invoking-functions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-108">For an example, see [Invoking CLR User-Defined Aggregate Functions](clr-user-defined-aggregate-invoking-functions.md).</span></span>  
  
## <a name="sqluserdefinedaggregate"></a><span data-ttu-id="4d3b9-109">SqlUserDefinedAggregate</span><span class="sxs-lookup"><span data-stu-id="4d3b9-109">SqlUserDefinedAggregate</span></span>  
 <span data-ttu-id="4d3b9-110">詳細については、「 [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-110">For more information, see [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span></span>  
  
## <a name="aggregation-methods"></a><span data-ttu-id="4d3b9-111">集計のメソッド</span><span class="sxs-lookup"><span data-stu-id="4d3b9-111">Aggregation Methods</span></span>  
 <span data-ttu-id="4d3b9-112">ユーザー定義集計として登録するクラスでは、次のインスタンス メソッドをサポートする必要があります。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-112">The class registered as a user-defined aggregate should support the following instance methods.</span></span> <span data-ttu-id="4d3b9-113">次に、集計を計算するためにクエリ プロセッサで使用されるメソッドを示します。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-113">These are the methods that the query processor uses to compute the aggregation:</span></span>  
  
|<span data-ttu-id="4d3b9-114">メソッド</span><span class="sxs-lookup"><span data-stu-id="4d3b9-114">Method</span></span>|<span data-ttu-id="4d3b9-115">構文</span><span class="sxs-lookup"><span data-stu-id="4d3b9-115">Syntax</span></span>|<span data-ttu-id="4d3b9-116">説明</span><span class="sxs-lookup"><span data-stu-id="4d3b9-116">Description</span></span>|  
|------------|------------|-----------------|  
|`Init`|<span data-ttu-id="4d3b9-117">public void Init ();</span><span class="sxs-lookup"><span data-stu-id="4d3b9-117">public void Init();</span></span>|<span data-ttu-id="4d3b9-118">クエリ プロセッサは、このメソッドを使用して集計計算を初期化します。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-118">The query processor uses this method to initialize the computation of the aggregation.</span></span> <span data-ttu-id="4d3b9-119">このメソッドは、クエリ プロセッサで集計されるグループごとに 1 回ずつ呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-119">This method is invoked once for each group that the query processor is aggregating.</span></span> <span data-ttu-id="4d3b9-120">クエリ プロセッサでは、複数のグループの集計を計算するために、集計クラスの同じインスタンスの再利用を選択することがあります。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-120">The query processor may choose to reuse the same instance of the aggregate class for computing aggregates of multiple groups.</span></span> <span data-ttu-id="4d3b9-121">`Init` メソッドは、現在のインスタンスが以前に使用されていれば必要になるクリーンアップを実行し、新たな集計計算を再開できるようにします。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-121">The `Init` method should perform any clean-up as necessary from previous uses of this instance, and enable it to re-start a new aggregate computation.</span></span>|  
|`Accumulate`|<span data-ttu-id="4d3b9-122">public void 累積 (入力型の値 [, 入力型の値,...]);</span><span class="sxs-lookup"><span data-stu-id="4d3b9-122">public void Accumulate ( input-type value[, input-type value, ...]);</span></span>|<span data-ttu-id="4d3b9-123">関数のパラメーターを表す 1 つ以上のパラメーター。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-123">One or more parameters representing the parameters of the function.</span></span> <span data-ttu-id="4d3b9-124">*input_type*は、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ステートメントで*input_sqltype*によって指定されたネイティブデータ型に相当するマネージデータ型である必要があり `CREATE AGGREGATE` ます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-124">*input_type* should be the managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type equivalent to the native [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type specified by *input_sqltype* in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="4d3b9-125">詳細については、「 [CLR パラメーターデータのマッピング](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-125">For more information, see [Mapping CLR Parameter Data](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span></span><br /><br /> <span data-ttu-id="4d3b9-126">UDT (ユーザー定義型) の場合、input-type 型は UDT 型と同じです。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-126">For user-defined types (UDTs), the input-type is the same as the UDT type.</span></span> <span data-ttu-id="4d3b9-127">クエリ プロセッサでは、このメソッドを使用して集計値を積算します。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-127">The query processor uses this method to accumulate the aggregate values.</span></span> <span data-ttu-id="4d3b9-128">このメソッドは、集計されるグループの値ごとに 1 回ずつ呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-128">This is invoked once for each value in the group that is being aggregated.</span></span> <span data-ttu-id="4d3b9-129">クエリ プロセッサでは、集計クラスの特定のインスタンスの `Init` メソッドが呼び出された後にのみ、常に、このメソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-129">The query processor always calls this only after calling the `Init` method on the given instance of the aggregate-class.</span></span> <span data-ttu-id="4d3b9-130">このメソッドの実装では、渡された引数値の積算を反映してインスタンスの状態を更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-130">The implementation of this method should update the state of the instance to reflect the accumulation of the argument value being passed in.</span></span>|  
|`Merge`|<span data-ttu-id="4d3b9-131">public void Merge (udagg_class 値);</span><span class="sxs-lookup"><span data-stu-id="4d3b9-131">public void Merge( udagg_class value);</span></span>|<span data-ttu-id="4d3b9-132">このメソッドは、この集計クラスの別のインスタンスを現在のインスタンスとマージする場合に使用できます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-132">This method can be used to merge another instance of this aggregate class with the current instance.</span></span> <span data-ttu-id="4d3b9-133">クエリ プロセッサでは、このメソッドを使用して、1 つの集計の複数の部分計算をマージできます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-133">The query processor uses this method to merge multiple partial computations of an aggregation.</span></span>|  
|`Terminate`|<span data-ttu-id="4d3b9-134">パブリック return_type 終了 ();</span><span class="sxs-lookup"><span data-stu-id="4d3b9-134">public return_type Terminate();</span></span>|<span data-ttu-id="4d3b9-135">このメソッドは、集計計算を完了し、集計の結果を返します。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-135">This method completes the aggregate computation and returns the result of the aggregation.</span></span> <span data-ttu-id="4d3b9-136">*Return_type*は、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ステートメントで指定された*return_sqltype*と同等のマネージデータ型である必要があり `CREATE AGGREGATE` ます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-136">The *return_type* should be a managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type that is the managed equivalent of *return_sqltype* specified in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="4d3b9-137">*Return_type*は、ユーザー定義型でもかまいません。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-137">The *return_type* can also be a user-defined type.</span></span>|  
  
### <a name="table-valued-parameters"></a><span data-ttu-id="4d3b9-138">テーブル値パラメーター</span><span class="sxs-lookup"><span data-stu-id="4d3b9-138">Table-Valued Parameters</span></span>  
 <span data-ttu-id="4d3b9-139">テーブル値パラメーター (TVP) とは、プロシージャや関数に渡されるユーザー定義のテーブル型です。TVP を使用すると、複数行のデータを効率的にサーバーに渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-139">Table-valued parameters (TVPs), user-defined table types that are passed into a procedure or function, provide an efficient way to pass multiple rows of data to the server.</span></span> <span data-ttu-id="4d3b9-140">TVP の機能はパラメーター配列に似ていますが、より柔軟性が高く、[!INCLUDE[tsql](../../includes/tsql-md.md)] との統合も緊密です。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-140">TVPs provide similar functionality to parameter arrays, but offer greater flexibility and closer integration with [!INCLUDE[tsql](../../includes/tsql-md.md)].</span></span> <span data-ttu-id="4d3b9-141">テーブル値パラメーターを使用するとパフォーマンスが向上する可能性もあります。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-141">They also provide the potential for better performance.</span></span> <span data-ttu-id="4d3b9-142">また、サーバーへのラウンド トリップを減らすのにも役立ちます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-142">TVPs also help reduce the number of round trips to the server.</span></span> <span data-ttu-id="4d3b9-143">スカラー パラメーターのリストを使用するなどしてサーバーに複数の要求を送信する代わりに、データを TVP としてサーバーに送信できます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-143">Instead of sending multiple requests to the server, such as with a list of scalar parameters, data can be sent to the server as a TVP.</span></span> <span data-ttu-id="4d3b9-144">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のプロセスで実行されているマネージド ストアド プロシージャやマネージド関数にユーザー定義のテーブル型をテーブル値パラメーターとして渡したり、戻り値として受け取ったりすることはできません。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-144">A user-defined table type cannot be passed as a table-valued parameter to, or be returned from, a managed stored procedure or function executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process.</span></span> <span data-ttu-id="4d3b9-145">また、TVP はコンテキスト接続のスコープ内では使用できません。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-145">Also, TVPs cannot be used within the scope of a context connection.</span></span> <span data-ttu-id="4d3b9-146">ただし、コンテキスト接続ではない接続で使用されている SqlClient を使用すると、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のプロセスで実行されているマネージド ストアド プロシージャやマネージド関数で TVP を使用できます。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-146">However, a TVP can be used with SqlClient in managed stored procedures or functions executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process, if it is used in a connection that is not a context connection.</span></span> <span data-ttu-id="4d3b9-147">その接続は、マネージド プロシージャやマネージド関数を実行しているのと同じサーバーへの接続でかまいません。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-147">The connection can be to the same server that is executing the managed procedure or function.</span></span> <span data-ttu-id="4d3b9-148">Tvp の詳細については、「[データベースエンジン&#41;&#40;テーブル値パラメーターの使用](../tables/use-table-valued-parameters-database-engine.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-148">For more information about TVPs, see [Use Table-Valued Parameters &#40;Database Engine&#41;](../tables/use-table-valued-parameters-database-engine.md).</span></span>  
  
## <a name="change-history"></a><span data-ttu-id="4d3b9-149">変更履歴</span><span class="sxs-lookup"><span data-stu-id="4d3b9-149">Change History</span></span>  
  
|<span data-ttu-id="4d3b9-150">変更内容</span><span class="sxs-lookup"><span data-stu-id="4d3b9-150">Updated content</span></span>|  
|---------------------|  
|<span data-ttu-id="4d3b9-151">`Accumulate` メソッドの説明を更新しました。このメソッドは、現在は複数のパラメーターを受け取ります。</span><span class="sxs-lookup"><span data-stu-id="4d3b9-151">Updated the description of the `Accumulate` method; it now accepts more than one parameter.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="4d3b9-152">参照</span><span class="sxs-lookup"><span data-stu-id="4d3b9-152">See Also</span></span>  
 <span data-ttu-id="4d3b9-153">[CLR ユーザー定義型](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span><span class="sxs-lookup"><span data-stu-id="4d3b9-153">[CLR User-Defined Types](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span></span>  
 [<span data-ttu-id="4d3b9-154">CLR ユーザー定義集計関数の呼び出し</span><span class="sxs-lookup"><span data-stu-id="4d3b9-154">Invoking CLR User-Defined Aggregate Functions</span></span>](clr-user-defined-aggregate-invoking-functions.md)  
  
  
