---
title: 空間インデックスの概要 | Microsoft Docs
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- spatial indexes [SQL Server]
ms.assetid: b1ae7b78-182a-459e-ab28-f743e43f8293
author: MladjoA
ms.author: mlandzic
ms.openlocfilehash: 36406bd60b4204469aca3d20862020870a8832fe
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87642023"
---
# <a name="spatial-indexes-overview"></a><span data-ttu-id="7c36a-102">空間インデックスの概要</span><span class="sxs-lookup"><span data-stu-id="7c36a-102">Spatial Indexes Overview</span></span>
  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="7c36a-103">では、空間データと空間インデックスがサポートされています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-103">supports spatial data and spatial indexes.</span></span> <span data-ttu-id="7c36a-104">*空間インデックス* は拡張インデックスの一種で、空間列にインデックスを設定することができます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-104">A *spatial index* is a type of extended index that allows you to index a spatial column.</span></span> <span data-ttu-id="7c36a-105">空間列とは、空間データ型 (`geometry` や `geography` など) のデータを含むテーブル列です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-105">A spatial column is a table column that contains data of a spatial data type, such as `geometry` or `geography`.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="7c36a-106">空間インデックスに影響を及ぼす機能を含め、 [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]で導入された空間機能の詳細な説明とサンプルについては、ホワイト ペーパー『 [New Spatial Features in SQL Server 2012 (SQL Server 2012 の新しい空間機能)](https://go.microsoft.com/fwlink/?LinkId=226407)』をダウンロードしてご覧ください。</span><span class="sxs-lookup"><span data-stu-id="7c36a-106">For a detailed description and examples of spatial features introduced in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], including features that affect spatial indexes, download the white paper, [New Spatial Features in SQL Server 2012](https://go.microsoft.com/fwlink/?LinkId=226407).</span></span>

##  <a name="about-spatial-indexes"></a><a name="about"></a> <span data-ttu-id="7c36a-107">空間インデックスについて</span><span class="sxs-lookup"><span data-stu-id="7c36a-107">About Spatial Indexes</span></span>

###  <a name="decomposing-indexed-space-into-a-grid-hierarchy"></a><a name="decompose"></a> <span data-ttu-id="7c36a-108">インデックスを作成する空間のグリッド階層への分解</span><span class="sxs-lookup"><span data-stu-id="7c36a-108">Decomposing Indexed Space into a Grid Hierarchy</span></span>
 <span data-ttu-id="7c36a-109">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]では、空間インデックスは B ツリーを使用して構築されます。したがって、インデックスでは、B ツリーの線形な順序で 2 次元の空間データを表現する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-109">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes are built using B-trees, which means that the indexes must represent the 2-dimensional spatial data in the linear order of B-trees.</span></span> <span data-ttu-id="7c36a-110">このため、 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] では、データを空間インデックスに読み取る前に、空間を階層に均一に分解します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-110">Therefore, before reading data into a spatial index, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] implements a hierarchical uniform decomposition of space.</span></span> <span data-ttu-id="7c36a-111">このインデックス作成プロセスでは、空間が 4 つのレベルから成る *グリッド階層* に *分解*されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-111">The index-creation process *decomposes* the space into a four-level *grid hierarchy*.</span></span> <span data-ttu-id="7c36a-112">これらのレベルはそれぞれ、 *レベル 1* (最上位レベル)、 *レベル 2*、 *レベル 3*、および *レベル 4*と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-112">These levels are referred to as *level 1* (the top level), *level 2*, *level 3*, and *level 4*.</span></span>

 <span data-ttu-id="7c36a-113">各レベルでは、1 つ上のレベルがさらに分解されます。したがって、上のレベルのセルに次のレベルの完全なグリッドが含まれます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-113">Each successive level further decomposes the level above it, so each upper-level cell contains a complete grid at the next level.</span></span> <span data-ttu-id="7c36a-114">特定のレベルのすべてのグリッドは、両方の軸に沿って同じ数のセルを持ちます (4 × 4、8 × 8 など)。それらのセルのサイズはすべて同じです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-114">On a given level, all the grids have the same number of cells along both axes (for example, 4x4 or 8x8), and the cells are all one size.</span></span>

 <span data-ttu-id="7c36a-115">次の図では、グリッド階層の各レベルで右上のセルが 4 × 4 のグリッドに分解されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-115">The following illustration shows the decomposition for the upper-right cell at each level of the grid hierarchy into a 4x4 grid.</span></span> <span data-ttu-id="7c36a-116">実際にはすべてのセルがこのように分解されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-116">In reality, all the cells are decomposed in this way.</span></span> <span data-ttu-id="7c36a-117">したがって、たとえば空間を 4 つのレベルの 4 × 4 のグリッドに分解すると、実際にはレベル 4 のセルが合計 65,536 個生成されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-117">Thus, for example, decomposing a space into four levels of 4x4 grids actually produces a total of 65,536 level-four cells.</span></span>

 <span data-ttu-id="7c36a-118">![再帰的テセレーションの 4 つのレベル](../../database-engine/media/spndx-recursive-levels-telescoped.gif "再帰的テセレーションの 4 つのレベル")</span><span class="sxs-lookup"><span data-stu-id="7c36a-118">![Four-levels of recursive tessellation](../../database-engine/media/spndx-recursive-levels-telescoped.gif "Four-levels of recursive tessellation")</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-119">空間インデックスのための空間の分解は、アプリケーション データが使用する測定単位に依存しません。</span><span class="sxs-lookup"><span data-stu-id="7c36a-119">The decomposition of space for a spatial index is independent of the unit of measurement that the application data uses.</span></span>

 <span data-ttu-id="7c36a-120">グリッド階層のセルは、ヒルベルト空間充てん曲線のバリエーションを使用して直線的に番号付けされます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-120">Grid hierarchy cells are numbered in a linear fashion by using a variation of the Hilbert space-filling curve.</span></span> <span data-ttu-id="7c36a-121">ただし、ここでは説明をわかりやすくするために、ヒルベルト曲線によって行われる実際の番号付けの代わりに単純な行方向の番号付けを使用します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-121">For the purpose of illustration, however, this discussion uses a simple row-wise numbering, instead of the numbering that is actually produced by the Hilbert curve.</span></span> <span data-ttu-id="7c36a-122">次の図では、建物を表すいくつかの多角形と通りを表す線が、既に 4 × 4 のレベル 1 グリッドに配置されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-122">In the following illustration, several polygons that represent buildings, and lines that represent streets, have already been placed into a 4x4, level-1 grid.</span></span> <span data-ttu-id="7c36a-123">レベル 1 のセルには、左上のセルから順番に 1 ～ 16 の番号が付けられています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-123">The level-1 cells are numbered from 1 through 16, starting with the upper-left cell.</span></span>

 <span data-ttu-id="7c36a-124">![4 × 4 のレベル 1 グリッド上の多角形と線](../../database-engine/media/spndx-level-1-objects.gif "4 × 4 のレベル 1 グリッド上の多角形と線")</span><span class="sxs-lookup"><span data-stu-id="7c36a-124">![Polygons and lines placed into a 4x4 level-1 grid](../../database-engine/media/spndx-level-1-objects.gif "Polygons and lines placed into a 4x4 level-1 grid")</span></span>

#### <a name="grid-density"></a><span data-ttu-id="7c36a-125">グリッド密度</span><span class="sxs-lookup"><span data-stu-id="7c36a-125">Grid Density</span></span>
 <span data-ttu-id="7c36a-126">グリッドの軸に沿ったセルの数により、グリッドの *密度*が決まります。この数が多いほど密度が高くなります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-126">The number of cells along the axes of a grid determines its *density*: the larger the number, the denser the grid.</span></span> <span data-ttu-id="7c36a-127">たとえば、8 × 8 のグリッド (64 個のセル) は、4 × 4 のグリッド (16 個のセル) より高密度です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-127">For example, an 8x8 grid (which produces 64 cells), is denser than a 4x4 grid (which produces 16 cells).</span></span> <span data-ttu-id="7c36a-128">グリッド密度はレベルごとに定義されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-128">Grid density is defined on a per-level basis.</span></span>

 <span data-ttu-id="7c36a-129">空間インデックスの [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] ステートメントでサポートされている GRIDS 句を使用すると、レベルごとに異なるグリッド密度を指定できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-129">The [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a GRIDS clause that enables you to specify different grid densities at different levels.</span></span> <span data-ttu-id="7c36a-130">特定のレベルのグリッド密度を指定するには、次のいずれかのキーワードを使用します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-130">The grid density for a given level is specified by using one of the following keywords.</span></span>

|<span data-ttu-id="7c36a-131">Keyword</span><span class="sxs-lookup"><span data-stu-id="7c36a-131">Keyword</span></span>|<span data-ttu-id="7c36a-132">グリッドの構成</span><span class="sxs-lookup"><span data-stu-id="7c36a-132">Grid configuration</span></span>|<span data-ttu-id="7c36a-133">セルの数</span><span class="sxs-lookup"><span data-stu-id="7c36a-133">Number of cells</span></span>|
|-------------|------------------------|---------------------|
|<span data-ttu-id="7c36a-134">LOW</span><span class="sxs-lookup"><span data-stu-id="7c36a-134">LOW</span></span>|<span data-ttu-id="7c36a-135">4 × 4</span><span class="sxs-lookup"><span data-stu-id="7c36a-135">4X4</span></span>|<span data-ttu-id="7c36a-136">16</span><span class="sxs-lookup"><span data-stu-id="7c36a-136">16</span></span>|
|<span data-ttu-id="7c36a-137">MEDIUM</span><span class="sxs-lookup"><span data-stu-id="7c36a-137">MEDIUM</span></span>|<span data-ttu-id="7c36a-138">8 × 8</span><span class="sxs-lookup"><span data-stu-id="7c36a-138">8X8</span></span>|<span data-ttu-id="7c36a-139">64</span><span class="sxs-lookup"><span data-stu-id="7c36a-139">64</span></span>|
|<span data-ttu-id="7c36a-140">HIGH</span><span class="sxs-lookup"><span data-stu-id="7c36a-140">HIGH</span></span>|<span data-ttu-id="7c36a-141">16 × 16</span><span class="sxs-lookup"><span data-stu-id="7c36a-141">16X16</span></span>|<span data-ttu-id="7c36a-142">256</span><span class="sxs-lookup"><span data-stu-id="7c36a-142">256</span></span>|

 <span data-ttu-id="7c36a-143">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]では、データベース互換性レベルが 100 以上に設定されている場合、既定ですべてのレベルが MEDIUM になります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-143">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], when the database compatibility level is set to 100 or lower, then the default is MEDIUM on all levels.</span></span> <span data-ttu-id="7c36a-144">データベース互換性レベルが 110 以上に設定されている場合、既定で自動グリッド スキームになります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-144">When the database compatibility level is set to 110 or higher, then the default is an auto grid scheme.</span></span>

 <span data-ttu-id="7c36a-145">既定以外のグリッド密度を指定することで分解プロセスを制御できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-145">You can control the decomposition process by specifying non-default grid densities.</span></span> <span data-ttu-id="7c36a-146">たとえば、レベルごとに異なるグリッド密度を使用して、インデックスを作成する空間や空間列のオブジェクトのサイズに基づいてインデックスを微調整することができます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-146">For example, different grid densities on different levels might be useful for fine tuning an index based on the size of the indexed space and the objects in the spatial column.</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-147">空間インデックスのグリッド密度は、データベース互換性レベルが 100 以下に設定されている場合、 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) カタログ ビューの level_1_grid、level_2_grid、level_3_grid、level_4_grid の各列で確認できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-147">The grid densities of a spatial index are visible in the level_1_grid, level_2_grid, level_3_grid, and level_4_grid columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view when the database compatibility level is set to 100 or lower.</span></span> <span data-ttu-id="7c36a-148">`GEOMETRY_AUTO_GRID` / `GEOGRAPHY_AUTO_GRID` テセレーションスキームのオプションでは、これらの列は設定されません。</span><span class="sxs-lookup"><span data-stu-id="7c36a-148">The `GEOMETRY_AUTO_GRID`/`GEOGRAPHY_AUTO_GRID` tessellation scheme options do not populate these columns.</span></span> <span data-ttu-id="7c36a-149">`NULL`自動グリッドオプションが使用されている場合、spatial_index_tessellations カタログビューにはこれらの列の値があります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-149">sys.spatial_index_tessellations catalog view has `NULL` values for these columns when the auto grid options are used.</span></span>

###  <a name="tessellation"></a><a name="tessellation"></a><span data-ttu-id="7c36a-150">テセレーション</span><span class="sxs-lookup"><span data-stu-id="7c36a-150">Tessellation</span></span>
 <span data-ttu-id="7c36a-151">インデックスを作成する空間がグリッド階層に分解された後、空間列のデータが行単位で読み取られます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-151">After decomposition of an indexed space into a grid hierarchy, the spatial index reads the data from the spatial column, row by row.</span></span> <span data-ttu-id="7c36a-152">空間オブジェクト (インスタンス) のデータの読み取りが完了すると、空間インデックスによってそのオブジェクトに対して *テセレーション プロセス* が実行されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-152">After reading the data for a spatial object (or instance), the spatial index performs a *tessellation process* for that object.</span></span> <span data-ttu-id="7c36a-153">テセレーション プロセスでは、オブジェクトを、そのオブジェクトが接する一連のグリッド セル (*接するセル*) に関連付けることによって、オブジェクトをグリッド階層に当てはめます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-153">The tessellation processfits the object into the grid hierarchy by associating the object with a set of grid cells that it touches (*touched cells*).</span></span> <span data-ttu-id="7c36a-154">テセレーション プロセスはグリッド階層のレベル 1 で開始され、 *幅優先* でレベル全体にわたって続けられます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-154">Starting at level 1 of the grid hierarchy, the tessellation process proceeds *breadth first* across the level.</span></span> <span data-ttu-id="7c36a-155">このプロセスは、場合によっては 4 つのレベルすべてにわたって続けられます (一度に 1 レベルずつ処理されます)。</span><span class="sxs-lookup"><span data-stu-id="7c36a-155">Potentially, the process can continue through all four levels, one level at a time.</span></span>

 <span data-ttu-id="7c36a-156">テセレーション プロセスが終了すると、そのオブジェクトについて、一連の接するセルが空間インデックスに記録されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-156">The output of the tessellation process is a set of touched cells that are recorded in the spatial index for the object.</span></span> <span data-ttu-id="7c36a-157">空間インデックスでは、記録されたそれらのセルを参照することにより、空間内のオブジェクトの場所を、同じくインデックスに格納されている空間列の他のオブジェクトを基準にして特定できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-157">By referring to these recorded cells, the spatial index can locate the object in space relative to other objects in the spatial column that are also stored in the index.</span></span>

#### <a name="tessellation-rules"></a><span data-ttu-id="7c36a-158">テセレーション ルール</span><span class="sxs-lookup"><span data-stu-id="7c36a-158">Tessellation Rules</span></span>
 <span data-ttu-id="7c36a-159">オブジェクトについて記録される接するセルの数を制限するために、テセレーション プロセスではいくつかのテセレーション ルールが適用されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-159">To limit the number of touched cells that are recorded for an object, the tessellation process applies several tessellation rules.</span></span> <span data-ttu-id="7c36a-160">これらのルールにより、テセレーション プロセスの深さと、接するセルのうちのどれがインデックスに記録されるかが決まります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-160">These rules determine the depth of the tessellation process and which of the touched cells are recorded in the index.</span></span>

 <span data-ttu-id="7c36a-161">これらのルールを以下に示します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-161">These rules are as follows:</span></span>

-   <span data-ttu-id="7c36a-162">カバリング ルール</span><span class="sxs-lookup"><span data-stu-id="7c36a-162">The covering rule</span></span>

     <span data-ttu-id="7c36a-163">オブジェクトがセルを完全に覆っている場合、そのセルはオブジェクトに *覆われている* と言います。</span><span class="sxs-lookup"><span data-stu-id="7c36a-163">If the object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="7c36a-164">覆われているセルはカウントされますが、テセレーションはされません。</span><span class="sxs-lookup"><span data-stu-id="7c36a-164">A covered cell is counted and is not tessellated.</span></span> <span data-ttu-id="7c36a-165">このルールはグリッド階層のすべてのレベルで適用されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-165">This rule applies at all levels of the grid hierarchy.</span></span> <span data-ttu-id="7c36a-166">これにより、テセレーション プロセスが簡略化され、空間インデックスに記録されるデータの量が減ります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-166">The covering rule simplifies the tessellation process and reduces the amount of data that a spatial index records.</span></span>

-   <span data-ttu-id="7c36a-167">オブジェクトごとのセル数のルール</span><span class="sxs-lookup"><span data-stu-id="7c36a-167">The cells-per-object rule</span></span>

     <span data-ttu-id="7c36a-168">このルールでは、 *オブジェクトごとのセル数の制限*を適用します。オブジェクトごとのセル数の制限は、レベル 1 以外のレベルで各オブジェクトについてカウントできるセルの最大数を決定します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-168">This rule enforces the *cells-per-object limit*, which determines the maximum number of cells that can be counted for each object, except on level 1.</span></span> <span data-ttu-id="7c36a-169">これにより、下位レベルでオブジェクトについて記録できる情報の量が制御されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-169">At lower levels, the cells-per-object rule controls the amount of information that can be recorded about the object.</span></span>

-   <span data-ttu-id="7c36a-170">最下位のセルのルール</span><span class="sxs-lookup"><span data-stu-id="7c36a-170">The deepest-cell rule</span></span>

     <span data-ttu-id="7c36a-171">このルールでは、オブジェクトに対してテセレーションされた最下位のセルのみを記録することにより、オブジェクトを最も近い形で再現できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-171">The deepest-cell rule generates the best approximation of an object by recording only the bottom-most cells that have been tessellated for the object.</span></span> <span data-ttu-id="7c36a-172">親のセルはオブジェクトごとのセル数に含まれず、インデックスにも記録されません。</span><span class="sxs-lookup"><span data-stu-id="7c36a-172">Parent cells do not contribute to the cells-per-object count, and they are not recorded in the index.</span></span>

 <span data-ttu-id="7c36a-173">これらのテセレーション ルールは、各グリッド レベルで再帰的に適用されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-173">These tessellation rules are applied recursively on each grid level.</span></span> <span data-ttu-id="7c36a-174">以降では、テセレーション ルールについてさらに詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-174">The rest of this section describes the tessellation rules in more detail.</span></span>

#### <a name="covering-rule"></a><span data-ttu-id="7c36a-175">カバリング ルール</span><span class="sxs-lookup"><span data-stu-id="7c36a-175">Covering Rule</span></span>
 <span data-ttu-id="7c36a-176">オブジェクトがセルを完全に覆っている場合、そのセルはオブジェクトに *覆われている* と言います。</span><span class="sxs-lookup"><span data-stu-id="7c36a-176">If an object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="7c36a-177">たとえば次の図では、レベル 2 のセルの 1 つ (15.11) が八角形の中心部分に完全に覆われています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-177">For example, in the following illustration, one of the second-level cells, 15.11, is completely covered by the middle portion of an octagon.</span></span>

 <span data-ttu-id="7c36a-178">![カバリングによる最適化](../../database-engine/media/spndx-opt-covering.gif "カバリングによる最適化")</span><span class="sxs-lookup"><span data-stu-id="7c36a-178">![Covering optimization](../../database-engine/media/spndx-opt-covering.gif "Covering optimization")</span></span>

 <span data-ttu-id="7c36a-179">覆われているセルはカウントされ、インデックスに記録されます。そのセルはそれ以上テセレーションされません。</span><span class="sxs-lookup"><span data-stu-id="7c36a-179">A covered cell is counted and recorded in the index, and the cell is not tessellated any further.</span></span>

#### <a name="cells-per-object-rule"></a><span data-ttu-id="7c36a-180">オブジェクトごとのセル数のルール</span><span class="sxs-lookup"><span data-stu-id="7c36a-180">Cells-Per-Object Rule</span></span>
 <span data-ttu-id="7c36a-181">各オブジェクトのテセレーションの範囲は、主に空間インデックスの *オブジェクトごとのセル数の制限* によって決まります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-181">The extent of tessellation of each object depends primarily on the *cells-per-object limit* of the spatial index.</span></span> <span data-ttu-id="7c36a-182">この制限は、テセレーションでオブジェクトごとにカウントできるセルの最大数を定義します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-182">This limit defines the maximum number of cells that tessellation can count per object.</span></span> <span data-ttu-id="7c36a-183">ただし、オブジェクトごとのセル数のルールはレベル 1 には適用されません。したがって、レベル 1 ではこの制限を超える可能性があります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-183">Note, however, that the cells-per-object rule is not enforced for level 1, so it is possible to exceed this limit.</span></span> <span data-ttu-id="7c36a-184">レベル 1 のカウントがオブジェクトごとのセル数の制限に達したり、この制限を超えたりすると、下位レベルでそれ以上テセレーションが行われなくなります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-184">If the level-1 count reaches, or exceeds, the cells-per-object limit, no further tessellation occurs at the lower levels.</span></span>

 <span data-ttu-id="7c36a-185">カウントがオブジェクトごとのセル数の制限に達していなければ、テセレーション プロセスは続行されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-185">As long as the count is less than the cells-per-object limit, the tessellation process continues.</span></span> <span data-ttu-id="7c36a-186">接するセルの中で最も番号が小さいセル (たとえば前の図ではセル 15.6) から始めて各セルがテストされ、そのセルをカウントするかテセレーションするかが評価されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-186">Starting with the lowest-number touched cell (for example, cell 15.6 in the preceding illustration), the process tests each cell to evaluate whether to count it or tessellate it.</span></span> <span data-ttu-id="7c36a-187">テセレーションするとオブジェクトごとのセル数の制限を超えてしまう場合、セルはテセレーションされずにカウントされます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-187">If tessellating a cell would exceed the cells-per-object limit, the cell is counted and not tessellated.</span></span> <span data-ttu-id="7c36a-188">そうでない場合は、セルがテセレーションされ、オブジェクトが接している下位レベルのセルがカウントされます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-188">Otherwise, the cell is tessellated, and the lower-level cells that are touched by the object are counted.</span></span> <span data-ttu-id="7c36a-189">このようにして、テセレーション プロセスが幅優先でレベル全体にわたって続けられます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-189">The tessellation process continues in this way, breadth-wise, across the level.</span></span> <span data-ttu-id="7c36a-190">このプロセスは、制限に達するか、カウントするセルがなくなるまで、テセレーションされたセルの下位レベルのグリッドに対して再帰的に繰り返されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-190">This process is repeated recursively for the lower-level grids of the tessellated cells until the limit is reached or there are no more cells to count.</span></span>

 <span data-ttu-id="7c36a-191">たとえば先ほどの、八角形がレベル 1 グリッドのセル 15 に完全に収まっている図では、</span><span class="sxs-lookup"><span data-stu-id="7c36a-191">For example, consider the preceding illustration, which shows an octagon that fits completely into cell 15 of the level-1 grid.</span></span> <span data-ttu-id="7c36a-192">セル 15 がテセレーションされて、八角形がレベル 2 の 9 つのセルに分解されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-192">In the figure, cell 15 has been tessellated, dissecting the octagon into nine level-2 cells.</span></span> <span data-ttu-id="7c36a-193">この例では、オブジェクトごとのセル数の制限が 9 以上と想定されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-193">This illustration assumes that the cells-per-object limit is 9 or more.</span></span> <span data-ttu-id="7c36a-194">オブジェクトごとのセル数の制限が 8 以下の場合は、セル 15 はテセレーションされず、セル 15 のみがオブジェクトに対してカウントされます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-194">If the cells-per-object limit were 8 or less, however, cell 15 would not be tessellated, and only that cell 15 would be counted for the object.</span></span>

 <span data-ttu-id="7c36a-195">既定では、オブジェクトごとのセル数の制限は 16 です。この値は、ほとんどの空間インデックスで、スペースと精度のバランスが取れた値になります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-195">By default, the cells-per-object limit is 16 cells per object, which provides a satisfactory trade-off between space and precision for most spatial indexes.</span></span> <span data-ttu-id="7c36a-196">ただし、 [CREATE 空間インデックス](/sql/t-sql/statements/create-spatial-index-transact-sql)ステートメントでは、 [!INCLUDE[tsql](../../../includes/tsql-md.md)] `=` オブジェクトごとのセル数の制限を1から8192の範囲で指定できるようにする CELLS_PER_OBJECT*n*句がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-196">However, the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a CELLS_PER_OBJECT`=`*n* clause that enables you to specify a cells-per-object limit between 1 and 8192, inclusive.</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-197">空間インデックスの **cells_per_object** の設定は、 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) カタログ ビューで確認できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-197">The **cells_per_object** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="deepest-cell-rule"></a><span data-ttu-id="7c36a-198">最下位のセルのルール</span><span class="sxs-lookup"><span data-stu-id="7c36a-198">Deepest-Cell Rule</span></span>
 <span data-ttu-id="7c36a-199">最下位のセルのルールでは、下位レベルのセルはすべてその上のセルに属しているという事実が利用されています。レベル 4 のセルはレベル 3 のセルに、レベル 3 のセルはレベル 2 のセルに、レベル 2 のセルはレベル 1 のセルにそれぞれ属しています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-199">The deepest-cell rule exploits the fact that every lower-level cell belongs to the cell above it: a level-4 cell belongs to a level-3 cell, a level-3 cell belongs to a level-2 cell, and a level-2 cell belongs to a level-1 cell.</span></span> <span data-ttu-id="7c36a-200">たとえば、セル 1.1.1.1 に属しているオブジェクトは、セル 1.1.1、セル 1.1、およびセル 1 にも属しています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-200">For example, an object that belongs to cell 1.1.1.1 also belongs to cell 1.1.1, cell 1.1, and cell 1.</span></span> <span data-ttu-id="7c36a-201">こうしたセルの階層関係の情報はクエリ プロセッサに組み込まれているため、</span><span class="sxs-lookup"><span data-stu-id="7c36a-201">Knowledge of such cell-hierarchy relationships is built into the query processor.</span></span> <span data-ttu-id="7c36a-202">インデックスに記録するのは最下位レベルのセルだけで済みます。これにより、インデックスに格納する情報を最小限に抑えられます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-202">Therefore, only the deepest-level cells need to be recorded in the index, minimizing the information that the index needs to store.</span></span>

 <span data-ttu-id="7c36a-203">次の図では、比較的小さな菱形の多角形がテセレーションされています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-203">In the following illustration, a relatively small diamond-shaped polygon is tessellated.</span></span> <span data-ttu-id="7c36a-204">このインデックスで使用されているオブジェクトごとのセル数の制限は既定の 16 で、この小さなオブジェクトではその制限に達しないため、</span><span class="sxs-lookup"><span data-stu-id="7c36a-204">The index uses the default cells-per-object limit of 16, which is not reached for this small object.</span></span> <span data-ttu-id="7c36a-205">テセレーションはレベル 4 まで続けられます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-205">Therefore, tessellation continues down to level 4.</span></span> <span data-ttu-id="7c36a-206">この多角形は、4、4.4、および 4.4.10 と 4.4.14 というレベル 1 ～ 3 のセルにも存在していますが、</span><span class="sxs-lookup"><span data-stu-id="7c36a-206">The polygon resides in the following level-1 through level-3 cells: 4, 4.4, and 4.4.10 and 4.4.14.</span></span> <span data-ttu-id="7c36a-207">最下位のセルのルールが使用されるため、テセレーションでカウントされるのはレベル 4 の 12 個のセル (4.4.10.13 ～ 15 と 4.4.14.1 ～ 3、4.4.14.5 ～ 7、および 4.4.14.9 ～ 11) だけです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-207">However, using the deepest-cell rule, the tessellation counts only the twelve level-4 cells: 4.4.10.13-15 and 4.4.14.1-3, 4.4.14.5-7, and 4.4.14.9-11.</span></span>

 <span data-ttu-id="7c36a-208">![最下位のセルによる最適化](../../database-engine/media/spndx-opt-deepest-cell.gif "最下位のセルによる最適化")</span><span class="sxs-lookup"><span data-stu-id="7c36a-208">![Deepest-cell optimization](../../database-engine/media/spndx-opt-deepest-cell.gif "Deepest-cell optimization")</span></span>

###  <a name="tessellation-schemes"></a><a name="schemes"></a> <span data-ttu-id="7c36a-209">テセレーション スキーム</span><span class="sxs-lookup"><span data-stu-id="7c36a-209">Tessellation Schemes</span></span>
 <span data-ttu-id="7c36a-210">空間インデックスの動作の一部は、 *テセレーション スキーム*によって決まります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-210">The behavior of a spatial index depends partly on its *tessellation scheme*.</span></span> <span data-ttu-id="7c36a-211">テセレーション スキームはデータ型固有です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-211">The tessellation scheme is data-type specific.</span></span> <span data-ttu-id="7c36a-212">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]では、空間インデックスで次の 2 つのテセレーション スキームがサポートされています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-212">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes support two tessellation schemes:</span></span>

-   <span data-ttu-id="7c36a-213">*ジオメトリグリッドテセレーション*。これは、データ型のスキームです `geometry` 。</span><span class="sxs-lookup"><span data-stu-id="7c36a-213">*Geometry grid tessellation*, which is the scheme for the `geometry` data type.</span></span>

-   <span data-ttu-id="7c36a-214">*Geography grid テセレーション*。データ型の列に適用さ `geography` れます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-214">*Geography grid tessellation*, which applies to columns of the `geography` data type.</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-215">空間インデックスの **tessellation_scheme** 設定は、 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) カタログ ビューで確認できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-215">The **tessellation_scheme** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="geometry-grid-tessellation-scheme"></a><span data-ttu-id="7c36a-216">ジオメトリ グリッド テセレーション スキーム</span><span class="sxs-lookup"><span data-stu-id="7c36a-216">Geometry Grid Tessellation Scheme</span></span>
 <span data-ttu-id="7c36a-217">GEOMETRY_AUTO_GRID テセレーションは、[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 以降の `geometry` データ型用の既定のテセレーション スキームです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-217">GEOMETRY_AUTO_GRID tessellation is the default tessellation scheme for the `geometry` data type for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and later.</span></span>  <span data-ttu-id="7c36a-218">GEOMETRY_GRID テセレーションは、 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]の geometry データ型で使用できる唯一のテセレーション スキームです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-218">GEOMETRY_GRID tessellation is the only tessellation scheme available for geometry data types in [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7c36a-219">ここでは、空間インデックスの操作に関連するジオメトリ グリッド テセレーションの特徴 (サポートされるメソッドと境界ボックス) について説明します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-219">This section discusses aspects of geometry grid tessellation that are relevant to working with spatial indexes: supported methods and bounding boxes.</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-220">[CREATE 空間インデックス](/sql/t-sql/statements/create-spatial-index-transact-sql)ステートメントの using (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) 句を使用して、このテセレーションスキームを明示的に指定することができ [!INCLUDE[tsql](../../../includes/tsql-md.md)] ます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-220">You can explicitly specify this tessellation scheme by using the USING (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="the-bounding-box"></a><span data-ttu-id="7c36a-221">境界ボックス</span><span class="sxs-lookup"><span data-stu-id="7c36a-221">The Bounding Box</span></span>
 <span data-ttu-id="7c36a-222">幾何データで用いられる平面は無限に広がっていますが、</span><span class="sxs-lookup"><span data-stu-id="7c36a-222">Geometric data occupies a plane that can be infinite.</span></span> <span data-ttu-id="7c36a-223">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]の空間インデックスは有限の空間を必要とします。</span><span class="sxs-lookup"><span data-stu-id="7c36a-223">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], however, a spatial index requires a finite space.</span></span> <span data-ttu-id="7c36a-224">ジオメトリ グリッド テセレーション スキームでは、分解のための有限の空間を確立するために、四角形の *境界ボックス*が必要になります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-224">To establish a finite space for decomposition, the geometry grid tessellation scheme requires a rectangular *bounding box*.</span></span> <span data-ttu-id="7c36a-225">境界ボックスは、 `(` **,**_y-min_ _x-min_ `)` `(` **,**_y-max_空間インデックスのプロパティとして格納される、x-min、y min、および_x-max_の4つの座標によって定義され `)` ます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-225">The bounding box is defined by four coordinates, `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)`, which are stored as properties of the spatial index.</span></span> <span data-ttu-id="7c36a-226">各座標の意味は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-226">These coordinates represent the following:</span></span>

-   <span data-ttu-id="7c36a-227">*x-min* は、境界ボックスの左下隅の x 座標です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-227">*x-min* is the x-coordinate of the lower-left corner of the bounding box.</span></span>

-   <span data-ttu-id="7c36a-228">*y-min* は、左下隅の y 座標です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-228">*y-min* is the y-coordinate of the lower-left corner.</span></span>

-   <span data-ttu-id="7c36a-229">*x-max* は、右上隅の x 座標です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-229">*x-max* is the x-coordinate of the upper-right corner.</span></span>

-   <span data-ttu-id="7c36a-230">*y-max* は、右上隅の y 座標です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-230">*y-max* is the y-coordinate of upper-right corner.</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-231">これらの座標は、 [CREATE 空間インデックス](/sql/t-sql/statements/create-spatial-index-transact-sql)ステートメントの BOUNDING_BOX 句によって指定され [!INCLUDE[tsql](../../../includes/tsql-md.md)] ます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-231">These coordinates are specified by the BOUNDING_BOX clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

 <span data-ttu-id="7c36a-232">`(` _X-min_**、**_y-min、_ `)` および `(` _x-max_**,** 座標_は、_ `)` 境界ボックスの配置と大きさを決定します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-232">The `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates determine the placement and dimensions of the bounding box.</span></span> <span data-ttu-id="7c36a-233">境界ボックスの外側の空間は、番号 0 の 1 つのセルとして扱われます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-233">The space outside of the bounding box is treated as a single cell that is numbered 0.</span></span>

 <span data-ttu-id="7c36a-234">空間インデックスは、境界ボックスの内側の空間を分解します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-234">The spatial index decomposes the space inside the bounding box.</span></span> <span data-ttu-id="7c36a-235">境界ボックスがグリッド階層のレベル 1 のグリッドで満たされ、</span><span class="sxs-lookup"><span data-stu-id="7c36a-235">The level-1 grid of the grid hierarchy fills the bounding box.</span></span> <span data-ttu-id="7c36a-236">幾何オブジェクトをグリッド階層に配置するためにオブジェクトの座標が境界ボックスの座標と比較されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-236">To place a geometric object in the grid hierarchy, the spatial index compares the coordinates of the object to the bounding-box coordinates.</span></span>

 <span data-ttu-id="7c36a-237">次の図は、 `(` 境界ボックスの_x の最小_値 **、**_y の最小_値、 `)` および `(` _x-最大_**,**_y-max_座標によって定義される点を示して `)` います。</span><span class="sxs-lookup"><span data-stu-id="7c36a-237">The following illustration shows the points defined by the `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates of the bounding box.</span></span> <span data-ttu-id="7c36a-238">また、グリッド階層の最上位レベルが 4 × 4 のグリッドとして示されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-238">The top-level of the grid hierarchy is shown as a 4x4 grid.</span></span> <span data-ttu-id="7c36a-239">下位のレベルはわかりやすくするために省略されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-239">For the purpose of illustration, the lower levels are omitted.</span></span> <span data-ttu-id="7c36a-240">境界ボックスの外側の空間はゼロ (0) によって示されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-240">The space outside of the bounding box is indicated by a zero (0).</span></span> <span data-ttu-id="7c36a-241">オブジェクト A はボックスから一部はみ出しており、オブジェクト B は完全にボックスの外側 (セル 0) にあります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-241">Note that object 'A' extends partly beyond the box, and object 'B' lies completely outside the box in cell 0.</span></span>

 <span data-ttu-id="7c36a-242">![座標とセル 0 を表示している境界ボックス。](../../database-engine/media/spndx-bb-4x4-objects.gif "座標とセル 0 を表示している境界ボックス。")</span><span class="sxs-lookup"><span data-stu-id="7c36a-242">![Bounding box showing coordinates and cell 0.](../../database-engine/media/spndx-bb-4x4-objects.gif "Bounding box showing coordinates and cell 0.")</span></span>

 <span data-ttu-id="7c36a-243">境界ボックスは、アプリケーションの空間データの一部分に対応します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-243">A bounding box corresponds to some portion of an application's spatial data.</span></span> <span data-ttu-id="7c36a-244">空間列に格納されているデータがインデックスの境界ボックスに完全に含まれるか、一部のみが含まれるかは、アプリケーションによって異なります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-244">Whether the bounding-box of the index completely contains the data stored in the spatial column, or only contains a portion, is up to the application.</span></span> <span data-ttu-id="7c36a-245">空間インデックスの恩恵を受けることができるのは、完全に境界ボックスの内側にあるオブジェクトに対して計算される操作だけです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-245">Only operations computed on objects that are entirely inside of the bounding box benefit from the spatial index.</span></span> <span data-ttu-id="7c36a-246">したがって、`geometry` 列の空間インデックスの利点を最大限に活用するためには、ほとんどすべてのオブジェクトが含まれるように境界ボックスを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-246">Therefore, to gain the greatest advantage from a spatial index on a `geometry` column, you need to specify a bounding-box that contains all or most of the objects.</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-247">空間インデックスのグリッド密度は、 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) カタログ ビューの bounding_box_xmin、bounding_box_ymin、bounding_box_xmax、および bounding_box_ymax columns の各列で確認できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-247">The grid densities of a spatial index are visible in the bounding_box_xmin, bounding_box_ymin, bounding_box_xmax, and bounding_box_ymax columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="the-geography-grid-tessellation-scheme"></a><span data-ttu-id="7c36a-248">地理グリッド テセレーション スキーム</span><span class="sxs-lookup"><span data-stu-id="7c36a-248">The Geography Grid Tessellation Scheme</span></span>
 <span data-ttu-id="7c36a-249">このテセレーション スキームは、`geography` 列のみに適用されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-249">This tessellation scheme applies only to a `geography` column.</span></span> <span data-ttu-id="7c36a-250">ここでは、地理グリッド テセレーションによってサポートされるメソッドの概要と、測地空間が平面に投影されてグリッド階層に分解されるしくみを説明します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-250">This section summarizes the methods that are supported by geography grid tessellation and discusses how geodetic space is projected onto a plane, which is then decomposed into a grid hierarchy.</span></span>

> [!NOTE]
>  <span data-ttu-id="7c36a-251">[CREATE 空間インデックス](/sql/t-sql/statements/create-spatial-index-transact-sql)ステートメントの using (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) 句を使用して、このテセレーションスキームを明示的に指定することができ [!INCLUDE[tsql](../../../includes/tsql-md.md)] ます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-251">You can explicitly specify this tessellation scheme by using the USING (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="projection-of-the-geodetic-space-onto-a-plane"></a><span data-ttu-id="7c36a-252">測地空間の平面への投影</span><span class="sxs-lookup"><span data-stu-id="7c36a-252">Projection of the Geodetic Space onto a Plane</span></span>
 <span data-ttu-id="7c36a-253">`geography` インスタンス (オブジェクト) の計算では、オブジェクトを含む空間を測地の楕円体として扱います。</span><span class="sxs-lookup"><span data-stu-id="7c36a-253">Computations on `geography` instances (objects) treat the space containing the objects as a geodetic ellipsoid.</span></span> <span data-ttu-id="7c36a-254">地理グリッド テセレーション スキームでは、この空間を分解するために、まず、楕円体の表面が上下の半球に分割されます。その後、次の手順が実行されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-254">To decompose this space, the geography grid tessellation scheme divides the surface of the ellipsoid into its upper and lower hemispheres and then performs the following steps:</span></span>

1.  <span data-ttu-id="7c36a-255">各半球を四角錐の面に投影します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-255">Projects each hemisphere onto the facets of a quadrilateral pyramid.</span></span>

2.  <span data-ttu-id="7c36a-256">2 つの四角錐を平面化します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-256">Flattens the two pyramids.</span></span>

3.  <span data-ttu-id="7c36a-257">平面化された四角錐を結合して、非ユークリッド平面を形成します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-257">Joins the flattened pyramids to form a non-Euclidean plane.</span></span>

 <span data-ttu-id="7c36a-258">次の図は、この 3 つの手順による分解プロセスの概略図です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-258">The following illustration shows a schematic view of the three-step decomposition process.</span></span> <span data-ttu-id="7c36a-259">四角錐の点線は、各四角錐の 4 つの面の境界を表しています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-259">In the pyramids, the dotted lines represent the boundaries of the four facets of each pyramid.</span></span> <span data-ttu-id="7c36a-260">手順 1. と 2. は、測地の楕円体を表しています。緑の横線は赤道の経線を表し、一連の緑の縦線は緯線を表します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-260">Steps 1 and 2 illustrate the geodetic ellipsoid, using a green horizontal line to represent the equatorial longitude line and a series of green vertical lines to represent several latitude lines.</span></span> <span data-ttu-id="7c36a-261">手順 1. では、2 つの半球が四角錐に投影されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-261">Step 1 shows the pyramids being projected over the two hemispheres.</span></span> <span data-ttu-id="7c36a-262">手順 2. では、四角錐が平面化されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-262">Step 2 shows the pyramids being flattened.</span></span> <span data-ttu-id="7c36a-263">手順 3. は、平面を形成するために結合された後の平面化された四角錐を表しています。いくつかの緯線が投影されているのがわかります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-263">Step 3 illustrates the flattened pyramids, after they have been combined to form a plane, showing a number of projected longitude lines.</span></span> <span data-ttu-id="7c36a-264">これらの投影された線は直線化されていて、四角錐のどこに投影されたかによって長さが異なっています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-264">Notice that these projected lines are straightened and vary in length, depending on where they fall on the pyramids.</span></span>

 <span data-ttu-id="7c36a-265">![楕円体の平面への投影](../../database-engine/media/spndx-geodetic-projection.gif "楕円体の平面への投影")</span><span class="sxs-lookup"><span data-stu-id="7c36a-265">![Projection of the ellipsoid onto a plane](../../database-engine/media/spndx-geodetic-projection.gif "Projection of the ellipsoid onto a plane")</span></span>

 <span data-ttu-id="7c36a-266">空間が平面に投影されたら、今度はその平面が 4 つのレベルから成るグリッド階層に分解されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-266">Once the space has been projected onto the plane, the plane is decomposed into the four-level grid hierarchy.</span></span> <span data-ttu-id="7c36a-267">レベルごとに異なるグリッド密度を使用できます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-267">Different levels can use different grid densities.</span></span> <span data-ttu-id="7c36a-268">次の図は、4 × 4 のレベル 1 グリッドに分解された後の平面を示しています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-268">The following illustration shows the plane after it has been decomposed into a 4x4 level-1 grid.</span></span> <span data-ttu-id="7c36a-269">グリッド階層の下位レベルはわかりやすくするために省略されています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-269">For the purposes of illustration, the lower-levels of the grid hierarchy are omitted.</span></span> <span data-ttu-id="7c36a-270">実際には、平面は 4 つのレベルから成るグリッド階層に完全に分解されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-270">In actuality, the plane is fully decomposed into a four-level grid hierarchy.</span></span> <span data-ttu-id="7c36a-271">分解のプロセスが完了すると、geography 列の地理データが行単位で読み取られ、各オブジェクトに対して順番にテセレーション プロセスが実行されます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-271">After the decomposition process finishes, the geographic data is read, row by row, from the geography column, and the tessellation process is performed for each object in turn.</span></span>

 <span data-ttu-id="7c36a-272">![レベル 1 地理グリッド](../../database-engine/media/spndx-geodetic-level1grid.gif "レベル 1 地理グリッド")</span><span class="sxs-lookup"><span data-stu-id="7c36a-272">![Level-1 geography grid](../../database-engine/media/spndx-geodetic-level1grid.gif "Level-1 geography grid")</span></span>

##  <a name="methods-supported-by-spatial-indexes"></a><a name="methods"></a> <span data-ttu-id="7c36a-273">空間インデックスでサポートされるメソッド</span><span class="sxs-lookup"><span data-stu-id="7c36a-273">Methods Supported by Spatial Indexes</span></span>

###  <a name="geometry-methods-supported-by-spatial-indexes"></a><a name="geometry"></a><span data-ttu-id="7c36a-274">空間インデックスでサポートされるジオメトリメソッド</span><span class="sxs-lookup"><span data-stu-id="7c36a-274">Geometry Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="7c36a-275">空間インデックスは、特定の条件下で、STContains()、STDistance()、STEquals()、STIntersects()、STOverlaps()、STTouches()、STWithin() というセット指向のジオメトリ メソッドをサポートします。</span><span class="sxs-lookup"><span data-stu-id="7c36a-275">Spatial indexes support the following set-oriented geometry methods under certain conditions: STContains(), STDistance(), STEquals(), STIntersects(), STOverlaps(), STTouches(), and STWithin().</span></span> <span data-ttu-id="7c36a-276">空間インデックスでサポートされるために、これらのメソッドは、クエリの WHERE 句または JOIN ON 句内で、次の一般的な述語の形式で使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-276">To be supported by a spatial index, these methods must be used within the WHERE or JOIN ON clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="7c36a-277">*geometry1*。*method_name*(*geometry2*)*comparison_operator \* \* valid_number*</span><span class="sxs-lookup"><span data-stu-id="7c36a-277">*geometry1*.*method_name*(*geometry2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="7c36a-278">NULL 以外の結果を返すには、 *geometry1* と *geometry2* の [SRID (Spatial Reference Identifier)](../spatial/spatial-reference-identifiers-srids.md)が同じであることが必要です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-278">To return a non-null result, *geometry1* and *geometry2* must have the same [spatial reference identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="7c36a-279">それ以外の場合は、NULL を返します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-279">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="7c36a-280">空間インデックスは、次の述語形式をサポートします。</span><span class="sxs-lookup"><span data-stu-id="7c36a-280">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="7c36a-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="7c36a-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="7c36a-282">*geometry1*。[Stdistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <*番号*</span><span class="sxs-lookup"><span data-stu-id="7c36a-282">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) < *number*</span></span>

-   <span data-ttu-id="7c36a-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *数値*</span><span class="sxs-lookup"><span data-stu-id="7c36a-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *number*</span></span>

-   <span data-ttu-id="7c36a-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="7c36a-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="7c36a-285">*geometry1*.[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="7c36a-285">*geometry1*.[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="7c36a-286">*geometry1.*</span><span class="sxs-lookup"><span data-stu-id="7c36a-286">*geometry1.*</span></span> <span data-ttu-id="7c36a-287">[STOverlaps](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) *(geometry2) = 1*</span><span class="sxs-lookup"><span data-stu-id="7c36a-287">[STOverlaps](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) *(geometry2) = 1*</span></span>

-   <span data-ttu-id="7c36a-288">*geometry1*.[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="7c36a-288">*geometry1*.[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="7c36a-289">*geometry1*.[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="7c36a-289">*geometry1*.[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*)= 1</span></span>

###  <a name="geography-methods-supported-by-spatial-indexes"></a><a name="geography"></a><span data-ttu-id="7c36a-290">空間インデックスでサポートされている Geography メソッド</span><span class="sxs-lookup"><span data-stu-id="7c36a-290">Geography Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="7c36a-291">空間インデックスは、特定の条件下で、STIntersects()、STEquals()、STDistance() というセット指向の地理メソッドをサポートします。</span><span class="sxs-lookup"><span data-stu-id="7c36a-291">Under certain conditions, spatial indexes support the following set-oriented geography methods: STIntersects(),STEquals(), and STDistance().</span></span> <span data-ttu-id="7c36a-292">空間インデックスでサポートされるために、これらのメソッドは、クエリの WHERE 句内で、次の一般的な述語の形式で使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-292">To be supported by a spatial index, these methods must be used within the WHERE clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="7c36a-293">*geography1*。*method_name*(*geography2*)*comparison_operator \* \* valid_number*</span><span class="sxs-lookup"><span data-stu-id="7c36a-293">*geography1*.*method_name*(*geography2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="7c36a-294">NULL 以外の結果を返すには、 *geography1* と *geography2* の [SRID (Spatial Reference Identifier)](../spatial/spatial-reference-identifiers-srids.md)が同じであることが必要です。</span><span class="sxs-lookup"><span data-stu-id="7c36a-294">To return a non-null result, *geography1* and *geography2* must have the same [Spatial Reference Identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="7c36a-295">それ以外の場合は、NULL を返します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-295">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="7c36a-296">空間インデックスは、次の述語形式をサポートします。</span><span class="sxs-lookup"><span data-stu-id="7c36a-296">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="7c36a-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*)= 1</span><span class="sxs-lookup"><span data-stu-id="7c36a-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="7c36a-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*)= 1</span><span class="sxs-lookup"><span data-stu-id="7c36a-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="7c36a-299">*geography1*。[Stdistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <*番号*</span><span class="sxs-lookup"><span data-stu-id="7c36a-299">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) < *number*</span></span>

-   <span data-ttu-id="7c36a-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *数値*</span><span class="sxs-lookup"><span data-stu-id="7c36a-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *number*</span></span>

### <a name="queries-that-use-spatial-indexes"></a><span data-ttu-id="7c36a-301">空間インデックスを使用するクエリ</span><span class="sxs-lookup"><span data-stu-id="7c36a-301">Queries that use Spatial Indexes</span></span>
 <span data-ttu-id="7c36a-302">空間インデックスは、`WHERE` 句にインデックス付き空間演算子を含むクエリのみでサポートされています。</span><span class="sxs-lookup"><span data-stu-id="7c36a-302">Spatial indexes are only supported in queries that include an indexed spatial operator in the `WHERE` clause.</span></span> <span data-ttu-id="7c36a-303">たとえば、次のような構文を考えてみます。</span><span class="sxs-lookup"><span data-stu-id="7c36a-303">For example syntax such as:</span></span>

```
[spatial object].SpatialMethod([reference spatial object]) [ = | < ] [const literal or variable]
```

 <span data-ttu-id="7c36a-304">クエリ オプティマイザーは、空間演算に交換法則が成立することを理解しています (つまり `@a.STIntersects(@b) = @b.STInterestcs(@a)` )。</span><span class="sxs-lookup"><span data-stu-id="7c36a-304">The query optimizer understands the commutativity of spatial operations (that `@a.STIntersects(@b) = @b.STInterestcs(@a)` ).</span></span> <span data-ttu-id="7c36a-305">ただし、比較構文の先頭に空間演算子がない場合、空間インデックスは使用されません (たとえば、 `WHERE 1 = spatial op` では空間インデックスは使用されません)。</span><span class="sxs-lookup"><span data-stu-id="7c36a-305">However, the spatial index will not be used if the beginning of a comparison does not contain the spatial operator (for example `WHERE 1 = spatial op` will not use the spatial index).</span></span> <span data-ttu-id="7c36a-306">空間インデックスを使用するには、比較構文を書き直します (たとえば、 `WHERE spatial op = 1`のようにします)。</span><span class="sxs-lookup"><span data-stu-id="7c36a-306">To use the spatial index, rewrite the comparison (for example `WHERE spatial op = 1`).</span></span>

 <span data-ttu-id="7c36a-307">他のインデックスと同様に、空間インデックスがサポートされていても、空間インデックスを使用するかどうかはコストに基づいて決定されます。そのため、必要な条件をすべて満たしている場合でも、クエリ オプティマイザーが空間インデックスを使用しないこともあります。</span><span class="sxs-lookup"><span data-stu-id="7c36a-307">As with any other index, when a spatial index is supported, the use of the spatial index is chosen based on cost, so the query optimizer might not choose to use the spatial index even though all requirements for using it are met.</span></span> <span data-ttu-id="7c36a-308">空間インデックスが使用されたか確認するにはプラン表示を使用し、必要に応じてクエリ ヒントを指定して、目的のクエリ プランを表示します。</span><span class="sxs-lookup"><span data-stu-id="7c36a-308">Use showplan to see if the spatial index was used and if necessary provide query hints to force a desired query plan.</span></span>

 <span data-ttu-id="7c36a-309">ニアレスト ネイバー タイプのクエリも空間インデックスをサポートしますが、それは、特定のクエリ構文が使用された場合だけです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-309">The nearest neighbor type of query also supports spatial indexes however only if a specific query syntax is written.</span></span> <span data-ttu-id="7c36a-310">適切な構文は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="7c36a-310">The appropriate syntax is:</span></span>

```
SELECT TOP(K) [WITH TIES] * 
FROM <Table> AS T [WITH(INDEX(<SpatialIndex>))]
WHERE <SpatialColumn>.STDistance(@reference_object) IS NOT NULL
ORDER BY <SpatialColumn>.STDistance(@reference_object) [;]
```

## <a name="see-also"></a><span data-ttu-id="7c36a-311">参照</span><span class="sxs-lookup"><span data-stu-id="7c36a-311">See Also</span></span>
 [<span data-ttu-id="7c36a-312">空間データ &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7c36a-312">Spatial Data &#40;SQL Server&#41;</span></span>](../spatial/spatial-data-sql-server.md)


