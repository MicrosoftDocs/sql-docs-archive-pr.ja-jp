---
title: テーブル値パラメーターへのデータの挿入 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters, inserting data into
ms.assetid: 9c1a3234-4675-40d3-b473-8df06208f880
author: rothja
ms.author: jroth
ms.openlocfilehash: 38e33c6e58bc2633591fa80e095ceafe46f67045
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87634493"
---
# <a name="inserting-data-into-table-valued-parameters"></a><span data-ttu-id="2f7f9-102">テーブル値パラメーターへのデータの挿入</span><span class="sxs-lookup"><span data-stu-id="2f7f9-102">Inserting Data into Table-Valued Parameters</span></span>
  <span data-ttu-id="2f7f9-103">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]Native Client OLE DB プロバイダーは、コンシューマーがテーブル値パラメーターの行 (プッシュモデルとプルモデル) にデータを指定するための2つのモデルをサポートします。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider supports two models for the consumer to specify data for table valued parameter rows: a push model and a pull model.</span></span> <span data-ttu-id="2f7f9-104">プル モデルの使用方法を示すサンプルを利用できます。「[SQL Server データ プログラミング サンプル](https://msftdpprodsamples.codeplex.com/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-104">A sample that demonstrates the pull model is available; see [SQL Server Data Programming Samples](https://msftdpprodsamples.codeplex.com/).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2f7f9-105">テーブル値パラメーターの列では、すべての行に既定値以外の値が格納されているか、すべての行に既定値が格納されているかのどちらかでなければなりません。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-105">A table-valued parameter column must have either non-default values in all rows or default values in all rows.</span></span> <span data-ttu-id="2f7f9-106">一部の行にだけ既定値を格納することはできません。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-106">It is not possible to have default values in some rows but not others.</span></span> <span data-ttu-id="2f7f9-107">したがって、テーブル値パラメーターのバインドでは、テーブル値パラメーターの行セット列データに許容される状態値は DBSTATUS_S_ISNULL と DBSTATUS_S_OK だけです。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-107">Therefore, in table-valued parameter bindings, the only status values allowed for table-valued parameter rowset column data are DBSTATUS_S_ISNULL and DBSTATUS_S_OK.</span></span> <span data-ttu-id="2f7f9-108">DBSTATUS_S_DEFAULT ではエラーが発生し、バインド状態値が DBSTATUS_E_BADSTATUS に設定されます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-108">DBSTATUS_S_DEFAULT will result in a failure and the bound status value will be set to DBSTATUS_E_BADSTATUS.</span></span>  
  
## <a name="push-model-loads-all-table-valued-paremeter-data-in-memory"></a><span data-ttu-id="2f7f9-109">プッシュ モデル (メモリ内のすべてのテーブル値パラメーターのデータを読み込む)</span><span class="sxs-lookup"><span data-stu-id="2f7f9-109">Push Model (Loads All Table-Valued Paremeter Data in Memory)</span></span>  
 <span data-ttu-id="2f7f9-110">プッシュ モデルは、パラメーター セットの使用方法 (ICommand::Execute の DBPARAMS パラメーター) に似ています。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-110">The push model is similar to the use of parameter sets (that is, the DBPARAMS parameter in ICommand::Execute).</span></span> <span data-ttu-id="2f7f9-111">プッシュ モデルが使用されるのは、IRowset インターフェイスをカスタマイズして実装せずに、テーブル値パラメーターの行セット オブジェクトを使用する場合だけです。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-111">The push model is only used if table-valued parameter rowset objects are used without a customized implementation of IRowset interfaces.</span></span> <span data-ttu-id="2f7f9-112">テーブル値パラメーターの行セット内の行数が少なく、アプリケーションに高いメモリ負荷がかからないことが見込まれる場合は、プッシュ モデルをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-112">The push model is recommended when the number of rows in the table-valued parameter rowset is small and is not expected to put excessive memory pressure on the application.</span></span> <span data-ttu-id="2f7f9-113">プッシュ モデルは、プル モデルよりも簡単な方法です。このモデルでは、コンシューマー アプリケーションに対し、標準的な OLE DB アプリケーションで現在一般的である以上の機能は要求されません。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-113">This is simpler than the pull model, because it does not require any more functionality from the consumer application than what is currently common in typical OLE DB applications.</span></span>  
  
 <span data-ttu-id="2f7f9-114">コンシューマーは、コマンドを実行する前に、すべてのテーブル値パラメーターのデータをプロバイダーに提供します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-114">The consumer is expected to provide all the table-valued parameter data to the provider before executing a command.</span></span> <span data-ttu-id="2f7f9-115">コンシューマーは、データを提供するために、各テーブル値パラメーター用にテーブル値パラメーターの行セット オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-115">To provide the data, the consumer populates a table-valued parameter rowset object for each table-valued parameter.</span></span> <span data-ttu-id="2f7f9-116">テーブル値パラメーターの行セット オブジェクトでは、行セットの挿入、設定、および削除の各操作が公開されます。このような操作は、コンシューマーがテーブル値パラメーターのデータを操作する際に使用します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-116">The table-valued parameter rowset object exposes rowset Insert, Set, and Delete operations, which the consumer will use to manipulate the table-valued parameter data.</span></span> <span data-ttu-id="2f7f9-117">プロバイダーでは、実行時にこのテーブル値パラメーターの行セット オブジェクトからデータをフェッチします。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-117">The provider will fetch the data from this table-valued parameter rowset object at execution time.</span></span>  
  
 <span data-ttu-id="2f7f9-118">テーブル値パラメーターの行セット オブジェクトがコンシューマーに提供されると、コンシューマーはそのオブジェクトを行セット オブジェクトとして処理できます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-118">When a table-valued parameter rowset object is provided to the consumer, the consumer can process it as a rowset object.</span></span> <span data-ttu-id="2f7f9-119">コンシューマーは IColumnsInfo::GetColumnInfo インターフェイス メソッドまたは IColumnsRowset::GetColumnsRowset インターフェイス メソッドを使用し、各列の型情報 (型、最大長、有効桁数、小数点以下桁数) を取得できます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-119">The consumer can obtain the type information of each column (type, maximum length, precision, and scale) by using the IColumnsInfo::GetColumnInfo or IColumnsRowset::GetColumnsRowset interface method.</span></span> <span data-ttu-id="2f7f9-120">その後、コンシューマーはアクセサーを作成してデータのバインドを指定します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-120">The consumer then creates an accessor to specify the bindings for the data.</span></span> <span data-ttu-id="2f7f9-121">次に、データ行をテーブル値パラメーターの行セットに挿入します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-121">The next step is to insert rows of data into the table-valued parameter rowset.</span></span> <span data-ttu-id="2f7f9-122">これは IRowsetChange::InsertRow の使用で行えます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-122">This can be done by using IRowsetChange::InsertRow.</span></span> <span data-ttu-id="2f7f9-123">データを操作する必要がある場合、IRowsetChange::SetData または IRowsetChange::DeleteRows もテーブル値パラメーターの行セット オブジェクトで使用できます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-123">IRowsetChange::SetData or IRowsetChange::DeleteRows can also be used on the table-valued parameter rowset object if you have to manipulate the data.</span></span> <span data-ttu-id="2f7f9-124">テーブル値パラメーターの行セット オブジェクトは、ストリーム オブジェクトと同様に参照数がカウントされます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-124">Table-valued parameter rowset objects are reference counted, similar to stream objects.</span></span>  
  
 <span data-ttu-id="2f7f9-125">IColumnsRowset::GetColumnsRowset が使用される場合、後で、結果的に生成される列の行セット オブジェクトで IRowset::GetNextRows、IRowset::GetData、IRowset::ReleaseRows メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-125">If IColumnsRowset::GetColumnsRowset is used, there will be subsequent calls to IRowset::GetNextRows, IRowset::GetData, and IRowset::ReleaseRows methods on the rowset object of the resulting column.</span></span>  
  
 <span data-ttu-id="2f7f9-126">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]Native Client OLE DB プロバイダーがコマンドの実行を開始すると、テーブル値パラメーターの値がこのテーブル値パラメーターの行セットオブジェクトからフェッチされ、サーバーに送信されます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-126">After the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider begins executing the command, the table-valued parameter values will be fetched from this table-valued parameter rowset object and sent to the server.</span></span>  
  
 <span data-ttu-id="2f7f9-127">プッシュ モデルでは、コンシューマーによる作業は必要最小限になりますが、使用するメモリはプル モデルよりも多くなります。これは、すべてのテーブル値パラメーターのデータが実行時にメモリ内に存在する必要があるためです。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-127">The push model requires minimal work by the consumer, but uses more memory than the pull model, because all the table-valued parameter data has to be in memory at execution time.</span></span>  
  
## <a name="pull-model-obtaining-table-valued-parameter-data-on-demand-from-the-consumer"></a><span data-ttu-id="2f7f9-128">プル モデル (要求時にコンシューマーからテーブル値パラメーターのデータを取得する)</span><span class="sxs-lookup"><span data-stu-id="2f7f9-128">Pull Model (Obtaining Table-Valued Parameter Data on Demand from the Consumer)</span></span>  
 <span data-ttu-id="2f7f9-129">プル モデルは、次の 2 つのシナリオで役立ちます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-129">The pull model is useful for two scenarios:</span></span>  
  
-   <span data-ttu-id="2f7f9-130">行をストリームする場合。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-130">To stream rows.</span></span>  
  
-   <span data-ttu-id="2f7f9-131">別のプロバイダーの行セットがテーブル値パラメーターの値として使用されている場合。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-131">If a rowset from another provider is being used as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="2f7f9-132">プル モデルでは、コンシューマーが要求時にプロバイダーにデータを提供します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-132">In the pull model, the consumer provides data on demand to the provider.</span></span> <span data-ttu-id="2f7f9-133">この方法は、アプリケーションでデータの挿入が何度も行われ、メモリ内のテーブル値パラメーターの行セットのデータが過度にメモリにアクセスする場合に使用します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-133">Use this approach if your application has many data insertions, and table-valued parameter rowset data in memory would result in excessive memory access.</span></span> <span data-ttu-id="2f7f9-134">複数の OLE DB プロバイダーが使用される場合、プル モデルでは、コンシューマーが任意の行セット オブジェクトをテーブル値パラメーターの値として提供できます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-134">If multiple OLE DB providers are used, the consumer pull model enables the consumer to provide any rowset object as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="2f7f9-135">プル モデルを使用するには、コンシューマーが行セット オブジェクトを独自に実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-135">To use the pull model, consumers have to provide their own implementation of a rowset object.</span></span> <span data-ttu-id="2f7f9-136">テーブル値パラメーターの行セット (CLSID_ROWSET_TVP) でプル モデルを使用する場合、プロバイダーが ITableDefinitionWithConstraints::CreateTableWithConstraints メソッドまたは IOpenRowset::OpenRowset メソッドを使用して公開する、テーブル値パラメーターの行セット オブジェクトを集計するためにコンシューマーが必要になります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-136">When using the pull model with table-valued parameter rowsets (CLSID_ROWSET_TVP), the consumer is required to aggregate the table-valued parameter rowset object that the provider exposes through the ITableDefinitionWithConstraints::CreateTableWithConstraints method or the IOpenRowset::OpenRowset method.</span></span> <span data-ttu-id="2f7f9-137">コンシューマー オブジェクトに期待されるのは、IRowset インターフェイスの実装をオーバーライドすることだけです。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-137">The consumer object is only expected to override the IRowset interface implementation.</span></span> <span data-ttu-id="2f7f9-138">次の関数をオーバーライドする必要があります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-138">You must override the following functions:</span></span>  
  
-   <span data-ttu-id="2f7f9-139">IRowset::GetNextRows</span><span class="sxs-lookup"><span data-stu-id="2f7f9-139">IRowset::GetNextRows</span></span>  
  
-   <span data-ttu-id="2f7f9-140">IRowset::AddRefRows</span><span class="sxs-lookup"><span data-stu-id="2f7f9-140">IRowset::AddRefRows</span></span>  
  
-   <span data-ttu-id="2f7f9-141">IRowset::GetData</span><span class="sxs-lookup"><span data-stu-id="2f7f9-141">IRowset::GetData</span></span>  
  
-   <span data-ttu-id="2f7f9-142">IRowset::ReleaseRows</span><span class="sxs-lookup"><span data-stu-id="2f7f9-142">IRowset::ReleaseRows</span></span>  
  
-   <span data-ttu-id="2f7f9-143">IRowset::RestartPosition</span><span class="sxs-lookup"><span data-stu-id="2f7f9-143">IRowset::RestartPosition</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="2f7f9-144">Native Client OLE DB プロバイダーでは、コンシューマーの行セット オブジェクトから一度に 1 つ以上の行を読み取り、テーブル値パラメーターのストリーミング動作をサポートします。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-144">Native Client OLE DB Provider will read one or more rows at a time from the consumer rowset object to support streaming behavior in table-valued parameters.</span></span> <span data-ttu-id="2f7f9-145">たとえば、ユーザーは、(メモリではなく) ディスクにテーブル値パラメーターの行セットのデータを保持し、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダーから要求されたときにディスクからデータを読み取る機能を実装する場合があります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-145">For example, the user might have the table-valued parameter rowset data on disk (not in memory) and might implement the functionality to read data from the disk when required by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider.</span></span>  
  
 <span data-ttu-id="2f7f9-146">コンシューマーは、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] テーブル値パラメーターの行セットオブジェクトに対して IAccessor:: CreateAccessor を使用して、データ形式を Native Client OLE DB プロバイダーに通知します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-146">The consumer will communicate its data format to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider by using IAccessor::CreateAccessor on the table-valued parameter rowset object.</span></span> <span data-ttu-id="2f7f9-147">プロバイダーは、データをコンシューマー バッファーから読み取る際に、既定以外の書き込み可能な列すべてを少なくとも 1 つのアクセサー ハンドルで使用できることを確認し、対応するハンドルを使用して列のデータを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-147">When reading data from the consumer buffer, the provider verifies that all the writable and non-default columns are available through at least one accessor handle, and uses the corresponding handles to read columns data.</span></span> <span data-ttu-id="2f7f9-148">あいまいさを排除するため、テーブル値パラメーターの行セットの列とバインドが一対一で対応するようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-148">To avoid ambiguity, there should be a one-to-one correspondence between a table-valued parameter rowset column and a binding.</span></span> <span data-ttu-id="2f7f9-149">同じ列に対するバインドが重複すると、エラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-149">Duplicate bindings to the same column will result in an error.</span></span> <span data-ttu-id="2f7f9-150">また、各アクセサーでは、DBBindings の *iOrdinal* メンバーを順番に使用します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-150">Also, each accessor is expected to have the *iOrdinal* member of DBBindings in sequence.</span></span> <span data-ttu-id="2f7f9-151">IRowset::GetData が各行のアクセサーの数と同じ回数だけ呼び出されます。呼び出しの順序は、*iOrdinal* 値の順序 (昇順) に基づきます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-151">There will be as many calls to IRowset::GetData as the number of accessors per row, and the order of calls will be based on the order of *iOrdinal* value from lower to higher values.</span></span>  
  
 <span data-ttu-id="2f7f9-152">プロバイダーは、テーブル値パラメーターの行セット オブジェクトで公開されるインターフェイスのほとんどを実装することが期待されています。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-152">The provider is expected to implement most of the interfaces exposed by the table-valued parameter rowset object.</span></span> <span data-ttu-id="2f7f9-153">コンシューマーは、最小限のインターフェイス (IRowset) を使用して行セット オブジェクトを実装します。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-153">The consumer will implement a rowset object with minimal interfaces (IRowset).</span></span> <span data-ttu-id="2f7f9-154">無計画な集計があるため、残りの必須の行セット オブジェクトのインターフェイスは、テーブル値パラメーターの行セット オブジェクトによって実装されます。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-154">Because of blind aggregation, the remaining mandatory rowset object interfaces will be implemented by the table-valued parameter rowset object.</span></span>  
  
 <span data-ttu-id="2f7f9-155">任意の OLE DB プロバイダー用に取得した行セット オブジェクトなどの他の行セット オブジェクトの場合、コンシューマーが提供した行セットは、OLE DB の仕様で指定されているとおり、必須の行セット オブジェクトのインターフェイスすべてを実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-155">For any other rowset object, such as rowset objects obtained for any OLE DB provider, the consumer-provided rowset must implement all the mandatory rowset object interfaces as specified in the OLE DB specification.</span></span>  
  
 <span data-ttu-id="2f7f9-156">実行時に、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダーは行セット オブジェクトにコールバックし、行をフェッチして列のデータを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="2f7f9-156">At the time of execution, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider will call back to the rowset object to fetch rows and read column data.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2f7f9-157">参照</span><span class="sxs-lookup"><span data-stu-id="2f7f9-157">See Also</span></span>  
 <span data-ttu-id="2f7f9-158">[テーブル値パラメーター &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span><span class="sxs-lookup"><span data-stu-id="2f7f9-158">[Table-Valued Parameters &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span></span>  
 [<span data-ttu-id="2f7f9-159">テーブル値パラメーターの使用 &#40;OLE DB&#41;</span><span class="sxs-lookup"><span data-stu-id="2f7f9-159">Use Table-Valued Parameters &#40;OLE DB&#41;</span></span>](../native-client-ole-db-how-to/use-table-valued-parameters-ole-db.md)  
  
