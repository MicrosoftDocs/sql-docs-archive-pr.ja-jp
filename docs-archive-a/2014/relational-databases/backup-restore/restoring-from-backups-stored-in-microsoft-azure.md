---
title: Azure に格納されているバックアップからの復元 |Microsoft Docs
ms.custom: ''
ms.date: 03/07/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 6ae358b2-6f6f-46e0-a7c8-f9ac6ce79a0e
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 68b270f18cb4dbc2724c5a062afae54fa711acec
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87643415"
---
# <a name="restoring-from-backups-stored-in-azure"></a><span data-ttu-id="18a3e-102">Azure に格納されたバックアップからの復元</span><span class="sxs-lookup"><span data-stu-id="18a3e-102">Restoring From Backups Stored in Azure</span></span>
  <span data-ttu-id="18a3e-103">このトピックでは、Azure Blob Storage サービスに格納されたバックアップを使用してデータベースを復元するときの注意事項について説明します。</span><span class="sxs-lookup"><span data-stu-id="18a3e-103">This topic outlines the considerations when restoring a database using a backup stored in the Azure Blob storage service.</span></span> <span data-ttu-id="18a3e-104">このトピックは、SQL Server Backup to URL または [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)]を使用して作成されたバックアップが対象です。</span><span class="sxs-lookup"><span data-stu-id="18a3e-104">This applies to backups created either by using SQL Server Backup to URL backup or by [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)].</span></span>  
  
 <span data-ttu-id="18a3e-105">Azure Blob Storage サービスに格納されたバックアップを復元する計画がある場合は、このトピックを確認した後、データベースの復元方法 (オンプレミス バックアップでも Azure バックアップでも同じ) の手順が説明されているトピックを確認することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="18a3e-105">We recommend reviewing this topic if you have backups stored in the Azure Blob storage service that you plan to restore, and then review the topics that describe the steps on how to restore a database which is the same for both on-premises and azure backups.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="18a3e-106">概要</span><span class="sxs-lookup"><span data-stu-id="18a3e-106">Overview</span></span>  
 <span data-ttu-id="18a3e-107">内部設置型バックアップからデータベースを復元するために使用するツールや方法は、クラウド バックアップからのデータベースの復元にも当てはまります。</span><span class="sxs-lookup"><span data-stu-id="18a3e-107">The tools and methods that are used to restore a database from an on-premises backup apply to restoring a database from a cloud backup.</span></span>  <span data-ttu-id="18a3e-108">以下のセクションでは、これらの注意事項に加えて、Azure Blob Storage サービスに格納されたバックアップを使用するときに知っておく必要がある相違点について説明します。</span><span class="sxs-lookup"><span data-stu-id="18a3e-108">The following sections describe these considerations and any differences you should know about when you use backups stored in the Azure Blob storage service.</span></span>  
  
### <a name="using-transact-sql"></a><span data-ttu-id="18a3e-109">Transact-SQL の使用</span><span class="sxs-lookup"><span data-stu-id="18a3e-109">Using Transact-SQL</span></span>  
  
-   <span data-ttu-id="18a3e-110">SQL Server はバックアップ ファイルを取得するために外部ソースに接続する必要があるため、SQL 資格情報を使用してストレージ アカウントへの認証を行います。</span><span class="sxs-lookup"><span data-stu-id="18a3e-110">Since SQL Server must connect to an external source to retrieve the backup files, SQL Credential is used to authenticate to the storage account.</span></span> <span data-ttu-id="18a3e-111">そのため、RESTORE ステートメントには WITH CREDENTIAL オプションが必要です。</span><span class="sxs-lookup"><span data-stu-id="18a3e-111">Consequently, the RESTORE statement requires WITH CREDENTIAL option.</span></span> <span data-ttu-id="18a3e-112">詳細については、「 [Azure BLOB ストレージ サービスを使用した SQL Server のバックアップと復元](sql-server-backup-and-restore-with-microsoft-azure-blob-storage-service.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="18a3e-112">For more information, see [SQL Server Backup and Restore with Azure Blob Storage Service](sql-server-backup-and-restore-with-microsoft-azure-blob-storage-service.md).</span></span>  
  
-   <span data-ttu-id="18a3e-113">[!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)] を使用してクラウドへのバックアップを管理している場合は、 **smart_admin.fn_available_backups** システム関数を使用すると、ストレージ内の使用可能なバックアップをすべて確認できます。</span><span class="sxs-lookup"><span data-stu-id="18a3e-113">If you are using the [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)] to manage your backups to the cloud, you can review all the available backups in the storage, by using the **smart_admin.fn_available_backups** system function.</span></span> <span data-ttu-id="18a3e-114">このシステム関数により、テーブル内のデータベースの使用可能なすべてのバックアップが返されます。</span><span class="sxs-lookup"><span data-stu-id="18a3e-114">This system function returns all the available backups for a database in a table.</span></span> <span data-ttu-id="18a3e-115">結果はテーブルで返されるため、結果のフィルター処理または並べ替えが可能です。</span><span class="sxs-lookup"><span data-stu-id="18a3e-115">As the results are returned in a table, you can filter or sort the results.</span></span> <span data-ttu-id="18a3e-116">詳細については、「smart_admin」を参照してください[。 transact-sql&#41;&#40;fn_available_backups ](/sql/relational-databases/system-functions/managed-backup-fn-available-backups-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="18a3e-116">For more information, see [smart_admin.fn_available_backups &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/managed-backup-fn-available-backups-transact-sql).</span></span>  
  
### <a name="using-sql-server-management-studio"></a><span data-ttu-id="18a3e-117">SQL Server Management Studio を使用する</span><span class="sxs-lookup"><span data-stu-id="18a3e-117">Using SQL Server Management Studio</span></span>  
  
-   <span data-ttu-id="18a3e-118">復元タスクは、SQL Server Management Studio を使用してデータベースを復元するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="18a3e-118">The restore task is used to restore a database using the SQL Server Management Studio.</span></span> <span data-ttu-id="18a3e-119">現在、バックアップ メディアのページには、Azure Blob Storage サービスに格納されたバックアップ ファイルを表示するための **[URL]** オプションがあります。</span><span class="sxs-lookup"><span data-stu-id="18a3e-119">The backup media page now includes the **URL** option to show backup files stored in the Azure Blob storage service.</span></span> <span data-ttu-id="18a3e-120">また、ストレージ アカウントへの認証に使用する SQL 資格情報を指定することも必要です。</span><span class="sxs-lookup"><span data-stu-id="18a3e-120">You also must provide the SQL Credential that is used to authenticate to the storage account.</span></span> <span data-ttu-id="18a3e-121">その後、 **[復元するバックアップ セット]** グリッドには、Azure Blob Storage 内の使用可能なバックアップが表示されます。</span><span class="sxs-lookup"><span data-stu-id="18a3e-121">The **Backup sets to restore** grid is then populated with the available backups in the Azure Blob storage.</span></span> <span data-ttu-id="18a3e-122">詳細については、「[SQL Server Management Studio を使用した Microsoft Azure Storage からの復元](sql-server-backup-to-url.md#RestoreSSMS)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="18a3e-122">For more information, see [Restoring from Azure storage Using SQL Server Management Studio](sql-server-backup-to-url.md#RestoreSSMS).</span></span>  
  
### <a name="optimizing-restores"></a><span data-ttu-id="18a3e-123">復元の最適化</span><span class="sxs-lookup"><span data-stu-id="18a3e-123">Optimizing Restores</span></span>  
 <span data-ttu-id="18a3e-124">復元の書き込み時間を短縮するには、SQL Server ユーザー アカウントに **[ボリュームの保守タスクを実行]** ユーザー権利を追加します。</span><span class="sxs-lookup"><span data-stu-id="18a3e-124">To reduce restore write time, Add **perform volume maintenance tasks** user right to the SQL Server user account.</span></span> <span data-ttu-id="18a3e-125">詳細については、「 [データベース ファイルの初期化](https://go.microsoft.com/fwlink/?LinkId=271622)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="18a3e-125">For more information, see [Database File Initialization](https://go.microsoft.com/fwlink/?LinkId=271622).</span></span> <span data-ttu-id="18a3e-126">ファイルの瞬時初期化が有効な状態で復元が依然として低速な場合は、データベースをバックアップしたときに使用したインスタンスに対応するログ ファイルのサイズに注目します。</span><span class="sxs-lookup"><span data-stu-id="18a3e-126">If restore is still slow with instant file initialization turned on, look at the size of the log file on the instance where the database was backed up.</span></span> <span data-ttu-id="18a3e-127">ログのサイズが非常に大きい場合 (数 GB) は、復元が低速であることが予期されます。</span><span class="sxs-lookup"><span data-stu-id="18a3e-127">If the log is very large in size (multiple GBs), it would be expected that restore would be slow.</span></span> <span data-ttu-id="18a3e-128">ログ ファイルの処理に長い時間が費やされるために、復元中はログ ファイルのサイズを 0 にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="18a3e-128">During restore the log file must be zeroed which takes a significant amount of time.</span></span>  
  
 <span data-ttu-id="18a3e-129">復元時間を短縮するには、圧縮されたバックアップを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="18a3e-129">To reduce restore times it is recommended that you use compressed backups.</span></span>  <span data-ttu-id="18a3e-130">バックアップ サイズが 25 GB を超える場合は、 [AzCopy ユーティリティ](https://docs.microsoft.com/archive/blogs/windowsazurestorage/azcopy-uploadingdownloading-files-for-windows-azure-blobs) を使用してローカル ドライブにダウンロードしてから復元を実行します。</span><span class="sxs-lookup"><span data-stu-id="18a3e-130">For backup sizes exceeding 25 GB, use [AzCopy utility](https://docs.microsoft.com/archive/blogs/windowsazurestorage/azcopy-uploadingdownloading-files-for-windows-azure-blobs) to download to the local drive and then perform the restore.</span></span> <span data-ttu-id="18a3e-131">バックアップに関するその他のベスト プラクティスと推奨事項については、「 [SQL Server Backup to URL のベスト プラクティスとトラブルシューティング](sql-server-backup-to-url-best-practices-and-troubleshooting.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="18a3e-131">For other backup best practices and recommendations, see [SQL Server Backup to URL Best Practices and Troubleshooting](sql-server-backup-to-url-best-practices-and-troubleshooting.md).</span></span>  
  
 <span data-ttu-id="18a3e-132">復元を実行するときに詳細ログを生成するために、トレース フラグ 3051 を有効にすることもできます。</span><span class="sxs-lookup"><span data-stu-id="18a3e-132">You can also turn on Trace Flag 3051 when doing the restore to generate a detailed log.</span></span> <span data-ttu-id="18a3e-133">このログ ファイルはログ ディレクトリに配置され、次の形式を使用して名前が付けられます: BackupToUrl-\<instancename>-\<dbname>-action-\<PID>.log。</span><span class="sxs-lookup"><span data-stu-id="18a3e-133">This log file is placed in the log directory, and is named using the format: BackupToUrl-\<instancename>-\<dbname>-action-\<PID>.log.</span></span> <span data-ttu-id="18a3e-134">このログ ファイルには、問題の診断に役に立つタイミングも含め、Azure Storage への各ラウンド トリップが記録されます。</span><span class="sxs-lookup"><span data-stu-id="18a3e-134">The log file includes information about each round trip to Azure Storage including timing that can be helpful in diagnosing the issue.</span></span>  
  
### <a name="topics-on-performing-restore-operations"></a><span data-ttu-id="18a3e-135">復元操作の実行に関するトピック</span><span class="sxs-lookup"><span data-stu-id="18a3e-135">Topics on Performing Restore Operations</span></span>  
  
-   [<span data-ttu-id="18a3e-136">データベースの全体復元 &#40;単純復旧モデル&#41;</span><span class="sxs-lookup"><span data-stu-id="18a3e-136">Complete Database Restores &#40;Simple Recovery Model&#41;</span></span>](complete-database-restores-simple-recovery-model.md)  
  
-   [<span data-ttu-id="18a3e-137">RESTORE &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="18a3e-137">RESTORE &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/restore-statements-transact-sql)  
  
-   [<span data-ttu-id="18a3e-138">データベースの全体復元 &#40;完全復旧モデル&#41;</span><span class="sxs-lookup"><span data-stu-id="18a3e-138">Complete Database Restores &#40;Full Recovery Model&#41;</span></span>](complete-database-restores-full-recovery-model.md)  
  
-   [<span data-ttu-id="18a3e-139">ファイル復元 &#40;単純復旧モデル&#41;</span><span class="sxs-lookup"><span data-stu-id="18a3e-139">File Restores &#40;Simple Recovery Model&#41;</span></span>](file-restores-simple-recovery-model.md)  
  
-   [<span data-ttu-id="18a3e-140">ファイル復元 &#40; 完全復旧モデル&#41;</span><span class="sxs-lookup"><span data-stu-id="18a3e-140">File Restores &#40;Full Recovery Model&#41;</span></span>](file-restores-full-recovery-model.md)  
  
-   [<span data-ttu-id="18a3e-141">段階的な部分復元 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="18a3e-141">Piecemeal Restores &#40;SQL Server&#41;</span></span>](piecemeal-restores-sql-server.md)  
  
  
