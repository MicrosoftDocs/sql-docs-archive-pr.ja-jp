---
title: 変更データ キャプチャの管理と監視 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data capture [SQL Server], monitoring
- change data capture [SQL Server], administering
- change data capture [SQL Server], jobs
ms.assetid: 23bda497-67b2-4e7b-8e4d-f1f9a2236685
author: rothja
ms.author: jroth
ms.openlocfilehash: 8d97929ead145d1b0de1a1f83becb15ade397683
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87642650"
---
# <a name="administer-and-monitor-change-data-capture-sql-server"></a><span data-ttu-id="c846c-102">変更データ キャプチャの管理と監視 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c846c-102">Administer and Monitor Change Data Capture (SQL Server)</span></span>
  <span data-ttu-id="c846c-103">このトピックでは、変更データ キャプチャを管理および監視する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="c846c-103">This topic describes how to administer and monitor change data capture.</span></span>  
  
##  <a name="capture-job"></a><a name="Capture"></a> <span data-ttu-id="c846c-104">キャプチャ ジョブ</span><span class="sxs-lookup"><span data-stu-id="c846c-104">Capture Job</span></span>  
 <span data-ttu-id="c846c-105">キャプチャ ジョブは、パラメーターなしのストアド プロシージャ `sp_MScdc_capture_job` を実行することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-105">The capture job is initiated by running the parameterless stored procedure `sp_MScdc_capture_job`.</span></span> <span data-ttu-id="c846c-106">このストアド プロシージャは、msdb.dbo.cdc_jobs からキャプチャ ジョブの *maxtrans*、 *maxscans*、 *continuous*、および *pollinginterval* の構成値を抽出することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-106">This stored procedure starts by extracting the configured values for *maxtrans*, *maxscans*, *continuous*, and *pollinginterval* for the capture job from msdb.dbo.cdc_jobs.</span></span> <span data-ttu-id="c846c-107">これらの構成値は、パラメーターとしてストアド プロシージャ `sp_cdc_scan` に渡されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-107">These configured values are then passed as parameters to the stored procedure `sp_cdc_scan`.</span></span> <span data-ttu-id="c846c-108">これは `sp_replcmds` を呼び出してログ スキャンを実行する場合に使用されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-108">This is used to invoke `sp_replcmds` to perform the log scan.</span></span>  
  
### <a name="capture-job-parameters"></a><span data-ttu-id="c846c-109">キャプチャ ジョブのパラメーター</span><span class="sxs-lookup"><span data-stu-id="c846c-109">Capture Job Parameters</span></span>  
 <span data-ttu-id="c846c-110">キャプチャ ジョブの動作を理解するには、`sp_cdc_scan` における構成可能パラメーターの使用方法について理解する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c846c-110">To understand capture job behavior, you must understand how the configurable parameters are used by `sp_cdc_scan`.</span></span>  
  
#### <a name="maxtrans-parameter"></a><span data-ttu-id="c846c-111">maxtrans パラメーター</span><span class="sxs-lookup"><span data-stu-id="c846c-111">maxtrans Parameter</span></span>  
 <span data-ttu-id="c846c-112">*maxtrans* パラメーターは、ログの単一のスキャン サイクルで処理できるトランザクションの最大数を指定します。</span><span class="sxs-lookup"><span data-stu-id="c846c-112">The *maxtrans* parameter specifies the maximum number of transactions that can be processed in a single scan cycle of the log.</span></span> <span data-ttu-id="c846c-113">スキャン時に、処理するトランザクションの数がこの制限値に達すると、現在のスキャンにはそれ以上のトランザクションは含まれません。</span><span class="sxs-lookup"><span data-stu-id="c846c-113">If, during the scan, the number of transactions to be processed reaches this limit, no additional transactions are included in the current scan.</span></span> <span data-ttu-id="c846c-114">スキャン サイクルの完了後は、処理されたトランザクションの数は常に *maxtrans*以下になります。</span><span class="sxs-lookup"><span data-stu-id="c846c-114">After a scan cycle is complete, the number of transactions that were processed will always be less than or equal to *maxtrans*.</span></span>  
  
#### <a name="maxscans-parameter"></a><span data-ttu-id="c846c-115">maxscans パラメーター</span><span class="sxs-lookup"><span data-stu-id="c846c-115">maxscans Parameter</span></span>  
 <span data-ttu-id="c846c-116">*maxscans* パラメーターは、制御を返す前 (continuous = 0)、または waitfor を実行する前 (continuous = 1) に、ログを空にするために実行されるスキャン サイクルの最大数を指定します。</span><span class="sxs-lookup"><span data-stu-id="c846c-116">The *maxscans* parameter specifies the maximum number of scan cycles that are attempted to drain the log before either returning (continuous = 0) or executing a waitfor (continuous = 1).</span></span>  
  
#### <a name="continuous-parameter"></a><span data-ttu-id="c846c-117">continuous パラメーター</span><span class="sxs-lookup"><span data-stu-id="c846c-117">continuous Parameter</span></span>  
 <span data-ttu-id="c846c-118">*Continuous*パラメーターは、 `sp_cdc_scan` ログをドレインするか、最大数のスキャンサイクル (ワンショットモード) を実行した後で、で制御が解放されるかどうかを制御します。</span><span class="sxs-lookup"><span data-stu-id="c846c-118">The *continuous* parameter controls whether `sp_cdc_scan` relinquishes control in after either draining the log or executing the maximum number of scan cycles (one shot mode).</span></span> <span data-ttu-id="c846c-119">また、明示的に停止されるまで、`sp_cdc_scan` の実行を継続するかどうかもこのパラメーターが制御します (連続モード)。</span><span class="sxs-lookup"><span data-stu-id="c846c-119">It also controles whether `sp_cdc_scan` continues to run until explicitly stopped (continuous mode).</span></span>  
  
##### <a name="one-shot-mode"></a><span data-ttu-id="c846c-120">ワン ショット モード</span><span class="sxs-lookup"><span data-stu-id="c846c-120">One Shot Mode</span></span>  
 <span data-ttu-id="c846c-121">ワンショットモードでは、キャプチャジョブは `sp_cdc_scan` 最大*maxtrans*スキャンを実行してログのドレインを試行し、を返すように要求します。</span><span class="sxs-lookup"><span data-stu-id="c846c-121">In one shot mode, the capture job requests `sp_cdc_scan` to perform up to *maxtrans* scans to try to drain the log and return.</span></span> <span data-ttu-id="c846c-122">ログに存在するトランザクションで *maxtrans* を超えた分は後のスキャンで処理されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-122">Any transactions in addition to *maxtrans* that are present in the log will be processed in later scans.</span></span>  
  
 <span data-ttu-id="c846c-123">ワン ショット モードは、処理するトランザクションのボリュームがわかっている、制御されたテストで使用され、完了時にジョブが自動的に終了するという利点があります。</span><span class="sxs-lookup"><span data-stu-id="c846c-123">One shot mode is used in controlled tests, where the volume of transactions to be processed is known, and there are advantages to the fact that the job closes automatically on when it is finished.</span></span> <span data-ttu-id="c846c-124">ワン ショット モードは、実稼働環境用にはお勧めできません。</span><span class="sxs-lookup"><span data-stu-id="c846c-124">One shot mode is not recommended for production use.</span></span> <span data-ttu-id="c846c-125">これは、このモードではジョブ スケジュールに依存してスキャン サイクル実行の頻度が管理されるためです。</span><span class="sxs-lookup"><span data-stu-id="c846c-125">This is because t relies on the job schedule to manage how frequently the scan cycle is run.</span></span>  
  
 <span data-ttu-id="c846c-126">ワン ショット モードでの実行時には、キャプチャ ジョブの予想スループットの上限を計算できます。これは次の計算式を使用して、1 秒あたりのトランザクション数として表します。</span><span class="sxs-lookup"><span data-stu-id="c846c-126">When running in one shot mode, you can compute an upper bound on expected throughput of the capture job, expressed in transactions per second by using the following computation:</span></span>  
  
 `(maxtrans * maxscans) / number of seconds between scans`  
  
 <span data-ttu-id="c846c-127">ログをスキャンして変更テーブルにデータを設定するために必要な時間が 0 とあまり変わらない場合でも、ジョブの平均スループットは、単一スキャンでのトランザクションの最大許容数にスキャンの最大許容数を掛け、それをログ処理間隔の秒数で割った値を超えることはできません。</span><span class="sxs-lookup"><span data-stu-id="c846c-127">Even if the time that is required to scan the log and populate the change tables were not significantly different from 0, the average throughput of the job could not exceed the value obtained by dividing the maximum allowed transactions for a single scan multiplied by the maximum allowed scans by the number of seconds separating log processing.</span></span>  
  
 <span data-ttu-id="c846c-128">ワン ショット モードでログ スキャンを制御する場合は、ログ処理間の秒数をジョブ スケジュールによって決める必要があります。</span><span class="sxs-lookup"><span data-stu-id="c846c-128">If one shot mode were to be used to regulate log scanning, the number of seconds between log processing would have to be governed by the job schedule.</span></span> <span data-ttu-id="c846c-129">このような動作が必要な場合、ログ スキャンの再スケジュールの管理には、連続モードでのキャプチャ ジョブの実行がより適しています。</span><span class="sxs-lookup"><span data-stu-id="c846c-129">When this kind of behavior is desired, running the capture job in continuous mode is a better way to manage rescheduling the log scan.</span></span>  
  
##### <a name="continuous-mode-and-the-polling-interval"></a><span data-ttu-id="c846c-130">連続モードとポーリング間隔</span><span class="sxs-lookup"><span data-stu-id="c846c-130">Continuous Mode and the Polling Interval</span></span>  
 <span data-ttu-id="c846c-131">連続モードでは、キャプチャ ジョブは `sp_cdc_scan` が継続的に実行されることを要求します。</span><span class="sxs-lookup"><span data-stu-id="c846c-131">In continuous mode, the capture job requests that `sp_cdc_scan` run continuously.</span></span> <span data-ttu-id="c846c-132">これにより、ストアド プロシージャは、maxtrans と maxscans だけではなく、ログ処理間 (ポーリング間隔) の秒数の値を指定することにより、独自の wait ループを管理できます。</span><span class="sxs-lookup"><span data-stu-id="c846c-132">This lets the stored procedure manage its own wait loop by providing not only for maxtrans and maxscans but also a value for the number of seconds between log processing (the polling interval).</span></span> <span data-ttu-id="c846c-133">このモードを実行すると、キャプチャ ジョブはアクティブな状態を維持し、ログ スキャン間に `WAITFOR` を実行します。</span><span class="sxs-lookup"><span data-stu-id="c846c-133">Running in this mode, the capture job remains active, executing a `WAITFOR` between log scanning.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c846c-134">ポーリング間隔の値が 0 より大きい場合、定期的なワン ショット ジョブのスループットと同じ上限が連続モードのジョブ操作にも適用されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-134">When the value of the polling interval is greater than 0, the same upper limit on throughput for the recurring one shot job also applies to the job operation in continuous mode.</span></span> <span data-ttu-id="c846c-135">つまり、(*maxtrans* \* *maxscans*) をゼロ以外のポーリング間隔で割ると、キャプチャ ジョブで処理できる平均トランザクション数の上限が決まります。</span><span class="sxs-lookup"><span data-stu-id="c846c-135">That is, (*maxtrans* \* *maxscans*) divided by a nonzero polling interval will put an upper bound on the average number of transactions that can be processed by the capture job.</span></span>  
  
### <a name="capture-job-customization"></a><span data-ttu-id="c846c-136">キャプチャ ジョブのカスタマイズ</span><span class="sxs-lookup"><span data-stu-id="c846c-136">Capture Job Customization</span></span>  
 <span data-ttu-id="c846c-137">キャプチャ ジョブでは、追加のロジックを適用することにより、固定したポーリング間隔に依存せずに、新しいスキャンをすぐに開始するか、スリープ状態を経てから新しいスキャンを開始するかを決定できます。</span><span class="sxs-lookup"><span data-stu-id="c846c-137">For the capture job, you can apply additional logic to determine whether a new scan begins immediately or whether a sleep is imposed before it starts a new scan instead of rely on a fixed polling interval.</span></span> <span data-ttu-id="c846c-138">この決定は単に時刻に基づきます。たとえば、アクティビティのピーク時に非常に長いスリープを強制したり、その日の処理を完了し、夜間の運用に備えることが重要な 1 日の終わりにポーリング間隔を 0 にしたりします。</span><span class="sxs-lookup"><span data-stu-id="c846c-138">The choice could be based merely on time of the day, perhaps enforcing very long sleeps during peak activity times, and even moving to a polling interval of 0 at close of day when it is important to complete the days processing and prepare for nightly runs.</span></span> <span data-ttu-id="c846c-139">また、キャプチャ プロセスの進捗状態を監視して、午前零時までにコミットされたすべてのトランザクションのスキャンが完了して変更テーブルに格納された時刻を判断することもできます。</span><span class="sxs-lookup"><span data-stu-id="c846c-139">Capture process progress could also be monitored to determine when all transactions committed by mid-night had been scanned and deposited in change tables.</span></span> <span data-ttu-id="c846c-140">これにより、キャプチャ ジョブを終了して、毎日 1 回のスケジュールで再起動することが可能になります。</span><span class="sxs-lookup"><span data-stu-id="c846c-140">This lets the capture job end, to be restarted by a scheduled daily restart.</span></span> <span data-ttu-id="c846c-141">`sp_cdc_scan` を呼び出すジョブ ステップを、ユーザーが作成した `sp_cdc_scan` のラッパーに置き換えることにより、高度にカスタマイズされた動作を簡単に実現できます。</span><span class="sxs-lookup"><span data-stu-id="c846c-141">By replacing the delivered job step calling `sp_cdc_scan` with a call to a user written wrapper for `sp_cdc_scan`, highly customized behavior can be obtained with little additional effort.</span></span>  
  
##  <a name="cleanup-job"></a><a name="Cleanup"></a> <span data-ttu-id="c846c-142">クリーンアップ ジョブ</span><span class="sxs-lookup"><span data-stu-id="c846c-142">Cleanup Job</span></span>  
 <span data-ttu-id="c846c-143">ここでは、変更データ キャプチャのクリーンアップ ジョブの仕組みについて説明します。</span><span class="sxs-lookup"><span data-stu-id="c846c-143">This section provides information about how the change data capture cleanup job works.</span></span>  
  
### <a name="structure-of-the-cleanup-job"></a><span data-ttu-id="c846c-144">クリーンアップ ジョブの構造</span><span class="sxs-lookup"><span data-stu-id="c846c-144">Structure of the Cleanup Job</span></span>  
 <span data-ttu-id="c846c-145">変更データ キャプチャでは、保有期間に基づくクリーンアップ戦略を使用して変更テーブルのサイズを管理します。</span><span class="sxs-lookup"><span data-stu-id="c846c-145">Change data capture uses a retention based cleanup strategy to manage change table size.</span></span> <span data-ttu-id="c846c-146">クリーンアップ メカニズムは、最初のデータベース テーブルが有効になったときに作成された [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] エージェント [!INCLUDE[tsql](../../includes/tsql-md.md)] ジョブで構成されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-146">The cleanup mechanism consists of a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent [!INCLUDE[tsql](../../includes/tsql-md.md)] job that is created when the first database table is enabled.</span></span> <span data-ttu-id="c846c-147">単一のクリーンアップ ジョブがすべてのデータベース変更テーブルのクリーンアップを処理し、定義されたすべてのキャプチャ インスタンスに同じ保有期間値を適用します。</span><span class="sxs-lookup"><span data-stu-id="c846c-147">A single cleanup job handles cleanup for all database change tables and applies the same retention value to all defined capture instances.</span></span>  
  
 <span data-ttu-id="c846c-148">クリーンアップ ジョブは、パラメーターなしのストアド プロシージャ `sp_MScdc_cleanup_job` を実行することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-148">The cleanup job is initiated by running the parameterless stored procedure `sp_MScdc_cleanup_job`.</span></span> <span data-ttu-id="c846c-149">このストアド プロシージャは、構成された保有期間値およびしきい値をクリーンアップ ジョブのために `msdb.dbo.cdc_jobs` から抽出することによって開始されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-149">This stored procedure starts by extracting the configured retention and threshold values for the cleanup job from `msdb.dbo.cdc_jobs`.</span></span> <span data-ttu-id="c846c-150">保有期間値は、変更テーブルの新しい低水位マークの計算に使用します。</span><span class="sxs-lookup"><span data-stu-id="c846c-150">The retention value is used to compute a new low watermark for the change tables.</span></span> <span data-ttu-id="c846c-151">指定した分数は、 *tran_end_time* `cdc.lsn_time_mapping` datetime 値として表現された新しい下限を取得するために、テーブルの最大 tran_end_time 値から減算されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-151">The specified number of minutes is subtracted from the maximum *tran_end_time* value from the `cdc.lsn_time_mapping` table to obtain the new low water mark expressed as a datetime value.</span></span> <span data-ttu-id="c846c-152">その後、CDC.lsn_time_mapping テーブルを使用して、対応する `lsn` 値にこの datetime 値を変換します。</span><span class="sxs-lookup"><span data-stu-id="c846c-152">The CDC.lsn_time_mapping table is then used to convert this datetime value to a corresponding `lsn` value.</span></span> <span data-ttu-id="c846c-153">テーブル内の複数のエントリが同じコミット時刻を共有する場合は、最小の `lsn` を持つエントリに対応する `lsn` が新しい低水位マークとして選択されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-153">If the same commit time is shared by multiple entries in the table, the `lsn` that corresponds to the entry that has the smallest `lsn` is chosen as the new low watermark.</span></span> <span data-ttu-id="c846c-154">この `lsn` 値は `sp_cdc_cleanup_change_tables` に渡され、データベース変更テーブルから変更テーブル エントリが削除されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-154">This `lsn` value is passed to `sp_cdc_cleanup_change_tables` to remove change table entries from the database change tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c846c-155">最新のトランザクションのコミット時刻を、新しい低水位マークの計算のベースとして使用する利点は、変更を特定の時刻の変更テーブルに残せることです。</span><span class="sxs-lookup"><span data-stu-id="c846c-155">The advantage of using the commit time of the recent transaction as the base for computing the new low watermark is that it lets the changes remain in change tables for the specified time.</span></span> <span data-ttu-id="c846c-156">これは、キャプチャ プロセスが背後で実行されている場合でも同様です。</span><span class="sxs-lookup"><span data-stu-id="c846c-156">This happens even when the capture process is running behind.</span></span> <span data-ttu-id="c846c-157">実際の低水位マークの共有コミット時刻を持つ最小の `lsn` を選択することにより、現在の低水位マークと同じコミット時刻を持つすべてのエントリは、変更テーブル内に引き続き表示されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-157">All entries that have the same commit time as the current low watermark continue to be represented within the change tables by choosing the smallest `lsn` that has the shared commit time for the actual low watermark.</span></span>  
  
 <span data-ttu-id="c846c-158">クリーンアップが実行されると、すべてのキャプチャ インスタンスの低水位マークが単一のトランザクションで最初に更新されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-158">When a cleanup is performed, the low watermark for all capture instances is initially updated in a single transaction.</span></span> <span data-ttu-id="c846c-159">その後、使用されなくなったエントリの変更テーブルおよび cdc.lsn_time_mapping テーブルからの削除が試みられます。</span><span class="sxs-lookup"><span data-stu-id="c846c-159">It then tries to remove obsolete entries from the change tables and the cdc.lsn_time_mapping table.</span></span> <span data-ttu-id="c846c-160">単一のステートメントで削除できるエントリの数は、構成可能なしきい値によって制限されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-160">The configurable threshold value limits how many entries are deleted in any single statement.</span></span> <span data-ttu-id="c846c-161">1 つのテーブルで削除が失敗しても、残りのテーブルで削除操作ができなくなるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="c846c-161">Failure to perform the delete on any individual table will not prevent the operation from being attempted on the remaining tables.</span></span>  
  
### <a name="cleanup-job-customization"></a><span data-ttu-id="c846c-162">クリーンアップ ジョブのカスタマイズ</span><span class="sxs-lookup"><span data-stu-id="c846c-162">Cleanup Job Customization</span></span>  
 <span data-ttu-id="c846c-163">クリーンアップ ジョブの場合、カスタマイズが可能なのは、破棄する変更テーブル エントリを決定する戦略です。</span><span class="sxs-lookup"><span data-stu-id="c846c-163">For the cleanup job, the possibility for customization is in the strategy used to determine which change table entries are to be discarded.</span></span> <span data-ttu-id="c846c-164">配布されたクリーンアップ ジョブでサポートされる唯一の戦略は時間ベースのものです。</span><span class="sxs-lookup"><span data-stu-id="c846c-164">The only supported strategy in the delivered cleanup job is a time-based one.</span></span> <span data-ttu-id="c846c-165">この状況では、新しい低水位マークは最後に処理されたトランザクションのコミット時刻から許容保有期間を引いて計算します。</span><span class="sxs-lookup"><span data-stu-id="c846c-165">In that situation, the new low watermark is computed by subtracting the allowed retention period from the commit time of the last transaction processed.</span></span> <span data-ttu-id="c846c-166">基になるクリーンアップ プロシージャは、時間ではなく `lsn` に基づいているため、変更テーブルに保持する最小の `lsn` を決定する戦略はいくつもあります。</span><span class="sxs-lookup"><span data-stu-id="c846c-166">Because the underlying cleanup procedures are based on `lsn` instead of time, any number of strategies can be used to determine the smallest `lsn` to keep in the change tables.</span></span> <span data-ttu-id="c846c-167">厳密には時間ベースのものはそのうちの一部のみです。</span><span class="sxs-lookup"><span data-stu-id="c846c-167">Only some of these are strictly time-based.</span></span> <span data-ttu-id="c846c-168">たとえばクライアントに関する知識は、変更テーブルへのアクセスを必要とするダウンストリーム プロセスを実行できない場合にフェールセーフを提供するために使用できます。</span><span class="sxs-lookup"><span data-stu-id="c846c-168">Knowledge about the clients, for example, could be used to provide a failsafe if downstream processes that require access to the change tables cannot run.</span></span> <span data-ttu-id="c846c-169">また、既定の戦略ではすべてのデータベースの変更テーブルのクリーンアップに同じ `lsn` を使用しますが、基になるクリーンアップ プロシージャを呼び出してキャプチャ インスタンス レベルでクリーンアップすることもできます。</span><span class="sxs-lookup"><span data-stu-id="c846c-169">Also, although the default strategy applies the same `lsn` to clean up all the databases' change tables, the underlying cleanup procedure, can also be called to clean up at the capture instance level.</span></span>  
  
##  <a name="monitor-the-change-data-capture-process"></a><a name="Monitor"></a> <span data-ttu-id="c846c-170">変更データ キャプチャ プロセスの監視</span><span class="sxs-lookup"><span data-stu-id="c846c-170">Monitor the Change Data Capture Process</span></span>  
 <span data-ttu-id="c846c-171">変更データ キャプチャ プロセスを監視すると、変更が変更テーブルに適切に書き込まれているかどうか、および書き込み時の待機時間が妥当かどうかを判断できます。</span><span class="sxs-lookup"><span data-stu-id="c846c-171">Monitoring the change data capture process lets you determine if changes are being written correctly and with a reasonable latency to the change tables.</span></span> <span data-ttu-id="c846c-172">また、発生する可能性のあるエラーを特定することもできます。</span><span class="sxs-lookup"><span data-stu-id="c846c-172">Monitoring can also help you to identify any errors that might occur.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="c846c-173">には、変更データ キャプチャの監視に役立つ 2 つの動的管理ビューが用意されています。 [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) と [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md)です。</span><span class="sxs-lookup"><span data-stu-id="c846c-173">includes two dynamic management views to help you monitor change data capture: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) and [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span></span>  
  
### <a name="identify-sessions-with-empty-result-sets"></a><span data-ttu-id="c846c-174">空の結果セットを含むセッションの特定</span><span class="sxs-lookup"><span data-stu-id="c846c-174">Identify Sessions with Empty Result Sets</span></span>  
 <span data-ttu-id="c846c-175">sys.dm_cdc_log_scan_sessions の各行はログ スキャン セッションを表します (ID が 0 の行を除く)。</span><span class="sxs-lookup"><span data-stu-id="c846c-175">Every row in sys.dm_cdc_log_scan_sessions represents a log scan session (except the row with an ID of 0).</span></span> <span data-ttu-id="c846c-176">ログ スキャン セッションは、 [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql)の 1 回の実行に相当します。</span><span class="sxs-lookup"><span data-stu-id="c846c-176">A log scan session is equivalent to one execution of [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span></span> <span data-ttu-id="c846c-177">セッション中、スキャンによって変更内容または空の結果のいずれかが返されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-177">During a session, the scan can either return changes or return an empty result.</span></span> <span data-ttu-id="c846c-178">結果セットが空の場合、sys.dm_cdc_log_scan_sessions の empty_scan_count 列が 1 に設定されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-178">If the result set is empty, the empty_scan_count column in sys.dm_cdc_log_scan_sessions is set to 1.</span></span> <span data-ttu-id="c846c-179">空の結果セットが連続する場合 (キャプチャ ジョブを連続的に実行している場合など)、既存の最後の行の empty_scan_count が増分されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-179">If there are consecutive empty result sets, such as if the capture job is running continuously, the empty_scan_count in the last existing row is incremented.</span></span> <span data-ttu-id="c846c-180">たとえば、変更内容を返したスキャンについて、sys.dm_cdc_log_scan_sessions に既に 10 行が格納されており、5 つの空の結果が行に含まれている場合、ビューには 11 行が格納され、</span><span class="sxs-lookup"><span data-stu-id="c846c-180">For example, if sys.dm_cdc_log_scan_sessions already contains 10 rows for scans that returned changes and there are five empty results in a row, the view contains 11 rows.</span></span> <span data-ttu-id="c846c-181">最後の行の empty_scan_count 列の値は 5 になります。</span><span class="sxs-lookup"><span data-stu-id="c846c-181">The last row has a value of 5 in the empty_scan_count column.</span></span> <span data-ttu-id="c846c-182">空のスキャンを含むセッションを確認するには、次のクエリを実行します。</span><span class="sxs-lookup"><span data-stu-id="c846c-182">To determine sessions that had an empty scan, run the following query:</span></span>  
  
```sql
SELECT * from sys.dm_cdc_log_scan_sessions where empty_scan_count <> 0
```
  
### <a name="determine-latency"></a><span data-ttu-id="c846c-183">待機時間の判断</span><span class="sxs-lookup"><span data-stu-id="c846c-183">Determine Latency</span></span>  
 <span data-ttu-id="c846c-184">sys.dm_cdc_log_scan_sessions 管理ビューには、各キャプチャ セッションの待機時間を記録する列があります。</span><span class="sxs-lookup"><span data-stu-id="c846c-184">The sys.dm_cdc_log_scan_sessions management view includes a column that records the latency for each capture session.</span></span> <span data-ttu-id="c846c-185">待機時間は、トランザクションがソース テーブルにコミットされてから、最後にキャプチャされたトランザクションが変更テーブルにコミットされるまでの経過時間として定義されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-185">Latency is defined as the elapsed time between a transaction being committed on a source table and the last captured transaction being committed on the change table.</span></span> <span data-ttu-id="c846c-186">待機時間列では、アクティブなセッションについてのみ値が設定されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-186">The latency column is populated only for active sessions.</span></span> <span data-ttu-id="c846c-187">empty_scan_count 列の値が 0 より大きいセッションについては、待機時間列は 0 に設定されます。</span><span class="sxs-lookup"><span data-stu-id="c846c-187">For sessions with a value greater than 0 in the empty_scan_count column, the latency column is set to 0.</span></span> <span data-ttu-id="c846c-188">次のクエリは、最新のセッションの平均待機時間を返します。</span><span class="sxs-lookup"><span data-stu-id="c846c-188">The following query returns the average latency for the most recent sessions:</span></span>  
  
```sql
SELECT latency FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
 <span data-ttu-id="c846c-189">待機時間データを使用すると、キャプチャ プロセスでのトランザクションの処理時間を確認できます。</span><span class="sxs-lookup"><span data-stu-id="c846c-189">You can use latency data to determine how fast or slow the capture process is processing transactions.</span></span> <span data-ttu-id="c846c-190">このデータが最も役立つのは、キャプチャ プロセスを連続的に実行している場合です。</span><span class="sxs-lookup"><span data-stu-id="c846c-190">This data is most useful when the capture process is running continuously.</span></span> <span data-ttu-id="c846c-191">スケジュールに従ってキャプチャ プロセスを実行している場合、トランザクションがソース テーブルにコミットされてから、スケジュールされた時間にキャプチャ プロセスが実行されるまでの間に遅延が生じるため、待機時間が長くなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="c846c-191">If the capture process is running on a schedule, latency can be high because of the lag between transactions being committed on the source table and the capture process running at its scheduled time.</span></span>  
  
 <span data-ttu-id="c846c-192">キャプチャ プロセスに関するもう 1 つの重要な指標はスループットです。</span><span class="sxs-lookup"><span data-stu-id="c846c-192">Another important measure of capture process efficiency is throughput.</span></span> <span data-ttu-id="c846c-193">これは、各セッション中に処理された 1 秒あたりの平均コマンド数です。</span><span class="sxs-lookup"><span data-stu-id="c846c-193">This is the average number of commands per second that are processed during each session.</span></span> <span data-ttu-id="c846c-194">セッションのスループットを確認するには、command_count 列の値を実行時間列の値で除算します。</span><span class="sxs-lookup"><span data-stu-id="c846c-194">To determine the throughput of a session, divide the value in the command_count column by the value in the duration column.</span></span> <span data-ttu-id="c846c-195">次のクエリは、最新のセッションの平均スループットを返します。</span><span class="sxs-lookup"><span data-stu-id="c846c-195">The following query returns the average throughput for the most recent sessions:</span></span>  
  
```sql
SELECT command_count/duration AS [Throughput] FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
### <a name="use-data-collector-to-collect-sampling-data"></a><span data-ttu-id="c846c-196">データ コレクターを使用したサンプル データの収集</span><span class="sxs-lookup"><span data-stu-id="c846c-196">Use Data Collector to Collect Sampling Data</span></span>  
 <span data-ttu-id="c846c-197">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] データ コレクターを使用すると、任意のテーブルまたは動的管理ビューからデータのスナップショットを収集して、パフォーマンス データ ウェアハウスを構築することができます。</span><span class="sxs-lookup"><span data-stu-id="c846c-197">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data collector lets you collect snapshots of data from any table or dynamic management view and build a performance data warehouse.</span></span> <span data-ttu-id="c846c-198">データベースで変更データ キャプチャが有効になっている場合、sys.dm_cdc_log_scan_sessions ビューおよび sys.dm_cdc_errors ビューのスナップショットを一定間隔で取得すると、後の分析に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="c846c-198">When change data capture is enabled on a database, it is useful to take snapshots of the sys.dm_cdc_log_scan_sessions view and the sys.dm_cdc_errors view at regular intervals for later analysis.</span></span> <span data-ttu-id="c846c-199">次の手順では、sys.dm_cdc_log_scan_sessions 管理ビューからサンプル データを収集するデータ コレクターを設定します。</span><span class="sxs-lookup"><span data-stu-id="c846c-199">The following procedure sets up a data collector for collecting sample data from the sys.dm_cdc_log_scan_sessions management view.</span></span>  
  
 <span data-ttu-id="c846c-200">**データ収集の構成**</span><span class="sxs-lookup"><span data-stu-id="c846c-200">**Configuring Data Collection**</span></span>  
  
1.  <span data-ttu-id="c846c-201">データ コレクターを有効にし、管理データ ウェアハウスを構成します。</span><span class="sxs-lookup"><span data-stu-id="c846c-201">Enable data collector and configure a management data warehouse.</span></span> <span data-ttu-id="c846c-202">詳細については、「 [データ コレクションの管理](../data-collection/data-collection.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c846c-202">For more information, see [Manage Data Collection](../data-collection/data-collection.md).</span></span>  
  
2.  <span data-ttu-id="c846c-203">次のコードを実行して、変更データ キャプチャ用のカスタム データ コレクターを作成します。</span><span class="sxs-lookup"><span data-stu-id="c846c-203">Execute the following code to create a custom collector for change data capture.</span></span>  
  
    ```sql  
    USE msdb;  
  
    DECLARE @schedule_uid uniqueidentifier;  
  
    -- Collect and upload data every 5 minutes  
    SELECT @schedule_uid = (  
    SELECT schedule_uid from sysschedules_localserver_view   
    WHERE name = N'CollectorSchedule_Every_5min')  
  
    DECLARE @collection_set_id int;  
  
    EXEC dbo.sp_syscollector_create_collection_set  
    @name = N' CDC Performance Data Collector',  
    @schedule_uid = @schedule_uid,          
    @collection_mode = 0,                   
    @days_until_expiration = 30,                
    @description = N'This collection set collects CDC metadata',  
    @collection_set_id = @collection_set_id output;  
  
    -- Create a collection item using statistics from   
    -- the change data capture dynamic management view.  
    DECLARE @parameters xml;  
    DECLARE @collection_item_id int;  
  
    SELECT @parameters = CONVERT(xml,   
        N'<TSQLQueryCollector>  
            <Query>  
              <Value>SELECT * FROM sys.dm_cdc_log_scan_sessions</Value>  
              <OutputTable>cdc_log_scan_data</OutputTable>  
            </Query>  
          </TSQLQueryCollector>');  
  
    EXEC dbo.sp_syscollector_create_collection_item  
    @collection_set_id = @collection_set_id,  
    @collector_type_uid = N'302E93D1-3424-4BE7-AA8E-84813ECF2419',  
    @name = ' CDC Performance Data Collector',  
    @frequency = 5,   
    @parameters = @parameters,  
    @collection_item_id = @collection_item_id output;  
  
    GO  
    ```  
  
3.  <span data-ttu-id="c846c-204">[!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]で、 **[管理]** 、 **[データ コレクション]** の順に展開します。</span><span class="sxs-lookup"><span data-stu-id="c846c-204">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], expand **Management**, and then expand **Data Collection**.</span></span> <span data-ttu-id="c846c-205">**[CDC パフォーマンス データ コレクター]** を右クリックし、 **[データ コレクション セットの開始]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="c846c-205">Right click **CDC Performance Data Collector**, and then click **Start Data Collection Set**.</span></span>  
  
4.  <span data-ttu-id="c846c-206">手順 1. で構成したデータ ウェアハウスで、custom_snapshots.cdc_log_scan_data テーブルを検索します。</span><span class="sxs-lookup"><span data-stu-id="c846c-206">In the data warehouse you configured in step 1, locate the table custom_snapshots.cdc_log_scan_data.</span></span> <span data-ttu-id="c846c-207">このテーブルには、ログ スキャン セッションのデータの履歴スナップショットが格納されています。</span><span class="sxs-lookup"><span data-stu-id="c846c-207">This table provides a historical snapshot of data from log scan sessions.</span></span> <span data-ttu-id="c846c-208">このデータを使用すると、待機時間やスループットなどのパフォーマンス指標を時系列で分析できます。</span><span class="sxs-lookup"><span data-stu-id="c846c-208">This data can be used to analyze latency, throughput, and other performance measures over time.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c846c-209">参照</span><span class="sxs-lookup"><span data-stu-id="c846c-209">See Also</span></span>  
 <span data-ttu-id="c846c-210">[データ変更の追跡 &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c846c-210">[Track Data Changes &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span></span>  
 <span data-ttu-id="c846c-211">[変更データ キャプチャについて &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c846c-211">[About Change Data Capture &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="c846c-212">[変更データ キャプチャの有効化と無効化 &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c846c-212">[Enable and Disable Change Data Capture &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span></span>  
 [<span data-ttu-id="c846c-213">変更データの処理 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="c846c-213">Work with Change Data &#40;SQL Server&#41;</span></span>](work-with-change-data-sql-server.md)  
  
  
