---
title: メモリ最適化テーブルが含まれるデータベースのバックアップ | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 83d47694-e56d-4dae-b54e-14945bf8ba31
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 176448aa9d4bab4101ab2db12ffc9a8a7fd1a5b5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87632462"
---
# <a name="backing-up-a-database-with-memory-optimized-tables"></a><span data-ttu-id="9e912-102">メモリ最適化テーブルが含まれるデータベースのバックアップ</span><span class="sxs-lookup"><span data-stu-id="9e912-102">Backing Up a Database with Memory-Optimized Tables</span></span>
  <span data-ttu-id="9e912-103">メモリ最適化されたテーブルは、通常のデータベースのバックアップの一部としてバックアップされます。</span><span class="sxs-lookup"><span data-stu-id="9e912-103">Memory-optimized tables are backed up as part of regular database backups.</span></span> <span data-ttu-id="9e912-104">ディスク ベース テーブルについては、ストレージの破損を検出するために、データベース バックアップの一部としてデータのチェックサムおよびデルタ ファイルのペアが検証されます。</span><span class="sxs-lookup"><span data-stu-id="9e912-104">As for disk-based tables, the CHECKSUM of data and delta file pairs is validated as part of the database backup to detect storage corruption.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9e912-105">バックアップ中に、メモリ最適化ファイル グループ内の 1 つ以上のファイルでチェックサム エラーが検出された場合、データベースを復元および再起動できなくなります。</span><span class="sxs-lookup"><span data-stu-id="9e912-105">During a backup, if you detect a CHECKSUM error in one or more files in a memory-optimized filegroup, you will not be able to restore and restart the database.</span></span> <span data-ttu-id="9e912-106">このような場合は、最新の既知の良好なバックアップからデータベースを復元します。</span><span class="sxs-lookup"><span data-stu-id="9e912-106">In that situation, you must, restore your database with the last known good backup.</span></span> <span data-ttu-id="9e912-107">バックアップがない場合、データベースを削除して再作成した後に、メモリ最適化テーブルおよびディスク ベース テーブルからデータをエクスポートして再読み込みできます。</span><span class="sxs-lookup"><span data-stu-id="9e912-107">If you don't have a backup, you can export the data from memory-optimized tables and disk-based tables and reload after you drop and recreate the database.</span></span>  
  
 <span data-ttu-id="9e912-108">1 つ以上のメモリ最適化されたテーブルを持つデータベースの完全バックアップには、メモリ最適化されたテーブルごとに、ディスク ベース テーブルに対して割り当てられているストレージ (存在する場合)、アクティブなトランザクション ログ、およびデータ ファイルとデルタ ファイルのペア (チェックポイント ファイル ペアとも呼びます) が含まれています。</span><span class="sxs-lookup"><span data-stu-id="9e912-108">A full backup of a database with one or more memory-optimized tables consists of the allocated storage for disk-based tables (if any), the active transaction log, and the data and delta file pairs (also known as checkpoint file pairs) for memory-optimized tables.</span></span> <span data-ttu-id="9e912-109">ただし、「 [メモリ最適化テーブルの持続性](memory-optimized-tables.md)」で説明されているように、メモリ最適化されたテーブルで使用されるストレージはメモリ内にあるときのサイズを大きく上回ることがあり、データベースのバックアップのサイズに影響します。</span><span class="sxs-lookup"><span data-stu-id="9e912-109">However, as described in [Durability for Memory-Optimized Tables](memory-optimized-tables.md), the storage used by memory-optimized tables can be much larger than its size in memory, and it affects the size of the database backup.</span></span>  
  
## <a name="full-database-backup"></a><span data-ttu-id="9e912-110">データベースの完全バックアップ</span><span class="sxs-lookup"><span data-stu-id="9e912-110">Full Database Backup</span></span>  
 <span data-ttu-id="9e912-111">この説明では、持続性のあるメモリ最適化されたテーブルを持つデータベースに関するデータベース バックアップに注目します。ディスク ベース テーブルに関するバックアップも同じであるためです。</span><span class="sxs-lookup"><span data-stu-id="9e912-111">This discussion will focus on database backups for databases with just durable memory-optimized tables, because the backup for disk-based tables is the same.</span></span> <span data-ttu-id="9e912-112">メモリ最適化されたファイル グループ内にあるチェックポイント ファイル ペアは、さまざまな状態をとることがあります。</span><span class="sxs-lookup"><span data-stu-id="9e912-112">The checkpoint file pairs in the memory-optimized filegroup could be in various states.</span></span> <span data-ttu-id="9e912-113">ファイルのどの部分がバックアップされるかを、次の表で説明します。</span><span class="sxs-lookup"><span data-stu-id="9e912-113">The table below describes what part of the files is backed.</span></span>  
  
|<span data-ttu-id="9e912-114">チェックポイント ファイル ペアの状態</span><span class="sxs-lookup"><span data-stu-id="9e912-114">Checkpoint File Pair State</span></span>|<span data-ttu-id="9e912-115">バックアップ</span><span class="sxs-lookup"><span data-stu-id="9e912-115">Backup</span></span>|  
|--------------------------------|------------|  
|<span data-ttu-id="9e912-116">PRECREATED</span><span class="sxs-lookup"><span data-stu-id="9e912-116">PRECREATED</span></span>|<span data-ttu-id="9e912-117">ファイルのメタデータのみ</span><span class="sxs-lookup"><span data-stu-id="9e912-117">File metadata only</span></span>|  
|<span data-ttu-id="9e912-118">UNDER CONSTRUCTION</span><span class="sxs-lookup"><span data-stu-id="9e912-118">UNDER CONSTRUCTION</span></span>|<span data-ttu-id="9e912-119">ファイルのメタデータのみ</span><span class="sxs-lookup"><span data-stu-id="9e912-119">File metadata only</span></span>|  
|<span data-ttu-id="9e912-120">アクティブ</span><span class="sxs-lookup"><span data-stu-id="9e912-120">Active</span></span>|<span data-ttu-id="9e912-121">ファイルのメタデータと使用されているバイト</span><span class="sxs-lookup"><span data-stu-id="9e912-121">File metadata plus used bytes</span></span>|  
|<span data-ttu-id="9e912-122">Merge source</span><span class="sxs-lookup"><span data-stu-id="9e912-122">Merge source</span></span>|<span data-ttu-id="9e912-123">ファイルのメタデータと使用されているバイト</span><span class="sxs-lookup"><span data-stu-id="9e912-123">File metadata plus used bytes</span></span>|  
|<span data-ttu-id="9e912-124">Merge target</span><span class="sxs-lookup"><span data-stu-id="9e912-124">Merge target</span></span>|<span data-ttu-id="9e912-125">ファイルのメタデータのみ</span><span class="sxs-lookup"><span data-stu-id="9e912-125">File metadata only</span></span>|  
|<span data-ttu-id="9e912-126">REQUIRED FOR BACKUP/HA</span><span class="sxs-lookup"><span data-stu-id="9e912-126">REQUIRED FOR BACKUP/HA</span></span>|<span data-ttu-id="9e912-127">ファイルのメタデータと使用されているバイト</span><span class="sxs-lookup"><span data-stu-id="9e912-127">File metadata plus used bytes</span></span>|  
|<span data-ttu-id="9e912-128">IN TRANSITION TO TOMBSTONE</span><span class="sxs-lookup"><span data-stu-id="9e912-128">IN TRANSITION TO TOMBSTONE</span></span>|<span data-ttu-id="9e912-129">ファイルのメタデータのみ</span><span class="sxs-lookup"><span data-stu-id="9e912-129">File metadata only</span></span>|  
|<span data-ttu-id="9e912-130">TOMBSTONE</span><span class="sxs-lookup"><span data-stu-id="9e912-130">TOMBSTONE</span></span>|<span data-ttu-id="9e912-131">ファイルのメタデータのみ</span><span class="sxs-lookup"><span data-stu-id="9e912-131">File metadata only</span></span>|  
  
 <span data-ttu-id="9e912-132">1つ以上のメモリ最適化テーブルを持つデータベースバックアップのサイズは、通常、メモリ内のサイズより大きくなりますが、ディスク上の記憶域よりも小さくなります。</span><span class="sxs-lookup"><span data-stu-id="9e912-132">The size of database backups with one or more memory-optimized tables is typically larger than its size in memory but smaller than the on-disk storage.</span></span> <span data-ttu-id="9e912-133">追加のサイズは、削除された行の数と、ワークロードに間接的に依存する Merge source および REQUIRED FOR BACKUP/HA という状態にあるチェックポイント ファイル ペアの数によって異なります。</span><span class="sxs-lookup"><span data-stu-id="9e912-133">The extra size will depend upon the number of deleted rows and the number of checkpoint file pairs in the states Merge source and REQUIRED FOR BACKUP/HA which indirectly depends upon the workload.</span></span> <span data-ttu-id="9e912-134">チェックポイントファイルペアの状態の詳細については、「 [sys. dm_db_xtp_checkpoint_files &#40;transact-sql&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9e912-134">For descriptions of the states for checkpoint file pairs, see [sys.dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql).</span></span>  
  
### <a name="estimating-size-of-full-database-backup"></a><span data-ttu-id="9e912-135">データベースの完全バックアップの推計サイズ</span><span class="sxs-lookup"><span data-stu-id="9e912-135">Estimating Size of Full Database Backup</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="9e912-136">BackupSizeInBytes 値を使用してインメモリ OLTP のバックアップのサイズを見積もることはお勧めしません。</span><span class="sxs-lookup"><span data-stu-id="9e912-136">It's recommended that you not use the BackupSizeInBytes value to estimate the backup size for In-Memory OLTP.</span></span>  
  
 <span data-ttu-id="9e912-137">最初のワークロードのシナリオは、(ほとんどが) 挿入の場合です。</span><span class="sxs-lookup"><span data-stu-id="9e912-137">The first workload scenario is for (mostly) insert.</span></span> <span data-ttu-id="9e912-138">このシナリオでは、ほとんどのデータ ファイルは Active 状態で、完全読み込みであり、削除済みの行はごくわずかです。</span><span class="sxs-lookup"><span data-stu-id="9e912-138">In this scenario, most data files will be in the Active state, fully loaded, and with very few deleted rows.</span></span> <span data-ttu-id="9e912-139">データベースのバックアップのサイズは、メモリ内にあるデータのサイズに近づきます。</span><span class="sxs-lookup"><span data-stu-id="9e912-139">The size of database backup up will be close to the size of data in memory.</span></span>  
  
 <span data-ttu-id="9e912-140">2 番目のワークロードのシナリオは、INSERT、DELETE、UPDATE の各操作が頻繁に実行される場合です。最悪のケースでは、削除された行を考慮に入れた後、各チェックポイント ファイル ペアは 50% が読み込み済みになります。</span><span class="sxs-lookup"><span data-stu-id="9e912-140">The second workload scenario is for frequent insert, delete, and update operations: In the worst case, each of the checkpoint file pairs are 50% loaded, after accounting for the deleted rows.</span></span> <span data-ttu-id="9e912-141">したがって、データベースのバックアップのサイズは、メモリ内にあるデータのサイズの少なくとも 2 倍になります。</span><span class="sxs-lookup"><span data-stu-id="9e912-141">So the size of the database backup will at least be 2 times the size of data in memory.</span></span> <span data-ttu-id="9e912-142">また、データベースのバックアップのサイズを大きくする Merge source および Required for backup/high availability という状態にあるチェックポイント ファイル ペアはわずかです。</span><span class="sxs-lookup"><span data-stu-id="9e912-142">Additionally, there will few checkpoint file pairs in states Merge source and Required for backup/high availability that will add to the size of database backup.</span></span>  
  
## <a name="differential-backups-of-databases-with-memory-optimized-tables"></a><span data-ttu-id="9e912-143">メモリ最適化テーブルを含むデータベースの差分バックアップ</span><span class="sxs-lookup"><span data-stu-id="9e912-143">Differential Backups of Databases with Memory-Optimized Tables</span></span>  
 <span data-ttu-id="9e912-144">メモリ最適化テーブルのストレージは、「 [メモリ最適化テーブルの持続性](memory-optimized-tables.md)」で説明しているようにデータ ファイルとデルタ ファイルで構成されます。</span><span class="sxs-lookup"><span data-stu-id="9e912-144">The storage for memory-optimized tables consists of data and delta files as described in [Durability for Memory-Optimized Tables](memory-optimized-tables.md).</span></span> <span data-ttu-id="9e912-145">メモリ最適化テーブルが含まれるデータベースの差分バックアップには、次のデータが含まれています。</span><span class="sxs-lookup"><span data-stu-id="9e912-145">The differential backup of a database with memory-optimized tables contains the following data:</span></span>  
  
-   <span data-ttu-id="9e912-146">ディスク ベース テーブルを格納するファイル グループの差分バックアップは、メモリ最適化テーブルの存在による影響を受けません。</span><span class="sxs-lookup"><span data-stu-id="9e912-146">Differential backup for filegroups storing disk-based tables is not affected by the presence of memory-optimized tables.</span></span>  
  
-   <span data-ttu-id="9e912-147">アクティブなトランザクション ログは、データベースの完全バックアップの場合と同じです。</span><span class="sxs-lookup"><span data-stu-id="9e912-147">The active transaction log is the same as in a full database backup.</span></span>  
  
-   <span data-ttu-id="9e912-148">メモリ最適化データ ファイル グループの差分バックアップでは、データベースの完全バックアップと同じアルゴリズムを使用して、バックアップのデータ ファイルとデルタ ファイルを識別しますが、その後、次のようにファイルのサブセットを除外します。</span><span class="sxs-lookup"><span data-stu-id="9e912-148">For a memory-optimized data filegroup, the differential backup uses the same algorithm as full database backup to identify the data and delta files for backup but it then filters out the subset of files as follows:</span></span>  
  
    -   <span data-ttu-id="9e912-149">データ ファイルには新たに挿入された行が含まれ、ファイルがいっぱいになるとファイルが閉じられ、読み取り専用としてマークされます。</span><span class="sxs-lookup"><span data-stu-id="9e912-149">A data file contains newly inserted rows and when it is full, it is closed and marked read-only.</span></span> <span data-ttu-id="9e912-150">データ ファイルは、最後のデータベースの完全バックアップの後で閉じられた場合にのみバックアップされます。</span><span class="sxs-lookup"><span data-stu-id="9e912-150">A data file is backed up only if it was closed after the last full database backup.</span></span> <span data-ttu-id="9e912-151">差分バックアップでは、挿入された行が含まれるデータ ファイルだけがバックアップされますが、挿入された行の一部が既にガベージ コレクション向けにマークされているか、ガベージ コレクションに収集された可能性がある更新および削除のシナリオは除きます。</span><span class="sxs-lookup"><span data-stu-id="9e912-151">The differential backup only backups up data files containing the inserted rows since the last full database backup with the exception of an update and delete scenario where it is possible that some of the inserted rows may have already been either marked for garbage collection or already garbage collected.</span></span>  
  
    -   <span data-ttu-id="9e912-152">デルタ ファイルには、削除されたデータ行への参照が格納されます。</span><span class="sxs-lookup"><span data-stu-id="9e912-152">A delta file stores references to the deleted data rows.</span></span> <span data-ttu-id="9e912-153">将来のトランザクションでは行を削除できるため、デルタ ファイルは存続期間中のいつでも変更することができ、閉じられません。</span><span class="sxs-lookup"><span data-stu-id="9e912-153">Since any future transaction can delete a row, a delta file can be modified anytime in its life time, it is never closed.</span></span> <span data-ttu-id="9e912-154">デルタ ファイルは常にバックアップされます。</span><span class="sxs-lookup"><span data-stu-id="9e912-154">A delta file is always backed up.</span></span> <span data-ttu-id="9e912-155">通常、デルタ ファイルはストレージの 10% 未満を使用するため、差分バックアップのサイズにほとんど影響を与えません。</span><span class="sxs-lookup"><span data-stu-id="9e912-155">Delta files typically use less than 10% of the storage, so delta files have a minimal impact on the size of differential backup.</span></span>  
  
 <span data-ttu-id="9e912-156">データベース サイズの大部分がメモリ最適化テーブルである場合は、差分バックアップによってデータベース バックアップのサイズを大幅に削減することができます。</span><span class="sxs-lookup"><span data-stu-id="9e912-156">If memory-optimized tables are a significant portion of your database size, the differential backup can significantly reduce the size of your database backup.</span></span>  
  
 <span data-ttu-id="9e912-157">一般的な OLTP ワークロードの場合、差分バックアップは完全バックアップより非常に小さくなります。</span><span class="sxs-lookup"><span data-stu-id="9e912-157">For typical OLTP workloads, the differential backups will be considerably smaller than the full database backups.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="9e912-158">参照</span><span class="sxs-lookup"><span data-stu-id="9e912-158">See Also</span></span>  
 [<span data-ttu-id="9e912-159">メモリ最適化テーブルのバックアップ、復元、復旧</span><span class="sxs-lookup"><span data-stu-id="9e912-159">Backup, Restore, and Recovery of Memory-Optimized Tables</span></span>](restore-and-recovery-of-memory-optimized-tables.md)  
  
  
