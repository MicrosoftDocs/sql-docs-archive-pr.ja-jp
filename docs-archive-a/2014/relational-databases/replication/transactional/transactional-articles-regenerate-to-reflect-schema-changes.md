---
title: カスタム トランザクション プロシージャの再生成によるスキーマ変更の反映 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- custom procedures [SQL Server replication]
- transactional replication, replicating schema changes
- schemas [SQL Server replication], replicating changes
ms.assetid: ccf68a13-e748-4455-8168-90e6d2868098
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 7b41b5309816e037ce3619e880b796e0653c7506
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87738190"
---
# <a name="regenerate-custom-transactional-procedures-to-reflect-schema-changes"></a><span data-ttu-id="ff83b-102">カスタム トランザクション プロシージャの再生成によるスキーマ変更の反映</span><span class="sxs-lookup"><span data-stu-id="ff83b-102">Regenerate Custom Transactional Procedures to Reflect Schema Changes</span></span>
  <span data-ttu-id="ff83b-103">既定では、トランザクション レプリケーションがサブスクライバー上のデータを変更する際、パブリケーション内の各テーブル アーティクルに対して内部プロシージャが生成したストアド プロシージャが必ず使われます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-103">By default transactional replication makes all data changes at Subscribers through stored procedures that are generated by internal procedures for each table article in the publication.</span></span> <span data-ttu-id="ff83b-104">3 つのプロシージャ (挿入、更新、削除用に 1 つずつ) はサブスクライバーにコピーされ、挿入、更新、削除がサブスクライバーにレプリケートされた時点で実行されます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-104">The three procedures (one each for inserts, updates, and deletes) are copied to the Subscriber and execute when an insert, update, or delete is replicated to the Subscriber.</span></span> <span data-ttu-id="ff83b-105">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] パブリッシャー上のテーブルでスキーマが変更されると、レプリケーションがスクリプト作成内部プロシージャの同じセットを呼び出すことで、これらのプロシージャが自動的に再生成され、新しいプロシージャと新しいスキーマが一致します (スキーマ変更のレプリケーションは、Oracle パブリッシャーではサポートされていません)。</span><span class="sxs-lookup"><span data-stu-id="ff83b-105">When a schema change is made to a table on a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Publisher, replication regenerates these procedures automatically by calling the same set of internal scripting procedures so that the new procedures match the new schema (replication of schema changes is not supported for Oracle Publishers).</span></span>  
  
 <span data-ttu-id="ff83b-106">カスタム プロシージャを指定して、1 つ以上の既定のプロシージャを置き換えることもできます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-106">It is also possible to specify custom procedures to replace one or more of the default procedures.</span></span> <span data-ttu-id="ff83b-107">スキーマ変更によってカスタム プロシージャが影響を受ける場合は、そのプロシージャを変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff83b-107">The custom procedures should be changed if the schema change will affect the procedure.</span></span> <span data-ttu-id="ff83b-108">たとえば、スキーマ変更によって削除される列をプロシージャが参照している場合には、その列への参照をプロシージャから削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff83b-108">For example, if a procedure references a column that is dropped in a schema change, references to the column should be removed from the procedure.</span></span> <span data-ttu-id="ff83b-109">レプリケーションで新しいカスタム プロシージャをサブスクライバーに反映するには、2 つの方法があります。</span><span class="sxs-lookup"><span data-stu-id="ff83b-109">There are two ways for replication to propagate a new custom procedure to Subscribers:</span></span>  
  
-   <span data-ttu-id="ff83b-110">1 つ目のオプションは、カスタム スクリプト作成プロシージャを使用して、レプリケーションで使用する既定のプロシージャを置き換える方法です。</span><span class="sxs-lookup"><span data-stu-id="ff83b-110">The first option is to use a custom scripting procedure to replace the defaults used by replication:</span></span>  
  
    1.  <span data-ttu-id="ff83b-111">[Transact-sql&#41;&#40;sp_addarticle](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql)を実行する場合は、 **@schema_option** 0x02 ビットが**true**であることを確認します。</span><span class="sxs-lookup"><span data-stu-id="ff83b-111">When executing [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql), ensure the **@schema_option** 0x02 bit is to **true**.</span></span>  
  
    2.  <span data-ttu-id="ff83b-112">[Transact-sql&#41;を実行 sp_register_custom_scripting &#40;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql) 、パラメーターに ' insert '、' update '、または ' delete ' の値を指定し、パラメーターに **@type** カスタムスクリプトプロシージャの名前を指定し **@value** ます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-112">Execute [sp_register_custom_scripting &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql) and specify a value of 'insert', 'update', or 'delete' for the parameter **@type** and the name of the custom scripting procedure for the parameter **@value**.</span></span>  
  
     <span data-ttu-id="ff83b-113">次回にスキーマが変更されると、レプリケーションによってこのストアド プロシージャが呼び出され、新しくユーザーが定義したカスタム ストアド プロシージャの定義がスクリプト化されて、プロシージャが各サブスクライバーに反映されます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-113">The next time a schema change is made, replication calls this stored procedure to script out the definition for the new user defined custom stored procedure, and then propagates the procedure to each Subscriber.</span></span>  
  
-   <span data-ttu-id="ff83b-114">2 つ目のオプションは、新しいカスタム プロシージャの定義を含むスクリプトを使用する方法です。</span><span class="sxs-lookup"><span data-stu-id="ff83b-114">The second option is to use a script that contains a new custom procedure definition:</span></span>  
  
    1.  <span data-ttu-id="ff83b-115">[Transact-sql&#41;&#40;sp_addarticle](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql)を実行する場合は、 **@schema_option** 0x02 ビットを**false**に設定して、レプリケーションによってカスタムプロシージャがサブスクライバーで自動的に生成されないようにします。</span><span class="sxs-lookup"><span data-stu-id="ff83b-115">When executing [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql), set the **@schema_option** 0x02 bit to **false** so replication does not automatically generate custom procedures at the Subscriber.</span></span>  
  
    2.  <span data-ttu-id="ff83b-116">各スキーマ変更の前に、新しいスクリプト ファイルを作成し、[sp_register_custom_scripting &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql) を実行してスクリプトをレプリケーションに登録します。</span><span class="sxs-lookup"><span data-stu-id="ff83b-116">Before each schema change, create a new script file and register the script with replication by executing [sp_register_custom_scripting &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql).</span></span> <span data-ttu-id="ff83b-117">パラメーターの値として ' custom_script ' を指定し、 **@type** パラメーターにパブリッシャー上のスクリプトへのパスを指定し **@value** ます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-117">Specify a value of 'custom_script' for the parameter **@type** and the path to the script on the Publisher for the parameter **@value**.</span></span>  
  
     <span data-ttu-id="ff83b-118">次回に関連スキーマが変更されると、各サブスクライバーでは、DDL コマンドと同じトランザクション内でこのスクリプトが実行されます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-118">The next time a relevant schema change is made, this script executes on each Subscriber within the same transaction as the DDL command.</span></span> <span data-ttu-id="ff83b-119">スキーマ変更が完了すると、スクリプトの登録が解除されます。</span><span class="sxs-lookup"><span data-stu-id="ff83b-119">After the schema change is made, the script is unregistered.</span></span> <span data-ttu-id="ff83b-120">以降のスキーマ変更でこのスクリプトを実行するには、スクリプトを再登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ff83b-120">You must re-register the script to have it executed after a subsequent schema change.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ff83b-121">参照</span><span class="sxs-lookup"><span data-stu-id="ff83b-121">See Also</span></span>  
 <span data-ttu-id="ff83b-122">[トランザクション アーティクルに変更を反映する方法の指定](transactional-articles-specify-how-changes-are-propagated.md) </span><span class="sxs-lookup"><span data-stu-id="ff83b-122">[Specify How Changes Are Propagated for Transactional Articles](transactional-articles-specify-how-changes-are-propagated.md) </span></span>  
 [<span data-ttu-id="ff83b-123">パブリケーション データベースでのスキーマの変更</span><span class="sxs-lookup"><span data-stu-id="ff83b-123">Make Schema Changes on Publication Databases</span></span>](../publish/make-schema-changes-on-publication-databases.md)  
  
  
