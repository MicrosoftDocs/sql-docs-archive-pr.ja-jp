---
title: サブスクリプションの有効期限と非アクティブ化 | Microsoft Docs
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- Distributors [SQL Server replication], distribution retention period
- subscriptions [SQL Server replication], expiration
- publications [SQL Server replication], publication retention periods
- expiration [SQL Server replication]
- retention periods [SQL Server replication]
- publication retention periods
- distribution retention period
- subscriptions [SQL Server replication], deactivation
- deactivating subscriptions
ms.assetid: 4d03f5ab-e721-4f56-aebc-60f6a56c1e07
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 6d81e8b5c02fcfe5399be9e63c8160036a999547
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87740793"
---
# <a name="subscription-expiration-and-deactivation"></a><span data-ttu-id="bd8c4-102">サブスクリプションの有効期限と非アクティブ化</span><span class="sxs-lookup"><span data-stu-id="bd8c4-102">Subscription Expiration and Deactivation</span></span>
  <span data-ttu-id="bd8c4-103">サブスクリプションは、指定した *保有期間*内に同期されなかった場合、非アクティブ化されるか、期限切れにされる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-103">Subscriptions can be deactivated or can expire if they are not synchronized within a specified *retention period*.</span></span> <span data-ttu-id="bd8c4-104">行われる処理は、レプリケーションの種類と保有期間が過ぎているかどうかによって異なります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-104">The action that occurs depends on the type of replication and the retention period that is exceeded.</span></span>  
  
 <span data-ttu-id="bd8c4-105">保有期間を設定する場合は、「[サブスクリプションの有効期限の設定](publish/set-the-expiration-period-for-subscriptions.md)」、「[トランザクション パブリケーションのディストリビューションの保有期間の設定 &#40;SQL Server Management Studio&#41;](set-distribution-retention-period-for-transactional-publications.md)」および「[パブリッシングおよびディストリビューションの構成](configure-publishing-and-distribution.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-105">To set retention periods, see [Set the Expiration Period for Subscriptions](publish/set-the-expiration-period-for-subscriptions.md), [Set the Distribution Retention Period for Transactional Publications &#40;SQL Server Management Studio&#41;](set-distribution-retention-period-for-transactional-publications.md), and [Configure Publishing and Distribution](configure-publishing-and-distribution.md).</span></span>  
  
## <a name="transactional-replication"></a><span data-ttu-id="bd8c4-106">トランザクション レプリケーション</span><span class="sxs-lookup"><span data-stu-id="bd8c4-106">Transactional Replication</span></span>  
 <span data-ttu-id="bd8c4-107">トランザクションレプリケーションでは、ディストリビューションの最大保有期間 ( **@max_distretention** [Sp_adddistributiondb &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-adddistributiondb-transact-sql)) とパブリケーションの保有期間 ( **@retention** [sp_addpublication &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql)のパラメーター) を使用します。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-107">Transactional replication uses the maximum distribution retention period (the **@max_distretention** parameter of [sp_adddistributiondb &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-adddistributiondb-transact-sql)) and the publication retention period (the **@retention** parameter of [sp_addpublication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql)):</span></span>  
  
-   <span data-ttu-id="bd8c4-108">ディストリビューションの最大保有期間 (既定値は 72 時間) 内にサブスクリプションが同期されず、ディストリビューション データベース内にサブスクライバーに配信されていない変更がある場合、そのサブスクリプションは、ディストリビューターで実行される **ディストリビューションのクリーンアップ** ジョブによって非アクティブ化にマークされます。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-108">If a subscription is not synchronized within the maximum distribution retention period (default of 72 hours) and there are changes in the distribution database that have not been delivered to the Subscriber, the subscription will be marked deactivated by the **Distribution clean up** job that runs on the Distributor.</span></span> <span data-ttu-id="bd8c4-109">サブスクリプションを再初期化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-109">The subscription must be reinitialized.</span></span>  
  
-   <span data-ttu-id="bd8c4-110">パブリケーションの保有期間 (既定値は 336 時間) 内にサブスクリプションが同期されない場合は、サブスクリプションは期限切れとなり、パブリッシャーで実行される **有効期限が切れたサブスクリプションのクリーンアップ** ジョブによって削除されます。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-110">If a subscription is not synchronized within the publication retention period (default of 336 hours), the subscription will expire and be dropped by the **Expired subscription clean up** job that runs on the Publisher.</span></span> <span data-ttu-id="bd8c4-111">サブスクリプションを再作成し、同期する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-111">The subscription must be recreated and synchronized.</span></span>  
  
     <span data-ttu-id="bd8c4-112">プッシュ サブスクリプションの期限が切れた場合は完全に削除されますが、プル サブスクリプションの場合は削除されません。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-112">If a push subscription expires, it is completely removed, but pull subscriptions are not.</span></span> <span data-ttu-id="bd8c4-113">プル サブスクリプションは、サブスクライバーでクリーンアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-113">You must clean up pull subscriptions at the Subscriber.</span></span> <span data-ttu-id="bd8c4-114">詳細については、「 [Delete a Pull Subscription](delete-a-pull-subscription.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-114">For more information, see [Delete a Pull Subscription](delete-a-pull-subscription.md).</span></span>  
  
## <a name="merge-replication"></a><span data-ttu-id="bd8c4-115">マージ レプリケーション</span><span class="sxs-lookup"><span data-stu-id="bd8c4-115">Merge Replication</span></span>  
 <span data-ttu-id="bd8c4-116">マージレプリケーションでは、パブリケーションの保有期間 **@retention** ( **@retention_period_unit** [sp_addmergepublication &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql)のパラメーターとパラメーター) を使用します。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-116">Merge replication uses the publication retention period (the **@retention** and **@retention_period_unit** parameters of [sp_addmergepublication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql)).</span></span> <span data-ttu-id="bd8c4-117">サブスクリプションが期限切れになると、そのサブスクリプションのメタデータが削除されるため、サブスクリプションを再初期化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-117">When a subscription expires, it must be reinitialized, because metadata for the subscription is removed.</span></span> <span data-ttu-id="bd8c4-118">再初期化されていないサブスクリプションは、パブリッシャーで実行される、 **有効期限が切れたサブスクリプションのクリーンアップ** ジョブによって削除されます。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-118">Subscriptions that are not reinitialized are dropped by the **Expired subscription clean up** job that runs on the Publisher.</span></span> <span data-ttu-id="bd8c4-119">既定では、このジョブは毎日実行されます。このジョブにより、パブリケーションの保有期間の 2 倍の期間にわたって同期されなかったすべてのプッシュ サブスクリプションが削除されます。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-119">By default, this job runs daily; it removes all push subscriptions that have not synchronized for double the length of the publication retention period.</span></span> <span data-ttu-id="bd8c4-120">次に例を示します。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-120">For example:</span></span>  
  
-   <span data-ttu-id="bd8c4-121">パブリケーションの保有期間が 14 日間である場合、サブスクリプションは 14 日以内に同期されなかった場合に期限切れになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-121">If a publication has a retention period of 14 days, a subscription can expire if it has not synchronized within 14 days.</span></span>  
  
     <span data-ttu-id="bd8c4-122">パブリッシャーが [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 以降のバージョンを実行しており、サブスクリプションのエージェントが [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 以降のバージョンから実行されている場合は、サブスクリプションのパーティション内のデータに変更があった場合にのみ、サブスクリプションは期限切れになります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-122">If the Publisher is running [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or a later version and the agent for the subscription is from [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or a later version, a subscription only expires if there have been changes to the data in that subscription's partition.</span></span> <span data-ttu-id="bd8c4-123">たとえば、サブスクライバーが、ドイツの顧客に関する顧客データのみを受信するとします。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-123">For example, suppose a Subscriber receives customer data only for customers in Germany.</span></span> <span data-ttu-id="bd8c4-124">保有期間が 14 日間に設定されているとすると、最近 14 日間でドイツの顧客データに変更があった場合にのみ、このサブスクリプションは 14 日目に期限切れになります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-124">If the retention period is set to 14 days, the subscription expires on day 14 only if there have been changes to the German customer data in the last 14 days.</span></span>  
  
-   <span data-ttu-id="bd8c4-125">最後の同期からの経過日数が 14 日から 27 日の間は、サブスクリプションを再初期化できます。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-125">From 14 days to 27 days after the last synchronization, the subscription can be reinitialized.</span></span>  
  
-   <span data-ttu-id="bd8c4-126">最後の同期後 28 日目に、サブスクリプションは、 **有効期限が切れたサブスクリプションのクリーンアップ** ジョブによって削除されます。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-126">At 28 days after the last synchronization, the subscription is dropped by the **Expired subscription clean up** job.</span></span> <span data-ttu-id="bd8c4-127">プッシュ サブスクリプションの期限が切れた場合は完全に削除されますが、プル サブスクリプションの場合は削除されません。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-127">If a push subscription expires, it is completely removed, but pull subscriptions are not.</span></span> <span data-ttu-id="bd8c4-128">プル サブスクリプションは、サブスクライバーでクリーンアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-128">You must clean up pull subscriptions at the Subscriber.</span></span> <span data-ttu-id="bd8c4-129">詳細については、「 [Delete a Pull Subscription](delete-a-pull-subscription.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-129">For more information, see [Delete a Pull Subscription](delete-a-pull-subscription.md).</span></span>  
  
### <a name="considerations-for-setting-the-publication-retention-period-for-merge-publications"></a><span data-ttu-id="bd8c4-130">マージ パブリケーションに対するパブリケーション保有期間の設定に関する注意点</span><span class="sxs-lookup"><span data-stu-id="bd8c4-130">Considerations for Setting the Publication Retention Period for Merge Publications</span></span>  
 <span data-ttu-id="bd8c4-131">マージ パブリケーションの保有期間を設定する場合は、以下の点に注意してください。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-131">Keep the following considerations in mind when setting the retention period for merge publications:</span></span>  
  
-   <span data-ttu-id="bd8c4-132">マージ パブリケーションの保有期間には、異なるタイム ゾーンのサブスクライバーに対応するため、24 時間の猶予期間があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-132">The retention period for merge publications has a 24-hour grace period to accommodate Subscribers in different time zones.</span></span> <span data-ttu-id="bd8c4-133">たとえば、保有期間を 1 日に設定した場合、実際の保有期間は 48 時間となります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-133">If, for example, you set a retention period of one day, the actual retention period is 48 hours.</span></span>  
  
-   <span data-ttu-id="bd8c4-134">マージ レプリケーション メタデータのクリーンアップは、パブリケーション保有期間に依存します。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-134">Cleanup of merge replication metadata is dependent on the publication retention period:</span></span>  
  
    -   <span data-ttu-id="bd8c4-135">保有期間が終了するまで、パブリケーションおよびサブスクリプション データベースでメタデータをクリーンアップすることはできません。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-135">Replication cannot clean up metadata in the publication and subscription databases until the retention period is reached.</span></span> <span data-ttu-id="bd8c4-136">レプリケーション パフォーマンスを低下させる可能性があるため、保有期間に大きな値を指定する際は注意してください。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-136">Use caution in specifying a high value for the retention period, because it can negatively impact replication performance.</span></span> <span data-ttu-id="bd8c4-137">すべてのサブスクライバーが保有期間内で定期的に同期されることを確実に予測できる場合は、小さい値を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-137">It is recommended that you use a lower setting if you can reliably predict that all Subscribers will synchronize regularly within that time period.</span></span>  
  
    -   <span data-ttu-id="bd8c4-138">サブスクリプションが期限切れにならないように指定することができます (の値は 0 **@retention** )。ただし、メタデータをクリーンアップできないため、この値は使用しないことを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-138">It is possible to specify that subscriptions never expire (a value of 0 for **@retention**), but it is strongly recommended that you do not use this value, because metadata cannot be cleaned up.</span></span>  
  
-   <span data-ttu-id="bd8c4-139">リパブリッシャーの保有期間は、元のパブリッシャーで設定されている保有期間以下の値に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-139">The retention period for any republisher must be set to a value equal to or less than the retention period set at the original Publisher.</span></span> <span data-ttu-id="bd8c4-140">また、すべてのパブリッシャーとその代替同期パートナーに対するパブリケーションの保有期間の値は、同じにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-140">You should also use the same publication retention values for all Publishers and their alternate synchronization partners.</span></span> <span data-ttu-id="bd8c4-141">異なる値を使用すると、集約されなくなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-141">Using different values may lead to non-convergence.</span></span> <span data-ttu-id="bd8c4-142">パブリケーションの保有期間の値を変更する必要がある場合は、サブスクライバーを再初期化して、データの未集約が発生しないようにします。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-142">If you need to change the publication retention value, reinitialize the Subscriber to avoid the non-convergence of data.</span></span>  
  
-   <span data-ttu-id="bd8c4-143">クリーンアップ後、パブリケーションの保有期間を延長し、既にメタデータを削除したパブリッシャーとのマージをサブスクリプションが試行した場合、保有期間の値が増加しているため、そのサブスクリプションは期限切れになりません。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-143">If, after a clean up, the publication retention period is increased and a subscription tries to merge with the Publisher (which has already deleted the metadata), the subscription will not expire because of the increased retention value.</span></span> <span data-ttu-id="bd8c4-144">ただし、パブリッシャーには、サブスクライバーに変更をダウンロードするための十分なメタデータが存在しないため、未集約が発生します。</span><span class="sxs-lookup"><span data-stu-id="bd8c4-144">However, the Publisher does not have enough metadata to download changes to the Subscriber, which leads to non-convergence.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bd8c4-145">参照</span><span class="sxs-lookup"><span data-stu-id="bd8c4-145">See Also</span></span>  
 <span data-ttu-id="bd8c4-146">[サブスクリプションの再初期化](reinitialize-subscriptions.md) </span><span class="sxs-lookup"><span data-stu-id="bd8c4-146">[Reinitialize Subscriptions](reinitialize-subscriptions.md) </span></span>  
 <span data-ttu-id="bd8c4-147">[レプリケーション エージェントの管理](agents/replication-agent-administration.md) </span><span class="sxs-lookup"><span data-stu-id="bd8c4-147">[Replication Agent Administration](agents/replication-agent-administration.md) </span></span>  
 [<span data-ttu-id="bd8c4-148">パブリケーションのサブスクライブ</span><span class="sxs-lookup"><span data-stu-id="bd8c4-148">Subscribe to Publications</span></span>](subscribe-to-publications.md)  
  
  
