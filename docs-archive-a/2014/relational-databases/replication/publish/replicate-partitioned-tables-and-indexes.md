---
title: パーティション テーブルとパーティション インデックスのレプリケート | Microsoft Docs
ms.custom: ''
ms.date: 09/10/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- partitioned indexes [SQL Server], replicating
- partitioned tables [SQL Server], replicating
- replication [SQL Server], partitioned tables
- publishing [SQL Server replication], partitioned tables
- transactional replication, partitioned tables
ms.assetid: c9fa81b1-6c81-4c11-927b-fab16301a8f5
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 616707bfb11b48b170fc8f0e8872076d2cd09d1c
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87633056"
---
# <a name="replicate-partitioned-tables-and-indexes"></a><span data-ttu-id="99f2e-102">パーティション テーブルとパーティション インデックスのレプリケート</span><span class="sxs-lookup"><span data-stu-id="99f2e-102">Replicate Partitioned Tables and Indexes</span></span>
  <span data-ttu-id="99f2e-103">大きなテーブルやインデックスをパーティション分割すると、データのサブセットに対するアクセスや管理を迅速かつ効率的に行うと同時に、データ コレクションの整合性を維持することができるので、大きなテーブルやインデックスを管理しやすくなります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-103">Partitioning makes large tables or indexes more manageable because partitioning enables you to manage and access subsets of data quickly and efficiently, and maintain the integrity of a data collection at the same time.</span></span> <span data-ttu-id="99f2e-104">詳細については、「 [Partitioned Tables and Indexes](../../partitions/partitioned-tables-and-indexes.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="99f2e-104">For more information, see [Partitioned Tables and Indexes](../../partitions/partitioned-tables-and-indexes.md).</span></span> <span data-ttu-id="99f2e-105">レプリケーションでは、パーティション テーブルとパーティション インデックスを扱う方法を指定するプロパティ セットによって、パーティション分割をサポートします。</span><span class="sxs-lookup"><span data-stu-id="99f2e-105">Replication supports partitioning by providing a set of properties that specify how partitioned tables and indexes should be treated.</span></span>  
  
## <a name="article-properties-for-transactional-and-merge-replication"></a><span data-ttu-id="99f2e-106">トランザクション レプリケーションおよびマージ レプリケーションのアーティクルのプロパティ</span><span class="sxs-lookup"><span data-stu-id="99f2e-106">Article Properties for Transactional and Merge Replication</span></span>  
 <span data-ttu-id="99f2e-107">次の表に、データのパーティション分割に使用されるオブジェクトを示します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-107">The following table lists the objects that are used to partition data.</span></span>  
  
|<span data-ttu-id="99f2e-108">Object</span><span class="sxs-lookup"><span data-stu-id="99f2e-108">Object</span></span>|<span data-ttu-id="99f2e-109">作成に使用するステートメント</span><span class="sxs-lookup"><span data-stu-id="99f2e-109">Created by using</span></span>|  
|------------|----------------------|  
|<span data-ttu-id="99f2e-110">パーティション テーブルまたはパーティション インデックス</span><span class="sxs-lookup"><span data-stu-id="99f2e-110">Partitioned table or index</span></span>|<span data-ttu-id="99f2e-111">CREATE TABLE または CREATE INDEX</span><span class="sxs-lookup"><span data-stu-id="99f2e-111">CREATE TABLE or CREATE INDEX</span></span>|  
|<span data-ttu-id="99f2e-112">パーティション関数</span><span class="sxs-lookup"><span data-stu-id="99f2e-112">Partition function</span></span>|<span data-ttu-id="99f2e-113">CREATE PARTITION FUNCTION</span><span class="sxs-lookup"><span data-stu-id="99f2e-113">CREATE PARTITION FUNCTION</span></span>|  
|<span data-ttu-id="99f2e-114">パーティション構成</span><span class="sxs-lookup"><span data-stu-id="99f2e-114">Partition scheme</span></span>|<span data-ttu-id="99f2e-115">CREATE PARTITION SCHEME</span><span class="sxs-lookup"><span data-stu-id="99f2e-115">CREATE PARTITION SCHEME</span></span>|  
  
 <span data-ttu-id="99f2e-116">パーティション分割に関連するプロパティの最初のセットは、パーティション分割するオブジェクトをサブスクライバーにコピーするかどうかを指定するアーティクルのスキーマ オプションです。</span><span class="sxs-lookup"><span data-stu-id="99f2e-116">The first set of properties related to partitioning are the article schema options that determine whether partitioning objects should be copied to the Subscriber.</span></span> <span data-ttu-id="99f2e-117">これらのスキーマ オプションは次の方法で設定できます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-117">These schema options can be set in the following ways:</span></span>  
  
-   <span data-ttu-id="99f2e-118">パブリケーションの新規作成ウィザードの **[アーティクルのプロパティ]** ページ、または [パブリケーションのプロパティ] ダイアログ ボックス。</span><span class="sxs-lookup"><span data-stu-id="99f2e-118">In the **Article Properties** page of the New Publication Wizard or the Publication Properties dialog box.</span></span> <span data-ttu-id="99f2e-119">前の表に示したオブジェクトをコピーするには、[ `true` **テーブル分割**構成のコピー] プロパティと [**インデックス分割**構成のコピー] プロパティに値を指定します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-119">To copy the objects listed in the previous table, specify a value of `true` for the properties **Copy table partitioning schemes** and **Copy index partitioning schemes**.</span></span> <span data-ttu-id="99f2e-120">**[アーティクルのプロパティ]** ページへのアクセス方法については、「[View and Modify Publication Properties](view-and-modify-publication-properties.md)」 (パブリケーション プロパティの表示および変更) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="99f2e-120">For information about how to access the **Article Properties** page, see [View and Modify Publication Properties](view-and-modify-publication-properties.md).</span></span>  
  
-   <span data-ttu-id="99f2e-121">次のいずれかのストアド プロシージャの *schema_option* パラメーターの使用。</span><span class="sxs-lookup"><span data-stu-id="99f2e-121">By using the *schema_option* parameter of one of the following stored procedures:</span></span>  
  
    -   <span data-ttu-id="99f2e-122">トランザクション レプリケーションの[sp_addarticle](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) または [sp_changearticle](/sql/relational-databases/system-stored-procedures/sp-changearticle-transact-sql) fまたは transactional replication</span><span class="sxs-lookup"><span data-stu-id="99f2e-122">[sp_addarticle](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) or [sp_changearticle](/sql/relational-databases/system-stored-procedures/sp-changearticle-transact-sql) for transactional replication</span></span>  
  
    -   <span data-ttu-id="99f2e-123">マージ レプリケーションの[sp_addmergearticle](/sql/relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql) または [sp_changemergearticle](/sql/relational-databases/system-stored-procedures/sp-changemergearticle-transact-sql) fまたは merge replication</span><span class="sxs-lookup"><span data-stu-id="99f2e-123">[sp_addmergearticle](/sql/relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql) or [sp_changemergearticle](/sql/relational-databases/system-stored-procedures/sp-changemergearticle-transact-sql) for merge replication</span></span>  
  
     <span data-ttu-id="99f2e-124">上記の表に示したオブジェクトをコピーするには、適切なスキーマ オプション値を指定します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-124">To copy the objects listed in the previous table, specify the appropriate schema option values.</span></span> <span data-ttu-id="99f2e-125">スキーマ オプションを指定する方法については、「 [Specify Schema Options](specify-schema-options.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="99f2e-125">For information about how to specify schema options, see [Specify Schema Options](specify-schema-options.md).</span></span>  
  
 <span data-ttu-id="99f2e-126">レプリケーションでは、初期同期中にオブジェクトがサブスクライバーにコピーされます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-126">Replication copies objects to the Subscriber during the initial synchronization.</span></span> <span data-ttu-id="99f2e-127">パーティション構成で PRIMARY 以外のファイル グループを使用する場合、そのファイル グループは初期同期の前にサブスクライバーに存在している必要があります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-127">If the partition scheme uses filegroups other than the PRIMARY filegroup, those filegroups must exist on the Subscriber before the initial synchronization.</span></span>  
  
 <span data-ttu-id="99f2e-128">サブスクライバーが初期化された後、データ変更がサブスクライバーに反映され、適切なパーティションに適用されます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-128">After the Subscriber is initialized, data changes are propagated to the Subscriber and applied to the appropriate partitions.</span></span> <span data-ttu-id="99f2e-129">ただし、パーティション構成に対する変更はサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="99f2e-129">However, changes to the partition scheme are not supported.</span></span> <span data-ttu-id="99f2e-130">トランザクション レプリケーションとマージ レプリケーションでは、ALTER PARTITION FUNCTION コマンド、ALTER PARTITION SCHEME コマンド、ALTER INDEX コマンドの REBUILD WITH PARTITION ステートメントのレプリケートはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="99f2e-130">Transactional and merge replication do not support replicating the following commands: ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME, or the REBUILD WITH PARTITION statement of ALTER INDEX.</span></span>  <span data-ttu-id="99f2e-131">これらに関連付けられた変更は、サブスクライバーに自動的にレプリケートされません。</span><span class="sxs-lookup"><span data-stu-id="99f2e-131">The changes associated with them will not be automatically replicated to the Subscriber.</span></span> <span data-ttu-id="99f2e-132">ユーザーがサブスクライバー側で同様の変更を手動で行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-132">It is the responsibility of the user to make similar changes manually at the Subscriber.</span></span>  
  
## <a name="replication-support-for-partition-switching"></a><span data-ttu-id="99f2e-133">レプリケーションによるパーティション切り替えのサポート</span><span class="sxs-lookup"><span data-stu-id="99f2e-133">Replication Support for Partition Switching</span></span>  
 <span data-ttu-id="99f2e-134">テーブル分割の主な利点の 1 つは、パーティション間でデータのサブセットをすばやく効率的に移動できることです。</span><span class="sxs-lookup"><span data-stu-id="99f2e-134">One of the key benefits of table partitioning is the ability to quickly and efficiently move subsets of data between partitions.</span></span> <span data-ttu-id="99f2e-135">データは SWITCH PARTITION コマンドを使用して移動します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-135">Data is moved by using the SWITCH PARTITION command.</span></span> <span data-ttu-id="99f2e-136">既定では、テーブルのレプリケーションが有効な場合、SWITCH PARTITION 操作は次の理由でブロックされます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-136">By default, when a table is enabled for replication, SWITCH PARTITION operations are blocked for the following reasons:</span></span>  
  
-   <span data-ttu-id="99f2e-137">パブリッシャーに存在するテーブルを移動元または移動先としてデータを移動する場合に、そのデータがサブスクライバーに存在しないと、パブリッシャーとサブスクライバーの間で不整合が発生します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-137">If data is moved into or out of a table that exists at the Publisher but does not exist at the Subscriber, the Publisher and Subscriber could become inconsistent with one another.</span></span> <span data-ttu-id="99f2e-138">この問題は、一般に、ステージング テーブルにかかわるデータの移動で発生します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-138">This problem typically occurs when data is moved into or out of a staging table.</span></span>  
  
-   <span data-ttu-id="99f2e-139">サブスクライバーにパブリッシャーとは異なるパーティション テーブルの定義がある場合、ディストリビューション エージェントが変更をサブスクライバーに適用しようとすると失敗します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-139">If the Subscriber has a different definition for the partitioned table than the Publisher, the Distribution Agent will fail when it tries to apply changes at the Subscriber.</span></span>  
  
 <span data-ttu-id="99f2e-140">このような問題が発生する可能性はありますが、トランザクション レプリケーションでパーティション切り替えを有効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-140">Despite these potential issues, partition switching can be enabled for transactional replication.</span></span> <span data-ttu-id="99f2e-141">パーティション切り替えを有効にする前に、パーティション切り替えに関連するすべてのテーブルがパブリッシャーとサブスクライバーに存在し、テーブル定義およびパーティション定義が同じであることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="99f2e-141">Before you enable partition switching, make sure that all tables that are involved in partition switching exist at the Publisher and Subscriber, and make sure that the table and partition definitions are the same.</span></span>  
  
 <span data-ttu-id="99f2e-142">パブリッシャーとサブスクライバーでパーティションにまったく同じパーティション構成が使用されている場合は、パブリッシャーへのパーティション切り替えステートメントのレプリケートのみを行う *allow_partition_switch* と共に、 *replication_partition_switch* を有効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-142">When partitions have the exact same partition scheme at the publishers and subscribers you can turn on *allow_partition_switch* along with *replication_partition_switch* which will only replicate the partition switch statement to the subscriber.</span></span> <span data-ttu-id="99f2e-143">DDL をレプリケートしないで、 *allow_partition_switch* を有効にすることもできます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-143">You can also turn on *allow_partition_switch* without replicating the DDL.</span></span> <span data-ttu-id="99f2e-144">これは、過去の月をパーティションからロール アウトする一方、バックアップの目的で、レプリケートしたパーティションをサブスクライバーにもう 1 年保持する場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="99f2e-144">This is useful in the case where you want to roll old months out of the partition but keep the replicated partition in place for another year for backup purposes at the subscriber.</span></span>  
  
 <span data-ttu-id="99f2e-145">SQL Server 2008 R2 から現在のバージョンまででパーティション切り替えを有効にすると、近い将来、分割操作とマージ操作が必要になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-145">If you enable partition switching on SQL Server 2008 R2 through the current version, you might also need split and merge operations in near future.</span></span> <span data-ttu-id="99f2e-146">レプリケートされたテーブルでの分割またはマージ操作を実行する前に、該当するパーティションに保留中のレプリケートされたコマンドがないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-146">Before executing a split or merge operation on a replicated table ensure that the partition in question does not have any pending replicated commands.</span></span> <span data-ttu-id="99f2e-147">分割操作とマージ操作中にパーティションで DML 操作が実行されないようにする必要もあります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-147">You should also ensure that no DML operations are executed on the partition during the split and merge operations.</span></span> <span data-ttu-id="99f2e-148">ログ リーダーが処理していないトランザクションがある場合や、分割操作またはマージ操作中に、レプリケートされたテーブルのパーティションで DML 操作が実行される場合 (同じパーティションに関連する場合)、ログ リーダー エージェントで処理エラーが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-148">If there are transactions which the log reader has not processed, or if DML operations are performed on a partition of a replicated table while a split or merge operation is executed (involving the same partition), it could lead to a processing error with log reader agent.</span></span> <span data-ttu-id="99f2e-149">このエラーを修正するには、サブスクリプションの再初期化が必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-149">In order to correct the error, it might require a re-initialization of the subscription.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="99f2e-150">ピア ツー ピア パブリケーションでは、非表示の列が競合の検出および解決のために使用されるため、パーティション切り替えを有効にしないでください。</span><span class="sxs-lookup"><span data-stu-id="99f2e-150">You should not enable partition switching for Peer-to-Peer publications, due to the hidden column which is used to detect and resolve conflict.</span></span>  
  
### <a name="enabling-partition-switching"></a><span data-ttu-id="99f2e-151">パーティション切り替えの有効化</span><span class="sxs-lookup"><span data-stu-id="99f2e-151">Enabling Partition Switching</span></span>  
 <span data-ttu-id="99f2e-152">トランザクション パブリケーションの次のプロパティを使用すると、レプリケーション環境でのパーティション切り替えの動作を制御できます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-152">The following properties for transactional publications enable users to control the behavior of partition switching in a replicated environment:</span></span>  
  
-   <span data-ttu-id="99f2e-153">\*\* \@ allow_partition_switch\*\*、に設定すると `true` 、パブリケーションデータベースに対して switch partition を実行できます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-153">**\@allow_partition_switch**, when set to `true`, SWITCH PARTITION can be executed against the publication database.</span></span>  
  
-   <span data-ttu-id="99f2e-154">\*\* \@ replicate_partition_switch\*\*によって、switch partition DDL ステートメントをサブスクライバーにレプリケートする必要があるかどうかが決まります。</span><span class="sxs-lookup"><span data-stu-id="99f2e-154">**\@replicate_partition_switch** determines whether the SWITCH PARTITION DDL statement should be replicated to Subscribers.</span></span> <span data-ttu-id="99f2e-155">このオプションは、 \*\* \@ allow_partition_switch\*\*がに設定されている場合にのみ有効です `true` 。</span><span class="sxs-lookup"><span data-stu-id="99f2e-155">This option is valid only when **\@allow_partition_switch** is set to `true`.</span></span>  
  
 <span data-ttu-id="99f2e-156">これらのプロパティは、パブリケーションの作成時に [sp_addpublication](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql) を使用するか、パブリケーションの作成後に [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql) を使用することによって設定できます。</span><span class="sxs-lookup"><span data-stu-id="99f2e-156">You can set these properties by using [sp_addpublication](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql) when the publication is created, or by using [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql) after the publication is created.</span></span> <span data-ttu-id="99f2e-157">既に述べたとおり、マージ レプリケーションではパーティション切り替えがサポートされません。</span><span class="sxs-lookup"><span data-stu-id="99f2e-157">As noted earlier, merge replication does not support partition switching.</span></span> <span data-ttu-id="99f2e-158">マージ レプリケーションが有効になっているテーブルで SWITCH PARTITION を実行するには、パブリケーションからテーブルを削除します。</span><span class="sxs-lookup"><span data-stu-id="99f2e-158">To execute SWITCH PARTITION on a table that is enabled for merge replication, remove the table from the publication.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="99f2e-159">参照</span><span class="sxs-lookup"><span data-stu-id="99f2e-159">See Also</span></span>  
 [<span data-ttu-id="99f2e-160">データとデータベース オブジェクトのパブリッシュ</span><span class="sxs-lookup"><span data-stu-id="99f2e-160">Publish Data and Database Objects</span></span>](publish-data-and-database-objects.md)  
  
  
