---
title: スナップショット レプリケーションおよびトランザクション レプリケーションのバックアップと復元の方式 | Microsoft Docs
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- backups [SQL Server replication], snapshot replication
- restoring [SQL Server replication], transactional replication
- snapshot replication [SQL Server], backup and restore
- restoring [SQL Server replication], snapshot replication
- recovery [SQL Server replication], transactional replication
- transactional replication, backup and restore
- recovery [SQL Server replication], snapshot replication
- sync with backup [SQL Server replication]
- backups [SQL Server replication], transactional replication
ms.assetid: a8afcdbc-55db-4916-a219-19454f561f9e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e26f6cf1a61e4df9db79bc5fd90429f86d70a99f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87646142"
---
# <a name="strategies-for-backing-up-and-restoring-snapshot-and-transactional-replication"></a><span data-ttu-id="9fbe2-102">スナップショット レプリケーションおよびトランザクション レプリケーションのバックアップと復元の方式</span><span class="sxs-lookup"><span data-stu-id="9fbe2-102">Strategies for Backing Up and Restoring Snapshot and Transactional Replication</span></span>
  <span data-ttu-id="9fbe2-103">スナップショット レプリケーションおよびトランザクション レプリケーションのバックアップと復元の方式を計画する場合には、以下の 3 点を考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-103">When you design a backup and restore strategy for snapshot and transactional replication, there are three areas to consider:</span></span>  
  
-   <span data-ttu-id="9fbe2-104">バックアップ対象のデータベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-104">Which databases to back up.</span></span>  
  
-   <span data-ttu-id="9fbe2-105">トランザクション レプリケーションのバックアップ設定</span><span class="sxs-lookup"><span data-stu-id="9fbe2-105">Backup settings for transactional replication.</span></span>  
  
-   <span data-ttu-id="9fbe2-106">データベースを復元するために必要な手順。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-106">The steps that are required to restore a database.</span></span> <span data-ttu-id="9fbe2-107">この手順は、レプリケーションの種類と選択したオプションによって異なります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-107">These depend on the type of replication and options chosen.</span></span>  
  
 <span data-ttu-id="9fbe2-108">このトピックでは、これらの各項目について、以下の 3 つのセクションで説明します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-108">This topic covers each of these areas in the next three sections.</span></span> <span data-ttu-id="9fbe2-109">Oracle パブリッシングのバックアップと復元については、「[Oracle パブリッシャーのバックアップと復元](../non-sql/backup-and-restore-for-oracle-publishers.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-109">For information about backup and restore for Oracle publishing, see [Backup and Restore for Oracle Publishers](../non-sql/backup-and-restore-for-oracle-publishers.md).</span></span>  
  
## <a name="backing-up-databases"></a><span data-ttu-id="9fbe2-110">データベースのバックアップ</span><span class="sxs-lookup"><span data-stu-id="9fbe2-110">Backing up Databases</span></span>  
 <span data-ttu-id="9fbe2-111">スナップショット レプリケーションおよびトランザクション レプリケーションの場合は、以下のデータベースを定期的にバックアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-111">For snapshot and transactional replication, you should regularly back up the following databases:</span></span>  
  
-   <span data-ttu-id="9fbe2-112">パブリッシャーにあるパブリケーション データベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-112">The publication database at the Publisher.</span></span>  
  
-   <span data-ttu-id="9fbe2-113">ディストリビューターにあるディストリビューション データベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-113">The distribution database at the Distributor.</span></span>  
  
-   <span data-ttu-id="9fbe2-114">サブスクライバーにあるサブスクリプション データベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-114">The subscription database at each Subscriber.</span></span>  
  
-   <span data-ttu-id="9fbe2-115">パブリッシャー、ディストリビューター、およびすべてのサブスクライバーにある **master** および **msdb** システム データベース。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-115">The **master** and **msdb** system databases at the Publisher, Distributor and all Subscribers.</span></span> <span data-ttu-id="9fbe2-116">これらのデータベースは、相互に関連するレプリケーション データベースとして、同時にバックアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-116">These databases should be backed up at the same time as each other and the relevant replication database.</span></span> <span data-ttu-id="9fbe2-117">たとえば、パブリッシャーでパブリケーション データベースをバックアップするときに、 **master** および **msdb** データベースも同時にバックアップします。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-117">For example, back up the **master** and **msdb** databases at the Publisher at the same time that you back up the publication database.</span></span> <span data-ttu-id="9fbe2-118">パブリケーション データベースが復元されるときに、 **master** および **msdb** データベースのレプリケーションの構成と設定が、パブリケーション データベースと一致していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-118">If the publication database is restored, make sure that the **master** and **msdb** databases are consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
 <span data-ttu-id="9fbe2-119">定期的なログ バックアップを実行する場合は、レプリケーション関連の変更をログ バックアップでキャプチャする必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-119">If you perform regular log backups, any replication-related changes should be captured in the log backups.</span></span> <span data-ttu-id="9fbe2-120">ログ バックアップを実行しない場合は、レプリケーションに関連する設定を変更するたびに、バックアップを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-120">If you do not perform log backups, a backup should be performed whenever a setting relevant to replication is changed.</span></span> <span data-ttu-id="9fbe2-121">詳細については、「 [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-121">For more information, see [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).</span></span>  
  
## <a name="backup-settings-for-transactional-replication"></a><span data-ttu-id="9fbe2-122">トランザクション レプリケーションのバックアップ設定</span><span class="sxs-lookup"><span data-stu-id="9fbe2-122">Backup Settings for Transactional Replication</span></span>  
 <span data-ttu-id="9fbe2-123">トランザクション レプリケーションには " **sync with backup** " オプションが用意されており、ディストリビューション データベースおよびパブリケーション データベースで設定できます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-123">Transactional replication includes using the **sync with backup** option, which can be set on the distribution database and the publication database:</span></span>  
  
-   <span data-ttu-id="9fbe2-124">ディストリビューション データベースでは、常にこのオプションを設定することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-124">We recommend that you always set this option on the distribution database.</span></span>  
  
     <span data-ttu-id="9fbe2-125">ディストリビューション データベースでこのオプションを設定すると、パブリケーション データベースのログに記録されたトランザクションは、ディストリビューション データベース内のバックアップが終了するまで切り捨てられることはありません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-125">Setting this option on the distribution database ensures that transactions in the log of the publication database will not be truncated until they have been backed up at the distribution database.</span></span> <span data-ttu-id="9fbe2-126">ディストリビューション データベースは前回のバックアップに復元できます。失われたトランザクションは、パブリケーション データベースからディストリビューション データベースに配信されます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-126">The distribution database can be restored to the last backup, and any missing transactions are delivered from the publication database to the distribution database.</span></span> <span data-ttu-id="9fbe2-127">レプリケーションは影響を受けることなく継続されます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-127">Replication continues unaffected.</span></span>  
  
     <span data-ttu-id="9fbe2-128">ディストリビューション データベースでこのオプションを設定しても、レプリケーションの待機時間には影響しません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-128">Setting this option on the distribution database does not affect replication latency.</span></span> <span data-ttu-id="9fbe2-129">ただし、ディストリビューション データベース内の対応するトランザクションがバックアップされるまで、パブリケーション データベースでのログの切り捨てが遅延されます</span><span class="sxs-lookup"><span data-stu-id="9fbe2-129">However, the option will delay the truncation of the log on the publication database until the corresponding transactions in the distribution database have been backed up.</span></span> <span data-ttu-id="9fbe2-130">(この結果、パブリケーション データベースのトランザクション ログのサイズが増加する可能性があります)。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-130">(This can create a larger transaction log in the publication database.)</span></span>  
  
-   <span data-ttu-id="9fbe2-131">アプリケーションがレプリケーションの待機時間の延長を許容できる場合は、パブリケーション データベースでこのオプションを設定することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-131">We recommend that you set this option on the publication database if your application can tolerate additional latency.</span></span>  
  
     <span data-ttu-id="9fbe2-132">パブリケーション データベースでこのオプションを設定すると、パブリケーション データベースでのバックアップが終了するまで、トランザクションがディストリビューション データベースに配信されることはなくなります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="9fbe2-133">その後、パブリッシャーでパブリケーション データベースを前回のバックアップに復元できます。復元されたパブリケーション データベースにないトランザクションが、ディストリビューション データベースに存在する可能性は一切ありません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-133">The last publication database backup can then be restored at the Publisher without any chance of the distribution database having transactions that the restored publication database does not have.</span></span>  
  
     <span data-ttu-id="9fbe2-134">パブリッシャーでのバックアップが終了するまでの間、トランザクションがディストリビューション データベースに配信されなくなるため、レプリケーションの待機時間とスループットが影響を受けます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-134">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher.</span></span> <span data-ttu-id="9fbe2-135">たとえば、トランザクション ログが 5 分ごとにバックアップされる場合、パブリッシャーでトランザクションがコミットされてから、パブリッシャーからディストリビューション データベース、その後サブスクライバーにトランザクションが配信されるまでの間に、さらに 5 分間の待機時間が発生します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-135">For example, if the transaction log is backed up every five minutes, there is an additional five minutes of latency between when a transaction is committed at the Publisher and when the transaction is delivered to the distribution database, and subsequently the Subscriber.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="9fbe2-136">" **sync with backup** " オプションを設定すると、パブリケーション データベースとディストリビューション データベースの一貫性が確保されますが、データの損失が発生しなくなるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-136">The **sync with backup** option ensures consistency between the publication database and the distribution database, but the option does not guarantee against data loss.</span></span> <span data-ttu-id="9fbe2-137">たとえば、トランザクション ログが見つからない場合、トランザクション ログの前回のバックアップ以降にコミットされたトランザクションを、パブリケーション データベースまたはディストリビューション データベースで利用することはできません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-137">For example, if the transaction log is lost, transactions that have been committed since the last transaction log backup will not be available in the publication database or the distribution database.</span></span> <span data-ttu-id="9fbe2-138">これは、レプリケートされていないデータベースと同様の動作です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-138">This is the same behavior as a nonreplicated database.</span></span>  
  
 <span data-ttu-id="9fbe2-139">**"sync with backup" オプションを設定するには**</span><span class="sxs-lookup"><span data-stu-id="9fbe2-139">**To set the sync with backup option**</span></span>  
  
-   <span data-ttu-id="9fbe2-140">レプリケーション [!INCLUDE[tsql](../../../includes/tsql-md.md)] プログラミング: [トランザクション レプリケーションの連携バックアップの有効化 (レプリケーション Transact-SQL プログラミング)](enable-coordinated-backups-for-transactional-replication.md)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-140">Replication [!INCLUDE[tsql](../../../includes/tsql-md.md)] programming: [Enable Coordinated Backups for Transactional Replication &#40;Replication Transact-SQL Programming&#41;](enable-coordinated-backups-for-transactional-replication.md)</span></span>  
  
## <a name="restoring-databases-involved-in-replication"></a><span data-ttu-id="9fbe2-141">レプリケーションに関連するデータベースの復元</span><span class="sxs-lookup"><span data-stu-id="9fbe2-141">Restoring Databases Involved in Replication</span></span>  
 <span data-ttu-id="9fbe2-142">最新のバックアップが利用可能で適切な手順が実行された場合、レプリケーション トポロジ内のすべてのデータベースを復元できます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-142">You can restore all databases in a replication topology if recent backups are available and the appropriate steps are followed.</span></span> <span data-ttu-id="9fbe2-143">パブリケーション データベースの復元手順は、使用するレプリケーションの種類とオプションによって異なります。ただし、パブリケーション データベース以外のデータベースの復元手順は、レプリケーションの種類とオプションに依存しません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-143">The restore steps for the publication database depend on the type of replication and options that are used; however, the restore steps for all other databases are independent of the type and options.</span></span>  
  
 <span data-ttu-id="9fbe2-144">レプリケーションでは、レプリケートされたデータベースをバックアップ作成元のサーバーおよびデータベースに復元する操作がサポートされます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-144">Replication supports restoring replicated databases to the same server and database from which the backup was created.</span></span> <span data-ttu-id="9fbe2-145">レプリケートされたデータベースのバックアップを別のサーバーまたはデータベースに復元する場合は、レプリケーションの設定は保存できません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-145">If you restore a backup of a replicated database to another server or database, replication settings cannot be preserved.</span></span> <span data-ttu-id="9fbe2-146">この場合、バックアップの復元後にすべてのパブリケーションおよびサブスクリプションを再作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-146">In this case, you must re-create all publications and subscriptions after backups are restored.</span></span>  
  
### <a name="publisher"></a><span data-ttu-id="9fbe2-147">Publisher</span><span class="sxs-lookup"><span data-stu-id="9fbe2-147">Publisher</span></span>  
 <span data-ttu-id="9fbe2-148">以下の種類のレプリケーションについては、復元手順が用意されています。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-148">There are restore steps provided for the following types of replication:</span></span>  
  
-   <span data-ttu-id="9fbe2-149">スナップショット レプリケーション</span><span class="sxs-lookup"><span data-stu-id="9fbe2-149">Snapshot replication</span></span>  
  
-   <span data-ttu-id="9fbe2-150">読み取り専用トランザクション レプリケーション</span><span class="sxs-lookup"><span data-stu-id="9fbe2-150">Read-only transactional replication</span></span>  
  
-   <span data-ttu-id="9fbe2-151">更新サブスクリプションを使用するトランザクション レプリケーション</span><span class="sxs-lookup"><span data-stu-id="9fbe2-151">Transactional replication with updating subscriptions</span></span>  
  
-   <span data-ttu-id="9fbe2-152">ピア ツー ピア トランザクション レプリケーション</span><span class="sxs-lookup"><span data-stu-id="9fbe2-152">Peer-to-peer transactional replication</span></span>  
  
 <span data-ttu-id="9fbe2-153">**msdb** データベースおよび **master** データベースの復元方法についてもこのセクションで説明しますが、上記の 4 種類のレプリケーションについてはすべて同じ方法です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-153">The restore of the **msdb** and **master** databases, which are also covered in this section, is the same for all four types.</span></span>  
  
#### <a name="publication-database-snapshot-replication"></a><span data-ttu-id="9fbe2-154">パブリケーション データベース: スナップショット レプリケーション</span><span class="sxs-lookup"><span data-stu-id="9fbe2-154">Publication Database: Snapshot Replication</span></span>  
  
1.  <span data-ttu-id="9fbe2-155">パブリケーション データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-155">Restore the latest backup of the publication database.</span></span> <span data-ttu-id="9fbe2-156">手順 2 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-156">Go to step 2.</span></span>  
  
2.  <span data-ttu-id="9fbe2-157">すべてのパブリケーションおよびサブスクリプションに対する最新の構成がパブリケーション データベースのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-157">Does the publication database backup contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="9fbe2-158">答えが「はい」の場合、復元は完了です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-158">If yes, the restore is completed.</span></span> <span data-ttu-id="9fbe2-159">「いいえ」の場合は、手順 3. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-159">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="9fbe2-160">パブリッシャー、ディストリビューター、およびサブスクライバーで、レプリケーション構成を削除した後、再作成を行います。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-160">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="9fbe2-161">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-161">Restore is completed.</span></span>  
  
     <span data-ttu-id="9fbe2-162">レプリケーションを削除する方法の詳細については、「[sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-162">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
#### <a name="publication-database-read-only-transactional-replication"></a><span data-ttu-id="9fbe2-163">パブリケーション データベース: 読み取り専用トランザクション レプリケーション</span><span class="sxs-lookup"><span data-stu-id="9fbe2-163">Publication Database: Read-Only Transactional Replication</span></span>  
  
1.  <span data-ttu-id="9fbe2-164">パブリケーション データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-164">Restore the latest backup of the publication database.</span></span> <span data-ttu-id="9fbe2-165">手順 2 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-165">Go to step 2.</span></span>  
  
2.  <span data-ttu-id="9fbe2-166">障害の発生前に、パブリケーション データベースで " **sync with backup** " 設定が有効になっていましたか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-166">Was the **sync with backup** setting enabled on the publication database before the failure?</span></span> <span data-ttu-id="9fbe2-167">答えが「はい」の場合は、手順 3 に進みます。「いいえ」の場合は、手順 5 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-167">If yes, go to step 3; if no, go to step 5.</span></span>  
  
     <span data-ttu-id="9fbe2-168">設定が有効の場合、 `SELECT DATABASEPROPERTYEX('<PublicationDatabaseName>', 'IsSyncWithBackup')` クエリが "1" を返します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-168">If the setting is enabled, the query `SELECT DATABASEPROPERTYEX('<PublicationDatabaseName>', 'IsSyncWithBackup')` returns '1'.</span></span>  
  
3.  <span data-ttu-id="9fbe2-169">復元されたバックアップは完全かつ最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-169">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="9fbe2-170">すべてのパブリケーションおよびサブスクリプションに対する最新の構成がこのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-170">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="9fbe2-171">答えが「はい」の場合、復元は完了です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-171">If yes, the restore is completed.</span></span> <span data-ttu-id="9fbe2-172">「いいえ」の場合は、手順 4 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-172">If no, go to step 4.</span></span>  
  
4.  <span data-ttu-id="9fbe2-173">復元されたパブリケーション データベースの構成情報が最新ではありません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-173">The configuration information in the restored publication database is not up-to-date.</span></span> <span data-ttu-id="9fbe2-174">このため、サブスクライバーで未実行のコマンドがすべてディストリビューション データベースに存在することを確認し、レプリケーション構成の削除と再作成を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-174">Therefore, you must make sure that the Subscribers have all outstanding commands in the distribution database, and then drop and re-create the replication configuration.</span></span>  
  
    1.  <span data-ttu-id="9fbe2-175">すべてのサブスクライバーがディストリビューション データベース内の未実行のコマンドと同期するまで、ディストリビューション エージェントを実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-175">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="9fbe2-176">レプリケーション モニターの **[未配布のコマンド]** タブを使用するか、またはディストリビューション データベース内の [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) ビューでクエリを実行して、すべてのコマンドがサブスクライバーに配信されたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-176">Verify that all commands are delivered to Subscribers by using the **Undistributed Commands** tab in Replication Monitor or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="9fbe2-177">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-177">Go to step b.</span></span>  
  
         <span data-ttu-id="9fbe2-178">ディストリビューション エージェントの実行方法の詳細については、「[レプリケーション エージェントを起動および停止する &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)」および「[レプリケーション エージェント実行可能ファイルの概念](../concepts/replication-agent-executables-concepts.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-178">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
         <span data-ttu-id="9fbe2-179">コマンドを確認する方法の詳細については、「[ディストリビューションデータベースのレプリケートされたコマンドおよびその他の情報を表示](../monitor/view-replicated-commands-and-information-in-distribution-database.md)する」を参照してください。レプリケーション transact-sql プログラミング&#41;および &#40;レプリケーション[モニターを使用して情報を表示し、タスクを実行](../monitor/view-information-and-perform-tasks-replication-monitor.md)します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-179">For more information about how to verify commands, see [View Replicated Commands and Other Information in the Distribution Database &#40;Replication Transact-SQL Programming&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md) and [View Information and Perform Tasks using Replication Monitor](../monitor/view-information-and-perform-tasks-replication-monitor.md).</span></span>  
  
    2.  <span data-ttu-id="9fbe2-180">パブリッシャー、ディストリビューター、およびサブスクライバーで、レプリケーション構成を削除した後、再作成を行います。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-180">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="9fbe2-181">サブスクリプションを再作成するときには、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-181">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-182">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-182">The restore is completed.</span></span>  
  
         <span data-ttu-id="9fbe2-183">レプリケーションを削除する方法の詳細については、「[sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-183">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="9fbe2-184">サブスクライバーにデータが格納済みであることを指定する方法の詳細については、「 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-184">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
5.  <span data-ttu-id="9fbe2-185">パブリケーション データベースで " **sync with backup** " オプションが設定されていませんでした。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-185">The **sync with backup** option was not set on the publication database.</span></span> <span data-ttu-id="9fbe2-186">このため、復元されたバックアップに含まれていないトランザクションが、ディストリビューターまたはサブスクライバーに配信された可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-186">Therefore, transactions that were not included in the restored backup might have been delivered to the Distributor and Subscribers.</span></span> <span data-ttu-id="9fbe2-187">サブスクライバーで未実行のコマンドがすべてディストリビューション データベースに存在することを確認し、復元されたバックアップに含まれないすべてのトランザクションをパブリケーション データベースに手動で適用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-187">You must now make sure that Subscribers have all outstanding commands in the distribution database, and then manually apply to the publication database any transactions that are not included in the restored backup.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="9fbe2-188">この処理を実行することによって、復元対象のパブリッシュされたテーブルを、バックアップから復元されたパブリッシュされていないテーブルよりも新しい状態にすることができます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-188">Performing this process can cause published tables to be restored to a point in time that is more recent than the point in time of other nonpublished tables that are restored from the backup.</span></span>  
  
    1.  <span data-ttu-id="9fbe2-189">すべてのサブスクライバーがディストリビューション データベース内の未実行のコマンドと同期するまで、ディストリビューション エージェントを実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-189">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="9fbe2-190">レプリケーション モニターの **[未配布のコマンド]** タブを使用するか、またはディストリビューション データベース内の [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) ビューでクエリを実行して、すべてのコマンドがサブスクライバーに配信されたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-190">Verify that all commands are delivered to Subscribers by using the **Undistributed Commands** tab in Replication Monitor or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="9fbe2-191">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-191">Go to step b.</span></span>  
  
         <span data-ttu-id="9fbe2-192">ディストリビューション エージェントの実行方法の詳細については、「[レプリケーション エージェントを起動および停止する &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)」および「[レプリケーション エージェント実行可能ファイルの概念](../concepts/replication-agent-executables-concepts.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-192">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
         <span data-ttu-id="9fbe2-193">コマンドを確認する方法の詳細については、「[ディストリビューションデータベースのレプリケートされたコマンドおよびその他の情報を表示](../monitor/view-replicated-commands-and-information-in-distribution-database.md)する」を参照してください。レプリケーション transact-sql プログラミング&#41;および &#40;レプリケーション[モニターを使用して情報を表示し、タスクを実行](../monitor/view-information-and-perform-tasks-replication-monitor.md)します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-193">For more information about how to verify commands, see [View Replicated Commands and Other Information in the Distribution Database &#40;Replication Transact-SQL Programming&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md) and [View Information and Perform Tasks using Replication Monitor](../monitor/view-information-and-perform-tasks-replication-monitor.md).</span></span>  
  
    2.  <span data-ttu-id="9fbe2-194">[tablediff ユーティリティ](../../../tools/tablediff-utility.md) またはその他のツールを使用して、パブリッシャーとサブスクライバーを手動で同期します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-194">Use the [tablediff utility](../../../tools/tablediff-utility.md) or another tool to manually synchronize the Publisher with the Subscriber.</span></span> <span data-ttu-id="9fbe2-195">これにより、パブリケーション データベースのバックアップに含まれていなかったサブスクリプション データベースのデータを復旧できます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-195">This enables you to recover data from the subscription database that was not contained in the publication database backup.</span></span> <span data-ttu-id="9fbe2-196">手順 c. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-196">Go to step c.</span></span>  
  
         <span data-ttu-id="9fbe2-197">**tablediff** ユーティリティの詳細については、「[レプリケートされたテーブルを比較して相違があるかどうかを確認する &#40;レプリケーション プログラミング&#41;](compare-replicated-tables-for-differences-replication-programming.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-197">For more information about the **tablediff** utility, see [Compare Replicated Tables for Differences &#40;Replication Programming&#41;](compare-replicated-tables-for-differences-replication-programming.md).</span></span>  
  
    3.  <span data-ttu-id="9fbe2-198">復元されたバックアップは完全かつ最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-198">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="9fbe2-199">すべてのパブリケーションおよびサブスクリプションに対する最新の構成がこのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-199">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="9fbe2-200">答えが「はい」の場合は、 [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) ストアド プロシージャを実行して、パブリッシャーのメタデータをディストリビューターのメタデータと再同期します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-200">If yes, execute the [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) stored procedure to resynchronize the Publisher metadata with the Distributor metadata.</span></span> <span data-ttu-id="9fbe2-201">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-201">The restore is completed.</span></span> <span data-ttu-id="9fbe2-202">答えが「いいえ」の場合は、手順 d. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-202">If no, go to step d.</span></span>  
  
    4.  <span data-ttu-id="9fbe2-203">パブリッシャー、ディストリビューター、およびサブスクライバーで、レプリケーション構成を削除した後、再作成を行います。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-203">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="9fbe2-204">サブスクリプションを再作成するときには、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-204">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-205">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-205">The restore is completed.</span></span>  
  
         <span data-ttu-id="9fbe2-206">レプリケーションを削除する方法の詳細については、「[sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-206">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="9fbe2-207">サブスクライバーにデータが格納済みであることを指定する方法の詳細については、「 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-207">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
#### <a name="publication-database-transactional-replication-with-updating-subscriptions"></a><span data-ttu-id="9fbe2-208">パブリケーション データベース: 更新サブスクリプションを使用するトランザクション レプリケーション</span><span class="sxs-lookup"><span data-stu-id="9fbe2-208">Publication Database: Transactional Replication with Updating Subscriptions</span></span>  
  
1.  <span data-ttu-id="9fbe2-209">パブリケーション データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-209">Restore the latest backup of the publication database.</span></span> <span data-ttu-id="9fbe2-210">手順 2 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-210">Go to step 2.</span></span>  
  
2.  <span data-ttu-id="9fbe2-211">すべてのサブスクライバーがディストリビューション データベース内の未実行のコマンドと同期するまで、ディストリビューション エージェントを実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-211">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="9fbe2-212">レプリケーション モニターの **[未配布のコマンド]** タブを使用するか、またはディストリビューション データベース内の [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) ビューでクエリを実行して、すべてのコマンドがサブスクライバーに配信されたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-212">Verify that all commands are delivered to Subscribers by using the **Undistributed Commands** tab in Replication Monitor, or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="9fbe2-213">手順 3. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-213">Go to step 3.</span></span>  
  
     <span data-ttu-id="9fbe2-214">ディストリビューション エージェントの実行方法の詳細については、「[レプリケーション エージェントを起動および停止する &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)」および「[レプリケーション エージェント実行可能ファイルの概念](../concepts/replication-agent-executables-concepts.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-214">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
     <span data-ttu-id="9fbe2-215">コマンドを確認する方法の詳細については、「[ディストリビューションデータベースのレプリケートされたコマンドおよびその他の情報を表示](../monitor/view-replicated-commands-and-information-in-distribution-database.md)する」を参照してください。レプリケーション transact-sql プログラミング&#41;および &#40;レプリケーション[モニターを使用して情報を表示し、タスクを実行](../monitor/view-information-and-perform-tasks-replication-monitor.md)します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-215">For more information about how to verify commands, see [View Replicated Commands and Other Information in the Distribution Database &#40;Replication Transact-SQL Programming&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md) and [View Information and Perform Tasks using Replication Monitor](../monitor/view-information-and-perform-tasks-replication-monitor.md).</span></span>  
  
3.  <span data-ttu-id="9fbe2-216">キュー更新サブスクリプションを使用している場合は、各サブスクライバーに接続して、サブスクリプション データベースの [MSreplication_queue &#40;Transact-SQL&#41;](/sql/relational-databases/system-tables/msreplication-queue-transact-sql) テーブルからすべての行を削除します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-216">If you are using queued updating subscriptions, connect to each Subscriber and delete all rows from the [MSreplication_queue &#40;Transact-SQL&#41;](/sql/relational-databases/system-tables/msreplication-queue-transact-sql) table in the subscription database.</span></span> <span data-ttu-id="9fbe2-217">手順 4 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-217">Go to step 4.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="9fbe2-218">キュー更新サブスクリプションおよび ID 列を含むテーブルを使用している場合は、復元後に正しい ID 範囲が割り当てられていることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-218">If you are using queued updating subscriptions and any tables contain identity columns, you must make sure that the correct identity ranges are assigned after a restore.</span></span> <span data-ttu-id="9fbe2-219">詳細については、「[Replicate Identity Columns](../publish/replicate-identity-columns.md)」 (ID 列のレプリケート) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-219">For more information, see [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
4.  <span data-ttu-id="9fbe2-220">サブスクライバーで未実行のコマンドがすべてディストリビューション データベースに存在することを確認し、復元されたバックアップに含まれないすべてのトランザクションをパブリケーション データベースに手動で適用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-220">You must now make sure that Subscribers have all outstanding commands in the distribution database, and then manually apply to the publication database any transactions that are not included in the restored backup.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="9fbe2-221">この処理を実行することによって、復元対象のパブリッシュされたテーブルを、バックアップから復元されたパブリッシュされていないテーブルよりも新しい状態にすることができます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-221">Performing this process can cause published tables to be restored to a point in time that is more recent than the point in time of other nonpublished tables that are restored from the backup.</span></span>  
  
    1.  <span data-ttu-id="9fbe2-222">すべてのサブスクライバーがディストリビューション データベース内の未実行のコマンドと同期するまで、ディストリビューション エージェントを実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-222">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="9fbe2-223">レプリケーション モニターを使用するか、またはディストリビューション データベース内の [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) ビューでクエリを実行して、すべてのコマンドがサブスクライバーに配信されたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-223">Verify that all commands are delivered to Subscribers by using Replication Monitor or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="9fbe2-224">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-224">Go to step b.</span></span>  
  
    2.  <span data-ttu-id="9fbe2-225">[tablediff Utility](../../../tools/tablediff-utility.md) またはその他のツールを使用して、パブリッシャーとサブスクライバーを手動で同期します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-225">Use the [tablediff Utility](../../../tools/tablediff-utility.md) or another tool to manually synchronize the Publisher with the Subscriber.</span></span> <span data-ttu-id="9fbe2-226">これにより、パブリケーション データベースのバックアップに含まれていなかったサブスクリプション データベースのデータを復旧できます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-226">This enables you to recover data from the subscription database that was not contained in the publication database backup.</span></span> <span data-ttu-id="9fbe2-227">手順 c. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-227">Go to step c.</span></span>  
  
         <span data-ttu-id="9fbe2-228">**tablediff** ユーティリティの詳細については、「[レプリケートされたテーブルを比較して相違があるかどうかを確認する &#40;レプリケーション プログラミング&#41;](compare-replicated-tables-for-differences-replication-programming.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-228">For more information about the **tablediff** utility, see [Compare Replicated Tables for Differences &#40;Replication Programming&#41;](compare-replicated-tables-for-differences-replication-programming.md).</span></span>  
  
    3.  <span data-ttu-id="9fbe2-229">復元されたバックアップは完全かつ最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-229">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="9fbe2-230">すべてのパブリケーションおよびサブスクリプションに対する最新の構成がこのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-230">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="9fbe2-231">答えが「はい」の場合は、 [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) ストアド プロシージャを実行して、パブリッシャーのメタデータをディストリビューターのメタデータと再同期します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-231">If yes, execute the [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) stored procedure to resynchronize the Publisher metadata with the Distributor metadata.</span></span> <span data-ttu-id="9fbe2-232">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-232">The restore is completed.</span></span> <span data-ttu-id="9fbe2-233">答えが「いいえ」の場合は、手順 d. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-233">If no, go to step d.</span></span>  
  
    4.  <span data-ttu-id="9fbe2-234">パブリッシャー、ディストリビューター、およびサブスクライバーで、レプリケーション構成を削除した後、再作成を行います。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-234">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="9fbe2-235">サブスクリプションを再作成するときには、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-235">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-236">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-236">The restore is completed.</span></span>  
  
         <span data-ttu-id="9fbe2-237">レプリケーションを削除する方法の詳細については、「[sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-237">For more information about how to remove replication, see and [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="9fbe2-238">サブスクライバーにデータが格納済みであることを指定する方法の詳細については、「 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-238">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
#### <a name="publication-database-peer-to-peer-transactional-replication"></a><span data-ttu-id="9fbe2-239">パブリケーション データベース: @loopback_detection</span><span class="sxs-lookup"><span data-stu-id="9fbe2-239">Publication Database: Peer-to-Peer Transactional Replication</span></span>  
 <span data-ttu-id="9fbe2-240">以下の手順では、パブリケーション データベース **A**、 **B**、および **C** は、ピア ツー ピア トランザクション レプリケーション トポロジ内にあります。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-240">In the following steps, publication databases **A**, **B**, and **C** are in a peer-to-peer transactional replication topology.</span></span> <span data-ttu-id="9fbe2-241">データベース **A** およびデータベース **C** はオンラインで正常に動作しています。データベース **B** は復元対象のデータベースです。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-241">Databases **A** and **C** are online and functioning properly; database **B** is the database to be restored.</span></span> <span data-ttu-id="9fbe2-242">ここで説明する処理、特に手順 7、10、および 11 は、ピア ツー ピア トポロジにノードを追加するために必要な処理とよく似ています。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-242">The process described here, especially steps 7, 10, and 11, is very similar to the process required to add a node to a peer-to-peer topology.</span></span> <span data-ttu-id="9fbe2-243">これらの手順を最も簡単に実行する方法は、ピア ツー ピア トポロジ構成ウィザードを使用することです。ただし、ストアド プロシージャも使用できます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-243">The most straightforward way to perform these steps is to use the Configure Peer-to-Peer Topology Wizard, but you can also use stored procedures.</span></span>  
  
1.  <span data-ttu-id="9fbe2-244">ディストリビューション エージェントを実行して、データベース **A** およびデータベース **C** のサブスクリプションを同期します。手順 2 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-244">Run the Distribution Agents to synchronize the subscriptions at databases **A** and **C**. Go to step 2.</span></span>  
  
     <span data-ttu-id="9fbe2-245">ディストリビューション エージェントの実行方法の詳細については、「[レプリケーション エージェントを起動および停止する &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)」および「[レプリケーション エージェント実行可能ファイルの概念](../concepts/replication-agent-executables-concepts.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-245">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
2.  <span data-ttu-id="9fbe2-246">**B** が使用するディストリビューション データベースがまだ利用可能な場合は、ディストリビューション エージェントを実行して、データベース **B** とデータベース **A** の間のサブスクリプション、およびデータベース B とデータベース **C** の間のサブスクリプションを同期します。手順 3. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-246">If the distribution database that **B** uses is still available, run Distribution Agents to synchronize subscriptions between databases **B** and **A** and databases and B and **C**. Go to step 3.</span></span>  
  
3.  <span data-ttu-id="9fbe2-247">**B** のディストリビューション データベースで [sp_removedistpublisherdbreplication](/sql/relational-databases/system-stored-procedures/sp-removedistpublisherdbreplication-transact-sql) を実行して、**B** が使用するディストリビューション データベースからメタデータを削除します。手順 4 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-247">Remove metadata from the distribution database that **B** uses by executing [sp_removedistpublisherdbreplication](/sql/relational-databases/system-stored-procedures/sp-removedistpublisherdbreplication-transact-sql) at the distribution database for **B**. Go to step 4.</span></span>  
  
4.  <span data-ttu-id="9fbe2-248">データベース **A** およびデータベース **C** で、データベース **B** のパブリケーションに対するサブスクリプションを削除します。手順 5 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-248">At databases **A** and **C**, drop the subscriptions to the publication at database **B**. Go to step 5.</span></span>  
  
     <span data-ttu-id="9fbe2-249">サブスクリプションを削除する方法の詳細については、「 [Subscribe to Publications](../subscribe-to-publications.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-249">For more information about how to drop subscriptions, see [Subscribe to Publications](../subscribe-to-publications.md).</span></span>  
  
5.  <span data-ttu-id="9fbe2-250">データベース **A** のログ バックアップまたは完全バックアップを実行します。手順 6 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-250">Perform a log backup or full backup of database **A**. Go to step 6.</span></span>  
  
6.  <span data-ttu-id="9fbe2-251">データベース **A** のバックアップをデータベース **B** で復元します。この場合、データベース **B** にはデータベース **A** のデータが格納されますが、レプリケーション構成は含まれません。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-251">Restore the backup of database **A** at database **B**. Database **B** now has the data from database **A**, but not the replication configuration.</span></span> <span data-ttu-id="9fbe2-252">バックアップを別のサーバーに復元すると、レプリケーションは削除されます。データベース **B** からレプリケーションが削除されたのはそのためです。既に</span><span class="sxs-lookup"><span data-stu-id="9fbe2-252">When you restore a backup to another server, replication is removed; therefore, replication has been removed from database **B**. Go to step 7.</span></span>  
  
7.  <span data-ttu-id="9fbe2-253">データベース **B** でパブリケーションを再作成し、その後にデータベース **A** とデータベース **B** の間のサブスクリプションを再作成します (データベース **C** 関連のサブスクリプションについては後の段階で処理します)。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-253">Re-create the publication at database **B**, and then re-create subscriptions between databases **A** and **B**. (Subscriptions that involve database **C** are handled at a later stage.).</span></span>  
  
    1.  <span data-ttu-id="9fbe2-254">データベース **B** でパブリケーションを再作成します。手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-254">Re-create the publication at database **B**. Go to step b.</span></span>  
  
    2.  <span data-ttu-id="9fbe2-255">データベース**B**のパブリケーションに対するサブスクリプションをデータベース**a**で再作成します。このとき、バックアップを使用してサブスクリプションを初期化するように指定します (sp_addsubscription のパラメーターの値を**initialize with backup**に設定し **@sync_type** [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)ます)。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-255">Re-create the subscription at database **B** to the publication at database **A**, specifying that the subscription should be initialized with a backup (a value of **initialize with backup** for the **@sync_type** parameter of [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)).</span></span> <span data-ttu-id="9fbe2-256">手順 c. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-256">Go to step c.</span></span>  
  
    3.  <span data-ttu-id="9fbe2-257">データベース**B**のパブリケーションに対するサブスクリプションをデータベース**a**で再作成します。このとき、サブスクライバーにデータが既にあることを指定します (sp_addsubscription のパラメーターに対して**のみ、レプリケーションサポート**の値です **@sync_type** )。 [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-257">Re-create the subscription at database **A** to the publication at database **B**, specifying that the Subscriber already has the data (a value of **replication support only** for the **@sync_type** parameter of [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)).</span></span> <span data-ttu-id="9fbe2-258">手順 8 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-258">Go to step 8.</span></span>  
  
8.  <span data-ttu-id="9fbe2-259">ディストリビューション エージェントを実行して、データベース **A** およびデータベース **B** のサブスクリプションを同期します。パブリッシュされたテーブルに ID 列がある場合は、手順 9. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-259">Run the Distribution Agents to synchronize the subscriptions at databases **A** and **B**. If there are any identity columns in published tables, go to step 9.</span></span> <span data-ttu-id="9fbe2-260">それ以外の場合は、手順 10 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-260">If not, go to step 10.</span></span>  
  
9. <span data-ttu-id="9fbe2-261">復元後、データベース **A** の各テーブルに割り当てた ID 範囲は、データベース **B** でも使用されます。データベース **B** の障害発生後、データベース **A** およびデータベース **C** に反映されたすべての変更を復元されたデータベース **B** に適用し、その後、各テーブルの ID 範囲を再作成します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-261">After the restore, the identity range that you assigned for each table in database **A** would also be used in database **B**. Make sure that the restored database **B** has received all changes from the failed database **B** that were propagated to database **A** and database **C**; and then reseed the identity range for each table.</span></span>  
  
    1.  <span data-ttu-id="9fbe2-262">データベース**B**で[sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql)を実行し、出力パラメーターを取得し **@request_id** ます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-262">Execute [sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql) at database **B** and retrieve the output parameter **@request_id**.</span></span> <span data-ttu-id="9fbe2-263">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-263">Go to step b.</span></span>  
  
    2.  <span data-ttu-id="9fbe2-264">既定では、ディストリビューション エージェントが連続的に実行されるように設定されているため、すべてのノードに自動的にトークンが送信されます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-264">By default, the Distribution Agent is set to run continuously; therefore, tokens should be sent to all nodes automatically.</span></span> <span data-ttu-id="9fbe2-265">ディストリビューション エージェントが連続モードで実行されていない場合は、エージェントを実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-265">If the Distribution Agent is not running in continuous mode, run the agent.</span></span> <span data-ttu-id="9fbe2-266">詳細については、「[レプリケーション エージェント実行可能ファイルの概念](../concepts/replication-agent-executables-concepts.md)」または「[レプリケーション エージェントを起動および停止する &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-266">For more information, see [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md) or [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span> <span data-ttu-id="9fbe2-267">手順 c. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-267">Go to step c.</span></span>  
  
    3.  <span data-ttu-id="9fbe2-268">手順 b で取得した値を指定して[sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql)を実行し **@request_id** ます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-268">Execute [sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql), providing the **@request_id** value retrieved in step b.</span></span> <span data-ttu-id="9fbe2-269">すべてのノードがピア要求を受信するまで待機します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-269">Wait until all nodes indicate they have received the peer request.</span></span> <span data-ttu-id="9fbe2-270">手順 d. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-270">Go to step d.</span></span>  
  
    4.  <span data-ttu-id="9fbe2-271">[DBCC CHECKIDENT](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) を使用してデータベース **B** の各テーブルを再作成し、適切な範囲が使用されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-271">Use [DBCC CHECKIDENT](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) to reseed each table in database **B** to make sure that an appropriate range is used.</span></span> <span data-ttu-id="9fbe2-272">手順 10 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-272">Go to step 10.</span></span>  
  
     <span data-ttu-id="9fbe2-273">ID 範囲を管理する方法の詳細については、「[ID 列のレプリケート](../publish/replicate-identity-columns.md)」の「手動で ID 範囲を管理する場合の範囲の割り当て」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-273">For more information about how to manage identity ranges, see the "Assigning ranges for manual identity range management" section of [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
10. <span data-ttu-id="9fbe2-274">この時点では、データベース **B** とデータベース **C** は直接接続されていませんが、両者はデータベース **A** を介して変更を受信します。[!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] を実行しているノードがトポロジに含まれている場合は手順 11. に進み、それ以外の場合は手順 12. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-274">At this point, database **B** and database **C** are not directly connected, but they will receive changes through database **A**. If the topology contains any nodes that are running [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], go to step 11; otherwise, go to step 12.</span></span>  
  
11. <span data-ttu-id="9fbe2-275">システムを停止し、データベース **B** とデータベース **C** の間のサブスクリプションを再作成します。システムを停止するときには、パブリッシュされたテーブルの利用をすべてのノードで停止し、各ノードが他のすべてのノードの変更を受け取っていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-275">Quiesce the system, and then re-create the subscription between databases **B** and **C**. Quiescing a system involves stopping activity on published tables at all nodes and making sure of that each node has received all changes from all other nodes.</span></span>  
  
    1.  <span data-ttu-id="9fbe2-276">ピア ツー ピア トポロジ内のパブリッシュされたテーブルの処理をすべて停止します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-276">Stop all activity on published tables in the peer-to-peer topology.</span></span> <span data-ttu-id="9fbe2-277">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-277">Go to step b.</span></span>  
  
    2.  <span data-ttu-id="9fbe2-278">データベース**B**で[sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql)を実行し、出力パラメーターを取得し **@request_id** ます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-278">Execute [sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql) at database **B** and retrieve the output parameter **@request_id**.</span></span> <span data-ttu-id="9fbe2-279">手順 c. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-279">Go to step c.</span></span>  
  
    3.  <span data-ttu-id="9fbe2-280">既定では、ディストリビューション エージェントが連続的に実行されるように設定されているため、すべてのノードに自動的にトークンが送信されます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-280">By default, the Distribution Agent is set to run continuously; therefore, tokens should be sent to all nodes automatically.</span></span> <span data-ttu-id="9fbe2-281">ディストリビューション エージェントが連続モードで実行されていない場合は、エージェントを実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-281">If the Distribution Agent is not running in continuous mode, run the agent.</span></span> <span data-ttu-id="9fbe2-282">手順 d. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-282">Go to step d.</span></span>  
  
    4.  <span data-ttu-id="9fbe2-283">手順 b で取得した値を指定して[sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql)を実行し **@request_id** ます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-283">Execute [sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql), providing the **@request_id** value retrieved in step b.</span></span> <span data-ttu-id="9fbe2-284">すべてのノードがピア要求を受信するまで待機します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-284">Wait until all nodes indicate they have received the peer request.</span></span> <span data-ttu-id="9fbe2-285">手順 e. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-285">Go to step e.</span></span>  
  
    5.  <span data-ttu-id="9fbe2-286">データベース **C** のパブリケーションに対するサブスクリプションをデータベース **B**で再作成します。その際に、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-286">Re-create the subscription at database **B** to the publication at database **C**, specifying that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-287">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-287">Go to step b.</span></span>  
  
    6.  <span data-ttu-id="9fbe2-288">データベース **B** のパブリケーションに対するサブスクリプションをデータベース **C**で再作成します。その際に、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-288">Re-create the subscription at database **C** to the publication at database **B**, specifying that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-289">手順 13 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-289">Go to step 13.</span></span>  
  
12. <span data-ttu-id="9fbe2-290">データベース **B** とデータベース **C**の間のサブスクリプションを再作成します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-290">Re-create the subscription between databases **B** and **C**:</span></span>  
  
    1.  <span data-ttu-id="9fbe2-291">データベース **B**で [MSpeer_lsns](/sql/relational-databases/system-tables/mspeer-lsns-transact-sql) テーブルにクエリを実行して、データベース **B** がデータベース **C**から受信した最新のトランザクションのログ シーケンス番号 (LSN) を取得します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-291">At database **B**, query the [MSpeer_lsns](/sql/relational-databases/system-tables/mspeer-lsns-transact-sql) table to retrieve the log sequence number (LSN) of the most recent transaction that database **B** has received from database **C**.</span></span>  
  
    2.  <span data-ttu-id="9fbe2-292">データベース**C**のパブリケーションに対するサブスクリプションをデータベース**B**で再作成します。その際、lsn に基づいてサブスクリプションを初期化するように指定します (sp_addsubscription のパラメーターには**initialize from lsn**の値を指定し **@sync_type** [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)ます)。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-292">Re-create the subscription at database **B** to the publication at database **C**, specifying that the subscription should be initialized based on LSN (a value of **initialize from lsn** for the **@sync_type** parameter of [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)).</span></span> <span data-ttu-id="9fbe2-293">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-293">Go to step b.</span></span>  
  
    3.  <span data-ttu-id="9fbe2-294">データベース **B** のパブリケーションに対するサブスクリプションをデータベース **C**で再作成します。その際に、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-294">Re-create the subscription at database **C** to the publication at database **B**, specifying that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-295">手順 13 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-295">Go to step 13.</span></span>  
  
13. <span data-ttu-id="9fbe2-296">ディストリビューション エージェントを実行して、データベース **B** およびデータベース **C** のサブスクリプションを同期します。復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-296">Run the Distribution Agents to synchronize the subscriptions at databases **B** and **C**. The restore is completed.</span></span>  
  
#### <a name="msdb-database-publisher"></a><span data-ttu-id="9fbe2-297">msdb データベース (パブリッシャー)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-297">msdb Database (Publisher)</span></span>  
  
1.  <span data-ttu-id="9fbe2-298">**msdb** データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-298">Restore the latest backup of the **msdb** database.</span></span>  
  
2.  <span data-ttu-id="9fbe2-299">復元されたバックアップは完全かつ最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-299">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="9fbe2-300">すべてのパブリケーションおよびサブスクリプションに対する最新の構成がこのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-300">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="9fbe2-301">答えが「はい」の場合、復元は完了です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-301">If yes, recovery is completed.</span></span> <span data-ttu-id="9fbe2-302">「いいえ」の場合は、手順 3. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-302">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="9fbe2-303">レプリケーション スクリプトを使用して、サブスクリプションのクリーンアップ ジョブを再作成します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-303">Re-create the subscription cleanup job from your replication scripts.</span></span> <span data-ttu-id="9fbe2-304">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-304">Recovery is completed.</span></span>  
  
#### <a name="master-database-publisher"></a><span data-ttu-id="9fbe2-305">master データベース (パブリッシャー)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-305">master Database (Publisher)</span></span>  
  
1.  <span data-ttu-id="9fbe2-306">**master** データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-306">Restore the latest backup of the **master** database.</span></span>  
  
2.  <span data-ttu-id="9fbe2-307">データベースのレプリケーション構成および設定が、パブリケーション データベースと一致していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-307">Make sure that the database is consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
### <a name="databases-at-the-distributor"></a><span data-ttu-id="9fbe2-308">ディストリビューターにあるデータベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-308">Databases at the Distributor</span></span>  
  
#### <a name="distribution-database"></a><span data-ttu-id="9fbe2-309">ディストリビューション データベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-309">Distribution Database</span></span>  
  
1.  <span data-ttu-id="9fbe2-310">ディストリビューション データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-310">Restore the latest backup of the distribution database.</span></span>  
  
2.  <span data-ttu-id="9fbe2-311">障害の発生前に、ディストリビューション データベースで " **sync with backup** " 設定が有効になっていましたか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-311">Was the **sync with backup** setting enabled on the distribution database before the failure?</span></span> <span data-ttu-id="9fbe2-312">答えが「はい」の場合は、手順 3. に進みます。「いいえ」の場合は、手順 4. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-312">If yes, go to step 3; if no, go to step 4.</span></span>  
  
     <span data-ttu-id="9fbe2-313">設定が有効の場合、 `SELECT DATABASEPROPERTYEX('<DistributionDatabaseName>', 'IsSyncWithBackup')` クエリが "1" を返します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-313">If the setting is enabled, the query `SELECT DATABASEPROPERTYEX('<DistributionDatabaseName>', 'IsSyncWithBackup')` returns '1'.</span></span>  
  
3.  <span data-ttu-id="9fbe2-314">復元されたバックアップは完全かつ最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-314">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="9fbe2-315">すべてのパブリケーションおよびサブスクリプションに対する最新の構成がこのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-315">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="9fbe2-316">答えが「はい」の場合、復元は完了です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-316">If yes, recovery is completed.</span></span> <span data-ttu-id="9fbe2-317">「いいえ」の場合は、手順 4 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-317">If no, go to step 4.</span></span>  
  
4.  <span data-ttu-id="9fbe2-318">復元されたディストリビューション データベースの構成情報が最新でないか、またはディストリビューション データベースで " **sync with backup** " オプションが設定されていませんでした</span><span class="sxs-lookup"><span data-stu-id="9fbe2-318">Either the configuration information in the restored distribution database is not up-to-date, or the **sync with backup** option was not set on the distribution database.</span></span> <span data-ttu-id="9fbe2-319">(復元後に、パブリッシャーでコミットされた後にサブスクライバーに配信されていないトランザクションは、ディストリビューション データベースで見つからない可能性があります)。レプリケーションの削除および再作成を行ってから検証を実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-319">(After the restore, the distribution database might be missing transactions that were committed at the Publisher but have not yet been delivered to Subscribers.) Drop and re-create replication, and then run validation.</span></span>  
  
    1.  <span data-ttu-id="9fbe2-320">パブリッシャー、ディストリビューター、およびサブスクライバーで、レプリケーション構成を削除した後、再作成を行います。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-320">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="9fbe2-321">サブスクリプションを再作成するときには、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-321">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-322">手順 b. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-322">Go to step b.</span></span>  
  
         <span data-ttu-id="9fbe2-323">レプリケーションを削除する方法の詳細については、「[sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-323">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="9fbe2-324">サブスクライバーにデータが格納済みであることを指定する方法の詳細については、「 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-324">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
    2.  <span data-ttu-id="9fbe2-325">検証を行うすべてのパブリケーションにマークを付けます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-325">Mark all publications for validation.</span></span> <span data-ttu-id="9fbe2-326">検証に失敗したサブスクリプションを再初期化します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-326">Reinitialize any subscriptions that fail validation.</span></span> <span data-ttu-id="9fbe2-327">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-327">Recovery is completed.</span></span>  
  
         <span data-ttu-id="9fbe2-328">検証の詳細については、「 [Validate Replicated Data](../validate-data-at-the-subscriber.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-328">For more information about validation, see [Validate Replicated Data](../validate-data-at-the-subscriber.md).</span></span> <span data-ttu-id="9fbe2-329">再初期化の詳細については、「[サブスクリプションの再初期化](../reinitialize-subscriptions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-329">For more information about reinitialization, see [Reinitialize Subscriptions](../reinitialize-subscriptions.md).</span></span>  
  
#### <a name="msdb-database-distributor"></a><span data-ttu-id="9fbe2-330">msdb データベース (ディストリビューター)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-330">msdb Database (Distributor)</span></span>  
  
1.  <span data-ttu-id="9fbe2-331">**msdb** データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-331">Restore the latest backup of the **msdb** database.</span></span>  
  
2.  <span data-ttu-id="9fbe2-332">復元されたバックアップは完全かつ最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-332">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="9fbe2-333">すべてのパブリケーションおよびサブスクリプションに対する最新の構成がこのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-333">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="9fbe2-334">答えが「はい」の場合、復元は完了です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-334">If yes, recovery is completed.</span></span> <span data-ttu-id="9fbe2-335">「いいえ」の場合は、手順 3. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-335">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="9fbe2-336">パブリッシャー、ディストリビューター、およびサブスクライバーで、レプリケーション構成を削除した後、再作成を行います。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-336">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="9fbe2-337">サブスクリプションを再作成するときには、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-337">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-338">手順 4 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-338">Go to step 4.</span></span>  
  
     <span data-ttu-id="9fbe2-339">レプリケーションを削除する方法の詳細については、「[sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-339">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
     <span data-ttu-id="9fbe2-340">サブスクライバーにデータが格納済みであることを指定する方法の詳細については、「 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-340">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
4.  <span data-ttu-id="9fbe2-341">検証を行うすべてのパブリケーションにマークを付けます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-341">Mark all publications for validation.</span></span> <span data-ttu-id="9fbe2-342">検証に失敗したサブスクリプションを再初期化します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-342">Reinitialize any subscriptions that fail validation.</span></span> <span data-ttu-id="9fbe2-343">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-343">Recovery is completed.</span></span>  
  
     <span data-ttu-id="9fbe2-344">検証の詳細については、「 [Validate Replicated Data](../validate-data-at-the-subscriber.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-344">For more information about validation, see [Validate Replicated Data](../validate-data-at-the-subscriber.md).</span></span> <span data-ttu-id="9fbe2-345">再初期化の詳細については、「[サブスクリプションの再初期化](../reinitialize-subscriptions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-345">For more information about reinitialization, see [Reinitialize Subscriptions](../reinitialize-subscriptions.md).</span></span>  
  
#### <a name="master-database-distributor"></a><span data-ttu-id="9fbe2-346">master データベース (ディストリビューター)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-346">master Database (Distributor)</span></span>  
  
1.  <span data-ttu-id="9fbe2-347">**master** データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-347">Restore the latest backup of the **master** database.</span></span>  
  
2.  <span data-ttu-id="9fbe2-348">データベースのレプリケーション構成および設定が、パブリケーション データベースと一致していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-348">Make sure that the database is consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
### <a name="databases-at-the-subscriber"></a><span data-ttu-id="9fbe2-349">サブスクライバーにあるデータベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-349">Databases at the Subscriber</span></span>  
  
#### <a name="subscription-database"></a><span data-ttu-id="9fbe2-350">サブスクリプション データベース</span><span class="sxs-lookup"><span data-stu-id="9fbe2-350">Subscription Database</span></span>  
  
1.  <span data-ttu-id="9fbe2-351">サブスクリプション データベースの最新バックアップは、ディストリビューション データベースにおけるディストリビューションの最小保有期間の設定よりも新しいですか</span><span class="sxs-lookup"><span data-stu-id="9fbe2-351">Is the latest subscription database backup more recent than the minimum distribution retention setting on the distribution database?</span></span> <span data-ttu-id="9fbe2-352">(これにより、サブスクライバーを最新状態にするために必要なすべてのコマンドがディストリビューターに存在しているかどうかを判断できます)。答えが「はい」の場合は、手順 2. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-352">(This determines whether the Distributor still has all the commands that are required to bring the Subscriber up-to-date.) If yes, go to step 2.</span></span> <span data-ttu-id="9fbe2-353">「いいえ」の場合は、サブスクリプションを再初期化します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-353">If no, reinitialize the subscription.</span></span> <span data-ttu-id="9fbe2-354">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-354">Recovery is completed.</span></span>  
  
     <span data-ttu-id="9fbe2-355">ディストリビューションの最大保有期間を確認するには、 [sp_helpdistributiondb](/sql/relational-databases/system-stored-procedures/sp-helpdistributiondb-transact-sql) を実行し、 **max_distretention** 列から値 (時間単位) を取得します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-355">To determine the maximum distribution retention setting, execute [sp_helpdistributiondb](/sql/relational-databases/system-stored-procedures/sp-helpdistributiondb-transact-sql) and retrieve the value from the **max_distretention** column (this value is in hours).</span></span>  
  
     <span data-ttu-id="9fbe2-356">サブスクリプションを再初期化する方法の詳細については、「 [Reinitialize a Subscription](../reinitialize-a-subscription.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-356">For more information about how to reinitialize a subscription, see [Reinitialize a Subscription](../reinitialize-a-subscription.md).</span></span>  
  
2.  <span data-ttu-id="9fbe2-357">サブスクリプション データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-357">Restore the latest subscription database backup.</span></span> <span data-ttu-id="9fbe2-358">手順 3. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-358">Go to step 3.</span></span>  
  
3.  <span data-ttu-id="9fbe2-359">サブスクリプション データベースにプッシュ サブスクリプションのみが含まれている場合は、手順 4. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-359">If the subscription database contains only push subscriptions, go to step 4.</span></span> <span data-ttu-id="9fbe2-360">サブスクリプション データベースにプル サブスクリプションが含まれている場合は、次の質問に答えてください。サブスクリプション情報は最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-360">If the subscription database contains any pull subscriptions, ask the following questions: Is the subscription information current?</span></span> <span data-ttu-id="9fbe2-361">障害発生時に設定されていたすべてのテーブルおよびオプションがデータベースに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-361">Does the database include all tables and options that were set at the time of failure.</span></span> <span data-ttu-id="9fbe2-362">「はい」の場合は、手順 4 に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-362">If yes, go to step 4.</span></span> <span data-ttu-id="9fbe2-363">「いいえ」の場合は、サブスクリプションを再初期化します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-363">If no, reinitialize the subscription.</span></span> <span data-ttu-id="9fbe2-364">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-364">Recovery is completed.</span></span>  
  
4.  <span data-ttu-id="9fbe2-365">サブスクライバーを同期するには、ディストリビューション エージェントを実行します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-365">To synchronize the Subscriber, run the Distribution Agent.</span></span> <span data-ttu-id="9fbe2-366">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-366">Recovery is completed.</span></span>  
  
     <span data-ttu-id="9fbe2-367">ディストリビューション エージェントの実行方法の詳細については、「[レプリケーション エージェントを起動および停止する &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)」および「[レプリケーション エージェント実行可能ファイルの概念](../concepts/replication-agent-executables-concepts.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-367">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
#### <a name="msdb-database-subscriber"></a><span data-ttu-id="9fbe2-368">msdb データベース (サブスクライバー)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-368">msdb Database (Subscriber)</span></span>  
  
1.  <span data-ttu-id="9fbe2-369">**msdb** データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-369">Restore the latest backup of the **msdb** database.</span></span> <span data-ttu-id="9fbe2-370">このサブスクライバーでプル サブスクリプションが使用されていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-370">Are pull subscriptions used at this Subscriber?</span></span> <span data-ttu-id="9fbe2-371">答えが「いいえ」の場合、復元は完了です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-371">If no, the restore is completed.</span></span> <span data-ttu-id="9fbe2-372">答えが「はい」の場合は、手順 2. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-372">If yes, go to step 2.</span></span>  
  
2.  <span data-ttu-id="9fbe2-373">復元されたバックアップは完全かつ最新ですか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-373">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="9fbe2-374">すべてのプル サブスクリプションに対する最新の構成がこのバックアップに含まれていますか。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-374">Does it contain the latest configuration for all pull subscriptions?</span></span> <span data-ttu-id="9fbe2-375">答えが「はい」の場合、復元は完了です。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-375">If yes, recovery is completed.</span></span> <span data-ttu-id="9fbe2-376">「いいえ」の場合は、手順 3. に進みます。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-376">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="9fbe2-377">プル サブスクリプションの削除および再作成を行います。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-377">Drop and re-create the pull subscriptions.</span></span> <span data-ttu-id="9fbe2-378">サブスクリプションを再作成するときには、サブスクライバーにデータが格納済みであることを指定します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-378">When you re-create the subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="9fbe2-379">復元が完了します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-379">The restore is completed.</span></span>  
  
     <span data-ttu-id="9fbe2-380">サブスクリプションを削除する方法の詳細については、「 [Subscribe to Publications](../subscribe-to-publications.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-380">For more information about how to drop subscriptions, see [Subscribe to Publications](../subscribe-to-publications.md).</span></span>  
  
     <span data-ttu-id="9fbe2-381">サブスクライバーにデータが格納済みであることを指定する方法の詳細については、「 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-381">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
#### <a name="master-database-subscriber"></a><span data-ttu-id="9fbe2-382">master データベース (サブスクライバー)</span><span class="sxs-lookup"><span data-stu-id="9fbe2-382">master Database (Subscriber)</span></span>  
  
1.  <span data-ttu-id="9fbe2-383">**master** データベースの最新バックアップを復元します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-383">Restore the latest backup of the **master** database.</span></span>  
  
2.  <span data-ttu-id="9fbe2-384">データベースのレプリケーション構成および設定が、パブリケーション データベースと一致していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="9fbe2-384">Make sure that the database is consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="9fbe2-385">参照</span><span class="sxs-lookup"><span data-stu-id="9fbe2-385">See Also</span></span>  
 <span data-ttu-id="9fbe2-386">[SQL Server データベースのバックアップと復元](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="9fbe2-386">[Back Up and Restore of SQL Server Databases](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span></span>  
 <span data-ttu-id="9fbe2-387">[レプリケートされたデータベースのバックアップと復元](back-up-and-restore-replicated-databases.md) </span><span class="sxs-lookup"><span data-stu-id="9fbe2-387">[Back Up and Restore Replicated Databases](back-up-and-restore-replicated-databases.md) </span></span>  
 <span data-ttu-id="9fbe2-388">[[ディストリビューションの構成]](../configure-distribution.md) </span><span class="sxs-lookup"><span data-stu-id="9fbe2-388">[Configure Distribution](../configure-distribution.md) </span></span>  
 <span data-ttu-id="9fbe2-389">[データとデータベース オブジェクトのパブリッシュ](../publish/publish-data-and-database-objects.md) </span><span class="sxs-lookup"><span data-stu-id="9fbe2-389">[Publish Data and Database Objects](../publish/publish-data-and-database-objects.md) </span></span>  
 <span data-ttu-id="9fbe2-390">[Subscribe to Publications](../subscribe-to-publications.md) </span><span class="sxs-lookup"><span data-stu-id="9fbe2-390">[Subscribe to Publications](../subscribe-to-publications.md) </span></span>  
 <span data-ttu-id="9fbe2-391">[サブスクリプションの初期化](../initialize-a-subscription.md) </span><span class="sxs-lookup"><span data-stu-id="9fbe2-391">[Initialize a Subscription](../initialize-a-subscription.md) </span></span>  
 [<span data-ttu-id="9fbe2-392">データの同期</span><span class="sxs-lookup"><span data-stu-id="9fbe2-392">Synchronize Data</span></span>](../synchronize-data.md)  
  
  
