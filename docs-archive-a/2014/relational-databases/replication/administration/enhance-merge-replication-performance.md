---
title: マージ レプリケーション パフォーマンスの向上 | Microsoft Docs
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publications [SQL Server replication], design and performance
- designing databases [SQL Server], replication performance
- Merge Agent, performance
- snapshots [SQL Server replication], performance considerations
- merge replication performance [SQL Server replication]
- subscriptions [SQL Server replication], performance considerations
- performance [SQL Server replication], merge replication
- agents [SQL Server replication], performance
ms.assetid: f929226f-b83d-4900-a07c-a62f64527c7f
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 41dc258e9b45e9839ad142e73cb145999d02986c
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87741881"
---
# <a name="enhance-merge-replication-performance"></a><span data-ttu-id="9a813-102">マージ レプリケーション パフォーマンスの向上</span><span class="sxs-lookup"><span data-stu-id="9a813-102">Enhance Merge Replication Performance</span></span>
  <span data-ttu-id="9a813-103">「 [レプリケーションの全般的パフォーマンスの向上](enhance-general-replication-performance.md)」で説明した全般的なパフォーマンスのヒントを検討した後、マージ レプリケーションに固有なこれらの項目を併せて検討してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-103">After considering the general performance tips described in [Enhancing General Replication Performance](enhance-general-replication-performance.md), consider these additional areas specific to merge replication.</span></span>  
  
## <a name="database-design"></a><span data-ttu-id="9a813-104">データベースの設計</span><span class="sxs-lookup"><span data-stu-id="9a813-104">Database Design</span></span>  
  
-   <span data-ttu-id="9a813-105">行フィルターおよび結合フィルター内で使用される列にインデックスを作成する。</span><span class="sxs-lookup"><span data-stu-id="9a813-105">Index columns used in row filters and join filters.</span></span>  
  
     <span data-ttu-id="9a813-106">パブリッシュされたアーティクルに行フィルターを使用する際には、フィルターの WHERE 句で使用する各列にインデックスを作成します。</span><span class="sxs-lookup"><span data-stu-id="9a813-106">When you use a row filter on a published article, create an index on each of the columns that is used in the filter's WHERE clause.</span></span> <span data-ttu-id="9a813-107">インデックスがない場合、[!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] は、行をパーティション内に含めるかどうかを決定するためにテーブル内の各行を読み取る必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-107">Without an index, [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] has to read each row in the table to determine whether the row should be included in the partition.</span></span> <span data-ttu-id="9a813-108">インデックスがあると、 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] は、含める行をすばやく見つけられます。</span><span class="sxs-lookup"><span data-stu-id="9a813-108">With an index, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] can quickly locate which rows should be included.</span></span> <span data-ttu-id="9a813-109">レプリケーションがインデックスのみを基にフィルターの WHERE 句を完全に解決できる場合、最高の処理速度になります。</span><span class="sxs-lookup"><span data-stu-id="9a813-109">The fastest processing takes place if replication can fully resolve the WHERE clause of the filter from the index alone.</span></span>  
  
     <span data-ttu-id="9a813-110">また、結合フィルターで使用するすべての列に対してもインデックスを作成することが重要です。</span><span class="sxs-lookup"><span data-stu-id="9a813-110">Indexing all the columns used in join filters is also important.</span></span> <span data-ttu-id="9a813-111">マージ エージェントは、実行時にベース テーブルを検索して、パーティションに含める親テーブルの行と関連テーブルの行を判断します。</span><span class="sxs-lookup"><span data-stu-id="9a813-111">Each time the Merge Agent runs, it searches the base table to determine which rows in a parent table and which rows in related tables are included in a partition.</span></span> <span data-ttu-id="9a813-112">結合された列のインデックスを作成すれば、マージ エージェントを実行するたびに [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] がテーブルの各行を読み取る必要はなくなります。</span><span class="sxs-lookup"><span data-stu-id="9a813-112">Creating an index on the joined columns avoids having [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] read each row in the table every time the Merge Agent runs.</span></span>  
  
     <span data-ttu-id="9a813-113">フィルター選択の詳細については、「[マージ レプリケーション用にパブリッシュされたデータのフィルター選択](../merge/filter-published-data-for-merge-replication.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-113">For more information on filtering, see [Filter Published Data for Merge Replication](../merge/filter-published-data-for-merge-replication.md).</span></span>  
  
-   <span data-ttu-id="9a813-114">Large Object (LOB) データ型を含むテーブルで、正規化を十分に行うことを検討する。</span><span class="sxs-lookup"><span data-stu-id="9a813-114">Consider overnormalizing tables that include Large Object (LOB) data types.</span></span>  
  
     <span data-ttu-id="9a813-115">同期が発生するとき、マージ エージェントはパブリッシャーまたはサブスクライバーからすべての行を読み取って転送する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-115">When synchronization occurs, the Merge Agent might need to read and transfer the entire data row from a Publisher or Subscriber.</span></span> <span data-ttu-id="9a813-116">行に LOB を使用する列が含まれている場合、この処理には追加のメモリ割り当てが必要となることがあり、これらの列が更新されていない場合でもパフォーマンスを低下させる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-116">If the row contains columns that use LOBs, this process can require additional memory allocation and negatively impact performance even though these columns may not have been updated.</span></span> <span data-ttu-id="9a813-117">このようなパフォーマンス低下が発生する可能性を減らすには、LOB 列を別のテーブルに置き、残りの行データとの一対一リレーションシップを使用することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-117">To reduce the likelihood that this performance impact occurs, consider putting LOB columns in a separate table using a one-to-one relationship to the rest of the row data.</span></span> <span data-ttu-id="9a813-118">`text`、`ntext`、および `image` の各データ型は非推奨です。</span><span class="sxs-lookup"><span data-stu-id="9a813-118">The data types `text`, `ntext`, and `image` are deprecated.</span></span> <span data-ttu-id="9a813-119">LOB が必要な場合は、`varchar(max)`、`nvarchar(max)`、および `varbinary(max)` の各データ型を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9a813-119">If you do include LOBs, we recommend that you use the data types `varchar(max)`, `nvarchar(max)`, `varbinary(max)`, respectively.</span></span>  
  
## <a name="publication-design"></a><span data-ttu-id="9a813-120">パブリケーションの設計</span><span class="sxs-lookup"><span data-stu-id="9a813-120">Publication Design</span></span>  
  
-   <span data-ttu-id="9a813-121">90RTM ([!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 以降のバージョン) のパブリケーション互換性レベルを使用する。</span><span class="sxs-lookup"><span data-stu-id="9a813-121">Use a publication compatibility level of 90RTM ([!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version).</span></span>  
  
     <span data-ttu-id="9a813-122">1 つ以上のサブスクライバーが異なるバージョンの [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]を使用している場合を除き、パブリケーションが [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 以降のバージョンのみをサポートする必要があるように指定します。</span><span class="sxs-lookup"><span data-stu-id="9a813-122">Unless one or more Subscribers use a different version of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], specify that the publication must support only [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version.</span></span> <span data-ttu-id="9a813-123">これによって、パブリケーションは、新しい機能とパフォーマンスの最適化を利用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="9a813-123">This allows the publication to take advantage of new features and performance optimizations.</span></span>  
  
-   <span data-ttu-id="9a813-124">適切なパブリケーション保有期間設定を使用する。</span><span class="sxs-lookup"><span data-stu-id="9a813-124">Use appropriate publication retention settings.</span></span>  
  
     <span data-ttu-id="9a813-125">パブリケーションの保有期間は、サブスクリプションが同期されるまでの最長期間を示し、この期間によって追跡メタデータを保存する期間が決定されます。</span><span class="sxs-lookup"><span data-stu-id="9a813-125">The publication retention period, which is the maximum amount of time before a subscription must be synchronized, determines how long tracking metadata is stored.</span></span> <span data-ttu-id="9a813-126">この値を大きくすると、ストレージと処理のパフォーマンスが影響を受ける可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-126">A high value can affect storage and processing performance.</span></span> <span data-ttu-id="9a813-127">パブリケーションの保有期間の設定の詳細については、「 [Subscription Expiration and Deactivation](../subscription-expiration-and-deactivation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-127">For more information about setting the publication retention period, see [Subscription Expiration and Deactivation](../subscription-expiration-and-deactivation.md).</span></span>  
  
-   <span data-ttu-id="9a813-128">パブリッシャーでのみ変更されるテーブルについては、ダウンロード専用アーティクルを使用する。</span><span class="sxs-lookup"><span data-stu-id="9a813-128">Use download-only articles on those tables that are only changed at the Publisher.</span></span> <span data-ttu-id="9a813-129">詳細については、「[ダウンロード専用アーティクルを使用したマージ レプリケーションのパフォーマンス最適化](../merge/optimize-merge-replication-performance-with-download-only-articles.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-129">For more information, see [Optimize Merge Replication Performance with Download-Only Articles](../merge/optimize-merge-replication-performance-with-download-only-articles.md).</span></span>  
  
### <a name="filter-design-and-use"></a><span data-ttu-id="9a813-130">フィルターの設計および使用方法</span><span class="sxs-lookup"><span data-stu-id="9a813-130">Filter Design and Use</span></span>  
  
-   <span data-ttu-id="9a813-131">複雑な行フィルター句を制限する。</span><span class="sxs-lookup"><span data-stu-id="9a813-131">Limit the complexity of row filter clauses.</span></span>  
  
     <span data-ttu-id="9a813-132">フィルター条件の複雑さを制限することにより、サブスクライバーに送信する行の変更をマージ エージェントが評価するときのパフォーマンスが向上することになります。</span><span class="sxs-lookup"><span data-stu-id="9a813-132">Limiting the complexity of the filtering criteria helps improve performance when the Merge Agent is evaluating row changes to send to Subscribers.</span></span> <span data-ttu-id="9a813-133">マージ行フィルター句では、副選択の使用は避けてください。</span><span class="sxs-lookup"><span data-stu-id="9a813-133">Avoid using sub-selects within merge row filter clauses.</span></span> <span data-ttu-id="9a813-134">代わりに、結合フィルターの使用を検討してください。一般に結合フィルターは、他のテーブルの行フィルター句を基に、テーブルのデータをパーティション分割するために使用すると、より効率的です。</span><span class="sxs-lookup"><span data-stu-id="9a813-134">Instead, consider using join filters, which are generally more efficient when used to partition data in one table based on the row filter clause in another table.</span></span> <span data-ttu-id="9a813-135">フィルター選択の詳細については、「[マージ レプリケーション用にパブリッシュされたデータのフィルター選択](../merge/filter-published-data-for-merge-replication.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-135">For more information about filtering, see [Filter Published Data for Merge Replication](../merge/filter-published-data-for-merge-replication.md).</span></span>  
  
-   <span data-ttu-id="9a813-136">パラメーター化されたフィルターによる事前計算済みパーティションを使用する (これは既定で使用される機能です)。</span><span class="sxs-lookup"><span data-stu-id="9a813-136">Use precomputed partitions with parameterized filters (this feature is used by default).</span></span> <span data-ttu-id="9a813-137">詳細については、「[事前計算済みパーティションによるパラメーター化されたフィルターのパフォーマンス最適化](../merge/parameterized-filters-optimize-for-precomputed-partitions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-137">For more information, see [Optimize Parameterized Filter Performance with Precomputed Partitions](../merge/parameterized-filters-optimize-for-precomputed-partitions.md).</span></span>  
  
     <span data-ttu-id="9a813-138">事前計算済みパーティションでは、フィルターの動作にさまざまな制限が課せられます。</span><span class="sxs-lookup"><span data-stu-id="9a813-138">Precomputed partitions impose a number of limits on filtering behavior.</span></span> <span data-ttu-id="9a813-139">アプリケーションがこれらの制限に従うことができない場合は、 **keep_partition_changes** オプションを **True**に設定すると、パフォーマンスが向上します。</span><span class="sxs-lookup"><span data-stu-id="9a813-139">If your application cannot adhere to these limitations, set the **keep_partition_changes** option to **True**, which provides a performance benefit.</span></span> <span data-ttu-id="9a813-140">詳しくは、「 [Parameterized Row Filters](../merge/parameterized-filters-parameterized-row-filters.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9a813-140">For more information, see [Parameterized Row Filters](../merge/parameterized-filters-parameterized-row-filters.md).</span></span>  
  
-   <span data-ttu-id="9a813-141">フィルター選択されたデータがユーザー間で共有されていない場合は、重複しないパーティションを使用する。</span><span class="sxs-lookup"><span data-stu-id="9a813-141">Use nonoverlapping partitions if data is filtered but not shared among users.</span></span>  
  
     <span data-ttu-id="9a813-142">レプリケーションは、複数のパーティションまたはサブスクリプションによって共有されていないデータのパフォーマンスを最適化できます。</span><span class="sxs-lookup"><span data-stu-id="9a813-142">Replication can optimize performance for data that is not shared between partitions or subscriptions.</span></span> <span data-ttu-id="9a813-143">詳しくは、「 [Parameterized Row Filters](../merge/parameterized-filters-parameterized-row-filters.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9a813-143">For more information, see [Parameterized Row Filters](../merge/parameterized-filters-parameterized-row-filters.md).</span></span>  
  
-   <span data-ttu-id="9a813-144">複雑な結合フィルター階層を作成しない。</span><span class="sxs-lookup"><span data-stu-id="9a813-144">Do not create complex join filter hierarchies.</span></span>  
  
     <span data-ttu-id="9a813-145">5 個以上のテーブルを使用した結合フィルターは、マージ処理中のパフォーマンスに大きく影響を与える可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-145">Join filters with five or more tables can significantly impact performance during merge processing.</span></span> <span data-ttu-id="9a813-146">5 個以上のテーブルに結合フィルターを生成するような場合には、他の方法を検討することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9a813-146">We recommend that if you are generating join filters of five or more tables that you consider other solutions:</span></span>  
  
    -   <span data-ttu-id="9a813-147">テーブルのフィルター選択で、プライマリ参照テーブル、より小さなテーブル、および変更されないテーブルは回避する。</span><span class="sxs-lookup"><span data-stu-id="9a813-147">Avoid filtering tables that are primarily lookup tables, smaller tables, and tables that are not subject to change.</span></span> <span data-ttu-id="9a813-148">これらのテーブルは、全体をパブリケーションの一部にしてください。</span><span class="sxs-lookup"><span data-stu-id="9a813-148">Make those tables part of the publication in their entirety.</span></span> <span data-ttu-id="9a813-149">結合フィルターは、複数のサブスクライバーの間でパーティション分割する必要があるテーブル間のみで使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9a813-149">We recommend that you use join filters only between tables that must be partitioned among Subscribers.</span></span> <span data-ttu-id="9a813-150">詳しくは、「 [Join Filters](../merge/join-filters.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9a813-150">For more information, see [Join Filters](../merge/join-filters.md).</span></span>  
  
    -   <span data-ttu-id="9a813-151">結合内に多数のテーブルが存在する場合は、データベース設計の正規化の低減、またはマッピング テーブルの使用を検討する。</span><span class="sxs-lookup"><span data-stu-id="9a813-151">Consider denormalizing the database design or using a mapping table if there are a large number of tables in a join.</span></span> <span data-ttu-id="9a813-152">たとえば、営業担当者が自分の担当する顧客のデータのみ必要なのに、1 人の顧客を 1 人の営業担当者に関連付けるために 6 個の結合が必要な場合は、顧客テーブルに営業担当者を識別する列を 1 つ追加することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-152">For example, if a sales person needs only the data for her customers, but it requires six joins to associate a customer with a sales person, consider adding a column to the customer table that identifies the sales person.</span></span> <span data-ttu-id="9a813-153">この営業担当者データは冗長ですが、レプリケーションのパーティション分割のパフォーマンス向上は、テーブルの正規化が低減されたコストを何らかの形で上回る可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-153">The sales person data is redundant, but the costs of denormalizing the tables somewhat might be outweighed by the performance benefits for replication partitioning.</span></span>  
  
    -   <span data-ttu-id="9a813-154">バッチにデータ変更が多数含まれている場合に事前計算済みパーティションのパフォーマンスを向上させるには、アプリケーションを慎重に設計してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-154">To improve the performance of precomputed partitions when batches contain lots of data changes, design your application with care.</span></span> <span data-ttu-id="9a813-155">結合フィルターに含まれる親テーブル内のデータへの変更は、子テーブル内で対応する変更が生じる前に行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-155">Make sure that changes to data in the parent table in a join filter are made before corresponding changes in the child tables.</span></span>  
  
-   <span data-ttu-id="9a813-156">ロジックで許容される場合は、 **join_unique_key** オプションに「 **1** 」を設定する。</span><span class="sxs-lookup"><span data-stu-id="9a813-156">Set the **join_unique_key** option to **1** if logic allows.</span></span>  
  
     <span data-ttu-id="9a813-157">このパラメーターを「 **1** 」に設定することによって、結合フィルター内の親テーブルと子テーブルのリレーションシップが一対一または一対多であることが指定されます。</span><span class="sxs-lookup"><span data-stu-id="9a813-157">Setting this parameter to **1** indicates that the relationship between the child and parent tables in a join filter is one to one or one to many.</span></span> <span data-ttu-id="9a813-158">一意性を保証する子テーブル内の列の結合についての制約がある場合にのみ、このパラメーターを「 **1** 」に設定します。</span><span class="sxs-lookup"><span data-stu-id="9a813-158">Only set this parameter to **1** if you have a constraint on the joining column in the child table that guarantees uniqueness.</span></span> <span data-ttu-id="9a813-159">このパラメーターを誤って「 **1** 」に設定した場合は、データの未集約が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-159">If the parameter is set to **1** incorrectly, non-convergence of data can occur.</span></span> <span data-ttu-id="9a813-160">詳しくは、「 [Join Filters](../merge/join-filters.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9a813-160">For more information, see [Join Filters](../merge/join-filters.md).</span></span>  
  
-   <span data-ttu-id="9a813-161">事前計算済みパーティションを使用する場合は、多数の変更を含むバッチの実行を回避します。</span><span class="sxs-lookup"><span data-stu-id="9a813-161">Avoid executing batches with lots of changes when you use precomputed partitions.</span></span>  
  
     <span data-ttu-id="9a813-162">多数のデータ変更を含むバッチを実行した後でマージ エージェントを実行すると、エージェントは大きいバッチを複数の小さいバッチに分割しようとします。</span><span class="sxs-lookup"><span data-stu-id="9a813-162">When the Merge Agent is run after you run a batch that contains lots of data changes, the agent tries to divide the large batch into smaller batches.</span></span> <span data-ttu-id="9a813-163">この処理の間に、他のマージ エージェントのプロセスがブロックされる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-163">During this time, other Merge Agent processes may be blocked.</span></span> <span data-ttu-id="9a813-164">バッチ内の変更の数を減らしてから、バッチとバッチの間でマージ エージェントを実行することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-164">Consider reducing the number of changes in a batch and run the Merge Agent between batches.</span></span> <span data-ttu-id="9a813-165">この処理を実行できない場合は、パブリケーションの **generation_leveling_threshold** の値を大きくします。</span><span class="sxs-lookup"><span data-stu-id="9a813-165">If this cannot be done, increase the value of **generation_leveling_threshold** for the publication.</span></span>  
  
## <a name="subscription-considerations"></a><span data-ttu-id="9a813-166">サブスクリプションに関する注意点</span><span class="sxs-lookup"><span data-stu-id="9a813-166">Subscription Considerations</span></span>  
  
-   <span data-ttu-id="9a813-167">サブスクリプションの同期スケジュールをずらす。</span><span class="sxs-lookup"><span data-stu-id="9a813-167">Stagger subscription synchronization schedules.</span></span>  
  
     <span data-ttu-id="9a813-168">多数のサブスクライバーが 1 つのパブリッシャーと同期される場合、マージ エージェントが異なるタイミングで実行されるように、スケジュールをずらすことを検討してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-168">If a large number of Subscribers synchronize with a Publisher, consider staggering the schedules so that Merge Agents run at different times.</span></span> <span data-ttu-id="9a813-169">詳細については、「 [Specify Synchronization Schedules](../specify-synchronization-schedules.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-169">For more information, see [Specify Synchronization Schedules](../specify-synchronization-schedules.md).</span></span>  
  
## <a name="merge-agent-parameters"></a><span data-ttu-id="9a813-170">マージ エージェントのパラメーター</span><span class="sxs-lookup"><span data-stu-id="9a813-170">Merge Agent Parameters</span></span>  
 <span data-ttu-id="9a813-171">マージ エージェントおよびそのパラメーターの詳細については、「 [Replication Merge Agent](../agents/replication-merge-agent.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-171">For information about the Merge Agent and its parameters, see [Replication Merge Agent](../agents/replication-merge-agent.md).</span></span>  
  
-   <span data-ttu-id="9a813-172">プル サブスクリプションを行うすべてのサブスクライバーを [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 以降のバージョンにアップグレードする。</span><span class="sxs-lookup"><span data-stu-id="9a813-172">Upgrade all Subscribers for pull subscriptions to [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version.</span></span>  
  
     <span data-ttu-id="9a813-173">サブスクライバーを [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 以降のバージョンにアップグレードすることにより、そのサブスクライバーのサブスクリプションによって使用されるマージ エージェントが更新されます。</span><span class="sxs-lookup"><span data-stu-id="9a813-173">Upgrading the Subscriber to [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version upgrades the Merge Agent used by the subscriptions at that Subscriber.</span></span> <span data-ttu-id="9a813-174">新しい機能の多くとパフォーマンスの最適化を利用するには、 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 以降のバージョンのマージ エージェントが必要です。</span><span class="sxs-lookup"><span data-stu-id="9a813-174">To take advantage of many of the new features and performance optimizations, the Merge Agent from [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version is required.</span></span>  
  
-   <span data-ttu-id="9a813-175">サブスクリプションが高速接続を介して同期され、パブリッシャーおよびサブスクライバーから変更が送信される場合は、マージ エージェントに対して **-ParallelUploadDownload** パラメーターを使用する。</span><span class="sxs-lookup"><span data-stu-id="9a813-175">If a subscription is synchronized over a fast connection and changes are sent from the Publisher and Subscriber, use the **-ParallelUploadDownload** parameter for the Merge Agent.</span></span>  
  
     [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] <span data-ttu-id="9a813-176">で、新しいマージ エージェント パラメーターである **-ParallelUploadDownload** が導入されました。</span><span class="sxs-lookup"><span data-stu-id="9a813-176">introduced a new Merge Agent parameter: **-ParallelUploadDownload**.</span></span> <span data-ttu-id="9a813-177">このパラメーターを設定することによって、マージ エージェントはパブリッシャーにアップロードされた複数の変更およびサブスクライバーにダウンロードされた複数の変更を並列処理できるようになります。</span><span class="sxs-lookup"><span data-stu-id="9a813-177">Setting this parameter allows the Merge Agent to process in parallel the changes uploaded to the Publisher and those downloaded to the Subscriber.</span></span> <span data-ttu-id="9a813-178">これは、帯域幅が広いネットワークを使用している大容量環境において役立ちます。</span><span class="sxs-lookup"><span data-stu-id="9a813-178">This is useful in high volume environments with high network bandwidth.</span></span> <span data-ttu-id="9a813-179">エージェント パラメーターは、エージェント プロファイルおよびコマンド ラインで指定できます。</span><span class="sxs-lookup"><span data-stu-id="9a813-179">Agent parameters can be specified in agent profiles and on the command line.</span></span> <span data-ttu-id="9a813-180">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-180">For more information, see:</span></span>  
  
    -   [<span data-ttu-id="9a813-181">レプリケーション エージェント プロファイルの操作</span><span class="sxs-lookup"><span data-stu-id="9a813-181">Work with Replication Agent Profiles</span></span>](../agents/replication-agent-profiles.md)  
  
    -   [<span data-ttu-id="9a813-182">レプリケーション エージェント コマンド プロンプト パラメーターを表示および変更する &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="9a813-182">View and Modify Replication Agent Command Prompt Parameters &#40;SQL Server Management Studio&#41;</span></span>](../agents/view-and-modify-replication-agent-command-prompt-parameters.md)  
  
    -   [<span data-ttu-id="9a813-183">Replication Agent Executables Concepts</span><span class="sxs-lookup"><span data-stu-id="9a813-183">Replication Agent Executables Concepts</span></span>](../concepts/replication-agent-executables-concepts.md)  
  
-   <span data-ttu-id="9a813-184">特に同期でサブスクライバーにダウンロードするよりもサブスクライバーからダウンロードすることが多い場合は、 **-MakeGenerationInterval** パラメーターの値を大きくすることを検討する。</span><span class="sxs-lookup"><span data-stu-id="9a813-184">Consider increasing the value of the **-MakeGenerationInterval** parameter, especially if synchronization involves more uploads from Subscribers than downloads to Subscribers.</span></span>  
  
-   <span data-ttu-id="9a813-185">LOB 列を含む行など、大量のデータを含むデータ行を同期すると、Web 同期から追加メモリの割り当てが要求され、パフォーマンスが低下する場合があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-185">When you synchronize data rows with a large amount of data, such as rows with LOB columns, Web synchronization can require additional memory allocation and hurt performance.</span></span> <span data-ttu-id="9a813-186">この動作は、マージ エージェントから生成された XML メッセージに、大量のデータを含むデータ行が過剰に含まれている場合に発生します。</span><span class="sxs-lookup"><span data-stu-id="9a813-186">This occurs when the Merge Agent generates an XML message that contains too many data rows with large amounts of data.</span></span> <span data-ttu-id="9a813-187">マージ エージェントが Web 同期中に使用するリソースが多すぎる場合は、次のいずれかの方法を使用して、1 つのメッセージで送信される行の数を減らします。</span><span class="sxs-lookup"><span data-stu-id="9a813-187">If the Merge Agent is consuming too many resources during Web synchronization, reduce the number of rows sent in a single message in one of the following ways:</span></span>  
  
    -   <span data-ttu-id="9a813-188">マージ エージェントで低速リンク エージェント プロファイルを使用する。</span><span class="sxs-lookup"><span data-stu-id="9a813-188">Use the slow link agent profile for the Merge Agent.</span></span> <span data-ttu-id="9a813-189">詳しくは、「 [レプリケーション エージェント プロファイル](../agents/replication-agent-profiles.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9a813-189">For more information, see [Replication Agent Profiles](../agents/replication-agent-profiles.md).</span></span>  
  
    -   <span data-ttu-id="9a813-190">マージ エージェントの **-DownloadGenerationsPerBatch** パラメーターと **-UploadGenerationsPerBatch** パラメーターの値を 10 未満に減らす。</span><span class="sxs-lookup"><span data-stu-id="9a813-190">Decrease the **-DownloadGenerationsPerBatch** and **-UploadGenerationsPerBatch** parameters for the Merge Agent to a value of 10 or less.</span></span> <span data-ttu-id="9a813-191">これらのパラメーターの既定値は 50 です。</span><span class="sxs-lookup"><span data-stu-id="9a813-191">The default value of these parameters is 50.</span></span>  
  
## <a name="snapshot-considerations"></a><span data-ttu-id="9a813-192">スナップショットに関する注意点</span><span class="sxs-lookup"><span data-stu-id="9a813-192">Snapshot Considerations</span></span>  
  
-   <span data-ttu-id="9a813-193">初期スナップショットを生成する前に大きなテーブルに ROWGUIDCOL 列を作成する。</span><span class="sxs-lookup"><span data-stu-id="9a813-193">Create a ROWGUIDCOL column on large tables prior to generating the initial snapshot.</span></span>  
  
     <span data-ttu-id="9a813-194">マージ レプリケーションでは、パブリッシュされた各テーブルに ROWGUIDCOL 列が必要です。</span><span class="sxs-lookup"><span data-stu-id="9a813-194">Merge replication requires that each published table have a ROWGUIDCOL column.</span></span> <span data-ttu-id="9a813-195">スナップショット エージェントが初期スナップショット ファイルを作成する際に ROWGUIDCOL 列があらかじめテーブルに作成されていない場合、エージェントはまず ROWGUIDCOL 列を作成し、追加しなくてはなりません。</span><span class="sxs-lookup"><span data-stu-id="9a813-195">If a ROWGUIDCOL column does not exist in the table before the Snapshot Agent creates the initial snapshot files, the agent must first add and populate the ROWGUIDCOL column.</span></span> <span data-ttu-id="9a813-196">マージ レプリケーションでスナップショットを生成および適用するときのパフォーマンスを向上させるには、テーブルをパブリッシュする前に各テーブルで ROWGUIDCOL 列を作成します。</span><span class="sxs-lookup"><span data-stu-id="9a813-196">To gain a performance advantage when generating snapshots during merge replication, create the ROWGUIDCOL column on each table before publishing.</span></span> <span data-ttu-id="9a813-197">列の名前は任意ですが (スナップショット エージェントは既定で**rowguid** を使用します)、以下のデータ型の特性を持つ必要があります。</span><span class="sxs-lookup"><span data-stu-id="9a813-197">The column can have any name (**rowguid** is used by the Snapshot Agent by default), but must have the following data type characteristics:</span></span>  
  
    -   <span data-ttu-id="9a813-198">UNIQUEIDENTIFIER のデータ型。</span><span class="sxs-lookup"><span data-stu-id="9a813-198">A data type of UNIQUEIDENTIFIER.</span></span>  
  
    -   <span data-ttu-id="9a813-199">NEWSEQUENTIALID() または NEWID() の既定値。</span><span class="sxs-lookup"><span data-stu-id="9a813-199">A default of NEWSEQUENTIALID() or NEWID().</span></span> <span data-ttu-id="9a813-200">変更および変更の追跡の際にパフォーマンスを向上させることができるため、NEWSEQUENTIALID() の使用をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9a813-200">NEWSEQUENTIALID() is recommended because it can provide increased performance when making and tracking changes.</span></span>  
  
    -   <span data-ttu-id="9a813-201">ROWGUIDCOL プロパティ セット。</span><span class="sxs-lookup"><span data-stu-id="9a813-201">The ROWGUIDCOL property set.</span></span>  
  
    -   <span data-ttu-id="9a813-202">列の一意なインデックス。</span><span class="sxs-lookup"><span data-stu-id="9a813-202">A unique index on the column.</span></span>  
  
-   <span data-ttu-id="9a813-203">スナップショットを事前に生成するか、最初の同期時にサブスクライバーからスナップショットの生成および適用を要求できるようにする。</span><span class="sxs-lookup"><span data-stu-id="9a813-203">Pre-generate snapshots and/or allow Subscribers to request snapshot generation and application the first time they synchronize.</span></span>  
  
     <span data-ttu-id="9a813-204">これらのオプションの両方またはどちらかを使用して、パラメーター化されたフィルターを使用するパブリケーションに対するスナップショットを提供します。</span><span class="sxs-lookup"><span data-stu-id="9a813-204">Use one or both of these options to provide snapshots for publications that use parameterized filters.</span></span> <span data-ttu-id="9a813-205">これらのオプションのどちらかを指定しないと、 **bcp** ユーティリティを使用するのではなく、一連の SELECT ステートメントおよび INSERT ステートメントを使用してサブスクリプションが初期化されます。この処理は、かなり低速で実行されます。</span><span class="sxs-lookup"><span data-stu-id="9a813-205">If you do not specify one of these options, subscriptions are initialized using a series of SELECT and INSERT statements, rather than using the **bcp** utility; this process is much slower.</span></span> <span data-ttu-id="9a813-206">詳しくは、「 [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9a813-206">For more information, see [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md).</span></span>  
  
## <a name="maintenance-and-monitoring-considerations"></a><span data-ttu-id="9a813-207">メンテナンスおよび監視に関する注意点</span><span class="sxs-lookup"><span data-stu-id="9a813-207">Maintenance and Monitoring Considerations</span></span>  
  
-   <span data-ttu-id="9a813-208">必要な場合、マージ レプリケーションのシステム テーブルのインデックスを再度作成する。</span><span class="sxs-lookup"><span data-stu-id="9a813-208">Occasionally re-index merge replication system tables.</span></span>  
  
     <span data-ttu-id="9a813-209">マージ レプリケーションのメンテナンスの一環として、マージ レプリケーションに関連付けられたシステム テーブル **MSmerge_contents**、 **MSmerge_genhistory**、 **MSmerge_tombstone**、 **MSmerge_current_partition_mappings**、および **MSmerge_past_partition_mappings**の増大を必要に応じて確認します。</span><span class="sxs-lookup"><span data-stu-id="9a813-209">As part of maintenance for merge replication, occasionally check the growth of the system tables associated with merge replication: **MSmerge_contents**, **MSmerge_genhistory**, and **MSmerge_tombstone**, **MSmerge_current_partition_mappings**, and **MSmerge_past_partition_mappings**.</span></span> <span data-ttu-id="9a813-210">定期的にこれらのテーブルのインデックスを再設定します。</span><span class="sxs-lookup"><span data-stu-id="9a813-210">Periodically re-index these tables.</span></span> <span data-ttu-id="9a813-211">詳細については、「 [インデックスの再編成と再構築](../../indexes/reorganize-and-rebuild-indexes.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-211">For more information, see [Reorganize and Rebuild Indexes](../../indexes/reorganize-and-rebuild-indexes.md).</span></span>  
  
-   <span data-ttu-id="9a813-212">レプリケーション モニターの **[同期の履歴]** タブを使用して、同期のパフォーマンスを監視する。</span><span class="sxs-lookup"><span data-stu-id="9a813-212">Monitor synchronization performance using the **Synchronization History** tab in Replication Monitor.</span></span>  
  
     <span data-ttu-id="9a813-213">マージ レプリケーションの場合、レプリケーション モニターの **[同期の履歴]** タブには、同期中に処理される各アーティクルの詳細な統計情報が表示されます。この統計には、各処理フェーズ (変更のアップロードやダウンロードなど) にかかる時間などが含まれます。</span><span class="sxs-lookup"><span data-stu-id="9a813-213">For merge replication, Replication Monitor displays detailed statistics in the **Synchronization History** tab for each article processed during synchronization, including the amount of time spent in each processing phase (uploading changes, downloading changes, and so on).</span></span> <span data-ttu-id="9a813-214">この情報によって、速度低下の原因となっているテーブルを特定することができます。マージ サブスクリプションのパフォーマンスに関するトラブルシューティングを、この情報から開始することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9a813-214">It can help pinpoint specific tables that are causing slow downs and is the best place to troubleshoot performance issues with merge subscriptions.</span></span> <span data-ttu-id="9a813-215">詳細な統計情報の表示の詳細については、「[レプリケーションモニターを使用して情報を表示し、タスクを実行する](../monitor/view-information-and-perform-tasks-replication-monitor.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9a813-215">For more information on viewing detailed statistics, see [View Information and Perform Tasks using Replication Monitor](../monitor/view-information-and-perform-tasks-replication-monitor.md).</span></span>  
  
  
