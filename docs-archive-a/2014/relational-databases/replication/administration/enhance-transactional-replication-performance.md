---
title: トランザクション レプリケーションのパフォーマンスの向上 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publications [SQL Server replication], design and performance
- performance [SQL Server replication], transactional replication
- designing databases [SQL Server], replication performance
- performance [SQL Server replication], snapshot replication
- snapshot replication [SQL Server], performance
- subscriptions [SQL Server replication], performance considerations
- agents [SQL Server replication], performance
- Distribution Agent, performance
- transactional replication, performance
- Log Reader Agent, performance
ms.assetid: 67084a67-43ff-4065-987a-3b16d1841565
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: fe802796b129ff9bdb50e5dea13e1fe98beee269
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87741873"
---
# <a name="enhance-transactional-replication-performance"></a><span data-ttu-id="9c052-102">トランザクション レプリケーションのパフォーマンスの向上</span><span class="sxs-lookup"><span data-stu-id="9c052-102">Enhance Transactional Replication Performance</span></span>
  <span data-ttu-id="9c052-103">「 [レプリケーションの全般的パフォーマンスの向上](enhance-general-replication-performance.md)」で説明した全般的なパフォーマンス向上のヒントを検討した後、トランザクション レプリケーションに固有なこれらの項目を併せて検討してください。</span><span class="sxs-lookup"><span data-stu-id="9c052-103">After considering the general performance tips described in [Enhancing General Replication Performance](enhance-general-replication-performance.md), consider these additional areas specific to transactional replication.</span></span>  
  
## <a name="database-design"></a><span data-ttu-id="9c052-104">データベースの設計</span><span class="sxs-lookup"><span data-stu-id="9c052-104">Database Design</span></span>  
  
-   <span data-ttu-id="9c052-105">アプリケーションの設計で、トランザクションのサイズを最小化する。</span><span class="sxs-lookup"><span data-stu-id="9c052-105">Minimize transaction size in your application design.</span></span>  
  
     <span data-ttu-id="9c052-106">既定では、トランザクション レプリケーションはトランザクションの境界に従って変更を反映させます。</span><span class="sxs-lookup"><span data-stu-id="9c052-106">By default, transactional replication propagates changes according to transaction boundaries.</span></span> <span data-ttu-id="9c052-107">トランザクションが小さくなると、ネットワークの問題によりディストリビューション エージェントがトランザクションを再送信しなければならなくなる可能性は低くなります。</span><span class="sxs-lookup"><span data-stu-id="9c052-107">If transactions are smaller, it is less likely that the Distribution Agent will have to resend a transaction due to network issues.</span></span> <span data-ttu-id="9c052-108">エージェントがトランザクションを再送信する必要があっても、送信されるデータは少なくなります。</span><span class="sxs-lookup"><span data-stu-id="9c052-108">If the agent is required to resend a transaction, the amount of data sent is smaller.</span></span>  
  
## <a name="distributor-configuration"></a><span data-ttu-id="9c052-109">ディストリビューターの構成</span><span class="sxs-lookup"><span data-stu-id="9c052-109">Distributor Configuration</span></span>  
  
-   <span data-ttu-id="9c052-110">ディストリビューション専用サーバーを構成する。</span><span class="sxs-lookup"><span data-stu-id="9c052-110">Configure the Distributor on a dedicated server.</span></span>  
  
     <span data-ttu-id="9c052-111">リモート ディストリビューターを構成することにより、パブリッシャーの処理オーバーヘッドを減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="9c052-111">You can reduce processing overhead on the Publisher by configuring a remote Distributor.</span></span> <span data-ttu-id="9c052-112">詳しくは、「 [Configure Distribution](../configure-distribution.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9c052-112">For more information, see [Configure Distribution](../configure-distribution.md).</span></span>  
  
-   <span data-ttu-id="9c052-113">ディストリビューション データベースのサイズを適切に設定する。</span><span class="sxs-lookup"><span data-stu-id="9c052-113">Size the distribution database appropriately.</span></span>  
  
     <span data-ttu-id="9c052-114">システムの典型的な負荷でレプリケーションをテストし、コマンドを格納するために必要な領域を決定します。</span><span class="sxs-lookup"><span data-stu-id="9c052-114">Test replication with a typical load for your system to determine how much space is required to store commands.</span></span> <span data-ttu-id="9c052-115">データベースが頻繁に自動拡張しなくてもコマンドを格納できるだけの大きさを備えていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="9c052-115">Ensure the database is large enough to store commands without having to auto-grow frequently.</span></span> <span data-ttu-id="9c052-116">データベースのサイズの変更に関する詳細については、「[ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9c052-116">For more information about changing the size of a database, see [ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql).</span></span>  
  
## <a name="publication-design"></a><span data-ttu-id="9c052-117">パブリケーションの設計</span><span class="sxs-lookup"><span data-stu-id="9c052-117">Publication Design</span></span>  
  
-   <span data-ttu-id="9c052-118">パブリッシュされたテーブルに対してバッチ更新を行う場合は、ストアド プロシージャの実行をレプリケートする。</span><span class="sxs-lookup"><span data-stu-id="9c052-118">Replicate stored procedure execution when making batch updates to published tables.</span></span>  
  
     <span data-ttu-id="9c052-119">バッチ更新がサブスクライバーで多数の行に影響することがある場合には、パブリッシュされたテーブルをストアド プロシージャで更新することを検討して、ストアド プロシージャの実行をパブリッシュしてください。</span><span class="sxs-lookup"><span data-stu-id="9c052-119">If you have batch updates that occasionally affect a large number of rows at the Subscriber, you should consider updating the published table using a stored procedure and publish the execution of the stored procedure.</span></span> <span data-ttu-id="9c052-120">ディストリビューション エージェントは、影響を受けたすべての列に対する更新または削除を送信するのではなく、サブスクライバーで同じパラメーター値を使用して同じプロシージャを実行します。</span><span class="sxs-lookup"><span data-stu-id="9c052-120">Instead of sending an update or delete for every row affected, the Distribution Agent executes the same procedure at the Subscriber with the same parameter values.</span></span> <span data-ttu-id="9c052-121">詳細については、「[トランザクション レプリケーションにおけるパブリッシング ストアド プロシージャの実行](../transactional/publishing-stored-procedure-execution-in-transactional-replication.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9c052-121">For more information, see [Publishing Stored Procedure Execution in Transactional Replication](../transactional/publishing-stored-procedure-execution-in-transactional-replication.md).</span></span>  
  
-   <span data-ttu-id="9c052-122">複数のパブリケーションにアーティクルを分散する。</span><span class="sxs-lookup"><span data-stu-id="9c052-122">Spread articles across multiple publications.</span></span>  
  
     <span data-ttu-id="9c052-123">**-SubscriptionStreams** パラメーター (このトピックで後ほど説明します) を使用できない場合は、複数のパブリケーションを作成することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="9c052-123">If you cannot use the **-SubscriptionStreams** parameter (described later in this topic), consider creating multiple publications.</span></span> <span data-ttu-id="9c052-124">これらのパブリケーションにアーティクルを分散させると、サブスクライバーに対する変更をレプリケーションで並列的に適用できます。</span><span class="sxs-lookup"><span data-stu-id="9c052-124">Spreading articles across these publications allows replication to apply changes in parallel to Subscribers.</span></span>  
  
## <a name="subscription-considerations"></a><span data-ttu-id="9c052-125">サブスクリプションに関する注意点</span><span class="sxs-lookup"><span data-stu-id="9c052-125">Subscription Considerations</span></span>  
  
-   <span data-ttu-id="9c052-126">同一のパブリッシャーに複数のパブリケーションがある場合は、共有エージェントの代わりに独立エージェントを使用する (これはパブリケーションの新規作成ウィザードの既定の設定です)。</span><span class="sxs-lookup"><span data-stu-id="9c052-126">Use independent agents rather than shared agents if you have multiple publications on the same Publisher (this is the default for the New Publication Wizard).</span></span>  
  
-   <span data-ttu-id="9c052-127">エージェントを連続して実行し、高い頻度のスケジュールにはしない。</span><span class="sxs-lookup"><span data-stu-id="9c052-127">Run agents continuously instead of on very frequent schedules.</span></span>  
  
     <span data-ttu-id="9c052-128">エージェントを連続的に実行するようにし、高い頻度のスケジュール、たとえば毎分などのスケジュールの作成を避けることで、レプリケーションのパフォーマンスが向上します。これは、エージェントが開始および停止する必要がなくなるからです。</span><span class="sxs-lookup"><span data-stu-id="9c052-128">Setting the agents to run continuously rather than creating frequent schedules (such as every minute) improves replication performance, because the agent does not have to start and stop.</span></span> <span data-ttu-id="9c052-129">ディストリビューション エージェントを連続的に実行するように設定すると、トポロジ内で接続しているその他のサーバーに、短い待機時間で変更が反映されます。</span><span class="sxs-lookup"><span data-stu-id="9c052-129">When you set the Distribution Agent to run continuously, changes are propagated with low latency to the other servers that are connected in the topology.</span></span> <span data-ttu-id="9c052-130">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9c052-130">For more information, see:</span></span>  
  
    -   [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]<span data-ttu-id="9c052-131">:[同期スケジュールの指定](../specify-synchronization-schedules.md)</span><span class="sxs-lookup"><span data-stu-id="9c052-131">: [Specify Synchronization Schedules](../specify-synchronization-schedules.md)</span></span>  
  
## <a name="distribution-agent-and-log-reader-agent-parameters"></a><span data-ttu-id="9c052-132">ディストリビューション エージェントおよびログ リーダー エージェントのパラメーター</span><span class="sxs-lookup"><span data-stu-id="9c052-132">Distribution Agent and Log Reader Agent Parameters</span></span>  
  
-   <span data-ttu-id="9c052-133">偶発的な解決策として、1回限りのボトルネックでは、ログリーダーエージェントに **-maxcmdsintran**パラメーターを使用します。</span><span class="sxs-lookup"><span data-stu-id="9c052-133">To resolve accidental, one-time bottlenecks use the **-MaxCmdsInTran** parameter for the Log Reader Agent.</span></span>  
  
     <span data-ttu-id="9c052-134">**-Maxcmdsintran**パラメーターは、ログリーダーがディストリビューションデータベースにコマンドを書き込むときに、トランザクションにグループ化されるステートメントの最大数を指定します。</span><span class="sxs-lookup"><span data-stu-id="9c052-134">The **-MaxCmdsInTran** parameter specifies the maximum number of statements grouped into a transaction as the Log Reader writes commands to the distribution database.</span></span> <span data-ttu-id="9c052-135">このパラメーターを使用すると、ログ リーダー エージェントおよびディストリビューション エージェントは、サブスクライバーでコマンドを適用するときに、パブリッシャーで (多数のコマンドで構成される) 大きなトランザクションを複数の小さなトランザクションに分割できます。</span><span class="sxs-lookup"><span data-stu-id="9c052-135">Using this parameter allows the Log Reader Agent and Distribution Agent to divide large transactions (consisting of many commands) at the Publisher into several smaller transactions when applying commands at the Subscriber.</span></span> <span data-ttu-id="9c052-136">このパラメーターを指定すると、ディストリビューターでの競合を減らし、パブリッシャーとサブスクライバーの間の待機時間を減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="9c052-136">Specifying this parameter can reduce contention at the Distributor and reduce latency between the Publisher and Subscriber.</span></span> <span data-ttu-id="9c052-137">元のトランザクションはより小さな単位で適用されるため、サブスクライバーは元のトランザクションが終了する前に、大きな論理パブリッシャー トランザクションの行にアクセスし、トランザクションの厳密な原子性を損なうことがあります。</span><span class="sxs-lookup"><span data-stu-id="9c052-137">Because the original transaction is applied in smaller units, the Subscriber can access rows of a large logical Publisher transaction prior to the end of the original transaction, breaking strict transactional atomicity.</span></span> <span data-ttu-id="9c052-138">既定値は **0**です。この場合、パブリッシャーのトランザクション境界が保護されます。</span><span class="sxs-lookup"><span data-stu-id="9c052-138">The default is **0**, which preserves the transaction boundaries of the Publisher.</span></span> <span data-ttu-id="9c052-139">このパラメーターは、Oracle パブリッシャーには適用されません。</span><span class="sxs-lookup"><span data-stu-id="9c052-139">This parameter does not apply to Oracle Publishers.</span></span>  
  
    > [!WARNING]  
    >  <span data-ttu-id="9c052-140">`MaxCmdsInTran` は、常に有効になるようには設計されていませんでした。</span><span class="sxs-lookup"><span data-stu-id="9c052-140">`MaxCmdsInTran` was not designed to be always turned on.</span></span> <span data-ttu-id="9c052-141">このパラメーターは、ユーザーが誤って 1 つのトランザクションで多数の DML 操作を実行した場合に対応するためのものです (このような場合、トランザクション全体がディストリビューション データベースに格納されるまでコマンドの配布で遅延が発生したり、ロックが保持されたりするなどの問題が発生します)。</span><span class="sxs-lookup"><span data-stu-id="9c052-141">It exists to work around cases where someone accidentally performed a large number of DML operations in a single transaction (causing delay in distribution of commands until the entire transaction is in distribution database, locks being held, etc.).</span></span> <span data-ttu-id="9c052-142">このような状況が定期的に発生する場合は、アプリケーションを確認し、トランザクションのサイズを縮小する方法を見つけてください。</span><span class="sxs-lookup"><span data-stu-id="9c052-142">If you routinely fall into this situation, you should review your applications and find ways to reduce the transaction size.</span></span>  
  
-   <span data-ttu-id="9c052-143">ディストリビューションエージェントには **-subscriptionstreams**パラメーターを使用します。</span><span class="sxs-lookup"><span data-stu-id="9c052-143">Use the **-SubscriptionStreams** parameter for the Distribution Agent.</span></span>  
  
     <span data-ttu-id="9c052-144">**-Subscriptionstreams**パラメーターを使用すると、集計レプリケーションのスループットを大幅に向上させることができます。</span><span class="sxs-lookup"><span data-stu-id="9c052-144">The **-SubscriptionStreams** parameter can greatly improve aggregate replication throughput.</span></span> <span data-ttu-id="9c052-145">このパラメーターを使用すると、単一のスレッドを使用するときに存在するトランザクション特性の多くを維持しつつ、変更のバッチをサブスクライバーへの複数の接続で並列的に適用できます。</span><span class="sxs-lookup"><span data-stu-id="9c052-145">It allows multiple connections to a Subscriber to apply batches of changes in parallel, while maintaining many of the transactional characteristics present when using a single thread.</span></span> <span data-ttu-id="9c052-146">いずれかの接続が実行またはコミットに失敗した場合、進行中のバッチがすべての接続について中止されます。その場合、エージェントは、単一のストリームを使用して、失敗したバッチを再試行します。</span><span class="sxs-lookup"><span data-stu-id="9c052-146">If one of the connections fails to execute or commit, all connections will abort the current batch, and the agent will use a single stream to retry the failed batches.</span></span> <span data-ttu-id="9c052-147">この再試行フェーズが完了するまでは、サブスクライバー側に、トランザクションの一時的な不整合が存在する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="9c052-147">Before this retry phase completes, there can be temporary transactional inconsistencies at the Subscriber.</span></span> <span data-ttu-id="9c052-148">サブスクライバーのトランザクション一貫性は、前回失敗したバッチが正常にコミットされた後で復元されます。</span><span class="sxs-lookup"><span data-stu-id="9c052-148">After the failed batches are successfully committed, the Subscriber is brought back to a state of transactional consistency.</span></span>  
  
     <span data-ttu-id="9c052-149">このエージェントパラメーターの値は、 [sp_addsubscription &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)の\*\* \@ subscriptionstreams\*\*を使用して指定できます。</span><span class="sxs-lookup"><span data-stu-id="9c052-149">A value for this agent parameter can be specified using the **\@subscriptionstreams** of [sp_addsubscription &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql).</span></span>  
  
-   <span data-ttu-id="9c052-150">ログ リーダー エージェントの **-ReadBatchSize** パラメーターの値を大きくする。</span><span class="sxs-lookup"><span data-stu-id="9c052-150">Increase the value of the **-ReadBatchSize** parameter for the Log Reader Agent.</span></span>  
  
     <span data-ttu-id="9c052-151">ログ リーダー エージェントとディストリビューション エージェントは、トランザクションの読み取りとコミット操作のバッチ サイズをサポートしています。</span><span class="sxs-lookup"><span data-stu-id="9c052-151">The Log Reader Agent and Distribution Agent support batch sizes for transaction read and commit operations.</span></span> <span data-ttu-id="9c052-152">バッチ サイズの既定値は 500 トランザクションです。</span><span class="sxs-lookup"><span data-stu-id="9c052-152">Batch sizes default to 500 transactions.</span></span> <span data-ttu-id="9c052-153">ログ リーダー エージェントは、レプリケーション用にマークが付けられているかどうかにかかわらず、一定の数のトランザクションをログから読み取ります。</span><span class="sxs-lookup"><span data-stu-id="9c052-153">The Log Reader Agent reads the specific number of transactions from the log, whether or not they are marked for replication.</span></span> <span data-ttu-id="9c052-154">多数のトランザクションがパブリケーション データベースに書き込まれているが、その中のごくわずかなサブセットだけにレプリケーションのマークが付いている場合、 **-ReadBatchSize** パラメーターでログ リーダー エージェントの読み取りバッチ サイズを増やす必要があります。</span><span class="sxs-lookup"><span data-stu-id="9c052-154">When a large number of transactions is written to a publication database, but only a small subset of those are marked for replication, you should use the **-ReadBatchSize** parameter to increase the read batch size of the Log Reader Agent.</span></span> <span data-ttu-id="9c052-155">このパラメーターは、Oracle パブリッシャーには適用されません。</span><span class="sxs-lookup"><span data-stu-id="9c052-155">This parameter does not apply to Oracle Publishers.</span></span>  
  
-   <span data-ttu-id="9c052-156">ディストリビューション エージェントの **-CommitBatchSize** パラメーターの値を大きくする。</span><span class="sxs-lookup"><span data-stu-id="9c052-156">Increase the value of the **-CommitBatchSize** parameter for the Distribution Agent.</span></span>  
  
     <span data-ttu-id="9c052-157">一連のトランザクションをコミットすると、一定のオーバーヘッドが生じます。より多くのトランザクションを、より低い頻度でコミットするほど、オーバーヘッドは多くのデータに分散されます。</span><span class="sxs-lookup"><span data-stu-id="9c052-157">Committing a set of transactions has a fixed overhead; by committing a larger number of transactions less frequently, the overhead is spread across a larger volume of data.</span></span> <span data-ttu-id="9c052-158">しかし、変更を適用するコストは、ログを含むディスクの最大 I/O などのその他の要因によって制限されるため、このパラメーターを大きくする利点は少なくなります。</span><span class="sxs-lookup"><span data-stu-id="9c052-158">However, the benefit of increasing this parameter drops off as the cost of applying changes is gated by other factors, such as the maximum I/O of the disk that contains the log.</span></span> <span data-ttu-id="9c052-159">さらに、検討すべきトレード オフもあります。ディストリビューション エージェントのやり直しの原因となる失敗をすべてロールバックし、多くのトランザクションを再適用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9c052-159">Additionally, there is a trade off to be considered: any failure that causes the Distribution Agent to start over must rollback and reapply a larger number of transactions.</span></span> <span data-ttu-id="9c052-160">信頼性の低いネットワークでは、値を小さくすると失敗が少なくなり、失敗が発生した場合にロールバックおよび再適用するトランザクションの数が減ります。</span><span class="sxs-lookup"><span data-stu-id="9c052-160">For unreliable networks, a lower value can result in less failures and a smaller number of transactions to rollback and reapply if a failure occurs.</span></span>  
  
-   <span data-ttu-id="9c052-161">ログ リーダー エージェントの **-PollingInterval** パラメーターの値を小さくする。</span><span class="sxs-lookup"><span data-stu-id="9c052-161">Decrease the value of the **-PollingInterval** parameter for the Log Reader Agent.</span></span>  
  
     <span data-ttu-id="9c052-162">**-PollingInterval** パラメーターは、トランザクションをレプリケートするために、パブリッシュされたデータベースのトランザクション ログをクエリする頻度を指定します。</span><span class="sxs-lookup"><span data-stu-id="9c052-162">The **-PollingInterval** parameter specifies how often the transaction log of a published database is queried for transactions to replicate.</span></span> <span data-ttu-id="9c052-163">既定値は 5 秒です。</span><span class="sxs-lookup"><span data-stu-id="9c052-163">The default is 5 seconds.</span></span> <span data-ttu-id="9c052-164">この値を小さくすると、ログを呼び出す頻度は高くなります。これにより、パブリケーション データベースからディストリビューション データベースへのトランザクションの配信の待機時間を減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="9c052-164">If you decrease this value, the log is polled more frequently, which can result in lower latency for the delivery of transactions from the publication database to the distribution database.</span></span> <span data-ttu-id="9c052-165">しかし、待機時間を減らす必要性と、照会の頻度が高くなることによるサーバーの負荷の増加とのバランスをとる必要があります。</span><span class="sxs-lookup"><span data-stu-id="9c052-165">However, you should balance the need for lower latency against the increased load on the server from polling more frequently.</span></span>  
  
 <span data-ttu-id="9c052-166">エージェント パラメーターは、エージェント プロファイルおよびコマンド ラインで指定できます。</span><span class="sxs-lookup"><span data-stu-id="9c052-166">Agent parameters can be specified in agent profiles and on the command line.</span></span> <span data-ttu-id="9c052-167">詳細については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9c052-167">For more information, see:</span></span>  
  
-   [<span data-ttu-id="9c052-168">レプリケーション エージェント プロファイルの操作</span><span class="sxs-lookup"><span data-stu-id="9c052-168">Work with Replication Agent Profiles</span></span>](../agents/replication-agent-profiles.md)  
  
-   [<span data-ttu-id="9c052-169">レプリケーション エージェント コマンド プロンプト パラメーターを表示および変更する &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="9c052-169">View and Modify Replication Agent Command Prompt Parameters &#40;SQL Server Management Studio&#41;</span></span>](../agents/view-and-modify-replication-agent-command-prompt-parameters.md)  
  
-   [<span data-ttu-id="9c052-170">Replication Agent Executables Concepts</span><span class="sxs-lookup"><span data-stu-id="9c052-170">Replication Agent Executables Concepts</span></span>](../concepts/replication-agent-executables-concepts.md)  
  
  
