---
title: マージ レプリケーションのバックアップと復元の方式 | Microsoft Docs
ms.custom: ''
ms.date: 03/09/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- recovery [SQL Server replication], merge replication
- backups [SQL Server replication], merge replication
- restoring [SQL Server replication], merge replication
- merge replication [SQL Server replication], backup and restore
ms.assetid: b8ae31c6-d76f-4dd7-8f46-17d023ca3eca
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 45e3259d93af4735569fcb6b6a9c7b9eddd52730
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87736264"
---
# <a name="strategies-for-backing-up-and-restoring-merge-replication"></a><span data-ttu-id="d7214-102">マージ レプリケーションのバックアップと復元の方式</span><span class="sxs-lookup"><span data-stu-id="d7214-102">Strategies for Backing Up and Restoring Merge Replication</span></span>
  <span data-ttu-id="d7214-103">マージ レプリケーションでは、次のデータベースを定期的にバックアップします。</span><span class="sxs-lookup"><span data-stu-id="d7214-103">For merge replication, back up the following databases regularly:</span></span>  
  
-   <span data-ttu-id="d7214-104">パブリッシャーにあるパブリケーション データベース</span><span class="sxs-lookup"><span data-stu-id="d7214-104">The publication database at the Publisher</span></span>   
-   <span data-ttu-id="d7214-105">ディストリビューターにあるディストリビューション データベース</span><span class="sxs-lookup"><span data-stu-id="d7214-105">The distribution database at the Distributor</span></span>    
-   <span data-ttu-id="d7214-106">各サブスクライバーにあるサブスクリプション データベース</span><span class="sxs-lookup"><span data-stu-id="d7214-106">The subscription database at each Subscriber</span></span>    
-   <span data-ttu-id="d7214-107">パブリッシャー、ディストリビューター、およびすべてのサブスクライバーにある **master** および **msdb** システム データベース。</span><span class="sxs-lookup"><span data-stu-id="d7214-107">The **master** and **msdb** system databases at the Publisher, Distributor and all Subscribers.</span></span> <span data-ttu-id="d7214-108">これらのデータベースは、相互に関連するレプリケーション データベースとして、同時にバックアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-108">These databases should be backed up at the same time as each other and the relevant replication database.</span></span> <span data-ttu-id="d7214-109">たとえば、パブリッシャーでパブリケーション データベースをバックアップするときに、 **master** および **msdb** データベースも同時にバックアップします。</span><span class="sxs-lookup"><span data-stu-id="d7214-109">For example, back up the **master** and **msdb** databases at the Publisher at the same time you back up the publication database.</span></span> <span data-ttu-id="d7214-110">パブリケーション データベースを復元するときは、 **master** および **msdb** データベースのレプリケーションの構成と設定が、パブリケーション データベースと一致していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="d7214-110">If the publication database is restored, ensure that the **master** and **msdb** database are consistent with the publication database in terms of replication configuration and settings.</span></span>  
  
 <span data-ttu-id="d7214-111">定期的なログ バックアップを実行する場合は、レプリケーション関連の変更をログ バックアップでキャプチャする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-111">If you perform regular log backups, any replication-related changes should be captured in the log backups.</span></span> <span data-ttu-id="d7214-112">ログ バックアップを実行しない場合は、レプリケーションに関連する設定を変更するたびに、バックアップを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-112">If you don't perform log backups, a backup should be performed whenever a setting relevant to replication is changed.</span></span> <span data-ttu-id="d7214-113">詳細については、「 [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d7214-113">For more information, see [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).</span></span>  
  
 <span data-ttu-id="d7214-114">以下で詳しく説明するパブリケーション データベースのバックアップと復元の方法のいずれかを選択し、ディストリビューション データベースとサブスクリプション データベースに対する推奨事項に従ってください。</span><span class="sxs-lookup"><span data-stu-id="d7214-114">Choose one of the approaches detailed below for backing up and restoring the publication database, and then follow the recommendations listed for the distribution database and subscription databases.</span></span>  
  
## <a name="backing-up-and-restoring-the-publication-database"></a><span data-ttu-id="d7214-115">パブリケーション データベースのバックアップと復元</span><span class="sxs-lookup"><span data-stu-id="d7214-115">Backing Up and Restoring the Publication Database</span></span>  
 <span data-ttu-id="d7214-116">マージ パブリケーション データベースの復元方法は 2 とおりあります。</span><span class="sxs-lookup"><span data-stu-id="d7214-116">There are two approaches to restoring a merge publication database.</span></span> <span data-ttu-id="d7214-117">バックアップからパブリケーション データベースを復元した後に、次のいずれかを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-117">After restoring the publication database from a backup, you should either:</span></span>  
  
-   <span data-ttu-id="d7214-118">パブリケーション データベースとサブスクリプション データベースを同期する。</span><span class="sxs-lookup"><span data-stu-id="d7214-118">Synchronize the publication database with a subscription database.</span></span>  
  
-   <span data-ttu-id="d7214-119">パブリケーション データベースにあるパブリケーションへのすべてのサブスクリプションを再初期化する。</span><span class="sxs-lookup"><span data-stu-id="d7214-119">Reinitialize all subscriptions to the publications in the publication database.</span></span>  
  
 <span data-ttu-id="d7214-120">これらのいずれかの方法を使用すると、復元の実行後にパブリッシャーとすべてのサブスクライバーが同期されます。</span><span class="sxs-lookup"><span data-stu-id="d7214-120">Using either of these methods ensures that after a restore is performed, the Publisher and all Subscribers are synchronized.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="d7214-121">ID 列を含むテーブルを使用している場合は、復元後、正しい ID 範囲を割り当てる必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-121">If any tables contain identity columns, you must ensure the correct identity ranges are assigned after a restore.</span></span> <span data-ttu-id="d7214-122">詳細については、「[Replicate Identity Columns](../publish/replicate-identity-columns.md)」 (ID 列のレプリケート) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d7214-122">For more information, see [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
### <a name="synchronizing-the-publication-database"></a><span data-ttu-id="d7214-123">パブリケーション データベースの同期</span><span class="sxs-lookup"><span data-stu-id="d7214-123">Synchronizing the Publication Database</span></span>  
 <span data-ttu-id="d7214-124">パブリケーション データベースとサブスクリプション データベースを同期すると、パブリケーション データベースで以前に変更され、復元されたバックアップに表示されていない変更を  1 つ以上のサブスクリプション データベースからアップロードできます。</span><span class="sxs-lookup"><span data-stu-id="d7214-124">Synchronizing a publication database with a subscription database allows you to upload from one or more subscription databases those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="d7214-125">アップロードできるデータは、パブリケーションのフィルター選択方法によって次のように異なります。</span><span class="sxs-lookup"><span data-stu-id="d7214-125">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
-   <span data-ttu-id="d7214-126">パブリケーションがフィルター選択されていない場合は、最新のサブスクライバーと同期することでパブリケーション データベースを最新の状態に更新できます。</span><span class="sxs-lookup"><span data-stu-id="d7214-126">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
-   <span data-ttu-id="d7214-127">パブリケーションがフィルター選択されている場合は、パブリケーションを最新の状態に更新できない場合があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-127">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="d7214-128">各サブスクリプションが 1 つの地域の顧客データのみを受信できるようにパーティション分割されているテーブルがあるとします。北、東、南、西のいずれかです。</span><span class="sxs-lookup"><span data-stu-id="d7214-128">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="d7214-129">データの各パーティションに 1 つ以上のサブスクライバーがある場合、各パーティションのサブスクライバーと同期することにより、パブリケーション データベースを最新の状態に更新できます。</span><span class="sxs-lookup"><span data-stu-id="d7214-129">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="d7214-130">ただし、たとえば、西パーティションのデータがすべてのサブスクライバーにレプリケートされていない場合は、パブリッシャーでこのデータを最新の状態に更新することはできません。</span><span class="sxs-lookup"><span data-stu-id="d7214-130">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="d7214-131">パブリケーション データベースとサブスクリプション データベースを同期することによって、復元対象のパブリッシュされたテーブルを、バックアップから復元されたパブリッシュされていないテーブルよりも新しい状態にすることができます。</span><span class="sxs-lookup"><span data-stu-id="d7214-131">Synchronizing a publication database with a subscription database can result in published tables being restored to a point in time that is more recent than the point in time of other non-published tables restored from the backup.</span></span>  
  
 <span data-ttu-id="d7214-132">[!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] よりも前のバージョンの [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]を実行しているサブスクライバーと同期する場合は、サブスクリプションを匿名にすることはできません。このサブスクリプションはクライアント サブスクリプションまたはサーバー サブスクリプション (以前のリリースではローカル サブスクリプションとグローバル サブスクリプションと呼ばれていました) にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-132">If you synchronize with a Subscriber that is running a version of [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prior to [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span>  
  
 <span data-ttu-id="d7214-133">サブスクリプションを同期するには、「 [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) 」および「 [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d7214-133">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
### <a name="reinitializing-all-subscriptions"></a><span data-ttu-id="d7214-134">すべてのサブスクリプションの再初期化</span><span class="sxs-lookup"><span data-stu-id="d7214-134">Reinitializing all Subscriptions</span></span>  
 <span data-ttu-id="d7214-135">すべてのサブスクリプションを再初期化すると、すべてのサブスクライバーを、復元されたパブリケーション データベースと一貫性のある状態に保つことができます。</span><span class="sxs-lookup"><span data-stu-id="d7214-135">Reinitializing all subscriptions ensures all Subscribers are in a state consistent with the restored publication database.</span></span> <span data-ttu-id="d7214-136">特定のパブリケーション データベースのバックアップで再現される、以前の状態にトポロジ全体を戻す場合は、この方法を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-136">This approach should be used if you want to return an entire topology to the previous state represented by a given publication database backup.</span></span> <span data-ttu-id="d7214-137">たとえば、誤って実行したバッチ操作から復旧するメカニズムとして、パブリケーション データベースをより古い時点に復元する場合に、すべてのサブスクリプションを再初期化することができます。</span><span class="sxs-lookup"><span data-stu-id="d7214-137">For example, you might want to reinitialize all subscriptions if you are restoring a publication database to an earlier point in time as a mechanism to recover from an erroneously performed batch operation.</span></span>  
  
 <span data-ttu-id="d7214-138">このオプションを選択する場合には、パブリケーション データベースを復元した直後に、再初期化されたサブスクライバーに配信するための新しいスナップショットを生成します。</span><span class="sxs-lookup"><span data-stu-id="d7214-138">If you choose this option, generate a new snapshot for delivery to reinitialized Subscribers immediately after restoring your publication database.</span></span>  
  
 <span data-ttu-id="d7214-139">サブスクリプションを再初期化するには、「 [Reinitialize a Subscription](../reinitialize-a-subscription.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d7214-139">To reinitialize a subscription, see [Reinitialize a Subscription](../reinitialize-a-subscription.md).</span></span>  
  
 <span data-ttu-id="d7214-140">スナップショットを作成および適用するには、「 [Create 」および「 Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md) 」および「 [Create a Snapshot for a Merge Publication with Parameterized Filters](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d7214-140">To create and apply a snapshot, see [Create and Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md) and [Create a Snapshot for a Merge Publication with Parameterized Filters](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md).</span></span>  
  
## <a name="backing-up-and-restoring-the-distribution-database"></a><span data-ttu-id="d7214-141">ディストリビューション データベースのバックアップと復元</span><span class="sxs-lookup"><span data-stu-id="d7214-141">Backing Up and Restoring the Distribution Database</span></span>  
 <span data-ttu-id="d7214-142">マージ レプリケーションでは、ディストリビューション データベースを定期的にバックアップする必要があります。この場合、使用されるバックアップがディストリビューターを使用するすべてのパブリケーションの最短の保有期間よりも古くない限り、特に注意することなく復元できます。</span><span class="sxs-lookup"><span data-stu-id="d7214-142">With merge replication, the distribution database should be backed up regularly, and can be restored without any special considerations as long as the backup used is no older than the shortest retention period of all publications that use the Distributor.</span></span> <span data-ttu-id="d7214-143">たとえば、保有期間がそれぞれ 10、20、および 30 日に設定されている 3 つのパブリケーションがある場合は、10 日より長く経過したバックアップはデータベースの復元に使用できません。</span><span class="sxs-lookup"><span data-stu-id="d7214-143">For example, if there are three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span> <span data-ttu-id="d7214-144">マージ レプリケーションでは、ディストリビューション データベースの役割が制限されています。変更の追跡に使用されるすべてのデータは保存されず、トランザクション レプリケーションのような、サブスクリプション データベースの転送先となるマージ レプリケーションの変更の一時的な保存場所も用意されません。</span><span class="sxs-lookup"><span data-stu-id="d7214-144">The distribution database has a limited role in merge replication: it does not store any data used in change tracking and it does not provide temporary storage of merge replication changes to be forwarded to subscription databases (as it does in transactional replication).</span></span>  
  
## <a name="backing-up-and-restoring-a-subscription-database"></a><span data-ttu-id="d7214-145">サブスクリプション データベースのバックアップと復元</span><span class="sxs-lookup"><span data-stu-id="d7214-145">Backing Up and Restoring a Subscription Database</span></span>  
 <span data-ttu-id="d7214-146">サブスクリプション データベースを正常に復元するためには、サブスクライバーとパブリッシャーを同期してから、サブスクリプション データベースをバックアップする必要があります。また、サブスクリプション データベースの復元後にも同期を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-146">To ensure successful recovery of a subscription database, Subscribers should synchronize with the Publisher before the subscription database is backed up; they should also synchronize after the subscription database is restored:</span></span>  
  
-   <span data-ttu-id="d7214-147">サブスクリプション データベースのバックアップの前にパブリッシャーと同期することにより、サブスクライバーをバックアップから復元した場合に、サブスクリプションをパブリケーションの保有期間内の状態に保つことができます。</span><span class="sxs-lookup"><span data-stu-id="d7214-147">Synchronizing with the Publisher before a subscription database backup helps ensure that if a Subscriber is restored from backup, the subscription is still within the publication retention period.</span></span> <span data-ttu-id="d7214-148">たとえば、保有期間が 10 日間に設定されているパブリケーションがあるとします。</span><span class="sxs-lookup"><span data-stu-id="d7214-148">For example, assume a publication with a retention period of 10 days.</span></span> <span data-ttu-id="d7214-149">最後の同期が 8 日前で、現在バックアップが実行されています。</span><span class="sxs-lookup"><span data-stu-id="d7214-149">The last synchronization was 8 days ago, and now the backup is performed.</span></span> <span data-ttu-id="d7214-150">4 日後にバックアップが復元されると、最後の同期は 12 日前に行われたことになり、保有期間は過ぎてしまいます。</span><span class="sxs-lookup"><span data-stu-id="d7214-150">If the backup is restored 4 days later, the last synchronization will have occurred 12 days ago, which is past the retention period.</span></span> <span data-ttu-id="d7214-151">この場合は、サブスクライバーを再初期化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d7214-151">In this case, you would have to reinitialize the Subscriber.</span></span> <span data-ttu-id="d7214-152">バックアップの前にサブスクライバーを同期しておくと、サブスクリプション データベースを保有期間内の状態に保つことができます。</span><span class="sxs-lookup"><span data-stu-id="d7214-152">If the Subscriber had synchronized before the backup, the subscription database would be within the retention period.</span></span>  
  
     <span data-ttu-id="d7214-153">サブスクライバーがサブスクライブするすべてのパブリケーションの最短の保有期間よりも古いバックアップは使用できません。</span><span class="sxs-lookup"><span data-stu-id="d7214-153">The backup should be no older than the shortest retention period of all publications to which the Subscriber subscribes.</span></span> <span data-ttu-id="d7214-154">たとえば、保有期間がそれぞれ 10、20、および 30 日に設定されている 3 つのパブリケーションをサブスクライバーがサブスクライブする場合、10 日より長く経過したバックアップはデータベースの復元に使用できません。</span><span class="sxs-lookup"><span data-stu-id="d7214-154">For example, if a Subscriber subscribes to three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span>  
  
-   <span data-ttu-id="d7214-155">復元後にサブスクリプション データベースとそれぞれのパブリケーションを同期すると、パブリッシャーのすべての変更を含む最新の状態にサブスクライバーを保つことができます。</span><span class="sxs-lookup"><span data-stu-id="d7214-155">Synchronizing the subscription database with each of its publications following a restore ensures that the Subscriber is up to date with all changes at the Publisher.</span></span>  
  
 <span data-ttu-id="d7214-156">パブリケーションの保有期間を設定する場合は、「[サブスクリプションの有効期限の設定](../publish/set-the-expiration-period-for-subscriptions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d7214-156">To set the publication retention period, see [Set the Expiration Period for Subscriptions](../publish/set-the-expiration-period-for-subscriptions.md).</span></span>  
  
 <span data-ttu-id="d7214-157">サブスクリプションを同期するには、「 [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) 」および「 [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d7214-157">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
## <a name="backing-up-and-restoring-a-republishing-database"></a><span data-ttu-id="d7214-158">再パブリッシュ データベースのバックアップと復元</span><span class="sxs-lookup"><span data-stu-id="d7214-158">Backing Up and Restoring a Republishing Database</span></span>  
 <span data-ttu-id="d7214-159">あるデータベースがパブリッシャーからのデータをサブスクライブしてから、同じデータを別のサブスクリプション データベースにパブリッシュするとき、このデータベースのことを再パブリッシュ データベースと言います。</span><span class="sxs-lookup"><span data-stu-id="d7214-159">When a database subscribes to data from a Publisher and in turn publishes that same data to other subscription databases, it is referred to as a republishing database.</span></span> <span data-ttu-id="d7214-160">再パブリッシュ データベースを復元する場合は、このトピックの「パブリケーション データベースのバックアップと復元」および「サブスクリプション データベースのバックアップと復元」で説明されているガイドラインに従ってください。</span><span class="sxs-lookup"><span data-stu-id="d7214-160">When restoring a republishing database, follow the guidelines described in "Backing Up and Restoring a Publication Database" and "Backing Up and Restoring a Subscription Database" in this topic.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d7214-161">参照</span><span class="sxs-lookup"><span data-stu-id="d7214-161">See Also</span></span>  
 <span data-ttu-id="d7214-162">[SQL Server データベースのバックアップと復元](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="d7214-162">[Back Up and Restore of SQL Server Databases](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span></span>  
 [<span data-ttu-id="d7214-163">レプリケートされたデータベースのバックアップと復元</span><span class="sxs-lookup"><span data-stu-id="d7214-163">Back Up and Restore Replicated Databases</span></span>](back-up-and-restore-replicated-databases.md)  
  
  
