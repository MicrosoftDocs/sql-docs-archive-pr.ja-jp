---
title: データベース チェックポイント (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 10/13/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- automatic checkpoints
- transaction logs [SQL Server], checkpoints
- logs [SQL Server], active
- pages [SQL Server], dirty
- MinLSN
- checkpoints [SQL Server]
- pages [SQL Server], flushing
- dirty pages
- transaction logs [SQL Server], active logs
- recovery interval option [SQL Server]
- buffer cache [SQL Server]
- logs [SQL Server], checkpoints
- Minimum Recovery LSN
- flushing pages
- active logs
ms.assetid: 98a80238-7409-4708-8a7d-5defd9957185
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 5776d4a23223637c50ac40098fa44342d5cd94a9
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87639505"
---
# <a name="database-checkpoints-sql-server"></a><span data-ttu-id="2c447-102">データベース チェックポイント (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="2c447-102">Database Checkpoints (SQL Server)</span></span>
  <span data-ttu-id="2c447-103">このトピックでは、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のデータベース チェックポイントについて概説します。</span><span class="sxs-lookup"><span data-stu-id="2c447-103">This topic provides an overview of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database checkpoints.</span></span> <span data-ttu-id="2c447-104">*チェックポイント* によって、予期しないシャットダウンやクラッシュの後の復旧中に、ログに格納されている変更を [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] が適用するための最適なポイントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-104">A *checkpoint* creates a known good point from which the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] can start applying changes contained in the log during recovery after an unexpected shutdown or crash.</span></span>  
  
  
##  <a name="overview-of-checkpoints"></a><a name="Overview"></a><span data-ttu-id="2c447-105">チェックポイントの概要</span><span class="sxs-lookup"><span data-stu-id="2c447-105">Overview of Checkpoints</span></span>  
 <span data-ttu-id="2c447-106">パフォーマンス向上のため、[!INCLUDE[ssDE](../../includes/ssde-md.md)] では、メモリ (バッファー キャッシュ) にあるデータベース ページが変更されるようになり、ページが変更されるたびにディスクに書き込まれることはなくなりました。</span><span class="sxs-lookup"><span data-stu-id="2c447-106">For performance reasons, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] performs modifications to database pages in memory-in the buffer cache-and does not write these pages to disk after every change.</span></span> <span data-ttu-id="2c447-107">また、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] では定期的に各データベースにチェックポイントが発行されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-107">Rather, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] periodically issues a checkpoint on each database.</span></span> <span data-ttu-id="2c447-108">*チェックポイント* では、現在メモリにある修正ページ (つまり *ダーティ ページ*) とトランザクション ログ情報がメモリからディスクに書き込まれ、トランザクション ログの情報も記録されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-108">A *checkpoint* writes the current in-memory modified pages (known as *dirty pages*) and transaction log information from memory to disk and, also, records information about the transaction log.</span></span>  
  
 <span data-ttu-id="2c447-109">[!INCLUDE[ssDE](../../includes/ssde-md.md)] では、自動、間接、手動、および内部といったチェックポイントの種類がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="2c447-109">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] supports several types of checkpoints: automatic, indirect, manual, and internal.</span></span> <span data-ttu-id="2c447-110">次の表は、チェックポイントの種類をまとめたものです。</span><span class="sxs-lookup"><span data-stu-id="2c447-110">The following table summarizes the types of checkpoints.</span></span>  
  
|<span data-ttu-id="2c447-111">名前</span><span class="sxs-lookup"><span data-stu-id="2c447-111">Name</span></span>|[!INCLUDE[tsql](../../includes/tsql-md.md)] <span data-ttu-id="2c447-112">インターフェイス</span><span class="sxs-lookup"><span data-stu-id="2c447-112">Interface</span></span>|<span data-ttu-id="2c447-113">説明</span><span class="sxs-lookup"><span data-stu-id="2c447-113">Description</span></span>|  
|----------|----------------------------------|-----------------|  
|<span data-ttu-id="2c447-114">自動</span><span class="sxs-lookup"><span data-stu-id="2c447-114">Automatic</span></span>|<span data-ttu-id="2c447-115">EXEC sp_configure **' `recovery interval` '、' *`seconds`* '**</span><span class="sxs-lookup"><span data-stu-id="2c447-115">EXEC sp_configure **'`recovery interval`','*`seconds`*'**</span></span>|<span data-ttu-id="2c447-116">サーバー構成オプションによって提案された上限時間を満たすために、バックグラウンドで自動的に発行さ `recovery interval` れます。</span><span class="sxs-lookup"><span data-stu-id="2c447-116">Issued automatically in the background to meet the upper time limit suggested by the `recovery interval` server configuration option.</span></span> <span data-ttu-id="2c447-117">自動チェックポイントは、最後まで実行されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-117">Automatic checkpoints run to completion.</span></span>  <span data-ttu-id="2c447-118">自動チェックポイントは、未処理の書き込み数と、20 ミリ秒を超える書き込み待機時間の上昇を [!INCLUDE[ssDE](../../includes/ssde-md.md)] が検出したかどうかに応じて調整されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-118">Automatic checkpoints are throttled based on the number of outstanding writes and whether the [!INCLUDE[ssDE](../../includes/ssde-md.md)] detects an increase in write latency above 20 milliseconds.</span></span><br /><br /> <span data-ttu-id="2c447-119">詳細については、「 [recovery interval サーバー構成オプションの構成](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2c447-119">For more information, see [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).</span></span>|  
|<span data-ttu-id="2c447-120">間接</span><span class="sxs-lookup"><span data-stu-id="2c447-120">Indirect</span></span>|<span data-ttu-id="2c447-121">データベースの変更...TARGET_RECOVERY_TIME **=** _target_recovery_time_ {SECONDS &#124; MINUTES} を設定します</span><span class="sxs-lookup"><span data-stu-id="2c447-121">ALTER DATABASE ... SET TARGET_RECOVERY_TIME **=**_target_recovery_time_ { SECONDS &#124; MINUTES }</span></span>|<span data-ttu-id="2c447-122">所定のデータベースのユーザーが指定したターゲット復旧時間に合わせて、バック グラウンドで発行されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-122">Issued in the background to meet a user-specified target recovery time for a given database.</span></span> <span data-ttu-id="2c447-123">既定のターゲット復旧時間は 0 です。この場合、自動チェックポイント ヒューリスティックがデータベースで使用されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-123">The default target recovery time is 0, which causes automatic checkpoint heuristics to be used on the database.</span></span> <span data-ttu-id="2c447-124">ALTER DATABASE を使用して TARGET_RECOVERY_TIME を >0 に設定した場合、サーバー インスタンスに指定された復旧間隔ではなく、この値が使用されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-124">If you have used ALTER DATABASE to set TARGET_RECOVERY_TIME to >0, this value is used, rather than the recovery interval specified for the server instance.</span></span><br /><br /> <span data-ttu-id="2c447-125">詳細については、「 [データベースのターゲットの復旧時間の変更 &#40;SQL Server&#41;](change-the-target-recovery-time-of-a-database-sql-server.md)サーバー構成オプションを構成する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="2c447-125">For more information, see [Change the Target Recovery Time of a Database &#40;SQL Server&#41;](change-the-target-recovery-time-of-a-database-sql-server.md).</span></span>|  
|<span data-ttu-id="2c447-126">マニュアル</span><span class="sxs-lookup"><span data-stu-id="2c447-126">Manual</span></span>|<span data-ttu-id="2c447-127">CHECKPOINT [ *checkpoint_duration* ]</span><span class="sxs-lookup"><span data-stu-id="2c447-127">CHECKPOINT [ *checkpoint_duration* ]</span></span>|<span data-ttu-id="2c447-128">[!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT コマンドを実行すると発行されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-128">Issued when you execute a [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT command.</span></span> <span data-ttu-id="2c447-129">接続している現在のデータベースで手動チェックポイントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-129">The manual checkpoint occurs in the current database for your connection.</span></span> <span data-ttu-id="2c447-130">既定では、手動のチェックポイントは最後まで実行されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-130">By default, manual checkpoints run to completion.</span></span> <span data-ttu-id="2c447-131">調整は自動チェックポイントの場合と同様に行われます。</span><span class="sxs-lookup"><span data-stu-id="2c447-131">Throttling works the same way as for automatic checkpoints.</span></span>  <span data-ttu-id="2c447-132">必要に応じて、 *checkpoint_duration* パラメーターを使用し、チェックポイントを完了するのに必要な時間を秒単位で指定します。</span><span class="sxs-lookup"><span data-stu-id="2c447-132">Optionally, the *checkpoint_duration* parameter specifies a requested amount of time, in seconds, for the checkpoint to complete.</span></span><br /><br /> <span data-ttu-id="2c447-133">詳細については、「 [CHECKPOINT &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/checkpoint-transact-sql)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2c447-133">For more information, see [CHECKPOINT &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/checkpoint-transact-sql).</span></span>|  
|<span data-ttu-id="2c447-134">内部</span><span class="sxs-lookup"><span data-stu-id="2c447-134">Internal</span></span>|<span data-ttu-id="2c447-135">[なし] :</span><span class="sxs-lookup"><span data-stu-id="2c447-135">None.</span></span>|<span data-ttu-id="2c447-136">ディスク イメージがログの現在の状態と一致することを保証するために、バックアップやデータベース スナップショット作成など、さまざまなサーバー操作によって発行されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-136">Issued by various server operations such as backup and database-snapshot creation to guarantee that disk images match the current state of the log.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="2c447-137">一部の種類のチェックポイントでは、データベース管理者が `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] の詳細設定オプションを使用して、I/O サブシステムのスループットに基づいてチェックポイントの I/O 動作を調整できます。</span><span class="sxs-lookup"><span data-stu-id="2c447-137">The `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] advanced setup option enables a database administrator to throttle checkpoint I/O behavior based on the throughput of the I/O subsystem for some types of checkpoints.</span></span> <span data-ttu-id="2c447-138">`-k`セットアップオプションは、自動チェックポイントに適用されます。それ以外の場合は、手動チェックポイントと内部チェックポイント抑制に適用されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-138">The `-k` setup option applies to automatic checkpoints and any otherwise unthrottled manual and internal checkpoints.</span></span>  
  
 <span data-ttu-id="2c447-139">自動チェックポイント、手動チェックポイント、および内部チェックポイントでは、データベース復旧中にロールフォワードする必要があるのは、最新チェックポイントの後で行われた修正のみです。</span><span class="sxs-lookup"><span data-stu-id="2c447-139">For automatic, manual, and internal checkpoints, only modifications made after the latest checkpoint need to be rolled forward during database recovery.</span></span> <span data-ttu-id="2c447-140">これにより、データベースの復旧にかかる時間が短縮されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-140">This reduces the time required to recover a database.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="2c447-141">実行時間の長い、コミットされていないトランザクションがあると、すべての種類のチェックポイントで復旧時間が長くなります。</span><span class="sxs-lookup"><span data-stu-id="2c447-141">Long-running uncommitted transactions increase recovery time for all types of checkpoints.</span></span>  
  
  
  
###  <a name="interaction-of-the-target_recovery_time-and-recovery-interval-options"></a><a name="InteractionBwnSettings"></a> <span data-ttu-id="2c447-142">TARGET_RECOVERY_TIME オプションと 'recovery interval' オプションの相互作用</span><span class="sxs-lookup"><span data-stu-id="2c447-142">Interaction of the TARGET_RECOVERY_TIME and 'recovery interval' Options</span></span>  
 <span data-ttu-id="2c447-143">次の表は、サーバー全体の**sp_configure ' `recovery interval` '** 設定とデータベース固有の ALTER database の相互作用をまとめたものです。TARGET_RECOVERY_TIME 設定です。</span><span class="sxs-lookup"><span data-stu-id="2c447-143">The following table summarizes the interaction between the server-wide **sp_configure'`recovery interval`'** setting and the database-specific ALTER DATABASE ... TARGET_RECOVERY_TIME setting.</span></span>  
  
|<span data-ttu-id="2c447-144">target_recovery_time</span><span class="sxs-lookup"><span data-stu-id="2c447-144">TARGET_RECOVERY_TIME</span></span>|<span data-ttu-id="2c447-145">'recovery interval'</span><span class="sxs-lookup"><span data-stu-id="2c447-145">'recovery interval'</span></span>|<span data-ttu-id="2c447-146">使用されるチェックポイントの種類</span><span class="sxs-lookup"><span data-stu-id="2c447-146">Type of Checkpoint Used</span></span>|  
|----------------------------|-------------------------|-----------------------------|  
|<span data-ttu-id="2c447-147">0</span><span class="sxs-lookup"><span data-stu-id="2c447-147">0</span></span>|<span data-ttu-id="2c447-148">0</span><span class="sxs-lookup"><span data-stu-id="2c447-148">0</span></span>|<span data-ttu-id="2c447-149">ターゲット復旧間隔が 1 分の自動チェックポイント</span><span class="sxs-lookup"><span data-stu-id="2c447-149">automatic checkpoints whose target recovery interval is 1 minute.</span></span>|  
|<span data-ttu-id="2c447-150">0</span><span class="sxs-lookup"><span data-stu-id="2c447-150">0</span></span>|<span data-ttu-id="2c447-151">>0</span><span class="sxs-lookup"><span data-stu-id="2c447-151">>0</span></span>|<span data-ttu-id="2c447-152">ターゲット復旧間隔が **sp_configurerecovery interval** オプションのユーザー定義設定によって指定されている自動チェックポイント。</span><span class="sxs-lookup"><span data-stu-id="2c447-152">Automatic checkpoints whose target recovery interval is specified by the user defined setting of the **sp_configurerecovery interval** option.</span></span>|  
|<span data-ttu-id="2c447-153">>0</span><span class="sxs-lookup"><span data-stu-id="2c447-153">>0</span></span>|<span data-ttu-id="2c447-154">適用不可。</span><span class="sxs-lookup"><span data-stu-id="2c447-154">Not applicable.</span></span>|<span data-ttu-id="2c447-155">復旧時間が TARGET_RECOVERY_TIME 設定 (秒単位) によって設定されている間接チェックポイント ターゲット</span><span class="sxs-lookup"><span data-stu-id="2c447-155">Indirect checkpoints whose target recovery time is determined by the TARGET_RECOVERY_TIME setting, expressed in seconds.</span></span>|  
  
###  <a name="automatic-checkpoints"></a><a name="AutomaticChkpt"></a><span data-ttu-id="2c447-156">自動チェックポイント</span><span class="sxs-lookup"><span data-stu-id="2c447-156">Automatic Checkpoints</span></span>  
 <span data-ttu-id="2c447-157">自動チェックポイントは、ログレコードの数が、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] サーバー構成オプションで指定された時間内に処理できると推定した数に達したときに発生し `recovery interval` ます。</span><span class="sxs-lookup"><span data-stu-id="2c447-157">An automatic checkpoint occurs each time that  the number of log records reaches the number the [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates it can process during the time specified in the `recovery interval` server configuration option.</span></span> <span data-ttu-id="2c447-158">ユーザー定義のターゲット復旧時間が設定されていないすべてのデータベースでは、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] によって自動チェックポイントが生成されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-158">In every database without a user-defined target recovery time, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] generates automatic checkpoints.</span></span> <span data-ttu-id="2c447-159">自動チェックポイントの頻度は、サーバーの詳細構成オプションによって異なり `recovery interval` ます。このオプションは、システムの再起動時に、特定のサーバーインスタンスがデータベースの復旧に使用する最長時間を指定します。</span><span class="sxs-lookup"><span data-stu-id="2c447-159">The frequency of automatic checkpoints depends on the `recovery interval` advanced server configuration option, which specifies the maximum time that a given server instance should use to recover a database during a system restart.</span></span> <span data-ttu-id="2c447-160">[!INCLUDE[ssDE](../../includes/ssde-md.md)] は、復旧間隔内に処理できるログ レコードの最大数を推定します。</span><span class="sxs-lookup"><span data-stu-id="2c447-160">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates the maximum number of log records it can process within the recovery interval.</span></span> <span data-ttu-id="2c447-161">自動チェックポイントを使用するデータベースのログ レコードが最大数に達すると、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] によってデータベースでチェックポイントが発行されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-161">When a database that is using automatic checkpoints reaches this maximum number of log records, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] issues an checkpoint on the database.</span></span> <span data-ttu-id="2c447-162">自動チェックポイントの作成間隔は大幅に変わります。</span><span class="sxs-lookup"><span data-stu-id="2c447-162">The time interval between automatic checkpoints can be highly variable.</span></span> <span data-ttu-id="2c447-163">相当量のトランザクション ワークロードがあるデータベースでは、主に読み取り専用操作で使用されるデータベースよりもチェックポイントの作成回数が多くなります。</span><span class="sxs-lookup"><span data-stu-id="2c447-163">A database with a substantial transaction workload will have more frequent checkpoints than a database that is used primarily for read-only operations.</span></span>  
  
 <span data-ttu-id="2c447-164">また、単純復旧モデルの場合、ログが全体の 70% に達すると自動チェックポイントもキューに登録されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-164">Also, under the simple recovery model, an automatic checkpoint is also queued if the log becomes 70 percent full.</span></span>  
  
 <span data-ttu-id="2c447-165">単純復旧モデルでは、ログ トランザクションが何かの要因によって遅れていない限り、自動チェックポイントにより、トランザクション ログの未使用のセクションが切り捨てられます。</span><span class="sxs-lookup"><span data-stu-id="2c447-165">Under the simple recovery model, unless some factor is delaying log truncation, an automatic checkpoint truncates the unused section of the transaction log.</span></span> <span data-ttu-id="2c447-166">反対に、完全復旧モデルおよび一括ログ復旧モデルでは、ログ バックアップ チェーンが確立されると、自動チェックポイントによるログの切り捨ては行われなくなります。</span><span class="sxs-lookup"><span data-stu-id="2c447-166">In contrast, under the full and bulk-logged recovery models, once a log backup chain has been established, automatic checkpoints do not cause log truncation.</span></span> <span data-ttu-id="2c447-167">詳細については、「 [トランザクション ログ &#40;SQL Server&#41;](the-transaction-log-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2c447-167">For more information, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="2c447-168">システム障害の後で所定のデータベースの復旧に必要な時間は、障害発生時点でのダーティ ページを再実行するために必要なランダム I/O の容量に大きく依存します。</span><span class="sxs-lookup"><span data-stu-id="2c447-168">After a system crash, the length of time required to recover a given database is largely dependent on the amount of random I/O needed to redo pages that were dirty at the time of the crash.</span></span> <span data-ttu-id="2c447-169">これは、 `recovery interval` 設定が信頼できないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="2c447-169">This means that the `recovery interval` setting is unreliable.</span></span> <span data-ttu-id="2c447-170">正確な復旧間隔がわかりません。</span><span class="sxs-lookup"><span data-stu-id="2c447-170">It cannot determine an accurate recovery duration.</span></span> <span data-ttu-id="2c447-171">さらに、自動チェックポイントの進行中に、データの一般的な I/O アクティビティが急に著しく増加します。</span><span class="sxs-lookup"><span data-stu-id="2c447-171">Furthermore, when an automatic checkpoint is in progress, the general I/O activity for data increases significantly and quite unpredictably.</span></span>  
  
  
####  <a name="impact-of-recovery-interval-on-recovery-performance"></a><a name="PerformanceImpact"></a><span data-ttu-id="2c447-172">復旧パフォーマンスに対する復旧間隔の影響</span><span class="sxs-lookup"><span data-stu-id="2c447-172">Impact of Recovery Interval on Recovery Performance</span></span>  
 <span data-ttu-id="2c447-173">短期トランザクションを使用するオンライントランザクション処理 (OLTP) システムで `recovery interval` は、復旧時間を決定する主な要因となります。</span><span class="sxs-lookup"><span data-stu-id="2c447-173">For an online transaction processing (OLTP) system using short transactions, `recovery interval` is the primary factor determining recovery time.</span></span> <span data-ttu-id="2c447-174">ただし、この `recovery interval` オプションは、実行時間の長いトランザクションを元に戻すために必要な時間には影響しません。</span><span class="sxs-lookup"><span data-stu-id="2c447-174">However, the `recovery interval` option does not affect the time required to undo a long-running transaction.</span></span> <span data-ttu-id="2c447-175">実行時間の長いトランザクションを含むデータベースの復旧には、オプションで指定されているよりもかなり長い時間がかかることが `recovery interval` あります。</span><span class="sxs-lookup"><span data-stu-id="2c447-175">Recovery of a database with a long-running transaction can take much longer than the specified in the `recovery interval` option.</span></span> <span data-ttu-id="2c447-176">たとえば、実行時間の長いトランザクションが、サーバーインスタンスが無効になる前に更新を実行するのに2時間かかった場合、 `recovery interval` 長いトランザクションを復旧するために、実際の復旧時間は値よりも大幅に長くなります。</span><span class="sxs-lookup"><span data-stu-id="2c447-176">For example, if a long-running transaction took two hours to perform updates before the server instance became disabled, the actual recovery takes considerably longer than the `recovery interval` value to recover the long transaction.</span></span> <span data-ttu-id="2c447-177">実行時間が長いトランザクションの復旧時間への影響の詳細については、「 [トランザクション ログ &#40;SQL Server&#41;](the-transaction-log-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2c447-177">For more information about the impact of a long running transaction on recovery time, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="2c447-178">通常は、既定値によって復旧の最適なパフォーマンスが得られます。</span><span class="sxs-lookup"><span data-stu-id="2c447-178">Typically, the default values provides optimal recovery performance.</span></span> <span data-ttu-id="2c447-179">ただし、次のような状況では recovery interval を変更するとパフォーマンスが向上する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2c447-179">However, changing the recovery interval might improve performance in the following circumstances:</span></span>  
  
-   <span data-ttu-id="2c447-180">実行時間の長いトランザクションがロールバックされていないのに、復旧にかかる時間が常に 1 分を超える場合</span><span class="sxs-lookup"><span data-stu-id="2c447-180">If recovery routinely takes significantly longer than 1 minute when long-running transactions are not being rolled back.</span></span>  
  
-   <span data-ttu-id="2c447-181">チェックポイントの回数が多いためにデータベースのパフォーマンスが損なわれていると判断できる場合</span><span class="sxs-lookup"><span data-stu-id="2c447-181">If you notice that frequent checkpoints are impairing performance on a database.</span></span>  
  
 <span data-ttu-id="2c447-182">`recovery interval` 設定を長くする場合には、少しずつ値を増やして、そのたびに復旧のパフォーマンスへの影響を評価することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="2c447-182">If you decide to increase the `recovery interval` setting, we recommend increasing it gradually by small increments and evaluating the effect of each incremental increase on recovery performance.</span></span> <span data-ttu-id="2c447-183">この方法は、設定が増えるにつれて `recovery interval` 、データベースの復旧にかかる時間が長くなるため、重要です。</span><span class="sxs-lookup"><span data-stu-id="2c447-183">This approach is important because as the `recovery interval` setting increases, database recovery takes that many times longer to complete.</span></span> <span data-ttu-id="2c447-184">たとえば、10を変更した場合、 `recovery interval` `recovery interval` が0に設定されている場合、復旧にかかる時間は約10倍になります。</span><span class="sxs-lookup"><span data-stu-id="2c447-184">For example, if you change `recovery interval` 10, recovery takes approximately 10 times longer to complete than when `recovery interval` is set to zero.</span></span>  
  
  
###  <a name="indirect-checkpoints"></a><a name="IndirectChkpt"></a><span data-ttu-id="2c447-185">間接チェックポイント</span><span class="sxs-lookup"><span data-stu-id="2c447-185">Indirect Checkpoints</span></span>  
 <span data-ttu-id="2c447-186">[!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]に新たに導入された間接チェックポイントは、自動チェックポイントの代わりに使用できる、構成可能なデータベース レベルのチェックポイントです。</span><span class="sxs-lookup"><span data-stu-id="2c447-186">Indirect checkpoints, new in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], provide a configurable database-level alternative to automatic checkpoints.</span></span> <span data-ttu-id="2c447-187">間接チェックポイントでは、自動チェックポイントに比べて、システム障害時の復旧時間が短く、予測可能です。</span><span class="sxs-lookup"><span data-stu-id="2c447-187">In the event of a system crash, indirect checkpoints provide potentially faster, more predictable recovery time than automatic checkpoints.</span></span> <span data-ttu-id="2c447-188">間接チェックポイントには次の利点があります。</span><span class="sxs-lookup"><span data-stu-id="2c447-188">Indirect checkpoints offer the following advantages:</span></span>  
  
-   <span data-ttu-id="2c447-189">間接チェックポイントが構成されたデータベースでオンライン トランザクション ワークロードが生じると、パフォーマンスが低下することがあります。</span><span class="sxs-lookup"><span data-stu-id="2c447-189">An online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="2c447-190">間接チェックポイントは、ターゲットの復旧時間内でデータベースの回復が完了するように、ダーティ ページの数が特定のしきい値を下回るようにします。</span><span class="sxs-lookup"><span data-stu-id="2c447-190">Indirect checkpoints make sure that the number of dirty pages are below a certain threshold so that the database recovery completes within the target recovery time.</span></span> <span data-ttu-id="2c447-191">復旧間隔構成オプションは、ダーティ ページ数を使用する間接チェックポイントとは異なり、トランザクション数を使用して復旧時間を決定します。</span><span class="sxs-lookup"><span data-stu-id="2c447-191">The recovery interval configuration option uses the number of transactions to determine the recovery time as opposed to indirect checkpoints which makes use of number of dirty pages.</span></span> <span data-ttu-id="2c447-192">DML 操作の受信数が多いデータベースで間接チェックポイントが有効な場合、バックグラウンド ライターは積極的にディスクにダーティ バッファーのフラッシュを開始し、回復を実行するのに必要な時間をデータベースのターゲット復旧時間内にすることができます。</span><span class="sxs-lookup"><span data-stu-id="2c447-192">When indirect checkpoints are enabled on a database receiving a large number of DML operations, the background writer can start aggressively flushing dirty buffers to disk to ensure that the time required to perform recovery is within the target recovery time set of the database.</span></span> <span data-ttu-id="2c447-193">これにより、ディスクのサブシステムが I/O のしきい値よりも高い動作をするかまたはその値に近づいた場合、パフォーマンス ボトルネックの原因となる追加の I/O アクティビティが特定のシステムで発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2c447-193">This can cause additional I/O activity on certain systems which can contribute to a performance bottleneck if the disk subsystem is operating above or nearing the I/O threshold.</span></span>  
  
-   <span data-ttu-id="2c447-194">間接チェックポイントを使用すると、REDO 時のランダム I/O のコストを計算に入れて、データベースの復旧時間を確実に制御できます。</span><span class="sxs-lookup"><span data-stu-id="2c447-194">Indirect checkpoints enable you to reliably control database recovery time by factoring in the cost of random I/O during REDO.</span></span> <span data-ttu-id="2c447-195">このため、所定のデータベースで、復旧時にサーバー インスタンスが上限内にとどまることができます (実行時間の長いトランザクションによって過度の UNDO 回数が生じる場合以外)。</span><span class="sxs-lookup"><span data-stu-id="2c447-195">This enables a server instance to stay within an upper-bound on recovery times for a given database (except when a long-running transaction causes excessive UNDO times).</span></span>  
  
-   <span data-ttu-id="2c447-196">間接チェックポイントでは、ディスクへのダーティ ページの書き込みがバックグラウンドで続けられるため、チェックポイントに関連する I/O の急上昇が少なくなります。</span><span class="sxs-lookup"><span data-stu-id="2c447-196">Indirect checkpoints reduce checkpoint-related I/O spiking by continually writing dirty pages to disk in the background.</span></span>  
  
 <span data-ttu-id="2c447-197">ただし、間接チェックポイントが構成されたデータベースでオンライン トランザクション ワークロードが生じると、パフォーマンスが低下することがあります。</span><span class="sxs-lookup"><span data-stu-id="2c447-197">However, an online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="2c447-198">これは、間接チェックポイントで使用されるバックグラウンド ライターによって、サーバー インスタンスの合計書き込みロードが増える場合があるためです。</span><span class="sxs-lookup"><span data-stu-id="2c447-198">This is because the background writer used by indirect checkpoint sometimes increases the total write load for a server instance.</span></span>  
  
  
###  <a name="internal-checkpoints"></a><a name="EventsCausingChkpt"></a><span data-ttu-id="2c447-199">内部チェックポイント</span><span class="sxs-lookup"><span data-stu-id="2c447-199">Internal Checkpoints</span></span>  
 <span data-ttu-id="2c447-200">内部チェックポイントは、ディスク イメージがログの現在の状態と一致することを保証するために、さまざまなサーバー コンポーネントによって生成されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-200">Internal Checkpoints are generated by various server components to guarantee that disk images match the current state of the log.</span></span> <span data-ttu-id="2c447-201">内部チェックポイントは、次のイベントに応答して生成されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-201">Internal checkpoint are generated in response to the following events:</span></span>  
  
-   <span data-ttu-id="2c447-202">ALTER DATABASE を使用して、データベース ファイルが追加または削除された場合。</span><span class="sxs-lookup"><span data-stu-id="2c447-202">Database files have been added or removed by using ALTER DATABASE.</span></span>  
  
-   <span data-ttu-id="2c447-203">データベースのバックアップが作成された場合。</span><span class="sxs-lookup"><span data-stu-id="2c447-203">A database backup is taken.</span></span>  
  
-   <span data-ttu-id="2c447-204">DBCC CHECK で明示的または内部的に、データベース スナップショットが作成された場合。</span><span class="sxs-lookup"><span data-stu-id="2c447-204">A database snapshot is created, whether explicitly or internally for DBCC CHECK.</span></span>  
  
-   <span data-ttu-id="2c447-205">データベースのシャットダウンが必要な動作が実行された場合。</span><span class="sxs-lookup"><span data-stu-id="2c447-205">An activity requiring a database shutdown is performed.</span></span> <span data-ttu-id="2c447-206">たとえば、AUTO_CLOSE が ON に設定されていて、データベースへの最後のユーザー接続が終了した場合、またはデータベースの再起動が必要なデータベース オプションが変更された場合です。</span><span class="sxs-lookup"><span data-stu-id="2c447-206">For example, AUTO_CLOSE is ON and the last user connection to the database is closed, or a database option change is made that requires a restart of the database.</span></span>  
  
-   <span data-ttu-id="2c447-207">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER) サービスを停止することによって、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のインスタンスが停止します。</span><span class="sxs-lookup"><span data-stu-id="2c447-207">An instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is stopped by stopping the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER) service .</span></span> <span data-ttu-id="2c447-208">どちらの場合でも、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]のインスタンスの各データベースでチェックポイントが作成されます。</span><span class="sxs-lookup"><span data-stu-id="2c447-208">Either action  causes a checkpoint in each database in the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="2c447-209">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] フェールオーバー クラスター インスタンス (FCI) がオフラインになった場合。</span><span class="sxs-lookup"><span data-stu-id="2c447-209">Bringing a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] failover cluster instance (FCI) offline.</span></span>  
  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="2c447-210">関連タスク</span><span class="sxs-lookup"><span data-stu-id="2c447-210">Related Tasks</span></span>  
 <span data-ttu-id="2c447-211">**サーバー インスタンスで復旧間隔を変更するには**</span><span class="sxs-lookup"><span data-stu-id="2c447-211">**To change the recovery interval on a server instance**</span></span>  
  
-   [<span data-ttu-id="2c447-212">recovery interval サーバー構成オプションの構成</span><span class="sxs-lookup"><span data-stu-id="2c447-212">Configure the recovery interval Server Configuration Option</span></span>](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)  
  
 <span data-ttu-id="2c447-213">**データベースで間接チェックポイントを構成するには**</span><span class="sxs-lookup"><span data-stu-id="2c447-213">**To configure indirect checkpoints on a database**</span></span>  
  
-   [<span data-ttu-id="2c447-214">データベースのターゲットの復旧時間の変更 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="2c447-214">Change the Target Recovery Time of a Database &#40;SQL Server&#41;</span></span>](change-the-target-recovery-time-of-a-database-sql-server.md)  
  
 <span data-ttu-id="2c447-215">**データベースで手動チェックポイントを発行するには**</span><span class="sxs-lookup"><span data-stu-id="2c447-215">**To issue a manual checkpoint on a database**</span></span>  
  
-   [<span data-ttu-id="2c447-216">CHECKPOINT &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2c447-216">CHECKPOINT &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/language-elements/checkpoint-transact-sql)  
  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="2c447-217">関連コンテンツ</span><span class="sxs-lookup"><span data-stu-id="2c447-217">Related Content</span></span>  
  
-   <span data-ttu-id="2c447-218">[トランザクション ログの物理アーキテクチャ](https://technet.microsoft.com/library/ms179355.aspx) (in [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] オンライン ブック)</span><span class="sxs-lookup"><span data-stu-id="2c447-218">[Transaction Log Physical Architecture](https://technet.microsoft.com/library/ms179355.aspx) (in [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] Books Oline)</span></span>  
  
  
## <a name="see-also"></a><span data-ttu-id="2c447-219">参照</span><span class="sxs-lookup"><span data-stu-id="2c447-219">See Also</span></span>  
 [<span data-ttu-id="2c447-220">トランザクション ログ &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="2c447-220">The Transaction Log &#40;SQL Server&#41;</span></span>](the-transaction-log-sql-server.md)  
  
  
