---
title: カーディナリティ推定 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 11/24/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- cardinality estimator
- CE (cardinality estimator)
- estimating cardinality
ms.assetid: baa8a304-5713-4cfe-a699-345e819ce6df
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: aa56127f649d71bfcc8825322f8bf729175d41df
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87645580"
---
# <a name="cardinality-estimation-sql-server"></a><span data-ttu-id="9f793-102">カーディナリティ推定 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="9f793-102">Cardinality Estimation (SQL Server)</span></span>
  <span data-ttu-id="9f793-103">カーディナリティ推定ロジックをカーディナリティ推定機能と呼びますが、クエリ プランの品質を向上させ、その結果、クエリのパフォーマンスを向上させる目的で、[!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] でこの機能を再設計しました。</span><span class="sxs-lookup"><span data-stu-id="9f793-103">The cardinality estimation logic, called the cardinality estimator, is re-designed in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] to improve the quality of query plans, and therefore to improve query performance.</span></span> <span data-ttu-id="9f793-104">新しいカーディナリティ推定機能には、現在の OLTP ワークロードとデータ ウェアハウス ワークロードで適切に機能する想定とアルゴリズムが組み込まれています。</span><span class="sxs-lookup"><span data-stu-id="9f793-104">The new cardinality estimator incorporates assumptions and algorithms that work well on modern OLTP and data warehousing workloads.</span></span> <span data-ttu-id="9f793-105">この機能は、現在のワークロードを対象とするカーディナリティ推定に関する詳細な調査、および SQL Server のカーディナリティ推定機能を向上させるための過去 15 年にわたる研究を土台としています。</span><span class="sxs-lookup"><span data-stu-id="9f793-105">It is based on in-depth cardinality estimation research on modern workloads, and our learnings over the past 15 years of improving the SQL Server cardinality estimator.</span></span> <span data-ttu-id="9f793-106">お客様からのフィードバックによると、大半のクエリは今回の変更によって性能が向上するか、何も変化しないこと、一方で、少数のクエリは以前のカーディナリティ推定機能と比較すると性能が低下する可能性があることが示されています。</span><span class="sxs-lookup"><span data-stu-id="9f793-106">Feedback from customers shows that while most queries will benefit from the change or remain unchanged, a small number might show regressions compared to the previous cardinality estimator.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9f793-107">カーディナリティ推定とは、クエリの結果に含まれる行の数を予測することです。</span><span class="sxs-lookup"><span data-stu-id="9f793-107">Cardinality estimates are a prediction of the number of rows in the query result.</span></span> <span data-ttu-id="9f793-108">クエリ オプティマイザーはこれらの推定を使用して、クエリを実行するプランを選択します。</span><span class="sxs-lookup"><span data-stu-id="9f793-108">The query optimizer uses these estimates to choose a plan for executing the query.</span></span> <span data-ttu-id="9f793-109">クエリ プランの品質は、クエリ パフォーマンスの向上に直接的な影響を及ぼします。</span><span class="sxs-lookup"><span data-stu-id="9f793-109">The quality of the query plan has a direct impact on improving query performance.</span></span>  
  
## <a name="performance-testing-and-tuning-recommendations"></a><span data-ttu-id="9f793-110">パフォーマンス テストとチューニングに関する推奨事項</span><span class="sxs-lookup"><span data-stu-id="9f793-110">Performance Testing and Tuning Recommendations</span></span>  
 <span data-ttu-id="9f793-111">新しいカーディナリティ推定機能は、[!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] を使用して作成したすべての新しいデータベースで有効になっています。</span><span class="sxs-lookup"><span data-stu-id="9f793-111">The new cardinality estimator is enabled for all new databases created in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span></span> <span data-ttu-id="9f793-112">ただし、[!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] にアップグレードするだけでは、既存のデータベースでは新しいカーディナリティ推定機能は有効になりません。</span><span class="sxs-lookup"><span data-stu-id="9f793-112">However, upgrading to [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] does not enable the new cardinality estimator on existing databases.</span></span>  
  
 <span data-ttu-id="9f793-113">実稼動システムで新しいカーディナリティ推定機能を有効にする前に、最適なクエリ パフォーマンスが達成できることを確認するために、次の推奨事項を使用して実際のワークロードをテストしてください。</span><span class="sxs-lookup"><span data-stu-id="9f793-113">To ensure the best query performance, use these recommendations to test your workload with the new cardinality estimator before enabling it on your production system.</span></span>  
  
1.  <span data-ttu-id="9f793-114">新しいカーディナリティ推定機能を使用するように、すべての既存のデータベースをアップグレードします。</span><span class="sxs-lookup"><span data-stu-id="9f793-114">Upgrade all existing databases to use the new cardinality estimator.</span></span> <span data-ttu-id="9f793-115">これを行うには、 [ALTER Database Compatibility level &#40;transact-sql&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level)を使用して、データベースの互換性レベルを120に設定します。</span><span class="sxs-lookup"><span data-stu-id="9f793-115">To do this, use [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 120.</span></span>  
  
2.  <span data-ttu-id="9f793-116">新しいカーディナリティ推定機能を使用してテスト ワークロードを実行し、パフォーマンス上の問題に対してトラブルシューティングを現在実行しているのと同じ方法で、パフォーマンスの新しい問題に対するトラブルシューティングを実行します。</span><span class="sxs-lookup"><span data-stu-id="9f793-116">Run your test workload with the new cardinality estimator, and then troubleshoot any new performance issues in the same manner you currently troubleshoot performance issues.</span></span>  
  
3.  <span data-ttu-id="9f793-117">新しいカーディナリティ推定機能 (データベース互換性レベル 120 (SQL Server 2014)) を使用してワークロードを実行し、特定のクエリを回帰させる場合は、[!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] 以前のバージョンのカーディナリティ推定機能を使用するために、トレース フラグ 9481 を指定してそのクエリを実行することができます。</span><span class="sxs-lookup"><span data-stu-id="9f793-117">Once your workload is running with the new cardinality estimator (database compatibility level 120 (SQL Server 2014)), and a specific query has regressed, you can run the query with trace flag 9481 to use the version of the cardinality estimator used in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] and earlier.</span></span> <span data-ttu-id="9f793-118">トレース フラグを指定してクエリを実行するには、サポート技術情報の資料「 [特定のクエリ レベルに対応するさまざまなトレース フラグを使用して制御できる、プランが影響を及ぼす SQL Server クエリ オプティマイザーの動作の有効化](https://support.microsoft.com/kb/2801413)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9f793-118">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
4.  <span data-ttu-id="9f793-119">新しいカーディナリティ推定機能を使用するためにすべてのデータベースを一度に変更できない場合は、 [ALTER DATABASE Compatibility level &#40;transact-sql&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level)を使用してデータベースの互換性レベルを110に設定することにより、すべてのデータベースに対して以前のカーディナリティ推定機能を使用できます。</span><span class="sxs-lookup"><span data-stu-id="9f793-119">If you cannot change all of the databases at once to use the new cardinality estimator, you can use the former cardinality estimator for all databases by using [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 110.</span></span>  
  
5.  <span data-ttu-id="9f793-120">データベース互換性レベル 110 を使用してワークロードを実行し、新しいカーディナリティ推定機能を使用して特定のクエリをテストまたは実行しようとする場合は、SQL Server 2014 バージョンのカーディナリティ推定機能を使用するために、トレース フラグ 2312 を指定してそのクエリを実行することができます。</span><span class="sxs-lookup"><span data-stu-id="9f793-120">If your workload is running with database compatibility level 110 and you want to test or run a specific query with the new cardinality estimator, you can run the query with trace flag 2312 to use the SQL Server 2014 version of the cardinality estimator.</span></span>  <span data-ttu-id="9f793-121">トレース フラグを指定してクエリを実行するには、サポート技術情報の資料「 [特定のクエリ レベルに対応するさまざまなトレース フラグを使用して制御できる、プランが影響を及ぼす SQL Server クエリ オプティマイザーの動作の有効化](https://support.microsoft.com/kb/2801413)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9f793-121">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
## <a name="new-xevents"></a><span data-ttu-id="9f793-122">新しい XEvent</span><span class="sxs-lookup"><span data-stu-id="9f793-122">New XEvents</span></span>  
 <span data-ttu-id="9f793-123">新しいクエリ プランをサポートする、2 つの新しい query_optimizer_estimate_cardinality XEvent が存在します。</span><span class="sxs-lookup"><span data-stu-id="9f793-123">There are two new query_optimizer_estimate_cardinality XEvents to support the new query plans.</span></span>  
  
-   <span data-ttu-id="9f793-124">*query_optimizer_estimate_cardinality* は、クエリ オプティマイザーが関係式のカーディナリティを推定するときに発生します。</span><span class="sxs-lookup"><span data-stu-id="9f793-124">*query_optimizer_estimate_cardinality* occurs when the query optimizer estimates the cardinality on a relational expression.</span></span>  
  
-   <span data-ttu-id="9f793-125">*query_optimizer_force_both_cardinality_estimation*の動作が発生するのは、トレース フラグ 2312 と 9481 の両方が有効になっていて、古いカーディナリティ推定動作と新しいカーディナリティ推定動作の両方を同時に適用しようとする場合です。</span><span class="sxs-lookup"><span data-stu-id="9f793-125">*query_optimizer_force_both_cardinality_estimation*_behaviors occurs when both traceflags 2312 and 9481 are enabled, attempting to force both old and new cardinality estimation behavior at the same time.</span></span>  
  
## <a name="examples"></a><span data-ttu-id="9f793-126">例</span><span class="sxs-lookup"><span data-stu-id="9f793-126">Examples</span></span>  
 <span data-ttu-id="9f793-127">次の例では、新しいカーディナリティ推定で加えられた変更の一部を示します。</span><span class="sxs-lookup"><span data-stu-id="9f793-127">The following examples show some of the changes in the new cardinality estimates.</span></span> <span data-ttu-id="9f793-128">カーディナリティを推定するコードを書き直しました。</span><span class="sxs-lookup"><span data-stu-id="9f793-128">The code for estimating cardinality has been rewritten.</span></span> <span data-ttu-id="9f793-129">ロジックは複雑であり、すべての変更を網羅した完全な一覧をここに示すことはできません。</span><span class="sxs-lookup"><span data-stu-id="9f793-129">The logic is complex and it is not possible to provide an exhaustive list of all changes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9f793-130">これらの例は、概念を示す情報として掲載したものです。</span><span class="sxs-lookup"><span data-stu-id="9f793-130">These examples are provided as conceptual information.</span></span> <span data-ttu-id="9f793-131">管理者や開発者が、データベースとクエリを設計する方法などに変更を加える必要はありません。</span><span class="sxs-lookup"><span data-stu-id="9f793-131">No action is required on your part to change the way you design databases and queries.</span></span>  
  
### <a name="example-a-new-cardinality-estimates-use-an-average-cardinality-for-recently-added-ascending-data"></a><span data-ttu-id="9f793-132">例 A。新しいカーディナリティ推定機能は、最近追加された昇順データに関して、平均のカーディナリティを使用します。</span><span class="sxs-lookup"><span data-stu-id="9f793-132">Example A. New cardinality estimates use an average cardinality for recently added ascending data</span></span>  
 <span data-ttu-id="9f793-133">この例では、最新の統計を更新する際に、テーブル内の最大値を上回る昇順データに関するカーディナリティ推定を、新しいカーディナリティ推定機能がどのように向上させるかを示します。</span><span class="sxs-lookup"><span data-stu-id="9f793-133">This example demonstrates how the new cardinality estimator can improve cardinality estimates for ascending data that exceeds the maximum value in the table during the most recent statistics update.</span></span>  
  
```  
SELECT item, category, amount FROM dbo.Sales AS s WHERE Date = '2013-12-19';  
```  
  
 <span data-ttu-id="9f793-134">この例では、Sales テーブルに新しい行を毎日追加し、クエリは 12/19/2013 (2013 年 12 月 19 日) に発生した行と、12/18/2013 に最後に更新された統計を要求します。</span><span class="sxs-lookup"><span data-stu-id="9f793-134">In this example, new rows are added to the Sales table each day, the query asks for sales that occurred on 12/19/2013, and statistics were last updated on 12/18/2013.</span></span> <span data-ttu-id="9f793-135">12/19/2013 という日付がテーブル内の最大値を上回っていて、この値を含む形で統計の更新が実行されていないため、以前のカーディナリティ推定機能はこの値が存在しないことを想定していました。</span><span class="sxs-lookup"><span data-stu-id="9f793-135">The previous cardinality estimator assumes the 12/19/2013 values do not exist since the date exceeds the maximum date and statistics have not been updated to include the 12/19/2013 values.</span></span> <span data-ttu-id="9f793-136">昇順キーの問題と呼ばれるこの状況は、その日のうちにデータを読み込んだ後、統計が更新される前にクエリがデータを要求する場合に発生します。</span><span class="sxs-lookup"><span data-stu-id="9f793-136">This situation, known as the ascending key problem, will occur if you load data during the day, and then run queries against the data before statistics are updated.</span></span>  
  
 <span data-ttu-id="9f793-137">この動作は変更されました。</span><span class="sxs-lookup"><span data-stu-id="9f793-137">This behavior has changed.</span></span> <span data-ttu-id="9f793-138">現在は、最後に統計を更新し、その後に追加された最新の昇順データを含む形で統計が更新されていない場合でも、新しいカーディナリティ推定機能はそれらの値が存在することを想定し、カーディナリティ推定を行う際に列内にある各値として平均カーディナリティを使用します。</span><span class="sxs-lookup"><span data-stu-id="9f793-138">Now, even if statistics have not been updated for the most recent ascending data that is added since the last statistics update, the new cardinality estimator assumes the values exist and uses the average cardinality for each value in the column as the cardinality estimate.</span></span>  
  
### <a name="example-b-new-cardinality-estimates-assume-filtered-predicates-on-the-same-table-have-some-correlation"></a><span data-ttu-id="9f793-139">例 B。新しいカーディナリティ推定機能は、同じテーブル内にあるフィルター処理された複数の述語の間に、何かの相関関係があることを想定します。</span><span class="sxs-lookup"><span data-stu-id="9f793-139">Example B. New cardinality estimates assume filtered predicates on the same table have some correlation</span></span>  
 <span data-ttu-id="9f793-140">この例では、Cars テーブルに 1,000 の行が存在することを想定します。200 の行では Make (メーカー) は "Honda" になっており、50 の行では Model (車種) は "Civic" になっており、"Civic" の行すべてで Make は "Honda" になっています。</span><span class="sxs-lookup"><span data-stu-id="9f793-140">For this example, assume the table Cars as 1000 rows, Make has 200 matches for 'Honda', Model has 50 matches for 'Civic', and that all of the Civics are Hondas.</span></span> <span data-ttu-id="9f793-141">したがって、Make の列では値の 20% が "Honda" になっており、Model の列では値の 5% が "Civic" になっており、"Honda Civic" の実際の数は 50 です。</span><span class="sxs-lookup"><span data-stu-id="9f793-141">Therefore, 20% of the values in the Make column are 'Honda', 5% of the values in the Model column are 'Civic', and the actual number of Honda Civics is 50.</span></span> <span data-ttu-id="9f793-142">以前のカーディナリティ推定機能では、Make と Model の各列にある値が互いに独立していることを想定していました。</span><span class="sxs-lookup"><span data-stu-id="9f793-142">The previous cardinality estimates assume the values in the Make and the Model columns are independent of each other.</span></span> <span data-ttu-id="9f793-143">前のクエリオプティマイザーでは、10個の Honda なっ (. 05 \* 0.20 \* 1000 行 = 10 行) が推定されています。</span><span class="sxs-lookup"><span data-stu-id="9f793-143">The previous query optimizer estimates there are 10 Honda Civics (.05 \* .20 \* 1000 rows = 10 rows).</span></span>  
  
```  
SELECT year, purchase_price FROM dbo.Cars WHERE Make = 'Honda' AND Model = 'Civic';  
```  
  
 <span data-ttu-id="9f793-144">この動作は変更されました。</span><span class="sxs-lookup"><span data-stu-id="9f793-144">This behavior has changed.</span></span> <span data-ttu-id="9f793-145">現在の新しいカーディナリティ推定機能は、Make 列と Model 列の間に「何かの」 \*\* 相関関係が存在することを想定します。</span><span class="sxs-lookup"><span data-stu-id="9f793-145">Now, the new cardinality estimates assume the Make and Model columns have *some* correlation.</span></span> <span data-ttu-id="9f793-146">クエリ オプティマイザーは、推定式に指数成分を追加することにより、以前の推定を超えるカーディナリティを推定します。</span><span class="sxs-lookup"><span data-stu-id="9f793-146">The query optimizer estimates a higher cardinality by adding an exponential component to the estimation equation.</span></span> <span data-ttu-id="9f793-147">クエリオプティマイザーでは、22.36 行 (0.05 \* SQRT (. 20) \* 1000 rows = 22.36 rows) が述語と一致することが推定されるようになりました。</span><span class="sxs-lookup"><span data-stu-id="9f793-147">The query optimizer now estimates that 22.36 rows ( .05 \* SQRT(.20) \* 1000 rows = 22.36 rows ) match the predicate.</span></span> <span data-ttu-id="9f793-148">このシナリオと特定のデータ分布の場合は、クエリが返す 22.36 行という値は、実際の値である 50 行に近づきます。</span><span class="sxs-lookup"><span data-stu-id="9f793-148">For this scenario and specific data distribution, 22.36 rows is closer to the actual 50 rows that the query will return.</span></span>  
  
 <span data-ttu-id="9f793-149">新しいカーディナリティ推定機能のロジックは、述語選択度を並べ替え、指数を大きくすることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="9f793-149">Note, the new cardinality estimator logic sorts the predicate selectivities and increases the exponent.</span></span> <span data-ttu-id="9f793-150">たとえば、述語選択度が0.05、0.20、および0.25 の場合、カーディナリティの推定は (. 05 \* SQRT (. 20) \* sqrt (sqrt (0.25))) になります。</span><span class="sxs-lookup"><span data-stu-id="9f793-150">For example, if the predicate selectivities were .05, .20, and .25, the cardinality estimate would be (.05 \* SQRT(.20) \* SQRT(SQRT(.25)) ).</span></span>  
  
### <a name="example-c-new-cardinality-estimates-assume-filtered-predicates-on-different-tables-are-independent"></a><span data-ttu-id="9f793-151">例 C。新しいカーディナリティ推定機能は、異なるテーブル上でフィルター処理された述語の間で、互いに依存関係がないことを想定しています。</span><span class="sxs-lookup"><span data-stu-id="9f793-151">Example C. New cardinality estimates assume filtered predicates on different tables are independent</span></span>  
 <span data-ttu-id="9f793-152">この例では、以前のカーディナリティ推定機能は、述語フィルター s.type と r.date が相関していることを想定しています。</span><span class="sxs-lookup"><span data-stu-id="9f793-152">For this example, the previous cardinality estimator assumes that the predicate filters s.type and r.date are correlated.</span></span> <span data-ttu-id="9f793-153">ただし、最近のワークロードに対するテストの結果は、異なるテーブル上にある列に対する述語フィルターが互いに相関しないことを示しています。</span><span class="sxs-lookup"><span data-stu-id="9f793-153">However, test results on modern workloads showed that predicate filters on columns in different tables are usually not correlated with each other.</span></span>  
  
```  
SELECT s.ticket, s.customer, r.store FROM dbo.Sales AS s CROSS JOIN dbo.Returns AS r  
WHERE s.ticket = r.ticket AND s.type = 'toy' AND r.date = '2013-12-19';  
```  
  
 <span data-ttu-id="9f793-154">この動作は変更されました。</span><span class="sxs-lookup"><span data-stu-id="9f793-154">This behavior has changed.</span></span> <span data-ttu-id="9f793-155">現在の新しいカーディナリティ推定機能のロジックは、s.type が r.date に相関しないことを想定しています。</span><span class="sxs-lookup"><span data-stu-id="9f793-155">Now, the new cardinality estimator logic assumes that s.type is not correlated with r.date.</span></span> <span data-ttu-id="9f793-156">つまり、玩具の返品は特定の 1 日ではなく、毎日発生することを想定しています。</span><span class="sxs-lookup"><span data-stu-id="9f793-156">In practical terms, the assumption is that toys are returned every day and not only on a specific day.</span></span> <span data-ttu-id="9f793-157">この例では、新しいカーディナリティ推定機能は、以前のカーディナリティ推定機能未満の数を推定します。</span><span class="sxs-lookup"><span data-stu-id="9f793-157">In this case, the new cardinality estimates will be a smaller number than the previous cardinality estimates.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="9f793-158">参照</span><span class="sxs-lookup"><span data-stu-id="9f793-158">See Also</span></span>  
 [<span data-ttu-id="9f793-159">パフォーマンスの監視とチューニング</span><span class="sxs-lookup"><span data-stu-id="9f793-159">Monitor and Tune for Performance</span></span>](monitor-and-tune-for-performance.md)  
  
  
