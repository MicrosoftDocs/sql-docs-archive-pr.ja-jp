---
title: スナップショット分離を使用した作業 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- data access [SQL Server Native Client], snapshot isolation
- SQLNCLI, snapshot isolation
- isolation levels [SQL Server], snapshot
- DBPROPSET_SESSION property set
- DBDROPSET_DATASOURCEINFO property set
- snapshot isolation [SQL Server Native Client]
- SQL Server Native Client OLE DB provider, snapshot isolation
- SQL Server Native Client ODBC driver, snapshot isolation
- SQL Server Native Client, snapshot isolation
- SQLGetInfo function
- concurrency [SQL Server Native Client]
- SQLSetConnectAttr function
ms.assetid: 39e87eb1-677e-45dd-bc61-83a4025a7756
author: rothja
ms.author: jroth
ms.openlocfilehash: 242d054a5fd2ad12a8811bebc834d423f547a499
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87643268"
---
# <a name="working-with-snapshot-isolation"></a><span data-ttu-id="7b4d7-102">スナップショット分離を使用した作業</span><span class="sxs-lookup"><span data-stu-id="7b4d7-102">Working with Snapshot Isolation</span></span>
  [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] <span data-ttu-id="7b4d7-103">では、OLTP (オンライン トランザクション処理) アプリケーションのコンカレンシーの強化を目的として、新しく "スナップショット" 分離レベルが導入されました。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-103">introduced a new "snapshot" isolation level that is intended to enhance concurrency for online transaction processing (OLTP) applications.</span></span> <span data-ttu-id="7b4d7-104">以前のバージョンの [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] では、コンカレンシーはロックだけを基にしていました。そのため、アプリケーションによってはブロックやデッドロックなどの問題が生じることがありました。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-104">In earlier versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], concurrency was based solely on locking, which can cause blocking and deadlocking problems for some applications.</span></span> <span data-ttu-id="7b4d7-105">スナップショット分離は行のバージョン管理の機能強化に依存しており、リーダーとライターのブロッキングを回避することでパフォーマンスを向上することを目的としています。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-105">Snapshot isolation depends on enhancements to row versioning and is intended to improve performance by avoiding reader-writer blocking scenarios.</span></span>  
  
 <span data-ttu-id="7b4d7-106">スナップショット分離の下で開始されたトランザクションは、トランザクションの開始時点のデータベース スナップショットを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-106">Transactions that start under snapshot isolation read a database snapshot as of the time when the transaction starts.</span></span> <span data-ttu-id="7b4d7-107">この結果、スナップショット トランザクション コンテキスト内でキーセット サーバー カーソル、動的サーバー カーソル、および静的サーバー カーソルを開くと、これらのカーソルはシリアル化可能なトランザクション内で開かれた静的カーソルとほぼ同様に動作します。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-107">One result of this is that keyset, dynamic and static server cursors, when opened within a snapshot transaction context, behave much like static cursors opened within serializable transactions.</span></span> <span data-ttu-id="7b4d7-108">また、スナップショット分離レベルの下でカーソルが開かれると、ロックが設定されず、サーバーでのブロッキングを減少させることができます。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-108">However, when the cursors are opened under the snapshot isolation level locks are not taken, which can reduce blocking on the server.</span></span>  
  
## <a name="sql-server-native-client-ole-db-provider"></a><span data-ttu-id="7b4d7-109">SQL Server Native Client OLE DB プロバイダー</span><span class="sxs-lookup"><span data-stu-id="7b4d7-109">SQL Server Native Client OLE DB Provider</span></span>  
 <span data-ttu-id="7b4d7-110">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB プロバイダーには、で導入されたスナップショット分離を利用する拡張機能があり [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] ます。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-110">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider has enhancements that take advantage of the snapshot isolation introduced in [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)].</span></span> <span data-ttu-id="7b4d7-111">具体的には、DBPROPSET_DATASOURCEINFO プロパティ セットと DBPROPSET_SESSION プロパティ セットへ変更が加えられています。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-111">These enhancements include changes to the DBPROPSET_DATASOURCEINFO and DBPROPSET_SESSION property sets.</span></span>  
  
### <a name="dbpropset_datasourceinfo"></a><span data-ttu-id="7b4d7-112">DBPROPSET_DATASOURCEINFO</span><span class="sxs-lookup"><span data-stu-id="7b4d7-112">DBPROPSET_DATASOURCEINFO</span></span>  
 <span data-ttu-id="7b4d7-113">DBPROP_SUPPORTEDTXNISOLEVELS プロパティで使用される DBPROPVAL_TI_SNAPSHOT 値が追加され、DBPROPSET_DATASOURCEINFO プロパティ セットではスナップショット分離レベルがサポートされるようになりました。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-113">The DBPROPSET_DATASOURCEINFO property set has been changed to indicate that the snapshot isolation level is supported by the addition of the DBPROPVAL_TI_SNAPSHOT value that is used in the DBPROP_SUPPORTEDTXNISOLEVELS property.</span></span> <span data-ttu-id="7b4d7-114">この新しい値は、データベースでバージョン管理が有効になっているかどうかにかかわらず、スナップショット分離レベルがサポートされることを示します。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-114">This new value indicates that the snapshot isolation level is supported whether or not versioning has been enabled on the database.</span></span> <span data-ttu-id="7b4d7-115">次に、DBPROP_SUPPORTEDTXNISOLEVELS の値の一覧を示します。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-115">The following is a list of the DBPROP_SUPPORTEDTXNISOLEVELS values:</span></span>  
  
|<span data-ttu-id="7b4d7-116">プロパティ ID</span><span class="sxs-lookup"><span data-stu-id="7b4d7-116">Property ID</span></span>|<span data-ttu-id="7b4d7-117">説明</span><span class="sxs-lookup"><span data-stu-id="7b4d7-117">Description</span></span>|  
|-----------------|-----------------|  
|<span data-ttu-id="7b4d7-118">DBPROP_SUPPORTEDTXNISOLEVELS</span><span class="sxs-lookup"><span data-stu-id="7b4d7-118">DBPROP_SUPPORTEDTXNISOLEVELS</span></span>|<span data-ttu-id="7b4d7-119">型 : VT_I4</span><span class="sxs-lookup"><span data-stu-id="7b4d7-119">Type: VT_I4</span></span><br /><br /> <span data-ttu-id="7b4d7-120">R/W: 読み取り専用</span><span class="sxs-lookup"><span data-stu-id="7b4d7-120">R/W: Read only</span></span><br /><br /> <span data-ttu-id="7b4d7-121">説明 : サポートされるトランザクション分離レベルを指定するビットマスク。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-121">Description: A bitmask specifying the supported transaction isolation levels.</span></span> <span data-ttu-id="7b4d7-122">次の値を 0 個以上指定できます。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-122">A combination of zero or more of the following:</span></span><br /><br /> <span data-ttu-id="7b4d7-123">-DBPROPVAL_TI_CHAOS</span><span class="sxs-lookup"><span data-stu-id="7b4d7-123">-   DBPROPVAL_TI_CHAOS</span></span><br /><span data-ttu-id="7b4d7-124">-DBPROPVAL_TI_READUNCOMMITTED</span><span class="sxs-lookup"><span data-stu-id="7b4d7-124">-   DBPROPVAL_TI_READUNCOMMITTED</span></span><br /><span data-ttu-id="7b4d7-125">-DBPROPVAL_TI_BROWSE</span><span class="sxs-lookup"><span data-stu-id="7b4d7-125">-   DBPROPVAL_TI_BROWSE</span></span><br /><span data-ttu-id="7b4d7-126">-DBPROPVAL_TI_CURSORSTABILITY</span><span class="sxs-lookup"><span data-stu-id="7b4d7-126">-   DBPROPVAL_TI_CURSORSTABILITY</span></span><br /><span data-ttu-id="7b4d7-127">-DBPROPVAL_TI_READCOMMITTED</span><span class="sxs-lookup"><span data-stu-id="7b4d7-127">-   DBPROPVAL_TI_READCOMMITTED</span></span><br /><span data-ttu-id="7b4d7-128">-DBPROPVAL_TI_REPEATABLEREAD</span><span class="sxs-lookup"><span data-stu-id="7b4d7-128">-   DBPROPVAL_TI_REPEATABLEREAD</span></span><br /><span data-ttu-id="7b4d7-129">-DBPROPVAL_TI_SERIALIZABLE</span><span class="sxs-lookup"><span data-stu-id="7b4d7-129">-   DBPROPVAL_TI_SERIALIZABLE</span></span><br /><span data-ttu-id="7b4d7-130">-DBPROPVAL_TI_ISOLATED</span><span class="sxs-lookup"><span data-stu-id="7b4d7-130">-   DBPROPVAL_TI_ISOLATED</span></span><br /><span data-ttu-id="7b4d7-131">-DBPROPVAL_TI_SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="7b4d7-131">-   DBPROPVAL_TI_SNAPSHOT</span></span>|  
  
### <a name="dbpropset_session"></a><span data-ttu-id="7b4d7-132">DBPROPSET_SESSION</span><span class="sxs-lookup"><span data-stu-id="7b4d7-132">DBPROPSET_SESSION</span></span>  
 <span data-ttu-id="7b4d7-133">DBPROP_SESS_AUTOCOMMITISOLEVELS プロパティで使用される DBPROPVAL_TI_SNAPSHOT 値が追加され、DBPROPSET_SESSION プロパティ セットではスナップショット分離レベルがサポートされるようになりました。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-133">The DBPROPSET_SESSION property set has been changed to indicate that the snapshot isolation level is supported by the addition of the DBPROPVAL_TI_SNAPSHOT value that is used in the DBPROP_SESS_AUTOCOMMITISOLEVELS property.</span></span> <span data-ttu-id="7b4d7-134">この新しい値は、データベースでバージョン管理が有効になっているかどうかにかかわらず、スナップショット分離レベルがサポートされることを示します。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-134">This new value indicates that the snapshot isolation level is supported whether or not versioning has been enabled on the database.</span></span> <span data-ttu-id="7b4d7-135">次に、DBPROP_SESS_AUTOCOMMITISOLEVELS の値の一覧を示します。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-135">The following is a list of the DBPROP_SESS_AUTOCOMMITISOLEVELS values:</span></span>  
  
|<span data-ttu-id="7b4d7-136">プロパティ ID</span><span class="sxs-lookup"><span data-stu-id="7b4d7-136">Property ID</span></span>|<span data-ttu-id="7b4d7-137">説明</span><span class="sxs-lookup"><span data-stu-id="7b4d7-137">Description</span></span>|  
|-----------------|-----------------|  
|<span data-ttu-id="7b4d7-138">DBPROP_SESS_AUTOCOMMITISOLEVELS</span><span class="sxs-lookup"><span data-stu-id="7b4d7-138">DBPROP_SESS_AUTOCOMMITISOLEVELS</span></span>|<span data-ttu-id="7b4d7-139">型 : VT_I4</span><span class="sxs-lookup"><span data-stu-id="7b4d7-139">Type: VT_I4</span></span><br /><br /> <span data-ttu-id="7b4d7-140">R/W: 読み取り専用</span><span class="sxs-lookup"><span data-stu-id="7b4d7-140">R/W: Read only</span></span><br /><br /> <span data-ttu-id="7b4d7-141">説明 : 自動コミット モードのときのトランザクション分離レベルを示すビットマスクを指定します。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-141">Description: Specifies a bitmask that indicates the transaction isolation level while in auto-commit mode.</span></span> <span data-ttu-id="7b4d7-142">このビットマスクには、DBPROP_SUPPORTEDTXNISOLEVELS に設定できる値と同じ値を設定できます。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-142">The values that can be set in this bitmask are the same as those that can be set for DBPROP_SUPPORTEDTXNISOLEVELS.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="7b4d7-143">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] よりも前のバージョンの [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] を使用しているときに DBPROPVAL_TI_SNAPSHOT を設定すると、エラー DB_S_ERRORSOCCURRED または DB_E_ERRORSOCCURRED が発生します。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-143">The errors DB_S_ERRORSOCCURRED or DB_E_ERRORSOCCURRED will occur if DBPROPVAL_TI_SNAPSHOT is set when using versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] earlier than [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)].</span></span>  
  
 <span data-ttu-id="7b4d7-144">トランザクションでスナップショット分離がサポートされる方法については、「[ローカル トランザクションのサポート](../../native-client-ole-db-transactions/transactions.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-144">For information about how snapshot isolation is supported in transactions, see [Supporting Local Transactions](../../native-client-ole-db-transactions/transactions.md).</span></span>  
  
## <a name="sql-server-native-client-odbc-driver"></a><span data-ttu-id="7b4d7-145">SQL Server Native Client ODBC ドライバー</span><span class="sxs-lookup"><span data-stu-id="7b4d7-145">SQL Server Native Client ODBC Driver</span></span>  
 <span data-ttu-id="7b4d7-146">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC ドライバーでは、 [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md)関数と[SQLGetInfo](../../native-client-odbc-api/sqlgetinfo.md)関数が拡張されましたが、スナップショット分離がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-146">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver provides support for snapshot isolation though enhancements made to the [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) and [SQLGetInfo](../../native-client-odbc-api/sqlgetinfo.md) functions.</span></span>  
  
### <a name="sqlsetconnectattr"></a><span data-ttu-id="7b4d7-147">SQLSetConnectAttr</span><span class="sxs-lookup"><span data-stu-id="7b4d7-147">SQLSetConnectAttr</span></span>  
 <span data-ttu-id="7b4d7-148">**SQLSetConnectAttr**関数は、SQL_COPT_SS_TXN_ISOLATION 属性の使用をサポートするようになりました。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-148">The **SQLSetConnectAttr** function now supports the use of the SQL_COPT_SS_TXN_ISOLATION attribute.</span></span> <span data-ttu-id="7b4d7-149">SQL_COPT_SS_TXN_ISOLATION を SQL_TXN_SS_SNAPSHOT に設定すると、トランザクションがスナップショット分離レベルで実行されることが報告されます。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-149">Setting SQL_COPT_SS_TXN_ISOLATION to SQL_TXN_SS_SNAPSHOT indicates that the transaction will take place under the snapshot isolation level.</span></span>  
  
### <a name="sqlgetinfo"></a><span data-ttu-id="7b4d7-150">SQLGetInfo</span><span class="sxs-lookup"><span data-stu-id="7b4d7-150">SQLGetInfo</span></span>  
 <span data-ttu-id="7b4d7-151">[SQLGetInfo](../../native-client-odbc-api/sqlgetinfo.md)関数は、SQL_TXN_ISOLATION_OPTION の情報の種類に追加された SQL_TXN_SS_SNAPSHOT 値をサポートするようになりました。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-151">The [SQLGetInfo](../../native-client-odbc-api/sqlgetinfo.md) function now supports the SQL_TXN_SS_SNAPSHOT value that has been added to the SQL_TXN_ISOLATION_OPTION info type.</span></span>  
  
 <span data-ttu-id="7b4d7-152">トランザクションでスナップショット分離がどのようにサポートされるかについては、「 [Cursor Transaction 分離レベル](../../native-client-odbc-cursors/properties/cursor-transaction-isolation-level.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7b4d7-152">For information about how snapshot isolation is supported in transactions, see [Cursor Transaction Isolation Level](../../native-client-odbc-cursors/properties/cursor-transaction-isolation-level.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7b4d7-153">参照</span><span class="sxs-lookup"><span data-stu-id="7b4d7-153">See Also</span></span>  
 <span data-ttu-id="7b4d7-154">[SQL Server Native Client の機能](sql-server-native-client-features.md) </span><span class="sxs-lookup"><span data-stu-id="7b4d7-154">[SQL Server Native Client Features](sql-server-native-client-features.md) </span></span>  
 [<span data-ttu-id="7b4d7-155">行セットのプロパティと動作</span><span class="sxs-lookup"><span data-stu-id="7b4d7-155">Rowset Properties and Behaviors</span></span>](../../native-client-ole-db-rowsets/rowset-properties-and-behaviors.md)  
  
  
