---
title: データベース ミラーリングの使用 | Microsoft Docs
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- SQL Server Native Client, database mirroring
- data access [SQL Server Native Client], database mirroring
- database mirroring [SQL Server], connecting clients to
- SQLNCLI, database mirroring
- SQL Server Native Client ODBC driver, database mirroring
- SQL Server Native Client OLE DB provider, database mirroring
ms.assetid: 71b15712-7972-4465-9274-e0ddc271eedc
author: rothja
ms.author: jroth
ms.openlocfilehash: 389036322137abcc9a40e36c697e8d45e39a7de5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87633114"
---
# <a name="using-database-mirroring"></a><span data-ttu-id="82223-102">データベース ミラーリングの使用</span><span class="sxs-lookup"><span data-stu-id="82223-102">Using Database Mirroring</span></span>
    
> [!NOTE]  
>  [!INCLUDE[ssNoteDepFutureAvoid](../../../includes/ssnotedepfutureavoid-md.md)] <span data-ttu-id="82223-103">代わりに [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] を使用します。</span><span class="sxs-lookup"><span data-stu-id="82223-103">Use [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] instead.</span></span>  
  
 <span data-ttu-id="82223-104">[!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] で導入されたデータベース ミラーリングは、データベースの可用性とデータの冗長性を高めるためのソリューションです。</span><span class="sxs-lookup"><span data-stu-id="82223-104">Database mirroring, introduced in [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], is a solution for increasing database availability and data redundancy.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="82223-105">Native Client では、データベースミラーリングの暗黙的なサポートが提供されるため、開発者は、データベースに対して構成されたコードを記述したり、他のアクションを実行したりする必要はありません。</span><span class="sxs-lookup"><span data-stu-id="82223-105">Native Client provides implicit support for database mirroring, so the developer does not need to write any code or take any other action once it has been configured for the database.</span></span>  
  
 <span data-ttu-id="82223-106">データベース ミラーリングは、データベースごとに実装され、スタンバイ サーバー上に [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 運用データベースのコピーを保持します。</span><span class="sxs-lookup"><span data-stu-id="82223-106">Database mirroring, which is implemented on a per-database basis, keeps a copy of a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] production database on a standby server.</span></span> <span data-ttu-id="82223-107">このサーバーは、データベース ミラーリング セッションの構成および状態に応じて、ホット スタンバイ サーバーかウォーム スタンバイ サーバーのいずれかになります。</span><span class="sxs-lookup"><span data-stu-id="82223-107">This server is either a hot or warm standby server, depending on the configuration and state of the database mirroring session.</span></span> <span data-ttu-id="82223-108">ホット スタンバイ サーバーはコミット済みトランザクションが失われない高速フェールオーバーをサポートし、ウォーム スタンバイ サーバーはサービスの強制 (データ損失の可能性あり) をサポートします。</span><span class="sxs-lookup"><span data-stu-id="82223-108">A hot standby server supports rapid failover with no loss of committed transactions, and a warm standby server supports forcing service (with possible data loss).</span></span>  
  
 <span data-ttu-id="82223-109">運用データベースは*プリンシパル データベース*と呼ばれ、スタンバイ コピーは*ミラー データベース*と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="82223-109">The production database is called the *principal database*, and the standby copy is called the *mirror database*.</span></span> <span data-ttu-id="82223-110">プリンシパル データベースおよびミラー データベースは、別個の [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] インスタンス (サーバー インスタンス) に配置する必要があります。また、可能な場合は別個のコンピューターに配置してください。</span><span class="sxs-lookup"><span data-stu-id="82223-110">The principal database and mirror database must reside on separate instances of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (server instances), and they should reside on separate computers if possible.</span></span>  
  
 <span data-ttu-id="82223-111">*プリンシパル サーバー*と呼ばれる実稼働サーバー インスタンスは、*ミラー サーバー*と呼ばれるスタンバイ サーバーと通信します。</span><span class="sxs-lookup"><span data-stu-id="82223-111">The production server instance, called the *principal server*, communicates with the standby server instance, called the *mirror server*.</span></span> <span data-ttu-id="82223-112">プリンシパル サーバーとミラー サーバーは、データベース ミラーリング *セッション*の中でパートナーとして機能します。</span><span class="sxs-lookup"><span data-stu-id="82223-112">The principal and mirror servers act as partners within a database mirroring *session*.</span></span> <span data-ttu-id="82223-113">プリンシパル サーバーで障害が発生した場合、ミラー サーバーは*フェールオーバー*と呼ばれる処理を通じて、ミラー サーバーのデータベースをプリンシパル データベースにできます。</span><span class="sxs-lookup"><span data-stu-id="82223-113">If the principal server fails, the mirror server can make its database into the principal database through a process called *failover*.</span></span> <span data-ttu-id="82223-114">たとえば、Partner_A と Partner_B がパートナー サーバーで、初期時点ではプリンシパル データベースがプリンシパル サーバーである Partner_A にあり、ミラー データベースがミラー サーバーである Partner_B にあるとします。</span><span class="sxs-lookup"><span data-stu-id="82223-114">For example, Partner_A and Partner_B are two partner servers, with the principal database initially on Partner_A as principal server, and the mirror database residing on Partner_B as the mirror server.</span></span> <span data-ttu-id="82223-115">Partner_A がオフラインになった場合、Partner_B がフェールオーバーして現在のプリンシパル データベースになることができます。</span><span class="sxs-lookup"><span data-stu-id="82223-115">If Partner_A goes offline, the database on Partner_B can fail over to become the current principal database.</span></span> <span data-ttu-id="82223-116">Partner_A がミラー化セッションに再び参加すると、このサーバーがミラー サーバーになり、このサーバーのデータベースがミラー データベースになります。</span><span class="sxs-lookup"><span data-stu-id="82223-116">When Partner_A rejoins the mirroring session, it becomes the mirror server and its database becomes the mirror database.</span></span>  
  
 <span data-ttu-id="82223-117">代替データベース ミラーリング構成は、さまざまなレベルのパフォーマンスとデータの安全性を提供し、さまざまな形態のフェールオーバーをサポートします。</span><span class="sxs-lookup"><span data-stu-id="82223-117">Alternative database mirroring configurations offer different levels of performance and data safety, and support different forms of failover.</span></span> <span data-ttu-id="82223-118">詳細については、「[データベース ミラーリング &#40;SQL Server&#41;](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="82223-118">For more information, see [Database Mirroring &#40;SQL Server&#41;](../../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span></span>  
  
 <span data-ttu-id="82223-119">ミラー データベース名を指定するときには別名を使用できます。</span><span class="sxs-lookup"><span data-stu-id="82223-119">It is possible to use an alias when specifying the mirror database name.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="82223-120">ミラー化されたデータベースへの最初の接続試行と再接続試行の詳細については、「[データベース ミラーリング セッションへのクライアントの接続 &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="82223-120">For information about initial connection attempts and reconnection attempts to a mirrored database, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
## <a name="programming-considerations"></a><span data-ttu-id="82223-121">プログラミングに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="82223-121">Programming Considerations</span></span>  
 <span data-ttu-id="82223-122">プリンシパル データベース サーバーに障害が発生した場合、クライアント アプリケーションの API 呼び出しの応答がエラーになり、データベースへの接続が失われたことが伝えられます。</span><span class="sxs-lookup"><span data-stu-id="82223-122">When the principal database server fails, the client application receives errors in response to API calls, which indicate that the connection to the database has been lost.</span></span> <span data-ttu-id="82223-123">このとき、データベースへのコミットされていない変更は反映されず、現在のトランザクションはロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="82223-123">When this happens, any uncommitted changes to the database are lost and the current transaction is rolled back.</span></span> <span data-ttu-id="82223-124">その場合、アプリケーションは接続を閉じ (またはデータ ソース オブジェクトを解放し)、再度接続を開く必要があります。</span><span class="sxs-lookup"><span data-stu-id="82223-124">If this occurs, the application should close the connection (or release the data source object) and re-open it.</span></span> <span data-ttu-id="82223-125">再接続の結果、プリンパル サーバーの機能を引き継いだミラー データベースに自動的にリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="82223-125">The connection is transparently re-directed to the mirror database, which now acts as the principal server.</span></span>  
  
 <span data-ttu-id="82223-126">接続を確立するときに、プリンシパル サーバーからクライアントに対し、フェールオーバーが行われるときに使用されるフェールオーバー パートナーの ID が送信されます。</span><span class="sxs-lookup"><span data-stu-id="82223-126">When a connection is established, the principal server sends the identity of its failover partner to the client to be used when failover occurs.</span></span> <span data-ttu-id="82223-127">プリンシパル サーバーで障害が発生した後で接続を確立すると、クライアント側でフェールオーバー パートナーの ID を把握できません。</span><span class="sxs-lookup"><span data-stu-id="82223-127">Where an application tried to establish a connection after the principal server failed, the client does not know the identity of the failover partner.</span></span> <span data-ttu-id="82223-128">このシナリオでクライアントが適切な処理を行うため、初期化プロパティおよび関連する接続文字列キーワードを使用して、クライアントが独自にフェールオーバー パートナーの ID を指定することができます。</span><span class="sxs-lookup"><span data-stu-id="82223-128">To allow clients the opportunity to cope with this scenario, an initialization property and an associated connection string keyword allow the client to specify the identity of the failover partner on its own.</span></span> <span data-ttu-id="82223-129">クライアント属性が使用されるのは、このシナリオのみです。プリンシパル サーバーが利用できる場合、クライアント属性は使用されません。</span><span class="sxs-lookup"><span data-stu-id="82223-129">The client attribute is used only in this scenario; if the principal server is available, it is not used.</span></span> <span data-ttu-id="82223-130">クライアントが指定したフェールオーバー パートナー サーバーが、フェールオーバー パートナーとして機能しているサーバーを参照していない場合は、サーバーへの接続が拒否されます。</span><span class="sxs-lookup"><span data-stu-id="82223-130">If the failover partner server supplied by the client does not refer to a server acting as a failover partner, the connection is refused by the server.</span></span> <span data-ttu-id="82223-131">アプリケーションが構成の変更に対応できるようにするため、接続を確立した後で属性を調査することにより、実際のフェールオーバー パートナーの ID を特定できます。</span><span class="sxs-lookup"><span data-stu-id="82223-131">To allow applications to adapt to configuration changes, the identity of the actual failover partner can be determined by inspecting the attribute after the connection has been established.</span></span> <span data-ttu-id="82223-132">パートナー情報をキャッシュして接続文字列を更新することを検討するか、最初の接続に失敗した場合の再接続の方法を検討することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="82223-132">You should consider caching the partner information to update the connection string or devise a retry strategy in the event that the first attempt at making a connection fails.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="82223-133">この機能を DSN、接続文字列、または接続プロパティや接続属性で使用する場合は、接続で使用するデータベースを明示的に指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="82223-133">You must explicitly specify the database to be used by a connection if you want to use this feature in a DSN, connection string, or connection property/attribute.</span></span> <span data-ttu-id="82223-134">指定しないと、[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client はパートナー データベースへのフェールオーバーを実行しません。</span><span class="sxs-lookup"><span data-stu-id="82223-134">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client will not attempt to failover to the partner database if this is not done.</span></span>  
>   
>  <span data-ttu-id="82223-135">ミラー化はデータベースの機能です。</span><span class="sxs-lookup"><span data-stu-id="82223-135">Mirroring is a feature of the database.</span></span> <span data-ttu-id="82223-136">複数のデータベースを併用するアプリケーションでは、この機能を利用できない場合があります。</span><span class="sxs-lookup"><span data-stu-id="82223-136">Applications that use multiple databases might not be able to exploit this feature.</span></span>  
>   
>  <span data-ttu-id="82223-137">また、サーバー名は大文字小文字が区別されませんが、データベース名は区別されます。</span><span class="sxs-lookup"><span data-stu-id="82223-137">In addition, server names are case insensitive, but database names are case sensitive.</span></span> <span data-ttu-id="82223-138">したがって、大文字小文字の使い方を DSN と接続文字列で統一してください。</span><span class="sxs-lookup"><span data-stu-id="82223-138">You should therefore make sure that you use the same casing in DSNs and connection strings.</span></span>  
  
## <a name="sql-server-native-client-ole-db-provider"></a><span data-ttu-id="82223-139">SQL Server Native Client OLE DB プロバイダー</span><span class="sxs-lookup"><span data-stu-id="82223-139">SQL Server Native Client OLE DB Provider</span></span>  
 <span data-ttu-id="82223-140">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB プロバイダーは、接続および接続文字列の属性を使用してデータベースミラーリングをサポートしています。</span><span class="sxs-lookup"><span data-stu-id="82223-140">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="82223-141">DBPROPSET_SQLSERVERDBINIT プロパティ セットには、SSPROP_INIT_FAILOVERPARTNER プロパティが追加されています。`FailoverPartner` キーワードは、DBPROP_INIT_PROVIDERSTRING の新しい接続文字列属性です。</span><span class="sxs-lookup"><span data-stu-id="82223-141">The SSPROP_INIT_FAILOVERPARTNER property has been added to the DBPROPSET_SQLSERVERDBINIT property set, and the `FailoverPartner` keyword is a new connection string attribute for DBPROP_INIT_PROVIDERSTRING.</span></span> <span data-ttu-id="82223-142">詳細については、「 [SQL Server Native Client での接続文字列キーワードの使用](../applications/using-connection-string-keywords-with-sql-server-native-client.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="82223-142">For more information, see [Using Connection String Keywords with SQL Server Native Client](../applications/using-connection-string-keywords-with-sql-server-native-client.md).</span></span>  
  
 <span data-ttu-id="82223-143">フェールオーバーキャッシュは、プロバイダーが読み込まれるまで保持されます。これは、 **CoUninitialize**が呼び出されるか、または、アプリケーションに、 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] データソースオブジェクトなどの Native Client OLE DB プロバイダーによって管理されるオブジェクトへの参照が含まれている限り保持されます。</span><span class="sxs-lookup"><span data-stu-id="82223-143">The failover cache is maintained as long as the provider is loaded, which is until **CoUninitialize** is called or as long as the application has a reference to some object managed by the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider such as a data source object.</span></span>  
  
 <span data-ttu-id="82223-144">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB プロバイダーによるデータベースミラーリングのサポートの詳細については、「[初期化と承認のプロパティ](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="82223-144">For details about [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider support for database mirroring, see [Initialization and Authorization Properties](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md).</span></span>  
  
## <a name="sql-server-native-client-odbc-driver"></a><span data-ttu-id="82223-145">SQL Server Native Client ODBC ドライバー</span><span class="sxs-lookup"><span data-stu-id="82223-145">SQL Server Native Client ODBC Driver</span></span>  
 <span data-ttu-id="82223-146">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC ドライバーでは、接続と接続文字列の属性を使用してデータベースミラーリングをサポートしています。</span><span class="sxs-lookup"><span data-stu-id="82223-146">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="82223-147">具体的には、SQL_COPT_SS_FAILOVER_PARTNER 属性は[SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md)および[Sqlgetconnectattr](../../native-client-odbc-api/sqlgetconnectattr.md)関数で使用するために追加されています。と `Failover_Partner` キーワードが新しい接続文字列属性として追加されました。</span><span class="sxs-lookup"><span data-stu-id="82223-147">Specifically, the SQL_COPT_SS_FAILOVER_PARTNER attribute has been added for use with the [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) and [SQLGetConnectAttr](../../native-client-odbc-api/sqlgetconnectattr.md) functions; and the `Failover_Partner` keyword has been added as a new connection string attribute.</span></span>  
  
 <span data-ttu-id="82223-148">アプリケーションに環境ハンドルが少なくとも 1 つ割り当てられている限り、フェールオーバー キャッシュが保持されます。</span><span class="sxs-lookup"><span data-stu-id="82223-148">The failover cache is maintained as long as the application has at least one environment handle allocated.</span></span> <span data-ttu-id="82223-149">反対に、最後の環境ハンドルの割り当てが解除されると、キャッシュが消失します。</span><span class="sxs-lookup"><span data-stu-id="82223-149">Conversely, it is lost when the last environment handle is deallocated.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="82223-150">ODBC ドライバー マネージャーが拡張され、フェールオーバー サーバーの名前を指定できるようになりました。</span><span class="sxs-lookup"><span data-stu-id="82223-150">The ODBC Driver Manager has been enhanced to support the specification of the failover server name.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="82223-151">参照</span><span class="sxs-lookup"><span data-stu-id="82223-151">See Also</span></span>  
 <span data-ttu-id="82223-152">[SQL Server Native Client の機能](sql-server-native-client-features.md) </span><span class="sxs-lookup"><span data-stu-id="82223-152">[SQL Server Native Client Features](sql-server-native-client-features.md) </span></span>  
 <span data-ttu-id="82223-153">[データベース ミラーリング セッションへのクライアントの接続 &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="82223-153">[Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span></span>  
 [<span data-ttu-id="82223-154">データベース ミラーリング &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="82223-154">Database Mirroring &#40;SQL Server&#41;</span></span>](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)  
  
  
