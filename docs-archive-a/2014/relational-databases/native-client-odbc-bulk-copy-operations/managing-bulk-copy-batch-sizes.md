---
title: 一括コピーバッチサイズの管理 |Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client ODBC driver, bulk copy
- ODBC, bulk copy operations
- batches [ODBC]
- bulk copy [ODBC], batch sizes
ms.assetid: 4b24139f-788b-45a6-86dc-ae835435d737
author: rothja
ms.author: jroth
ms.openlocfilehash: 1f24ece176cbb834e4162f9e516ff23013fd256a
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87643312"
---
# <a name="managing-bulk-copy-batch-sizes"></a><span data-ttu-id="fff5c-102">一括コピー バッチ サイズの管理</span><span class="sxs-lookup"><span data-stu-id="fff5c-102">Managing Bulk Copy Batch Sizes</span></span>
  <span data-ttu-id="fff5c-103">一括コピー操作でバッチを使用する主な目的は、トランザクションのスコープを定義することです。</span><span class="sxs-lookup"><span data-stu-id="fff5c-103">The primary purpose of a batch in bulk copy operations is to define the scope of a transaction.</span></span> <span data-ttu-id="fff5c-104">一括コピー関数では、バッチ サイズが設定されていないと、一括コピー全体を 1 つのトランザクションと見なします。</span><span class="sxs-lookup"><span data-stu-id="fff5c-104">If a batch size is not set, then bulk copy functions consider an entire bulk copy to be one transaction.</span></span> <span data-ttu-id="fff5c-105">バッチ サイズが設定されている場合、各バッチはそのバッチの終了時にコミットされるトランザクションで構成されます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-105">If a batch size is set, then each batch constitutes a transaction that is committed when the batch finishes.</span></span>  
  
 <span data-ttu-id="fff5c-106">バッチ サイズを指定せずに一括コピーを実行し、エラーが発生した場合は、一括コピー全体がロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-106">If a bulk copy is performed with no batch size specified and an error is encountered, the entire bulk copy is rolled back.</span></span> <span data-ttu-id="fff5c-107">実行時間が長い一括コピーの復旧には時間がかかることがあります。</span><span class="sxs-lookup"><span data-stu-id="fff5c-107">The recovery of a long-running bulk copy can take a long time.</span></span> <span data-ttu-id="fff5c-108">バッチ サイズを設定すると、各バッチが 1 つのトランザクションと見なされ、各バッチがコミットされます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-108">When a batch size is set, bulk copy considers each batch a transaction and commits each batch.</span></span> <span data-ttu-id="fff5c-109">エラーが発生した場合は、最後の未解決のバッチだけがロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-109">If an error is encountered, only the last outstanding batch needs to be rolled back.</span></span>  
  
 <span data-ttu-id="fff5c-110">バッチ サイズは、ロックのオーバーヘッドにも影響を与えることがあります。</span><span class="sxs-lookup"><span data-stu-id="fff5c-110">The batch size can also affect locking overhead.</span></span> <span data-ttu-id="fff5c-111">に対して一括コピーを実行する場合は [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 、 [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md)を使用して TABLOCK ヒントを指定し、行ロックではなくテーブルロックを取得できます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-111">When performing a bulk copy against [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the TABLOCK hint can be specified using [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md) to acquire a table lock instead of row locks.</span></span> <span data-ttu-id="fff5c-112">1 つのテーブル ロックを設定すると、一括コピー操作全体のオーバーヘッドを最小限に抑えることができます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-112">The single table lock can be held with minimal overhead for an entire bulk copy operation.</span></span> <span data-ttu-id="fff5c-113">TABLOCK を指定しないと各行がロックされるので、一括コピーの実行中にすべてのロックを保持するオーバーヘッドにより、パフォーマンスが低下することがあります。</span><span class="sxs-lookup"><span data-stu-id="fff5c-113">If TABLOCK is not specified then locks are held on individual rows and the overhead of maintaining all the locks for the duration of the bulk copy can slow performance.</span></span> <span data-ttu-id="fff5c-114">トランザクションの長さだけロックが保持されるので、バッチ サイズを指定すると、定期的にコミットが発生して、その時点で保持されているロックが解放されるため、この問題を解決できます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-114">Because locks are only held for the length of a transaction, specifying a batch size addresses this problem by periodically generating a commit that frees the locks currently held.</span></span>  
  
 <span data-ttu-id="fff5c-115">大量の行を一括コピーする場合、1 つのバッチを構成する行数がパフォーマンスに大きな影響を与えることがあります。</span><span class="sxs-lookup"><span data-stu-id="fff5c-115">The number of rows making up a batch can have significant performance effects when bulk copying a large number of rows.</span></span> <span data-ttu-id="fff5c-116">推奨バッチ サイズは、実行する一括コピーの種類によって異なります。</span><span class="sxs-lookup"><span data-stu-id="fff5c-116">The recommendations for batch size depend on the type of bulk copy being performed.</span></span>  
  
-   <span data-ttu-id="fff5c-117">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] への一括コピーを行う場合は、TABLOCK 一括コピー ヒントを指定し、大きなバッチ サイズを設定します。</span><span class="sxs-lookup"><span data-stu-id="fff5c-117">When bulk copying to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], specify the TABLOCK bulk copy hint and set a large batch size.</span></span>  
  
-   <span data-ttu-id="fff5c-118">TABLOCK を指定しない場合は、バッチ サイズを 1,000 行未満に制限します。</span><span class="sxs-lookup"><span data-stu-id="fff5c-118">When TABLOCK is not specified, limit batch sizes to less than 1,000 rows.</span></span>  
  
 <span data-ttu-id="fff5c-119">データファイルから一括コピーする場合は、 [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md)を呼び出す前に、bcpbatch オプションを指定して**bcp_control**を呼び出すことによってバッチサイズを指定します。</span><span class="sxs-lookup"><span data-stu-id="fff5c-119">When bulk copying in from a data file, the batch size is specified by calling **bcp_control** with the BCPBATCH option before calling [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md).</span></span> <span data-ttu-id="fff5c-120">[Bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md)と[bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md)を使用してプログラム変数から一括コピーを行う場合、バッチサイズは[bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x*回を呼び出した後[bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md)を呼び出すことによって制御されます。ここで、 *x*はバッチ内の行数です。</span><span class="sxs-lookup"><span data-stu-id="fff5c-120">When bulk copying from program variables using [bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md) and [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md), the batch size is controlled by calling [bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md) after calling [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x* times, where *x* is the number of rows in a batch.</span></span>  
  
 <span data-ttu-id="fff5c-121">バッチはトランザクションのサイズを指定するだけでなく、ネットワーク経由でサーバーに行を送信するときにも影響を与えます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-121">In addition to specifying the size of a transaction, batches also affect when rows are sent across the network to the server.</span></span> <span data-ttu-id="fff5c-122">一括コピー関数は、通常、ネットワークパケットがいっぱいになるまで**bcp_sendrow**から行をキャッシュしてから、完全なパケットをサーバーに送信します。</span><span class="sxs-lookup"><span data-stu-id="fff5c-122">Bulk copy functions normally cache the rows from **bcp_sendrow** until a network packet is filled, and then send the full packet to the server.</span></span> <span data-ttu-id="fff5c-123">ただし、アプリケーションが**bcp_batch**を呼び出すと、そのパケットがいっぱいになっているかどうかに関係なく、現在のパケットがサーバーに送信されます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-123">When an application calls **bcp_batch**, however, the current packet is sent to the server regardless of whether it has been filled.</span></span> <span data-ttu-id="fff5c-124">バッチ サイズを非常に小さくすると、いっぱいになっていないパケットが大量にサーバーに送信されるので、パフォーマンスが低下することがあります。</span><span class="sxs-lookup"><span data-stu-id="fff5c-124">Using a very low batch size can slow performance if it results in sending many partially filled packets to the server.</span></span> <span data-ttu-id="fff5c-125">たとえば、すべての**bcp_sendrow**の後に**bcp_batch**を呼び出すと、各行が個別のパケットで送信され、行が非常に大きい場合を除き、各パケットの領域が無駄になります。</span><span class="sxs-lookup"><span data-stu-id="fff5c-125">For example, calling **bcp_batch** after every **bcp_sendrow** causes each row to be sent in a separate packet and, unless the rows are very large, wastes space in each packet.</span></span> <span data-ttu-id="fff5c-126">SQL Server のネットワークパケットの既定のサイズは 4 KB ですが、アプリケーションでは、SQL_ATTR_PACKET_SIZE 属性を指定して[SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md)を呼び出すことによってサイズを変更できます。</span><span class="sxs-lookup"><span data-stu-id="fff5c-126">The default size of network packets for SQL Server is 4 KB, although an application can change the size by calling [SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md) specifying the SQL_ATTR_PACKET_SIZE attribute.</span></span>  
  
 <span data-ttu-id="fff5c-127">バッチのもう1つの副作用は、 **bcp_batch**で完了するまで、各バッチが未処理の結果セットと見なされることです。</span><span class="sxs-lookup"><span data-stu-id="fff5c-127">Another side effect of batches is that each batch is considered an outstanding result set until it is completed with **bcp_batch**.</span></span> <span data-ttu-id="fff5c-128">バッチが未処理のときに接続ハンドルで他の操作が試行された場合、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native CLIENT ODBC ドライバーでは、SQLState = "HY000" およびエラーメッセージ文字列の次のエラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="fff5c-128">If any other operations are attempted on a connection handle while a batch is outstanding, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC driver issues an error with SQLState = "HY000" and an error message string of:</span></span>  
  
```  
"[Microsoft][SQL Server Native Client] Connection is busy with  
results for another hstmt."  
```  
  
## <a name="see-also"></a><span data-ttu-id="fff5c-129">参照</span><span class="sxs-lookup"><span data-stu-id="fff5c-129">See Also</span></span>  
 <span data-ttu-id="fff5c-130">[ODBC&#41;&#40;の一括コピー操作の実行](performing-bulk-copy-operations-odbc.md) </span><span class="sxs-lookup"><span data-stu-id="fff5c-130">[Performing Bulk Copy Operations &#40;ODBC&#41;](performing-bulk-copy-operations-odbc.md) </span></span>  
 [<span data-ttu-id="fff5c-131">データの一括インポートと一括エクスポート &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="fff5c-131">Bulk Import and Export of Data &#40;SQL Server&#41;</span></span>](../import-export/bulk-import-and-export-of-data-sql-server.md)  
  
  
