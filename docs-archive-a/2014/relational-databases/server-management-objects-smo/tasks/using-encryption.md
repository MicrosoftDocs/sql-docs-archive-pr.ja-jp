---
title: Encryption | を使用するMicrosoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: reference
helpviewer_keywords:
- database master key [SMO]
- cryptography [SMO]
- cryptography [SQL Server], SMO
- encryption keys [SMO]
- encryption [SQL Server], SMO
- encryption [SMO]
- certificates [SMO]
- service master key [SMO]
ms.assetid: 405e0ed7-50a9-430e-a343-471f54b4af76
author: stevestein
ms.author: sstein
ms.openlocfilehash: 1f1f7d6a8714deb1317562dce669fa0e7adbd45c
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87644402"
---
# <a name="using-encryption"></a><span data-ttu-id="04f01-102">暗号化の使用</span><span class="sxs-lookup"><span data-stu-id="04f01-102">Using Encryption</span></span>
  <span data-ttu-id="04f01-103">SMO では、サービス マスター キーは <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey> オブジェクトで表現します。</span><span class="sxs-lookup"><span data-stu-id="04f01-103">In SMO, the service master key is represented by the <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey> object.</span></span> <span data-ttu-id="04f01-104">これは、<xref:Microsoft.SqlServer.Management.Smo.Server.ServiceMasterKey%2A> オブジェクトの <xref:Microsoft.SqlServer.Management.Smo.Server> プロパティによって参照されます。</span><span class="sxs-lookup"><span data-stu-id="04f01-104">This is referenced by the <xref:Microsoft.SqlServer.Management.Smo.Server.ServiceMasterKey%2A> property of the <xref:Microsoft.SqlServer.Management.Smo.Server> object.</span></span> <span data-ttu-id="04f01-105"><xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey.Regenerate%2A> メソッドを使用して、再生成することができます。</span><span class="sxs-lookup"><span data-stu-id="04f01-105">It can be regenerated by using the <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey.Regenerate%2A> method.</span></span>  
  
 <span data-ttu-id="04f01-106">データベース マスター キーは、<xref:Microsoft.SqlServer.Management.Smo.MasterKey> オブジェクトによって表されます。</span><span class="sxs-lookup"><span data-stu-id="04f01-106">The database master key is represented by the <xref:Microsoft.SqlServer.Management.Smo.MasterKey> object.</span></span> <span data-ttu-id="04f01-107"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.IsEncryptedByServer%2A> プロパティでは、データベース マスター キーがサービス マスター キーによって暗号化されるのかどうかが示されます。</span><span class="sxs-lookup"><span data-stu-id="04f01-107">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.IsEncryptedByServer%2A> property indicates whether or not the database master key is encrypted by the service master key.</span></span> <span data-ttu-id="04f01-108">master データベース内の暗号化されたコピーは、データベース マスター キーが変更されるたびに自動的に更新されます。</span><span class="sxs-lookup"><span data-stu-id="04f01-108">The encrypted copy in the master database is automatically updated whenever the database master key is changed.</span></span>  
  
 <span data-ttu-id="04f01-109"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> メソッドを使用してサービス キー暗号化を削除し、パスワードを使ってデータベース マスター キーを暗号化することが可能です。</span><span class="sxs-lookup"><span data-stu-id="04f01-109">It is possible to drop service key encryption using the <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> method and encrypt the database master key with a password.</span></span> <span data-ttu-id="04f01-110">この場合、セキュリティで保護された秘密キーにアクセスする前に、データベース マスター キーを明示的に開く必要があります。</span><span class="sxs-lookup"><span data-stu-id="04f01-110">In that situation, you will have to explicitly open the database master key before accessing private keys that it has secured.</span></span>  
  
 <span data-ttu-id="04f01-111">データベースを [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] のインスタンスにアタッチする際には、データベース マスター キーのパスワードを指定するか、サービス マスター キーでの暗号化に使用できるデータベース マスター キーの非暗号化コピーを作成するための <xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> メソッドを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="04f01-111">When a database is being attached to an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], you must either supply the password for the database master key or execute the <xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> method to make an unencrypted copy of the database master key available for encryption with the service master key.</span></span> <span data-ttu-id="04f01-112">データベース マスター キーを明示的に開く必要性を回避するには、この手順をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="04f01-112">This step is recommended to avoid the need to explicitly open the database master key.</span></span>  
  
 <span data-ttu-id="04f01-113"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.Regenerate%2A> メソッドは、データベース マスター キーを再生成します。</span><span class="sxs-lookup"><span data-stu-id="04f01-113">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.Regenerate%2A> method regenerates the database master key.</span></span> <span data-ttu-id="04f01-114">データベース マスター キーが再生成されると、このデータベース マスター キーで暗号化されたすべてのキーの暗号化が解除され、これらのキーが新しいデータベース マスター キーで暗号化されます。</span><span class="sxs-lookup"><span data-stu-id="04f01-114">When the database master key is regenerated, all the keys that have been encrypted with the database master key are decrypted, and then encrypts them with the new database master key.</span></span> <span data-ttu-id="04f01-115"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> メソッドは、サービス マスター キーを使用してデータベース マスター キーの暗号化を削除します。</span><span class="sxs-lookup"><span data-stu-id="04f01-115">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> method removes the encryption of the database master key by the service master key.</span></span> <span data-ttu-id="04f01-116"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> は、サービス マスター キーを使用してマスター キーのコピーを暗号化し、現在のデータベースおよび master データベースの両方に格納します。</span><span class="sxs-lookup"><span data-stu-id="04f01-116"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> causes a copy of the master key to be encrypted using the service master key and stored in both the current database and in the master database.</span></span>  
  
 <span data-ttu-id="04f01-117">SMO では、証明書は <xref:Microsoft.SqlServer.Management.Smo.Certificate> オブジェクトで表現します。</span><span class="sxs-lookup"><span data-stu-id="04f01-117">In SMO, certificates are represented by the <xref:Microsoft.SqlServer.Management.Smo.Certificate> object.</span></span> <span data-ttu-id="04f01-118"><xref:Microsoft.SqlServer.Management.Smo.Certificate> オブジェクトには、公開キー、サブジェクト名、有効期間、および発行者に関する情報を指定するプロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="04f01-118">The <xref:Microsoft.SqlServer.Management.Smo.Certificate> object has properties that specify the public key, the name of the subject, period of validity, and information about the issuer.</span></span> <span data-ttu-id="04f01-119">証明書にアクセスする権限は、`Grant` メソッド、`Revoke` メソッド、および `Deny` メソッドを使用して制御されます。</span><span class="sxs-lookup"><span data-stu-id="04f01-119">Permission to access the certificate is controlled by using the `Grant`, `Revoke` and `Deny` methods.</span></span>  
  
## <a name="example"></a><span data-ttu-id="04f01-120">例</span><span class="sxs-lookup"><span data-stu-id="04f01-120">Example</span></span>  
 <span data-ttu-id="04f01-121">次のコード例では、アプリケーションを作成するプログラミング環境、プログラミング テンプレート、およびプログラミング言語を選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="04f01-121">For the following code example, you will have to select the programming environment, programming template and the programming language to create your application.</span></span> <span data-ttu-id="04f01-122">詳細については、「 [Visual studio .net での VISUAL BASIC Smo プロジェクトの作成](../../../database-engine/dev-guide/create-a-visual-basic-smo-project-in-visual-studio-net.md)」および「visual [Studio .Net で VISUAL C&#35; Smo プロジェクトを作成](../how-to-create-a-visual-csharp-smo-project-in-visual-studio-net.md)する」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="04f01-122">For more information, see [Create a Visual Basic SMO Project in Visual Studio .NET](../../../database-engine/dev-guide/create-a-visual-basic-smo-project-in-visual-studio-net.md) and [Create a Visual C&#35; SMO Project in Visual Studio .NET](../how-to-create-a-visual-csharp-smo-project-in-visual-studio-net.md).</span></span>  
  
## <a name="adding-a-certificate-in-visual-basic"></a><span data-ttu-id="04f01-123">Visual Basic での証明書の追加</span><span class="sxs-lookup"><span data-stu-id="04f01-123">Adding a Certificate in Visual Basic</span></span>  
 <span data-ttu-id="04f01-124">コード例では、暗号化パスワードを持つ簡単な証明書を作成します。</span><span class="sxs-lookup"><span data-stu-id="04f01-124">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="04f01-125">他のオブジェクトと異なり、<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> メソッドには複数のオーバーロードがあります。</span><span class="sxs-lookup"><span data-stu-id="04f01-125">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="04f01-126">この例で使用するオーバーロードは、暗号化パスワードを持つ新しい証明書を作成しています。</span><span class="sxs-lookup"><span data-stu-id="04f01-126">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
<!-- TODO: review snippet reference  [!CODE [SMO How to#SMO_VBCertificate1](SMO How to#SMO_VBCertificate1)]  -->  
  
## <a name="adding-a-certificate-in-visual-c"></a><span data-ttu-id="04f01-127">Visual C# での証明書の追加</span><span class="sxs-lookup"><span data-stu-id="04f01-127">Adding a Certificate in Visual C#</span></span>  
 <span data-ttu-id="04f01-128">コード例では、暗号化パスワードを持つ簡単な証明書を作成します。</span><span class="sxs-lookup"><span data-stu-id="04f01-128">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="04f01-129">他のオブジェクトと異なり、<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> メソッドには複数のオーバーロードがあります。</span><span class="sxs-lookup"><span data-stu-id="04f01-129">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="04f01-130">この例で使用するオーバーロードは、暗号化パスワードを持つ新しい証明書を作成しています。</span><span class="sxs-lookup"><span data-stu-id="04f01-130">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
```csharp
{  
            //Connect to the local, default instance of SQL Server.   
            {  
                Server srv = new Server();  
  
                //Reference the AdventureWorks2012 database.   
                Database db = srv.Databases["AdventureWorks2012"];  
  
                //Define a Certificate object variable by supplying the parent database and name in the constructor.   
                Certificate c = new Certificate(db, "Test_Certificate");  
  
                //Set the start date, expiry date, and description.   
                System.DateTime dt;  
                DateTime.TryParse("January 01, 2010", out dt);  
                c.StartDate = dt;  
                DateTime.TryParse("January 01, 2015", out dt);  
                c.ExpirationDate = dt;  
                c.Subject = "This is a test certificate.";  
                //Create the certificate on the instance of SQL Server by supplying the certificate password argument.   
                c.Create("pGFD4bb925DGvbd2439587y");  
            }  
        }   
```  
  
## <a name="adding-a-certificate-in-powershell"></a><span data-ttu-id="04f01-131">PowerShell での証明書の追加</span><span class="sxs-lookup"><span data-stu-id="04f01-131">Adding a Certificate in PowerShell</span></span>  
 <span data-ttu-id="04f01-132">コード例では、暗号化パスワードを持つ簡単な証明書を作成します。</span><span class="sxs-lookup"><span data-stu-id="04f01-132">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="04f01-133">他のオブジェクトと異なり、<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> メソッドには複数のオーバーロードがあります。</span><span class="sxs-lookup"><span data-stu-id="04f01-133">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="04f01-134">この例で使用するオーバーロードは、暗号化パスワードを持つ新しい証明書を作成しています。</span><span class="sxs-lookup"><span data-stu-id="04f01-134">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
```powershell
# Set the path context to the local, default instance of SQL Server and get a reference to AdventureWorks2012  
CD \sql\localhost\default\databases  
$db = get-item AdventureWorks2012  
  
#Create a certificate
$c = New-Object -TypeName Microsoft.SqlServer.Management.Smo.Certificate -ArgumentList $db, "Test_Certificate"  
$c.StartDate = "January 01, 2010"  
$c.Subject = "This is a test certificate."  
$c.ExpirationDate = "January 01, 2015"  
  
#Create the certificate on the instance of SQL Server by supplying the certificate password argument.  
$c.Create("pGFD4bb925DGvbd2439587y")
```  
  
## <a name="see-also"></a><span data-ttu-id="04f01-135">参照</span><span class="sxs-lookup"><span data-stu-id="04f01-135">See Also</span></span>  
 [<span data-ttu-id="04f01-136">暗号化キーの使用</span><span class="sxs-lookup"><span data-stu-id="04f01-136">Using Encryption Keys</span></span>](using-encryption.md)  
