---
title: ログオン トリガー | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
f1_keywords:
- logon triggers
- login triggers
helpviewer_keywords:
- triggers [SQL Server], logon
ms.assetid: 2f0ebb2f-de10-482d-9806-1a5de5b312b8
author: rothja
ms.author: jroth
ms.openlocfilehash: cda0be25f07ed2ee283b9707884041e7c6e4692f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87644881"
---
# <a name="logon-triggers"></a><span data-ttu-id="db6de-102">ログオン トリガー</span><span class="sxs-lookup"><span data-stu-id="db6de-102">Logon Triggers</span></span>
  <span data-ttu-id="db6de-103">ログオン トリガーは、LOGON イベントに応答してストアド プロシージャを起動します。</span><span class="sxs-lookup"><span data-stu-id="db6de-103">Logon triggers fire stored procedures in response to a LOGON event.</span></span> <span data-ttu-id="db6de-104">このイベントは、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]インスタンスでユーザー セッションが確立されるときに発生します。</span><span class="sxs-lookup"><span data-stu-id="db6de-104">This event is raised when a user session is established with an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="db6de-105">ログオン トリガーは、ログインの認証段階が終了した後、ユーザー セッションが実際に確立されるまでの間に発生します。</span><span class="sxs-lookup"><span data-stu-id="db6de-105">Logon triggers fire after the authentication phase of logging in finishes, but before the user session is actually established.</span></span> <span data-ttu-id="db6de-106">したがって、通常、エラー メッセージや PRINT ステートメントからのメッセージはユーザーに通知されますが、このトリガー内で発生したすべてのメッセージは [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のエラー ログに記録されます。</span><span class="sxs-lookup"><span data-stu-id="db6de-106">Therefore, all messages originating inside the trigger that would typically reach the user, such as error messages and messages from the PRINT statement, are diverted to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="db6de-107">認証に失敗した場合は、ログオン トリガーが作動しません。</span><span class="sxs-lookup"><span data-stu-id="db6de-107">Logon triggers do not fire if authentication fails.</span></span>  
  
 <span data-ttu-id="db6de-108">ログオン トリガーを使用すると、ログインの利用状況を追跡したり、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]へのログインを制限したり、特定のログインのセッション数を制限したりすることで、サーバー セッションを監査し制御できます。</span><span class="sxs-lookup"><span data-stu-id="db6de-108">You can use logon triggers to audit and control server sessions, such as by tracking login activity, restricting logins to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], or limiting the number of sessions for a specific login.</span></span> <span data-ttu-id="db6de-109">たとえば、次のコードでは、ログイン [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login_test *によってユーザー セッションが既に 3 つ生成されている場合、ログオン トリガーは、そのログインが開始する* へのログイン試行を拒否します。</span><span class="sxs-lookup"><span data-stu-id="db6de-109">For example, in the following code, the logon trigger denies log in attempts to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] initiated by login *login_test* if there are already three user sessions created by that login.</span></span>  
  
 [!code-sql[TriggerDDL#LogonTrigger1](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#logontrigger1)]  
  
 <span data-ttu-id="db6de-110">LOGON イベントが AUDIT_LOGIN SQL トレース イベントに対応していることに注意してください。このトレース イベントは、 [イベント通知](../service-broker/event-notifications.md)で使用できます。</span><span class="sxs-lookup"><span data-stu-id="db6de-110">Note that the LOGON event corresponds to the AUDIT_LOGIN SQL Trace event, which can be used in [Event Notifications](../service-broker/event-notifications.md).</span></span> <span data-ttu-id="db6de-111">トリガーとイベント通知の主な相違点は、トリガーがイベントと同期的に発生するのに対し、イベント通知は非同期的に発生することです。</span><span class="sxs-lookup"><span data-stu-id="db6de-111">The primary difference between triggers and event notifications is that triggers are raised synchronously with events, whereas event notifications are asynchronous.</span></span> <span data-ttu-id="db6de-112">つまり、セッションが確立されないようにする場合は、ログオン トリガーを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="db6de-112">This means, for example, that if you want to stop a session from being established, you must use a logon trigger.</span></span> <span data-ttu-id="db6de-113">この目的では、AUDIT_LOGIN イベントのイベント通知を使用できません。</span><span class="sxs-lookup"><span data-stu-id="db6de-113">An event notification on an AUDIT_LOGIN event cannot be used for this purpose.</span></span>  
  
## <a name="specifying-first-and-last-trigger"></a><span data-ttu-id="db6de-114">最初と最後のトリガーの指定</span><span class="sxs-lookup"><span data-stu-id="db6de-114">Specifying First and Last Trigger</span></span>  
 <span data-ttu-id="db6de-115">LOGON イベントでは、複数のトリガーを定義できます。</span><span class="sxs-lookup"><span data-stu-id="db6de-115">Multiple triggers can be defined on the LOGON event.</span></span> <span data-ttu-id="db6de-116">[sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) システム ストアド プロシージャを使用すると、定義したトリガーの 1 つを、イベントで起動される最初または最後のトリガーとして指定できます。</span><span class="sxs-lookup"><span data-stu-id="db6de-116">Any one of these triggers can be designated the first or last trigger to be fired on an event by using the [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) system stored procedure.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="db6de-117">では、残りのトリガーの実行順序は保証されません。</span><span class="sxs-lookup"><span data-stu-id="db6de-117">does not guarantee the execution order of the remaining triggers.</span></span>  
  
## <a name="managing-transactions"></a><span data-ttu-id="db6de-118">トランザクションの管理</span><span class="sxs-lookup"><span data-stu-id="db6de-118">Managing Transactions</span></span>  
 <span data-ttu-id="db6de-119">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] によってログオン トリガーが起動される前に、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] では、任意のユーザー トランザクションに依存しない暗黙のトランザクションが作成されます。</span><span class="sxs-lookup"><span data-stu-id="db6de-119">Before [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fires a logon trigger, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an implicit transaction that is independent from any user transaction.</span></span> <span data-ttu-id="db6de-120">その結果、最初のログオン トリガーが起動し始めると、トランザクション数は 1 になります。</span><span class="sxs-lookup"><span data-stu-id="db6de-120">Therefore, when the first logon trigger starts firing, the transaction count is 1.</span></span> <span data-ttu-id="db6de-121">すべてのログオン トリガーの実行が完了すると、トランザクションがコミットされます。</span><span class="sxs-lookup"><span data-stu-id="db6de-121">After all the logon triggers finish executing, the transaction commits.</span></span> <span data-ttu-id="db6de-122">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] では、他の種類のトリガーと同様に、トランザクション数が 0 の状態でログオン トリガーの実行が完了すると、エラーが返されます。</span><span class="sxs-lookup"><span data-stu-id="db6de-122">As with other types of triggers, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] returns an error if a logon trigger finishes execution with a transaction count of 0.</span></span> <span data-ttu-id="db6de-123">ROLLBACK TRANSACTION ステートメントは、入れ子になったトランザクション内で実行される場合でも、トランザクション数を 0 にリセットします。</span><span class="sxs-lookup"><span data-stu-id="db6de-123">The ROLLBACK TRANSACTION statement resets the transaction count to 0, even if the statement is issued inside a nested transaction.</span></span> <span data-ttu-id="db6de-124">COMMIT TRANSACTION を実行すると、トランザクション数が 0 まで減少することがあります。</span><span class="sxs-lookup"><span data-stu-id="db6de-124">COMMIT TRANSACTION might decrement the transaction count to 0.</span></span> <span data-ttu-id="db6de-125">そのため、ログオン トリガー内では COMMIT TRANSACTION ステートメントを実行しないことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="db6de-125">Therefore, we advise against issuing COMMIT TRANSACTION statements inside logon triggers.</span></span>  
  
 <span data-ttu-id="db6de-126">ログオン トリガー内で ROLLBACK TRANSACTION ステートメントを使用する場合は、次の点を考慮してください。</span><span class="sxs-lookup"><span data-stu-id="db6de-126">Consider the following when you are using a ROLLBACK TRANSACTION statement inside logon triggers:</span></span>  
  
-   <span data-ttu-id="db6de-127">ROLLBACK TRANSACTION が実行されるまでに行われたデータ変更がすべてロールバックされます。</span><span class="sxs-lookup"><span data-stu-id="db6de-127">Any data modifications made up to the point of ROLLBACK TRANSACTION are rolled back.</span></span> <span data-ttu-id="db6de-128">これには、現在のトリガーによる変更、および同じイベントで先に実行されたトリガーによる変更が含まれます。</span><span class="sxs-lookup"><span data-stu-id="db6de-128">These modifications include those made by the current trigger and those made by previous triggers that executed on the same event.</span></span> <span data-ttu-id="db6de-129">特定のイベントに対する残りのトリガーは実行されません。</span><span class="sxs-lookup"><span data-stu-id="db6de-129">Any remaining triggers for the specific event are not executed.</span></span>  
  
-   <span data-ttu-id="db6de-130">現在のトリガーは、ROLLBACK ステートメントの後にある残りのステートメントすべてを引き続き実行します。</span><span class="sxs-lookup"><span data-stu-id="db6de-130">The current trigger continues to execute any remaining statements that appear after the ROLLBACK statement.</span></span> <span data-ttu-id="db6de-131">これらのステートメントのいずれかがデータを変更する場合、その変更はロールバックされません。</span><span class="sxs-lookup"><span data-stu-id="db6de-131">If any of these statements modify data, the modifications are not rolled back.</span></span>  
  
 <span data-ttu-id="db6de-132">LOGON イベントでトリガーを実行中に次のいずれかの状況が発生すると、ユーザー セッションは確立されません。</span><span class="sxs-lookup"><span data-stu-id="db6de-132">A user session is not established if any one of the following conditions occur during execution of a trigger on a LOGON event:</span></span>  
  
-   <span data-ttu-id="db6de-133">元の暗黙のトランザクションがロールバックされるか失敗した。</span><span class="sxs-lookup"><span data-stu-id="db6de-133">The original implicit transaction is rolled back or fails.</span></span>  
  
-   <span data-ttu-id="db6de-134">重大度が 20 を超えるエラーがトリガー内部で発生した。</span><span class="sxs-lookup"><span data-stu-id="db6de-134">An error that has severity greater than 20 is raised inside the trigger body.</span></span>  
  
## <a name="disabling-a-logon-trigger"></a><span data-ttu-id="db6de-135">ログオン トリガーを無効にする</span><span class="sxs-lookup"><span data-stu-id="db6de-135">Disabling a Logon Trigger</span></span>  
 <span data-ttu-id="db6de-136">ログオン トリガーを使用すると、`sysadmin` 固定サーバー ロールのメンバーを含むすべてのユーザーの[!INCLUDE[ssDE](../../../includes/ssde-md.md)]への接続を効率的に禁止できます。</span><span class="sxs-lookup"><span data-stu-id="db6de-136">A logon trigger can effectively prevent successful connections to the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] for all users, including members of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="db6de-137">ログオン トリガーによって接続が禁止されているときでも、`sysadmin` 固定サーバー ロールのメンバーは、専用管理者接続を使用するか、または[!INCLUDE[ssDE](../../../includes/ssde-md.md)]を最小構成モード (-f) で起動することにより、接続できます。</span><span class="sxs-lookup"><span data-stu-id="db6de-137">When a logon trigger is preventing connections, members of the `sysadmin` fixed server role can connect by using the dedicated administrator connection, or by starting the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] in minimal configuration mode (-f).</span></span> <span data-ttu-id="db6de-138">詳細については、「 [データベース エンジン サービスのスタートアップ オプション](../../database-engine/configure-windows/database-engine-service-startup-options.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="db6de-138">For more information, see [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="db6de-139">Related Tasks</span><span class="sxs-lookup"><span data-stu-id="db6de-139">Related Tasks</span></span>  
  
|<span data-ttu-id="db6de-140">タスク</span><span class="sxs-lookup"><span data-stu-id="db6de-140">Task</span></span>|<span data-ttu-id="db6de-141">トピック</span><span class="sxs-lookup"><span data-stu-id="db6de-141">Topic</span></span>|  
|----------|-----------|  
|<span data-ttu-id="db6de-142">ログオン トリガーの作成方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="db6de-142">Describes how to create logon triggers.</span></span> <span data-ttu-id="db6de-143">ログオン トリガーは、どのデータベースからでも作成できますが、サーバー レベルで登録されるため **master** データベースに存在します。</span><span class="sxs-lookup"><span data-stu-id="db6de-143">Logon triggers can be created from any database, but are registered at the server level and reside in the **master** database.</span></span>|[<span data-ttu-id="db6de-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="db6de-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-trigger-transact-sql)|  
|<span data-ttu-id="db6de-145">ログオン トリガーを変更する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="db6de-145">Describes how to modify logon triggers.</span></span>|[<span data-ttu-id="db6de-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="db6de-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-trigger-transact-sql)|  
|<span data-ttu-id="db6de-147">ログオン トリガーを削除する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="db6de-147">Describes how to delete logon triggers.</span></span>|[<span data-ttu-id="db6de-148">DROP TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="db6de-148">DROP TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/drop-trigger-transact-sql)|  
|<span data-ttu-id="db6de-149">ログオン トリガーに関する情報を取得する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="db6de-149">Describes how to return information about logon triggers.</span></span>|[<span data-ttu-id="db6de-150">sys.server_triggers &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="db6de-150">sys.server_triggers &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-triggers-transact-sql)<br /><br /> [<span data-ttu-id="db6de-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="db6de-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-trigger-events-transact-sql)|  
|<span data-ttu-id="db6de-152">ログオン トリガーのイベント データをキャプチャする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="db6de-152">Describes how to capture logon trigger event data.</span></span>||  
  
## <a name="see-also"></a><span data-ttu-id="db6de-153">参照</span><span class="sxs-lookup"><span data-stu-id="db6de-153">See Also</span></span>  
 [<span data-ttu-id="db6de-154">DDL トリガー</span><span class="sxs-lookup"><span data-stu-id="db6de-154">DDL Triggers</span></span>](../triggers/ddl-triggers.md)  
  
  
