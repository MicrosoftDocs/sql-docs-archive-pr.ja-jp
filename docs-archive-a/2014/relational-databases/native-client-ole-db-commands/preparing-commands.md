---
title: コマンドの準備 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client OLE DB provider, commands
- prepared statements [SQL Server Native Client]
- commands [OLE DB]
- command preparation [SQL Server Native Client]
ms.assetid: 09ec0c6c-0a44-4766-b9b7-5092f676ee54
author: rothja
ms.author: jroth
ms.openlocfilehash: e06e6afab622953452a00751e3a55d49fc7b8ec7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/04/2020
ms.locfileid: "87713157"
---
# <a name="preparing-commands"></a><span data-ttu-id="25eaa-102">コマンドの準備</span><span class="sxs-lookup"><span data-stu-id="25eaa-102">Preparing Commands</span></span>
  <span data-ttu-id="25eaa-103">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダーでは、1 つのコマンドを最適化された状態で複数回実行できるように、コマンドを準備できます。ただし、コマンドを準備することでオーバーヘッドが生じるので、コンシューマーではコマンドを 2 回程度実行する場合は準備する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="25eaa-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports command preparation for optimized multiple execution of a single command; however, command preparation generates overhead, and a consumer does not need to prepare a command to execute it more than once.</span></span> <span data-ttu-id="25eaa-104">一般的には、コマンドを 4 回以上実行する場合に準備します。</span><span class="sxs-lookup"><span data-stu-id="25eaa-104">In general, a command should be prepared if it will be executed more than three times.</span></span>  
  
 <span data-ttu-id="25eaa-105">パフォーマンス上の理由から、コマンドの準備は、コマンドが実行されるまで遅延されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-105">For performance reasons, the command preparation is deferred until the command is executed.</span></span> <span data-ttu-id="25eaa-106">これは既定の動作です。</span><span class="sxs-lookup"><span data-stu-id="25eaa-106">This is the default behavior.</span></span> <span data-ttu-id="25eaa-107">準備中のコマンドのエラーは、コマンドまたはメタプロパティ操作が実行されるまで認識されません。</span><span class="sxs-lookup"><span data-stu-id="25eaa-107">Any errors in the command being prepared are not known until the command is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="25eaa-108">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] の SSPROP_DEFERPREPARE プロパティを FALSE に設定すると、この既定の動作を無効にできます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-108">Setting the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] property SSPROP_DEFERPREPARE to FALSE can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="25eaa-109">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] では、コマンドを (最初に準備しないで) 直接実行すると、実行プランが作成され、キャッシュされます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-109">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], when a command is executed directly (without preparing it first), an execution plan is created and cached.</span></span> <span data-ttu-id="25eaa-110">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] には新しいステートメントをキャッシュ内の既存の実行プランと照合する効率的なアルゴリズムがあるので、SQL ステートメントを再実行すると、そのステートメントの実行プランが再利用されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-110">If the SQL statement is executed again, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] has an efficient algorithm to match the new statement with the existing execution plan in the cache, and reuses the execution plan for that statement.</span></span>  
  
 <span data-ttu-id="25eaa-111">準備されたコマンドに対して、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ではコマンド ステートメントの準備と実行に関するネイティブ サポートが提供されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-111">For prepared commands, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] provides native support for preparing and executing command statements.</span></span> <span data-ttu-id="25eaa-112">ステートメントを準備すると、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] では実行プランが作成されてキャッシュされ、この実行プランのハンドルがプロバイダーに返されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-112">When you prepare a statement, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an execution plan, caches it, and returns a handle to this execution plan to the provider.</span></span> <span data-ttu-id="25eaa-113">その後、プロバイダーはこのハンドルを使用して、ステートメントを繰り返し実行します。</span><span class="sxs-lookup"><span data-stu-id="25eaa-113">The provider then uses this handle to execute the statement repeatedly.</span></span> <span data-ttu-id="25eaa-114">ストアド プロシージャは作成されません。</span><span class="sxs-lookup"><span data-stu-id="25eaa-114">No stored procedures are created.</span></span> <span data-ttu-id="25eaa-115">直接実行する場合のように SQL ステートメントをキャッシュ内の実行プランと照合するのではなく、ハンドルで SQL ステートメントの実行プランを直接識別するので、そのステートメントを複数回実行することがわかっている場合は、ステートメントを準備する方が直接実行するよりも効率的です。</span><span class="sxs-lookup"><span data-stu-id="25eaa-115">Because the handle directly identifies the execution plan for an SQL statement instead of matching the statement to the execution plan in the cache (as is the case for direct execution), it is more efficient to prepare a statement than to execute it directly, if you know the statement will be executed more than a few times.</span></span>  
  
 <span data-ttu-id="25eaa-116">[!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] では、準備されたステートメントを一時オブジェクトの作成に使用できません。また、準備されたステートメントから、一時テーブルなどの一時オブジェクトを作成するシステム ストアド プロシージャを参照できません。</span><span class="sxs-lookup"><span data-stu-id="25eaa-116">In [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the prepared statements cannot be used to create temporary objects and cannot reference system stored procedures that create temporary objects, such as temporary tables.</span></span> <span data-ttu-id="25eaa-117">このようなプロシージャは、直接実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="25eaa-117">These procedures must be executed directly.</span></span>  
  
 <span data-ttu-id="25eaa-118">コマンドによっては、準備してはいけないものがあります。</span><span class="sxs-lookup"><span data-stu-id="25eaa-118">Some commands should never be prepared.</span></span> <span data-ttu-id="25eaa-119">たとえば、ストアド プロシージャの実行を指定するコマンドや、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ストアド プロシージャの作成に関して無効なテキストを含むコマンドは、準備しないようにしてください。</span><span class="sxs-lookup"><span data-stu-id="25eaa-119">For example, commands that specify stored procedure execution or include invalid text for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] stored procedure creation should not be prepared.</span></span>  
  
 <span data-ttu-id="25eaa-120">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダーでは、一時ストアド プロシージャが作成されると、その一時ストアド プロシージャを実行して、そのステートメント自体が実行されたかのように結果を返します。</span><span class="sxs-lookup"><span data-stu-id="25eaa-120">If a temporary stored procedure is created, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider executes the temporary stored procedure, returning results as if the statement itself was executed.</span></span>  
  
 <span data-ttu-id="25eaa-121">一時ストアド プロシージャの作成は、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダー固有の初期化プロパティである SSPROP_INIT_USEPROCFORPREP によって制御されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-121">Temporary stored procedure creation is controlled by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider -specific initialization property SSPROP_INIT_USEPROCFORPREP.</span></span> <span data-ttu-id="25eaa-122">プロパティ値が SSPROPVAL_USEPROCFORPREP_ON または SSPROPVAL_USEPROCFORPREP_ON_DROP の場合、コマンドが準備されると、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダーは、ストアド プロシージャの作成を試みます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-122">If the property value is either SSPROPVAL_USEPROCFORPREP_ON or SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider attempts to create a stored procedure when a command is prepared.</span></span> <span data-ttu-id="25eaa-123">ストアド プロシージャの作成は、アプリケーション ユーザーが適切な [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 権限を所持している場合に成功します。</span><span class="sxs-lookup"><span data-stu-id="25eaa-123">Stored procedure creation succeeds if the application user has sufficient [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permissions.</span></span>  
  
 <span data-ttu-id="25eaa-124">ほとんど切断しないコンシューマーの場合、一時ストアド プロシージャの作成には、**tempdb** の大量のリソースが必要になることがあります。tempdb は、一時オブジェクトが作成される [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] システム データベースです。</span><span class="sxs-lookup"><span data-stu-id="25eaa-124">For consumers that infrequently disconnect, creation of temporary stored procedures can require significant resources of **tempdb**, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] system database in which temporary objects are created.</span></span> <span data-ttu-id="25eaa-125">SSPROP_INIT_USEPROCFORPREP の値が SSPROPVAL_USEPROCFORPREP_ ON の場合、コマンドを作成したセッションで [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のインスタンスへの接続が失われたときにだけ、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダーで作成された一時ストアド プロシージャが削除されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-125">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ ON, temporary stored procedures created by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider are dropped only when the session that created the command loses its connection to the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="25eaa-126">その接続がデータ ソースの初期化時に作成された既定の接続の場合は、データ ソースの初期化が解除されたときのみ、一時ストアド プロシージャが削除されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-126">If that connection is the default connection created on data source initialization, the temporary stored procedure is dropped only when the data source becomes uninitialized.</span></span>  
  
 <span data-ttu-id="25eaa-127">SSPROP_INIT_USEPROCFORPREP の値が SSPROPVAL_USEPROCFORPREP_ON_DROP の場合、次のいずれかの時点で、[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB プロバイダーの一時ストアド プロシージャが削除されます。</span><span class="sxs-lookup"><span data-stu-id="25eaa-127">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider temporary stored procedures are dropped when one of the following occurs:</span></span>  
  
-   <span data-ttu-id="25eaa-128">コンシューマーが **ICommandText::SetCommandText** を使用して新しいコマンドを指定したとき。</span><span class="sxs-lookup"><span data-stu-id="25eaa-128">The consumer uses **ICommandText::SetCommandText** to indicate a new command.</span></span>  
  
-   <span data-ttu-id="25eaa-129">コンシューマーが **ICommandPrepare::Unprepare** を使用して、コマンド テキストが必要なくなったことを指定したとき。</span><span class="sxs-lookup"><span data-stu-id="25eaa-129">The consumer uses **ICommandPrepare::Unprepare** to indicate that it no longer requires the command text.</span></span>  
  
-   <span data-ttu-id="25eaa-130">コンシューマーが一時ストアド プロシージャを使用して、コマンド オブジェクトへのすべての参照を解放したとき。</span><span class="sxs-lookup"><span data-stu-id="25eaa-130">The consumer releases all references to the command object using the temporary stored procedure.</span></span>  
  
 <span data-ttu-id="25eaa-131">コマンド オブジェクトは、最大で 1 つだけ一時ストアド プロシージャを **tempdb** に保持します。</span><span class="sxs-lookup"><span data-stu-id="25eaa-131">A command object has at most one temporary stored procedure in **tempdb**.</span></span> <span data-ttu-id="25eaa-132">既存の一時ストアド プロシージャは、特定のコマンド オブジェクトに関する現在のコマンド テキストを表します。</span><span class="sxs-lookup"><span data-stu-id="25eaa-132">Any existing temporary stored procedure represents the current command text of a specific command object.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="25eaa-133">参照</span><span class="sxs-lookup"><span data-stu-id="25eaa-133">See Also</span></span>  
 [<span data-ttu-id="25eaa-134">コマンド</span><span class="sxs-lookup"><span data-stu-id="25eaa-134">Commands</span></span>](commands.md)  
  
  
